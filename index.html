<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Renova | Central de Inteligência</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;600;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <style>
        :root {
            --bg-pure: #050508;
            --bg-card: #0d0d14;
            --nucleo-gold: #ffd700;
            --iniciado-blue: #00d4ff;
            --obs-gray: #666;
            --border: #1f1f2e;
            --text: #f0f0f0;
            --text-dim: #888;
            --error: #ff4444;
        }

        * { box-sizing: border-box; outline: none; }
        body, html { 
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg-pure); color: var(--text);
            font-family: 'Source Code Pro', monospace; overflow: hidden;
        }

        /* --- SISTEMA DE LOGIN --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 1000;
            background: radial-gradient(circle at center, #10101a 0%, #050508 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .login-container {
            background: var(--bg-card); padding: 40px; border: 1px solid var(--border);
            width: 100%; max-width: 420px; border-radius: 4px; box-shadow: 0 20px 50px rgba(0,0,0,0.5);
        }
        .login-header { text-align: center; margin-bottom: 30px; }
        .login-header h1 { font-family: 'Cinzel', serif; color: var(--iniciado-blue); margin: 0; letter-spacing: 3px; }
        .form-group { margin-bottom: 20px; }
        .form-group label { display: block; font-size: 10px; color: var(--text-dim); margin-bottom: 5px; letter-spacing: 1px; }
        .form-group input, .form-group select {
            width: 100%; padding: 12px; background: #000; border: 1px solid var(--border);
            color: #fff; font-family: inherit; font-size: 14px;
        }
        .btn-sync {
            width: 100%; padding: 15px; background: none; border: 1px solid var(--iniciado-blue);
            color: var(--iniciado-blue); font-family: 'Cinzel', serif; cursor: pointer;
            transition: 0.3s; font-weight: bold; margin-top: 10px;
        }
        .btn-sync:hover { background: var(--iniciado-blue); color: #000; box-shadow: 0 0 20px rgba(0, 212, 255, 0.4); }

        /* --- ESTRUTURA DASHBOARD (SPA) --- */
        #app-shell { display: none; height: 100vh; grid-template-columns: 260px 1fr 300px; }

        /* Sidebar Esquerda */
        .nav-sidebar { background: var(--bg-card); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .profile-box { padding: 30px 20px; text-align: center; border-bottom: 1px solid var(--border); }
        .avatar { 
            width: 70px; height: 70px; border-radius: 50%; margin: 0 auto 15px;
            display: flex; align-items: center; justify-content: center; font-size: 28px;
            background: #151520; border: 2px solid var(--border);
        }
        .nav-menu { flex: 1; padding: 15px; }
        .nav-item { 
            padding: 12px 15px; margin-bottom: 8px; cursor: pointer; border-radius: 4px;
            color: var(--text-dim); transition: 0.2s; display: flex; align-items: center; gap: 12px;
        }
        .nav-item:hover { background: rgba(255,255,255,0.05); color: #fff; }
        .nav-item.active { background: rgba(0, 212, 255, 0.1); color: var(--iniciado-blue); font-weight: 600; }

        /* Viewport Central */
        .main-viewport { overflow-y: auto; padding: 40px; background: #08080c; position: relative; }
        .view-section { display: none; animation: fadeIn 0.3s ease-out; }
        .view-section.active { display: block; }

        /* Sidebar Direita (Social) */
        .social-sidebar { background: var(--bg-card); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .social-header { padding: 15px; font-size: 12px; font-weight: bold; border-bottom: 1px solid var(--border); color: var(--text-dim); }
        .list-container { flex: 1; overflow-y: auto; padding: 10px; }
        .user-card { 
            display: flex; align-items: center; gap: 10px; padding: 10px; 
            border-radius: 4px; cursor: pointer; transition: 0.2s;
        }
        .user-card:hover { background: rgba(255,255,255,0.05); }
        .status-indicator { width: 8px; height: 8px; border-radius: 50%; background: #2ecc71; }

        /* Modais */
        .modal-overlay { 
            position: fixed; inset: 0; background: rgba(0,0,0,0.85); 
            display: none; justify-content: center; align-items: center; z-index: 2000;
        }
        .modal-content { 
            background: var(--bg-card); border: 1px solid var(--border); 
            width: 90%; max-width: 600px; padding: 30px; position: relative;
        }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <h1>ALGEBRA RENOVA</h1>
                <p style="font-size: 10px; color: var(--text-dim); margin-top: 5px;">PROTOCOLOS DE INTELIGÊNCIA ATIVOS</p>
            </div>
            
            <div class="form-group">
                <label>IDENTIFICAÇÃO</label>
                <input type="text" id="user-name" placeholder="Codinome...">
            </div>

            <div class="form-group">
                <label>ESPECIALIDADE TÉCNICA</label>
                <input type="text" id="user-spec" placeholder="Ex: Topologia Algébrica">
            </div>

            <div class="form-group">
                <label>NÍVEL DE ACESSO</label>
                <select id="user-level" onchange="toggleMasterKey()">
                    <option value="observador">Observador</option>
                    <option value="iniciado">Iniciado</option>
                    <option value="nucleo_hidden">Acesso de Cúpula...</option>
                </select>
            </div>

            <div id="master-key-wrap" class="form-group" style="display: none;">
                <label style="color: var(--nucleo-gold);">CHAVE MESTRE (MASTER_KEY)</label>
                <input type="password" id="auth-key" placeholder="••••••••">
            </div>

            <button class="btn-sync" onclick="processLogin()">SINCRONIZAR SESSÃO</button>
        </div>
    </div>

    <div id="app-shell">
        <aside class="nav-sidebar">
            <div class="profile-box">
                <div class="avatar" id="app-avatar">?</div>
                <div id="app-username" style="font-weight: bold;">---</div>
                <div id="app-userlevel" style="font-size: 10px; color: var(--iniciado-blue); margin-top: 5px;">---</div>
            </div>

            <nav class="nav-menu">
                <div class="nav-item active" onclick="navigate('manifesto', this)"><i class="fas fa-terminal"></i> Manifesto</div>
                <div class="nav-item" onclick="navigate('teorias', this)"><i class="fas fa-microchip"></i> Teorias</div>
                <div class="nav-item" onclick="navigate('forum', this)"><i class="fas fa-brain"></i> Fórum de Discussão</div>
                <div class="nav-item" onclick="navigate('perfil', this)"><i class="fas fa-id-badge"></i> Perfil do Agente</div>
            </nav>

            <div style="padding: 20px;">
                <button onclick="terminateSession()" style="width:100%; background:none; border:1px solid #222; color:#444; font-size:10px; cursor:pointer; padding:8px;">LOGOUT</button>
            </div>
        </aside>

        <main class="main-viewport">
            <section id="v-manifesto" class="view-section active">
                <h2 style="font-family: 'Cinzel'; border-bottom: 1px solid var(--border); padding-bottom: 15px;">Axiomas da Revolução</h2>
                <div id="manifesto-content" style="line-height: 1.8; color: var(--text-dim); max-width: 800px;">
                    Carregando dados criptografados...
                </div>
            </section>

            <section id="v-teorias" class="view-section">
                <div style="display:flex; justify-content:space-between; align-items:center;">
                    <h2 style="font-family: 'Cinzel';">Repositório Teórico</h2>
                    <button class="btn-sync" style="width:auto; padding:8px 20px; font-size:12px;" onclick="openTheoryModal()">+ Publicar Teoria</button>
                </div>
                <div id="theory-grid" style="display:grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap:20px; margin-top:30px;">
                    </div>
            </section>

            <section id="v-forum" class="view-section">
                <h2 style="font-family: 'Cinzel';">Fórum de Desafios</h2>
                <div id="forum-list" style="margin-top:20px;"></div>
            </section>
        </main>

        <aside class="social-sidebar">
            <div class="social-header">INTEGRANTES ONLINE (<span id="real-member-count">0</span>)</div>
            <div class="list-container" id="global-members"></div>
            
            <div class="social-header" style="border-top:1px solid var(--border);">CONTATOS DIRETOS</div>
            <div class="list-container" id="direct-contacts"></div>
            
            <div style="padding: 15px; border-top:1px solid var(--border);">
                <input type="text" id="add-contact-input" placeholder="Buscar por codinome..." style="width:100%; background:#000; border:1px solid var(--border); color:#fff; padding:8px; font-size:11px;">
            </div>
        </aside>
    </div>

    <div id="theory-modal" class="modal-overlay">
        <div class="modal-content">
            <h3 style="font-family:'Cinzel'; color:var(--iniciado-blue);">Nova Proposição Teórica</h3>
            <div class="form-group">
                <label>TÍTULO DA TEORIA</label>
                <input type="text" id="t-modal-title" placeholder="Ex: Isomorfismo Não-Linear">
            </div>
            <div class="form-group">
                <label>CONTEÚDO (SUPORTE LATEX $...$)</label>
                <textarea id="t-modal-body" style="width:100%; height:200px; background:#000; color:#fff; border:1px solid var(--border); padding:10px; font-family:inherit; resize:none;"></textarea>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn-sync" onclick="submitTheory()">PUBLICAR</button>
                <button class="btn-sync" style="border-color:#444; color:#666;" onclick="closeTheoryModal()">CANCELAR</button>
            </div>
        </div>
    </div>

    <script>
        const KEY_UP = "Renova, O Non Trad";
        
        // Memória do Sistema
        let DB = {
            user: JSON.parse(localStorage.getItem('renova_session')),
            members: JSON.parse(localStorage.getItem('renova_members')) || [],
            theories: JSON.parse(localStorage.getItem('renova_theories')) || [],
            messages: JSON.parse(localStorage.getItem('renova_messages')) || {}
        };

        // =============================================
        // LÓGICA DE LOGIN E SESSÃO
        // =============================================

        function toggleMasterKey() {
            const level = document.getElementById('user-level').value;
            const keyWrap = document.getElementById('master-key-wrap');
            keyWrap.style.display = (level === 'nucleo_hidden') ? 'block' : 'none';
        }

        function processLogin() {
            const name = document.getElementById('user-name').value.trim();
            const spec = document.getElementById('user-spec').value.trim();
            let level = document.getElementById('user-level').value;
            const key = document.getElementById('auth-key').value;

            if (!name || !spec) {
                return toastr.error("Identificação e Especialidade são obrigatórios.");
            }

            // Validação de Segurança do Núcleo
            if (level === 'nucleo_hidden') {
                if (key === KEY_UP) {
                    level = 'nucleo';
                } else {
                    return toastr.error("Chave Mestre Inválida. Acesso Negado.");
                }
            }

            // Criar ou recuperar usuário no "banco"
            const userData = {
                id: Date.now().toString(),
                name: name,
                spec: spec,
                level: level,
                joinedAt: new Date().toISOString()
            };

            DB.user = userData;
            
            // Adicionar à lista global de membros se não existir
            if (!DB.members.find(m => m.name === name)) {
                DB.members.push(userData);
                save('renova_members', DB.members);
            }

            save('renova_session', userData);
            toastr.success("Sincronização concluída. Bem-vindo.");
            initApp();
        }

        function initApp() {
            if (!DB.user) return;

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-shell').style.display = 'grid';
            
            // Atualizar Perfil na UI
            document.getElementById('app-username').innerText = DB.user.name;
            document.getElementById('app-userlevel').innerText = DB.user.level.toUpperCase();
            document.getElementById('app-avatar').innerText = DB.user.name[0].toUpperCase();
            
            // Estilo por nível
            const avatar = document.getElementById('app-avatar');
            if (DB.user.level === 'nucleo') {
                avatar.style.borderColor = 'var(--nucleo-gold)';
                avatar.style.color = 'var(--nucleo-gold)';
                avatar.style.boxShadow = '0 0 15px var(--nucleo-glow)';
            } else if (DB.user.level === 'iniciado') {
                avatar.style.borderColor = 'var(--iniciado-blue)';
                avatar.style.color = 'var(--iniciado-blue)';
            }

            renderAll();
        }

        // =============================================
        // NAVEGAÇÃO E RENDERIZAÇÃO
        // =============================================

        function navigate(sectionId, element) {
            // Trocar Abas
            document.querySelectorAll('.view-section').forEach(s => s.classList.remove('active'));
            document.getElementById('v-' + sectionId).classList.add('active');

            // Atualizar Menu
            document.querySelectorAll('.nav-item').forEach(i => i.classList.remove('active'));
            element.classList.add('active');

            if (sectionId === 'teorias') renderTheories();
            if (sectionId === 'forum') renderForum();
        }

        function renderTheories() {
            const container = document.getElementById('theory-grid');
            container.innerHTML = DB.theories.map(t => `
                <div class="login-box" style="max-width:none; text-align:left; border-color: ${t.authorLevel === 'nucleo' ? 'var(--nucleo-gold)' : 'var(--border)'}">
                    <div style="font-size:10px; color:var(--text-dim); margin-bottom:5px;">${t.date} | Por: ${t.author}</div>
                    <h3 style="margin:0 0 10px 0; color:var(--iniciado-blue);">${t.title}</h3>
                    <div class="math-content">${t.body}</div>
                </div>
            `).join('');
            
            if (window.MathJax) MathJax.typeset();
        }

        // =============================================
        // SISTEMA SOCIAL (CONTATOS E AMIGOS)
        // =============================================

        function renderAll() {
            // Membros Online (Simulação Real baseada no DB)
            const memberList = document.getElementById('global-members');
            document.getElementById('real-member-count').innerText = DB.members.length;
            
            memberList.innerHTML = DB.members.map(m => `
                <div class="user-card" onclick="askAddFriend('${m.name}')">
                    <div class="status-indicator"></div>
                    <div style="font-size:13px;">${m.name} <span style="font-size:9px; color:var(--text-dim)">[${m.level}]</span></div>
                </div>
            `).join('');

            // Amigos/Contatos
            const friendList = document.getElementById('direct-contacts');
            const myFriends = DB.members.filter(m => DB.user.friends && DB.user.friends.includes(m.name));
            
            friendList.innerHTML = myFriends.length ? myFriends.map(f => `
                <div class="user-card" style="border-left: 2px solid var(--iniciado-blue)">
                    <div class="status-indicator online"></div>
                    <div style="font-size:13px;">${f.name}</div>
                </div>
            `).join('') : '<div style="font-size:10px; color:#444; padding:10px;">Nenhum contato ativo.</div>';
        }

        // =============================================
        // UTILITÁRIOS
        // =============================================

        function save(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function terminateSession() {
            localStorage.removeItem('renova_session');
            location.reload();
        }

        // Auto-login se houver sessão
        if (DB.user) {
            setTimeout(initApp, 100);
        }

        // O Bloco 3 seguirá com a criação de teorias e o Chat de Mensagens Reais.

        // =============================================
        // GESTÃO DE TEORIAS E CONTEÚDO
        // =============================================

        function openTheoryModal() {
            if (DB.user.level === 'observador') {
                return toastr.warning("Observadores não possuem permissão de escrita.");
            }
            document.getElementById('theory-modal').style.display = 'flex';
        }

        function closeTheoryModal() {
            document.getElementById('theory-modal').style.display = 'none';
        }

        function submitTheory() {
            const title = document.getElementById('t-modal-title').value.trim();
            const body = document.getElementById('t-modal-body').value.trim();

            if (!title || !body) return toastr.error("Preencha todos os campos.");

            const newTheory = {
                id: Date.now(),
                title: title,
                body: body,
                author: DB.user.name,
                authorLevel: DB.user.level,
                date: new Date().toLocaleDateString('pt-BR')
            };

            DB.theories.unshift(newTheory); // Adiciona ao início
            save('renova_theories', DB.theories);
            
            toastr.success("Teoria propagada na rede.");
            closeTheoryModal();
            renderTheories();
            
            // Limpar campos
            document.getElementById('t-modal-title').value = '';
            document.getElementById('t-modal-body').value = '';
        }

        // =============================================
        // CHAT E INTERAÇÃO PRIVADA
        // =============================================

        function askAddFriend(targetName) {
            if (targetName === DB.user.name) return;
            
            if (confirm(`Deseja estabelecer conexão direta com ${targetName}?`)) {
                if (!DB.user.friends) DB.user.friends = [];
                
                if (!DB.user.friends.includes(targetName)) {
                    DB.user.friends.push(targetName);
                    
                    // Atualizar o membro no DB global e na sessão
                    const index = DB.members.findIndex(m => m.name === DB.user.name);
                    DB.members[index].friends = DB.user.friends;
                    
                    save('renova_members', DB.members);
                    save('renova_session', DB.user);
                    
                    toastr.success(`Conexão com ${targetName} estabelecida.`);
                    renderAll();
                }
            }
        }

        // Simulação de busca no input
        document.getElementById('add-contact-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const name = e.target.value.trim();
                const found = DB.members.find(m => m.name.toLowerCase() === name.toLowerCase());
                
                if (found) {
                    askAddFriend(found.name);
                    e.target.value = '';
                } else {
                    toastr.error("Membro não localizado na rede.");
                }
            }
        });

        // =============================================
        // CARREGAMENTO DO MANIFESTO (DINÂMICO)
        // =============================================
        
        const manifestoRaw = `
            1. A matemática não é estática; ela é uma linguagem em expansão.<br><br>
            2. O Núcleo coordena a transição para a Álgebra Non Trad.<br><br>
            3. Todo Iniciado deve contribuir com pelo menos uma proposição teórica.<br><br>
            4. O erro é uma variável necessária para a descoberta da verdade.
        `;

        document.getElementById('manifesto-content').innerHTML = manifestoRaw;

        // FINALIZAÇÃO DO SCRIPT
    </script>
</body>
</html>
