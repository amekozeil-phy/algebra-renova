<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Renova | Sistema de Inteligência</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;600;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>

    <style>
        :root {
            --bg-ultra: #030305;
            --bg-panel: #0a0a0f;
            --bg-input: #000;
            --nucleo: #ffd700;
            --iniciado: #00d4ff;
            --border: #1a1a24;
            --text: #e0e0e0;
            --text-mute: #666;
        }

        * { box-sizing: border-box; }
        body, html { 
            margin: 0; padding: 0; height: 100vh; width: 100vw;
            background: var(--bg-ultra); color: var(--text);
            font-family: 'Source Code Pro', monospace; overflow: hidden;
        }

        /* --- TELA DE ACESSO --- */
        #login-screen {
            position: fixed; inset: 0; z-index: 1000;
            background: radial-gradient(circle at center, #0a0a15 0%, #030305 100%);
            display: flex; justify-content: center; align-items: center;
        }
        .login-card {
            background: var(--bg-panel); padding: 40px; border: 1px solid var(--border);
            width: 400px; border-radius: 2px; text-align: center;
            box-shadow: 0 0 40px rgba(0,0,0,0.7);
        }
        .login-card h1 { font-family: 'Cinzel'; color: var(--iniciado); letter-spacing: 5px; margin-bottom: 30px; }
        .field { margin-bottom: 20px; text-align: left; }
        .field label { font-size: 10px; color: var(--text-mute); display: block; margin-bottom: 5px; }
        .field input, .field select { 
            width: 100%; padding: 12px; background: var(--bg-input); border: 1px solid var(--border);
            color: #fff; font-family: inherit;
        }
        .btn-sync { 
            width: 100%; padding: 15px; background: none; border: 1px solid var(--iniciado);
            color: var(--iniciado); font-family: 'Cinzel'; cursor: pointer; transition: 0.3s;
        }
        .btn-sync:hover { background: var(--iniciado); color: #000; box-shadow: 0 0 20px var(--iniciado); }

        /* --- INTERFACE PRINCIPAL --- */
        #app-main { display: none; grid-template-columns: 260px 1fr 300px; height: 100vh; }

        /* Lateral Esquerda (Navegação) */
        .sidebar-nav { background: var(--bg-panel); border-right: 1px solid var(--border); display: flex; flex-direction: column; }
        .user-info { padding: 30px 20px; border-bottom: 1px solid var(--border); text-align: center; }
        .pfp { width: 60px; height: 60px; border-radius: 50%; margin: 0 auto 10px; border: 2px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 24px; font-weight: bold; background: #000; }
        .menu-items { flex: 1; padding: 10px; }
        .menu-btn { padding: 12px; cursor: pointer; color: var(--text-mute); display: flex; align-items: center; gap: 10px; transition: 0.2s; }
        .menu-btn:hover, .menu-btn.active { color: var(--iniciado); background: rgba(0, 212, 255, 0.05); }

        /* Centro (Área de Trabalho) */
        .viewport { overflow-y: auto; padding: 40px; }
        .tab-section { display: none; }
        .tab-section.active { display: block; }

        /* Lateral Direita (Social/WhatsApp Style) */
        .sidebar-social { background: var(--bg-panel); border-left: 1px solid var(--border); display: flex; flex-direction: column; }
        .social-label { padding: 15px; font-size: 10px; border-bottom: 1px solid var(--border); color: var(--text-mute); letter-spacing: 1px; }
        .chat-list { flex: 1; overflow-y: auto; padding: 10px; }
        .contact { display: flex; align-items: center; gap: 10px; padding: 10px; cursor: pointer; border-radius: 4px; }
        .contact:hover { background: rgba(255,255,255,0.03); }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #2ecc71; }

        /* Modal */
        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 2000; }
        .modal-box { background: var(--bg-panel); border: 1px solid var(--border); width: 500px; padding: 30px; }

        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    </style>
</head>
<body>

    <div id="login-screen">
        <div class="login-card">
            <h1>RENOVA</h1>
            <div class="field">
                <label>IDENTIDADE</label>
                <input type="text" id="in-name" placeholder="Nome...">
            </div>
            <div class="field">
                <label>NÍVEL</label>
                <select id="in-level" onchange="toggleNucleoField()">
                    <option value="observador">Observador</option>
                    <option value="iniciado">Iniciado</option>
                    <option value="locked">Restrito [Núcleo]</option>
                </select>
            </div>
            <div id="nucleo-field" class="field" style="display:none;">
                <label style="color: var(--nucleo)">CHAVE MESTRE</label>
                <input type="password" id="in-key" placeholder="••••••••">
            </div>
            <button class="btn-sync" onclick="auth()">INGRESSAR</button>
        </div>
    </div>

    <div id="app-main">
        <aside class="sidebar-nav">
            <div class="user-info">
                <div class="pfp" id="u-pfp">?</div>
                <div id="u-name" style="font-weight: bold;">---</div>
                <div id="u-level" style="font-size: 10px; color: var(--iniciado);">---</div>
            </div>
            <div class="menu-items">
                <div class="menu-btn active" onclick="tab('manifesto')"><i class="fas fa-scroll"></i> Manifesto</div>
                <div class="menu-btn" onclick="tab('teorias')"><i class="fas fa-atom"></i> Teorias</div>
                <div class="menu-btn" onclick="tab('forum')"><i class="fas fa-comments"></i> Fórum</div>
                <div class="menu-btn" onclick="tab('perfil')"><i class="fas fa-user-circle"></i> Perfil</div>
            </div>
            <button onclick="logout()" style="background:none; border:none; color:#333; cursor:pointer; padding:20px;">SAIR</button>
        </aside>

        <main class="viewport">
            <section id="tab-manifesto" class="tab-section active">
                <h2 style="font-family: 'Cinzel';">O Manifesto</h2>
                <div id="manifesto-text" style="color: var(--text-mute); line-height: 1.8;"></div>
            </section>

            <section id="tab-teorias" class="tab-section">
                <div style="display:flex; justify-content:space-between;">
                    <h2 style="font-family: 'Cinzel';">Teorias</h2>
                    <button class="btn-sync" style="width:auto; padding:5px 15px;" onclick="openM()">+ Nova</button>
                </div>
                <div id="theories-list" style="margin-top: 20px;"></div>
            </section>
        </main>

        <aside class="sidebar-social">
            <div class="social-label">MEMBROS ONLINE (<span id="count">0</span>)</div>
            <div class="chat-list" id="global-members"></div>
            <div class="social-label" style="border-top: 1px solid var(--border);">CONTACTOS DIRETOS</div>
            <div class="chat-list" id="friend-list"></div>
            <div style="padding: 10px;">
                <input type="text" id="search-member" placeholder="Adicionar por nome..." style="width:100%; background:#000; border:1px solid var(--border); color:#fff; padding:8px; font-size:11px;">
            </div>
        </aside>
    </div>

    <script>
        const MASTER_KEY = "Renova, O Non Trad";
        let state = {
            user: JSON.parse(localStorage.getItem('renova_session')),
            members: JSON.parse(localStorage.getItem('renova_members')) || [],
            theories: JSON.parse(localStorage.getItem('renova_theories')) || []
        };

        // =============================================
        // SISTEMA DE AUTENTICAÇÃO E SESSÃO
        // =============================================

        function toggleNucleoField() {
            const level = document.getElementById('in-level').value;
            const field = document.getElementById('nucleo-field');
            field.style.display = (level === 'locked') ? 'block' : 'none';
        }

        function auth() {
            const name = document.getElementById('in-name').value.trim();
            let level = document.getElementById('in-level').value;
            const key = document.getElementById('in-key').value;

            if (!name) return toastr.error("A identificação é necessária.");

            // Validação de Segurança do Núcleo
            if (level === 'locked') {
                if (key === MASTER_KEY) {
                    level = 'nucleo';
                } else {
                    return toastr.error("Chave Mestre Inválida.");
                }
            }

            const userData = {
                name: name,
                level: level,
                pfp: name[0].toUpperCase(),
                id: Date.now()
            };

            state.user = userData;
            
            // Adicionar à lista global de membros (Simulação de Base de Dados)
            if (!state.members.find(m => m.name === name)) {
                state.members.push(userData);
                save('renova_members', state.members);
            }

            save('renova_session', userData);
            toastr.success("Sincronização bem-sucedida.");
            renderApp();
        }

        function renderApp() {
            if (!state.user) return;

            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-main').style.display = 'grid';

            // UI do Usuário
            document.getElementById('u-name').innerText = state.user.name;
            document.getElementById('u-level').innerText = state.user.level.toUpperCase();
            document.getElementById('u-pfp').innerText = state.user.pfp;

            // Estilo por Nível
            const pfp = document.getElementById('u-pfp');
            if (state.user.level === 'nucleo') {
                pfp.style.borderColor = 'var(--nucleo)';
                pfp.style.color = 'var(--nucleo)';
                document.getElementById('u-level').style.color = 'var(--nucleo)';
            } else if (state.user.level === 'iniciado') {
                pfp.style.borderColor = 'var(--iniciado)';
            }

            loadContent();
            renderSocial();
        }

        // =============================================
        // NAVEGAÇÃO E CONTEÚDO
        // =============================================

        function tab(name) {
            document.querySelectorAll('.tab-section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.menu-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById('tab-' + name).classList.add('active');
            event.currentTarget.classList.add('active');

            if (name === 'teorias') renderTheories();
        }

        function loadContent() {
            // Texto do Manifesto
            document.getElementById('manifesto-text').innerHTML = `
                <p>1. A estrutura precede a forma. A Álgebra é a chave da realidade.</p>
                <p>2. O Núcleo coordena. O Iniciado executa. O Observador aprende.</p>
                <p>3. Nada é tradicional nesta rede. O pensamento é radical.</p>
            `;
        }

        function renderTheories() {
            const list = document.getElementById('theories-list');
            if (state.theories.length === 0) {
                list.innerHTML = "<p style='color:#333'>Nenhuma teoria propagada ainda...</p>";
                return;
            }
            list.innerHTML = state.theories.map(t => `
                <div style="background:var(--bg-panel); border:1px solid var(--border); padding:20px; margin-bottom:15px;">
                    <small style="color:var(--text-mute)">Por: ${t.author} | ${t.date}</small>
                    <h3 style="color:var(--iniciado); margin:10px 0;">${t.title}</h3>
                    <div class="math">${t.content}</div>
                </div>
            `).join('');
            
            if (window.MathJax) MathJax.typeset();
        }

        // =============================================
        // SISTEMA SOCIAL E AMIGOS
        // =============================================

        function renderSocial() {
            // Membros da Rede (Dados Reais)
            const globalList = document.getElementById('global-members');
            document.getElementById('count').innerText = state.members.length;
            
            globalList.innerHTML = state.members.map(m => `
                <div class="contact" onclick="addFriend('${m.name}')">
                    <div class="dot"></div>
                    <span style="font-size:13px">${m.name}</span>
                    <small style="font-size:9px; color:var(--text-mute)">[${m.level}]</small>
                </div>
            `).join('');
        }

        function addFriend(name) {
            if (name === state.user.name) return;
            toastr.info(`Conexão estabelecida com ${name}`);
            // Lógica de Chat Privado será injetada no Bloco 3
        }

        // =============================================
        // PERSISTÊNCIA E BACKUP
        // =============================================

        function save(key, data) {
            localStorage.setItem(key, JSON.stringify(data));
        }

        function logout() {
            localStorage.removeItem('renova_session');
            location.reload();
        }

        // Auto-Init
        if (state.user) {
            setTimeout(renderApp, 100);
        }

        // =============================================
        // GESTÃO DE CONTEÚDO (TEORIAS E FÓRUM)
        // =============================================

        function openM() {
            if (state.user.level === 'observador') {
                return toastr.warning("Observadores não possuem permissão de escrita.");
            }
            // Criar modal dinâmico
            const m = document.createElement('div');
            m.className = 'modal';
            m.id = 'theory-modal';
            m.style.display = 'flex';
            m.innerHTML = `
                <div class="modal-box">
                    <h3 style="font-family:'Cinzel'; color:var(--iniciado)">Propagar Nova Teoria</h3>
                    <div class="field">
                        <label>TÍTULO</label>
                        <input type="text" id="t-title" placeholder="Ex: Espaços de Hilbert Não-Euclidianos">
                    </div>
                    <div class="field">
                        <label>CONTEÚDO (Suporta LaTeX $...$)</label>
                        <textarea id="t-content" style="width:100%; height:150px; background:#000; color:#fff; border:1px solid var(--border); padding:10px; font-family:inherit;"></textarea>
                    </div>
                    <div style="display:flex; gap:10px;">
                        <button class="btn-sync" onclick="saveTheory()">PUBLICAR</button>
                        <button class="btn-sync" style="border-color:#333; color:#555;" onclick="closeM()">CANCELAR</button>
                    </div>
                </div>
            `;
            document.body.appendChild(m);
        }

        function closeM() {
            const m = document.getElementById('theory-modal');
            if (m) m.remove();
        }

        function saveTheory() {
            const title = document.getElementById('t-title').value.trim();
            const content = document.getElementById('t-content').value.trim();

            if (!title || !content) return toastr.error("Preencha todos os campos.");

            const newT = {
                title: title,
                content: content,
                author: state.user.name,
                date: new Date().toLocaleDateString(),
                id: Date.now()
            };

            state.theories.unshift(newT);
            save('renova_theories', state.theories);
            toastr.success("Teoria indexada com sucesso.");
            closeM();
            renderTheories();
        }

        // =============================================
        // CHAT PRIVADO E SISTEMA DE AMIGOS
        // =============================================

        function addFriend(targetName) {
            if (targetName === state.user.name) return;
            
            // Simulação de Pedido/Adição Instantânea
            let friends = JSON.parse(localStorage.getItem('friends_' + state.user.name)) || [];
            
            if (!friends.includes(targetName)) {
                friends.push(targetName);
                localStorage.setItem('friends_' + state.user.name, JSON.stringify(friends));
                toastr.success(`Conexão direta com ${targetName} estabelecida.`);
                renderFriends();
            } else {
                openPrivateChat(targetName);
            }
        }

        function renderFriends() {
            const list = document.getElementById('friend-list');
            const friends = JSON.parse(localStorage.getItem('friends_' + state.user.name)) || [];
            
            if (friends.length === 0) {
                list.innerHTML = "<small style='color:#333; padding:10px; display:block;'>Sem conexões ativas.</small>";
                return;
            }

            list.innerHTML = friends.map(f => `
                <div class="contact" onclick="openPrivateChat('${f}')">
                    <div class="dot" style="background:#00d4ff"></div>
                    <span>${f}</span>
                    <i class="fas fa-comment-dots" style="margin-left:auto; font-size:10px; color:#444;"></i>
                </div>
            `).join('');
        }

        function openPrivateChat(name) {
            // Criação de Interface de Chat Estilo WhatsApp
            const chatId = [state.user.name, name].sort().join('_');
            const chatLog = JSON.parse(localStorage.getItem('chat_' + chatId)) || [];

            const chatUI = document.createElement('div');
            chatUI.className = 'modal';
            chatUI.id = 'chat-modal';
            chatUI.style.display = 'flex';
            chatUI.innerHTML = `
                <div class="modal-box" style="width:400px; display:flex; flex-direction:column; height:500px;">
                    <div style="display:flex; justify-content:space-between; align-items:center; border-bottom:1px solid var(--border); padding-bottom:10px;">
                        <span style="font-family:'Cinzel'; color:var(--iniciado)">${name}</span>
                        <button onclick="this.closest('.modal').remove()" style="background:none; border:none; color:#555; cursor:pointer;">&times;</button>
                    </div>
                    <div id="chat-box" style="flex:1; overflow-y:auto; padding:10px; font-size:12px;">
                        ${chatLog.map(m => `
                            <div style="margin-bottom:10px; text-align: ${m.sender === state.user.name ? 'right' : 'left'}">
                                <div style="display:inline-block; padding:8px; border-radius:4px; background:${m.sender === state.user.name ? 'var(--iniciado)' : '#1a1a24'}; color:${m.sender === state.user.name ? '#000' : '#fff'}">
                                    ${m.text}
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    <input type="text" id="chat-msg" placeholder="Digite uma mensagem... (Enter)" 
                           style="width:100%; padding:10px; background:#000; border:1px solid var(--border); color:#fff;">
                </div>
            `;
            document.body.appendChild(chatUI);

            const input = document.getElementById('chat-msg');
            input.focus();
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter' && input.value.trim()) {
                    const msg = { sender: state.user.name, text: input.value.trim(), time: Date.now() };
                    chatLog.push(msg);
                    localStorage.setItem('chat_' + chatId, JSON.stringify(chatLog));
                    input.value = '';
                    openPrivateChat(name); // Refresh simplificado
                    document.getElementById('chat-modal').remove();
                }
            });
            
            // Scroll para o fim
            const box = document.getElementById('chat-box');
            box.scrollTop = box.scrollHeight;
        }

        // Evento de busca de membros
        document.getElementById('search-member').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                const target = e.target.value.trim();
                const found = state.members.find(m => m.name.toLowerCase() === target.toLowerCase());
                if (found) {
                    addFriend(found.name);
                    e.target.value = '';
                } else {
                    toastr.error("Membro não encontrado.");
                }
            }
        });

        // Inicializar Amigos na UI
        if(state.user) renderFriends();

    </script>
</body>
</html>
