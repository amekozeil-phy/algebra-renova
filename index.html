<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Algebra Renova - Plataforma Operacional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
/* ===============================
   RESET + BASE
================================ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Times New Roman", serif;
}

body {
  background: radial-gradient(circle at top, #0b0b0b, #000);
  color: #d6d6d6;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===============================
   TELA DE LOGIN
================================ */
#login-screen {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at center, #0a0a0a, #000);
  z-index: 10000;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
}

.login-container {
  background: rgba(20, 0, 0, 0.9);
  border: 3px solid #400;
  padding: 40px;
  width: 90%;
  max-width: 500px;
  box-shadow: 0 0 50px rgba(179, 0, 0, 0.3);
}

.login-tabs {
  display: flex;
  margin-bottom: 30px;
  border-bottom: 1px solid #400;
}

.login-tab {
  flex: 1;
  padding: 15px;
  background: transparent;
  color: #666;
  border: none;
  border-bottom: 3px solid transparent;
  cursor: pointer;
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 2px;
  transition: all 0.3s;
}

.login-tab.active {
  color: #b30000;
  border-bottom: 3px solid #b30000;
}

.login-form {
  display: none;
}

.login-form.active {
  display: block;
}

.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #b30000;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.form-control {
  width: 100%;
  padding: 12px;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid #400;
  color: #eee;
  font-size: 0.95rem;
}

.btn-primary {
  background: linear-gradient(135deg, #8b0000 0%, #b30000 100%);
  color: white;
  border: none;
  padding: 12px 25px;
  cursor: pointer;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  transition: all 0.3s;
  width: 100%;
  margin-top: 10px;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #b30000 0%, #8b0000 100%);
  box-shadow: 0 0 15px rgba(179, 0, 0, 0.4);
}

.hidden {
  display: none !important;
}

/* ===============================
   APLICATIVO PRINCIPAL
================================ */
#main-app {
  min-height: 100vh;
}

/* ===============================
   HEADER
================================ */
#banner {
  background: linear-gradient(135deg, #000 0%, #1a0000 100%);
  border-bottom: 3px solid #400;
  padding: 20px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.banner-title {
  font-size: 2.5rem;
  color: #8b0000;
  text-shadow: 0 0 20px #300;
  letter-spacing: 3px;
}

.system-status {
  display: flex;
  gap: 20px;
  font-size: 0.9rem;
  color: #666;
}

.status-item {
  text-align: center;
}

.status-value {
  display: block;
  color: #b30000;
  font-size: 1.2rem;
  font-weight: bold;
}

/* ===============================
   LAYOUT PRINCIPAL
================================ */
.container {
  display: grid;
  grid-template-columns: 280px 1fr 320px;
  gap: 0;
  min-height: calc(100vh - 80px);
}

/* ===============================
   SIDEBAR ESQUERDA
================================ */
#sidebar {
  background: rgba(15, 0, 0, 0.7);
  border-right: 2px solid #400;
  padding: 25px 20px;
  overflow-y: auto;
}

.profile-section {
  text-align: center;
  padding: 20px 0;
  border-bottom: 1px solid #300;
  margin-bottom: 25px;
}

.avatar-container {
  width: 100px;
  height: 100px;
  margin: 0 auto 15px;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid #400;
  background: #111;
}

.avatar-placeholder {
  width: 100%;
  height: 100%;
  background: #222;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #b30000;
  font-size: 2.5rem;
  font-weight: bold;
}

.nav-section {
  margin-bottom: 30px;
}

.nav-button {
  display: block;
  width: 100%;
  padding: 12px 15px;
  margin: 8px 0;
  background: transparent;
  color: #b30000;
  border: 1px solid #400;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.nav-button:hover {
  background: rgba(179, 0, 0, 0.1);
  border-color: #b30000;
  transform: translateX(5px);
}

.nav-button.active {
  background: rgba(179, 0, 0, 0.2);
  border-color: #b30000;
  color: #ff3333;
}

/* ===============================
   CONTEÚDO CENTRAL
================================ */
#main-content {
  padding: 30px;
  overflow-y: auto;
  background: rgba(10, 0, 0, 0.4);
}

.content-section {
  display: none;
  animation: fadeIn 0.5s;
}

.content-section.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===============================
   PAINEL DIREITO
================================ */
#right-panel {
  background: rgba(20, 0, 0, 0.8);
  border-left: 2px solid #400;
  padding: 25px 20px;
  overflow-y: auto;
}

.chat-tabs {
  display: flex;
  border-bottom: 1px solid #400;
  margin-bottom: 15px;
}

.chat-tab {
  flex: 1;
  padding: 10px;
  background: transparent;
  color: #666;
  border: none;
  border-bottom: 2px solid transparent;
  cursor: pointer;
  font-size: 0.8rem;
  text-transform: uppercase;
  transition: all 0.3s;
}

.chat-tab.active {
  color: #b30000;
  border-bottom: 2px solid #b30000;
}

.chat-container {
  display: none;
  border: 1px solid #400;
  background: rgba(0, 0, 0, 0.7);
  padding: 15px;
  margin-bottom: 20px;
  height: 300px;
  flex-direction: column;
}

.chat-container.active {
  display: flex;
}

.chat-messages {
  flex: 1;
  overflow-y: auto;
  margin-bottom: 15px;
  padding: 10px;
  background: #000;
  border: 1px solid #300;
}

.chat-message {
  margin-bottom: 10px;
  padding: 8px;
  border-bottom: 1px solid #222;
}

.chat-message .sender {
  color: #b30000;
  font-weight: bold;
  margin-right: 8px;
  cursor: pointer;
}

.chat-message .sender:hover {
  text-decoration: underline;
}

.chat-input {
  display: flex;
  gap: 10px;
}

.chat-input input {
  flex: 1;
  background: #111;
  border: 1px solid #400;
  color: #eee;
  padding: 8px 12px;
}

.chat-input button {
  background: #400;
  color: #eee;
  border: 1px solid #600;
  padding: 8px 15px;
  cursor: pointer;
}

.chat-input button:hover {
  background: #600;
}

/* ===============================
   CARDS E LISTAS
================================ */
.card {
  background: rgba(20, 0, 0, 0.5);
  border: 1px solid #400;
  padding: 20px;
  margin-bottom: 20px;
}

.list-item {
  padding: 15px;
  margin-bottom: 10px;
  background: rgba(10, 0, 0, 0.3);
  border-left: 3px solid #400;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

/* ===============================
   HIERARQUIA
================================ */
.rank-badge {
  display: inline-block;
  padding: 3px 12px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: bold;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-left: 10px;
}

.rank-nucleo {
  background: linear-gradient(135deg, #daa520 0%, #b8860b 100%);
  color: #000;
  border: 1px solid #ffd700;
}

.rank-iniciado {
  background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
  color: #fff;
  border: 1px solid #3b82f6;
}

.rank-observador {
  background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
  color: #d1d5db;
  border: 1px solid #6b7280;
}

/* ===============================
   MODAL CHAT PRIVADO
================================ */
.chat-modal {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.9);
  z-index: 1000;
  display: none;
  align-items: center;
  justify-content: center;
}

.chat-modal-content {
  background: #111;
  border: 2px solid #400;
  width: 90%;
  max-width: 600px;
  height: 70vh;
  display: flex;
  flex-direction: column;
}

.chat-modal-header {
  padding: 15px 20px;
  background: rgba(20, 0, 0, 0.8);
  border-bottom: 1px solid #400;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.chat-modal-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: #000;
}

.chat-modal-input {
  padding: 15px;
  border-top: 1px solid #400;
  display: flex;
  gap: 10px;
}

/* ===============================
   SCROLLBAR
================================ */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #111;
}

::-webkit-scrollbar-thumb {
  background: #400;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #600;
}

/* ===============================
   BOTÕES PEQUENOS
================================ */
.btn-small {
  padding: 5px 10px;
  font-size: 0.7rem;
  margin-left: 5px;
}

.btn-secondary {
  background: transparent;
  color: #b30000;
  border: 1px solid #400;
  padding: 8px 15px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-secondary:hover {
  background: rgba(179, 0, 0, 0.1);
}
</style>
</head>
<body>

<!-- TELA DE LOGIN -->
<div id="login-screen">
  <div class="login-container">
    <div class="login-tabs">
      <button class="login-tab active" onclick="showLoginForm('login')">Entrar</button>
      <button class="login-tab" onclick="showLoginForm('register')">Criar Conta</button>
      <button class="login-tab" onclick="showLoginForm('key')">Chave Renova</button>
    </div>
    
    <div id="login-form" class="login-form active">
      <div class="form-group">
        <label>Nome de Usuário</label>
        <input type="text" id="login-username" class="form-control" placeholder="Digite seu usuário" value="admin">
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="login-password" class="form-control" placeholder="Digite sua senha" value="admin123">
      </div>
      <button class="btn-primary" onclick="login()">Entrar na Rede</button>
      <div style="margin-top: 15px; text-align: center; color: #666; font-size: 0.8rem;">
        Usuário de teste: admin / admin123
      </div>
    </div>
    
    <div id="register-form" class="login-form">
      <div class="form-group">
        <label>Nome de Usuário</label>
        <input type="text" id="register-username" class="form-control" placeholder="Escolha um nome único">
      </div>
      <div class="form-group">
        <label>Senha</label>
        <input type="password" id="register-password" class="form-control" placeholder="Mínimo 6 caracteres">
      </div>
      <div class="form-group">
        <label>Confirmar Senha</label>
        <input type="password" id="register-confirm" class="form-control" placeholder="Digite a senha novamente">
      </div>
      <button class="btn-primary" onclick="register()">Criar Conta</button>
    </div>
    
    <div id="key-form" class="login-form">
      <div class="form-group">
        <label>Nome de Usuário</label>
        <input type="text" id="key-username" class="form-control" placeholder="Seu nome de usuário">
      </div>
      <div class="form-group">
        <label>Chave de Acesso</label>
        <input type="password" id="key-password" class="form-control" placeholder="Digite a chave secreta">
      </div>
      <button class="btn-primary" onclick="useKey()">Ativar Chave</button>
      <div style="margin-top: 15px; text-align: center; color: #666; font-size: 0.8rem;">
        Acesso ao Núcleo: Chave Renova
      </div>
    </div>
  </div>
</div>

<!-- APLICATIVO PRINCIPAL -->
<div id="main-app" class="hidden">
  <div id="banner">
    <div class="banner-title">ALGEBRA RENOVA</div>
    <div class="system-status">
      <div class="status-item">
        <span class="status-value" id="member-count">0</span>
        <span>MEMBROS</span>
      </div>
      <div class="status-item">
        <span class="status-value" id="theory-count">0</span>
        <span>TEORIAS</span>
      </div>
      <div class="status-item">
        <button class="btn-primary" onclick="logout()" style="padding: 8px 20px; font-size: 0.8rem;">Sair</button>
      </div>
    </div>
  </div>

  <div class="container">
    
    <!-- SIDEBAR ESQUERDA -->
    <aside id="sidebar">
      <div class="profile-section">
        <div class="avatar-container">
          <div class="avatar-placeholder" id="avatar-placeholder">A</div>
        </div>
        <h3 id="username-display">Carregando...</h3>
        <div id="user-rank" class="rank-badge rank-observador">Observador</div>
        <div style="margin-top: 20px;">
          <button class="btn-primary" onclick="editProfile()" style="width: 100%;">Editar Perfil</button>
        </div>
      </div>

      <div class="nav-section">
        <button class="nav-button active" onclick="showSection('dashboard')">Dashboard</button>
        <button class="nav-button" onclick="showSection('theories')">Teorias</button>
        <button class="nav-button" onclick="showSection('archive')">Arquivo</button>
        <button class="nav-button" onclick="showSection('bounty')">Desafios</button>
        <button class="nav-button" onclick="showSection('members')">Membros</button>
        <button class="nav-button" onclick="showSection('friends')">Amigos</button>
      </div>

      <div class="nav-section">
        <h4 style="color: #b30000; margin-bottom: 15px;">Ferramentas</h4>
        <button class="nav-button" onclick="showSection('editor')" id="editor-btn">Editor Teórico</button>
        <button class="nav-button" onclick="showSection('create-bounty')" id="create-bounty-btn">Criar Desafio</button>
      </div>
    </aside>

    <!-- CONTEÚDO CENTRAL -->
    <main id="main-content">
      
      <!-- DASHBOARD -->
      <section id="dashboard" class="content-section active">
        <h2>Dashboard do Sistema</h2>
        <div class="card">
          <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #300;">
            <div style="color: #b30000; font-size: 1.2rem;">Status da Rede</div>
            <div style="color: #666; font-size: 0.8rem;">Atualizado: <span id="last-update"></span></div>
          </div>
          <p>Plataforma operacional. Sistema de hierarquia rigorosa implementado.</p>
          <div style="margin-top: 20px;">
            <div class="list-item">
              <span>Teorias Ativas</span>
              <span id="active-theories">0</span>
            </div>
            <div class="list-item">
              <span>Desafios em Aberto</span>
              <span id="open-bounties">0</span>
            </div>
            <div class="list-item">
              <span>Membros Conectados</span>
              <span id="online-count">0</span>
            </div>
            <div class="list-item">
              <span>Suas Conexões</span>
              <span id="my-connections-count">0</span>
            </div>
          </div>
        </div>

        <h3>Atividades Recentes</h3>
        <div id="recent-activities" style="margin-top: 20px;">
          <!-- Atividades serão carregadas aqui -->
        </div>
      </section>

      <!-- TEORIAS -->
      <section id="theories" class="content-section">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h2>Teorias Publicadas</h2>
          <button class="btn-primary" id="new-theory-btn" onclick="showSection('editor')">Nova Teoria</button>
        </div>
        <div id="theories-list">
          <!-- Teorias serão carregadas aqui -->
        </div>
      </section>

      <!-- EDITOR TEÓRICO -->
      <section id="editor" class="content-section">
        <h2>Editor Teórico</h2>
        <div class="card">
          <div class="form-group">
            <label for="theory-title">Título da Teoria</label>
            <input type="text" id="theory-title" class="form-control" placeholder="Ex: Álgebra Não-Associativa">
          </div>
          <div class="form-group">
            <label for="theory-content">Conteúdo</label>
            <textarea id="theory-content" class="form-control" placeholder="Descreva sua teoria..." rows="10"></textarea>
          </div>
          <div class="form-group">
            <label for="theory-tags">Tags</label>
            <input type="text" id="theory-tags" class="form-control" placeholder="álgebra, matemática">
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button class="btn-primary" onclick="publishTheory()">Publicar Teoria</button>
            <button class="btn-primary" onclick="showSection('theories')" style="background: #333; margin-left: 10px;">Cancelar</button>
          </div>
        </div>
      </section>

      <!-- ARQUIVO -->
      <section id="archive" class="content-section">
        <h2>Arquivo de Referências</h2>
        <div class="card">
          <div class="form-group">
            <label for="ref-title">Título da Referência</label>
            <input type="text" id="ref-title" class="form-control" placeholder="Título do artigo">
          </div>
          <div class="form-group">
            <label for="ref-url">URL ou DOI</label>
            <input type="text" id="ref-url" class="form-control" placeholder="https://...">
          </div>
          <div class="form-group">
            <label for="ref-description">Descrição</label>
            <textarea id="ref-description" class="form-control" placeholder="Resumo..."></textarea>
          </div>
          <button class="btn-primary" onclick="addReference()">Adicionar ao Arquivo</button>
        </div>

        <div id="references-list" style="margin-top: 30px;">
          <!-- Referências serão carregadas aqui -->
        </div>
      </section>

      <!-- DESAFIOS -->
      <section id="bounty" class="content-section">
        <h2>Quadro de Desafios</h2>
        <div id="bounty-board">
          <!-- Desafios serão carregados aqui -->
        </div>
      </section>

      <!-- CRIAR DESAFIO -->
      <section id="create-bounty" class="content-section">
        <h2>Criar Novo Desafio</h2>
        <div class="card">
          <div class="form-group">
            <label for="bounty-title">Título do Desafio</label>
            <input type="text" id="bounty-title" class="form-control" placeholder="Ex: Problema da Auto-Similaridade Algébrica">
          </div>
          <div class="form-group">
            <label for="bounty-description">Descrição</label>
            <textarea id="bounty-description" class="form-control" placeholder="Descreva o problema matemático..." rows="8"></textarea>
          </div>
          <div class="form-group">
            <label for="bounty-reward">Recompensa</label>
            <input type="text" id="bounty-reward" class="form-control" placeholder="Ex: Acesso ao Núcleo por 30 dias">
          </div>
          <div style="text-align: center; margin-top: 20px;">
            <button class="btn-primary" onclick="createBounty()">Criar Desafio</button>
            <button class="btn-primary" onclick="showSection('bounty')" style="background: #333; margin-left: 10px;">Cancelar</button>
          </div>
        </div>
      </section>

      <!-- MEMBROS -->
      <section id="members" class="content-section">
        <h2>Membros da Rede</h2>
        <div class="form-group">
          <input type="text" id="search-member" class="form-control" placeholder="Buscar membro..." onkeyup="searchMembers()">
        </div>
        <div id="members-list">
          <!-- Membros serão carregados aqui -->
        </div>
      </section>

      <!-- AMIGOS -->
      <section id="friends" class="content-section">
        <h2>Seus Amigos</h2>
        <div id="friends-list">
          <!-- Amigos serão carregados aqui -->
        </div>
        
        <h3 style="margin-top: 30px;">Solicitações de Amizade</h3>
        <div id="friend-requests-list">
          <!-- Solicitações serão carregadas aqui -->
        </div>
      </section>

    </main>

    <!-- PAINEL DIREITO -->
    <aside id="right-panel">
      <div class="chat-tabs">
        <button class="chat-tab active" onclick="showChat('global')">Global</button>
        <button class="chat-tab" onclick="showChat('bounty')">Desafios</button>
        <button class="chat-tab" onclick="showChat('private')">Privado</button>
      </div>

      <!-- CHAT GLOBAL -->
      <div id="chat-global" class="chat-container active">
        <div class="chat-messages" id="chat-messages-global"></div>
        <div class="chat-input">
          <input type="text" id="chat-input-global" placeholder="Mensagem para todos..." onkeypress="if(event.key==='Enter') sendGlobalChat()">
          <button onclick="sendGlobalChat()">Enviar</button>
        </div>
      </div>

      <!-- CHAT DE DESAFIOS -->
      <div id="chat-bounty" class="chat-container">
        <div class="chat-messages" id="chat-messages-bounty"></div>
        <div class="chat-input">
          <input type="text" id="chat-input-bounty" placeholder="Discuta soluções..." onkeypress="if(event.key==='Enter') sendBountyChat()">
          <button onclick="sendBountyChat()">Enviar</button>
        </div>
      </div>

      <!-- CHAT PRIVADO -->
      <div id="chat-private" class="chat-container">
        <div id="chat-contacts-list"></div>
        <div class="chat-input">
          <input type="text" id="search-contact" placeholder="Buscar contato..." onkeyup="searchContacts()">
        </div>
      </div>

      <!-- LOG -->
      <div style="margin-top: 30px;">
        <h4 style="color: #b30000; margin-bottom: 10px;">Log do Sistema</h4>
        <div id="activity-log" style="max-height: 200px; overflow-y: auto; font-size: 0.8rem;">
          <!-- Log será carregado aqui -->
        </div>
      </div>
    </aside>
  </div>
</div>

<!-- MODAL CHAT PRIVADO -->
<div id="private-chat-modal" class="chat-modal">
  <div class="chat-modal-content">
    <div class="chat-modal-header">
      <h3 id="chat-with-user">Chat com Usuário</h3>
      <button class="btn-secondary" onclick="closePrivateChat()" style="padding: 5px 10px;">Fechar</button>
    </div>
    <div class="chat-modal-messages" id="private-chat-messages"></div>
    <div class="chat-modal-input">
      <input type="text" id="private-chat-input" placeholder="Digite sua mensagem..." onkeypress="if(event.key==='Enter') sendPrivateMessage()">
      <button class="btn-primary" onclick="sendPrivateMessage()">Enviar</button>
    </div>
  </div>
</div>

<script>
// ===============================
// SISTEMA DE DADOS
// ===============================
let currentUser = null;
let users = [];
let theories = [];
let references = [];
let bounties = [];
let globalChat = [];
let bountyChat = [];
let privateMessages = {};
let friendRequests = {};
let activities = [];

// ===============================
// INICIALIZAÇÃO
// ===============================
function initialize() {
  loadData();
  
  // Se já houver usuário logado, mostrar app
  if (currentUser) {
    showApp();
  } else {
    // Criar usuários padrão se não existirem
    if (users.length === 0) {
      createDefaultUsers();
    }
  }
}

function loadData() {
  // Carregar do localStorage
  users = JSON.parse(localStorage.getItem('ar_users')) || [];
  currentUser = JSON.parse(localStorage.getItem('ar_currentUser')) || null;
  theories = JSON.parse(localStorage.getItem('ar_theories')) || [];
  references = JSON.parse(localStorage.getItem('ar_references')) || [];
  bounties = JSON.parse(localStorage.getItem('ar_bounties')) || [];
  globalChat = JSON.parse(localStorage.getItem('ar_globalChat')) || [];
  bountyChat = JSON.parse(localStorage.getItem('ar_bountyChat')) || [];
  privateMessages = JSON.parse(localStorage.getItem('ar_privateMessages')) || {};
  friendRequests = JSON.parse(localStorage.getItem('ar_friendRequests')) || {};
  activities = JSON.parse(localStorage.getItem('ar_activities')) || [];
  
  // Criar alguns desafios de exemplo se não existirem
  if (bounties.length === 0) {
    createExampleBounties();
  }
}

function saveData() {
  localStorage.setItem('ar_users', JSON.stringify(users));
  localStorage.setItem('ar_currentUser', JSON.stringify(currentUser));
  localStorage.setItem('ar_theories', JSON.stringify(theories));
  localStorage.setItem('ar_references', JSON.stringify(references));
  localStorage.setItem('ar_bounties', JSON.stringify(bounties));
  localStorage.setItem('ar_globalChat', JSON.stringify(globalChat));
  localStorage.setItem('ar_bountyChat', JSON.stringify(bountyChat));
  localStorage.setItem('ar_privateMessages', JSON.stringify(privateMessages));
  localStorage.setItem('ar_friendRequests', JSON.stringify(friendRequests));
  localStorage.setItem('ar_activities', JSON.stringify(activities));
}

function createDefaultUsers() {
  const adminUser = {
    id: 'admin_' + Date.now(),
    username: 'admin',
    password: 'admin123',
    rank: 'nucleo',
    avatar: '',
    bio: 'Administrador do sistema',
    interests: ['álgebra', 'matemática'],
    friends: [],
    joinDate: new Date().toISOString()
  };

  const testUser = {
    id: 'user_' + Date.now(),
    username: 'pesquisador',
    password: 'teste123',
    rank: 'iniciado',
    avatar: '',
    bio: 'Pesquisador em álgebra',
    interests: ['álgebra avançada'],
    friends: [],
    joinDate: new Date().toISOString()
  };

  users.push(adminUser, testUser);
  saveData();
}

function createExampleBounties() {
  const bounty1 = {
    id: Date.now(),
    title: 'Problema da Auto-Similaridade Algébrica',
    description: 'Encontre uma estrutura algébrica não-associativa que seja isomorfa a um de seus subconjuntos próprios. Considere espaços de dimensão infinita.',
    reward: 'Acesso ao Núcleo por 30 dias',
    createdBy: 'admin',
    createdById: users.find(u => u.username === 'admin')?.id,
    createdAt: new Date().toISOString(),
    status: 'open',
    submissions: []
  };

  const bounty2 = {
    id: Date.now() + 1,
    title: 'Demonstração da Conjectura da Borboleta',
    description: 'Prove que toda transformação algébrica radical pode ser representada como composição de duas involuções não-lineares.',
    reward: 'Título de Iniciado Permanente',
    createdBy: 'admin',
    createdById: users.find(u => u.username === 'admin')?.id,
    createdAt: new Date().toISOString(),
    status: 'open',
    submissions: []
  };

  bounties.push(bounty1, bounty2);
  saveData();
}

// ===============================
// SISTEMA DE LOGIN
// ===============================
function showLoginForm(form) {
  // Esconder todos os formulários
  document.querySelectorAll('.login-form').forEach(f => {
    f.classList.remove('active');
  });
  
  // Remover active de todas as tabs
  document.querySelectorAll('.login-tab').forEach(t => {
    t.classList.remove('active');
  });
  
  // Mostrar formulário selecionado
  document.getElementById(form + '-form').classList.add('active');
  
  // Ativar tab selecionada
  document.querySelector(`[onclick="showLoginForm('${form}')"]`).classList.add('active');
}

function login() {
  const username = document.getElementById('login-username').value.trim();
  const password = document.getElementById('login-password').value;
  
  if (!username || !password) {
    alert('Preencha todos os campos');
    return;
  }
  
  // Procurar usuário
  const user = users.find(u => u.username === username && u.password === password);
  
  if (user) {
    currentUser = user;
    saveData();
    showApp();
    logActivity(`${username} entrou na rede`);
  } else {
    alert('Usuário ou senha incorretos');
  }
}

function register() {
  const username = document.getElementById('register-username').value.trim();
  const password = document.getElementById('register-password').value;
  const confirm = document.getElementById('register-confirm').value;
  
  if (!username || !password) {
    alert('Usuário e senha são obrigatórios');
    return;
  }
  
  if (password.length < 6) {
    alert('Senha deve ter pelo menos 6 caracteres');
    return;
  }
  
  if (password !== confirm) {
    alert('As senhas não coincidem');
    return;
  }
  
  // Verificar se usuário já existe
  if (users.some(u => u.username === username)) {
    alert('Nome de usuário já existe');
    return;
  }
  
  // Criar novo usuário
  const newUser = {
    id: 'user_' + Date.now(),
    username: username,
    password: password,
    rank: 'observador',
    avatar: '',
    bio: '',
    interests: [],
    friends: [],
    joinDate: new Date().toISOString()
  };
  
  users.push(newUser);
  currentUser = newUser;
  
  // Inicializar estruturas do usuário
  privateMessages[newUser.id] = {};
  friendRequests[newUser.id] = [];
  
  saveData();
  showApp();
  logActivity(`Novo membro: ${username}`);
}

function useKey() {
  const username = document.getElementById('key-username').value.trim();
  const key = document.getElementById('key-password').value;
  
  if (!username || !key) {
    alert('Preencha todos os campos');
    return;
  }
  
  // Encontrar usuário
  const user = users.find(u => u.username === username);
  
  if (!user) {
    alert('Usuário não encontrado');
    return;
  }
  
  // Verificar chave (Renova)
  if (key === 'Renova') {
    user.rank = 'nucleo';
    currentUser = user;
    saveData();
    showApp();
    logActivity(`${username} ativou a Chave Renova e ascendeu ao Núcleo`);
    alert('Chave aceita. Bem-vindo ao Núcleo.');
  } else {
    alert('Chave incorreta');
  }
}

function logout() {
  if (confirm('Tem certeza que deseja sair?')) {
    logActivity(`${currentUser.username} saiu da rede`);
    currentUser = null;
    localStorage.removeItem('ar_currentUser');
    
    // Mostrar tela de login
    document.getElementById('login-screen').classList.remove('hidden');
    document.getElementById('main-app').classList.add('hidden');
  }
}

function showApp() {
  // Esconder tela de login
  document.getElementById('login-screen').classList.add('hidden');
  
  // Mostrar app
  document.getElementById('main-app').classList.remove('hidden');
  
  // Atualizar interface
  updateUserDisplay();
  updateCounters();
  renderTheories();
  renderReferences();
  renderBounties();
  renderMembers();
  renderFriends();
  renderFriendRequests();
  renderGlobalChat();
  renderBountyChat();
  renderActivities();
  showChat('global');
  
  // Criar algumas teorias de exemplo se não existirem
  if (theories.length === 0) {
    createExampleContent();
  }
}

// ===============================
// INTERFACE DO USUÁRIO
// ===============================
function updateUserDisplay() {
  if (!currentUser) return;
  
  document.getElementById('username-display').textContent = currentUser.username;
  
  const rank = getRankDisplay(currentUser.rank);
  document.getElementById('user-rank').textContent = rank.name;
  document.getElementById('user-rank').className = `rank-badge ${rank.class}`;
  
  // Avatar
  const avatarPlaceholder = document.getElementById('avatar-placeholder');
  if (currentUser.avatar) {
    avatarPlaceholder.innerHTML = `<img src="${currentUser.avatar}" alt="${currentUser.username}" style="width:100%;height:100%;object-fit:cover;">`;
  } else {
    avatarPlaceholder.textContent = currentUser.username.charAt(0);
  }
  
  // Permissões
  document.getElementById('new-theory-btn').style.display = 
    canPublishTheory() ? 'block' : 'none';
  
  document.getElementById('create-bounty-btn').style.display = 
    canCreateBounty() ? 'block' : 'none';
}

function getRankDisplay(rank) {
  const ranks = {
    'nucleo': { name: 'Núcleo', class: 'rank-nucleo' },
    'iniciado': { name: 'Iniciado', class: 'rank-iniciado' },
    'observador': { name: 'Observador', class: 'rank-observador' }
  };
  return ranks[rank] || ranks.observador;
}

function canPublishTheory() {
  return currentUser && ['nucleo', 'iniciado'].includes(currentUser.rank);
}

function canCreateBounty() {
  return currentUser && currentUser.rank === 'nucleo';
}

function updateCounters() {
  if (!currentUser) return;
  
  document.getElementById('member-count').textContent = users.length;
  document.getElementById('theory-count').textContent = theories.length;
  document.getElementById('online-count').textContent = users.length;
  document.getElementById('my-connections-count').textContent = currentUser.friends.length;
  document.getElementById('active-theories').textContent = theories.length;
  document.getElementById('open-bounties').textContent = bounties.filter(b => b.status === 'open').length;
  document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
}

// ===============================
// NAVEGAÇÃO
// ===============================
function showSection(sectionId) {
  // Esconder todas as seções
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Remover active de todos os botões
  document.querySelectorAll('.nav-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Mostrar seção selecionada
  const section = document.getElementById(sectionId);
  if (section) {
    section.classList.add('active');
  }
  
  // Ativar botão correspondente
  const button = document.querySelector(`.nav-button[onclick="showSection('${sectionId}')"]`);
  if (button) {
    button.classList.add('active');
  }
}

function showChat(chatType) {
  // Esconder todos os chats
  document.querySelectorAll('.chat-container').forEach(chat => {
    chat.classList.remove('active');
  });
  
  // Remover active de todas as tabs
  document.querySelectorAll('.chat-tab').forEach(tab => {
    tab.classList.remove('active');
  });
  
  // Mostrar chat selecionado
  document.getElementById('chat-' + chatType).classList.add('active');
  
  // Ativar tab correspondente
  document.querySelector(`.chat-tab[onclick="showChat('${chatType}')"]`).classList.add('active');
  
  if (chatType === 'private') {
    renderContacts();
  }
}

// ===============================
// TEORIAS
// ===============================
function publishTheory() {
  if (!currentUser) {
    alert('Você precisa estar logado');
    return;
  }
  
  if (!canPublishTheory()) {
    alert('Apenas membros do Núcleo e Iniciados podem publicar teorias');
    return;
  }
  
  const title = document.getElementById('theory-title').value.trim();
  const content = document.getElementById('theory-content').value.trim();
  const tags = document.getElementById('theory-tags').value.trim();
  
  if (!title || !content) {
    alert('Título e conteúdo são obrigatórios');
    return;
  }
  
  const theory = {
    id: Date.now(),
    title: title,
    content: content,
    tags: tags ? tags.split(',').map(t => t.trim()) : [],
    author: currentUser.username,
    authorId: currentUser.id,
    authorRank: currentUser.rank,
    createdAt: new Date().toISOString(),
    views: 0
  };
  
  theories.unshift(theory);
  saveData();
  
  // Limpar formulário
  document.getElementById('theory-title').value = '';
  document.getElementById('theory-content').value = '';
  document.getElementById('theory-tags').value = '';
  
  // Voltar para teorias
  showSection('theories');
  renderTheories();
  logActivity(`${currentUser.username} publicou uma nova teoria: "${title}"`);
}

function renderTheories() {
  const container = document.getElementById('theories-list');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (theories.length === 0) {
    container.innerHTML = '<p style="color: #666;">Nenhuma teoria publicada ainda.</p>';
    return;
  }
  
  theories.forEach(theory => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #300;">
        <div style="color: #b30000; font-size: 1.2rem;">${theory.title}</div>
        <div style="color: #666; font-size: 0.8rem;">Por: ${theory.author}</div>
      </div>
      <div>${theory.content}</div>
      <div style="margin-top: 15px;">
        <span style="color: #666; font-size: 0.8rem;">Tags: ${theory.tags.join(', ') || 'Nenhuma'}</span>
      </div>
    `;
    container.appendChild(card);
  });
}

// ===============================
// DESAFIOS
// ===============================
function createBounty() {
  if (!currentUser) {
    alert('Você precisa estar logado');
    return;
  }
  
  if (!canCreateBounty()) {
    alert('Apenas membros do Núcleo podem criar desafios');
    return;
  }
  
  const title = document.getElementById('bounty-title').value.trim();
  const description = document.getElementById('bounty-description').value.trim();
  const reward = document.getElementById('bounty-reward').value.trim();
  
  if (!title || !description || !reward) {
    alert('Preencha todos os campos');
    return;
  }
  
  const bounty = {
    id: Date.now(),
    title: title,
    description: description,
    reward: reward,
    createdBy: currentUser.username,
    createdById: currentUser.id,
    createdAt: new Date().toISOString(),
    status: 'open',
    submissions: []
  };
  
  bounties.unshift(bounty);
  saveData();
  
  // Limpar formulário
  document.getElementById('bounty-title').value = '';
  document.getElementById('bounty-description').value = '';
  document.getElementById('bounty-reward').value = '';
  
  // Voltar para desafios
  showSection('bounty');
  renderBounties();
  logActivity(`${currentUser.username} criou um novo desafio: "${title}"`);
}

function renderBounties() {
  const container = document.getElementById('bounty-board');
  if (!container) return;
  
  container.innerHTML = '';
  
  if (bounties.length === 0) {
    container.innerHTML = '<p style="color: #666;">Nenhum desafio disponível.</p>';
    return;
  }
  
  bounties.forEach(bounty => {
    const card = document.createElement('div');
    card.className = 'card';
    card.innerHTML = `
      <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; padding-bottom: 10px; border-bottom: 1px solid #300;">
        <div style="color: #b30000; font-size: 1.2rem;">${bounty.title}</div>
        <span class="rank-badge ${bounty.status === 'open' ? 'rank-iniciado' : 'rank-observador'}" style="font-size: 0.7rem;">
          ${bounty.status === 'open' ? 'ABERTO' : 'RESOLVIDO'}
        </span>
      </div>
      <p>${bounty.description}</p>
      <div style="margin-top: 15px;">
        <div style="color: #daa520; margin-bottom: 10px;">
          <strong>Recompensa:</strong> ${bounty.reward}
        </div>
        <div style="color: #666; font-size: 0.8rem;">
          Criado por: ${bounty.createdBy} • ${new Date(bounty.createdAt).toLocaleDateString()}
        </div>
      </div>
      ${bounty.status === 'open' ? `
        <div style="margin-top: 20px;">
          <button class="btn-primary" onclick="submitSolution(${bounty.id})" style="padding: 8px 15px; font-size: 0.8rem;">Submeter Solução</button>
        </div>
      ` : ''}
    `;
    container.appendChild(card);
  });
}

function submitSolution(bountyId) {
  const solution = prompt('Descreva sua solução para este desafio:');
  if (solution && solution.trim()) {
    const bounty = bounties.find(b => b.id === bountyId);
    if (bounty) {
      bounty.submissions.push({
        user: currentUser.username,
        userId: currentUser.id,
        solution: solution.trim(),
        submittedAt: new Date().toISOString()
      });
      saveData();
      alert('Solução submetida para análise do Núcleo.');
      logActivity(`${currentUser.username} submeteu uma solução para: "${bounty.title}"`);
    }
  }
}

// ===============================
// ARQUIVO
// ===============================
function addReference() {
  if (!currentUser) return;
  
  const title = document.getElementById('ref-title').value.trim();
  const url = document.getElementById('ref-url').value.trim();
  const description = document.getElementById('ref-description').value.trim();
  
  if (!title) {
    alert('Título é obrigatório');
    return;
  }
  
  const reference = {
    id: Date.now(),
    title: title,
    url: url,
    description: description,
    addedBy: currentUser.username,
    addedById: currentUser.id,
    addedAt: new Date().toISOString()
  };
  
  references.unshift(reference);
  saveData();
  
  // Limpar formulário
  document.getElementById('ref-title').value = '';
  document.getElementById('ref-url').value = '';
  document.getElementById('ref-description').value = '';
  
  renderReferences();
  logActivity(`${currentUser.username} adicionou uma referência: "${title}"`);
}

function renderReferences() {
  const container = document.getElementById('references-list');
  if (!container) return;
  
  container.innerHTML = '';
  
  references.forEach(ref => {
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div>
        <strong>${ref.title}</strong><br>
        <small style="color: #666;">${ref.url}</small><br>
        <small>${ref.description}</small>
      </div>
      <div style="text-align: right;">
        <small>Por: ${ref.addedBy}</small>
      </div>
    `;
    container.appendChild(item);
  });
}

// ===============================
// MEMBROS
// ===============================
function renderMembers() {
  const container = document.getElementById('members-list');
  if (!container || !currentUser) return;
  
  container.innerHTML = '';
  
  users.forEach(user => {
    if (user.id === currentUser.id) return;
    
    const rank = getRankDisplay(user.rank);
    const isFriend = currentUser.friends.includes(user.id);
    const hasRequest = friendRequests[user.id]?.includes(currentUser.id) || 
                      friendRequests[currentUser.id]?.includes(user.id);
    
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center;">
          ${user.avatar ? 
            `<img src="${user.avatar}" alt="${user.username}" style="width:100%;height:100%;border-radius:50%;">` : 
            user.username.charAt(0)
          }
        </div>
        <div>
          <strong>${user.username}</strong><br>
          <span class="rank-badge ${rank.class}" style="font-size: 0.7rem;">${rank.name}</span>
        </div>
      </div>
      <div>
        ${isFriend ? 
          `<button class="btn-primary" onclick="startPrivateChat('${user.id}')" style="padding: 5px 10px; font-size: 0.7rem;">Mensagem</button>` :
          hasRequest ?
          `<button class="btn-primary" style="padding: 5px 10px; font-size: 0.7rem; background: #666;" disabled>Solicitado</button>` :
          `<button class="btn-primary" onclick="sendFriendRequest('${user.id}')" style="padding: 5px 10px; font-size: 0.7rem;">Adicionar</button>`
        }
      </div>
    `;
    container.appendChild(item);
  });
}

function searchMembers() {
  const searchTerm = document.getElementById('search-member').value.toLowerCase();
  const items = document.querySelectorAll('#members-list .list-item');
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
  });
}

// ===============================
// AMIZADES
// ===============================
function sendFriendRequest(targetUserId) {
  if (!currentUser) return;
  
  const targetUser = users.find(u => u.id === targetUserId);
  if (!targetUser) return;
  
  if (currentUser.friends.includes(targetUserId)) {
    alert('Você já é amigo deste usuário');
    return;
  }
  
  if (!friendRequests[targetUserId]) {
    friendRequests[targetUserId] = [];
  }
  
  if (friendRequests[targetUserId].includes(currentUser.id)) {
    alert('Solicitação já enviada');
    return;
  }
  
  friendRequests[targetUserId].push(currentUser.id);
  saveData();
  
  alert(`Solicitação enviada para ${targetUser.username}`);
  renderMembers();
  logActivity(`${currentUser.username} enviou solicitação para ${targetUser.username}`);
}

function acceptFriendRequest(fromUserId) {
  const fromUser = users.find(u => u.id === fromUserId);
  if (!fromUser || !currentUser) return;
  
  // Adicionar como amigo
  currentUser.friends.push(fromUserId);
  fromUser.friends.push(currentUser.id);
  
  // Remover solicitação
  const index = friendRequests[currentUser.id]?.indexOf(fromUserId);
  if (index !== -1) {
    friendRequests[currentUser.id].splice(index, 1);
  }
  
  saveData();
  
  renderFriendRequests();
  renderFriends();
  renderMembers();
  logActivity(`${currentUser.username} aceitou amizade de ${fromUser.username}`);
}

function rejectFriendRequest(fromUserId) {
  const fromUser = users.find(u => u.id === fromUserId);
  if (!fromUser || !currentUser) return;
  
  const index = friendRequests[currentUser.id]?.indexOf(fromUserId);
  if (index !== -1) {
    friendRequests[currentUser.id].splice(index, 1);
    saveData();
  }
  
  renderFriendRequests();
  logActivity(`${currentUser.username} rejeitou amizade de ${fromUser.username}`);
}

function removeFriend(friendId) {
  const friend = users.find(u => u.id === friendId);
  if (!friend || !currentUser) return;
  
  // Remover de ambas as listas
  const userIndex = currentUser.friends.indexOf(friendId);
  const friendIndex = friend.friends.indexOf(currentUser.id);
  
  if (userIndex !== -1) currentUser.friends.splice(userIndex, 1);
  if (friendIndex !== -1) friend.friends.splice(friendIndex, 1);
  
  saveData();
  
  renderFriends();
  renderMembers();
  logActivity(`${currentUser.username} removeu ${friend.username} dos amigos`);
}

function renderFriends() {
  const container = document.getElementById('friends-list');
  if (!container || !currentUser) return;
  
  container.innerHTML = '';
  
  if (currentUser.friends.length === 0) {
    container.innerHTML = '<p style="color: #666;">Você ainda não tem amigos. Adicione alguns membros!</p>';
    return;
  }
  
  currentUser.friends.forEach(friendId => {
    const friend = users.find(u => u.id === friendId);
    if (!friend) return;
    
    const rank = getRankDisplay(friend.rank);
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center;">
          ${friend.avatar ? 
            `<img src="${friend.avatar}" alt="${friend.username}" style="width:100%;height:100%;border-radius:50%;">` : 
            friend.username.charAt(0)
          }
        </div>
        <div>
          <strong>${friend.username}</strong><br>
          <span class="rank-badge ${rank.class}" style="font-size: 0.7rem;">${rank.name}</span>
        </div>
      </div>
      <div>
        <button class="btn-primary" onclick="startPrivateChat('${friend.id}')" style="padding: 5px 10px; font-size: 0.7rem; margin-right: 5px;">Mensagem</button>
        <button class="btn-primary" onclick="removeFriend('${friend.id}')" style="padding: 5px 10px; font-size: 0.7rem; background: #400;">Remover</button>
      </div>
    `;
    container.appendChild(item);
  });
}

function renderFriendRequests() {
  const container = document.getElementById('friend-requests-list');
  if (!container || !currentUser) return;
  
  container.innerHTML = '';
  
  const requests = friendRequests[currentUser.id] || [];
  
  if (requests.length === 0) {
    container.innerHTML = '<p style="color: #666;">Nenhuma solicitação de amizade pendente.</p>';
    return;
  }
  
  requests.forEach(fromUserId => {
    const fromUser = users.find(u => u.id === fromUserId);
    if (!fromUser) return;
    
    const item = document.createElement('div');
    item.className = 'list-item';
    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center;">
          ${fromUser.avatar ? 
            `<img src="${fromUser.avatar}" alt="${fromUser.username}" style="width:100%;height:100%;border-radius:50%;">` : 
            fromUser.username.charAt(0)
          }
        </div>
        <div>
          <strong>${fromUser.username}</strong><br>
          <small style="color: #666;">Quer ser seu amigo</small>
        </div>
      </div>
      <div>
        <button class="btn-primary" onclick="acceptFriendRequest('${fromUserId}')" style="padding: 5px 10px; font-size: 0.7rem; margin-right: 5px;">Aceitar</button>
        <button class="btn-primary" onclick="rejectFriendRequest('${fromUserId}')" style="padding: 5px 10px; font-size: 0.7rem; background: #400;">Recusar</button>
      </div>
    `;
    container.appendChild(item);
  });
}

// ===============================
// CHAT
// ===============================
function sendGlobalChat() {
  const input = document.getElementById('chat-input-global');
  const message = input.value.trim();
  
  if (!currentUser || !message) return;
  
  const chatMessage = {
    id: Date.now(),
    user: currentUser.username,
    userId: currentUser.id,
    text: message,
    timestamp: new Date().toISOString()
  };
  
  globalChat.push(chatMessage);
  if (globalChat.length > 100) globalChat.shift();
  
  saveData();
  renderGlobalChat();
  input.value = '';
  input.focus();
}

function sendBountyChat() {
  const input = document.getElementById('chat-input-bounty');
  const message = input.value.trim();
  
  if (!currentUser || !message) return;
  
  const chatMessage = {
    id: Date.now(),
    user: currentUser.username,
    userId: currentUser.id,
    text: message,
    timestamp: new Date().toISOString()
  };
  
  bountyChat.push(chatMessage);
  if (bountyChat.length > 100) bountyChat.shift();
  
  saveData();
  renderBountyChat();
  input.value = '';
  input.focus();
}

function renderGlobalChat() {
  const container = document.getElementById('chat-messages-global');
  if (!container) return;
  
  container.innerHTML = '';
  
  globalChat.slice(-20).forEach(msg => {
    const div = document.createElement('div');
    div.className = 'chat-message';
    div.innerHTML = `
      <div>
        <span class="sender" onclick="startPrivateChat('${msg.userId}')">${msg.user}</span>
        <span style="color: #666; font-size: 0.7rem;">
          ${new Date(msg.timestamp).toLocaleTimeString()}
        </span>
      </div>
      <div>${msg.text}</div>
    `;
    container.appendChild(div);
  });
  
  container.scrollTop = container.scrollHeight;
}

function renderBountyChat() {
  const container = document.getElementById('chat-messages-bounty');
  if (!container) return;
  
  container.innerHTML = '';
  
  bountyChat.slice(-20).forEach(msg => {
    const div = document.createElement('div');
    div.className = 'chat-message';
    div.innerHTML = `
      <div>
        <span class="sender" onclick="startPrivateChat('${msg.userId}')">${msg.user}</span>
        <span style="color: #666; font-size: 0.7rem;">
          ${new Date(msg.timestamp).toLocaleTimeString()}
        </span>
      </div>
      <div>${msg.text}</div>
    `;
    container.appendChild(div);
  });
  
  container.scrollTop = container.scrollHeight;
}

// ===============================
// CHAT PRIVADO
// ===============================
let currentChatWith = null;

function startPrivateChat(userId) {
  const user = users.find(u => u.id === userId);
  if (!user) return;
  
  currentChatWith = userId;
  document.getElementById('chat-with-user').textContent = `Chat com ${user.username}`;
  document.getElementById('private-chat-modal').style.display = 'flex';
  
  renderPrivateChat();
  
  // Focar no input
  setTimeout(() => {
    document.getElementById('private-chat-input').focus();
  }, 100);
}

function closePrivateChat() {
  document.getElementById('private-chat-modal').style.display = 'none';
  currentChatWith = null;
}

function sendPrivateMessage() {
  const input = document.getElementById('private-chat-input');
  const message = input.value.trim();
  
  if (!currentUser || !currentChatWith || !message) return;
  
  const chatMessage = {
    id: Date.now(),
    from: currentUser.id,
    fromName: currentUser.username,
    to: currentChatWith,
    text: message,
    timestamp: new Date().toISOString()
  };
  
  // Inicializar se necessário
  if (!privateMessages[currentUser.id]) {
    privateMessages[currentUser.id] = {};
  }
  if (!privateMessages[currentChatWith]) {
    privateMessages[currentChatWith] = {};
  }
  if (!privateMessages[currentUser.id][currentChatWith]) {
    privateMessages[currentUser.id][currentChatWith] = [];
  }
  if (!privateMessages[currentChatWith][currentUser.id]) {
    privateMessages[currentChatWith][currentUser.id] = [];
  }
  
  // Adicionar mensagem
  privateMessages[currentUser.id][currentChatWith].push(chatMessage);
  privateMessages[currentChatWith][currentUser.id].push(chatMessage);
  
  saveData();
  
  renderPrivateChat();
  input.value = '';
  input.focus();
}

function renderPrivateChat() {
  const container = document.getElementById('private-chat-messages');
  if (!container || !currentChatWith) return;
  
  container.innerHTML = '';
  
  const messages = privateMessages[currentUser.id]?.[currentChatWith] || [];
  
  messages.forEach(msg => {
    const isFromMe = msg.from === currentUser.id;
    const div = document.createElement('div');
    div.className = 'chat-message';
    div.style.background = isFromMe ? 'rgba(64, 0, 0, 0.3)' : 'rgba(0, 20, 0, 0.3)';
    div.style.borderLeft = isFromMe ? '3px solid #b30000' : '3px solid #008000';
    div.innerHTML = `
      <div>
        <strong style="color: ${isFromMe ? '#b30000' : '#008000'}">
          ${isFromMe ? 'Você' : msg.fromName}
        </strong>
        <span style="color: #666; font-size: 0.7rem; margin-left: 10px;">
          ${new Date(msg.timestamp).toLocaleTimeString()}
        </span>
      </div>
      <div>${msg.text}</div>
    `;
    container.appendChild(div);
  });
  
  container.scrollTop = container.scrollHeight;
}

function renderContacts() {
  const container = document.getElementById('chat-contacts-list');
  if (!container || !currentUser) return;
  
  container.innerHTML = '';
  
  const friends = currentUser.friends.map(id => users.find(u => u.id === id)).filter(Boolean);
  
  if (friends.length === 0) {
    container.innerHTML = '<p style="color: #666; padding: 20px; text-align: center;">Adicione amigos para conversar</p>';
    return;
  }
  
  friends.forEach(friend => {
    // Contar mensagens não lidas
    const messages = privateMessages[currentUser.id]?.[friend.id] || [];
    const unread = messages.filter(m => !m.read && m.from !== currentUser.id).length;
    
    const item = document.createElement('div');
    item.className = 'list-item';
    item.style.cursor = 'pointer';
    item.onclick = () => startPrivateChat(friend.id);
    item.innerHTML = `
      <div style="display: flex; align-items: center; gap: 15px;">
        <div style="width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center;">
          ${friend.avatar ? 
            `<img src="${friend.avatar}" alt="${friend.username}" style="width:100%;height:100%;border-radius:50%;">` : 
            friend.username.charAt(0)
          }
        </div>
        <div style="flex: 1;">
          <strong>${friend.username}</strong>
          ${unread > 0 ? `<span style="background: #b30000; color: white; padding: 2px 6px; border-radius: 10px; font-size: 0.7rem; margin-left: 10px;">${unread}</span>` : ''}
        </div>
      </div>
    `;
    container.appendChild(item);
  });
}

function searchContacts() {
  const searchTerm = document.getElementById('search-contact').value.toLowerCase();
  const items = document.querySelectorAll('#chat-contacts-list .list-item');
  
  items.forEach(item => {
    const text = item.textContent.toLowerCase();
    item.style.display = text.includes(searchTerm) ? 'flex' : 'none';
  });
}

// ===============================
// LOG DE ATIVIDADES
// ===============================
function logActivity(message) {
  const activity = {
    id: Date.now(),
    message: message,
    timestamp: new Date().toISOString()
  };
  
  activities.unshift(activity);
  if (activities.length > 50) activities.pop();
  
  saveData();
  renderActivities();
}

function renderActivities() {
  const container = document.getElementById('activity-log');
  if (!container) return;
  
  container.innerHTML = '';
  
  activities.slice(0, 10).forEach(activity => {
    const div = document.createElement('div');
    div.style.padding = '8px';
    div.style.borderBottom = '1px solid #222';
    div.style.fontSize = '0.8rem';
    div.innerHTML = `
      <div style="color: #999;">${new Date(activity.timestamp).toLocaleTimeString()}</div>
      <div>${activity.message}</div>
    `;
    container.appendChild(div);
  });
}

// ===============================
// FUNÇÕES AUXILIARES
// ===============================
function editProfile() {
  const newUsername = prompt('Novo nome de usuário:', currentUser.username);
  if (newUsername) {
    currentUser.username = newUsername;
    saveData();
    updateUserDisplay();
    logActivity(`${currentUser.username} atualizou seu perfil`);
  }
}

function createExampleContent() {
  // Criar teoria de exemplo
  const exampleTheory = {
    id: Date.now(),
    title: 'Fundamentos da Algebra Renova',
    content: 'A Algebra Renova transcende as estruturas convencionais. É uma revolução matemática completa.',
    tags: ['álgebra', 'fundamentos', 'revolução'],
    author: 'admin',
    authorId: users.find(u => u.username === 'admin')?.id,
    authorRank: 'nucleo',
    createdAt: new Date().toISOString(),
    views: 0
  };
  
  theories.push(exampleTheory);
  saveData();
  renderTheories();
}

// ===============================
// INICIALIZAÇÃO
// ===============================
document.addEventListener('DOMContentLoaded', () => {
  initialize();
  
  // Permitir login com Enter
  document.getElementById('login-password')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') login();
  });
  
  document.getElementById('register-confirm')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') register();
  });
  
  document.getElementById('key-password')?.addEventListener('keypress', (e) => {
    if (e.key === 'Enter') useKey();
  });
});
</script>
</body>
</html>
