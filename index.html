<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Renova - Revolução Matemática</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;600;700&family=Cinzel:wght@400;700&family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- MathJax para renderizar fórmulas LaTeX -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Toast notifications -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <style>
        /* VARIÁVEIS DE CORES E ESTILOS */
        :root {
            --primary-dark: #0a0a0f;
            --secondary-dark: #121218;
            --tertiary-dark: #1a1a24;
            --accent-purple: #6a0dad;
            --accent-blue: #0d6efd;
            --accent-teal: #20c997;
            --accent-red: #dc3545;
            --accent-gold: #ffd700;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --border-color: #2d2d3a;
            --shadow-color: rgba(106, 13, 173, 0.2);
            --font-mono: 'Source Code Pro', monospace;
            --font-decorative: 'Cinzel', serif;
            --font-tech: 'Orbitron', sans-serif;
        }

        /* RESET E ESTILOS GERAIS */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-mono);
            background-color: var(--primary-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
            background-image: 
                radial-gradient(circle at 10% 20%, rgba(106, 13, 173, 0.05) 0%, transparent 20%),
                radial-gradient(circle at 90% 80%, rgba(13, 110, 253, 0.05) 0%, transparent 20%);
        }

        a {
            color: var(--accent-teal);
            text-decoration: none;
            transition: color 0.3s ease;
        }

        a:hover {
            color: var(--accent-blue);
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        /* SIDEBAR */
        .sidebar {
            width: 280px;
            background-color: var(--secondary-dark);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.3);
        }

        .logo-container {
            text-align: center;
            padding: 20px 10px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }

        .logo {
            font-family: var(--font-decorative);
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-purple);
            text-transform: uppercase;
            letter-spacing: 2px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .logo-symbol {
            font-size: 2.5rem;
            margin-bottom: 10px;
            color: var(--accent-gold);
        }

        .logo-subtitle {
            font-size: 0.7rem;
            color: var(--text-secondary);
            letter-spacing: 1px;
            margin-top: 5px;
        }

        .user-info {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
            position: relative;
        }

        .user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.8rem;
            margin: 0 auto 10px;
            border: 2px solid var(--accent-teal);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .user-avatar-upload {
            position: absolute;
            bottom: 0;
            left: 0;
            width: 100%;
            background: rgba(0,0,0,0.7);
            color: white;
            text-align: center;
            padding: 5px;
            font-size: 0.7rem;
            display: none;
        }

        .user-avatar:hover .user-avatar-upload {
            display: block;
        }

        #avatar-upload {
            display: none;
        }

        .user-name {
            font-weight: 600;
            font-size: 1.1rem;
            margin-bottom: 5px;
        }

        .user-level {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            background-color: var(--accent-purple);
            color: white;
            margin-top: 5px;
        }

        .level-observador {
            background-color: #6c757d;
        }

        .level-iniciado {
            background-color: #198754;
        }

        .level-nucleo {
            background-color: var(--accent-red);
        }

        .nav-menu {
            list-style: none;
            padding: 0 15px;
        }

        .nav-item {
            margin-bottom: 5px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 15px;
            border-radius: 8px;
            transition: all 0.3s ease;
            color: var(--text-secondary);
            cursor: pointer;
            text-decoration: none;
        }

        .nav-link:hover, .nav-link.active {
            background-color: var(--tertiary-dark);
            color: var(--text-primary);
        }

        .nav-link i {
            margin-right: 10px;
            font-size: 1.2rem;
            width: 24px;
            text-align: center;
        }

        .nav-section {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin: 20px 0 10px;
            padding-left: 15px;
        }

        .notification-badge {
            background-color: var(--accent-red);
            color: white;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            margin-left: auto;
            cursor: pointer;
        }

        /* CONTEÚDO PRINCIPAL */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 30px;
        }

        .page-title {
            font-family: var(--font-decorative);
            font-size: 2rem;
            color: var(--accent-teal);
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .search-box {
            position: relative;
        }

        .search-box input {
            background-color: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 8px 15px 8px 40px;
            color: var(--text-primary);
            width: 250px;
            font-family: var(--font-mono);
        }

        .search-box i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
        }

        .notification-btn, .logout-btn {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.2rem;
            cursor: pointer;
            transition: color 0.3s;
            position: relative;
        }

        .notification-btn:hover, .logout-btn:hover {
            color: var(--text-primary);
        }

        .notification-count {
            position: absolute;
            top: -5px;
            right: -5px;
            background-color: var(--accent-red);
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* DASHBOARD */
        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 25px;
            margin-bottom: 40px;
        }

        .card {
            background-color: var(--secondary-dark);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            transition: transform 0.3s, box-shadow 0.3s;
        }

        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px var(--shadow-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent-teal);
        }

        .card-icon {
            font-size: 1.5rem;
            color: var(--accent-purple);
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-bottom: 30px;
        }

        .stat-card {
            background-color: var(--tertiary-dark);
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            border-left: 4px solid var(--accent-purple);
        }

        .stat-value {
            font-size: 1.8rem;
            font-weight: 700;
            color: var(--accent-teal);
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .recent-activities {
            list-style: none;
        }

        .activity-item {
            padding: 12px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .activity-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            padding: 12px 10px;
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background-color: var(--tertiary-dark);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: var(--accent-blue);
        }

        .activity-content {
            flex: 1;
        }

        .activity-title {
            font-weight: 600;
            margin-bottom: 3px;
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .btn {
            display: inline-block;
            padding: 10px 20px;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: none;
            font-family: var(--font-mono);
            font-size: 0.95rem;
        }

        .btn-primary {
            background-color: var(--accent-purple);
            color: white;
        }

        .btn-primary:hover {
            background-color: #5a0a9c;
        }

        .btn-secondary {
            background-color: var(--tertiary-dark);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            background-color: var(--border-color);
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.85rem;
        }

        /* MODAIS */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background-color: var(--secondary-dark);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            font-size: 1.8rem;
            font-family: var(--font-decorative);
            color: var(--accent-teal);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }

        .modal-close:hover {
            color: var(--accent-red);
        }

        .modal-body {
            padding: 25px 30px;
        }

        /* SEÇÕES DE CONTEÚDO */
        .content-section {
            display: none;
            animation: fadeIn 0.5s ease;
        }

        .content-section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .section-title {
            font-size: 1.8rem;
            font-family: var(--font-decorative);
            color: var(--accent-teal);
        }

        .theories-list, .groups-list, .forum-topics, .contacts-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 25px;
        }

        .theory-card, .group-card, .topic-card, .contact-card {
            background-color: var(--secondary-dark);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .theory-card:hover, .group-card:hover, .topic-card:hover, .contact-card:hover {
            border-color: var(--accent-purple);
            box-shadow: 0 5px 15px var(--shadow-color);
            transform: translateY(-3px);
        }

        .theory-header, .group-header, .topic-header, .contact-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .theory-title, .group-title, .topic-title, .contact-name {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 5px;
        }

        .theory-author, .group-members, .topic-author, .contact-status {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .theory-status, .group-type, .topic-status, .contact-level {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-developing {
            background-color: rgba(32, 201, 151, 0.2);
            color: var(--accent-teal);
        }

        .status-published {
            background-color: rgba(13, 110, 253, 0.2);
            color: var(--accent-blue);
        }

        .status-archived {
            background-color: rgba(108, 117, 125, 0.2);
            color: var(--text-secondary);
        }

        .type-public {
            background-color: rgba(32, 201, 151, 0.2);
            color: var(--accent-teal);
        }

        .type-private {
            background-color: rgba(220, 53, 69, 0.2);
            color: var(--accent-red);
        }

        .type-restricted {
            background-color: rgba(255, 215, 0, 0.2);
            color: var(--accent-gold);
        }

        .theory-description, .group-description, .topic-description, .contact-bio {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
            font-size: 0.95rem;
        }

        .theory-meta, .group-meta, .topic-meta, .contact-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        /* FORMULÁRIOS */
        .form-container {
            max-width: 800px;
            margin: 0 auto;
        }

        .form-group {
            margin-bottom: 25px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: var(--font-mono);
            font-size: 1rem;
            transition: border-color 0.3s;
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-purple);
        }

        textarea.form-control {
            min-height: 150px;
            resize: vertical;
        }

        .form-row {
            display: flex;
            gap: 20px;
        }

        .form-row .form-group {
            flex: 1;
        }

        /* LOGIN PAGE */
        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background-color: var(--primary-dark);
            background-image: 
                radial-gradient(circle at 20% 30%, rgba(106, 13, 173, 0.1) 0%, transparent 40%),
                radial-gradient(circle at 80% 70%, rgba(13, 110, 253, 0.1) 0%, transparent 40%);
        }

        .login-box {
            width: 100%;
            max-width: 450px;
            background-color: var(--secondary-dark);
            border-radius: 15px;
            border: 1px solid var(--border-color);
            padding: 40px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.5);
        }

        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }

        .login-logo .logo {
            font-size: 2.2rem;
        }

        .login-title {
            text-align: center;
            font-family: var(--font-decorative);
            font-size: 1.8rem;
            margin-bottom: 30px;
            color: var(--accent-teal);
        }

        .login-footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        /* CHAT */
        .chat-container {
            display: flex;
            height: 70vh;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }

        .chat-sidebar {
            width: 250px;
            background-color: var(--tertiary-dark);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }

        .chat-group, .chat-contact {
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: background-color 0.3s;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .chat-group:hover, .chat-group.active,
        .chat-contact:hover, .chat-contact.active {
            background-color: rgba(106, 13, 173, 0.2);
        }

        .chat-group-icon, .contact-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .contact-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: 15px 20px;
            background-color: var(--secondary-dark);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .message {
            margin-bottom: 15px;
            max-width: 70%;
            padding: 12px 15px;
            border-radius: 10px;
            position: relative;
            animation: messageAppear 0.3s ease;
        }

        @keyframes messageAppear {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .message-sent {
            align-self: flex-end;
            background-color: rgba(106, 13, 173, 0.3);
            border: 1px solid rgba(106, 13, 173, 0.5);
        }

        .message-received {
            align-self: flex-start;
            background-color: var(--tertiary-dark);
            border: 1px solid var(--border-color);
        }

        .message-sender {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--accent-teal);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .message-sender-level {
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            background-color: var(--accent-purple);
        }

        .message-content {
            line-height: 1.5;
        }

        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
        }

        .chat-input-container {
            padding: 15px;
            background-color: var(--secondary-dark);
            border-top: 1px solid var(--border-color);
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .chat-input textarea {
            background-color: var(--tertiary-dark);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            color: var(--text-primary);
            font-family: var(--font-mono);
            padding: 12px 15px;
            resize: none;
            min-height: 60px;
            max-height: 120px;
        }

        .chat-input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .latex-preview {
            background-color: var(--tertiary-dark);
            border: 1px dashed var(--border-color);
            border-radius: 8px;
            padding: 10px;
            margin-top: 10px;
            display: none;
        }

        .latex-preview.active {
            display: block;
        }

        /* TABELAS */
        .table-container {
            overflow-x: auto;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }

        th {
            background-color: var(--tertiary-dark);
            font-weight: 600;
            color: var(--accent-teal);
        }

        tr:hover {
            background-color: rgba(255, 255, 255, 0.03);
        }

        /* RITO DE INICIAÇÃO */
        .initiation-container {
            max-width: 800px;
            margin: 0 auto;
            text-align: center;
        }

        .initiation-step {
            margin-bottom: 40px;
            padding: 30px;
            background-color: var(--secondary-dark);
            border-radius: 10px;
            border: 1px solid var(--border-color);
            position: relative;
        }

        .step-number {
            position: absolute;
            top: -15px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--accent-purple);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            font-size: 1.2rem;
        }

        .step-title {
            font-size: 1.4rem;
            color: var(--accent-teal);
            margin-bottom: 15px;
            font-family: var(--font-decorative);
        }

        /* NOTIFICAÇÕES */
        .notifications-modal .notification-item {
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .notifications-modal .notification-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .notifications-modal .notification-item.unread {
            background-color: rgba(106, 13, 173, 0.1);
        }

        .notification-title {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--accent-teal);
        }

        .notification-time {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        /* CONTATOS/AMIGOS */
        .contacts-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .contacts-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
        }

        .contact-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .contact-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .contact-avatar-small {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            margin-right: 15px;
        }

        .contact-info {
            flex: 1;
        }

        .contact-name {
            font-weight: 600;
            margin-bottom: 5px;
            color: var(--accent-teal);
        }

        .contact-last-message {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .contact-time {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .online-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: var(--accent-teal);
            margin-left: 10px;
        }

        .offline {
            background-color: #6c757d;
        }

        /* RESPONSIVIDADE */
        @media (max-width: 1100px) {
            .sidebar {
                width: 70px;
                overflow-x: hidden;
            }
            
            .logo-text, .user-name, .user-level, .nav-section, .nav-text {
                display: none;
            }
            
            .logo-symbol {
                font-size: 2rem;
            }
            
            .nav-link {
                justify-content: center;
                padding: 15px;
            }
            
            .nav-link i {
                margin-right: 0;
                font-size: 1.4rem;
            }
            
            .main-content {
                margin-left: 70px;
            }
            
            .search-box input {
                width: 200px;
            }
        }

        @media (max-width: 768px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
            
            .stats-container {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .theories-list, .groups-list, .forum-topics, .contacts-list {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                flex-direction: column;
                gap: 0;
            }
            
            .search-box input {
                width: 150px;
            }
            
            .chat-container {
                flex-direction: column;
                height: 80vh;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }

        /* ANIMAÇÕES E EFEITOS ESPECIAIS */
        .math-symbol {
            font-family: "Times New Roman", serif;
            font-style: italic;
        }

        .glowing-text {
            text-shadow: 0 0 5px var(--accent-purple), 0 0 10px rgba(106, 13, 173, 0.5);
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(106, 13, 173, 0.7); }
            70% { box-shadow: 0 0 0 10px rgba(106, 13, 173, 0); }
            100% { box-shadow: 0 0 0 0 rgba(106, 13, 173, 0); }
        }

        .fractal-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
            opacity: 0.05;
            z-index: -1;
            background-image: 
                radial-gradient(circle at 20% 30%, var(--accent-purple) 0%, transparent 10%),
                radial-gradient(circle at 80% 70%, var(--accent-blue) 0%, transparent 10%),
                radial-gradient(circle at 40% 80%, var(--accent-teal) 0%, transparent 10%);
        }

        /* TOAST NOTIFICATIONS CUSTOM */
        .toast-success {
            background-color: var(--accent-teal) !important;
        }

        .toast-error {
            background-color: var(--accent-red) !important;
        }

        .toast-info {
            background-color: var(--accent-blue) !important;
        }

        .toast-warning {
            background-color: var(--accent-gold) !important;
            color: #000 !important;
        }

        /* DISCUSSÃO DETALHADA */
        .discussion-container {
            max-width: 900px;
            margin: 0 auto;
        }

        .discussion-header {
            background-color: var(--secondary-dark);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
        }

        .discussion-title {
            font-size: 1.8rem;
            color: var(--accent-teal);
            margin-bottom: 10px;
            font-family: var(--font-decorative);
        }

        .discussion-meta {
            display: flex;
            justify-content: space-between;
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border-color);
        }

        .discussion-content {
            background-color: var(--secondary-dark);
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid var(--border-color);
            line-height: 1.8;
        }

        .discussion-replies {
            background-color: var(--secondary-dark);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid var(--border-color);
        }

        .reply {
            padding: 20px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .reply:last-child {
            border-bottom: none;
        }

        .reply-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .reply-author {
            font-weight: 600;
            color: var(--accent-teal);
        }

        .reply-time {
            color: var(--text-secondary);
            font-size: 0.85rem;
        }

        .reply-content {
            line-height: 1.6;
        }

        .reply-form {
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
        }

        /* NOVO: LISTA DE MEMBROS NA SIDEBAR */
        .sidebar-contacts {
            padding: 15px;
            border-top: 1px solid var(--border-color);
            margin-top: 20px;
        }

        .sidebar-contacts-title {
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sidebar-contact-item {
            display: flex;
            align-items: center;
            padding: 8px;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.3s;
            margin-bottom: 5px;
        }

        .sidebar-contact-item:hover {
            background-color: rgba(255, 255, 255, 0.05);
        }

        .sidebar-contact-avatar {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--accent-purple), var(--accent-blue));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.9rem;
            margin-right: 10px;
        }

        .sidebar-contact-name {
            font-size: 0.9rem;
            color: var(--text-secondary);
            flex: 1;
        }

        .sidebar-contact-status {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background-color: var(--accent-teal);
        }

        .sidebar-contact-status.offline {
            background-color: #6c757d;
        }

        .add-contact-btn {
            background: none;
            border: none;
            color: var(--accent-teal);
            cursor: pointer;
            font-size: 0.9rem;
        }
    </style>
</head>
<body>
    <!-- TELA DE LOGIN (INICIAL) -->
    <div id="login-page" class="login-container">
        <div class="login-box">
            <div class="login-logo">
                <div class="logo">
                    <div class="logo-symbol">∞</div>
                    <div class="logo-text">ALGEBRA RENOVA</div>
                    <div class="logo-subtitle">Revolution. Algebra et Perseverantia.</div>
                </div>
            </div>
            
            <h2 class="login-title">Acesso ao Portal</h2>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label" for="login-username">Nome Simbólico</label>
                    <input type="text" class="form-control" id="login-username" placeholder="Enter seu nome simbólico" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-password">Senha de Iniciação</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Enter a senha de iniciação" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-level">Nível de Acesso</label>
                    <select class="form-control" id="login-level" required>
                        <option value="">Selecione seu nível</option>
                        <option value="observador">Observador</option>
                        <option value="iniciado">Iniciado</option>
                        <option value="nucleo">Núcleo</option>
                    </select>
                </div>
                
                <!-- Campo extra para chave do Núcleo (inicialmente oculto) -->
                <div class="form-group" id="master-key-group" style="display: none;">
                    <label class="form-label" for="master-key">Chave de Acesso do Núcleo</label>
                    <input type="password" class="form-control" id="master-key" placeholder="Enter a chave secreta do Núcleo">
                    <small style="color: var(--text-secondary); font-size: 0.8rem;">Apenas membros do Núcleo possuem esta chave</small>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%; padding: 14px;">Acessar Portal</button>
            </form>
            
            <div class="login-footer">
                <p>Área restrita aos membros de Algebra Renova</p>
                <p>"Matemática é opcional – assim como a sanidade"</p>
            </div>
        </div>
    </div>

    <!-- CONTEÚDO PRINCIPAL DO SITE (APÓS LOGIN) -->
    <div id="main-site" class="container" style="display: none;">
        <!-- MENU LATERAL -->
        <aside class="sidebar">
            <div class="logo-container">
                <div class="logo">
                    <div class="logo-symbol">∞</div>
                    <div class="logo-text">ALGEBRA RENOVA</div>
                    <div class="logo-subtitle">Revolution. Algebra et Perseverantia.</div>
                </div>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">
                    <div class="user-avatar-upload">Alterar Foto</div>
                </div>
                <input type="file" id="avatar-upload" accept="image/*">
                <div class="user-name" id="user-name">Membro Algebra Renova</div>
                <div class="user-level level-observador" id="user-level">Observador</div>
            </div>
            
            <ul class="nav-menu">
                <li class="nav-section">Navegação Principal</li>
                <li class="nav-item">
                    <a class="nav-link active" data-section="dashboard">
                        <i class="fas fa-chart-network"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="manifesto">
                        <i class="fas fa-scroll"></i>
                        <span class="nav-text">Manifesto</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="theories">
                        <i class="fas fa-atom"></i>
                        <span class="nav-text">Teorias</span>
                        <span class="notification-badge" id="theory-notif">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="research-groups">
                        <i class="fas fa-users-cog"></i>
                        <span class="nav-text">Grupos de Pesquisa</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="forum">
                        <i class="fas fa-comments"></i>
                        <span class="nav-text">Fórum de Dúvidas</span>
                        <span class="notification-badge" id="forum-notif">0</span>
                    </a>
                </li>
                
                <li class="nav-section">Comunicação</li>
                <li class="nav-item">
                    <a class="nav-link" data-section="chat">
                        <i class="fas fa-comment-dots"></i>
                        <span class="nav-text">Chat Geral</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="private-chat">
                        <i class="fas fa-user-friends"></i>
                        <span class="nav-text">Chat Privado</span>
                        <span class="notification-badge" id="private-chat-notif">0</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="contacts">
                        <i class="fas fa-address-book"></i>
                        <span class="nav-text">Membros da Rede</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="files">
                        <i class="fas fa-archive"></i>
                        <span class="nav-text">Arquivos</span>
                    </a>
                </li>
                
                <li class="nav-section">Hierarquia</li>
                <li class="nav-item">
                    <a class="nav-link" data-section="initiation">
                        <i class="fas fa-door-open"></i>
                        <span class="nav-text">Rito de Iniciação</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="profile">
                        <i class="fas fa-user-cog"></i>
                        <span class="nav-text">Perfil</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-section="members">
                        <i class="fas fa-chess-queen"></i>
                        <span class="nav-text">Todos os Membros</span>
                    </a>
                </li>
            </ul>
            
            <!-- LISTA DE CONTATOS/AMIGOS NA SIDEBAR -->
            <div class="sidebar-contacts">
                <div class="sidebar-contacts-title">
                    <span>Membros Online</span>
                    <button class="add-contact-btn" id="sidebar-add-contact" title="Adicionar membro">
                        <i class="fas fa-user-plus"></i>
                    </button>
                </div>
                <div id="sidebar-contacts-list">
                    <!-- Contatos serão carregados aqui -->
                </div>
            </div>
            
            <div style="padding: 20px 15px; margin-top: 30px; border-top: 1px solid var(--border-color);">
                <p style="font-size: 0.8rem; color: var(--text-secondary); text-align: center;">
                    "A álgebra que renasce das ruínas do tradicional"
                </p>
            </div>
        </aside>

        <!-- CONTEÚDO PRINCIPAL -->
        <main class="main-content">
            <!-- CABEÇALHO -->
            <header class="header">
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <i class="fas fa-search"></i>
                        <input type="text" placeholder="Buscar teorias, membros..." id="global-search">
                    </div>
                    <button class="notification-btn" id="notification-btn">
                        <i class="fas fa-bell"></i>
                        <span class="notification-count" id="notification-count">0</span>
                    </button>
                    <button class="logout-btn" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </header>

            <!-- SEÇÕES DE CONTEÚDO -->
            
            <!-- DASHBOARD -->
            <section id="dashboard" class="content-section active">
                <div class="dashboard">
                    <!-- CARD DE ESTATÍSTICAS -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Estatísticas da Organização</h3>
                            <div class="card-icon"><i class="fas fa-chart-bar"></i></div>
                        </div>
                        <div class="stats-container">
                            <div class="stat-card">
                                <div class="stat-value" id="stat-members">1</div>
                                <div class="stat-label">Membros</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-theories">0</div>
                                <div class="stat-label">Teorias Ativas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-groups">6</div>
                                <div class="stat-label">Grupos de Pesquisa</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-contacts">0</div>
                                <div class="stat-label">Contatos</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value" id="stat-conjectures">0</div>
                                <div class="stat-label">Conjecturas Ativas</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">∞</div>
                                <div class="stat-label">Possibilidades</div>
                            </div>
                        </div>
                    </div>

                    <!-- CARD DE ATIVIDADES RECENTES -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Atividades Recentes</h3>
                            <div class="card-icon"><i class="fas fa-history"></i></div>
                        </div>
                        <ul class="recent-activities" id="recent-activities">
                            <li class="activity-item">
                                <div class="activity-icon"><i class="fas fa-door-open"></i></div>
                                <div class="activity-content">
                                    <div class="activity-title">Bem-vindo ao Algebra Renova</div>
                                    <div class="activity-time">Sua jornada começa agora</div>
                                </div>
                            </li>
                        </ul>
                    </div>

                    <!-- CARD DE TEORIAS EM DESTAQUE -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Teorias em Destaque</h3>
                            <div class="card-icon"><i class="fas fa-star"></i></div>
                        </div>
                        <div class="theories-list" style="grid-template-columns: 1fr;" id="featured-theories">
                            <!-- Conteúdo dinâmico -->
                        </div>
                        <button class="btn btn-secondary" style="width: 100%; margin-top: 15px;" data-section="theories">Ver Todas as Teorias</button>
                    </div>

                    <!-- CARD DE CONVITE -->
                    <div class="card pulse">
                        <div class="card-header">
                            <h3 class="card-title">Próximo Rito de Iniciação</h3>
                            <div class="card-icon"><i class="fas fa-door-open"></i></div>
                        </div>
                        <p style="margin-bottom: 20px; color: var(--text-secondary);">O próximo rito de iniciação para novos membros será agendado em breve. Para participar, você deve primeiro atingir o nível mínimo de contribuição no fórum.</p>
                        <button class="btn btn-primary" data-section="initiation">Saiba Mais</button>
                    </div>
                </div>
            </section>

            <!-- MANIFESTO -->
            <section id="manifesto" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Manifesto Algebra Renova</h2>
                </div>
                
                <div class="card" style="margin-bottom: 30px;">
                    <div class="card-header">
                        <h3 class="card-title">Revolution. Algebra et Perseverantia.</h3>
                        <div class="card-icon"><i class="fas fa-scroll"></i></div>
                    </div>
                    <div style="padding: 0 20px 20px;">
                        <blockquote style="border-left: 4px solid var(--accent-purple); padding-left: 20px; margin: 20px 0; font-style: italic; color: var(--text-secondary);">
                            "Algebra Renova é mais do que um grupo de pesquisa. É uma rebelião matemática. Uma revolução intelectual. Uma reconstrução dos próprios fundamentos do pensamento estrutural e algébrico."
                        </blockquote>
                        
                        <h4 style="color: var(--accent-teal); margin: 25px 0 15px;">A Origem do Nome</h4>
                        <p>O nome <strong>Algebra Renova</strong> surge da fusão entre o <strong>clássico e o revolucionário</strong>.</p>
                        
                        <ul style="padding-left: 20px; margin: 15px 0;">
                            <li style="margin-bottom: 10px;"><strong>Algebra</strong>: Refere-se ao campo estrutural fundamental da matemática, mas aqui entendido em seu sentido mais profundo — não apenas como a manipulação de símbolos ou equações, mas como o <em>tecido estrutural da realidade teórica</em>.</li>
                            <li style="margin-bottom: 10px;"><strong>Renova</strong>: Do latim <em>renovare</em>, "renovar", "renascer", "recriar". Uma evocação ao renascimento matemático. Ao ato de destruir estruturas caducas e criar novas formas de pensamento algébrico.</li>
                        </ul>
                        
                        <p><strong>Algebra Renova</strong>, portanto, significa: <em>A álgebra que renasce das ruínas do tradicional, mais poderosa, mais estranha, mais verdadeira.</em></p>
                        
                        <h4 style="color: var(--accent-teal); margin: 25px 0 15px;">Símbolos e seu Significado</h4>
                        
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin: 20px 0;">
                            <div style="flex: 1; min-width: 250px; background-color: var(--tertiary-dark); padding: 20px; border-radius: 8px;">
                                <h5 style="color: var(--accent-blue); margin-bottom: 10px;"><i class="fas fa-butterfly"></i> A Borboleta</h5>
                                <p>Simboliza a transformação radical. Representa a transfunctoração: a capacidade de uma estrutura emergir em outro domínio, com regras totalmente novas.</p>
                            </div>
                            <div style="flex: 1; min-width: 250px; background-color: var(--tertiary-dark); padding: 20px; border-radius: 8px;">
                                <h5 style="color: var(--accent-red); margin-bottom: 10px;"><i class="fas fa-eye"></i> A Espada com Olho</h5>
                                <p>A espada representa a precisão cortante, o rigor lógico. O olho que chora representa a visão profunda, a contemplação infinita das estruturas ocultas.</p>
                            </div>
                            <div style="flex: 1; min-width: 250px; background-color: var(--tertiary-dark); padding: 20px; border-radius: 8px;">
                                <h5 style="color: var(--accent-teal); margin-bottom: 10px;"><i class="fas fa-shield-alt"></i> O Escudo com o Lema</h5>
                                <p>Simboliza a defesa da nova matemática contra o dogma. Contém o lema: <strong>Revolution. Algebra et Perseverantia.</strong></p>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--accent-teal); margin: 25px 0 15px;">Missão e Objetivos</h4>
                        <p>Algebra Renova tem como missão a criação deliberada de estruturas matemáticas impossíveis. Seu objetivo não é resolver problemas já conhecidos, mas inventar realidades teóricas novas.</p>
                        
                        <ul style="padding-left: 20px; margin: 15px 0;">
                            <li style="margin-bottom: 8px;"><strong>Desenvolver novas teorias rigorosas.</strong></li>
                            <li style="margin-bottom: 8px;"><strong>Fundar subcampos dentro da álgebra e matemática abstrata.</strong></li>
                            <li style="margin-bottom: 8px;"><strong>Reformular a linguagem matemática como forma de expressão estrutural criativa.</strong></li>
                            <li style="margin-bottom: 8px;"><strong>Criar uma comunidade radical de pensadores.</strong></li>
                        </ul>
                    </div>
                </div>
            </section>

            <!-- TEORIAS -->
            <section id="theories" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Teorias Matemáticas</h2>
                    <button class="btn btn-primary" id="new-theory-btn"><i class="fas fa-plus"></i> Nova Teoria</button>
                </div>
                
                <div class="theories-list" id="theories-list">
                    <!-- Conteúdo dinâmico -->
                </div>
            </section>

            <!-- GRUPOS DE PESQUISA -->
            <section id="research-groups" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Grupos de Pesquisa</h2>
                    <button class="btn btn-primary" id="join-group-btn"><i class="fas fa-user-plus"></i> Solicitar Ingresso</button>
                </div>
                
                <div class="groups-list" id="groups-list">
                    <!-- Conteúdo dinâmico -->
                </div>
            </section>

            <!-- FÓRUM DE DÚVIDAS -->
            <section id="forum" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Fórum de Dúvidas e Debates</h2>
                    <button class="btn btn-primary" id="new-topic-btn"><i class="fas fa-plus"></i> Novo Tópico</button>
                </div>
                
                <div class="forum-topics" id="forum-topics">
                    <!-- Conteúdo dinâmico -->
                </div>
            </section>

            <!-- CHAT GERAL -->
            <section id="chat" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Chat Geral</h2>
                    <div class="header-actions">
                        <span id="online-count">Online: 1</span>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-sidebar" id="chat-sidebar">
                        <!-- Canais dinâmicos -->
                    </div>
                    
                    <div class="chat-main">
                        <div class="chat-header">
                            <span id="current-chat-title">Geral</span>
                            <button class="btn btn-small btn-secondary" id="chat-info-btn">
                                <i class="fas fa-info-circle"></i> Info
                            </button>
                        </div>
                        
                        <div class="chat-messages" id="chat-messages">
                            <!-- Mensagens dinâmicas -->
                        </div>
                        
                        <div class="chat-input-container">
                            <div class="chat-input">
                                <textarea id="chat-input" placeholder="Digite sua mensagem... Use $ para fórmulas LaTeX. Ex: $E = mc^2$" autocomplete="off"></textarea>
                                <div class="latex-preview" id="latex-preview"></div>
                                <div class="chat-input-actions">
                                    <button class="btn btn-small btn-secondary" id="latex-toggle">
                                        <i class="fas fa-square-root-alt"></i> LaTeX
                                    </button>
                                    <button class="btn btn-primary btn-small" id="send-message">
                                        <i class="fas fa-paper-plane"></i> Enviar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- CHAT PRIVADO -->
            <section id="private-chat" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Chat Privado</h2>
                    <div class="header-actions">
                        <button class="btn btn-primary" id="new-private-chat-btn">
                            <i class="fas fa-plus"></i> Nova Conversa
                        </button>
                    </div>
                </div>
                
                <div class="chat-container">
                    <div class="chat-sidebar" id="private-chat-sidebar">
                        <!-- Lista de conversas privadas -->
                    </div>
                    
                    <div class="chat-main">
                        <div class="chat-header">
                            <span id="private-chat-title">Selecione uma conversa</span>
                            <div id="private-chat-actions" style="display: none;">
                                <button class="btn btn-small btn-secondary" id="private-chat-info-btn">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="private-chat-messages">
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                                <h3 style="color: var(--accent-teal); margin-bottom: 10px;">Chat Privado</h3>
                                <p>Selecione um contato para iniciar uma conversa privada.</p>
                                <p style="margin-top: 20px; font-size: 0.9rem;">
                                    <i class="fas fa-lock"></i> As mensagens são privadas e criptografadas entre você e o contato.
                                </p>
                            </div>
                        </div>
                        
                        <div class="chat-input-container" id="private-chat-input-container" style="display: none;">
                            <div class="chat-input">
                                <textarea id="private-chat-input" placeholder="Digite sua mensagem privada..." autocomplete="off"></textarea>
                                <div class="chat-input-actions">
                                    <button class="btn btn-primary btn-small" id="send-private-message">
                                        <i class="fas fa-paper-plane"></i> Enviar
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MEMBROS DA REDE (CONTATOS) -->
            <section id="contacts" class="content-section">
                <div class="contacts-container">
                    <div class="contacts-header">
                        <h2 class="section-title">Membros da Rede</h2>
                        <div>
                            <button class="btn btn-primary" id="add-contact-btn">
                                <i class="fas fa-user-plus"></i> Adicionar Membro
                            </button>
                            <button class="btn btn-secondary" id="refresh-contacts-btn">
                                <i class="fas fa-sync-alt"></i>
                            </button>
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Meus Contatos</h3>
                            <div class="card-icon"><i class="fas fa-address-book"></i></div>
                        </div>
                        <div style="padding: 20px;">
                            <div id="contacts-list">
                                <!-- Contatos serão carregados aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ARQUIVOS -->
            <section id="files" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Arquivos e Documentos</h2>
                    <button class="btn btn-primary" id="upload-file-btn"><i class="fas fa-upload"></i> Upload</button>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Documentos da Organização</h3>
                        <div class="card-icon"><i class="fas fa-archive"></i></div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="table-container">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Nome</th>
                                        <th>Tipo</th>
                                        <th>Tamanho</th>
                                        <th>Upload por</th>
                                        <th>Data</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="files-table">
                                    <!-- Conteúdo dinâmico -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- RITO DE INICIAÇÃO -->
            <section id="initiation" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Rito de Iniciação</h2>
                </div>
                
                <div class="initiation-container">
                    <div class="initiation-step">
                        <div class="step-number">1</div>
                        <h3 class="step-title">Observador</h3>
                        <p>O primeiro nível é o de Observador. Nesta fase, você tem acesso limitado ao conteúdo, podendo ler o manifesto, visualizar teorias públicas e participar do fórum de forma restrita.</p>
                        <p style="margin-top: 15px; color: var(--accent-teal);"><strong>Pré-requisito:</strong> Criação de conta e primeiro login.</p>
                    </div>
                    
                    <div class="initiation-step">
                        <div class="step-number">2</div>
                        <h3 class="step-title">Iniciado</h3>
                        <p>O segundo nível é o de Iniciado. Aqui você ganha acesso a grupos de pesquisa públicos, pode propor novas teorias, participar ativamente do fórum e do chat, e acessar mais documentos.</p>
                        <p style="margin-top: 15px; color: var(--accent-teal);"><strong>Pré-requisito:</strong> Participação ativa no fórum e contribuição com pelo menos uma discussão significativa.</p>
                    </div>
                    
                    <div class="initiation-step">
                        <div class="step-number">3</div>
                        <h3 class="step-title">Núcleo</h3>
                        <p>O nível máximo é o de Núcleo. Membros do núcleo têm acesso total a todos os grupos (incluindo os restritos), podem moderar conteúdo, validar teorias e participar da direção estratégica da organização.</p>
                        <p style="margin-top: 15px; color: var(--accent-red);"><strong>Pré-requisito:</strong> Contribuição excepcional para a organização, seja através de teorias inovadoras, resolução de conjecturas complexas ou liderança em grupos de pesquisa. Acesso por convite apenas.</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 40px;">
                        <p style="color: var(--text-secondary); margin-bottom: 20px;">Para avançar de nível, demonstre seu comprometimento com a revolução matemática.</p>
                        <button class="btn btn-primary pulse" id="request-initiation">Solicitar Avaliação para Iniciado</button>
                    </div>
                </div>
            </section>

            <!-- PERFIL -->
            <section id="profile" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Perfil do Membro</h2>
                </div>
                
                <div class="form-container">
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Configurações do Perfil</h3>
                            <div class="card-icon"><i class="fas fa-user-cog"></i></div>
                        </div>
                        <div style="padding: 20px;">
                            <form id="profile-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="profile-name">Nome Simbólico</label>
                                        <input type="text" class="form-control" id="profile-name" value="Membro Algebra Renova" required>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="profile-level">Nível Atual</label>
                                        <input type="text" class="form-control" id="profile-level" value="Observador" readonly>
                                    </div>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="profile-description">Descrição/Áreas de Interesse</label>
                                    <textarea class="form-control" id="profile-description" rows="4" placeholder="Descreva suas áreas de interesse matemático, especialidades e objetivos dentro da organização..."></textarea>
                                </div>
                                
                                <div class="form-row">
                                    <div class="form-group">
                                        <label class="form-label" for="profile-expertise">Especialidades</label>
                                        <input type="text" class="form-control" id="profile-expertise" placeholder="Ex: Álgebra abstrata, Teoria das categorias, Topologia">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label" for="profile-status">Status</label>
                                        <select class="form-control" id="profile-status">
                                            <option value="active">Ativo</option>
                                            <option value="inactive">Inativo</option>
                                            <option value="away">Ausente</option>
                                        </select>
                                    </div>
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 30px;">
                                    <button type="submit" class="btn btn-primary">Salvar Alterações</button>
                                    <button type="button" class="btn btn-secondary" id="change-password-btn">Alterar Senha</button>
                                </div>
                            </form>
                            
                            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                                <h4 style="color: var(--accent-teal); margin-bottom: 15px;">Estatísticas Pessoais</h4>
                                <div class="stats-container" style="grid-template-columns: repeat(2, 1fr);">
                                    <div class="stat-card">
                                        <div class="stat-value" id="profile-theories">0</div>
                                        <div class="stat-label">Teorias Criadas</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="profile-posts">0</div>
                                        <div class="stat-label">Posts no Fórum</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="profile-contacts">0</div>
                                        <div class="stat-label">Contatos</div>
                                    </div>
                                    <div class="stat-card">
                                        <div class="stat-value" id="profile-documents">0</div>
                                        <div class="stat-label">Documentos Enviados</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- TODOS OS MEMBROS -->
            <section id="members" class="content-section">
                <div class="section-header">
                    <h2 class="section-title">Todos os Membros</h2>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Hierarquia de Membros</h3>
                        <div class="card-icon"><i class="fas fa-chess-queen"></i></div>
                    </div>
                    <div style="padding: 20px;">
                        <div style="display: flex; flex-wrap: wrap; gap: 20px; margin-bottom: 30px;">
                            <div style="flex: 1; min-width: 250px; background-color: var(--tertiary-dark); padding: 20px; border-radius: 8px; border-top: 4px solid var(--accent-red);">
                                <h4 style="color: var(--accent-red); margin-bottom: 10px;">Núcleo</h4>
                                <p style="margin-bottom: 15px;">Acesso total, direção estratégica, validação de teorias.</p>
                                <ul style="list-style: none; padding-left: 0;" id="nucleo-list">
                                    <li style="padding: 5px 0;"><i class="fas fa-crown" style="margin-right: 8px; color: var(--accent-gold);"></i>Lohan Cunha (Fundador)</li>
                                </ul>
                            </div>
                            
                            <div style="flex: 1; min-width: 250px; background-color: var(--tertiary-dark); padding: 20px; border-radius: 8px; border-top: 4px solid var(--accent-teal);">
                                <h4 style="color: var(--accent-teal); margin-bottom: 10px;">Iniciados</h4>
                                <p style="margin-bottom: 15px;">Acesso amplo, podem propor teorias, liderar grupos públicos.</p>
                                <ul style="list-style: none; padding-left: 0;" id="iniciados-list">
                                    <!-- Dinâmico -->
                                </ul>
                            </div>
                            
                            <div style="flex: 1; min-width: 250px; background-color: var(--tertiary-dark); padding: 20px; border-radius: 8px; border-top: 4px solid #6c757d;">
                                <h4 style="color: #6c757d; margin-bottom: 10px;">Observadores</h4>
                                <p style="margin-bottom: 15px;">Acesso limitado, leitura de conteúdo, participação restrita no fórum.</p>
                                <ul style="list-style: none; padding-left: 0;" id="observadores-list">
                                    <!-- Dinâmico -->
                                </ul>
                            </div>
                        </div>
                        
                        <h4 style="color: var(--accent-teal); margin: 25px 0 15px;">Regras de Conduta</h4>
                        <ul style="padding-left: 20px; margin-bottom: 30px;">
                            <li style="margin-bottom: 8px;">Respeito absoluto às ideias, mesmo as mais radicais.</li>
                            <li style="margin-bottom: 8px;">Rigor lógico acima de preferências pessoais.</li>
                            <li style="margin-bottom: 8px;">Confidencialidade do conteúdo restrito aos membros.</li>
                            <li style="margin-bottom: 8px;">Colaboração acima de competição.</li>
                            <li style="margin-bottom: 8px;">A matemática como linguagem de revolução, não como dogma.</li>
                        </ul>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- MODAIS -->

    <!-- Modal Nova Teoria -->
    <div id="modal-new-theory" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova Teoria</h3>
                <button class="modal-close" data-modal="modal-new-theory">&times;</button>
            </div>
            <div class="modal-body">
                <form id="theory-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="theory-name">Nome da Teoria *</label>
                            <input type="text" class="form-control" id="theory-name" placeholder="Ex: Álgebra Transdimensional" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="theory-group">Grupo de Pesquisa *</label>
                            <select class="form-control" id="theory-group" required>
                                <option value="">Selecione um grupo</option>
                                <option value="transfunctoracao">Transfunctoração</option>
                                <option value="transformacoes">Transformações Radicais</option>
                                <option value="estruturas">Estruturas Não-Convencionais</option>
                                <option value="algebra-superior">Álgebra Superior</option>
                                <option value="conjecturas">Conjecturas e "Caças"</option>
                                <option value="analise">Análise Não-Padrão</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="theory-description">Descrição da Teoria *</label>
                        <textarea class="form-control" id="theory-description" placeholder="Descreva a teoria proposta, seus fundamentos e objetivos..." rows="5" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="theory-visibility">Visibilidade *</label>
                            <select class="form-control" id="theory-visibility" required>
                                <option value="public">Pública (todos os membros)</option>
                                <option value="private">Privada (apenas grupo de pesquisa)</option>
                                <option value="restricted">Restrita (apenas Núcleo)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="theory-status">Status Inicial *</label>
                            <select class="form-control" id="theory-status" required>
                                <option value="developing">Em desenvolvimento</option>
                                <option value="proposal">Proposta</option>
                                <option value="discussion">Em discussão</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="theory-tags">Tags (separadas por vírgula)</label>
                        <input type="text" class="form-control" id="theory-tags" placeholder="Ex: álgebra, transfunctoração, não-associativa, transdimensional">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="theory-content">Conteúdo Detalhado (LaTeX suportado)</label>
                        <textarea class="form-control" id="theory-content" placeholder="Descreva em detalhes sua teoria. Use $$ para fórmulas LaTeX. Ex: $$E = mc^2$$" rows="8"></textarea>
                        <small style="color: var(--text-secondary);">Dica: Use $$f(x) = \int_{-\infty}^{\infty} \hat{f}(\xi) e^{2\pi i \xi x} d\xi$$ para fórmulas</small>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">Submeter Teoria</button>
                        <button type="button" class="btn btn-secondary" data-modal="modal-new-theory">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Novo Tópico -->
    <div id="modal-new-topic" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Tópico de Discussão</h3>
                <button class="modal-close" data-modal="modal-new-topic">&times;</button>
            </div>
            <div class="modal-body">
                <form id="topic-form">
                    <div class="form-group">
                        <label class="form-label" for="topic-title">Título do Tópico *</label>
                        <input type="text" class="form-control" id="topic-title" placeholder="Ex: Dúvida sobre transfunctoração entre dimensões" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="topic-description">Descrição/Questão *</label>
                        <textarea class="form-control" id="topic-description" placeholder="Descreva sua dúvida, questão ou ponto de debate..." rows="5" required></textarea>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="topic-category">Categoria *</label>
                            <select class="form-control" id="topic-category" required>
                                <option value="duvida">Dúvida Conceitual</option>
                                <option value="debate">Debate Teórico</option>
                                <option value="desafio">Desafio Matemático</option>
                                <option value="discussao">Discussão Geral</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="topic-tags">Tags (separadas por vírgula)</label>
                            <input type="text" class="form-control" id="topic-tags" placeholder="Ex: álgebra, transfunctoração, anti-identidades">
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="topic-content">Conteúdo Detalhado (LaTeX suportado)</label>
                        <textarea class="form-control" id="topic-content" placeholder="Desenvolva sua discussão com detalhes. Use $ para fórmulas inline e $$ para fórmulas em bloco." rows="8"></textarea>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">Criar Tópico</button>
                        <button type="button" class="btn btn-secondary" data-modal="modal-new-topic">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Adicionar Contato -->
    <div id="modal-add-contact" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar Membro à Rede</h3>
                <button class="modal-close" data-modal="modal-add-contact">&times;</button>
            </div>
            <div class="modal-body">
                <form id="add-contact-form">
                    <div class="form-group">
                        <label class="form-label" for="contact-search">Buscar Membro</label>
                        <input type="text" class="form-control" id="contact-search" placeholder="Digite o nome do membro...">
                        <div id="contact-search-results" style="margin-top: 10px; max-height: 200px; overflow-y: auto; display: none;">
                            <!-- Resultados da busca -->
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="contact-name">Ou adicionar manualmente</label>
                        <input type="text" class="form-control" id="contact-name" placeholder="Nome do membro">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="contact-level">Nível do Membro</label>
                        <select class="form-control" id="contact-level">
                            <option value="observador">Observador</option>
                            <option value="iniciado">Iniciado</option>
                            <option value="nucleo">Núcleo</option>
                        </select>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">Adicionar Contato</button>
                        <button type="button" class="btn btn-secondary" data-modal="modal-add-contact">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Nova Conversa Privada -->
    <div id="modal-new-private-chat" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova Conversa Privada</h3>
                <button class="modal-close" data-modal="modal-new-private-chat">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">Selecionar Contato</label>
                    <div id="private-chat-contacts-list" style="max-height: 300px; overflow-y: auto;">
                        <!-- Lista de contatos para iniciar conversa -->
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="private-chat-message">Mensagem Inicial (opcional)</label>
                    <textarea class="form-control" id="private-chat-message" placeholder="Digite uma mensagem inicial..." rows="3"></textarea>
                </div>
                
                <div style="display: flex; gap: 15px; margin-top: 30px;">
                    <button class="btn btn-primary" id="start-private-chat-btn">Iniciar Conversa</button>
                    <button type="button" class="btn btn-secondary" data-modal="modal-new-private-chat">Cancelar</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Notificações -->
    <div id="modal-notifications" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Notificações</h3>
                <button class="modal-close" data-modal="modal-notifications">&times;</button>
            </div>
            <div class="modal-body">
                <div id="notifications-list">
                    <!-- Conteúdo dinâmico -->
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Upload Arquivo -->
    <div id="modal-upload" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload de Arquivo</h3>
                <button class="modal-close" data-modal="modal-upload">&times;</button>
            </div>
            <div class="modal-body">
                <form id="upload-form">
                    <div class="form-group">
                        <label class="form-label" for="file-name">Nome do Arquivo *</label>
                        <input type="text" class="form-control" id="file-name" placeholder="Ex: Artigo_Transfunctoracao.pdf" required>
                    </div>
                    
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label" for="file-type">Tipo de Arquivo *</label>
                            <select class="form-control" id="file-type" required>
                                <option value="pdf">PDF</option>
                                <option value="tex">LaTeX</option>
                                <option value="md">Markdown</option>
                                <option value="txt">Texto</option>
                                <option value="image">Imagem</option>
                                <option value="other">Outro</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="file-visibility">Visibilidade *</label>
                            <select class="form-control" id="file-visibility" required>
                                <option value="public">Público</option>
                                <option value="private">Privado (apenas meu grupo)</option>
                                <option value="restricted">Restrito (apenas Núcleo)</option>
                            </select>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="file-description">Descrição</label>
                        <textarea class="form-control" id="file-description" placeholder="Descreva o conteúdo do arquivo..." rows="3"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="file-upload">Selecionar Arquivo *</label>
                        <input type="file" class="form-control" id="file-upload" required>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">Upload</button>
                        <button type="button" class="btn btn-secondary" data-modal="modal-upload">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Modal Alterar Senha -->
    <div id="modal-change-password" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Alterar Senha</h3>
                <button class="modal-close" data-modal="modal-change-password">&times;</button>
            </div>
            <div class="modal-body">
                <form id="change-password-form">
                    <div class="form-group">
                        <label class="form-label" for="current-password">Senha Atual *</label>
                        <input type="password" class="form-control" id="current-password" required>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="new-password">Nova Senha *</label>
                        <input type="password" class="form-control" id="new-password" required>
                        <small style="color: var(--text-secondary);">Mínimo 8 caracteres</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="confirm-password">Confirmar Nova Senha *</label>
                        <input type="password" class="form-control" id="confirm-password" required>
                    </div>
                    
                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                        <button type="submit" class="btn btn-primary">Alterar Senha</button>
                        <button type="button" class="btn btn-secondary" data-modal="modal-change-password">Cancelar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- BACKGROUND FRACTAL -->
    <div class="fractal-bg"></div>

    <script>
        // =============================================
        // CONSTANTES E CONFIGURAÇÕES
        // =============================================

        const MASTER_KEY = "algebra_renova_nucleo_2024";
        const STORAGE_KEYS = {
            USER: 'algebra_renova_user',
            USERS: 'algebra_renova_users', // Todos os usuários registrados
            THEORIES: 'algebra_renova_theories',
            FORUM_TOPICS: 'algebra_renova_forum_topics',
            CHAT_MESSAGES: 'algebra_renova_chat_messages',
            PRIVATE_MESSAGES: 'algebra_renova_private_messages',
            NOTIFICATIONS: 'algebra_renova_notifications',
            FILES: 'algebra_renova_files',
            ACTIVITIES: 'algebra_renova_activities',
            CONTACTS: 'algebra_renova_contacts', // Contatos/amigos do usuário
            CONVERSATIONS: 'algebra_renova_conversations' // Conversas privadas
        };

        // =============================================
        // ESTADO GLOBAL DA APLICAÇÃO
        // =============================================

        let currentUser = null;
        let allUsers = []; // Todos os usuários registrados
        let theories = [];
        let forumTopics = [];
        let chatMessages = {};
        let privateMessages = {}; // Mensagens privadas por conversa
        let notifications = [];
        let files = [];
        let activities = [];
        let contacts = []; // Contatos/amigos do usuário atual
        let conversations = []; // Conversas privadas
        let currentChatGroup = "geral";
        let currentPrivateChat = null; // ID da conversa privada atual
        let unreadNotifications = 0;
        let unreadPrivateMessages = 0;

        // =============================================
        // FUNÇÕES DE PERSISTÊNCIA (LOCALSTORAGE)
        // =============================================

        function initializeStorage() {
            // Verificar se é a primeira execução
            const isFirstRun = !localStorage.getItem(STORAGE_KEYS.USERS);
            
            // Inicializar todos os dados no localStorage se não existirem
            Object.keys(STORAGE_KEYS).forEach(key => {
                if (!localStorage.getItem(STORAGE_KEYS[key])) {
                    let defaultValue = [];
                    
                    // Valores padrão específicos
                    if (key === 'USERS') {
                        defaultValue = [
                            {
                                id: '1',
                                name: 'Lohan Cunha',
                                level: 'nucleo',
                                avatar: 'LC',
                                password: 'admin123',
                                joinDate: new Date().toISOString(),
                                lastSeen: new Date().toISOString(),
                                status: 'online',
                                description: 'Fundador do Algebra Renova',
                                expertise: 'Álgebra Abstrata, Teoria das Categorias'
                            }
                        ];
                    } else if (key === 'PRIVATE_MESSAGES' || key === 'CONVERSATIONS') {
                        defaultValue = {};
                    }
                    
                    localStorage.setItem(STORAGE_KEYS[key], JSON.stringify(defaultValue));
                }
            });
            
            // Carregar dados do localStorage
            loadFromStorage();
            
            // Se for primeira execução, criar dados iniciais
            if (isFirstRun) {
                createInitialData();
            }
        }

        function loadFromStorage() {
            try {
                theories = JSON.parse(localStorage.getItem(STORAGE_KEYS.THEORIES)) || [];
                forumTopics = JSON.parse(localStorage.getItem(STORAGE_KEYS.FORUM_TOPICS)) || [];
                chatMessages = JSON.parse(localStorage.getItem(STORAGE_KEYS.CHAT_MESSAGES)) || {};
                privateMessages = JSON.parse(localStorage.getItem(STORAGE_KEYS.PRIVATE_MESSAGES)) || {};
                notifications = JSON.parse(localStorage.getItem(STORAGE_KEYS.NOTIFICATIONS)) || [];
                files = JSON.parse(localStorage.getItem(STORAGE_KEYS.FILES)) || [];
                activities = JSON.parse(localStorage.getItem(STORAGE_KEYS.ACTIVITIES)) || [];
                contacts = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONTACTS)) || [];
                conversations = JSON.parse(localStorage.getItem(STORAGE_KEYS.CONVERSATIONS)) || [];
                allUsers = JSON.parse(localStorage.getItem(STORAGE_KEYS.USERS)) || [];
                
                // Inicializar chatMessages se estiver vazio
                if (Object.keys(chatMessages).length === 0) {
                    chatMessages = {
                        geral: [
                            {
                                id: generateId(),
                                sender: "Sistema Algebra Renova",
                                senderId: "system",
                                message: "Bem-vindo ao chat geral! Conecte-se com outros membros para discutir ideias, teorias e conjecturas.",
                                time: new Date().toISOString(),
                                type: "received"
                            }
                        ]
                    };
                    saveToStorage(STORAGE_KEYS.CHAT_MESSAGES, chatMessages);
                }
                
                // Carregar usuário se existir
                const savedUser = localStorage.getItem(STORAGE_KEYS.USER);
                if (savedUser) {
                    currentUser = JSON.parse(savedUser);
                    // Atualizar status do usuário para online
                    updateUserStatus('online');
                }
            } catch (error) {
                console.error("Erro ao carregar do localStorage:", error);
                // Resetar para dados iniciais em caso de erro
                resetToDefaultData();
            }
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`Erro ao salvar ${key}:`, error);
                showToast("Erro ao salvar dados", "error");
            }
        }

        function saveUser() {
            if (currentUser) {
                // Atualizar timestamp de última atividade
                currentUser.lastActivity = new Date().toISOString();
                saveToStorage(STORAGE_KEYS.USER, currentUser);
                
                // Atualizar na lista de usuários
                const userIndex = allUsers.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    allUsers[userIndex] = {...currentUser};
                } else {
                    // Se não existe, adicionar (novo usuário)
                    allUsers.push({...currentUser});
                }
                saveToStorage(STORAGE_KEYS.USERS, allUsers);
            }
        }

        function updateUserStatus(status) {
            if (!currentUser) return;
            
            currentUser.status = status;
            currentUser.lastSeen = new Date().toISOString();
            saveUser();
            
            // Notificar contatos sobre mudança de status
            contacts.forEach(contact => {
                if (contact.userId) {
                    const conversationId = getConversationId(currentUser.id, contact.userId);
                    if (conversations[conversationId]) {
                        // Atualizar último visto na conversa
                        conversations[conversationId].lastActivity = new Date().toISOString();
                        conversations[conversationId].participants = conversations[conversationId].participants.map(p => 
                            p.userId === currentUser.id ? {...p, status, lastSeen: currentUser.lastSeen} : p
                        );
                    }
                }
            });
            
            saveToStorage(STORAGE_KEYS.CONVERSATIONS, conversations);
        }

        function saveTheories() {
            saveToStorage(STORAGE_KEYS.THEORIES, theories);
        }

        function saveForumTopics() {
            saveToStorage(STORAGE_KEYS.FORUM_TOPICS, forumTopics);
        }

        function saveChatMessages() {
            saveToStorage(STORAGE_KEYS.CHAT_MESSAGES, chatMessages);
        }

        function savePrivateMessages() {
            saveToStorage(STORAGE_KEYS.PRIVATE_MESSAGES, privateMessages);
        }

        function saveNotifications() {
            saveToStorage(STORAGE_KEYS.NOTIFICATIONS, notifications);
        }

        function saveFiles() {
            saveToStorage(STORAGE_KEYS.FILES, files);
        }

        function saveActivities() {
            saveToStorage(STORAGE_KEYS.ACTIVITIES, activities);
        }

        function saveContacts() {
            saveToStorage(STORAGE_KEYS.CONTACTS, contacts);
        }

        function saveConversations() {
            saveToStorage(STORAGE_KEYS.CONVERSATIONS, conversations);
        }

        // =============================================
        // FUNÇÕES DE UTILIDADE
        // =============================================

        function showToast(message, type = "success") {
            toastr.options = {
                positionClass: "toast-top-right",
                progressBar: true,
                closeButton: true,
                timeOut: 3000,
                extendedTimeOut: 1000
            };
            
            switch(type) {
                case "success":
                    toastr.success(message);
                    break;
                case "error":
                    toastr.error(message);
                    break;
                case "warning":
                    toastr.warning(message);
                    break;
                case "info":
                    toastr.info(message);
                    break;
            }
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return "Agora";
            if (diffMins < 60) return `${diffMins} min atrás`;
            if (diffHours < 24) return `${diffHours} h atrás`;
            if (diffDays < 7) return `${diffDays} dias atrás`;
            
            return date.toLocaleDateString('pt-BR', { 
                day: '2-digit', 
                month: '2-digit', 
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function getConversationId(userId1, userId2) {
            // Garante que a conversa tenha o mesmo ID independente da ordem dos usuários
            const ids = [userId1, userId2].sort();
            return `conv_${ids[0]}_${ids[1]}`;
        }

        function renderLatexInText(text) {
            if (!text) return '';
            // Converte LaTeX inline ($...$) para MathJax
            return text.replace(/\$(.*?)\$/g, '\\\\($1\\\\)')
                      .replace(/\$\$(.*?)\$\$/g, '\\\\[$1\\\\]');
        }

        // =============================================
        // FUNÇÕES DE DADOS INICIAIS
        // =============================================

        function createInitialData() {
            // Criar dados iniciais para demonstração
            const initialTheories = [
                {
                    id: generateId(),
                    title: "Álgebra das Anti-identidades",
                    author: "Lohan Cunha",
                    authorId: "1",
                    authorLevel: "nucleo",
                    group: "Transfunctoração",
                    description: "Explora estruturas algébricas onde as identidades tradicionais são substituídas por seus opostos conceituais.",
                    content: "Na álgebra tradicional, temos identidades como $a + 0 = a$ e $a \\cdot 1 = a$. Nesta teoria, propomos sistemas onde estas identidades não se mantêm: $$a + 0 \\neq a$$ $$a \\cdot 1 \\neq a$$ Isso permite a criação de estruturas totalmente novas.",
                    status: "developing",
                    version: "v1.0.0",
                    date: new Date().toISOString(),
                    visibility: "public",
                    tags: "álgebra, anti-identidades, transfunctoração",
                    replies: []
                },
                {
                    id: generateId(),
                    title: "Transfunctoração Quântica",
                    author: "Lohan Cunha",
                    authorId: "1",
                    authorLevel: "nucleo",
                    group: "Transformações Radicais",
                    description: "Estuda como estruturas algébricas podem ser 'transportadas' entre diferentes domínios matemáticos.",
                    content: "A transfunctoração quântica permite mover estruturas entre espaços de dimensão diferente mantendo certas propriedades invariantes: $$\\mathcal{F}: \\mathcal{C} \\to \\mathcal{D}$$ onde $\\mathcal{C}$ e $\\mathcal{D}$ são categorias distintas.",
                    status: "published",
                    version: "v2.0.0",
                    date: new Date().toISOString(),
                    visibility: "public",
                    tags: "transfunctoração, quântica, transformações",
                    replies: []
                }
            ];

            const initialForumTopics = [
                {
                    id: generateId(),
                    title: "Interpretação da Anti-identidade a+0 ≠ a",
                    author: "Lohan Cunha",
                    authorId: "1",
                    authorLevel: "nucleo",
                    description: "Como interpretar sistemas onde o elemento neutro aditivo não funciona como neutro?",
                    content: "Em sistemas tradicionais, o elemento neutro aditivo $0$ satisfaz $a + 0 = a$ para todo $a$. Em nossa teoria das anti-identidades, temos $a + 0 \\neq a$. Qual seria a interpretação física/matemática disso?",
                    category: "debate",
                    tags: "álgebra, anti-identidades, interpretação",
                    replies: [],
                    status: "active",
                    date: new Date().toISOString(),
                    views: 0
                }
            ];

            const initialFiles = [
                {
                    id: generateId(),
                    name: "Manifesto_Algebra_Renova.pdf",
                    type: "pdf",
                    size: "2.4 MB",
                    uploadedBy: "Lohan Cunha",
                    uploadedById: "1",
                    uploadedByLevel: "nucleo",
                    date: new Date().toISOString(),
                    description: "Manifesto fundacional da organização",
                    visibility: "public",
                    url: "#"
                }
            ];

            // Salvar dados iniciais
            theories = initialTheories;
            forumTopics = initialForumTopics;
            files = initialFiles;

            saveTheories();
            saveForumTopics();
            saveFiles();
        }

        function resetToDefaultData() {
            // Resetar para dados padrão em caso de erro
            theories = [];
            forumTopics = [];
            chatMessages = {};
            privateMessages = {};
            notifications = [];
            files = [];
            activities = [];
            contacts = [];
            conversations = [];
            allUsers = [];
            
            createInitialData();
        }

        // =============================================
        // FUNÇÕES DE MANIPULAÇÃO DE DADOS
        // =============================================

        function createNewTheory(theoryData) {
            const newTheory = {
                id: generateId(),
                ...theoryData,
                author: currentUser.name,
                authorId: currentUser.id,
                authorLevel: currentUser.level,
                date: new Date().toISOString(),
                replies: [],
                version: "v1.0.0"
            };
            
            theories.push(newTheory);
            saveTheories();
            
            // Adicionar atividade
            addActivity(`Nova teoria criada: "${theoryData.title}"`, "lightbulb");
            
            // Adicionar notificação para membros do Núcleo
            if (currentUser.level !== "nucleo") {
                allUsers.filter(u => u.level === "nucleo").forEach(member => {
                    addNotification(member.id, "Nova teoria para revisão", `${currentUser.name} criou a teoria "${theoryData.title}"`, "theory", newTheory.id);
                });
            }
            
            showToast("Teoria criada com sucesso!", "success");
            return newTheory;
        }

        function createNewTopic(topicData) {
            const newTopic = {
                id: generateId(),
                ...topicData,
                author: currentUser.name,
                authorId: currentUser.id,
                authorLevel: currentUser.level,
                date: new Date().toISOString(),
                replies: [],
                views: 0,
                status: "active"
            };
            
            forumTopics.push(newTopic);
            saveForumTopics();
            
            // Adicionar atividade
            addActivity(`Novo tópico no fórum: "${topicData.title}"`, "comments");
            
            showToast("Tópico criado com sucesso!", "success");
            return newTopic;
        }

        function addChatMessageToGroup(groupId, messageData) {
            if (!chatMessages[groupId]) {
                chatMessages[groupId] = [];
            }
            
            const newMessage = {
                id: generateId(),
                ...messageData,
                sender: currentUser.name,
                senderId: currentUser.id,
                senderLevel: currentUser.level,
                time: new Date().toISOString(),
                type: "sent"
            };
                        // Enviar cópias para outros usuários online (simulação)
            chatMessages[groupId].push({
                ...newMessage,
                type: "received"
            });
            
            saveChatMessages();
            
            return newMessage;
        }

        function addPrivateMessage(conversationId, messageData) {
            if (!privateMessages[conversationId]) {
                privateMessages[conversationId] = [];
            }
            
            const newMessage = {
                id: generateId(),
                ...messageData,
                sender: currentUser.name,
                senderId: currentUser.id,
                senderLevel: currentUser.level,
                time: new Date().toISOString(),
                read: false
            };
            
            privateMessages[conversationId].push(newMessage);
            savePrivateMessages();
            
            // Atualizar última mensagem na conversa
            if (conversations[conversationId]) {
                conversations[conversationId].lastMessage = {
                    text: messageData.message,
                    senderId: currentUser.id,
                    time: new Date().toISOString()
                };
                conversations[conversationId].lastActivity = new Date().toISOString();
                saveConversations();
            }
            
            return newMessage;
        }

        function addNotification(userId, title, message, type = "info", referenceId = null) {
            const notification = {
                id: generateId(),
                userId,
                title,
                message,
                type,
                referenceId,
                read: false,
                date: new Date().toISOString()
            };
            
            notifications.push(notification);
            saveNotifications();
            
            if (userId === currentUser?.id) {
                updateUnreadNotifications();
            }
            
            return notification;
        }

        function addActivity(text, icon = "info") {
            const activity = {
                id: generateId(),
                text,
                icon,
                date: new Date().toISOString()
            };
            
            activities.unshift(activity);
            if (activities.length > 20) activities.length = 20; // Manter apenas 20 atividades
            saveActivities();
            
            return activity;
        }

        function addFile(fileData) {
            const newFile = {
                id: generateId(),
                ...fileData,
                uploadedBy: currentUser.name,
                uploadedById: currentUser.id,
                uploadedByLevel: currentUser.level,
                date: new Date().toISOString()
            };
            
            files.unshift(newFile);
            saveFiles();
            
            // Adicionar atividade
            addActivity(`Novo arquivo enviado: "${fileData.name}"`, "archive");
            
            showToast("Arquivo enviado com sucesso!", "success");
            return newFile;
        }

        function addContact(contactUserId) {
            if (!contactUserId || contacts.some(c => c.userId === contactUserId)) {
                showToast("Contato já existe ou ID inválido", "warning");
                return null;
            }
            
            const userToAdd = allUsers.find(u => u.id === contactUserId);
            if (!userToAdd) {
                showToast("Usuário não encontrado", "error");
                return null;
            }
            
            const newContact = {
                id: generateId(),
                userId: contactUserId,
                name: userToAdd.name,
                level: userToAdd.level,
                avatar: userToAdd.avatar,
                status: userToAdd.status,
                lastSeen: userToAdd.lastSeen,
                addedDate: new Date().toISOString()
            };
            
            contacts.push(newContact);
            saveContacts();
            
            // Criar conversa automaticamente
            const conversationId = getConversationId(currentUser.id, contactUserId);
            if (!conversations[conversationId]) {
                conversations[conversationId] = {
                    id: conversationId,
                    participants: [
                        { userId: currentUser.id, name: currentUser.name, level: currentUser.level },
                        { userId: contactUserId, name: userToAdd.name, level: userToAdd.level }
                    ],
                    lastMessage: null,
                    lastActivity: new Date().toISOString(),
                    unreadCount: 0
                };
                saveConversations();
            }
            
            // Adicionar atividade
            addActivity(`Contato adicionado: ${userToAdd.name}`, "user-friends");
            
            // Adicionar notificação para o usuário adicionado (se for do nível Núcleo)
            if (userToAdd.level === "nucleo") {
                addNotification(contactUserId, "Novo contato", `${currentUser.name} adicionou você como contato`, "contact", currentUser.id);
            }
            
            showToast(`${userToAdd.name} adicionado aos contatos!`, "success");
            return newContact;
        }

        function updateUnreadNotifications() {
            if (!currentUser) return;
            
            unreadNotifications = notifications.filter(n => 
                n.userId === currentUser.id && !n.read
            ).length;
            
            document.getElementById('notification-count').textContent = unreadNotifications;
        }

        function updateUnreadPrivateMessages() {
            if (!currentUser) return;
            
            let totalUnread = 0;
            Object.keys(conversations).forEach(convId => {
                const conv = conversations[convId];
                if (conv.participants.some(p => p.userId === currentUser.id)) {
                    // Verificar se há mensagens não lidas
                    const messages = privateMessages[convId] || [];
                    const unread = messages.filter(m => 
                        m.senderId !== currentUser.id && !m.read
                    ).length;
                    conv.unreadCount = unread;
                    totalUnread += unread;
                }
            });
            
            unreadPrivateMessages = totalUnread;
            document.getElementById('private-chat-notif').textContent = totalUnread > 0 ? totalUnread : "0";
            saveConversations();
        }

        // =============================================
        // FUNÇÕES DE RENDERIZAÇÃO
        // =============================================

        function renderDashboard() {
            // Atualizar estatísticas
            document.getElementById('stat-members').textContent = allUsers.length;
            document.getElementById('stat-theories').textContent = theories.length;
            document.getElementById('stat-groups').textContent = '6'; // Fixo por enquanto
            document.getElementById('stat-contacts').textContent = contacts.length;
            document.getElementById('stat-conjectures').textContent = theories.filter(t => 
                t.title.toLowerCase().includes('conjectura') || 
                t.tags?.toLowerCase().includes('conjectura')
            ).length;
            
            // Atualizar estatísticas do perfil
            document.getElementById('profile-theories').textContent = 
                theories.filter(t => t.authorId === currentUser.id).length;
            document.getElementById('profile-posts').textContent = 
                forumTopics.filter(t => t.authorId === currentUser.id).length;
            document.getElementById('profile-contacts').textContent = contacts.length;
            document.getElementById('profile-documents').textContent = 
                files.filter(f => f.uploadedById === currentUser.id).length;
            
            // Renderizar atividades recentes
            const activitiesList = document.getElementById('recent-activities');
            activitiesList.innerHTML = '';
            
            activities.slice(0, 5).forEach(activity => {
                const activityEl = document.createElement('li');
                activityEl.className = 'activity-item';
                activityEl.innerHTML = `
                    <div class="activity-icon"><i class="fas fa-${activity.icon}"></i></div>
                    <div class="activity-content">
                        <div class="activity-title">${activity.text}</div>
                        <div class="activity-time">${formatDate(activity.date)}</div>
                    </div>
                `;
                activitiesList.appendChild(activityEl);
            });
            
            // Renderizar teorias em destaque
            const featuredTheoriesEl = document.getElementById('featured-theories');
            featuredTheoriesEl.innerHTML = '';
            
            const featuredTheories = theories
                .filter(t => t.visibility !== 'restricted' || currentUser.level === 'nucleo')
                .slice(0, 3);
            
            if (featuredTheories.length === 0) {
                featuredTheoriesEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-atom" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Nenhuma teoria pública ainda. Seja o primeiro a criar uma!</p>
                    </div>
                `;
            } else {
                featuredTheories.forEach(theory => {
                    const theoryEl = document.createElement('div');
                    theoryEl.className = 'theory-card';
                    theoryEl.innerHTML = `
                        <div class="theory-header">
                            <div>
                                <h4 class="theory-title">${theory.title}</h4>
                                <div class="theory-author">Por ${theory.author} • ${formatDate(theory.date)}</div>
                            </div>
                            <div class="theory-status status-${theory.status}">${theory.status}</div>
                        </div>
                        <div class="theory-description">${theory.description}</div>
                        <div class="theory-meta">
                            <span><i class="fas fa-users"></i> ${theory.group}</span>
                            <span><i class="fas fa-code-branch"></i> ${theory.version}</span>
                        </div>
                    `;
                    theoryEl.addEventListener('click', () => {
                        // Em uma versão completa, isso abriria um modal com detalhes
                        showToast(`Abrindo teoria: ${theory.title}`, "info");
                    });
                    featuredTheoriesEl.appendChild(theoryEl);
                });
            }
            
            // Atualizar notificações
            updateUnreadNotifications();
            updateUnreadPrivateMessages();
        }

        function renderTheories() {
            const theoriesListEl = document.getElementById('theories-list');
            theoriesListEl.innerHTML = '';
            
            const filteredTheories = theories.filter(t => {
                if (t.visibility === 'public') return true;
                if (t.visibility === 'private') return true; // Todos os membros veem privadas por enquanto
                if (t.visibility === 'restricted') return currentUser.level === 'nucleo';
                return true;
            });
            
            if (filteredTheories.length === 0) {
                theoriesListEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-atom" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--accent-teal); margin-bottom: 10px;">Nenhuma Teoria</h3>
                        <p>Nenhuma teoria foi criada ainda. Seja o primeiro a propor uma nova estrutura matemática!</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" id="new-theory-empty">
                            <i class="fas fa-plus"></i> Criar Primeira Teoria
                        </button>
                    </div>
                `;
                
                document.getElementById('new-theory-empty')?.addEventListener('click', () => {
                    openModal('modal-new-theory');
                });
            } else {
                filteredTheories.forEach(theory => {
                    const theoryEl = document.createElement('div');
                    theoryEl.className = 'theory-card';
                    theoryEl.innerHTML = `
                        <div class="theory-header">
                            <div>
                                <h4 class="theory-title">${theory.title}</h4>
                                <div class="theory-author">Por ${theory.author} • ${theory.authorLevel.toUpperCase()} • ${formatDate(theory.date)}</div>
                            </div>
                            <div class="theory-status status-${theory.status}">${theory.status}</div>
                        </div>
                        <div class="theory-description">${theory.description}</div>
                        <div class="theory-meta">
                            <span><i class="fas fa-users"></i> ${theory.group}</span>
                            <span><i class="fas fa-code-branch"></i> ${theory.version}</span>
                            <span><i class="fas fa-eye"></i> ${theory.visibility === 'public' ? 'Pública' : 
                                theory.visibility === 'private' ? 'Privada' : 'Restrita'}</span>
                        </div>
                    `;
                    theoryEl.addEventListener('click', () => {
                        // Em uma versão completa, isso abriria um modal com detalhes
                        showTheoryDetails(theory);
                    });
                    theoriesListEl.appendChild(theoryEl);
                });
            }
            
            // Atualizar contador de notificações de teorias
            const theoryNotifications = notifications.filter(n => 
                n.userId === currentUser.id && !n.read && n.type === 'theory'
            ).length;
            document.getElementById('theory-notif').textContent = theoryNotifications > 0 ? theoryNotifications : "0";
        }

        function showTheoryDetails(theory) {
            // Em uma implementação completa, isso abriria um modal
            alert(`Detalhes da teoria:\n\nTítulo: ${theory.title}\nAutor: ${theory.author}\nStatus: ${theory.status}\n\n${theory.description}`);
        }

        function renderForumTopics() {
            const forumTopicsEl = document.getElementById('forum-topics');
            forumTopicsEl.innerHTML = '';
            
            if (forumTopics.length === 0) {
                forumTopicsEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--accent-teal); margin-bottom: 10px;">Nenhum Tópico</h3>
                        <p>Nenhum tópico de discussão foi criado ainda. Inicie um debate!</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" id="new-topic-empty">
                            <i class="fas fa-plus"></i> Criar Primeiro Tópico
                        </button>
                    </div>
                `;
                
                document.getElementById('new-topic-empty')?.addEventListener('click', () => {
                    openModal('modal-new-topic');
                });
            } else {
                forumTopics.forEach(topic => {
                    const topicEl = document.createElement('div');
                    topicEl.className = 'topic-card';
                    topicEl.innerHTML = `
                        <div class="topic-header">
                            <div>
                                <h4 class="topic-title">${topic.title}</h4>
                                <div class="topic-author">Por ${topic.author} • ${topic.authorLevel.toUpperCase()} • ${formatDate(topic.date)}</div>
                            </div>
                            <div class="topic-status">${topic.category === 'duvida' ? 'Dúvida' : 
                                topic.category === 'debate' ? 'Debate' : 
                                topic.category === 'desafio' ? 'Desafio' : 'Discussão'}</div>
                        </div>
                        <div class="topic-description">${topic.description}</div>
                        <div class="topic-meta">
                            <span><i class="fas fa-reply"></i> ${topic.replies?.length || 0} respostas</span>
                            <span><i class="fas fa-eye"></i> ${topic.views || 0} visualizações</span>
                            <span><i class="fas fa-tags"></i> ${topic.tags || 'Sem tags'}</span>
                        </div>
                    `;
                    topicEl.addEventListener('click', () => {
                        showTopicDetails(topic);
                    });
                    forumTopicsEl.appendChild(topicEl);
                });
            }
        }

        function renderGroups() {
            const groupsListEl = document.getElementById('groups-list');
            
            const groups = [
                {
                    id: 'transfunctoracao',
                    name: 'Transfunctoração',
                    description: 'Estudo das transformações radicais entre estruturas matemáticas.',
                    type: 'public',
                    members: 12,
                    theories: 5,
                    leader: 'Lohan Cunha'
                },
                {
                    id: 'transformacoes',
                    name: 'Transformações Radicais',
                    description: 'Desenvolvimento de operações que alteram fundamentalmente a natureza dos objetos matemáticos.',
                    type: 'public',
                    members: 8,
                    theories: 3,
                    leader: 'Lohan Cunha'
                },
                {
                    id: 'estruturas',
                    name: 'Estruturas Não-Convencionais',
                    description: 'Criação de estruturas algébricas que violam axiomas tradicionais.',
                    type: 'private',
                    members: 6,
                    theories: 4,
                    leader: 'Lohan Cunha'
                },
                {
                    id: 'algebra-superior',
                    name: 'Álgebra Superior',
                    description: 'Álgebras de ordem superior e sistemas algébricos aninhados.',
                    type: 'public',
                    members: 10,
                    theories: 2,
                    leader: 'Lohan Cunha'
                },
                {
                    id: 'conjecturas',
                    name: 'Conjecturas e "Caças"',
                    description: 'Formulação e resolução de conjecturas matemáticas radicais.',
                    type: 'restricted',
                    members: 4,
                    theories: 7,
                    leader: 'Lohan Cunha'
                },
                {
                    id: 'analise',
                    name: 'Análise Não-Padrão',
                    description: 'Análise matemática em estruturas não-arquimedianas e infinitésimos.',
                    type: 'private',
                    members: 5,
                    theories: 3,
                    leader: 'Lohan Cunha'
                }
            ];
            
            groupsListEl.innerHTML = '';
            
            groups.forEach(group => {
                // Verificar acesso
                if (group.type === 'restricted' && currentUser.level !== 'nucleo') return;
                
                const groupEl = document.createElement('div');
                groupEl.className = 'group-card';
                groupEl.innerHTML = `
                    <div class="group-header">
                        <div>
                            <h4 class="group-title">${group.name}</h4>
                            <div class="group-members">${group.members} membros • ${group.theories} teorias</div>
                        </div>
                        <div class="group-type type-${group.type}">${group.type === 'public' ? 'Público' : 
                            group.type === 'private' ? 'Privado' : 'Restrito'}</div>
                    </div>
                    <div class="group-description">${group.description}</div>
                    <div class="group-meta">
                        <span><i class="fas fa-crown"></i> Líder: ${group.leader}</span>
                        <button class="btn btn-small ${currentUser.level === 'observador' ? 'btn-secondary' : 'btn-primary'}" 
                                data-group="${group.id}">
                            ${currentUser.level === 'observador' ? 'Acesso Restrito' : 'Entrar no Grupo'}
                        </button>
                    </div>
                `;
                
                const joinBtn = groupEl.querySelector('button');
                if (currentUser.level !== 'observador') {
                    joinBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        const groupId = e.target.dataset.group;
                        if (group.type === 'restricted' && currentUser.level !== 'nucleo') {
                            showToast('Este grupo é restrito ao Núcleo', 'warning');
                        } else {
                            showToast(`Entrando no grupo: ${group.name}`, 'success');
                            // Em uma implementação completa, isso adicionaria o usuário ao grupo
                        }
                    });
                }
                
                groupEl.addEventListener('click', () => {
                    showGroupDetails(group);
                });
                
                groupsListEl.appendChild(groupEl);
            });
        }

        function renderChat() {
            const chatSidebarEl = document.getElementById('chat-sidebar');
            const chatMessagesEl = document.getElementById('chat-messages');
            const currentChatTitleEl = document.getElementById('current-chat-title');
            
            // Renderizar canais
            const channels = [
                { id: 'geral', name: 'Geral', icon: 'globe', unread: 0 },
                { id: 'transfunctoracao', name: 'Transfunctoração', icon: 'butterfly', unread: 0 },
                { id: 'transformacoes', name: 'Transformações', icon: 'exchange-alt', unread: 0 },
                { id: 'estruturas', name: 'Estruturas', icon: 'cubes', unread: 0 },
                { id: 'algebra-superior', name: 'Álgebra Superior', icon: 'layer-group', unread: 0 }
            ];
            
            chatSidebarEl.innerHTML = '';
            channels.forEach(channel => {
                // Verificar acesso para canais restritos
                if (channel.id === 'conjecturas' && currentUser.level !== 'nucleo') return;
                
                const channelEl = document.createElement('div');
                channelEl.className = `chat-group ${currentChatGroup === channel.id ? 'active' : ''}`;
                channelEl.dataset.channel = channel.id;
                channelEl.innerHTML = `
                    <div class="chat-group-icon">
                        <i class="fas fa-${channel.icon}"></i>
                    </div>
                    <div>
                        <div style="font-weight: 600;">${channel.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">
                            ${chatMessages[channel.id]?.length || 0} mensagens
                        </div>
                    </div>
                    ${channel.unread > 0 ? `<div class="notification-badge">${channel.unread}</div>` : ''}
                `;
                
                channelEl.addEventListener('click', () => {
                    switchChatGroup(channel.id);
                });
                
                chatSidebarEl.appendChild(channelEl);
            });
            
            // Renderizar mensagens do canal atual
            renderChatMessages(currentChatGroup);
            currentChatTitleEl.textContent = channels.find(c => c.id === currentChatGroup)?.name || 'Geral';
            
            // Atualizar contagem online
            const onlineCount = allUsers.filter(u => u.status === 'online').length;
            document.getElementById('online-count').textContent = `Online: ${onlineCount}`;
        }

        function renderChatMessages(groupId) {
            const chatMessagesEl = document.getElementById('chat-messages');
            const messages = chatMessages[groupId] || [];
            
            chatMessagesEl.innerHTML = '';
            
            if (messages.length === 0) {
                chatMessagesEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--accent-teal); margin-bottom: 10px;">Nenhuma Mensagem</h3>
                        <p>Seja o primeiro a enviar uma mensagem neste canal!</p>
                    </div>
                `;
            } else {
                messages.forEach(message => {
                    const messageEl = document.createElement('div');
                    messageEl.className = `message ${message.type === 'sent' ? 'message-sent' : 'message-received'}`;
                    messageEl.innerHTML = `
                        <div class="message-sender">
                            ${message.sender}
                            ${message.senderLevel !== 'system' ? 
                                `<span class="message-sender-level level-${message.senderLevel}">${message.senderLevel.toUpperCase()}</span>` : 
                                ''}
                        </div>
                        <div class="message-content">${renderLatexInText(message.message)}</div>
                        <div class="message-time">${formatDate(message.time)}</div>
                    `;
                    chatMessagesEl.appendChild(messageEl);
                });
                
                // Rolar para o final
                chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
            }
            
            // Reconfigurar MathJax para renderizar fórmulas
            if (window.MathJax) {
                MathJax.typesetPromise([chatMessagesEl]).catch(err => console.log('MathJax error:', err));
            }
        }

        function renderPrivateChat() {
            const chatSidebarEl = document.getElementById('private-chat-sidebar');
            const chatMessagesEl = document.getElementById('private-chat-messages');
            const chatInputContainer = document.getElementById('private-chat-input-container');
            const chatActions = document.getElementById('private-chat-actions');
            
            // Renderizar conversas
            chatSidebarEl.innerHTML = '';
            
            // Filtrar conversas do usuário atual
            const userConversations = Object.values(conversations).filter(conv => 
                conv.participants.some(p => p.userId === currentUser.id)
            );
            
            if (userConversations.length === 0) {
                chatSidebarEl.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Nenhuma conversa</p>
                        <p style="font-size: 0.8rem;">Adicione contatos para iniciar conversas</p>
                    </div>
                `;
            } else {
                userConversations.forEach(conversation => {
                    const otherParticipant = conversation.participants.find(p => p.userId !== currentUser.id);
                    if (!otherParticipant) return;
                    
                    const user = allUsers.find(u => u.id === otherParticipant.userId);
                    if (!user) return;
                    
                    const conversationEl = document.createElement('div');
                    conversationEl.className = `chat-contact ${currentPrivateChat === conversation.id ? 'active' : ''}`;
                    conversationEl.dataset.conversation = conversation.id;
                    conversationEl.innerHTML = `
                        <div class="contact-avatar">
                            ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}">` : 
                                `<span>${user.name.charAt(0)}</span>`}
                        </div>
                        <div style="flex: 1;">
                            <div style="font-weight: 600; display: flex; align-items: center;">
                                ${user.name}
                                <div class="online-dot ${user.status === 'online' ? '' : 'offline'}"></div>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                ${conversation.lastMessage ? 
                                    (conversation.lastMessage.senderId === currentUser.id ? 'Você: ' : '') + 
                                    (conversation.lastMessage.text?.substring(0, 30) || '') + 
                                    (conversation.lastMessage.text?.length > 30 ? '...' : '') : 
                                    'Sem mensagens'}
                            </div>
                        </div>
                        ${conversation.unreadCount > 0 ? 
                            `<div class="notification-badge">${conversation.unreadCount}</div>` : ''}
                    `;
                    
                    conversationEl.addEventListener('click', () => {
                        switchPrivateChat(conversation.id);
                    });
                    
                    chatSidebarEl.appendChild(conversationEl);
                });
            }
            
            // Renderizar mensagens da conversa atual
            if (currentPrivateChat) {
                const messages = privateMessages[currentPrivateChat] || [];
                const conversation = conversations[currentPrivateChat];
                
                if (conversation) {
                    const otherParticipant = conversation.participants.find(p => p.userId !== currentUser.id);
                    const user = allUsers.find(u => u.id === otherParticipant.userId);
                    
                    document.getElementById('private-chat-title').textContent = user?.name || 'Conversa';
                    chatInputContainer.style.display = 'flex';
                    chatActions.style.display = 'block';
                    
                    chatMessagesEl.innerHTML = '';
                    
                    if (messages.length === 0) {
                        chatMessagesEl.innerHTML = `
                            <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                                <i class="fas fa-comment" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                                <h3 style="color: var(--accent-teal); margin-bottom: 10px;">Conversa com ${user?.name}</h3>
                                <p>Nenhuma mensagem ainda. Envie a primeira mensagem!</p>
                            </div>
                        `;
                    } else {
                        messages.forEach(message => {
                            const messageEl = document.createElement('div');
                            messageEl.className = `message ${message.senderId === currentUser.id ? 'message-sent' : 'message-received'}`;
                            messageEl.innerHTML = `
                                <div class="message-sender">
                                    ${message.sender}
                                    ${message.senderLevel !== 'system' ? 
                                        `<span class="message-sender-level level-${message.senderLevel}">${message.senderLevel.toUpperCase()}</span>` : 
                                        ''}
                                </div>
                                <div class="message-content">${renderLatexInText(message.message)}</div>
                                <div class="message-time">${formatDate(message.time)}</div>
                            `;
                            chatMessagesEl.appendChild(messageEl);
                        });
                        
                        // Rolar para o final
                        chatMessagesEl.scrollTop = chatMessagesEl.scrollHeight;
                    }
                    
                    // Marcar mensagens como lidas
                    markPrivateMessagesAsRead(currentPrivateChat);
                }
            } else {
                // Tela inicial
                chatInputContainer.style.display = 'none';
                chatActions.style.display = 'none';
            }
            
            // Reconfigurar MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([chatMessagesEl]).catch(err => console.log('MathJax error:', err));
            }
        }

        function renderContacts() {
            const contactsListEl = document.getElementById('contacts-list');
            const sidebarContactsList = document.getElementById('sidebar-contacts-list');
            
            // Renderizar lista principal de contatos
            contactsListEl.innerHTML = '';
            
            if (contacts.length === 0) {
                contactsListEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--accent-teal); margin-bottom: 10px;">Nenhum Contato</h3>
                        <p>Você ainda não adicionou nenhum membro aos seus contatos.</p>
                        <button class="btn btn-primary" style="margin-top: 20px;" id="add-contact-empty">
                            <i class="fas fa-user-plus"></i> Adicionar Primeiro Contato
                        </button>
                    </div>
                `;
                
                document.getElementById('add-contact-empty')?.addEventListener('click', () => {
                    openModal('modal-add-contact');
                });
            } else {
                contacts.forEach(contact => {
                    const user = allUsers.find(u => u.id === contact.userId);
                    if (!user) return;
                    
                    const contactEl = document.createElement('div');
                    contactEl.className = 'contact-item';
                    contactEl.dataset.contactId = contact.userId;
                    contactEl.innerHTML = `
                        <div class="contact-avatar-small">
                            ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}">` : 
                                `<span>${user.name.charAt(0)}</span>`}
                        </div>
                        <div class="contact-info">
                            <div class="contact-name">${user.name}</div>
                            <div class="contact-last-message">${user.description || 'Membro do Algebra Renova'}</div>
                        </div>
                        <div style="text-align: right;">
                            <div class="contact-time">${formatDate(user.lastSeen)}</div>
                            <div style="display: flex; align-items: center; justify-content: flex-end; margin-top: 5px;">
                                <span class="user-level level-${user.level}">${user.level.toUpperCase()}</span>
                                <div class="online-dot ${user.status === 'online' ? '' : 'offline'}" style="margin-left: 10px;"></div>
                            </div>
                        </div>
                    `;
                    
                    contactEl.addEventListener('click', () => {
                        // Em uma implementação completa, isso abriria o perfil ou iniciaria chat
                        const conversationId = getConversationId(currentUser.id, contact.userId);
                        switchPrivateChat(conversationId);
                        switchSection('private-chat');
                    });
                    
                    contactsListEl.appendChild(contactEl);
                });
            }
            
            // Renderizar contatos na sidebar (apenas online)
            renderSidebarContacts();
        }

        function renderSidebarContacts() {
            const sidebarContactsList = document.getElementById('sidebar-contacts-list');
            const onlineContacts = contacts.filter(contact => {
                const user = allUsers.find(u => u.id === contact.userId);
                return user && user.status === 'online';
            }).slice(0, 5); // Limitar a 5 contatos online na sidebar
            
            sidebarContactsList.innerHTML = '';
            
            if (onlineContacts.length === 0) {
                sidebarContactsList.innerHTML = `
                    <div style="text-align: center; padding: 10px; color: var(--text-secondary); font-size: 0.8rem;">
                        Nenhum contato online
                    </div>
                `;
            } else {
                onlineContacts.forEach(contact => {
                    const user = allUsers.find(u => u.id === contact.userId);
                    if (!user) return;
                    
                    const contactEl = document.createElement('div');
                    contactEl.className = 'sidebar-contact-item';
                    contactEl.title = user.name;
                    contactEl.innerHTML = `
                        <div class="sidebar-contact-avatar">
                            ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}">` : 
                                `<span>${user.name.charAt(0)}</span>`}
                        </div>
                        <div class="sidebar-contact-name">${user.name}</div>
                        <div class="sidebar-contact-status ${user.status === 'online' ? '' : 'offline'}"></div>
                    `;
                    
                    contactEl.addEventListener('click', () => {
                        const conversationId = getConversationId(currentUser.id, contact.userId);
                        switchPrivateChat(conversationId);
                        switchSection('private-chat');
                    });
                    
                    sidebarContactsList.appendChild(contactEl);
                });
            }
        }

        function renderFiles() {
            const filesTableEl = document.getElementById('files-table');
            
            filesTableEl.innerHTML = '';
            
            if (files.length === 0) {
                filesTableEl.innerHTML = `
                    <tr>
                        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-archive" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                            <p>Nenhum arquivo enviado ainda.</p>
                        </td>
                    </tr>
                `;
            } else {
                files.forEach(file => {
                    const fileEl = document.createElement('tr');
                    fileEl.innerHTML = `
                        <td>
                            <i class="fas fa-file-${file.type === 'pdf' ? 'pdf' : 
                                file.type === 'tex' ? 'code' : 
                                file.type === 'md' ? 'markdown' : 
                                file.type === 'txt' ? 'file-alt' : 
                                file.type === 'image' ? 'image' : 'file'}"></i>
                            ${file.name}
                        </td>
                        <td>${file.type.toUpperCase()}</td>
                        <td>${file.size}</td>
                        <td>
                            <span class="user-level level-${file.uploadedByLevel}">${file.uploadedByLevel.toUpperCase()}</span>
                            ${file.uploadedBy}
                        </td>
                        <td>${formatDate(file.date)}</td>
                        <td>
                            <button class="btn btn-small btn-secondary" data-file="${file.id}" title="Download">
                                <i class="fas fa-download"></i>
                            </button>
                            ${currentUser.level === 'nucleo' || file.uploadedById === currentUser.id ? 
                                `<button class="btn btn-small btn-secondary" data-file-delete="${file.id}" title="Excluir">
                                    <i class="fas fa-trash"></i>
                                </button>` : ''}
                        </td>
                    `;
                    
                    filesTableEl.appendChild(fileEl);
                });
            }
        }

        function renderMembers() {
            const nucleoList = document.getElementById('nucleo-list');
            const iniciadosList = document.getElementById('iniciados-list');
            const observadoresList = document.getElementById('observadores-list');
            
            // Limpar listas
            nucleoList.innerHTML = '<li style="padding: 5px 0;"><i class="fas fa-crown" style="margin-right: 8px; color: var(--accent-gold);"></i>Lohan Cunha (Fundador)</li>';
            iniciadosList.innerHTML = '';
            observadoresList.innerHTML = '';
            
            // Agrupar usuários por nível
            const nucleoMembers = allUsers.filter(u => u.level === 'nucleo' && u.id !== '1'); // Excluir fundador já listado
            const iniciadoMembers = allUsers.filter(u => u.level === 'iniciado');
            const observadorMembers = allUsers.filter(u => u.level === 'observador');
            
            // Adicionar membros do Núcleo
            nucleoMembers.forEach(user => {
                const li = document.createElement('li');
                li.style.padding = '5px 0';
                li.innerHTML = `<i class="fas fa-crown" style="margin-right: 8px; color: var(--accent-gold);"></i>${user.name}`;
                nucleoList.appendChild(li);
            });
            
            // Adicionar Iniciados
            iniciadoMembers.forEach(user => {
                const li = document.createElement('li');
                li.style.padding = '5px 0';
                li.innerHTML = `<i class="fas fa-star" style="margin-right: 8px; color: var(--accent-teal);"></i>${user.name}`;
                iniciadosList.appendChild(li);
            });
            
            // Adicionar Observadores
            observadorMembers.forEach(user => {
                const li = document.createElement('li');
                li.style.padding = '5px 0';
                li.innerHTML = `<i class="fas fa-eye" style="margin-right: 8px; color: #6c757d;"></i>${user.name}`;
                observadoresList.appendChild(li);
            });
            
            // Adicionar o usuário atual se não estiver listado
            if (currentUser && !allUsers.find(u => u.id === currentUser.id)) {
                const list = currentUser.level === 'nucleo' ? nucleoList :
                            currentUser.level === 'iniciado' ? iniciadosList : observadoresList;
                const icon = currentUser.level === 'nucleo' ? 'crown' :
                            currentUser.level === 'iniciado' ? 'star' : 'eye';
                const color = currentUser.level === 'nucleo' ? 'var(--accent-gold)' :
                            currentUser.level === 'iniciado' ? 'var(--accent-teal)' : '#6c757d';
                
                const li = document.createElement('li');
                li.style.padding = '5px 0';
                li.innerHTML = `<i class="fas fa-${icon}" style="margin-right: 8px; color: ${color};"></i>${currentUser.name} (Você)`;
                list.appendChild(li);
            }
        }

        function renderNotifications() {
            const notificationsListEl = document.getElementById('notifications-list');
            const userNotifications = notifications.filter(n => n.userId === currentUser.id);
            
            notificationsListEl.innerHTML = '';
            
            if (userNotifications.length === 0) {
                notificationsListEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-bell-slash" style="font-size: 3rem; margin-bottom: 15px; opacity: 0.5;"></i>
                        <h3 style="color: var(--accent-teal); margin-bottom: 10px;">Sem Notificações</h3>
                        <p>Você não tem notificações no momento.</p>
                    </div>
                `;
            } else {
                userNotifications.forEach(notification => {
                    const notificationEl = document.createElement('div');
                    notificationEl.className = `notification-item ${notification.read ? '' : 'unread'}`;
                    notificationEl.dataset.notificationId = notification.id;
                    notificationEl.innerHTML = `
                        <div class="notification-title">
                            <i class="fas fa-${notification.type === 'theory' ? 'atom' : 
                                notification.type === 'contact' ? 'user-friends' : 
                                notification.type === 'system' ? 'cog' : 'info-circle'}"></i>
                            ${notification.title}
                        </div>
                        <div style="color: var(--text-secondary); margin-bottom: 5px;">${notification.message}</div>
                        <div class="notification-time">${formatDate(notification.date)}</div>
                    `;
                    
                    notificationEl.addEventListener('click', () => {
                        markNotificationAsRead(notification.id);
                        
                        // Navegar para seção relevante baseada no tipo
                        if (notification.type === 'theory') {
                            switchSection('theories');
                            showToast(`Navegando para teoria relacionada`, 'info');
                        } else if (notification.type === 'contact') {
                            switchSection('contacts');
                        }
                        
                        closeModal('modal-notifications');
                    });
                    
                    notificationsListEl.appendChild(notificationEl);
                });
            }
        }

        // =============================================
        // FUNÇÕES DE CONTROLE DE INTERFACE
        // =============================================

        function switchSection(sectionId) {
            // Esconder todas as seções
            document.querySelectorAll('.content-section').forEach(section => {
                section.classList.remove('active');
            });
            
            // Mostrar seção selecionada
            const targetSection = document.getElementById(sectionId);
            if (targetSection) {
                targetSection.classList.add('active');
                
                // Atualizar título da página
                const pageTitle = document.getElementById('page-title');
                pageTitle.textContent = targetSection.querySelector('.section-title')?.textContent || 'Dashboard';
                
                // Atualizar menu ativo
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    if (link.dataset.section === sectionId) {
                        link.classList.add('active');
                    }
                });
                
                // Renderizar conteúdo específico da seção
                switch(sectionId) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'theories':
                        renderTheories();
                        break;
                    case 'research-groups':
                        renderGroups();
                        break;
                    case 'forum':
                        renderForumTopics();
                        break;
                    case 'chat':
                        renderChat();
                        break;
                    case 'private-chat':
                        renderPrivateChat();
                        break;
                    case 'contacts':
                        renderContacts();
                        break;
                    case 'files':
                        renderFiles();
                        break;
                    case 'profile':
                        // Preencher formulário de perfil
                        document.getElementById('profile-name').value = currentUser.name;
                        document.getElementById('profile-level').value = currentUser.level === 'observador' ? 'Observador' :
                                                                        currentUser.level === 'iniciado' ? 'Iniciado' : 'Núcleo';
                        document.getElementById('profile-description').value = currentUser.description || '';
                        document.getElementById('profile-expertise').value = currentUser.expertise || '';
                        document.getElementById('profile-status').value = currentUser.status || 'active';
                        renderDashboard(); // Para atualizar estatísticas do perfil
                        break;
                    case 'members':
                        renderMembers();
                        break;
                }
                
                // Scroll para o topo
                window.scrollTo(0, 0);
            }
        }

        function switchChatGroup(groupId) {
            currentChatGroup = groupId;
            renderChat();
        }

        function switchPrivateChat(conversationId) {
            currentPrivateChat = conversationId;
            renderPrivateChat();
        }

        function markPrivateMessagesAsRead(conversationId) {
            if (!privateMessages[conversationId]) return;
            
            let updated = false;
            privateMessages[conversationId].forEach(message => {
                if (message.senderId !== currentUser.id && !message.read) {
                    message.read = true;
                    updated = true;
                }
            });
            
            if (updated) {
                savePrivateMessages();
                updateUnreadPrivateMessages();
                renderPrivateChat();
            }
        }

        function markNotificationAsRead(notificationId) {
            const notificationIndex = notifications.findIndex(n => n.id === notificationId);
            if (notificationIndex !== -1 && !notifications[notificationIndex].read) {
                notifications[notificationIndex].read = true;
                saveNotifications();
                updateUnreadNotifications();
                renderNotifications();
            }
        }

        function openModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.add('active');
                
                // Renderizar conteúdo específico do modal
                if (modalId === 'modal-add-contact') {
                    renderAddContactModal();
                } else if (modalId === 'modal-new-private-chat') {
                    renderNewPrivateChatModal();
                } else if (modalId === 'modal-notifications') {
                    renderNotifications();
                    // Marcar todas as notificações como lidas ao abrir o modal
                    notifications.forEach(n => {
                        if (n.userId === currentUser.id && !n.read) {
                            n.read = true;
                        }
                    });
                    saveNotifications();
                    updateUnreadNotifications();
                }
            }
        }

        function closeModal(modalId) {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function renderAddContactModal() {
            const searchResultsEl = document.getElementById('contact-search-results');
            const contactSearch = document.getElementById('contact-search');
            
            contactSearch.addEventListener('input', (e) => {
                const searchTerm = e.target.value.toLowerCase();
                
                if (searchTerm.length < 2) {
                    searchResultsEl.style.display = 'none';
                    return;
                }
                
                // Filtrar usuários que não são o usuário atual e não são já contatos
                const filteredUsers = allUsers.filter(user => 
                    user.id !== currentUser.id &&
                    !contacts.some(c => c.userId === user.id) &&
                    (user.name.toLowerCase().includes(searchTerm) || 
                     user.description?.toLowerCase().includes(searchTerm))
                );
                
                if (filteredUsers.length === 0) {
                    searchResultsEl.innerHTML = '<div style="padding: 10px; color: var(--text-secondary); text-align: center;">Nenhum membro encontrado</div>';
                } else {
                    searchResultsEl.innerHTML = '';
                    filteredUsers.forEach(user => {
                        const userEl = document.createElement('div');
                        userEl.className = 'sidebar-contact-item';
                        userEl.style.cursor = 'pointer';
                        userEl.innerHTML = `
                            <div class="sidebar-contact-avatar">
                                ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}">` : 
                                    `<span>${user.name.charAt(0)}</span>`}
                            </div>
                            <div class="sidebar-contact-name">${user.name}</div>
                            <span class="user-level level-${user.level}" style="font-size: 0.7rem;">${user.level.toUpperCase()}</span>
                        `;
                        
                        userEl.addEventListener('click', () => {
                            document.getElementById('contact-name').value = user.name;
                            document.getElementById('contact-level').value = user.level;
                            searchResultsEl.style.display = 'none';
                        });
                        
                        searchResultsEl.appendChild(userEl);
                    });
                }
                
                searchResultsEl.style.display = 'block';
            });
        }

        function renderNewPrivateChatModal() {
            const contactsListEl = document.getElementById('private-chat-contacts-list');
            const userContacts = contacts.filter(contact => {
                const user = allUsers.find(u => u.id === contact.userId);
                return user && user.id !== currentUser.id;
            });
            
            contactsListEl.innerHTML = '';
            
            if (userContacts.length === 0) {
                contactsListEl.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 2rem; margin-bottom: 10px; opacity: 0.5;"></i>
                        <p>Você não tem contatos ainda.</p>
                        <button class="btn btn-primary btn-small" style="margin-top: 15px;" onclick="closeModal('modal-new-private-chat'); openModal('modal-add-contact');">
                            <i class="fas fa-user-plus"></i> Adicionar Contatos
                        </button>
                    </div>
                `;
            } else {
                userContacts.forEach(contact => {
                    const user = allUsers.find(u => u.id === contact.userId);
                    if (!user) return;
                    
                    const contactEl = document.createElement('div');
                    contactEl.className = 'sidebar-contact-item';
                    contactEl.style.cursor = 'pointer';
                    contactEl.dataset.userId = user.id;
                    contactEl.innerHTML = `
                        <div class="sidebar-contact-avatar">
                            ${user.avatar ? `<img src="${user.avatar}" alt="${user.name}">` : 
                                `<span>${user.name.charAt(0)}</span>`}
                        </div>
                        <div class="sidebar-contact-name">${user.name}</div>
                        <div class="sidebar-contact-status ${user.status === 'online' ? '' : 'offline'}"></div>
                    `;
                    
                    contactEl.addEventListener('click', () => {
                        // Selecionar/deselecionar contato
                        document.querySelectorAll('#private-chat-contacts-list .sidebar-contact-item').forEach(item => {
                            item.classList.remove('active');
                        });
                        contactEl.classList.add('active');
                    });
                    
                    contactsListEl.appendChild(contactEl);
                });
            }
        }

        // =============================================
        // FUNÇÕES DE AUTENTICAÇÃO E LOGIN
        // =============================================

        function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('login-username').value.trim();
            const password = document.getElementById('login-password').value;
            const level = document.getElementById('login-level').value;
            const masterKey = document.getElementById('master-key')?.value;
            
            if (!username || !password || !level) {
                showToast("Preencha todos os campos obrigatórios", "error");
                return;
            }
            
            // Verificar chave mestre se for nível Núcleo
            if (level === 'nucleo' && masterKey !== MASTER_KEY) {
                showToast("Chave do Núcleo incorreta", "error");
                return;
            }
            
            // Verificar se usuário já existe
            let user = allUsers.find(u => u.name.toLowerCase() === username.toLowerCase());
            
            if (user) {
                // Login existente - verificar senha
                if (user.password !== password) {
                    showToast("Senha incorreta", "error");
                    return;
                }
                
                // Atualizar nível se mudou
                if (user.level !== level) {
                    // Verificar se pode mudar para Núcleo
                    if (level === 'nucleo' && masterKey !== MASTER_KEY) {
                        showToast("Não autorizado para nível Núcleo", "error");
                        return;
                    }
                    user.level = level;
                }
            } else {
                // Novo usuário - criar
                user = {
                    id: generateId(),
                    name: username,
                    password: password,
                    level: level,
                    avatar: username.charAt(0).toUpperCase(),
                    joinDate: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    status: 'online',
                    description: '',
                    expertise: '',
                    lastActivity: new Date().toISOString()
                };
                
                allUsers.push(user);
                saveToStorage(STORAGE_KEYS.USERS, allUsers);
                
                // Adicionar notificação para o fundador
                const founder = allUsers.find(u => u.id === '1');
                if (founder) {
                    addNotification(founder.id, "Novo membro", `${username} se juntou ao Algebra Renova como ${level === 'observador' ? 'Observador' : level === 'iniciado' ? 'Iniciado' : 'Núcleo'}`, "system");
                }
            }
            
            // Fazer login
            currentUser = user;
            currentUser.status = 'online';
            currentUser.lastSeen = new Date().toISOString();
            
            saveUser();
            
            // Adicionar atividade
            addActivity(`${username} fez login como ${level}`, "door-open");
            
            // Mostrar mensagem de boas-vindas
            showToast(`Bem-vindo, ${username}! Nível: ${level.toUpperCase()}`, "success");
            
            // Inicializar dados do usuário
            initializeUserData();
            
            // Mudar para a interface principal
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-site').style.display = 'flex';
            
            // Renderizar interface
            renderDashboard();
            switchSection('dashboard');
            
            // Atualizar interface do usuário
            updateUserInterface();
        }

        function initializeUserData() {
            if (!currentUser) return;
            
            // Verificar se já tem contato com o fundador (para novos usuários)
            if (!contacts.some(c => c.userId === '1')) {
                const founderContact = {
                    id: generateId(),
                    userId: '1',
                    name: 'Lohan Cunha',
                    level: 'nucleo',
                    avatar: 'LC',
                    status: allUsers.find(u => u.id === '1')?.status || 'online',
                    lastSeen: allUsers.find(u => u.id === '1')?.lastSeen || new Date().toISOString(),
                    addedDate: new Date().toISOString()
                };
                
                contacts.push(founderContact);
                saveContacts();
                
                // Criar conversa com o fundador
                const conversationId = getConversationId(currentUser.id, '1');
                if (!conversations[conversationId]) {
                    conversations[conversationId] = {
                        id: conversationId,
                        participants: [
                            { userId: currentUser.id, name: currentUser.name, level: currentUser.level },
                            { userId: '1', name: 'Lohan Cunha', level: 'nucleo' }
                        ],
                        lastMessage: null,
                        lastActivity: new Date().toISOString(),
                        unreadCount: 0
                    };
                    saveConversations();
                    
                    // Mensagem de boas-vindas do sistema
                    const welcomeMessage = {
                        id: generateId(),
                        sender: "Sistema Algebra Renova",
                        senderId: "system",
                        senderLevel: "system",
                        message: `Bem-vindo ao Algebra Renova, ${currentUser.name}! Eu sou Lohan Cunha, fundador da organização. Fique à vontade para explorar as teorias e participar das discussões.`,
                        time: new Date().toISOString(),
                        read: false
                    };
                    
                    if (!privateMessages[conversationId]) {
                        privateMessages[conversationId] = [];
                    }
                    privateMessages[conversationId].push(welcomeMessage);
                    savePrivateMessages();
                }
            }
            
            // Adicionar notificação de boas-vindas
            addNotification(currentUser.id, "Bem-vindo ao Algebra Renova", 
                "Explore as teorias, participe dos grupos e conecte-se com outros membros. Sua jornada matemática começa agora.", 
                "system");
        }

        function updateUserInterface() {
            if (!currentUser) return;
            
            // Atualizar informações do usuário na sidebar
            document.getElementById('user-name').textContent = currentUser.name;
            document.getElementById('user-level').textContent = 
                currentUser.level === 'observador' ? 'Observador' :
                currentUser.level === 'iniciado' ? 'Iniciado' : 'Núcleo';
            
            document.getElementById('user-level').className = `user-level level-${currentUser.level}`;
            
            // Atualizar avatar
            const userAvatar = document.getElementById('user-avatar');
            userAvatar.innerHTML = `
                <span>${currentUser.avatar}</span>
                <div class="user-avatar-upload">Alterar Foto</div>
            `;
        }

        function handleLogout() {
            if (currentUser) {
                // Atualizar status para offline
                updateUserStatus('offline');
                
                // Adicionar atividade
                addActivity(`${currentUser.name} saiu do sistema`, "sign-out-alt");
                
                showToast(`Até logo, ${currentUser.name}!`, "info");
            }
            
            // Limpar usuário atual
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.USER);
            
            // Voltar para tela de login
            document.getElementById('login-page').style.display = 'flex';
            document.getElementById('main-site').style.display = 'none';
            
            // Limpar formulário de login
            document.getElementById('login-form').reset();
            document.getElementById('master-key-group').style.display = 'none';
        }

        // =============================================
        // EVENT LISTENERS E INICIALIZAÇÃO
        // =============================================

        function initializeEventListeners() {
            // Login
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('login-level').addEventListener('change', function() {
                const masterKeyGroup = document.getElementById('master-key-group');
                masterKeyGroup.style.display = this.value === 'nucleo' ? 'block' : 'none';
            });
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Navegação do menu
            document.querySelectorAll('.nav-link[data-section]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const sectionId = this.dataset.section;
                    switchSection(sectionId);
                });
            });
            
            // Botões que alternam seções
            document.querySelectorAll('button[data-section]').forEach(button => {
                button.addEventListener('click', function() {
                    const sectionId = this.dataset.section;
                    switchSection(sectionId);
                });
            });
            
            // Busca global
            document.getElementById('global-search').addEventListener('input', function(e) {
                const searchTerm = e.target.value.toLowerCase();
                if (searchTerm.length > 2) {
                    // Em uma implementação completa, isso filtraria o conteúdo
                    showToast(`Buscando por: ${searchTerm}`, "info");
                }
            });
            
            // Notificações
            document.getElementById('notification-btn').addEventListener('click', () => {
                openModal('modal-notifications');
            });
            
            // Modais - abrir
            document.getElementById('new-theory-btn')?.addEventListener('click', () => openModal('modal-new-theory'));
            document.getElementById('new-topic-btn')?.addEventListener('click', () => openModal('modal-new-topic'));
            document.getElementById('add-contact-btn')?.addEventListener('click', () => openModal('modal-add-contact'));
            document.getElementById('sidebar-add-contact')?.addEventListener('click', () => openModal('modal-add-contact'));
            document.getElementById('new-private-chat-btn')?.addEventListener('click', () => openModal('modal-new-private-chat'));
            document.getElementById('upload-file-btn')?.addEventListener('click', () => openModal('modal-upload'));
            document.getElementById('change-password-btn')?.addEventListener('click', () => openModal('modal-change-password'));
            document.getElementById('request-initiation')?.addEventListener('click', () => {
                if (currentUser.level === 'observador') {
                    showToast("Solicitação enviada para avaliação do Núcleo", "info");
                    addNotification('1', "Solicitação de iniciação", 
                        `${currentUser.name} solicitou avanço para nível Iniciado`, "system", currentUser.id);
                } else {
                    showToast("Você já é um Iniciado ou membro do Núcleo", "info");
                }
            });
            
            // Modais - fechar
            document.querySelectorAll('.modal-close, button[data-modal]').forEach(button => {
                button.addEventListener('click', function() {
                    const modalId = this.dataset.modal;
                    closeModal(modalId);
                });
            });
            
            // Fechar modal ao clicar fora
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', function(e) {
                    if (e.target === this) {
                        this.classList.remove('active');
                    }
                });
            });
            
            // Formulário Nova Teoria
            document.getElementById('theory-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const theoryData = {
                    title: document.getElementById('theory-name').value,
                    group: document.getElementById('theory-group').value,
                    description: document.getElementById('theory-description').value,
                    content: document.getElementById('theory-content').value,
                    status: document.getElementById('theory-status').value,
                    visibility: document.getElementById('theory-visibility').value,
                    tags: document.getElementById('theory-tags').value
                };
                
                createNewTheory(theoryData);
                closeModal('modal-new-theory');
                this.reset();
                renderTheories();
                switchSection('theories');
            });
            
            // Formulário Novo Tópico
            document.getElementById('topic-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const topicData = {
                    title: document.getElementById('topic-title').value,
                    description: document.getElementById('topic-description').value,
                    content: document.getElementById('topic-content').value,
                    category: document.getElementById('topic-category').value,
                    tags: document.getElementById('topic-tags').value
                };
                
                createNewTopic(topicData);
                closeModal('modal-new-topic');
                this.reset();
                renderForumTopics();
                switchSection('forum');
            });
            
            // Formulário Adicionar Contato
            document.getElementById('add-contact-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const contactName = document.getElementById('contact-name').value;
                const contactLevel = document.getElementById('contact-level').value;
                
                // Buscar usuário pelo nome
                const userToAdd = allUsers.find(u => 
                    u.name.toLowerCase() === contactName.toLowerCase() && 
                    u.id !== currentUser.id
                );
                
                if (userToAdd) {
                    addContact(userToAdd.id);
                } else {
                    // Criar usuário fictício (para demonstração)
                    const newUserId = generateId();
                    const newUser = {
                        id: newUserId,
                        name: contactName,
                        level: contactLevel,
                        avatar: contactName.charAt(0).toUpperCase(),
                        status: 'offline',
                        lastSeen: new Date().toISOString(),
                        description: 'Membro adicionado manualmente',
                        joinDate: new Date().toISOString()
                    };
                    
                    allUsers.push(newUser);
                    saveToStorage(STORAGE_KEYS.USERS, allUsers);
                    
                    addContact(newUserId);
                }
                
                closeModal('modal-add-contact');
                this.reset();
                renderContacts();
            });
            
            // Nova Conversa Privada
            document.getElementById('start-private-chat-btn')?.addEventListener('click', function() {
                const selectedContact = document.querySelector('#private-chat-contacts-list .sidebar-contact-item.active');
                const initialMessage = document.getElementById('private-chat-message').value;
                
                if (!selectedContact) {
                    showToast("Selecione um contato", "warning");
                    return;
                }
                
                const userId = selectedContact.dataset.userId;
                const conversationId = getConversationId(currentUser.id, userId);
                
                // Garantir que a conversa existe
                if (!conversations[conversationId]) {
                    const user = allUsers.find(u => u.id === userId);
                    conversations[conversationId] = {
                        id: conversationId,
                        participants: [
                            { userId: currentUser.id, name: currentUser.name, level: currentUser.level },
                            { userId: userId, name: user.name, level: user.level }
                        ],
                        lastMessage: null,
                        lastActivity: new Date().toISOString(),
                        unreadCount: 0
                    };
                    saveConversations();
                }
                
                // Enviar mensagem inicial se fornecida
                if (initialMessage.trim()) {
                    addPrivateMessage(conversationId, {
                        message: initialMessage
                    });
                }
                
                closeModal('modal-new-private-chat');
                switchPrivateChat(conversationId);
                switchSection('private-chat');
            });
            
            // Chat Geral - Enviar mensagem
            document.getElementById('send-message')?.addEventListener('click', sendChatMessage);
            document.getElementById('chat-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendChatMessage();
                }
            });
            
            // Chat Privado - Enviar mensagem
            document.getElementById('send-private-message')?.addEventListener('click', sendPrivateMessage);
            document.getElementById('private-chat-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });
            
            // LaTeX preview toggle
            document.getElementById('latex-toggle')?.addEventListener('click', function() {
                const preview = document.getElementById('latex-preview');
                const textarea = document.getElementById('chat-input');
                
                if (preview.classList.contains('active')) {
                    preview.classList.remove('active');
                    this.innerHTML = '<i class="fas fa-square-root-alt"></i> LaTeX';
                } else {
                    preview.classList.add('active');
                    updateLatexPreview();
                    this.innerHTML = '<i class="fas fa-times"></i> Fechar';
                }
            });
            
            // Atualizar preview LaTeX
            document.getElementById('chat-input')?.addEventListener('input', updateLatexPreview);
            
            // Upload de arquivo
            document.getElementById('upload-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const fileName = document.getElementById('file-name').value;
                const fileType = document.getElementById('file-type').value;
                const fileVisibility = document.getElementById('file-visibility').value;
                const fileDescription = document.getElementById('file-description').value;
                const fileInput = document.getElementById('file-upload');
                
                if (!fileName || !fileInput.files.length) {
                    showToast("Preencha todos os campos obrigatórios", "error");
                    return;
                }
                
                const file = fileInput.files[0];
                const fileSize = (file.size / (1024*1024)).toFixed(2) + ' MB';
                
                const fileData = {
                    name: fileName,
                    type: fileType,
                    size: fileSize,
                    description: fileDescription,
                    visibility: fileVisibility
                };
                
                addFile(fileData);
                closeModal('modal-upload');
                this.reset();
                renderFiles();
                switchSection('files');
            });
            
            // Alterar senha
            document.getElementById('change-password-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                const currentPassword = document.getElementById('current-password').value;
                const newPassword = document.getElementById('new-password').value;
                const confirmPassword = document.getElementById('confirm-password').value;
                
                if (currentPassword !== currentUser.password) {
                    showToast("Senha atual incorreta", "error");
                    return;
                }
                
                if (newPassword.length < 8) {
                    showToast("Nova senha deve ter pelo menos 8 caracteres", "error");
                    return;
                }
                
                if (newPassword !== confirmPassword) {
                    showToast("As senhas não coincidem", "error");
                    return;
                }
                
                currentUser.password = newPassword;
                saveUser();
                
                showToast("Senha alterada com sucesso!", "success");
                closeModal('modal-change-password');
                this.reset();
            });
            
            // Perfil
            document.getElementById('profile-form')?.addEventListener('submit', function(e) {
                e.preventDefault();
                
                currentUser.name = document.getElementById('profile-name').value;
                currentUser.description = document.getElementById('profile-description').value;
                currentUser.expertise = document.getElementById('profile-expertise').value;
                currentUser.status = document.getElementById('profile-status').value;
                
                saveUser();
                updateUserInterface();
                showToast("Perfil atualizado com sucesso!", "success");
                
                // Atualizar em todas as conversas
                Object.keys(conversations).forEach(convId => {
                    const conv = conversations[convId];
                    const participantIndex = conv.participants.findIndex(p => p.userId === currentUser.id);
                    if (participantIndex !== -1) {
                        conv.participants[participantIndex].name = currentUser.name;
                        conv.participants[participantIndex].level = currentUser.level;
                    }
                });
                saveConversations();
            });
            
            // Upload de avatar
            document.getElementById('avatar-upload')?.addEventListener('change', function(e) {
                if (this.files && this.files[0]) {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        // Em uma implementação real, enviaria para servidor
                        // Aqui apenas simulamos
                        currentUser.avatar = e.target.result;
                        saveUser();
                        updateUserInterface();
                        showToast("Avatar atualizado!", "success");
                    };
                    
                    reader.readAsDataURL(this.files[0]);
                }
            });
            
            document.getElementById('user-avatar')?.addEventListener('click', function() {
                document.getElementById('avatar-upload').click();
            });
            
            // Solicitar ingresso em grupo
            document.getElementById('join-group-btn')?.addEventListener('click', function() {
                if (currentUser.level === 'observador') {
                    showToast("Observadores não podem ingressar em grupos. Torne-se um Iniciado primeiro.", "warning");
                } else {
                    showToast("Solicitação enviada aos líderes dos grupos", "info");
                }
            });
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) {
                showToast("Digite uma mensagem", "warning");
                return;
            }
            
            addChatMessageToGroup(currentChatGroup, {
                message: message
            });
            
            input.value = '';
            renderChatMessages(currentChatGroup);
            
            // Atualizar preview LaTeX
            updateLatexPreview();
        }

        function sendPrivateMessage() {
            if (!currentPrivateChat) {
                showToast("Selecione uma conversa primeiro", "warning");
                return;
            }
            
            const input = document.getElementById('private-chat-input');
            const message = input.value.trim();
            
            if (!message) {
                showToast("Digite uma mensagem", "warning");
                return;
            }
            
            addPrivateMessage(currentPrivateChat, {
                message: message
            });
            
            input.value = '';
            renderPrivateChat();
        }

        function updateLatexPreview() {
            const preview = document.getElementById('latex-preview');
            const textarea = document.getElementById('chat-input');
            
            if (textarea.value.includes('$')) {
                preview.innerHTML = renderLatexInText(textarea.value);
                preview.classList.add('active');
                
                // Reconfigurar MathJax
                if (window.MathJax) {
                    MathJax.typesetPromise([preview]).catch(err => console.log('MathJax error:', err));
                }
            } else {
                preview.innerHTML = '';
                preview.classList.remove('active');
            }
        }

        // =============================================
        // INICIALIZAÇÃO DA APLICAÇÃO
        // =============================================

        function initializeApp() {
            // Configurar Toastr
            toastr.options = {
                positionClass: "toast-top-right",
                progressBar: true,
                closeButton: true,
                timeOut: 3000
            };
            
            // Inicializar armazenamento
            initializeStorage();
            
            // Configurar event listeners
            initializeEventListeners();
            
            // Verificar se há usuário logado
            if (currentUser) {
                // Usuário já logado
                document.getElementById('login-page').style.display = 'none';
                document.getElementById('main-site').style.display = 'flex';
                updateUserInterface();
                renderDashboard();
                switchSection('dashboard');
            } else {
                // Mostrar tela de login
                document.getElementById('login-page').style.display = 'flex';
                document.getElementById('main-site').style.display = 'none';
            }
            
            // Configurar MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
            
            // Atualizar status periodicamente
            setInterval(() => {
                if (currentUser) {
                    updateUserStatus('online');
                    renderSidebarContacts(); // Atualizar status dos contatos
                    
                    // Se estiver na seção de chat, atualizar
                    if (document.getElementById('chat').classList.contains('active')) {
                        renderChat();
                    }
                    if (document.getElementById('private-chat').classList.contains('active')) {
                        renderPrivateChat();
                    }
                }
            }, 30000); // A cada 30 segundos
            
            // Mostrar mensagem de boas-vindas
            console.log(`
            =============================================
            ALGEBRA RENOVA - SISTEMA INICIALIZADO
            =============================================
            Sistema de gerenciamento de comunidade matemática
            
            Dados de demonstração:
            - Usuário fundador: Lohan Cunha (Núcleo)
            - Senha padrão: admin123
            - Chave do Núcleo: algebra_renova_nucleo_2024
            
            Para testar diferentes níveis:
            - Observador: qualquer usuário/senha
            - Iniciado: qualquer usuário/senha
            - Núcleo: precisa da chave correta
            =============================================
            `);
        }

        // Iniciar aplicação quando o DOM estiver carregado
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
            
