<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Renova - Revolução Matemática</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;600;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Toastr -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <style>
        /* ===== VARIÁVEIS DE CORES ===== */
        :root {
            /* Cores base por nível */
            --nucleo-primary: #8B4513;
            --nucleo-secondary: #DAA520;
            --nucleo-accent: #FFD700;
            
            --iniciado-primary: #1E3A8A;
            --iniciado-secondary: #3B82F6;
            --iniciado-accent: #60A5FA;
            
            --observador-primary: #374151;
            --observador-secondary: #6B7280;
            --observador-accent: #9CA3AF;
            
            /* Cores gerais */
            --bg-dark: #0A0A0F;
            --bg-card: #121218;
            --bg-input: #1A1A24;
            --border-color: #2D2D3A;
            --text-primary: #F8F9FA;
            --text-secondary: #ADB5BD;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        /* ===== RESET E ESTILOS GERAIS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', monospace;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* ===== UTILITÁRIOS ===== */
        .hidden {
            display: none !important;
        }
        
        /* ===== LAYOUT PRINCIPAL ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--nucleo-accent);
            margin-bottom: 5px;
        }
        
        .logo .subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Informações do usuário */
        .user-info {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
        }
        
        .user-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .user-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Navegação */
        .nav-section {
            padding: 15px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 10px;
        }
        
        .nav-item {
            list-style: none;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .nav-link:hover {
            background-color: var(--bg-input);
            color: var(--text-primary);
        }
        
        .nav-link.active {
            background-color: var(--bg-input);
            color: var(--text-primary);
            border-left: 3px solid;
        }
        
        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* ===== CONTEÚDO PRINCIPAL ===== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .page-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--text-primary);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* ===== FORMULÁRIOS ===== */
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--bg-card);
            border-radius: 10px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Source Code Pro', monospace;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--nucleo-accent);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            font-family: 'Source Code Pro', monospace;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-primary {
            background-color: var(--nucleo-accent);
            color: #000;
        }
        
        .btn-primary:hover {
            background-color: var(--nucleo-secondary);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* ===== LOGIN PAGE ===== */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
        }
        
        .login-box {
            width: 100%;
            max-width: 500px;
            background-color: var(--bg-card);
            border-radius: 15px;
            padding: 40px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--nucleo-accent);
            margin-bottom: 10px;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* ===== CARTÕES ===== */
        .card {
            background-color: var(--bg-card);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* ===== MODAIS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-content {
            background-color: var(--bg-card);
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 25px 30px;
        }
        
        /* ===== CHAT ===== */
        .chat-container {
            display: flex;
            height: 70vh;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .chat-sidebar {
            width: 250px;
            background-color: var(--bg-input);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px 20px;
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 70%;
        }
        
        .message-sent {
            background-color: rgba(139, 69, 19, 0.3);
            margin-left: auto;
            border: 1px solid rgba(139, 69, 19, 0.5);
        }
        
        .message-received {
            background-color: var(--bg-input);
            margin-right: auto;
            border: 1px solid var(--border-color);
        }
        
        .message-sender {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .message-content {
            line-height: 1.5;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
        }
        
        .chat-input-area {
            padding: 15px;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
        }
        
        .chat-input {
            width: 100%;
            min-height: 60px;
            padding: 12px 15px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Source Code Pro', monospace;
            resize: none;
        }
        
        /* ===== LISTAS ===== */
        .list {
            display: grid;
            gap: 20px;
        }
        
        .list-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .list-item:hover {
            border-color: var(--nucleo-accent);
            transform: translateY(-2px);
        }
        
        .list-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .list-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .list-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-nucleo {
            background-color: rgba(139, 69, 19, 0.2);
            color: var(--nucleo-accent);
            border: 1px solid var(--nucleo-accent);
        }
        
        .badge-iniciado {
            background-color: rgba(30, 58, 138, 0.2);
            color: var(--iniciado-accent);
            border: 1px solid var(--iniciado-accent);
        }
        
        .badge-observador {
            background-color: rgba(55, 65, 81, 0.2);
            color: var(--observador-accent);
            border: 1px solid var(--observador-accent);
        }
        
        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }
            
            .logo h1, .user-name, .nav-text, .nav-section {
                display: none;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .nav-link {
                justify-content: center;
                padding: 15px;
            }
            
            .nav-link i {
                margin-right: 0;
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .chat-container {
                flex-direction: column;
                height: 80vh;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }
    </style>
</head>
<body>
    <!-- PÁGINA DE LOGIN -->
    <div id="login-page" class="login-page">
        <div class="login-box">
            <div class="login-logo">
                <h1>ALGEBRA RENOVA</h1>
                <p class="subtitle">Revolution. Algebra et Perseverantia.</p>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label" for="login-name">Nome Simbólico *</label>
                    <input type="text" class="form-control" id="login-name" placeholder="Seu nome dentro da organização" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-specialty">Especialidade Matemática *</label>
                    <input type="text" class="form-control" id="login-specialty" placeholder="Ex: Álgebra Abstrata, Teoria das Categorias..." required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-bio">Biografia (opcional)</label>
                    <textarea class="form-control" id="login-bio" placeholder="Conte sobre sua jornada matemática..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-password">Senha de Iniciação *</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Escolha uma senha segura" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-level">Nível de Acesso *</label>
                    <select class="form-control" id="login-level" required>
                        <option value="">Selecione seu nível</option>
                        <option value="observador">Observador</option>
                        <option value="iniciado">Iniciado</option>
                    </select>
                </div>
                
                <div class="form-group hidden" id="nucleo-key-group">
                    <label class="form-label" for="nucleo-key">Chave Secreta do Núcleo</label>
                    <input type="password" class="form-control" id="nucleo-key" placeholder="Digite a chave secreta...">
                    <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                        O nível Núcleo não aparece na lista. Apenas membros com a chave correta podem acessar.
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-door-open"></i> Acessar o Portal
                </button>
            </form>
            
            <div class="login-footer">
                <p>"A matemática é a linguagem com a qual Deus escreveu o universo." - Galileo Galilei</p>
            </div>
        </div>
    </div>

    <!-- APLICAÇÃO PRINCIPAL -->
    <div id="app" class="app-container hidden">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <h1>AR</h1>
                <p class="subtitle">Algebra Renova</p>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">
                    <!-- Avatar será gerado dinamicamente -->
                </div>
                <div class="user-name" id="user-display-name">Carregando...</div>
                <div class="user-level" id="user-level-badge">Nível</div>
            </div>
            
            <div class="nav-section">Navegação</div>
            <ul>
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <i class="fas fa-chart-bar"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="theories">
                        <i class="fas fa-atom"></i>
                        <span class="nav-text">Teorias</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="research-groups">
                        <i class="fas fa-users"></i>
                        <span class="nav-text">Grupos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="forum">
                        <i class="fas fa-comments"></i>
                        <span class="nav-text">Fórum</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="chat">
                        <i class="fas fa-comment-dots"></i>
                        <span class="nav-text">Chat Geral</span>
                    </a>
                </li>
            </ul>
            
            <div class="nav-section">Rede Social</div>
            <ul>
                <li class="nav-item">
                    <a class="nav-link" data-page="contacts">
                        <i class="fas fa-address-book"></i>
                        <span class="nav-text">Contatos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="private-chat">
                        <i class="fas fa-user-friends"></i>
                        <span class="nav-text">Chat Privado</span>
                        <span class="badge" id="unread-dm-count">0</span>
                    </a>
                </li>
            </ul>
            
            <div class="nav-section">Administração</div>
            <ul>
                <li class="nav-item">
                    <a class="nav-link" data-page="profile">
                        <i class="fas fa-user-cog"></i>
                        <span class="nav-text">Perfil</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="members">
                        <i class="fas fa-users-cog"></i>
                        <span class="nav-text">Membros</span>
                    </a>
                </li>
                <li class="nav-item" id="nucleo-admin-item" style="display: none;">
                    <a class="nav-link" data-page="nucleo-admin">
                        <i class="fas fa-crown"></i>
                        <span class="nav-text">Núcleo</span>
                    </a>
                </li>
            </ul>
            
            <div style="padding: 20px; margin-top: 20px; border-top: 1px solid var(--border-color);">
                <button id="logout-btn" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <!-- CONTEÚDO PRINCIPAL -->
        <main class="main-content">
            <header class="header">
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <input type="text" id="global-search" placeholder="Buscar teorias, membros..." 
                               style="padding: 8px 15px; background: var(--bg-input); border: 1px solid var(--border-color); 
                                      border-radius: 20px; color: var(--text-primary); width: 200px;">
                    </div>
                    <button id="notifications-btn" class="btn btn-secondary btn-small">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count">0</span>
                    </button>
                </div>
            </header>

            <!-- PÁGINAS DINÂMICAS -->
            <div id="pages-container">
                <!-- Dashboard -->
                <div id="dashboard-page" class="page">
                    <div class="stats-grid">
                        <!-- As estatísticas serão geradas dinamicamente -->
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Atividade Recente</h3>
                        </div>
                        <div id="recent-activity">
                            <!-- Atividades serão carregadas aqui -->
                        </div>
                    </div>
                </div>

                <!-- Teorias -->
                <div id="theories-page" class="page hidden">
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2>Teorias Matemáticas</h2>
                        <button id="new-theory-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nova Teoria
                        </button>
                    </div>
                    <div id="theories-list" class="list">
                        <!-- Teorias serão carregadas aqui -->
                    </div>
                </div>

                <!-- Chat Geral -->
                <div id="chat-page" class="page hidden">
                    <div class="chat-container">
                        <div class="chat-sidebar" id="chat-channels">
                            <!-- Canais serão carregados aqui -->
                        </div>
                        <div class="chat-main">
                            <div class="chat-header">
                                <span id="current-channel">Geral</span>
                                <span id="online-count" style="font-size: 0.9rem; color: var(--text-secondary);">Online: 0</span>
                            </div>
                            <div class="chat-messages" id="chat-messages">
                                <!-- Mensagens serão carregadas aqui -->
                            </div>
                            <div class="chat-input-area">
                                <textarea id="chat-input" class="chat-input" placeholder="Digite sua mensagem... Use LaTeX: $E = mc^2$"></textarea>
                                <button id="send-chat-btn" class="btn btn-primary" style="margin-top: 10px; float: right;">
                                    <i class="fas fa-paper-plane"></i> Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Outras páginas terão conteúdo semelhante -->
            </div>
        </main>
    </div>

    <!-- MODAIS (serão mostrados/ocultados dinamicamente) -->
    <div id="modal-container"></div>

    <script>
        // =============================================
        // CONSTANTES E CONFIGURAÇÕES
        // =============================================
        const NUCLEO_SECRET = "Renova, O Non Trad";
        const STORAGE_KEYS = {
            CURRENT_USER: 'algebra_renova_current_user',
            USERS: 'algebra_renova_users',
            THEORIES: 'algebra_renova_theories',
            FORUM_POSTS: 'algebra_renova_forum_posts',
            RESEARCH_GROUPS: 'algebra_renova_research_groups',
            CHAT_MESSAGES: 'algebra_renova_chat_messages',
            PRIVATE_MESSAGES: 'algebra_renova_private_messages',
            CONTACTS: 'algebra_renova_contacts',
            NOTIFICATIONS: 'algebra_renova_notifications'
        };

        // =============================================
        // ESTADO GLOBAL DA APLICAÇÃO
        // =============================================
        let currentUser = null;
        let appState = {
            users: [],
            theories: [],
            forumPosts: [],
            researchGroups: [],
            chatMessages: {},
            privateMessages: {},
            contacts: [],
            notifications: [],
            currentPage: 'dashboard'
        };

        // =============================================
        // FUNÇÕES DE UTILIDADE
        // =============================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            const now = new Date();
            const diffMs = now - date;
            const diffMins = Math.floor(diffMs / 60000);
            
            if (diffMins < 1) return "Agora mesmo";
            if (diffMins < 60) return `${diffMins} min atrás`;
            if (diffMins < 1440) return `${Math.floor(diffMins/60)} h atrás`;
            
            return date.toLocaleDateString('pt-BR');
        }

        function showToast(message, type = 'success') {
            toastr.options = {
                positionClass: "toast-top-right",
                progressBar: true,
                closeButton: true,
                timeOut: 3000
            };
            
            switch(type) {
                case 'success': toastr.success(message); break;
                case 'error': toastr.error(message); break;
                case 'warning': toastr.warning(message); break;
                case 'info': toastr.info(message); break;
            }
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
            } catch (error) {
                console.error(`Erro ao salvar em ${key}:`, error);
                showToast('Erro ao salvar dados', 'error');
            }
        }

        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error(`Erro ao carregar de ${key}:`, error);
                return null;
            }
        }

        function initializeStorage() {
            // Inicializar dados se não existirem
            Object.values(STORAGE_KEYS).forEach(key => {
                if (!localStorage.getItem(key)) {
                    let defaultValue = [];
                    
                    if (key === STORAGE_KEYS.USERS) {
                        // Criar usuário fundador
                        defaultValue = [{
                            id: 'founder',
                            name: 'Lohan Cunha',
                            specialty: 'Álgebra Abstrata, Teoria das Categorias',
                            bio: 'Fundador do Algebra Renova. Acredito na matemática como revolução intelectual.',
                            level: 'nucleo',
                            password: 'admin123',
                            joinDate: new Date().toISOString(),
                            lastSeen: new Date().toISOString(),
                            status: 'online',
                            color: 'nucleo'
                        }];
                    } else if (key === STORAGE_KEYS.CHAT_MESSAGES || key === STORAGE_KEYS.PRIVATE_MESSAGES) {
                        defaultValue = {};
                    }
                    
                    saveToStorage(key, defaultValue);
                }
            });
        }

        // =============================================
        // FUNÇÕES DE AUTENTICAÇÃO
        // =============================================
        function handleLogin(event) {
            event.preventDefault();
            
            const name = document.getElementById('login-name').value.trim();
            const specialty = document.getElementById('login-specialty').value.trim();
            const bio = document.getElementById('login-bio').value.trim();
            const password = document.getElementById('login-password').value;
            const levelSelect = document.getElementById('login-level').value;
            const nucleoKey = document.getElementById('nucleo-key')?.value;
            
            // Validações básicas
            if (!name || !specialty || !password || !levelSelect) {
                showToast('Preencha todos os campos obrigatórios', 'error');
                return;
            }
            
            let level = levelSelect;
            
            // Verificar se está tentando acessar como Núcleo
            if (nucleoKey) {
                if (nucleoKey === NUCLEO_SECRET) {
                    level = 'nucleo';
                } else {
                    showToast('Chave do Núcleo incorreta', 'error');
                    return;
                }
            }
            
            // Carregar usuários existentes
            const existingUsers = loadFromStorage(STORAGE_KEYS.USERS) || [];
            
            // Verificar se usuário já existe
            const existingUser = existingUsers.find(u => u.name.toLowerCase() === name.toLowerCase());
            
            if (existingUser) {
                // Verificar senha
                if (existingUser.password !== password) {
                    showToast('Senha incorreta', 'error');
                    return;
                }
                
                // Atualizar informações
                existingUser.specialty = specialty;
                existingUser.bio = bio;
                existingUser.lastSeen = new Date().toISOString();
                existingUser.status = 'online';
                
                currentUser = existingUser;
            } else {
                // Criar novo usuário
                const newUser = {
                    id: generateId(),
                    name,
                    specialty,
                    bio,
                    level,
                    password,
                    joinDate: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    status: 'online',
                    color: level // Será usado para estilização
                };
                
                existingUsers.push(newUser);
                currentUser = newUser;
            }
            
            // Salvar usuários atualizados
            saveToStorage(STORAGE_KEYS.USERS, existingUsers);
            saveToStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
            
            // Adicionar contato automático com o fundador
            if (!existingUser) {
                setTimeout(() => {
                    const founder = existingUsers.find(u => u.id === 'founder');
                    if (founder) {
                        addContact(founder.id);
                        
                        // Enviar mensagem de boas-vindas
                        const conversationId = getConversationId(currentUser.id, founder.id);
                        sendPrivateMessage(conversationId, 
                            `Bem-vindo ao Algebra Renova, ${currentUser.name}! Eu sou Lohan Cunha, fundador da organização. Fique à vontade para explorar as teorias e participar das discussões.`,
                            'system'
                        );
                    }
                }, 1000);
            }
            
            showToast(`Bem-vindo, ${name}!`, 'success');
            renderApp();
        }

        function handleLogout() {
            if (currentUser) {
                // Atualizar status
                currentUser.status = 'offline';
                currentUser.lastSeen = new Date().toISOString();
                
                // Atualizar no storage
                const users = loadFromStorage(STORAGE_KEYS.USERS) || [];
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex] = currentUser;
                    saveToStorage(STORAGE_KEYS.USERS, users);
                }
            }
            
            // Limpar usuário atual
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            
            // Mostrar página de login
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            
            showToast('Até logo!', 'info');
        }

        // =============================================
        // FUNÇÕES DE RENDERIZAÇÃO PRINCIPAL
        // =============================================
        function renderApp() {
            if (!currentUser) {
                // Verificar se há usuário salvo
                const savedUser = loadFromStorage(STORAGE_KEYS.CURRENT_USER);
                if (savedUser) {
                    currentUser = savedUser;
                } else {
                    // Mostrar página de login
                    document.getElementById('login-page').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                    return;
                }
            }
            
            // Esconder página de login, mostrar app
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Atualizar informações do usuário na sidebar
            updateUserInfo();
            
            // Carregar dados do storage
            loadAppData();
            
            // Renderizar página atual
            renderCurrentPage();
            
            // Configurar MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            // Nome
            document.getElementById('user-display-name').textContent = currentUser.name;
            
            // Avatar (iniciais)
            const avatar = document.getElementById('user-avatar');
            const initials = currentUser.name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
            avatar.textContent = initials;
            
            // Aplicar cores baseadas no nível
            let bgColor, textColor, badgeClass;
            
            switch(currentUser.level) {
                case 'nucleo':
                    bgColor = 'var(--nucleo-primary)';
                    textColor = 'var(--nucleo-accent)';
                    badgeClass = 'badge-nucleo';
                    break;
                case 'iniciado':
                    bgColor = 'var(--iniciado-primary)';
                    textColor = 'var(--iniciado-accent)';
                    badgeClass = 'badge-iniciado';
                    break;
                default: // observador
                    bgColor = 'var(--observador-primary)';
                    textColor = 'var(--observador-accent)';
                    badgeClass = 'badge-observador';
            }
            
            avatar.style.backgroundColor = bgColor;
            avatar.style.color = textColor;
            
            // Badge de nível
            const badge = document.getElementById('user-level-badge');
            badge.textContent = currentUser.level.toUpperCase();
            badge.className = `user-level ${badgeClass}`;
            
            // Mostrar/ocultar item do Núcleo na sidebar
            const nucleoItem = document.getElementById('nucleo-admin-item');
            nucleoItem.style.display = currentUser.level === 'nucleo' ? 'block' : 'none';
        }

        function loadAppData() {
            // Carregar todos os dados do localStorage
            appState.users = loadFromStorage(STORAGE_KEYS.USERS) || [];
            appState.theories = loadFromStorage(STORAGE_KEYS.THEORIES) || [];
            appState.forumPosts = loadFromStorage(STORAGE_KEYS.FORUM_POSTS) || [];
            appState.researchGroups = loadFromStorage(STORAGE_KEYS.RESEARCH_GROUPS) || [];
            appState.chatMessages = loadFromStorage(STORAGE_KEYS.CHAT_MESSAGES) || {};
            appState.privateMessages = loadFromStorage(STORAGE_KEYS.PRIVATE_MESSAGES) || {};
            appState.contacts = loadFromStorage(STORAGE_KEYS.CONTACTS) || [];
            appState.notifications = loadFromStorage(STORAGE_KEYS.NOTIFICATIONS) || [];
            
            // Inicializar chat se não existir
            if (!appState.chatMessages.general) {
                appState.chatMessages.general = [{
                    id: generateId(),
                    sender: 'Sistema',
                    senderId: 'system',
                    message: 'Bem-vindo ao chat geral do Algebra Renova! Discuta ideias, teorias e conjecturas.',
                    timestamp: new Date().toISOString(),
                    type: 'system'
                }];
                saveToStorage(STORAGE_KEYS.CHAT_MESSAGES, appState.chatMessages);
            }
        }

        function renderCurrentPage() {
            const pages = document.querySelectorAll('.page');
            pages.forEach(page => page.classList.add('hidden'));
            
            const currentPageElement = document.getElementById(`${appState.currentPage}-page`);
            if (currentPageElement) {
                currentPageElement.classList.remove('hidden');
                
                // Atualizar título da página
                const pageTitle = document.getElementById('page-title');
                const pageTitles = {
                    'dashboard': 'Dashboard',
                    'theories': 'Teorias',
                    'research-groups': 'Grupos de Pesquisa',
                    'forum': 'Fórum de Desafios',
                    'chat': 'Chat Geral',
                    'contacts': 'Contatos',
                    'private-chat': 'Chat Privado',
                    'profile': 'Meu Perfil',
                    'members': 'Membros',
                    'nucleo-admin': 'Administração do Núcleo'
                };
                
                pageTitle.textContent = pageTitles[appState.currentPage] || appState.currentPage;
                
                // Renderizar conteúdo específico da página
                switch(appState.currentPage) {
                    case 'dashboard':
                        renderDashboard();
                        break;
                    case 'theories':
                        renderTheories();
                        break;
                    case 'chat':
                        renderChat();
                        break;
                    case 'contacts':
                        renderContacts();
                        break;
                    case 'private-chat':
                        renderPrivateChat();
                        break;
                    case 'profile':
                        renderProfile();
                        break;
                    case 'members':
                        renderMembers();
                        break;
                }
            }
            
            // Atualizar navegação ativa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === appState.currentPage) {
                    link.classList.add('active');
                }
            });
        }

        // =============================================
        // RENDERIZAÇÃO DE PÁGINAS ESPECÍFICAS
        // =============================================
        function renderDashboard() {
            const statsGrid = document.querySelector('.stats-grid');
            if (!statsGrid) return;
            
            // Estatísticas REAIS
            const totalMembers = appState.users.length;
            const totalTheories = appState.theories.length;
            const totalForumPosts = appState.forumPosts.length;
            const totalGroups = appState.researchGroups.length;
            const onlineUsers = appState.users.filter(u => u.status === 'online').length;
            const userTheories = appState.theories.filter(t => t.authorId === currentUser.id).length;
            
            statsGrid.innerHTML = `
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Membros</h3>
                        <i class="fas fa-users" style="color: var(--text-secondary);"></i>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3rem; font-weight: bold; color: var(--nucleo-accent);">${totalMembers}</div>
                        <div style="color: var(--text-secondary);">${onlineUsers} online</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Teorias</h3>
                        <i class="fas fa-atom" style="color: var(--text-secondary);"></i>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3rem; font-weight: bold; color: var(--iniciado-accent);">${totalTheories}</div>
                        <div style="color: var(--text-secondary);">${userTheories} suas</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Discussões</h3>
                        <i class="fas fa-comments" style="color: var(--text-secondary);"></i>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3rem; font-weight: bold; color: var(--observador-accent);">${totalForumPosts}</div>
                        <div style="color: var(--text-secondary);">no fórum</div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h3 class="card-title">Grupos</h3>
                        <i class="fas fa-users-cog" style="color: var(--text-secondary);"></i>
                    </div>
                    <div style="text-align: center; padding: 20px;">
                        <div style="font-size: 3rem; font-weight: bold; color: var(--nucleo-secondary);">${totalGroups}</div>
                        <div style="color: var(--text-secondary);">ativos</div>
                    </div>
                </div>
            `;
            
            // Atividade recente
            const recentActivity = document.getElementById('recent-activity');
            if (recentActivity) {
                // Combinar atividades de diferentes fontes
                const activities = [];
                
                // Adicionar teorias recentes
                appState.theories.slice(-5).forEach(theory => {
                    activities.push({
                        type: 'theory',
                        user: theory.author,
                        content: theory.title,
                        time: theory.createdAt,
                        icon: 'atom'
                    });
                });
                
                // Adicionar posts recentes do fórum
                appState.forumPosts.slice(-5).forEach(post => {
                    activities.push({
                        type: 'forum',
                        user: post.author,
                        content: post.title,
                        time: post.createdAt,
                        icon: 'comments'
                    });
                });
                
                // Ordenar por data
                activities.sort((a, b) => new Date(b.time) - new Date(a.time));
                
                // Pegar as 5 mais recentes
                const recent = activities.slice(0, 5);
                
                if (recent.length === 0) {
                    recentActivity.innerHTML = `
                        <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                            <i class="fas fa-history" style="font-size: 2rem; opacity: 0.5;"></i>
                            <p style="margin-top: 15px;">Nenhuma atividade recente</p>
                        </div>
                    `;
                } else {
                    recentActivity.innerHTML = recent.map(activity => `
                        <div style="display: flex; align-items: center; padding: 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: var(--bg-input); 
                                      display: flex; align-items: center; justify-content: center; margin-right: 15px;">
                                <i class="fas fa-${activity.icon}" style="color: var(--text-secondary);"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${activity.user}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">${activity.content}</div>
                            </div>
                            <div style="color: var(--text-secondary); font-size: 0.8rem;">${formatDate(activity.time)}</div>
                        </div>
                    `).join('');
                }
            }
        }

        function renderTheories() {
            const theoriesList = document.getElementById('theories-list');
            if (!theoriesList) return;
            
            // Filtrar teorias baseado no nível do usuário
            let filteredTheories = appState.theories;
            if (currentUser.level !== 'nucleo') {
                filteredTheories = appState.theories.filter(t => 
                    t.visibility !== 'nucleo' && (t.visibility !== 'private' || t.authorId === currentUser.id)
                );
            }
            
            if (filteredTheories.length === 0) {
                theoriesList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-atom" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhuma Teoria</h3>
                        <p>Seja o primeiro a propor uma teoria revolucionária!</p>
                        <button id="create-first-theory" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Criar Primeira Teoria
                        </button>
                    </div>
                `;
            } else {
                theoriesList.innerHTML = filteredTheories.map(theory => {
                    const author = appState.users.find(u => u.id === theory.authorId);
                    const isOwner = theory.authorId === currentUser.id;
                    
                    return `
                        <div class="list-item" data-theory-id="${theory.id}">
                            <div class="list-header" style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <h3 class="list-title">${theory.title}</h3>
                                <div class="badge ${theory.visibility === 'public' ? 'badge-iniciado' : 
                                                    theory.visibility === 'private' ? 'badge-observador' : 'badge-nucleo'}">
                                    ${theory.visibility === 'public' ? 'Pública' : 
                                     theory.visibility === 'private' ? 'Privada' : 'Núcleo'}
                                </div>
                            </div>
                            <div class="list-description">${theory.description}</div>
                            <div class="list-meta">
                                <span>
                                    <i class="fas fa-user"></i> ${author?.name || 'Autor desconhecido'}
                                    ${author?.level === 'nucleo' ? ' 👑' : ''}
                                </span>
                                <span><i class="fas fa-calendar"></i> ${formatDate(theory.createdAt)}</span>
                                ${isOwner ? '<span><i class="fas fa-edit"></i> Editar</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderChat() {
            // Renderizar canais
            const chatChannels = document.getElementById('chat-channels');
            if (chatChannels) {
                const channels = [
                    { id: 'general', name: 'Geral', icon: 'globe', description: 'Discussões gerais' },
                    { id: 'theories', name: 'Teorias', icon: 'atom', description: 'Debates sobre teorias' },
                    { id: 'challenges', name: 'Desafios', icon: 'puzzle-piece', description: 'Problemas matemáticos' }
                ];
                
                // Adicionar canais de grupos de pesquisa
                appState.researchGroups.forEach(group => {
                    if (group.members.includes(currentUser.id) || currentUser.level === 'nucleo') {
                        channels.push({
                            id: `group-${group.id}`,
                            name: group.name,
                            icon: 'users',
                            description: group.description.substring(0, 30) + '...'
                        });
                    }
                });
                
                chatChannels.innerHTML = channels.map(channel => `
                    <div class="channel-item" data-channel="${channel.id}" 
                         style="padding: 10px; margin-bottom: 10px; border-radius: 8px; cursor: pointer;
                                display: flex; align-items: center; gap: 10px;">
                        <i class="fas fa-${channel.icon}" style="color: var(--text-secondary);"></i>
                        <div style="flex: 1;">
                            <div style="font-weight: 600;">${channel.name}</div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary);">${channel.description}</div>
                        </div>
                    </div>
                `).join('');
            }
            
            // Renderizar mensagens do canal atual
            renderChatMessages('general');
            
            // Atualizar contagem online
            const onlineCount = appState.users.filter(u => u.status === 'online').length;
            document.getElementById('online-count').textContent = `Online: ${onlineCount}`;
        }

        function renderChatMessages(channelId = 'general') {
            const chatMessagesDiv = document.getElementById('chat-messages');
            if (!chatMessagesDiv) return;
            
            const messages = appState.chatMessages[channelId] || [];
            const currentChannel = document.getElementById('current-channel');
            
            // Definir nome do canal
            const channelNames = {
                'general': 'Geral',
                'theories': 'Teorias',
                'challenges': 'Desafios'
            };
            
            currentChannel.textContent = channelNames[channelId] || channelId.replace('group-', '');
            
            if (messages.length === 0) {
                chatMessagesDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhuma Mensagem</h3>
                        <p>Seja o primeiro a enviar uma mensagem neste canal!</p>
                    </div>
                `;
            } else {
                chatMessagesDiv.innerHTML = messages.map(msg => {
                    const isOwn = msg.senderId === currentUser.id;
                    const sender = appState.users.find(u => u.id === msg.senderId);
                    
                    return `
                        <div class="message ${isOwn ? 'message-sent' : 'message-received'}">
                            <div class="message-sender">
                                ${sender?.name || 'Sistema'}
                                ${sender?.level === 'nucleo' ? ' 👑' : ''}
                            </div>
                            <div class="message-content">${msg.message}</div>
                            <div class="message-time">${formatDate(msg.timestamp)}</div>
                        </div>
                    `;
                }).join('');
                
                // Scroll para o final
                chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
            }
            
            // Re-processar MathJax
            if (window.MathJax) {
                MathJax.typesetPromise([chatMessagesDiv]);
            }
        }

        // =============================================
        // FUNÇÕES DE DADOS (CONTATOS, MENSAGENS, ETC)
        // =============================================
        function getConversationId(userId1, userId2) {
            const ids = [userId1, userId2].sort();
            return `dm_${ids[0]}_${ids[1]}`;
        }

        function addContact(contactUserId) {
            if (contactUserId === currentUser.id) return;
            
            const existingContact = appState.contacts.find(c => 
                (c.userId1 === currentUser.id && c.userId2 === contactUserId) ||
                (c.userId2 === currentUser.id && c.userId1 === contactUserId)
            );
            
            if (!existingContact) {
                const newContact = {
                    id: generateId(),
                    userId1: currentUser.id,
                    userId2: contactUserId,
                    createdAt: new Date().toISOString()
                };
                
                appState.contacts.push(newContact);
                saveToStorage(STORAGE_KEYS.CONTACTS, appState.contacts);
                showToast('Contato adicionado!', 'success');
            }
        }

        function sendChatMessage(channelId, message) {
            if (!message.trim()) return;
            
            const newMessage = {
                id: generateId(),
                sender: currentUser.name,
                senderId: currentUser.id,
                message: message,
                timestamp: new Date().toISOString(),
                type: 'user'
            };
            
            if (!appState.chatMessages[channelId]) {
                appState.chatMessages[channelId] = [];
            }
            
            appState.chatMessages[channelId].push(newMessage);
            saveToStorage(STORAGE_KEYS.CHAT_MESSAGES, appState.chatMessages);
            
            // Renderizar mensagens atualizadas
            renderChatMessages(channelId);
        }

        function sendPrivateMessage(conversationId, message, senderType = 'user') {
            const newMessage = {
                id: generateId(),
                sender: senderType === 'system' ? 'Sistema' : currentUser.name,
                senderId: senderType === 'system' ? 'system' : currentUser.id,
                message: message,
                timestamp: new Date().toISOString(),
                type: senderType,
                read: false
            };
            
            if (!appState.privateMessages[conversationId]) {
                appState.privateMessages[conversationId] = [];
            }
            
            appState.privateMessages[conversationId].push(newMessage);
            saveToStorage(STORAGE_KEYS.PRIVATE_MESSAGES, appState.privateMessages);
        }

        // =============================================
        // INICIALIZAÇÃO DA APLICAÇÃO
        // =============================================
        function initializeApp() {
            // Inicializar storage
            initializeStorage();
            
            // Configurar listeners da página de login
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', handleLogin);
            }
            
            const loginLevelSelect = document.getElementById('login-level');
            const nucleoKeyGroup = document.getElementById('nucleo-key-group');
            
            if (loginLevelSelect && nucleoKeyGroup) {
                loginLevelSelect.addEventListener('change', function() {
                    // Campo da chave do Núcleo sempre visível
                    // (usuário pode tentar a chave mesmo selecionando outro nível)
                    nucleoKeyGroup.classList.remove('hidden');
                });
            }
            
            // Configurar logout
            const logoutBtn = document.getElementById('logout-btn');
            if (logoutBtn) {
                logoutBtn.addEventListener('click', handleLogout);
            }
            
            // Configurar navegação
            document.querySelectorAll('.nav-link[data-page]').forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    appState.currentPage = this.dataset.page;
                    renderCurrentPage();
                });
            });
            
            // Configurar botão de nova teoria
            document.addEventListener('click', function(e) {
                if (e.target.id === 'new-theory-btn' || e.target.id === 'create-first-theory') {
                    showNewTheoryModal();
                }
            });
            
            // Configurar chat
            document.addEventListener('click', function(e) {
                // Enviar mensagem no chat
                if (e.target.id === 'send-chat-btn' || (e.target.closest && e.target.closest('#send-chat-btn'))) {
                    const chatInput = document.getElementById('chat-input');
                    if (chatInput && chatInput.value.trim()) {
                        sendChatMessage('general', chatInput.value);
                        chatInput.value = '';
                    }
                }
                
                // Selecionar canal
                if (e.target.closest('.channel-item')) {
                    const channelItem = e.target.closest('.channel-item');
                    const channelId = channelItem.dataset.channel;
                    renderChatMessages(channelId);
                }
            });
            
            // Configurar submit no chat com Enter (sem Shift)
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        if (this.value.trim()) {
                            sendChatMessage('general', this.value);
                            this.value = '';
                        }
                    }
                });
            }
            
            // Inicializar renderização
            renderApp();
            
            // Atualizar status periodicamente
            setInterval(() => {
                if (currentUser) {
                    currentUser.lastSeen = new Date().toISOString();
                    saveToStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
                    
                    // Atualizar na lista de usuários
                    const users = appState.users;
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1) {
                        users[userIndex] = currentUser;
                        saveToStorage(STORAGE_KEYS.USERS, users);
                    }
                }
            }, 30000); // A cada 30 segundos
        }

        // =============================================
        // MODAIS
        // =============================================
        function showNewTheoryModal() {
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">Nova Teoria</h3>
                            <button class="modal-close">&times;</button>
                        </div>
                        <div class="modal-body">
                            <form id="new-theory-form">
                                <div class="form-group">
                                    <label class="form-label" for="theory-title">Título *</label>
                                    <input type="text" class="form-control" id="theory-title" 
                                           placeholder="Ex: Álgebra Transdimensional" required>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="theory-description">Descrição *</label>
                                    <textarea class="form-control" id="theory-description" 
                                              placeholder="Descreva sua teoria em termos gerais..." 
                                              rows="4" required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="theory-content">Conteúdo (LaTeX suportado) *</label>
                                    <textarea class="form-control" id="theory-content" 
                                              placeholder="Desenvolva sua teoria com detalhes. Use LaTeX: $$E = mc^2$$" 
                                              rows="8" required></textarea>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="theory-visibility">Visibilidade</label>
                                    <select class="form-control" id="theory-visibility">
                                        <option value="public">Pública (todos podem ver)</option>
                                        <option value="private">Privada (apenas você)</option>
                                        ${currentUser.level === 'nucleo' ? '<option value="nucleo">Núcleo (apenas membros do Núcleo)</option>' : ''}
                                    </select>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label" for="theory-tags">Tags (separadas por vírgula)</label>
                                    <input type="text" class="form-control" id="theory-tags" 
                                           placeholder="álgebra, transfunctoração, não-associativa">
                                </div>
                                
                                <div style="display: flex; gap: 15px; margin-top: 30px;">
                                    <button type="submit" class="btn btn-primary">Criar Teoria</button>
                                    <button type="button" class="btn btn-secondary modal-close">Cancelar</button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            `;
            
            // Inserir modal
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = modalHTML;
            
            // Configurar fechar modal
            modalContainer.querySelectorAll('.modal-close').forEach(btn => {
                btn.addEventListener('click', () => {
                    modalContainer.innerHTML = '';
                });
            });
            
            // Configurar submit do formulário
            const form = document.getElementById('new-theory-form');
            if (form) {
                form.addEventListener('submit', function(e) {
                    e.preventDefault();
                    
                    const newTheory = {
                        id: generateId(),
                        title: document.getElementById('theory-title').value,
                        description: document.getElementById('theory-description').value,
                        content: document.getElementById('theory-content').value,
                        visibility: document.getElementById('theory-visibility').value,
                        tags: document.getElementById('theory-tags').value.split(',').map(t => t.trim()).filter(t => t),
                        authorId: currentUser.id,
                        author: currentUser.name,
                        createdAt: new Date().toISOString(),
                        updatedAt: new Date().toISOString(),
                        status: 'active'
                    };
                    
                    appState.theories.push(newTheory);
                    saveToStorage(STORAGE_KEYS.THEORIES, appState.theories);
                    
                    showToast('Teoria criada com sucesso!', 'success');
                    modalContainer.innerHTML = '';
                    
                    // Se estiver na página de teorias, atualizar
                    if (appState.currentPage === 'theories') {
                        renderTheories();
                    }
                });
            }
        }

        // =============================================
        // INICIALIZAR APLICAÇÃO
        // =============================================
        document.addEventListener('DOMContentLoaded', initializeApp);
    </script>
</body>
</html>
