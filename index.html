<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Renova - Rede Científica</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- MathJax para LaTeX -->
  <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
  <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
  
  <!-- Ícones -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  
  <style>
    /* ===== RESET & BASE ===== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', system-ui, sans-serif;
    }

    :root {
      --bg-main: #0b0b10;
      --bg-panel: #111118;
      --bg-card: #1b1b2e;
      --bg-input: #0a0a15;
      --accent: #4a6fa5;
      --accent-hover: #5a80b5;
      --accent-secondary: #9b59b6;
      --text-main: #eaeaea;
      --text-soft: #a0a0a0;
      --border: #333;
      --border-light: #444;
      --success: #27ae60;
      --warning: #f39c12;
      --danger: #e74c3c;
      --info: #3498db;
      --online: #2ecc71;
      --away: #f1c40f;
      --offline: #95a5a6;
    }

    body {
      background: var(--bg-main);
      color: var(--text-main);
      min-height: 100vh;
    }

    .hidden { display: none !important; }

    /* ===== NOTIFICAÇÕES TOAST ===== */
    .toast-container {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .toast {
      padding: 15px 20px;
      background: var(--bg-card);
      border-left: 4px solid var(--accent);
      border-radius: 6px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      animation: slideIn 0.3s ease;
      max-width: 350px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .toast.success { border-left-color: var(--success); }
    .toast.error { border-left-color: var(--danger); }
    .toast.warning { border-left-color: var(--warning); }
    .toast.info { border-left-color: var(--info); }

    @keyframes slideIn {
      from { transform: translateX(100%); opacity: 0; }
      to { transform: translateX(0); opacity: 1; }
    }

    /* ===== LAYOUT CONTAINERS ===== */
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 20px;
    }

    /* ===== AUTH SCREEN ===== */
    .auth-container {
      width: 100%;
      max-width: 420px;
      padding: 40px;
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
    }

    .auth-container h1 {
      text-align: center;
      margin-bottom: 30px;
      color: var(--accent);
      font-size: 32px;
      font-weight: 300;
    }

    .auth-input {
      width: 100%;
      padding: 14px;
      margin-bottom: 15px;
      background: var(--bg-input);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 6px;
      font-size: 15px;
      transition: all 0.3s;
    }

    .auth-input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(74, 111, 165, 0.2);
    }

    .auth-button {
      width: 100%;
      padding: 14px;
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s;
      margin-bottom: 10px;
    }

    .auth-button:hover {
      transform: translateY(-1px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    }

    .auth-button.secondary {
      background: var(--bg-card);
      color: var(--text-main);
    }

    .auth-button.secondary:hover {
      background: #26264a;
    }

    .auth-info {
      text-align: center;
      font-size: 12px;
      color: var(--text-soft);
      margin-top: 20px;
      line-height: 1.5;
    }

    /* ===== DASHBOARD LAYOUT ===== */
    #dashboard {
      min-height: 100vh;
      display: grid;
      grid-template-columns: 280px 1fr;
    }

    /* SIDEBAR */
    #sidebar {
      background: var(--bg-panel);
      border-right: 1px solid var(--border);
      padding: 20px;
      display: flex;
      flex-direction: column;
      position: sticky;
      top: 0;
      height: 100vh;
      overflow-y: auto;
    }

    .sidebar-header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .sidebar-header h2 {
      color: var(--accent);
      font-size: 24px;
      font-weight: 300;
      margin-bottom: 5px;
    }

    .user-status {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 13px;
      color: var(--text-soft);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-online { background: var(--online); }
    .status-away { background: var(--away); }
    .status-offline { background: var(--offline); }

    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    /* Online Users */
    .online-users {
      margin: 15px 0;
      padding: 15px;
      background: var(--bg-card);
      border-radius: 8px;
    }

    .online-users h4 {
      font-size: 14px;
      color: var(--text-soft);
      margin-bottom: 10px;
    }

    .online-user-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .online-user {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 5px;
      border-radius: 4px;
      transition: background 0.3s;
      cursor: pointer;
    }

    .online-user:hover {
      background: rgba(255, 255, 255, 0.05);
    }

    .online-user-avatar {
      width: 32px;
      height: 32px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--online);
    }

    .online-user-name {
      font-size: 14px;
      flex: 1;
    }

    .sidebar-menu {
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
    }

    .menu-item {
      padding: 14px 16px;
      color: var(--text-main);
      text-decoration: none;
      border-radius: 8px;
      transition: all 0.3s;
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 12px;
      font-size: 15px;
    }

    .menu-item:hover {
      background: var(--bg-card);
      transform: translateX(5px);
    }

    .menu-item.active {
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      color: white;
      box-shadow: 0 4px 12px rgba(74, 111, 165, 0.3);
    }

    .menu-item i {
      width: 20px;
      text-align: center;
      font-size: 18px;
    }

    .notification-badge {
      background: var(--danger);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      margin-left: auto;
    }

    /* MAIN CONTENT */
    #mainContent {
      padding: 30px;
      overflow-y: auto;
      background: var(--bg-main);
    }

    .content-header {
      margin-bottom: 30px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .content-header h1 {
      font-size: 32px;
      margin-bottom: 10px;
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      font-weight: 300;
    }

    .content-header p {
      color: var(--text-soft);
      font-size: 16px;
    }

    /* ===== CHAT IMPROVEMENTS ===== */
    .message-reply {
      margin-left: 20px;
      padding-left: 10px;
      border-left: 3px solid var(--accent);
      font-size: 0.9em;
      opacity: 0.8;
      margin-bottom: 5px;
    }

    .message-actions {
      display: flex;
      gap: 10px;
      margin-top: 8px;
      font-size: 12px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .message:hover .message-actions {
      opacity: 1;
    }

    .message-action {
      background: none;
      border: none;
      color: var(--text-soft);
      cursor: pointer;
      padding: 2px 6px;
      border-radius: 4px;
      transition: all 0.3s;
    }

    .message-action:hover {
      background: rgba(255, 255, 255, 0.1);
      color: var(--accent);
    }

    .reply-preview {
      background: rgba(74, 111, 165, 0.1);
      border: 1px solid var(--accent);
      border-radius: 6px;
      padding: 8px;
      margin-bottom: 10px;
      font-size: 13px;
    }

    .reply-preview-header {
      display: flex;
      justify-content: space-between;
      margin-bottom: 5px;
    }

    .cancel-reply {
      background: none;
      border: none;
      color: var(--text-soft);
      cursor: pointer;
      font-size: 12px;
    }

    /* ===== FILE UPLOAD IN CHAT ===== */
    .file-upload-chat {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-top: 10px;
    }

    .file-preview {
      max-width: 200px;
      padding: 8px;
      background: var(--bg-card);
      border-radius: 6px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .file-preview img {
      max-width: 40px;
      max-height: 40px;
      border-radius: 4px;
    }

    .file-preview-info {
      flex: 1;
    }

    .file-preview-name {
      font-size: 12px;
      color: var(--text-main);
    }

    .file-preview-size {
      font-size: 10px;
      color: var(--text-soft);
    }

    .remove-file {
      background: none;
      border: none;
      color: var(--danger);
      cursor: pointer;
      font-size: 12px;
    }

    /* ===== LATEX EDITOR ===== */
    .latex-toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 5px;
      padding: 10px;
      background: var(--bg-panel);
      border-bottom: 1px solid var(--border);
    }

    .latex-btn {
      padding: 6px 10px;
      background: var(--bg-card);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 4px;
      cursor: pointer;
      font-size: 12px;
      transition: all 0.3s;
    }

    .latex-btn:hover {
      background: var(--accent);
      color: white;
    }

    .math-preview {
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 10px;
      margin: 10px 0;
      min-height: 50px;
      overflow-x: auto;
    }

    /* ===== AVATAR & PROFILE PICTURE ===== */
    .avatar {
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent);
    }

    .avatar-small {
      width: 32px;
      height: 32px;
    }

    .avatar-medium {
      width: 64px;
      height: 64px;
    }

    .avatar-large {
      width: 120px;
      height: 120px;
    }

    .avatar-xlarge {
      width: 180px;
      height: 180px;
    }

    .avatar-upload {
      position: relative;
      cursor: pointer;
      transition: transform 0.3s;
    }

    .avatar-upload:hover {
      transform: scale(1.05);
    }

    .avatar-upload-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.7);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .avatar-upload:hover .avatar-upload-overlay {
      opacity: 1;
    }

    /* ===== FRIEND SYSTEM ===== */
    .friend-requests-container {
      background: var(--bg-panel);
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }

    .friend-request-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 15px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-bottom: 10px;
    }

    .friend-request-info {
      display: flex;
      align-items: center;
      gap: 15px;
    }

    .friend-request-actions {
      display: flex;
      gap: 10px;
    }

    .friends-list-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 15px;
    }

    .friend-card {
      background: var(--bg-card);
      border-radius: 10px;
      padding: 15px;
      text-align: center;
      transition: transform 0.3s;
    }

    .friend-card:hover {
      transform: translateY(-5px);
    }

    .friend-avatar {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      object-fit: cover;
      margin: 0 auto 10px;
      border: 3px solid var(--accent);
    }

    .friend-name {
      font-weight: 500;
      margin-bottom: 5px;
    }

    .friend-status {
      font-size: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 5px;
      margin-bottom: 10px;
    }

    .friend-actions {
      display: flex;
      gap: 10px;
      justify-content: center;
    }

    /* ===== DASHBOARD CARDS ===== */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .stat-card {
      background: linear-gradient(135deg, var(--bg-panel), var(--bg-card));
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 25px;
      transition: all 0.3s;
      position: relative;
      overflow: hidden;
    }

    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
    }

    .stat-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 4px;
      background: linear-gradient(90deg, var(--accent), var(--accent-secondary));
    }

    .stat-card h3 {
      color: var(--text-soft);
      font-size: 14px;
      margin-bottom: 10px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .stat-value {
      font-size: 36px;
      font-weight: 700;
      color: var(--accent);
      margin-bottom: 5px;
    }

    .stat-trend {
      font-size: 12px;
      color: var(--success);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    /* ===== MODULES STYLES ===== */
    .module-container {
      background: var(--bg-panel);
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 30px;
      margin-bottom: 30px;
      transition: all 0.3s;
    }

    .module-container:hover {
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
    }

    .module-header {
      margin-bottom: 25px;
      padding-bottom: 20px;
      border-bottom: 1px solid var(--border);
    }

    .module-header h2 {
      color: var(--text-main);
      font-size: 24px;
      font-weight: 400;
    }

    .module-actions {
      display: flex;
      gap: 12px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .module-button {
      padding: 12px 24px;
      background: var(--bg-card);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s;
      font-size: 14px;
      font-weight: 500;
    }

    .module-button:hover {
      background: var(--accent);
      color: white;
      transform: translateY(-2px);
    }

    .module-button.primary {
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      color: white;
      border: none;
    }

    .module-button.success {
      background: var(--success);
      color: white;
      border: none;
    }

    .module-button.danger {
      background: var(--danger);
      color: white;
      border: none;
    }

    /* ===== THEORIES MODULE ===== */
    .theories-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
      gap: 20px;
    }

    .theory-card {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 20px;
      transition: all 0.3s;
      display: flex;
      flex-direction: column;
    }

    .theory-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
      border-color: var(--accent);
    }

    .theory-card h4 {
      color: var(--text-main);
      margin-bottom: 12px;
      font-size: 18px;
      font-weight: 500;
      line-height: 1.4;
    }

    .theory-meta {
      display: flex;
      gap: 15px;
      font-size: 13px;
      color: var(--text-soft);
      margin-bottom: 15px;
      flex-wrap: wrap;
    }

    .theory-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .status-draft { background: rgba(155, 89, 182, 0.2); color: var(--accent-secondary); }
    .status-pending { background: rgba(243, 156, 18, 0.2); color: var(--warning); }
    .status-approved { background: rgba(39, 174, 96, 0.2); color: var(--success); }
    .status-rejected { background: rgba(231, 76, 60, 0.2); color: var(--danger); }

    .theory-preview {
      color: var(--text-soft);
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 20px;
      flex: 1;
      overflow: hidden;
      display: -webkit-box;
      -webkit-line-clamp: 3;
      -webkit-box-orient: vertical;
    }

    .theory-actions {
      display: flex;
      gap: 10px;
      margin-top: auto;
    }

    /* ===== FORUM MODULE ===== */
    .forum-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .forum-table th {
      text-align: left;
      padding: 16px;
      border-bottom: 2px solid var(--border);
      color: var(--text-soft);
      font-weight: 600;
      font-size: 14px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .forum-table td {
      padding: 18px 16px;
      border-bottom: 1px solid var(--border);
      transition: background 0.3s;
    }

    .forum-table tr:hover {
      background: var(--bg-card);
    }

    .forum-table tr:last-child td {
      border-bottom: none;
    }

    .topic-title {
      font-weight: 500;
      color: var(--text-main);
      margin-bottom: 5px;
    }

    .topic-excerpt {
      font-size: 13px;
      color: var(--text-soft);
      line-height: 1.4;
    }

    .pinned-topic {
      background: rgba(155, 89, 182, 0.1);
      border-left: 3px solid var(--accent-secondary);
    }

    /* ===== CHAT MODULE ===== */
    .chat-container {
      display: grid;
      grid-template-columns: 250px 1fr;
      gap: 20px;
      height: 600px;
    }

    .chat-channels {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .channel-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
    }

    .channel-header h3 {
      color: var(--text-main);
      font-size: 18px;
      font-weight: 500;
    }

    .channels-list {
      flex: 1;
      overflow-y: auto;
    }

    .channel-item {
      padding: 15px 20px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .channel-item:hover {
      background: var(--bg-panel);
    }

    .channel-item.active {
      background: linear-gradient(135deg, rgba(74, 111, 165, 0.2), rgba(155, 89, 182, 0.2));
      border-left: 3px solid var(--accent);
    }

    .channel-icon {
      font-size: 20px;
    }

    .channel-name {
      flex: 1;
      font-weight: 500;
    }

    .unread-count {
      background: var(--danger);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    .online-count {
      font-size: 12px;
      color: var(--online);
    }

    .chat-window {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .chat-header {
      padding: 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .messages-container {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: flex;
      flex-direction: column;
      gap: 15px;
    }

    .message {
      max-width: 70%;
      padding: 15px;
      border-radius: 15px;
      position: relative;
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .message.own {
      background: linear-gradient(135deg, var(--accent), var(--accent-secondary));
      color: white;
      align-self: flex-end;
      border-bottom-right-radius: 5px;
    }

    .message.other {
      background: var(--bg-panel);
      align-self: flex-start;
      border-bottom-left-radius: 5px;
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .message-author {
      font-weight: 600;
      font-size: 14px;
    }

    .message-time {
      font-size: 12px;
      opacity: 0.8;
    }

    .message-content {
      font-size: 14px;
      line-height: 1.5;
      word-wrap: break-word;
    }

    .typing-indicator {
      font-size: 12px;
      color: var(--text-soft);
      padding: 10px 20px;
      font-style: italic;
    }

    .chat-input-container {
      padding: 20px;
      border-top: 1px solid var(--border);
      display: flex;
      gap: 12px;
      background: var(--bg-panel);
    }

    .chat-input {
      flex: 1;
      padding: 15px;
      background: var(--bg-input);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 14px;
      resize: none;
      min-height: 50px;
      max-height: 120px;
    }

    .chat-input:focus {
      outline: none;
      border-color: var(--accent);
    }

    /* ===== CHAT PRIVADO ===== */
    .private-chat-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
      height: 600px;
    }

    .contacts-list {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: 10px;
      overflow: hidden;
      display: flex;
      flex-direction: column;
    }

    .contact-search {
      padding: 15px;
      border-bottom: 1px solid var(--border);
    }

    .contact-search input {
      width: 100%;
      padding: 10px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-main);
    }

    .contact-item {
      padding: 15px;
      border-bottom: 1px solid var(--border);
      cursor: pointer;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .contact-item:hover {
      background: var(--bg-panel);
    }

    .contact-item.active {
      background: linear-gradient(135deg, rgba(74, 111, 165, 0.2), rgba(155, 89, 182, 0.2));
      border-left: 3px solid var(--accent);
    }

    .contact-avatar {
      width: 44px;
      height: 44px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid var(--accent);
    }

    .contact-info {
      flex: 1;
    }

    .contact-name {
      font-weight: 500;
      color: var(--text-main);
    }

    .contact-status {
      font-size: 12px;
      color: var(--text-soft);
      display: flex;
      align-items: center;
      gap: 5px;
    }

    .status-indicator {
      width: 8px;
      height: 8px;
      border-radius: 50%;
    }

    .status-online-ind { background: var(--online); }
    .status-away-ind { background: var(--away); }
    .status-offline-ind { background: var(--offline); }

    .last-message {
      font-size: 13px;
      color: var(--text-soft);
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: 180px;
    }

    .unread-badge {
      background: var(--danger);
      color: white;
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    /* ===== FRIENDS SYSTEM ===== */
    .friends-container {
      display: grid;
      grid-template-columns: 300px 1fr;
      gap: 20px;
    }

    .friends-sidebar {
      background: var(--bg-card);
      border-radius: 10px;
      padding: 20px;
    }

    .friends-search {
      margin-bottom: 20px;
    }

    .friends-search input {
      width: 100%;
      padding: 10px;
      background: var(--bg-input);
      border: 1px solid var(--border);
      border-radius: 6px;
      color: var(--text-main);
    }

    .friend-request-notification {
      background: var(--info);
      color: white;
      padding: 8px 12px;
      border-radius: 6px;
      font-size: 14px;
      cursor: pointer;
      margin-bottom: 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    /* ===== FORMS ===== */
    .form-group {
      margin-bottom: 25px;
    }

    .form-label {
      display: block;
      margin-bottom: 10px;
      color: var(--text-main);
      font-weight: 500;
      font-size: 15px;
    }

    .form-control {
      width: 100%;
      padding: 15px;
      background: var(--bg-input);
      color: var(--text-main);
      border: 1px solid var(--border);
      border-radius: 8px;
      font-size: 15px;
      transition: all 0.3s;
    }

    .form-control:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(74, 111, 165, 0.2);
    }

    textarea.form-control {
      min-height: 150px;
      resize: vertical;
      line-height: 1.5;
    }

    .form-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
    }

    /* ===== TEMAS ===== */
    .theme-selector {
      display: flex;
      gap: 10px;
      padding: 10px;
      background: var(--bg-card);
      border-radius: 8px;
      margin-top: 20px;
    }

    .theme-option {
      width: 30px;
      height: 30px;
      border-radius: 50%;
      cursor: pointer;
      transition: all 0.3s;
      border: 2px solid transparent;
    }

    .theme-option:hover {
      transform: scale(1.1);
    }

    .theme-option.active {
      border-color: var(--accent);
      transform: scale(1.1);
    }

    .theme-dark { background: #0b0b10; }
    .theme-blue { background: #1a237e; }
    .theme-green { background: #1b5e20; }
    .theme-purple { background: #4a148c; }

    /* ===== RESPONSIVE ===== */
    @media (max-width: 1024px) {
      #dashboard {
        grid-template-columns: 1fr;
      }
      
      #sidebar {
        display: none;
        position: fixed;
        left: 0;
        top: 0;
        width: 280px;
        height: 100vh;
        z-index: 1000;
        box-shadow: 0 0 20px rgba(0, 0, 0, 0.5);
      }
      
      #sidebar.active {
        display: flex;
      }
      
      .mobile-menu-toggle {
        display: block;
        position: fixed;
        top: 20px;
        left: 20px;
        z-index: 1001;
        background: var(--accent);
        color: white;
        width: 50px;
        height: 50px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 20px;
        cursor: pointer;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
      }
      
      .chat-container,
      .private-chat-container,
      .friends-container {
        grid-template-columns: 1fr;
        height: auto;
      }
      
      .stats-grid {
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      }
      
      .theories-grid {
        grid-template-columns: 1fr;
      }
      
      .friends-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
      }
    }

    @media (max-width: 768px) {
      .auth-container {
        position: relative;
        top: 0;
        left: 0;
        transform: none;
        margin: 20px auto;
        max-width: 90%;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .module-actions {
        flex-direction: column;
      }
      
      .module-button {
        width: 100%;
      }
      
      .friends-list-grid {
        grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      }
    }

    /* ===== ANIMAÇÕES ===== */
    .fade-in {
      animation: fadeIn 0.5s ease;
    }

    .slide-up {
      animation: slideUp 0.5s ease;
    }

    @keyframes slideUp {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    /* ===== SCROLLBAR PERSONALIZADA ===== */
    ::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    ::-webkit-scrollbar-track {
      background: var(--bg-input);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb {
      background: var(--accent);
      border-radius: 4px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: var(--accent-secondary);
    }
  </style>
</head>

<body>
  <!-- ===== TOAST NOTIFICATIONS ===== -->
  <div class="toast-container" id="toastContainer"></div>

  <!-- ===== MOBILE MENU TOGGLE ===== -->
  <div class="mobile-menu-toggle" id="mobileMenuToggle">
    <i class="fas fa-bars"></i>
  </div>

  <!-- ===== AUTH SCREEN ===== -->
  <div id="authScreen" class="auth-container fade-in">
    <h1>Renova</h1>
    
    <div id="authError" class="alert alert-error hidden"></div>
    
    <input type="text" id="username" class="auth-input" placeholder="Usuário" required>
    <input type="password" id="password" class="auth-input" placeholder="Senha" required>
    <input type="text" id="masterKey" class="auth-input" placeholder="MASTER_KEY (opcional)">
    
    <button onclick="login()" class="auth-button">Entrar</button>
    <button onclick="register()" class="auth-button secondary">Criar Conta</button>
    
    <div class="theme-selector">
      <div class="theme-option theme-dark active" onclick="setTheme('dark')"></div>
      <div class="theme-option theme-blue" onclick="setTheme('blue')"></div>
      <div class="theme-option theme-green" onclick="setTheme('green')"></div>
      <div class="theme-option theme-purple" onclick="setTheme('purple')"></div>
    </div>
    
    <div class="auth-info">
      Sistema Científico · Amigos Online · LaTeX · v4.0
    </div>
  </div>

  <!-- ===== DASHBOARD ===== -->
  <div id="dashboard" class="hidden">
    <!-- SIDEBAR -->
    <div id="sidebar">
      <div class="sidebar-header">
        <h2>Renova</h2>
        <div class="user-status">
          <span class="status-dot status-online" id="userStatusDot"></span>
          <span id="userRole">Online</span>
        </div>
      </div>
      
      <!-- Online Users -->
      <div class="online-users">
        <h4><i class="fas fa-user-friends"></i> Amigos Online</h4>
        <div class="online-user-list" id="onlineFriendsList">
          <!-- Carregado dinamicamente -->
        </div>
      </div>
      
      <!-- Menu -->
      <div class="sidebar-menu">
        <div class="menu-item active" onclick="loadSection('dashboard')">
          <i class="fas fa-chart-line"></i> Dashboard
        </div>
        <div class="menu-item" onclick="loadSection('theories')">
          <i class="fas fa-book"></i> Teorias
          <span class="notification-badge" id="theoryBadge" style="display: none;">0</span>
        </div>
        <div class="menu-item" onclick="loadSection('forum')">
          <i class="fas fa-comments"></i> Fórum
          <span class="notification-badge" id="forumBadge" style="display: none;">0</span>
        </div>
        <div class="menu-item" onclick="loadSection('friends')">
          <i class="fas fa-user-friends"></i> Amigos
          <span class="notification-badge" id="friendBadge" style="display: none;">0</span>
        </div>
        <div class="menu-item" onclick="loadSection('private')">
          <i class="fas fa-comment-dots"></i> Chat Privado
          <span class="notification-badge" id="privateBadge" style="display: none;">0</span>
        </div>
        <div class="menu-item" onclick="loadSection('chat')">
          <i class="fas fa-hashtag"></i> Chat Geral
        </div>
        <div class="menu-item" onclick="loadSection('groups')">
          <i class="fas fa-users"></i> Grupos
        </div>
        <div class="menu-item" onclick="loadSection('files')">
          <i class="fas fa-folder"></i> Arquivos
        </div>
        <div class="menu-item" onclick="loadSection('profile')">
          <i class="fas fa-user"></i> Perfil
        </div>
        <div id="adminMenuItem" class="menu-item hidden" onclick="loadSection('admin')">
          <i class="fas fa-cog"></i> Administração
        </div>
      </div>
      
      <div class="user-info">
        <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
          <img id="userAvatarSidebar" class="avatar avatar-small" src="" alt="Avatar">
          <div>
            <div id="currentUser" style="font-weight: 500;"></div>
            <div id="userLevel" style="font-size: 12px; color: var(--text-soft);"></div>
          </div>
        </div>
        <select id="statusSelector" class="form-control" style="margin-bottom: 10px; font-size: 13px; padding: 8px;">
          <option value="online">Online</option>
          <option value="away">Ausente</option>
          <option value="offline">Offline</option>
        </select>
        <button onclick="logout()" class="module-button danger" style="width: 100%;">
          <i class="fas fa-sign-out-alt"></i> Sair
        </button>
      </div>
    </div>
    
    <!-- MAIN CONTENT -->
    <div id="mainContent">
      <!-- Content will be loaded here -->
    </div>
  </div>

  <script>
    // ============================================
    // 1. SISTEMA COMPLETO COM TODAS AS CORREÇÕES
    // ============================================
    const MASTER_KEY = "Renova, O Non Trad";
    const APP_VERSION = "4.0";
    
    // Estado global completo
    let appState = {
      currentUser: null,
      isNucleo: false,
      userStatus: 'online',
      onlineUsers: {}, // {username: {status, lastSeen, avatar}}
      notifications: [],
      theme: 'dark',
      
      // Dados persistentes
      users: JSON.parse(localStorage.getItem('renova_users')) || {},
      theories: JSON.parse(localStorage.getItem('renova_theories')) || [],
      forumTopics: JSON.parse(localStorage.getItem('renova_forum')) || [],
      chatMessages: JSON.parse(localStorage.getItem('renova_chat')) || {},
      privateMessages: JSON.parse(localStorage.getItem('renova_private')) || {},
      groups: JSON.parse(localStorage.getItem('renova_groups')) || [],
      files: JSON.parse(localStorage.getItem('renova_files')) || [],
      notifications: JSON.parse(localStorage.getItem('renova_notifications')) || [],
      
      // Sistema de amizades
      friends: JSON.parse(localStorage.getItem('renova_friends')) || {},
      friendRequests: JSON.parse(localStorage.getItem('renova_friend_requests')) || {},
      
      unreadCounts: {
        theories: 0,
        forum: 0,
        chat: 0,
        private: 0,
        friends: 0
      }
    };
    
    // Variáveis temporárias para funcionalidades de chat
    let currentReplyTo = null;
    let currentFile = null;
    let currentChannel = 'geral';
    let currentContact = null;
    
    // ============================================
    // 2. SISTEMA DE NOTIFICAÇÕES
    // ============================================
    function showToast(message, type = 'info') {
      const container = document.getElementById('toastContainer');
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      toast.innerHTML = `
        <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : type === 'warning' ? 'exclamation-triangle' : 'info-circle'}"></i>
        <span>${message}</span>
      `;
      
      container.appendChild(toast);
      
      // Auto-remove após 5 segundos
      setTimeout(() => {
        toast.style.animation = 'slideIn 0.3s ease reverse';
        setTimeout(() => toast.remove(), 300);
      }, 5000);
    }
    
    function addNotification(title, message, type = 'info', link = null) {
      const notification = {
        id: 'n' + Date.now(),
        title,
        message,
        type,
        link,
        timestamp: new Date().toISOString(),
        read: false
      };
      
      appState.notifications.unshift(notification);
      saveState();
      updateNotificationBadges();
      
      // Mostrar toast
      showToast(message, type);
    }
    
    function updateNotificationBadges() {
      // Solicitações de amizade
      const friendRequests = appState.friendRequests[appState.currentUser] || [];
      const pendingRequests = friendRequests.filter(r => r.status === 'pending');
      
      // Mensagens privadas não lidas
      let unreadPrivate = 0;
      if (appState.privateMessages[appState.currentUser]) {
        Object.values(appState.privateMessages[appState.currentUser]).forEach(conversation => {
          unreadPrivate += conversation.filter(m => m.sender !== appState.currentUser && !m.read).length;
        });
      }
      
      // Atualizar badges
      const badges = {
        'friendBadge': pendingRequests.length,
        'privateBadge': unreadPrivate
      };
      
      Object.entries(badges).forEach(([id, count]) => {
        const badge = document.getElementById(id);
        if (badge) {
          badge.textContent = count;
          badge.style.display = count > 0 ? 'block' : 'none';
        }
      });
    }
    
    // ============================================
    // 3. PERSISTÊNCIA
    // ============================================
    function saveState() {
      localStorage.setItem('renova_users', JSON.stringify(appState.users));
      localStorage.setItem('renova_theories', JSON.stringify(appState.theories));
      localStorage.setItem('renova_forum', JSON.stringify(appState.forumTopics));
      localStorage.setItem('renova_chat', JSON.stringify(appState.chatMessages));
      localStorage.setItem('renova_private', JSON.stringify(appState.privateMessages));
      localStorage.setItem('renova_groups', JSON.stringify(appState.groups));
      localStorage.setItem('renova_files', JSON.stringify(appState.files));
      localStorage.setItem('renova_notifications', JSON.stringify(appState.notifications));
      localStorage.setItem('renova_friends', JSON.stringify(appState.friends));
      localStorage.setItem('renova_friend_requests', JSON.stringify(appState.friendRequests));
      localStorage.setItem('renova_theme', appState.theme);
    }
    
    // ============================================
    // 4. SISTEMA DE AUTENTICAÇÃO
    // ============================================
    function checkAuth() {
      const storedUser = localStorage.getItem('renova_currentUser');
      if (storedUser && appState.users[storedUser]) {
        appState.currentUser = storedUser;
        appState.isNucleo = appState.users[storedUser].nucleo || false;
        appState.userStatus = appState.users[storedUser].status || 'online';
        appState.theme = localStorage.getItem('renova_theme') || 'dark';
        setTheme(appState.theme);
        
        // Marcar como online
        updateUserStatus(appState.userStatus);
        
        showDashboard();
      }
    }
    
    function login() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const masterKey = document.getElementById('masterKey').value;
      
      if (!username || !password) {
        showToast('Preencha usuário e senha!', 'error');
        return;
      }
      
      const user = appState.users[username];
      
      if (!user) {
        showToast('Usuário não encontrado!', 'error');
        return;
      }
      
      if (user.password !== password) {
        showToast('Senha incorreta!', 'error');
        return;
      }
      
      // Verificar se é núcleo
      const isNucleo = masterKey === MASTER_KEY;
      if (isNucleo) {
        user.nucleo = true;
        saveState();
        showToast('Acesso Núcleo concedido!', 'success');
      }
      
      appState.currentUser = username;
      appState.isNucleo = user.nucleo || false;
      appState.userStatus = user.status || 'online';
      
      // Atualizar status
      updateUserStatus(appState.userStatus);
      
      localStorage.setItem('renova_currentUser', username);
      
      showToast(`Bem-vindo(a) de volta, ${username}!`, 'success');
      
      showDashboard();
    }
    
    function register() {
      const username = document.getElementById('username').value.trim();
      const password = document.getElementById('password').value;
      const masterKey = document.getElementById('masterKey').value;
      
      if (!username || !password) {
        showToast('Preencha usuário e senha!', 'error');
        return;
      }
      
      if (appState.users[username]) {
        showToast('Usuário já existe!', 'error');
        return;
      }
      
      const isNucleo = masterKey === MASTER_KEY;
      
      // Avatar padrão
      const avatarColor = generateAvatarColor(username);
      const avatarInitials = username.substring(0, 2).toUpperCase();
      const defaultAvatar = generateDefaultAvatar(avatarInitials, avatarColor);
      
      appState.users[username] = {
        password: password,
        nucleo: isNucleo,
        status: 'online',
        createdAt: new Date().toISOString(),
        lastSeen: new Date().toISOString(),
        profile: {
          bio: '',
          area: '',
          links: '',
          avatar: defaultAvatar,
          avatarUrl: null
        },
        stats: {
          theories: 0,
          forumPosts: 0,
          chatMessages: 0,
          files: 0,
          groups: 0,
          friends: 0
        },
        settings: {
          theme: 'dark',
          notifications: true,
          privacy: 'public',
          showOnlineStatus: true
        }
      };
      
      // Inicializar lista de amigos
      appState.friends[username] = [];
      appState.friendRequests[username] = [];
      
      saveState();
      
      if (isNucleo) {
        showToast('Conta Núcleo criada com sucesso!', 'success');
      } else {
        showToast('Conta criada com sucesso! Faça login.', 'success');
      }
    }
    
    function generateAvatarColor(username) {
      const colors = [
        '#4a6fa5', '#9b59b6', '#e74c3c', '#27ae60', 
        '#f39c12', '#3498db', '#1abc9c', '#d35400'
      ];
      const hash = username.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
      return colors[hash % colors.length];
    }
    
    function generateDefaultAvatar(initials, color) {
      const svg = `
        <svg width="100" height="100" viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg">
          <rect width="100" height="100" fill="${color}" rx="50"/>
          <text x="50" y="50" font-family="Arial, sans-serif" font-size="40" 
                fill="white" text-anchor="middle" dy=".3em">${initials}</text>
        </svg>
      `;
      return 'data:image/svg+xml;base64,' + btoa(svg);
    }
    
    function updateUserStatus(status) {
      if (!appState.currentUser) return;
      
      appState.userStatus = status;
      appState.users[appState.currentUser].status = status;
      appState.users[appState.currentUser].lastSeen = new Date().toISOString();
      
      // Atualizar lista de onlineUsers
      appState.onlineUsers[appState.currentUser] = {
        status: status,
        lastSeen: new Date().toISOString(),
        avatar: appState.users[appState.currentUser].profile.avatarUrl || 
                appState.users[appState.currentUser].profile.avatar
      };
      
      saveState();
      updateOnlineUsersDisplay();
      
      // Atualizar UI
      const statusDot = document.getElementById('userStatusDot');
      const statusSelector = document.getElementById('statusSelector');
      
      if (statusDot) {
        statusDot.className = 'status-dot status-' + status;
      }
      
      if (statusSelector) {
        statusSelector.value = status;
      }
    }
    
    function logout() {
      // Marcar como offline
      if (appState.currentUser) {
        updateUserStatus('offline');
        delete appState.onlineUsers[appState.currentUser];
        
        appState.users[appState.currentUser].lastSeen = new Date().toISOString();
        saveState();
      }
      
      appState.currentUser = null;
      appState.isNucleo = false;
      localStorage.removeItem('renova_currentUser');
      
      showAuthScreen();
      showToast('Logout realizado com sucesso!', 'info');
    }
    
    // ============================================
    // 5. SISTEMA DE AMIZADES
    // ============================================
    function sendFriendRequest(toUsername) {
      if (!appState.currentUser || appState.currentUser === toUsername) return;
      
      // Verificar se já são amigos
      if (appState.friends[appState.currentUser]?.includes(toUsername)) {
        showToast('Vocês já são amigos!', 'info');
        return;
      }
      
      // Verificar se já existe solicitação pendente
      const existingRequest = appState.friendRequests[toUsername]?.find(
        r => r.from === appState.currentUser && r.status === 'pending'
      );
      
      if (existingRequest) {
        showToast('Solicitação já enviada!', 'info');
        return;
      }
      
      // Criar solicitação
      const request = {
        id: 'fr' + Date.now(),
        from: appState.currentUser,
        to: toUsername,
        status: 'pending',
        sentAt: new Date().toISOString()
      };
      
      // Adicionar à lista do destinatário
      if (!appState.friendRequests[toUsername]) {
        appState.friendRequests[toUsername] = [];
      }
      appState.friendRequests[toUsername].push(request);
      
      saveState();
      
      // Notificar o destinatário
      showToast('Solicitação de amizade enviada!', 'success');
      
      // Recarregar seção de amigos se estiver aberta
      if (document.getElementById('mainContent').innerHTML.includes('Amigos')) {
        loadSection('friends');
      }
    }
    
    function acceptFriendRequest(requestId) {
      const userRequests = appState.friendRequests[appState.currentUser];
      if (!userRequests) return;
      
      const request = userRequests.find(r => r.id === requestId);
      if (!request) return;
      
      // Atualizar status
      request.status = 'accepted';
      request.respondedAt = new Date().toISOString();
      
      // Adicionar como amigos mútuos
      if (!appState.friends[appState.currentUser]) {
        appState.friends[appState.currentUser] = [];
      }
      if (!appState.friends[request.from]) {
        appState.friends[request.from] = [];
      }
      
      if (!appState.friends[appState.currentUser].includes(request.from)) {
        appState.friends[appState.currentUser].push(request.from);
      }
      if (!appState.friends[request.from].includes(appState.currentUser)) {
        appState.friends[request.from].push(appState.currentUser);
      }
      
      // Atualizar estatísticas
      appState.users[appState.currentUser].stats.friends++;
      appState.users[request.from].stats.friends++;
      
      saveState();
      
      showToast('Solicitação de amizade aceita!', 'success');
      
      // Recarregar
      loadSection('friends');
    }
    
    function rejectFriendRequest(requestId) {
      const userRequests = appState.friendRequests[appState.currentUser];
      if (!userRequests) return;
      
      const requestIndex = userRequests.findIndex(r => r.id === requestId);
      if (requestIndex === -1) return;
      
      // Atualizar status
      appState.friendRequests[appState.currentUser][requestIndex].status = 'rejected';
      appState.friendRequests[appState.currentUser][requestIndex].respondedAt = new Date().toISOString();
      
      saveState();
      
      showToast('Solicitação recusada.', 'info');
      loadSection('friends');
    }
    
    function removeFriend(friendUsername) {
      if (!confirm(`Remover ${friendUsername} dos seus amigos?`)) return;
      
      // Remover da lista de amigos
      if (appState.friends[appState.currentUser]) {
        appState.friends[appState.currentUser] = appState.friends[appState.currentUser].filter(
          f => f !== friendUsername
        );
      }
      
      if (appState.friends[friendUsername]) {
        appState.friends[friendUsername] = appState.friends[friendUsername].filter(
          f => f !== appState.currentUser
        );
      }
      
      // Atualizar estatísticas
      appState.users[appState.currentUser].stats.friends--;
      appState.users[friendUsername].stats.friends--;
      
      saveState();
      
      showToast(`${friendUsername} removido dos amigos.`, 'info');
      loadSection('friends');
    }
    
    // ============================================
    // 6. TEMAS
    // ============================================
    function setTheme(themeName) {
      appState.theme = themeName;
      localStorage.setItem('renova_theme', themeName);
      
      const themes = {
        dark: {
          '--bg-main': '#0b0b10',
          '--bg-panel': '#111118',
          '--bg-card': '#1b1b2e',
          '--bg-input': '#0a0a15'
        },
        blue: {
          '--bg-main': '#0d1b2a',
          '--bg-panel': '#1b263b',
          '--bg-card': '#415a77',
          '--bg-input': '#0a1422'
        },
        green: {
          '--bg-main': '#0d1f12',
          '--bg-panel': '#1a2c1d',
          '--bg-card': '#2d4d31',
          '--bg-input': '#0a180d'
        },
        purple: {
          '--bg-main': '#1a0d2a',
          '--bg-panel': '#2a1b3b',
          '--bg-card': '#4a2d77',
          '--bg-input': '#140a22'
        }
      };
      
      const theme = themes[themeName] || themes.dark;
      Object.entries(theme).forEach(([property, value]) => {
        document.documentElement.style.setProperty(property, value);
      });
      
      // Atualizar tema ativo
      document.querySelectorAll('.theme-option').forEach(opt => {
        opt.classList.remove('active');
      });
      document.querySelector(`.theme-${themeName}`)?.classList.add('active');
      
      // Salvar no perfil do usuário
      if (appState.currentUser && appState.users[appState.currentUser]) {
        appState.users[appState.currentUser].settings.theme = themeName;
        saveState();
      }
    }
    
    // ============================================
    // 7. SISTEMA DE NAVEGAÇÃO
    // ============================================
    function loadSection(section) {
      const menuItems = document.querySelectorAll('.menu-item');
      menuItems.forEach(item => item.classList.remove('active'));
      
      // Ativar item do menu
      event?.target.closest('.menu-item')?.classList.add('active');
      
      // Fechar menu mobile se aberto
      document.getElementById('sidebar').classList.remove('active');
      
      switch(section) {
        case 'dashboard':
          renderDashboard();
          break;
        case 'theories':
          renderTheories();
          break;
        case 'forum':
          renderForum();
          break;
        case 'friends':
          renderFriends();
          break;
        case 'private':
          renderPrivateChat();
          break;
        case 'chat':
          renderChat();
          break;
        case 'groups':
          renderGroups();
          break;
        case 'files':
          renderFiles();
          break;
        case 'profile':
          renderProfile();
          break;
        case 'admin':
          renderAdmin();
          break;
      }
      
      // Atualizar notificações
      updateNotificationBadges();
    }
    
    // ============================================
    // 8. DASHBOARD PRINCIPAL
    // ============================================
    function renderDashboard() {
      const user = appState.users[appState.currentUser];
      const userTheories = appState.theories.filter(t => t.author === appState.currentUser);
      const approvedTheories = userTheories.filter(t => t.status === 'approved');
      const userGroups = appState.groups.filter(g => g.members.includes(appState.currentUser));
      const forumPosts = appState.forumTopics.filter(t => t.author === appState.currentUser);
      const friends = appState.friends[appState.currentUser] || [];
      const onlineFriends = friends.filter(f => 
        appState.onlineUsers[f] && appState.onlineUsers[f].status === 'online'
      );
      
      const content = document.getElementById('mainContent');
      content.innerHTML = `
        <div class="content-header">
          <div style="display: flex; align-items: center; gap: 20px;">
            <img id="userAvatarHeader" class="avatar avatar-large" src="${user.profile.avatarUrl || user.profile.avatar}" alt="Avatar">
            <div>
              <h1>Bem-vindo(a), ${appState.currentUser}!</h1>
              <p>Sistema Científico Renova • ${friends.length} amigos • ${onlineFriends.length} online</p>
            </div>
          </div>
        </div>
        
        <div class="stats-grid">
          <div class="stat-card">
            <h3>Meus Amigos</h3>
            <div class="stat-value">${friends.length}</div>
            <div class="stat-trend">
              <i class="fas fa-user-friends"></i>
              <span>${onlineFriends.length} online</span>
            </div>
          </div>
          
          <div class="stat-card">
            <h3>Minhas Teorias</h3>
            <div class="stat-value">${userTheories.length}</div>
            <div class="stat-trend">
              <i class="fas fa-check"></i>
              <span>${approvedTheories.length} aprovadas</span>
            </div>
          </div>
          
          <div class="stat-card">
            <h3>Posts no Fórum</h3>
            <div class="stat-value">${forumPosts.length}</div>
            <div class="stat-trend">
              <i class="fas fa-comment"></i>
              <span>interações</span>
            </div>
          </div>
          
          <div class="stat-card">
            <h3>Meus Grupos</h3>
            <div class="stat-value">${userGroups.length}</div>
            <div class="stat-trend">
              <i class="fas fa-users"></i>
              <span>participações</span>
            </div>
          </div>
        </div>
        
        <div class="module-container">
          <div class="module-header">
            <h2>Ações Rápidas</h2>
          </div>
          
          <div class="module-actions">
            <button class="module-button primary" onclick="loadSection('theories')">
              <i class="fas fa-plus"></i> Nova Teoria
            </button>
            <button class="module-button" onclick="loadSection('friends')">
              <i class="fas fa-user-plus"></i> Adicionar Amigo
            </button>
            <button class="module-button" onclick="loadSection('private')">
              <i class="fas fa-comment-medical"></i> Nova Mensagem
            </button>
            <button class="module-button" onclick="loadSection('forum')">
              <i class="fas fa-comment-dots"></i> Criar Tópico
            </button>
          </div>
        </div>
        
        <div class="module-container">
          <div class="module-header">
            <h2>Amigos Online</h2>
          </div>
          
          <div class="friends-list-grid" id="onlineFriendsDashboard">
            ${renderOnlineFriendsDashboard()}
          </div>
        </div>
        
        <div class="module-container">
          <div class="module-header">
            <h2>Atividade Recente</h2>
          </div>
          
          <div id="recentActivity">
            ${renderRecentActivity()}
          </div>
        </div>
      `;
      
      // Atualizar UI do usuário
      updateUserUI();
      
      // Atualizar MathJax
      setTimeout(() => {
        if (window.MathJax) {
          MathJax.typesetPromise();
        }
      }, 100);
    }
    
    function renderOnlineFriendsDashboard() {
      const friends = appState.friends[appState.currentUser] || [];
      const onlineFriends = friends.filter(f => 
        appState.onlineUsers[f] && appState.onlineUsers[f].status === 'online'
      );
      
      if (onlineFriends.length === 0) {
        return `
          <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-soft);">
            <i class="fas fa-user-friends" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>Nenhum amigo online no momento.</p>
          </div>
        `;
      }
      
      return onlineFriends.slice(0, 6).map(friend => {
        const user = appState.users[friend];
        return `
          <div class="friend-card">
            <img src="${user.profile.avatarUrl || user.profile.avatar}" 
                 class="friend-avatar" alt="${friend}">
            <div class="friend-name">${friend}</div>
            <div class="friend-status">
              <span class="status-indicator status-online-ind"></span>
              <span>Online</span>
            </div>
            <div class="friend-actions">
              <button class="module-button" onclick="openPrivateChat('${friend}')">
                <i class="fas fa-comment"></i>
              </button>
              <button class="module-button success" onclick="viewProfile('${friend}')">
                <i class="fas fa-user"></i>
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderRecentActivity() {
      const activities = [];
      
      // Teorias recentes
      appState.theories.slice(-5).reverse().forEach(theory => {
        activities.push({
          type: 'theory',
          user: theory.author,
          title: theory.title,
          time: theory.createdAt,
          status: theory.status
        });
      });
      
      // Tópicos recentes do fórum
      appState.forumTopics.slice(-5).reverse().forEach(topic => {
        activities.push({
          type: 'forum',
          user: topic.author,
          title: topic.title,
          time: topic.createdAt
        });
      });
      
      // Amizades recentes
      Object.values(appState.friendRequests).forEach(requests => {
        requests.slice(-3).forEach(req => {
          if (req.status === 'accepted' && req.respondedAt) {
            activities.push({
              type: 'friend',
              user: req.from,
              action: 'accepted',
              time: req.respondedAt
            });
          }
        });
      });
      
      // Ordenar por tempo
      activities.sort((a, b) => new Date(b.time) - new Date(a.time));
      
      if (activities.length === 0) {
        return '<p style="text-align: center; color: var(--text-soft); padding: 20px;">Nenhuma atividade recente.</p>';
      }
      
      return activities.slice(0, 10).map(act => {
        let icon, text;
        
        switch(act.type) {
          case 'theory':
            icon = '📚';
            text = `${act.user} publicou "${act.title}"`;
            break;
          case 'forum':
            icon = '💬';
            text = `${act.user} criou "${act.title}"`;
            break;
          case 'friend':
            icon = '🤝';
            text = `${act.user} e ${act.action === 'accepted' ? 'agora são amigos' : ''}`;
            break;
          default:
            icon = '📝';
            text = 'Nova atividade';
        }
        
        return `
          <div style="padding: 15px; border-bottom: 1px solid var(--border); display: flex; align-items: center; gap: 15px;">
            <div style="font-size: 20px;">${icon}</div>
            <div style="flex: 1;">
              <div style="font-size: 14px; color: var(--text-main);">${text}</div>
              <div style="font-size: 12px; color: var(--text-soft);">
                ${new Date(act.time).toLocaleString()}
              </div>
            </div>
          </div>
        `;
      }).join('');
    }
    
    // ============================================
    // 9. CHAT GERAL COMPLETO
    // ============================================
    function renderChat() {
      // Inicializar canais se não existirem
      const channels = {
        'geral': { name: '💬 Geral', description: 'Conversas gerais' },
        'matematica': { name: '🧮 Matemática', description: 'Discussões matemáticas' },
        'fisica': { name: '⚛️ Física', description: 'Física e ciências naturais' },
        'programacao': { name: '💻 Programação', description: 'Algoritmos e código' },
        'offtopic': { name: '🎮 Off-topic', description: 'Conversas informais' }
      };
      
      // Inicializar mensagens se não existirem
      Object.keys(channels).forEach(channel => {
        if (!appState.chatMessages[channel]) {
          appState.chatMessages[channel] = [];
        }
      });
      
      const content = document.getElementById('mainContent');
      content.innerHTML = `
        <div class="content-header">
          <h1>Chat Geral</h1>
          <p>Converse com toda a comunidade científica</p>
        </div>
        
        <div class="chat-container">
          <div class="chat-channels">
            <div class="channel-header">
              <h3>Canais</h3>
            </div>
            <div class="channels-list">
              ${Object.entries(channels).map(([id, channel]) => `
                <div class="channel-item ${id === currentChannel ? 'active' : ''}" 
                     onclick="switchChannel('${id}')">
                  <div class="channel-icon">${channel.name.charAt(0)}</div>
                  <div class="channel-name">${channel.name.substring(2)}</div>
                  <div class="online-count">${getOnlineCount()}</div>
                </div>
              `).join('')}
            </div>
          </div>
          
          <div class="chat-window">
            <div class="chat-header">
              <div>
                <h3 id="currentChannelName">${channels[currentChannel].name}</h3>
                <div class="online-count">${getOnlineCount()} usuários online</div>
              </div>
              <div class="module-actions" style="margin: 0;">
                <button class="module-button" onclick="showLatexHelp()">
                  <i class="fas fa-superscript"></i> LaTeX
                </button>
              </div>
            </div>
            
            <div class="messages-container" id="messagesContainer">
              ${renderChatMessages(currentChannel)}
            </div>
            
            ${currentReplyTo ? `
            <div class="reply-preview">
              <div class="reply-preview-header">
                <span>Respondendo a ${currentReplyTo.author}</span>
                <button class="cancel-reply" onclick="cancelReply()">
                  <i class="fas fa-times"></i> Cancelar
                </button>
              </div>
              <div>${currentReplyTo.content.substring(0, 100)}...</div>
            </div>
            ` : ''}
            
            <div class="chat-input-container">
              <div style="display: flex; flex-direction: column; width: 100%; gap: 10px;">
                <div class="latex-toolbar">
                  <button class="latex-btn" onclick="insertLatex('equation')">$$ Equação $$</button>
                  <button class="latex-btn" onclick="insertLatex('fraction')">\\frac{}{}</button>
                  <button class="latex-btn" onclick="insertLatex('sqrt')">\\sqrt{}</button>
                  <button class="latex-btn" onclick="insertLatex('sum')">\\sum</button>
                  <button class="latex-btn" onclick="insertLatex('integral')">\\int</button>
                  <button class="latex-btn" onclick="insertLatex('matrix')">Matriz</button>
                </div>
                
                ${currentFile ? `
                <div class="file-preview">
                  ${currentFile.type.startsWith('image/') ? 
                    `<img src="${currentFile.data}" alt="Preview">` : 
                    `<i class="fas fa-file" style="font-size: 24px;"></i>`
                  }
                  <div class="file-preview-info">
                    <div class="file-preview-name">${currentFile.name}</div>
                    <div class="file-preview-size">${formatFileSize(currentFile.size)}</div>
                  </div>
                  <button class="remove-file" onclick="removeFile()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                ` : ''}
                
                <textarea id="chatInput" class="chat-input" 
                          placeholder="Digite sua mensagem... (Use LaTeX para fórmulas: $E=mc^2$)"
                          onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendChatMessage(); }"></textarea>
                
                <div style="display: flex; gap: 10px;">
                  <button class="module-button" onclick="document.getElementById('fileUpload').click()">
                    <i class="fas fa-paperclip"></i> Arquivo
                  </button>
                  <input type="file" id="fileUpload" style="display: none;" onchange="handleFileUpload(event)">
                  <button class="module-button primary" onclick="sendChatMessage()" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Enviar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <div class="module-container" style="margin-top: 20px;">
          <div class="module-header">
            <h2><i class="fas fa-superscript"></i> Guia Rápido de LaTeX</h2>
          </div>
          <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
            <div>
              <h4>Modo inline</h4>
              <code style="background: var(--bg-card); padding: 5px; border-radius: 4px; display: block;">
                $E = mc^2$
              </code>
              <small>Renderiza como: \(E = mc^2\)</small>
            </div>
            <div>
              <h4>Modo display</h4>
              <code style="background: var(--bg-card); padding: 5px; border-radius: 4px; display: block;">
                $$\int_{-\infty}^{\infty} e^{-x^2} dx = \sqrt{\pi}$$
              </code>
              <small>Renderiza centralizado</small>
            </div>
            <div>
              <h4>Fórmulas comuns</h4>
              <code style="background: var(--bg-card); padding: 5px; border-radius: 4px; display: block;">
                \frac{a}{b}, \sqrt{x}, \sum_{i=1}^{n}
              </code>
              <small>Use os botões acima</small>
            </div>
          </div>
        </div>
      `;
      
      // Scroll para baixo
      setTimeout(() => {
        const container = document.getElementById('messagesContainer');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
      
      // Atualizar MathJax
      setTimeout(() => {
        if (window.MathJax) {
          MathJax.typesetPromise();
        }
      }, 200);
    }
    
    function renderChatMessages(channel) {
      const messages = appState.chatMessages[channel] || [];
      
      if (messages.length === 0) {
        return `
          <div style="text-align: center; padding: 40px; color: var(--text-soft);">
            <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>Nenhuma mensagem ainda. Seja o primeiro a falar!</p>
          </div>
        `;
      }
      
      return messages.map(msg => {
        const isOwn = msg.author === appState.currentUser;
        const hasFile = msg.file;
        
        return `
          <div class="message ${isOwn ? 'own' : 'other'}" id="msg-${msg.id}">
            <div class="message-header">
              <span class="message-author">${msg.author}</span>
              <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
            </div>
            
            ${msg.replyTo ? `
              <div class="message-reply">
                <strong>Respondendo a ${msg.replyTo.author}:</strong>
                ${msg.replyTo.content.substring(0, 50)}...
              </div>
            ` : ''}
            
            <div class="message-content">
              ${msg.content}
              ${hasFile ? renderFileAttachment(msg.file) : ''}
            </div>
            
            <div class="message-actions">
              <button class="message-action" onclick="replyToMessage('${msg.id}')">
                <i class="fas fa-reply"></i> Responder
              </button>
              ${isOwn ? `
                <button class="message-action" onclick="deleteMessage('${msg.id}', '${channel}')">
                  <i class="fas fa-trash"></i> Apagar
                </button>
              ` : `
                <button class="message-action" onclick="pingUser('${msg.author}')">
                  <i class="fas fa-at"></i> @${msg.author}
                </button>
              `}
              <button class="message-action" onclick="copyMessageLink('${msg.id}')">
                <i class="fas fa-link"></i> Link
              </button>
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderFileAttachment(file) {
      if (file.type.startsWith('image/')) {
        return `
          <div style="margin-top: 10px;">
            <img src="${file.data}" alt="${file.name}" 
                 style="max-width: 200px; max-height: 200px; border-radius: 8px; cursor: pointer;"
                 onclick="viewFile('${file.data}', '${file.name}')">
            <div style="font-size: 12px; color: var(--text-soft); margin-top: 5px;">
              ${file.name} • ${formatFileSize(file.size)}
              <a href="${file.data}" download="${file.name}" style="margin-left: 10px;">
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
        `;
      } else {
        return `
          <div style="margin-top: 10px; background: rgba(255,255,255,0.1); padding: 10px; border-radius: 6px;">
            <div style="display: flex; align-items: center; gap: 10px;">
              <i class="fas fa-file" style="font-size: 24px;"></i>
              <div>
                <div style="font-weight: 500;">${file.name}</div>
                <div style="font-size: 12px; color: var(--text-soft);">
                  ${file.type} • ${formatFileSize(file.size)}
                </div>
              </div>
              <a href="${file.data}" download="${file.name}" style="margin-left: auto;">
                <i class="fas fa-download"></i>
              </a>
            </div>
          </div>
        `;
      }
    }
    
    function switchChannel(channel) {
      currentChannel = channel;
      currentReplyTo = null;
      currentFile = null;
      renderChat();
    }
    
    function getOnlineCount() {
      return Object.keys(appState.onlineUsers).filter(u => 
        appState.onlineUsers[u].status === 'online'
      ).length;
    }
    
    function insertLatex(type) {
      const textarea = document.getElementById('chatInput');
      const cursorPos = textarea.selectionStart;
      const text = textarea.value;
      
      const latexSnippets = {
        equation: '$$\\displaystyle{}$$',
        fraction: '\\frac{numerator}{denominator}',
        sqrt: '\\sqrt{}',
        sum: '\\sum_{i=1}^{n}',
        integral: '\\int_{a}^{b}',
        matrix: '\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}'
      };
      
      const snippet = latexSnippets[type] || '$$\\displaystyle{}$$';
      const newText = text.substring(0, cursorPos) + snippet + text.substring(cursorPos);
      textarea.value = newText;
      textarea.focus();
      textarea.setSelectionRange(cursorPos + snippet.length - 2, cursorPos + snippet.length - 2);
    }
    
    function handleFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validar tamanho (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showToast('Arquivo muito grande! Máximo 5MB.', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        currentFile = {
          name: file.name,
          type: file.type,
          size: file.size,
          data: e.target.result
        };
        renderChat(); // Recarregar para mostrar preview
      };
      
      reader.readAsDataURL(file);
    }
    
    function removeFile() {
      currentFile = null;
      renderChat();
    }
    
    function sendChatMessage() {
      const input = document.getElementById('chatInput');
      const content = input.value.trim();
      
      if (!content && !currentFile) {
        showToast('Digite uma mensagem ou selecione um arquivo!', 'error');
        return;
      }
      
      const message = {
        id: 'msg' + Date.now(),
        author: appState.currentUser,
        content: content || '(arquivo)',
        timestamp: new Date().toISOString(),
        channel: currentChannel,
        replyTo: currentReplyTo || null,
        file: currentFile || null
      };
      
      appState.chatMessages[currentChannel].push(message);
      
      // Atualizar estatísticas
      if (appState.users[appState.currentUser]) {
        appState.users[appState.currentUser].stats.chatMessages++;
      }
      
      saveState();
      
      // Resetar
      input.value = '';
      currentReplyTo = null;
      currentFile = null;
      
      // Recarregar mensagens
      document.getElementById('messagesContainer').innerHTML = 
        renderChatMessages(currentChannel);
      
      // Scroll para baixo
      setTimeout(() => {
        const container = document.getElementById('messagesContainer');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
      
      // Atualizar MathJax
      setTimeout(() => {
        if (window.MathJax) {
          MathJax.typesetPromise();
        }
      }, 200);
    }
    
    function replyToMessage(messageId) {
      const messages = appState.chatMessages[currentChannel] || [];
      const message = messages.find(m => m.id === messageId);
      
      if (message) {
        currentReplyTo = {
          id: message.id,
          author: message.author,
          content: message.content
        };
        
        // Focar no input
        const input = document.getElementById('chatInput');
        input.focus();
        
        // Recarregar para mostrar preview
        renderChat();
      }
    }
    
    function cancelReply() {
      currentReplyTo = null;
      renderChat();
    }
    
    function deleteMessage(messageId, channel) {
      if (!confirm('Apagar esta mensagem?')) return;
      
      const messages = appState.chatMessages[channel] || [];
      const index = messages.findIndex(m => m.id === messageId);
      
      if (index !== -1 && messages[index].author === appState.currentUser) {
        messages.splice(index, 1);
        saveState();
        renderChat();
        showToast('Mensagem apagada.', 'success');
      }
    }
    
    function pingUser(username) {
      const input = document.getElementById('chatInput');
      input.value = `@${username} ` + input.value;
      input.focus();
    }
    
    function copyMessageLink(messageId) {
      const url = `${window.location.origin}#msg-${messageId}`;
      navigator.clipboard.writeText(url).then(() => {
        showToast('Link copiado para a área de transferência!', 'success');
      });
    }
    
    function viewFile(data, name) {
      const w = window.open();
      w.document.write(`
        <html>
          <head><title>${name}</title></head>
          <body style="margin: 0; background: #111; display: flex; justify-content: center; align-items: center; min-height: 100vh;">
            <img src="${data}" style="max-width: 90vw; max-height: 90vh; border-radius: 8px;">
          </body>
        </html>
      `);
    }
    
    function formatFileSize(bytes) {
      if (bytes < 1024) return bytes + ' B';
      if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
      return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }
    
    function showLatexHelp() {
      showToast('Use $...$ para fórmulas inline e $$...$$ para display', 'info');
    }
    
    // ============================================
    // 10. CHAT PRIVADO COM TODAS AS FUNCIONALIDADES
    // ============================================
    function renderPrivateChat() {
      // Inicializar mensagens privadas se não existirem
      if (!appState.privateMessages[appState.currentUser]) {
        appState.privateMessages[appState.currentUser] = {};
      }
      
      const content = document.getElementById('mainContent');
      content.innerHTML = `
        <div class="content-header">
          <h1>Chat Privado</h1>
          <p>Conversas particulares com seus amigos</p>
        </div>
        
        <div class="private-chat-container">
          <div class="contacts-list">
            <div class="contact-search">
              <input type="text" id="contactSearch" placeholder="Buscar amigos..." 
                     onkeyup="searchContacts(this.value)">
            </div>
            
            <div class="channels-list" id="contactsList">
              ${renderContactsList()}
            </div>
          </div>
          
          <div class="chat-window">
            <div class="chat-header">
              <div>
                <h3 id="currentContactName">${currentContact ? currentContact : 'Selecione um amigo'}</h3>
                <div class="online-count" id="contactStatus">
                  ${currentContact && appState.onlineUsers[currentContact] ? 
                    appState.onlineUsers[currentContact].status === 'online' ? 'Online' : 'Ausente' : 
                    'Offline'}
                </div>
              </div>
              ${currentContact ? `
                <div class="module-actions" style="margin: 0;">
                  <button class="module-button" onclick="viewProfile('${currentContact}')">
                    <i class="fas fa-user"></i>
                  </button>
                </div>
              ` : ''}
            </div>
            
            <div class="messages-container" id="privateMessagesContainer">
              ${currentContact ? renderPrivateMessages(currentContact) : `
                <div style="text-align: center; padding: 40px; color: var(--text-soft);">
                  <i class="fas fa-comment-dots" style="font-size: 48px; margin-bottom: 15px;"></i>
                  <p>Selecione um amigo para começar a conversar</p>
                </div>
              `}
            </div>
            
            ${currentContact ? `
            <div class="chat-input-container">
              <div style="display: flex; flex-direction: column; width: 100%; gap: 10px;">
                ${currentReplyTo ? `
                <div class="reply-preview">
                  <div class="reply-preview-header">
                    <span>Respondendo a ${currentReplyTo.author}</span>
                    <button class="cancel-reply" onclick="cancelReplyPrivate()">
                      <i class="fas fa-times"></i> Cancelar
                    </button>
                  </div>
                  <div>${currentReplyTo.content.substring(0, 100)}...</div>
                </div>
                ` : ''}
                
                ${currentFile ? `
                <div class="file-preview">
                  ${currentFile.type.startsWith('image/') ? 
                    `<img src="${currentFile.data}" alt="Preview">` : 
                    `<i class="fas fa-file" style="font-size: 24px;"></i>`
                  }
                  <div class="file-preview-info">
                    <div class="file-preview-name">${currentFile.name}</div>
                    <div class="file-preview-size">${formatFileSize(currentFile.size)}</div>
                  </div>
                  <button class="remove-file" onclick="removeFilePrivate()">
                    <i class="fas fa-times"></i>
                  </button>
                </div>
                ` : ''}
                
                <textarea id="privateInput" class="chat-input" 
                          placeholder="Digite sua mensagem privada..."
                          onkeypress="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendPrivateMessage(); }"></textarea>
                
                <div style="display: flex; gap: 10px;">
                  <button class="module-button" onclick="document.getElementById('privateFileUpload').click()">
                    <i class="fas fa-paperclip"></i> Arquivo
                  </button>
                  <input type="file" id="privateFileUpload" style="display: none;" onchange="handlePrivateFileUpload(event)">
                  <button class="module-button primary" onclick="sendPrivateMessage()" style="flex: 1;">
                    <i class="fas fa-paper-plane"></i> Enviar
                  </button>
                </div>
              </div>
            </div>
            ` : ''}
          </div>
        </div>
      `;
    }
    
    function renderContactsList() {
      const friends = appState.friends[appState.currentUser] || [];
      
      if (friends.length === 0) {
        return `
          <div style="text-align: center; padding: 30px; color: var(--text-soft);">
            <i class="fas fa-user-friends" style="font-size: 32px; margin-bottom: 10px;"></i>
            <p>Adicione amigos para conversar!</p>
            <button class="module-button" onclick="loadSection('friends')" style="margin-top: 15px;">
              <i class="fas fa-user-plus"></i> Adicionar Amigos
            </button>
          </div>
        `;
      }
      
      return friends.map(friend => {
        const user = appState.users[friend];
        const isOnline = appState.onlineUsers[friend]?.status === 'online';
        const isAway = appState.onlineUsers[friend]?.status === 'away';
        
        // Contar mensagens não lidas
        const messages = appState.privateMessages[appState.currentUser][friend] || [];
        const unread = messages.filter(m => m.sender === friend && !m.read).length;
        
        // Última mensagem
        const lastMessage = messages.length > 0 ? messages[messages.length - 1] : null;
        
        return `
          <div class="contact-item ${friend === currentContact ? 'active' : ''}" onclick="openPrivateChat('${friend}')">
            <img src="${user.profile.avatarUrl || user.profile.avatar}" 
                 class="contact-avatar" alt="${friend}">
            <div class="contact-info">
              <div class="contact-name">${friend}</div>
              <div class="contact-status">
                <div class="status-indicator ${isOnline ? 'status-online-ind' : isAway ? 'status-away-ind' : 'status-offline-ind'}"></div>
                <span>${isOnline ? 'Online' : isAway ? 'Ausente' : 'Offline'}</span>
              </div>
              ${lastMessage ? `
                <div class="last-message">${lastMessage.content.substring(0, 30)}...</div>
              ` : ''}
            </div>
            ${unread > 0 ? `
              <div class="unread-badge">${unread}</div>
            ` : ''}
          </div>
        `;
      }).join('');
    }
    
    function renderPrivateMessages(friend) {
      const messages = appState.privateMessages[appState.currentUser][friend] || [];
      
      if (messages.length === 0) {
        return `
          <div style="text-align: center; padding: 40px; color: var(--text-soft);">
            <i class="fas fa-comments" style="font-size: 48px; margin-bottom: 15px;"></i>
            <p>Nenhuma mensagem ainda. Comece a conversa!</p>
          </div>
        `;
      }
      
      return messages.map(msg => {
        const isOwn = msg.sender === appState.currentUser;
        const hasFile = msg.file;
        
        return `
          <div class="message ${isOwn ? 'own' : 'other'}" id="pm-${msg.id}">
            <div class="message-header">
              <span class="message-author">${msg.sender}</span>
              <span class="message-time">${new Date(msg.timestamp).toLocaleTimeString()}</span>
            </div>
            
            ${msg.replyTo ? `
              <div class="message-reply">
                <strong>Respondendo a ${msg.replyTo.author}:</strong>
                ${msg.replyTo.content.substring(0, 50)}...
              </div>
            ` : ''}
            
            <div class="message-content">
              ${msg.content}
              ${hasFile ? renderFileAttachment(msg.file) : ''}
            </div>
            
            <div class="message-actions">
              <button class="message-action" onclick="replyToPrivateMessage('${msg.id}')">
                <i class="fas fa-reply"></i> Responder
              </button>
              ${isOwn ? `
                <button class="message-action" onclick="deletePrivateMessage('${msg.id}', '${friend}')">
                  <i class="fas fa-trash"></i> Apagar
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function openPrivateChat(friend) {
      currentContact = friend;
      currentReplyTo = null;
      currentFile = null;
      
      // Marcar mensagens como lidas
      markMessagesAsRead(friend);
      
      renderPrivateChat();
      
      // Scroll para baixo
      setTimeout(() => {
        const container = document.getElementById('privateMessagesContainer');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
    }
    
    function searchContacts(query) {
      const friends = appState.friends[appState.currentUser] || [];
      
      if (!query.trim()) {
        document.getElementById('contactsList').innerHTML = renderContactsList();
        return;
      }
      
      const filtered = friends.filter(f => 
        f.toLowerCase().includes(query.toLowerCase())
      );
      
      const html = filtered.map(friend => {
        const user = appState.users[friend];
        const isOnline = appState.onlineUsers[friend]?.status === 'online';
        const isAway = appState.onlineUsers[friend]?.status === 'away';
        
        const messages = appState.privateMessages[appState.currentUser][friend] || [];
        const unread = messages.filter(m => m.sender === friend && !m.read).length;
        
        return `
          <div class="contact-item ${friend === currentContact ? 'active' : ''}" onclick="openPrivateChat('${friend}')">
            <img src="${user.profile.avatarUrl || user.profile.avatar}" 
                 class="contact-avatar" alt="${friend}">
            <div class="contact-info">
              <div class="contact-name">${friend}</div>
              <div class="contact-status">
                <div class="status-indicator ${isOnline ? 'status-online-ind' : isAway ? 'status-away-ind' : 'status-offline-ind'}"></div>
                <span>${isOnline ? 'Online' : isAway ? 'Ausente' : 'Offline'}</span>
              </div>
            </div>
            ${unread > 0 ? `
              <div class="unread-badge">${unread}</div>
            ` : ''}
          </div>
        `;
      }).join('');
      
      document.getElementById('contactsList').innerHTML = html || 
        '<p style="text-align: center; padding: 20px; color: var(--text-soft);">Nenhum amigo encontrado.</p>';
    }
    
    function handlePrivateFileUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      // Validar tamanho (max 5MB)
      if (file.size > 5 * 1024 * 1024) {
        showToast('Arquivo muito grande! Máximo 5MB.', 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        currentFile = {
          name: file.name,
          type: file.type,
          size: file.size,
          data: e.target.result
        };
        renderPrivateChat();
      };
      
      reader.readAsDataURL(file);
    }
    
    function removeFilePrivate() {
      currentFile = null;
      renderPrivateChat();
    }
    
    function replyToPrivateMessage(messageId) {
      const messages = appState.privateMessages[appState.currentUser][currentContact] || [];
      const message = messages.find(m => m.id === messageId);
      
      if (message) {
        currentReplyTo = {
          id: message.id,
          author: message.sender,
          content: message.content
        };
        
        // Focar no input
        const input = document.getElementById('privateInput');
        input.focus();
        
        renderPrivateChat();
      }
    }
    
    function cancelReplyPrivate() {
      currentReplyTo = null;
      renderPrivateChat();
    }
    
    function sendPrivateMessage() {
      if (!currentContact) return;
      
      const input = document.getElementById('privateInput');
      const content = input.value.trim();
      
      if (!content && !currentFile) {
        showToast('Digite uma mensagem ou selecione um arquivo!', 'error');
        return;
      }
      
      const msg = {
        id: 'pm' + Date.now(),
        sender: appState.currentUser,
        receiver: currentContact,
        content: content || '(arquivo)',
        timestamp: new Date().toISOString(),
        read: false,
        replyTo: currentReplyTo || null,
        file: currentFile || null
      };
      
      // Salvar para o remetente
      if (!appState.privateMessages[appState.currentUser][currentContact]) {
        appState.privateMessages[appState.currentUser][currentContact] = [];
      }
      appState.privateMessages[appState.currentUser][currentContact].push(msg);
      
      // Salvar para o destinatário
      if (!appState.privateMessages[currentContact]) {
        appState.privateMessages[currentContact] = {};
      }
      if (!appState.privateMessages[currentContact][appState.currentUser]) {
        appState.privateMessages[currentContact][appState.currentUser] = [];
      }
      appState.privateMessages[currentContact][appState.currentUser].push(msg);
      
      saveState();
      
      // Resetar
      input.value = '';
      currentReplyTo = null;
      currentFile = null;
      
      // Atualizar mensagens
      document.getElementById('privateMessagesContainer').innerHTML = 
        renderPrivateMessages(currentContact);
      
      // Scroll para baixo
      setTimeout(() => {
        const container = document.getElementById('privateMessagesContainer');
        if (container) {
          container.scrollTop = container.scrollHeight;
        }
      }, 100);
      
      // Atualizar notificações
      updateNotificationBadges();
      
      // Notificar o destinatário se estiver online
      if (appState.onlineUsers[currentContact]) {
        showToast(`Mensagem enviada para ${currentContact}!`, 'success');
      }
    }
    
    function deletePrivateMessage(messageId, friend) {
      if (!confirm('Apagar esta mensagem?')) return;
      
      // Remover do remetente
      const senderMessages = appState.privateMessages[appState.currentUser][friend] || [];
      const senderIndex = senderMessages.findIndex(m => m.id === messageId && m.sender === appState.currentUser);
      
      if (senderIndex !== -1) {
        senderMessages.splice(senderIndex, 1);
      }
      
      // Remover do destinatário
      const receiverMessages = appState.privateMessages[friend][appState.currentUser] || [];
      const receiverIndex = receiverMessages.findIndex(m => m.id === messageId && m.sender === appState.currentUser);
      
      if (receiverIndex !== -1) {
        receiverMessages.splice(receiverIndex, 1);
      }
      
      saveState();
      renderPrivateChat();
      showToast('Mensagem apagada.', 'success');
    }
    
    function markMessagesAsRead(friend) {
      const messages = appState.privateMessages[appState.currentUser][friend];
      if (messages) {
        let updated = false;
        messages.forEach(msg => {
          if (msg.sender === friend && !msg.read) {
            msg.read = true;
            updated = true;
          }
        });
        if (updated) {
          saveState();
          updateNotificationBadges();
        }
      }
    }
    
    // ============================================
    // 11. SISTEMA DE AMIGOS (Página dedicada)
    // ============================================

    // ============================================
// 11. SISTEMA DE AMIGOS (Página dedicada) - CONTINUAÇÃO
// ============================================

function renderFriendsList() {
  const friends = appState.friends[appState.currentUser] || [];
  
  if (friends.length === 0) {
    return `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-soft);">
        <i class="fas fa-user-friends" style="font-size: 48px; margin-bottom: 15px;"></i>
        <p>Você ainda não tem amigos adicionados.</p>
        <p style="font-size: 14px; margin-top: 10px;">Busque por usuários abaixo para adicionar amigos!</p>
      </div>
    `;
  }
  
  return friends.map(friend => {
    const user = appState.users[friend];
    const isOnline = appState.onlineUsers[friend]?.status === 'online';
    const isAway = appState.onlineUsers[friend]?.status === 'away';
    
    return `
      <div class="friend-card">
        <img src="${user.profile.avatarUrl || user.profile.avatar}" 
             class="friend-avatar" alt="${friend}">
        <div class="friend-name">${friend}</div>
        <div class="friend-status">
          <div class="status-indicator ${isOnline ? 'status-online-ind' : isAway ? 'status-away-ind' : 'status-offline-ind'}"></div>
          <span>${isOnline ? 'Online agora' : isAway ? 'Ausente' : 'Offline'}</span>
        </div>
        <div class="friend-actions">
          <button class="module-button" onclick="openPrivateChat('${friend}')">
            <i class="fas fa-comment"></i> Chat
          </button>
          <button class="module-button success" onclick="viewProfile('${friend}')">
            <i class="fas fa-user"></i> Perfil
          </button>
          <button class="module-button danger" onclick="removeFriend('${friend}')">
            <i class="fas fa-user-times"></i> Remover
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function searchAllUsers(query) {
  const searchResultsDiv = document.getElementById('searchResults');
  
  if (!query.trim()) {
    searchResultsDiv.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--text-soft);">
        <i class="fas fa-search" style="font-size: 24px; margin-bottom: 10px;"></i>
        <p>Digite um nome de usuário para buscar</p>
      </div>
    `;
    return;
  }
  
  const currentUser = appState.currentUser;
  const friends = appState.friends[currentUser] || [];
  
  // Filtrar usuários (excluir o próprio usuário e amigos já existentes)
  const results = Object.keys(appState.users).filter(username => {
    return username.toLowerCase().includes(query.toLowerCase()) &&
           username !== currentUser &&
           !friends.includes(username);
  });
  
  if (results.length === 0) {
    searchResultsDiv.innerHTML = `
      <div style="text-align: center; padding: 20px; color: var(--text-soft);">
        <i class="fas fa-user-slash" style="font-size: 24px; margin-bottom: 10px;"></i>
        <p>Nenhum usuário encontrado</p>
      </div>
    `;
    return;
  }
  
  const html = results.map(username => {
    const user = appState.users[username];
    const isOnline = appState.onlineUsers[username]?.status === 'online';
    
    // Verificar se já existe solicitação pendente
    const hasPendingRequest = (appState.friendRequests[username] || []).some(
      req => req.from === currentUser && req.status === 'pending'
    );
    
    return `
      <div class="friend-request-item" style="margin-bottom: 15px;">
        <div class="friend-request-info">
          <img src="${user.profile.avatarUrl || user.profile.avatar}" 
               class="avatar avatar-small" alt="${username}">
          <div>
            <div style="font-weight: 500; color: var(--text-main);">${username}</div>
            <div style="font-size: 13px; color: var(--text-soft); display: flex; align-items: center; gap: 5px;">
              <span class="status-indicator ${isOnline ? 'status-online-ind' : 'status-offline-ind'}"></span>
              <span>${isOnline ? 'Online' : 'Offline'}</span>
            </div>
          </div>
        </div>
        <div class="friend-request-actions">
          <button class="module-button ${hasPendingRequest ? 'warning' : 'primary'}" 
                  onclick="${hasPendingRequest ? '' : `sendFriendRequest('${username}')`}" 
                  ${hasPendingRequest ? 'disabled' : ''}>
            <i class="fas ${hasPendingRequest ? 'fa-clock' : 'fa-user-plus'}"></i>
            ${hasPendingRequest ? 'Pendente' : 'Adicionar'}
          </button>
          <button class="module-button" onclick="viewProfile('${username}')">
            <i class="fas fa-eye"></i> Ver
          </button>
        </div>
      </div>
    `;
  }).join('');
  
  searchResultsDiv.innerHTML = html;
}

function viewProfile(username) {
  const user = appState.users[username];
  if (!user) return;
  
  const isFriend = appState.friends[appState.currentUser]?.includes(username);
  const isCurrentUser = username === appState.currentUser;
  const isOnline = appState.onlineUsers[username]?.status === 'online';
  const isAway = appState.onlineUsers[username]?.status === 'away';
  
  // Calcular estatísticas
  const userTheories = appState.theories.filter(t => t.author === username);
  const approvedTheories = userTheories.filter(t => t.status === 'approved');
  const forumPosts = appState.forumTopics.filter(t => t.author === username);
  const groups = appState.groups.filter(g => g.members.includes(username));
  
  // Abrir modal com perfil
  const modalContent = `
    <div class="content-header" style="border: none; padding-bottom: 0;">
      <h1>Perfil de ${username}</h1>
    </div>
    
    <div style="display: grid; grid-template-columns: 200px 1fr; gap: 30px; margin-bottom: 30px;">
      <div style="text-align: center;">
        <img src="${user.profile.avatarUrl || user.profile.avatar}" 
             class="avatar avatar-xlarge" alt="${username}">
        
        <div style="margin-top: 20px;">
          <div class="friend-status" style="justify-content: center; margin-bottom: 15px;">
            <div class="status-indicator ${isOnline ? 'status-online-ind' : isAway ? 'status-away-ind' : 'status-offline-ind'}"></div>
            <span style="font-weight: 500;">${isOnline ? 'Online' : isAway ? 'Ausente' : 'Offline'}</span>
          </div>
          
          ${!isCurrentUser ? `
            <div class="friend-actions" style="justify-content: center;">
              ${isFriend ? `
                <button class="module-button" onclick="openPrivateChat('${username}')" style="margin-bottom: 10px;">
                  <i class="fas fa-comment"></i> Mensagem
                </button>
                <button class="module-button danger" onclick="removeFriend('${username}')">
                  <i class="fas fa-user-times"></i> Remover
                </button>
              ` : `
                <button class="module-button primary" onclick="sendFriendRequest('${username}')">
                  <i class="fas fa-user-plus"></i> Adicionar
                </button>
              `}
            </div>
          ` : ''}
        </div>
      </div>
      
      <div>
        <div class="stats-grid" style="margin-bottom: 30px;">
          <div class="stat-card">
            <h3>Teorias</h3>
            <div class="stat-value">${userTheories.length}</div>
            <div class="stat-trend">
              <i class="fas fa-check"></i>
              <span>${approvedTheories.length} aprovadas</span>
            </div>
          </div>
          
          <div class="stat-card">
            <h3>Posts no Fórum</h3>
            <div class="stat-value">${forumPosts.length}</div>
          </div>
          
          <div class="stat-card">
            <h3>Grupos</h3>
            <div class="stat-value">${groups.length}</div>
          </div>
          
          <div class="stat-card">
            <h3>Amigos</h3>
            <div class="stat-value">${user.stats?.friends || 0}</div>
          </div>
        </div>
        
        <div class="module-container" style="margin-bottom: 20px;">
          <div class="module-header">
            <h2>Informações do Perfil</h2>
          </div>
          
          <div class="form-group">
            <label class="form-label">Biografia</label>
            <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; color: var(--text-soft); min-height: 80px;">
              ${user.profile?.bio || 'Nenhuma biografia fornecida.'}
            </div>
          </div>
          
          <div class="form-row">
            <div class="form-group">
              <label class="form-label">Área de Interesse</label>
              <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; color: var(--text-soft);">
                ${user.profile?.area || 'Não especificada'}
              </div>
            </div>
            
            <div class="form-group">
              <label class="form-label">Membro desde</label>
              <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; color: var(--text-soft);">
                ${new Date(user.createdAt).toLocaleDateString()}
              </div>
            </div>
          </div>
          
          ${user.profile?.links ? `
            <div class="form-group">
              <label class="form-label">Links</label>
              <div style="background: var(--bg-input); padding: 15px; border-radius: 8px; color: var(--accent); word-break: break-all;">
                ${user.profile.links}
              </div>
            </div>
          ` : ''}
        </div>
        
        ${isCurrentUser ? `
          <div class="module-actions">
            <button class="module-button primary" onclick="loadSection('profile')">
              <i class="fas fa-edit"></i> Editar Meu Perfil
            </button>
          </div>
        ` : ''}
      </div>
    </div>
  `;
  
  // Abrir em uma seção dedicada ou modal
  document.getElementById('mainContent').innerHTML = modalContent;
}

// ============================================
// 12. SISTEMA DE TEORIAS
// ============================================

function renderTheories() {
  const userTheories = appState.theories.filter(t => t.author === appState.currentUser);
  const otherTheories = appState.theories.filter(t => t.author !== appState.currentUser);
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Teorias Científicas</h1>
      <p>Compartilhe e discuta teorias científicas</p>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Minhas Teorias (${userTheories.length})</h2>
      </div>
      
      <div class="module-actions">
        <button class="module-button primary" onclick="showNewTheoryForm()">
          <i class="fas fa-plus"></i> Nova Teoria
        </button>
        <button class="module-button" onclick="filterTheories('draft')">
          <i class="fas fa-edit"></i> Rascunhos
        </button>
        <button class="module-button" onclick="filterTheories('pending')">
          <i class="fas fa-clock"></i> Pendentes
        </button>
        <button class="module-button success" onclick="filterTheories('approved')">
          <i class="fas fa-check"></i> Aprovadas
        </button>
      </div>
      
      <div class="theories-grid" id="myTheoriesList">
        ${renderUserTheories(userTheories)}
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Teorias da Comunidade (${otherTheories.length})</h2>
      </div>
      
      <div class="module-actions">
        <input type="text" id="searchTheories" class="form-control" 
               placeholder="Buscar teorias..." style="max-width: 300px;"
               onkeyup="searchTheories(this.value)">
      </div>
      
      <div class="theories-grid" id="communityTheories">
        ${renderCommunityTheories(otherTheories)}
      </div>
    </div>
  `;
}

function renderUserTheories(theories) {
  if (theories.length === 0) {
    return `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-soft);">
        <i class="fas fa-book" style="font-size: 48px; margin-bottom: 15px;"></i>
        <p>Você ainda não criou nenhuma teoria.</p>
        <button class="module-button primary" onclick="showNewTheoryForm()" style="margin-top: 15px;">
          <i class="fas fa-plus"></i> Criar Minha Primeira Teoria
        </button>
      </div>
    `;
  }
  
  return theories.slice().reverse().map(theory => {
    const statusClass = `status-${theory.status}`;
    const statusText = {
      'draft': 'Rascunho',
      'pending': 'Em Análise',
      'approved': 'Aprovada',
      'rejected': 'Rejeitada'
    }[theory.status] || theory.status;
    
    return `
      <div class="theory-card">
        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
          <h4>${theory.title}</h4>
          <span class="theory-status ${statusClass}">${statusText}</span>
        </div>
        
        <div class="theory-meta">
          <span><i class="fas fa-calendar"></i> ${new Date(theory.createdAt).toLocaleDateString()}</span>
          <span><i class="fas fa-comment"></i> ${theory.comments?.length || 0} comentários</span>
          ${theory.category ? `<span><i class="fas fa-tag"></i> ${theory.category}</span>` : ''}
        </div>
        
        <div class="theory-preview">
          ${theory.content.substring(0, 200)}...
        </div>
        
        <div class="theory-actions">
          <button class="module-button" onclick="viewTheory('${theory.id}')">
            <i class="fas fa-eye"></i> Ver
          </button>
          ${theory.status === 'draft' ? `
            <button class="module-button" onclick="editTheory('${theory.id}')">
              <i class="fas fa-edit"></i> Editar
            </button>
          ` : ''}
          ${theory.status === 'pending' ? `
            <button class="module-button danger" onclick="cancelSubmission('${theory.id}')">
              <i class="fas fa-times"></i> Cancelar
            </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

// Continua com as funções restantes do sistema de teorias, fórum, grupos, perfil, administração...

// ============================================
// 13. INICIALIZAÇÃO E FUNÇÕES DE UTILIDADE
// ============================================

function showAuthScreen() {
  document.getElementById('authScreen').classList.remove('hidden');
  document.getElementById('dashboard').classList.add('hidden');
}

function showDashboard() {
  document.getElementById('authScreen').classList.add('hidden');
  document.getElementById('dashboard').classList.remove('hidden');
  
  // Atualizar UI do usuário
  updateUserUI();
  
  // Carregar dashboard inicial
  loadSection('dashboard');
  
  // Atualizar usuários online
  updateOnlineUsersDisplay();
  
  // Atualizar notificações
  updateNotificationBadges();
}

function updateUserUI() {
  const user = appState.users[appState.currentUser];
  if (!user) return;
  
  // Atualizar nome de usuário
  const userElements = document.querySelectorAll('#currentUser, #userNameHeader');
  userElements.forEach(el => {
    if (el) el.textContent = appState.currentUser;
  });
  
  // Atualizar avatar
  const avatarElements = document.querySelectorAll('#userAvatarSidebar, #userAvatarHeader');
  avatarElements.forEach(el => {
    if (el) el.src = user.profile.avatarUrl || user.profile.avatar;
  });
  
  // Atualizar nível/role
  const roleElement = document.getElementById('userRole');
  const levelElement = document.getElementById('userLevel');
  
  if (appState.isNucleo) {
    if (roleElement) roleElement.textContent = 'Núcleo';
    if (levelElement) levelElement.textContent = 'Membro do Núcleo';
    document.getElementById('adminMenuItem')?.classList.remove('hidden');
  } else {
    if (roleElement) roleElement.textContent = 'Membro';
    if (levelElement) levelElement.textContent = 'Membro Regular';
    document.getElementById('adminMenuItem')?.classList.add('hidden');
  }
  
  // Atualizar status
  const statusSelector = document.getElementById('statusSelector');
  if (statusSelector) {
    statusSelector.value = appState.userStatus;
  }
  
  const statusDot = document.getElementById('userStatusDot');
  if (statusDot) {
    statusDot.className = 'status-dot status-' + appState.userStatus;
  }
}

function updateOnlineUsersDisplay() {
  const onlineFriendsList = document.getElementById('onlineFriendsList');
  if (!onlineFriendsList) return;
  
  const friends = appState.friends[appState.currentUser] || [];
  const onlineFriends = friends.filter(f => 
    appState.onlineUsers[f] && appState.onlineUsers[f].status === 'online'
  );
  
  if (onlineFriends.length === 0) {
    onlineFriendsList.innerHTML = `
      <div style="text-align: center; padding: 10px; color: var(--text-soft); font-size: 13px;">
        Nenhum amigo online
      </div>
    `;
    return;
  }
  
  onlineFriendsList.innerHTML = onlineFriends.slice(0, 5).map(friend => {
    const user = appState.users[friend];
    return `
      <div class="online-user" onclick="openPrivateChat('${friend}')">
        <img src="${user.profile.avatarUrl || user.profile.avatar}" 
             class="online-user-avatar" alt="${friend}">
        <div class="online-user-name">${friend}</div>
        <span class="status-dot status-online"></span>
      </div>
    `;
  }).join('');
  
  if (onlineFriends.length > 5) {
    onlineFriendsList.innerHTML += `
      <div style="text-align: center; padding: 5px; color: var(--text-soft); font-size: 12px;">
        +${onlineFriends.length - 5} outros
      </div>
    `;
  }
}

// ============================================
// 14. EVENT LISTENERS E INICIALIZAÇÃO
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  // Verificar autenticação
  checkAuth();
  
  // Menu mobile toggle
  document.getElementById('mobileMenuToggle').addEventListener('click', function() {
    document.getElementById('sidebar').classList.toggle('active');
  });
  
  // Status selector change
  document.getElementById('statusSelector')?.addEventListener('change', function() {
    updateUserStatus(this.value);
  });
  
  // Fechar menu ao clicar fora (mobile)
  document.addEventListener('click', function(event) {
    const sidebar = document.getElementById('sidebar');
    const toggle = document.getElementById('mobileMenuToggle');
    
    if (sidebar.classList.contains('active') && 
        !sidebar.contains(event.target) && 
        !toggle.contains(event.target)) {
      sidebar.classList.remove('active');
    }
  });
  
  // Permitir Enter no login
  document.getElementById('username')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') login();
  });
  
  document.getElementById('password')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') login();
  });
  
  document.getElementById('masterKey')?.addEventListener('keypress', function(e) {
    if (e.key === 'Enter') login();
  });
  
  // Simular alguns dados iniciais se necessário
  initializeSampleData();
});

function initializeSampleData() {
  // Verificar se já existem dados
  if (Object.keys(appState.users).length === 0) {
    // Criar alguns usuários de exemplo
    const sampleUsers = ['Einstein', 'Newton', 'Curie', 'Tesla', 'Hawking'];
    
    sampleUsers.forEach(username => {
      const avatarColor = generateAvatarColor(username);
      const avatarInitials = username.substring(0, 2).toUpperCase();
      const defaultAvatar = generateDefaultAvatar(avatarInitials, avatarColor);
      
      appState.users[username] = {
        password: '123456', // Senha simples para demonstração
        nucleo: username === 'Einstein', // Einstein é núcleo
        status: Math.random() > 0.5 ? 'online' : 'offline',
        createdAt: new Date().toISOString(),
        lastSeen: new Date().toISOString(),
        profile: {
          bio: `Cientista renomado especializado em ${username === 'Einstein' ? 'Relatividade' : 
                username === 'Newton' ? 'Mecânica Clássica' : 
                username === 'Curie' ? 'Radioatividade' : 
                username === 'Tesla' ? 'Eletromagnetismo' : 'Cosmologia'}.`,
          area: username === 'Einstein' ? 'Física Teórica' : 
                username === 'Newton' ? 'Física e Matemática' : 
                username === 'Curie' ? 'Física e Química' : 
                username === 'Tesla' ? 'Engenharia Elétrica' : 'Cosmologia',
          links: 'https://exemplo.com',
          avatar: defaultAvatar
        },
        stats: {
          theories: Math.floor(Math.random() * 10),
          forumPosts: Math.floor(Math.random() * 20),
          chatMessages: Math.floor(Math.random() * 50),
          files: Math.floor(Math.random() * 5),
          groups: Math.floor(Math.random() * 3),
          friends: Math.floor(Math.random() * 4)
        }
      };
      
      // Inicializar listas de amigos
      appState.friends[username] = sampleUsers
        .filter(u => u !== username && Math.random() > 0.5);
      
      appState.friendRequests[username] = [];
    });
    
    // Criar algumas teorias de exemplo
    const sampleTheories = [
      {
        id: 'theory1',
        title: 'A Teoria da Relatividade Geral',
        author: 'Einstein',
        content: 'A gravidade como curvatura do espaço-tempo...',
        category: 'Física',
        status: 'approved',
        createdAt: new Date().toISOString(),
        comments: []
      },
      {
        id: 'theory2',
        title: 'Leis do Movimento de Newton',
        author: 'Newton',
        content: 'As três leis fundamentais da mecânica clássica...',
        category: 'Física',
        status: 'approved',
        createdAt: new Date().toISOString(),
        comments: []
      }
    ];
    
    appState.theories = sampleTheories;
    
    // Criar alguns tópicos de fórum
    const sampleForumTopics = [
      {
        id: 'topic1',
        title: 'Discussão sobre Buracos Negros',
        author: 'Hawking',
        content: 'Quais são as implicações da radiação Hawking?',
        category: 'Astrofísica',
        createdAt: new Date().toISOString(),
        replies: []
      }
    ];
    
    appState.forumTopics = sampleForumTopics;
    
    // Salvar dados iniciais
    saveState();
  }
}

// ============================================
// 15. FUNÇÕES RESTANTES A SEREM IMPLEMENTADAS
// ============================================

// Nota: As seguintes funções precisam ser implementadas:
// - renderForum() - Sistema completo de fórum
// - renderGroups() - Sistema de grupos
// - renderFiles() - Sistema de arquivos
// - renderProfile() - Edição de perfil
// - renderAdmin() - Painel administrativo
// - Funções do sistema de teorias (showNewTheoryForm, viewTheory, etc.)
// - Funções do sistema de fórum
// - Funções do sistema de grupos
// - Funções do sistema de arquivos

// Para manter o código organizado, essas funções devem ser implementadas
// em módulos separados ou continuadas nesta mesma estrutura.

// Exemplo de função a ser implementada:
function renderForum() {
  // Implementar sistema de fórum completo
}

function renderGroups() {
  // Implementar sistema de grupos
}

function renderFiles() {
  // Implementar sistema de arquivos
}

function renderProfile() {
  // Implementar edição de perfil
}

function renderAdmin() {
  // Implementar painel administrativo (apenas para núcleo)
  if (!appState.isNucleo) {
    loadSection('dashboard');
    showToast('Acesso negrado! Apenas membros do núcleo.', 'error');
    return;
  }
  
  // Implementar painel admin
}

// ============================================
// 16. FINAL DO ARQUIVO PRINCIPAL
// ============================================

// ============================================
// 16. IMPLEMENTAÇÃO DAS FUNÇÕES RESTANTES
// ============================================

// ============================================
// 16.1 SISTEMA DE TEORIAS COMPLETO
// ============================================

function showNewTheoryForm() {
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Nova Teoria Científica</h1>
      <p>Compartilhe sua pesquisa com a comunidade</p>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Formulário de Submissão</h2>
      </div>
      
      <form id="theoryForm" onsubmit="submitTheory(event)">
        <div class="form-group">
          <label class="form-label">Título da Teoria *</label>
          <input type="text" id="theoryTitle" class="form-control" required 
                 placeholder="Ex: Teoria da Relatividade Geral">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Categoria *</label>
            <select id="theoryCategory" class="form-control" required>
              <option value="">Selecione uma categoria</option>
              <option value="fisica">Física</option>
              <option value="matematica">Matemática</option>
              <option value="quimica">Química</option>
              <option value="biologia">Biologia</option>
              <option value="astronomia">Astronomia</option>
              <option value="computacao">Ciência da Computação</option>
              <option value="engenharia">Engenharia</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Visibilidade</label>
            <select id="theoryVisibility" class="form-control">
              <option value="public">Pública (todos podem ver)</option>
              <option value="friends">Apenas Amigos</option>
              <option value="private">Privada (somente eu)</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Conteúdo da Teoria *</label>
          <div class="latex-toolbar">
            <button type="button" class="latex-btn" onclick="insertLatexIntoTheory('equation')">$$ Equação $$</button>
            <button type="button" class="latex-btn" onclick="insertLatexIntoTheory('matrix')">Matriz</button>
            <button type="button" class="latex-btn" onclick="insertLatexIntoTheory('integral')">∫ Integral</button>
            <button type="button" class="latex-btn" onclick="insertLatexIntoTheory('sum')">∑ Somatório</button>
          </div>
          <textarea id="theoryContent" class="form-control" rows="15" required
                    placeholder="Descreva sua teoria em detalhes. Use LaTeX para fórmulas matemáticas: $E=mc^2$"></textarea>
          
          <div class="math-preview" id="theoryPreview">
            <p style="color: var(--text-soft); font-style: italic;">Pré-visualização aparecerá aqui...</p>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Referências (opcional)</label>
          <textarea id="theoryReferences" class="form-control" rows="4"
                    placeholder="Cite suas fontes e referências bibliográficas"></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tags (separadas por vírgula)</label>
          <input type="text" id="theoryTags" class="form-control" 
                 placeholder="ex: relatividade, fisica, espaço-tempo">
        </div>
        
        <div class="module-actions">
          <button type="button" class="module-button" onclick="loadSection('theories')">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="button" class="module-button warning" onclick="saveTheoryAsDraft()">
            <i class="fas fa-save"></i> Salvar Rascunho
          </button>
          <button type="submit" class="module-button primary">
            <i class="fas fa-paper-plane"></i> Submeter para Análise
          </button>
        </div>
      </form>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2><i class="fas fa-lightbulb"></i> Dicas para uma Boa Submissão</h2>
      </div>
      <ul style="color: var(--text-soft); line-height: 1.6; padding-left: 20px;">
        <li>Seja claro e objetivo na explicação</li>
        <li>Use fórmulas matemáticas quando necessário (LaTeX)</li>
        <li>Inclua referências para trabalhos relacionados</li>
        <li>Verifique a consistência lógica da teoria</li>
        <li>Teorias serão revisadas pelo núcleo científico</li>
        <li>Status: <span class="status-pending">Pendente</span> → <span class="status-approved">Aprovada</span> ou <span class="status-rejected">Rejeitada</span></li>
      </ul>
    </div>
  `;
  
  // Adicionar evento para pré-visualização em tempo real
  document.getElementById('theoryContent').addEventListener('input', updateTheoryPreview);
}

function insertLatexIntoTheory(type) {
  const textarea = document.getElementById('theoryContent');
  const latexSnippets = {
    equation: '$$\\displaystyle{}$$',
    matrix: '\\begin{bmatrix} a & b \\\\ c & d \\end{bmatrix}',
    integral: '\\int_{a}^{b} f(x) dx',
    sum: '\\sum_{i=1}^{n} i = \\frac{n(n+1)}{2}',
    fraction: '\\frac{numerator}{denominator}',
    sqrt: '\\sqrt{x}',
    limit: '\\lim_{x \\to \\infty} f(x)'
  };
  
  const snippet = latexSnippets[type] || '$$\\displaystyle{}$$';
  const cursorPos = textarea.selectionStart;
  const text = textarea.value;
  const newText = text.substring(0, cursorPos) + snippet + text.substring(cursorPos);
  textarea.value = newText;
  textarea.focus();
  
  // Mover cursor para dentro dos colchetes
  const placeholderIndex = snippet.indexOf('{}');
  if (placeholderIndex !== -1) {
    textarea.setSelectionRange(cursorPos + placeholderIndex + 1, cursorPos + placeholderIndex + 1);
  }
  
  updateTheoryPreview();
}

function updateTheoryPreview() {
  const content = document.getElementById('theoryContent').value;
  const preview = document.getElementById('theoryPreview');
  
  if (!content.trim()) {
    preview.innerHTML = '<p style="color: var(--text-soft); font-style: italic;">Pré-visualização aparecerá aqui...</p>';
    return;
  }
  
  preview.innerHTML = content;
  
  // Atualizar MathJax
  setTimeout(() => {
    if (window.MathJax) {
      MathJax.typesetPromise([preview]);
    }
  }, 100);
}

function submitTheory(event) {
  event.preventDefault();
  
  const title = document.getElementById('theoryTitle').value.trim();
  const category = document.getElementById('theoryCategory').value;
  const content = document.getElementById('theoryContent').value.trim();
  const visibility = document.getElementById('theoryVisibility').value;
  const references = document.getElementById('theoryReferences').value.trim();
  const tags = document.getElementById('theoryTags').value.split(',').map(t => t.trim()).filter(t => t);
  
  if (!title || !category || !content) {
    showToast('Preencha todos os campos obrigatórios!', 'error');
    return;
  }
  
  const theory = {
    id: 'theory_' + Date.now(),
    title: title,
    author: appState.currentUser,
    content: content,
    category: category,
    status: 'pending',
    visibility: visibility,
    references: references,
    tags: tags,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    comments: [],
    upvotes: 0,
    downvotes: 0,
    views: 0
  };
  
  appState.theories.push(theory);
  
  // Atualizar estatísticas do usuário
  if (appState.users[appState.currentUser]) {
    appState.users[appState.currentUser].stats.theories++;
  }
  
  saveState();
  
  showToast('Teoria submetida para análise! Será revisada pelo núcleo científico.', 'success');
  
  // Notificar membros do núcleo
  Object.keys(appState.users).forEach(username => {
    if (appState.users[username].nucleo && username !== appState.currentUser) {
      addNotification(
        'Nova Teoria para Revisão',
        `${appState.currentUser} submeteu: "${title}"`,
        'info',
        `viewTheory('${theory.id}')`
      );
    }
  });
  
  loadSection('theories');
}

function saveTheoryAsDraft() {
  const title = document.getElementById('theoryTitle').value.trim();
  const category = document.getElementById('theoryCategory').value;
  const content = document.getElementById('theoryContent').value.trim();
  
  if (!title || !content) {
    showToast('Título e conteúdo são obrigatórios para salvar rascunho!', 'error');
    return;
  }
  
  const theory = {
    id: 'draft_' + Date.now(),
    title: title,
    author: appState.currentUser,
    content: content,
    category: category || 'outro',
    status: 'draft',
    visibility: 'private',
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    comments: []
  };
  
  appState.theories.push(theory);
  saveState();
  
  showToast('Rascunho salvo com sucesso!', 'success');
  loadSection('theories');
}

function viewTheory(theoryId) {
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory) {
    showToast('Teoria não encontrada!', 'error');
    loadSection('theories');
    return;
  }
  
  // Verificar permissões
  const canView = (
    theory.author === appState.currentUser ||
    theory.visibility === 'public' ||
    (theory.visibility === 'friends' && appState.friends[appState.currentUser]?.includes(theory.author)) ||
    appState.isNucleo
  );
  
  if (!canView) {
    showToast('Você não tem permissão para ver esta teoria!', 'error');
    loadSection('theories');
    return;
  }
  
  // Incrementar visualizações
  theory.views = (theory.views || 0) + 1;
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h1>${theory.title}</h1>
          <p>Por ${theory.author} • ${new Date(theory.createdAt).toLocaleDateString()} • 
             <span class="theory-status status-${theory.status}">${theory.status === 'draft' ? 'Rascunho' : 
               theory.status === 'pending' ? 'Em Análise' : 
               theory.status === 'approved' ? 'Aprovada' : 'Rejeitada'}</span></p>
        </div>
        <div class="module-actions" style="margin: 0;">
          ${theory.author === appState.currentUser && theory.status === 'draft' ? `
            <button class="module-button" onclick="editTheory('${theory.id}')">
              <i class="fas fa-edit"></i> Editar
            </button>
          ` : ''}
          ${appState.isNucleo && theory.status === 'pending' ? `
            <button class="module-button success" onclick="approveTheory('${theory.id}')">
              <i class="fas fa-check"></i> Aprovar
            </button>
            <button class="module-button danger" onclick="rejectTheory('${theory.id}')">
              <i class="fas fa-times"></i> Rejeitar
            </button>
          ` : ''}
          <button class="module-button" onclick="loadSection('theories')">
            <i class="fas fa-arrow-left"></i> Voltar
          </button>
        </div>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Conteúdo da Teoria</h2>
        <div style="display: flex; gap: 15px; font-size: 14px; color: var(--text-soft);">
          <span><i class="fas fa-eye"></i> ${theory.views || 0} visualizações</span>
          <span><i class="fas fa-comment"></i> ${theory.comments?.length || 0} comentários</span>
          <span><i class="fas fa-tag"></i> ${theory.category}</span>
        </div>
      </div>
      
      <div id="theoryContentDisplay" style="line-height: 1.8; font-size: 16px; color: var(--text-main);">
        ${theory.content}
      </div>
      
      ${theory.references ? `
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
          <h3 style="margin-bottom: 15px; color: var(--accent);">Referências</h3>
          <div style="color: var(--text-soft); white-space: pre-line;">${theory.references}</div>
        </div>
      ` : ''}
      
      ${theory.tags && theory.tags.length > 0 ? `
        <div style="margin-top: 20px;">
          <h4 style="color: var(--text-soft); margin-bottom: 10px;">Tags</h4>
          <div style="display: flex; flex-wrap: wrap; gap: 8px;">
            ${theory.tags.map(tag => `
              <span style="background: var(--bg-card); padding: 5px 12px; border-radius: 15px; font-size: 13px;">
                ${tag}
              </span>
            `).join('')}
          </div>
        </div>
      ` : ''}
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Comentários (${theory.comments?.length || 0})</h2>
      </div>
      
      ${theory.status === 'approved' || theory.author === appState.currentUser ? `
        <div class="form-group">
          <textarea id="newComment" class="form-control" rows="3" placeholder="Adicione um comentário..."></textarea>
          <div class="module-actions" style="margin-top: 15px;">
            <button class="module-button primary" onclick="addComment('${theory.id}')">
              <i class="fas fa-paper-plane"></i> Publicar Comentário
            </button>
          </div>
        </div>
      ` : '<p style="color: var(--text-soft); text-align: center; padding: 20px;">Comentários habilitados após aprovação.</p>'}
      
      <div id="commentsList" style="margin-top: 30px;">
        ${renderComments(theory.comments || [])}
      </div>
    </div>
  `;
  
  // Atualizar MathJax
  setTimeout(() => {
    if (window.MathJax) {
      MathJax.typesetPromise([document.getElementById('theoryContentDisplay')]);
    }
  }, 200);
}

function renderComments(comments) {
  if (comments.length === 0) {
    return '<p style="text-align: center; color: var(--text-soft); padding: 20px;">Nenhum comentário ainda. Seja o primeiro!</p>';
  }
  
  return comments.map(comment => `
    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <img src="${appState.users[comment.author]?.profile?.avatarUrl || 
                    appState.users[comment.author]?.profile?.avatar || ''}" 
               class="avatar avatar-small" alt="${comment.author}">
          <div>
            <div style="font-weight: 500;">${comment.author}</div>
            <div style="font-size: 12px; color: var(--text-soft);">
              ${new Date(comment.timestamp).toLocaleString()}
            </div>
          </div>
        </div>
        ${comment.author === appState.currentUser || appState.isNucleo ? `
          <button class="message-action" onclick="deleteComment('${comment.id}')">
            <i class="fas fa-trash"></i>
          </button>
        ` : ''}
      </div>
      <div style="color: var(--text-main); line-height: 1.6; padding-left: 50px;">
        ${comment.content}
      </div>
    </div>
  `).join('');
}

function addComment(theoryId) {
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory) return;
  
  const commentInput = document.getElementById('newComment');
  const content = commentInput.value.trim();
  
  if (!content) {
    showToast('Digite um comentário!', 'error');
    return;
  }
  
  const comment = {
    id: 'comment_' + Date.now(),
    author: appState.currentUser,
    content: content,
    timestamp: new Date().toISOString()
  };
  
  if (!theory.comments) theory.comments = [];
  theory.comments.push(comment);
  
  // Notificar o autor da teoria
  if (theory.author !== appState.currentUser) {
    addNotification(
      'Novo Comentário na Sua Teoria',
      `${appState.currentUser} comentou em "${theory.title}"`,
      'info',
      `viewTheory('${theory.id}')`
    );
  }
  
  saveState();
  
  commentInput.value = '';
  document.getElementById('commentsList').innerHTML = renderComments(theory.comments);
  showToast('Comentário adicionado!', 'success');
}

function deleteComment(commentId) {
  // Encontrar a teoria que contém o comentário
  for (const theory of appState.theories) {
    const commentIndex = theory.comments?.findIndex(c => c.id === commentId);
    if (commentIndex !== -1 && commentIndex !== undefined) {
      // Verificar permissão
      if (theory.comments[commentIndex].author === appState.currentUser || appState.isNucleo) {
        theory.comments.splice(commentIndex, 1);
        saveState();
        showToast('Comentário removido!', 'success');
        // Recarregar a teoria atual
        viewTheory(theory.id);
        return;
      }
    }
  }
}

function editTheory(theoryId) {
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory || theory.author !== appState.currentUser || theory.status !== 'draft') {
    showToast('Não é possível editar esta teoria!', 'error');
    loadSection('theories');
    return;
  }
  
  showNewTheoryForm();
  
  // Preencher os campos com os dados existentes
  setTimeout(() => {
    document.getElementById('theoryTitle').value = theory.title;
    document.getElementById('theoryCategory').value = theory.category;
    document.getElementById('theoryContent').value = theory.content;
    document.getElementById('theoryVisibility').value = theory.visibility;
    document.getElementById('theoryReferences').value = theory.references || '';
    document.getElementById('theoryTags').value = theory.tags?.join(', ') || '';
    
    updateTheoryPreview();
    
    // Substituir o botão de submit
    const form = document.getElementById('theoryForm');
    form.onsubmit = function(event) {
      event.preventDefault();
      updateTheory(theoryId);
    };
    
    const submitBtn = form.querySelector('.module-button.primary');
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Teoria';
    submitBtn.type = 'button';
    submitBtn.onclick = () => updateTheory(theoryId);
  }, 100);
}

function updateTheory(theoryId) {
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory) return;
  
  theory.title = document.getElementById('theoryTitle').value.trim();
  theory.category = document.getElementById('theoryCategory').value;
  theory.content = document.getElementById('theoryContent').value.trim();
  theory.visibility = document.getElementById('theoryVisibility').value;
  theory.references = document.getElementById('theoryReferences').value.trim();
  theory.tags = document.getElementById('theoryTags').value.split(',').map(t => t.trim()).filter(t => t);
  theory.updatedAt = new Date().toISOString();
  
  saveState();
  showToast('Teoria atualizada com sucesso!', 'success');
  loadSection('theories');
}

function approveTheory(theoryId) {
  if (!appState.isNucleo) {
    showToast('Apenas membros do núcleo podem aprovar teorias!', 'error');
    return;
  }
  
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory) return;
  
  theory.status = 'approved';
  theory.approvedBy = appState.currentUser;
  theory.approvedAt = new Date().toISOString();
  
  // Notificar o autor
  addNotification(
    'Teoria Aprovada!',
    `Sua teoria "${theory.title}" foi aprovada pelo núcleo científico.`,
    'success',
    `viewTheory('${theory.id}')`
  );
  
  saveState();
  showToast('Teoria aprovada com sucesso!', 'success');
  viewTheory(theoryId);
}

function rejectTheory(theoryId) {
  if (!appState.isNucleo) {
    showToast('Apenas membros do núcleo podem rejeitar teorias!', 'error');
    return;
  }
  
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory) return;
  
  const reason = prompt('Informe o motivo da rejeição:');
  if (!reason) return;
  
  theory.status = 'rejected';
  theory.rejectedBy = appState.currentUser;
  theory.rejectedAt = new Date().toISOString();
  theory.rejectionReason = reason;
  
  // Notificar o autor
  addNotification(
    'Teoria Rejeitada',
    `Sua teoria "${theory.title}" foi rejeitada. Motivo: ${reason}`,
    'error',
    `viewTheory('${theory.id}')`
  );
  
  saveState();
  showToast('Teoria rejeitada.', 'info');
  viewTheory(theoryId);
}

function cancelSubmission(theoryId) {
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory || theory.author !== appState.currentUser || theory.status !== 'pending') {
    showToast('Não é possível cancelar esta submissão!', 'error');
    return;
  }
  
  theory.status = 'draft';
  saveState();
  showToast('Submissão cancelada. Teoria voltou para rascunhos.', 'success');
  loadSection('theories');
}

function filterTheories(filter) {
  const userTheories = appState.theories.filter(t => t.author === appState.currentUser);
  const filtered = userTheories.filter(t => t.status === filter);
  
  document.getElementById('myTheoriesList').innerHTML = renderUserTheories(filtered);
}

function searchTheories(query) {
  const otherTheories = appState.theories.filter(t => t.author !== appState.currentUser && t.status === 'approved');
  
  if (!query.trim()) {
    document.getElementById('communityTheories').innerHTML = renderCommunityTheories(otherTheories);
    return;
  }
  
  const filtered = otherTheories.filter(theory => 
    theory.title.toLowerCase().includes(query.toLowerCase()) ||
    theory.content.toLowerCase().includes(query.toLowerCase()) ||
    theory.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase())) ||
    theory.category.toLowerCase().includes(query.toLowerCase())
  );
  
  document.getElementById('communityTheories').innerHTML = renderCommunityTheories(filtered);
}

function renderCommunityTheories(theories) {
  if (theories.length === 0) {
    return `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-soft);">
        <i class="fas fa-search" style="font-size: 48px; margin-bottom: 15px;"></i>
        <p>Nenhuma teoria encontrada.</p>
      </div>
    `;
  }
  
  return theories.slice().reverse().map(theory => {
    const isUpvoted = theory.upvotedBy?.includes(appState.currentUser);
    const isDownvoted = theory.downvotedBy?.includes(appState.currentUser);
    
    return `
      <div class="theory-card">
        <h4>${theory.title}</h4>
        
        <div class="theory-meta">
          <span><i class="fas fa-user"></i> ${theory.author}</span>
          <span><i class="fas fa-calendar"></i> ${new Date(theory.createdAt).toLocaleDateString()}</span>
          <span><i class="fas fa-comment"></i> ${theory.comments?.length || 0}</span>
          <span><i class="fas fa-eye"></i> ${theory.views || 0}</span>
        </div>
        
        <div class="theory-preview">
          ${theory.content.substring(0, 150)}...
        </div>
        
        <div class="theory-actions">
          <button class="module-button" onclick="viewTheory('${theory.id}')">
            <i class="fas fa-eye"></i> Ler
          </button>
          <button class="module-button ${isUpvoted ? 'success' : ''}" 
                  onclick="voteTheory('${theory.id}', 'up')" style="padding: 8px 12px;">
            <i class="fas fa-arrow-up"></i> ${theory.upvotes || 0}
          </button>
          <button class="module-button ${isDownvoted ? 'danger' : ''}" 
                  onclick="voteTheory('${theory.id}', 'down')" style="padding: 8px 12px;">
            <i class="fas fa-arrow-down"></i> ${theory.downvotes || 0}
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function voteTheory(theoryId, type) {
  const theory = appState.theories.find(t => t.id === theoryId);
  if (!theory) return;
  
  // Inicializar arrays se não existirem
  if (!theory.upvotedBy) theory.upvotedBy = [];
  if (!theory.downvotedBy) theory.downvotedBy = [];
  if (!theory.upvotes) theory.upvotes = 0;
  if (!theory.downvotes) theory.downvotes = 0;
  
  const alreadyUpvoted = theory.upvotedBy.includes(appState.currentUser);
  const alreadyDownvoted = theory.downvotedBy.includes(appState.currentUser);
  
  if (type === 'up') {
    if (alreadyUpvoted) {
      // Remover upvote
      theory.upvotedBy = theory.upvotedBy.filter(u => u !== appState.currentUser);
      theory.upvotes--;
    } else {
      // Adicionar upvote
      theory.upvotedBy.push(appState.currentUser);
      theory.upvotes++;
      
      // Remover downvote se existir
      if (alreadyDownvoted) {
        theory.downvotedBy = theory.downvotedBy.filter(u => u !== appState.currentUser);
        theory.downvotes--;
      }
    }
  } else if (type === 'down') {
    if (alreadyDownvoted) {
      // Remover downvote
      theory.downvotedBy = theory.downvotedBy.filter(u => u !== appState.currentUser);
      theory.downvotes--;
    } else {
      // Adicionar downvote
      theory.downvotedBy.push(appState.currentUser);
      theory.downvotes++;
      
      // Remover upvote se existir
      if (alreadyUpvoted) {
        theory.upvotedBy = theory.upvotedBy.filter(u => u !== appState.currentUser);
        theory.upvotes--;
      }
    }
  }
  
  saveState();
  
  // Recarregar a seção de teorias
  if (document.getElementById('mainContent').innerHTML.includes('Teorias da Comunidade')) {
    const otherTheories = appState.theories.filter(t => t.author !== appState.currentUser && t.status === 'approved');
    document.getElementById('communityTheories').innerHTML = renderCommunityTheories(otherTheories);
  }
}

// ============================================
// 16.2 SISTEMA DE FÓRUM COMPLETO
// ============================================

function renderForum() {
  const topics = appState.forumTopics;
  const pinnedTopics = topics.filter(t => t.pinned);
  const regularTopics = topics.filter(t => !t.pinned);
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Fórum de Discussão</h1>
      <p>Discuta tópicos científicos com a comunidade</p>
    </div>
    
    <div class="module-container">
      <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Tópicos do Fórum</h2>
        <button class="module-button primary" onclick="showNewTopicForm()">
          <i class="fas fa-plus"></i> Novo Tópico
        </button>
      </div>
      
      <div class="forum-table-container">
        <table class="forum-table">
          <thead>
            <tr>
              <th style="width: 50%;">Tópico</th>
              <th>Autor</th>
              <th>Respostas</th>
              <th>Última Atividade</th>
            </tr>
          </thead>
          <tbody id="forumTopicsList">
            ${renderForumTopics(pinnedTopics.concat(regularTopics))}
          </tbody>
        </table>
      </div>
      
      <div class="module-actions" style="margin-top: 20px;">
        <input type="text" id="forumSearch" class="form-control" style="max-width: 300px;"
               placeholder="Buscar tópicos..." onkeyup="searchForumTopics(this.value)">
        <select id="forumCategoryFilter" class="form-control" style="max-width: 200px;" 
                onchange="filterForumByCategory(this.value)">
          <option value="">Todas as Categorias</option>
          <option value="fisica">Física</option>
          <option value="matematica">Matemática</option>
          <option value="quimica">Química</option>
          <option value="biologia">Biologia</option>
          <option value="astronomia">Astronomia</option>
          <option value="duvida">Dúvida</option>
          <option value="debate">Debate</option>
          <option value="noticia">Notícia</option>
        </select>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Estatísticas do Fórum</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Tópicos</h3>
          <div class="stat-value">${topics.length}</div>
        </div>
        <div class="stat-card">
          <h3>Respostas</h3>
          <div class="stat-value">${topics.reduce((sum, topic) => sum + (topic.replies?.length || 0), 0)}</div>
        </div>
        <div class="stat-card">
          <h3>Usuários Ativos</h3>
          <div class="stat-value">${new Set(topics.flatMap(t => [t.author, ...(t.replies?.map(r => r.author) || [])])).size}</div>
        </div>
        <div class="stat-card">
          <h3>Tópicos Hoje</h3>
          <div class="stat-value">${topics.filter(t => isToday(new Date(t.createdAt))).length}</div>
        </div>
      </div>
    </div>
  `;
}

function renderForumTopics(topics) {
  if (topics.length === 0) {
    return `
      <tr>
        <td colspan="4" style="text-align: center; padding: 40px; color: var(--text-soft);">
          <i class="fas fa-comments" style="font-size: 32px; margin-bottom: 10px;"></i>
          <p>Nenhum tópico ainda. Seja o primeiro a criar um!</p>
        </td>
      </tr>
    `;
  }
  
  return topics.map(topic => {
    const lastReply = topic.replies && topic.replies.length > 0 
      ? topic.replies[topic.replies.length - 1] 
      : null;
    
    return `
      <tr class="${topic.pinned ? 'pinned-topic' : ''}" onclick="viewForumTopic('${topic.id}')" style="cursor: pointer;">
        <td>
          <div class="topic-title">
            ${topic.pinned ? '<i class="fas fa-thumbtack" style="color: var(--accent-secondary); margin-right: 8px;"></i>' : ''}
            ${topic.title}
          </div>
          <div class="topic-excerpt">${topic.content.substring(0, 80)}...</div>
          <div style="display: flex; gap: 10px; margin-top: 8px;">
            <span style="font-size: 12px; color: var(--accent); background: rgba(74, 111, 165, 0.1); padding: 2px 8px; border-radius: 10px;">
              ${topic.category}
            </span>
            ${topic.tags?.map(tag => `
              <span style="font-size: 12px; color: var(--text-soft); background: var(--bg-input); padding: 2px 8px; border-radius: 10px;">
                ${tag}
              </span>
            `).join('')}
          </div>
        </td>
        <td>
          <div style="display: flex; align-items: center; gap: 8px;">
            <img src="${appState.users[topic.author]?.profile?.avatarUrl || 
                      appState.users[topic.author]?.profile?.avatar || ''}" 
                 class="avatar avatar-small" alt="${topic.author}">
            <span>${topic.author}</span>
          </div>
        </td>
        <td>
          <div style="text-align: center;">
            <span style="font-weight: 500;">${topic.replies?.length || 0}</span>
            <div style="font-size: 12px; color: var(--text-soft);">respostas</div>
          </div>
        </td>
        <td>
          ${lastReply ? `
            <div>
              <div style="font-size: 13px;">${new Date(lastReply.timestamp).toLocaleDateString()}</div>
              <div style="font-size: 12px; color: var(--text-soft);">por ${lastReply.author}</div>
            </div>
          ` : `
            <div style="font-size: 13px; color: var(--text-soft);">
              ${new Date(topic.createdAt).toLocaleDateString()}
            </div>
          `}
        </td>
      </tr>
    `;
  }).join('');
}

function showNewTopicForm() {
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Novo Tópico no Fórum</h1>
      <p>Crie uma discussão para a comunidade</p>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Formulário do Tópico</h2>
      </div>
      
      <form id="topicForm" onsubmit="submitTopic(event)">
        <div class="form-group">
          <label class="form-label">Título do Tópico *</label>
          <input type="text" id="topicTitle" class="form-control" required 
                 placeholder="Ex: Discussão sobre Mecânica Quântica">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Categoria *</label>
            <select id="topicCategory" class="form-control" required>
              <option value="">Selecione uma categoria</option>
              <option value="fisica">Física</option>
              <option value="matematica">Matemática</option>
              <option value="quimica">Química</option>
              <option value="biologia">Biologia</option>
              <option value="astronomia">Astronomia</option>
              <option value="computacao">Computação</option>
              <option value="engenharia">Engenharia</option>
              <option value="duvida">Dúvida</option>
              <option value="debate">Debate</option>
              <option value="noticia">Notícia</option>
              <option value="geral">Geral</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Tags (separadas por vírgula)</label>
            <input type="text" id="topicTags" class="form-control" 
                   placeholder="ex: quantica, fisica, eletrons">
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Conteúdo *</label>
          <textarea id="topicContent" class="form-control" rows="10" required
                    placeholder="Descreva seu tópico em detalhes. Use LaTeX para fórmulas: $\\psi(x)$"></textarea>
        </div>
        
        ${appState.isNucleo ? `
          <div class="form-group">
            <label class="form-label">
              <input type="checkbox" id="topicPinned"> Fixar tópico (apenas núcleo)
            </label>
          </div>
        ` : ''}
        
        <div class="module-actions">
          <button type="button" class="module-button" onclick="loadSection('forum')">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="module-button primary">
            <i class="fas fa-paper-plane"></i> Criar Tópico
          </button>
        </div>
      </form>
    </div>
  `;
}

function submitTopic(event) {
  event.preventDefault();
  
  const title = document.getElementById('topicTitle').value.trim();
  const category = document.getElementById('topicCategory').value;
  const content = document.getElementById('topicContent').value.trim();
  const tags = document.getElementById('topicTags').value.split(',').map(t => t.trim()).filter(t => t);
  const pinned = appState.isNucleo && document.getElementById('topicPinned')?.checked;
  
  if (!title || !category || !content) {
    showToast('Preencha todos os campos obrigatórios!', 'error');
    return;
  }
  
  const topic = {
    id: 'topic_' + Date.now(),
    title: title,
    author: appState.currentUser,
    content: content,
    category: category,
    tags: tags,
    pinned: pinned || false,
    createdAt: new Date().toISOString(),
    updatedAt: new Date().toISOString(),
    replies: [],
    views: 0,
    locked: false
  };
  
  appState.forumTopics.push(topic);
  
  // Atualizar estatísticas do usuário
  if (appState.users[appState.currentUser]) {
    appState.users[appState.currentUser].stats.forumPosts++;
  }
  
  saveState();
  showToast('Tópico criado com sucesso!', 'success');
  loadSection('forum');
}

function viewForumTopic(topicId) {
  const topic = appState.forumTopics.find(t => t.id === topicId);
  if (!topic) {
    showToast('Tópico não encontrado!', 'error');
    loadSection('forum');
    return;
  }
  
  // Incrementar visualizações
  topic.views = (topic.views || 0) + 1;
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h1>${topic.title}</h1>
          <p>
            Por ${topic.author} • ${new Date(topic.createdAt).toLocaleDateString()} • 
            <span style="color: var(--accent); background: rgba(74, 111, 165, 0.1); padding: 2px 8px; border-radius: 10px;">
              ${topic.category}
            </span>
            ${topic.pinned ? '<span style="color: var(--accent-secondary); margin-left: 10px;"><i class="fas fa-thumbtack"></i> Fixado</span>' : ''}
            ${topic.locked ? '<span style="color: var(--danger); margin-left: 10px;"><i class="fas fa-lock"></i> Trancado</span>' : ''}
          </p>
        </div>
        <div class="module-actions" style="margin: 0;">
          ${(appState.isNucleo || topic.author === appState.currentUser) && !topic.locked ? `
            <button class="module-button" onclick="editTopic('${topic.id}')">
              <i class="fas fa-edit"></i> Editar
            </button>
          ` : ''}
          ${appState.isNucleo ? `
            <button class="module-button ${topic.pinned ? 'warning' : ''}" onclick="togglePinTopic('${topic.id}')">
              <i class="fas fa-thumbtack"></i> ${topic.pinned ? 'Desfixar' : 'Fixar'}
            </button>
            <button class="module-button ${topic.locked ? 'success' : 'danger'}" onclick="toggleLockTopic('${topic.id}')">
              <i class="fas ${topic.locked ? 'fa-unlock' : 'fa-lock'}"></i> ${topic.locked ? 'Destrancar' : 'Trancar'}
            </button>
          ` : ''}
          <button class="module-button" onclick="loadSection('forum')">
            <i class="fas fa-arrow-left"></i> Voltar
          </button>
        </div>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Discussão</h2>
        <div style="display: flex; gap: 15px; font-size: 14px; color: var(--text-soft);">
          <span><i class="fas fa-eye"></i> ${topic.views || 0} visualizações</span>
          <span><i class="fas fa-comment"></i> ${topic.replies?.length || 0} respostas</span>
        </div>
      </div>
      
      <!-- Post Original -->
      <div style="padding: 25px; background: var(--bg-card); border-radius: 8px; margin-bottom: 20px;">
        <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
          <div style="display: flex; align-items: center; gap: 12px;">
            <img src="${appState.users[topic.author]?.profile?.avatarUrl || 
                      appState.users[topic.author]?.profile?.avatar || ''}" 
                 class="avatar avatar-medium" alt="${topic.author}">
            <div>
              <div style="font-weight: 500; font-size: 16px;">${topic.author}</div>
              <div style="font-size: 13px; color: var(--text-soft);">
                ${new Date(topic.createdAt).toLocaleString()}
                ${topic.updatedAt !== topic.createdAt ? ` (editado ${new Date(topic.updatedAt).toLocaleDateString()})` : ''}
              </div>
            </div>
          </div>
        </div>
        
        <div style="line-height: 1.7; color: var(--text-main); padding: 0 10px;">
          ${topic.content}
        </div>
        
        ${topic.tags && topic.tags.length > 0 ? `
          <div style="margin-top: 20px; padding-top: 15px; border-top: 1px solid var(--border);">
            <div style="display: flex; flex-wrap: wrap; gap: 8px;">
              ${topic.tags.map(tag => `
                <span style="background: var(--bg-input); padding: 5px 12px; border-radius: 15px; font-size: 13px; color: var(--text-soft);">
                  ${tag}
                </span>
              `).join('')}
            </div>
          </div>
        ` : ''}
      </div>
      
      <!-- Respostas -->
      <h3 style="margin: 30px 0 20px; color: var(--text-main);">Respostas (${topic.replies?.length || 0})</h3>
      
      <div id="topicReplies">
        ${renderTopicReplies(topic.replies || [])}
      </div>
      
      <!-- Formulário de Resposta -->
      ${!topic.locked ? `
        <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border);">
          <div class="form-group">
            <label class="form-label">Sua Resposta</label>
            <textarea id="newReply" class="form-control" rows="5" 
                      placeholder="Escreva sua resposta aqui..."></textarea>
          </div>
          <div class="module-actions">
            <button class="module-button primary" onclick="addReply('${topic.id}')">
              <i class="fas fa-paper-plane"></i> Publicar Resposta
            </button>
          </div>
        </div>
      ` : `
        <div style="text-align: center; padding: 30px; color: var(--text-soft);">
          <i class="fas fa-lock" style="font-size: 32px; margin-bottom: 10px;"></i>
          <p>Este tópico está trancado. Não é possível adicionar novas respostas.</p>
        </div>
      `}
    </div>
  `;
  
  // Atualizar MathJax
  setTimeout(() => {
    if (window.MathJax) {
      MathJax.typesetPromise();
    }
  }, 200);
}

function renderTopicReplies(replies) {
  if (replies.length === 0) {
    return `
      <div style="text-align: center; padding: 30px; color: var(--text-soft);">
        <i class="fas fa-comments" style="font-size: 32px; margin-bottom: 10px;"></i>
        <p>Nenhuma resposta ainda. Seja o primeiro a responder!</p>
      </div>
    `;
  }
  
  return replies.map((reply, index) => `
    <div style="padding: 20px; border-bottom: 1px solid var(--border); ${index === replies.length - 1 ? 'border-bottom: none;' : ''}">
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <img src="${appState.users[reply.author]?.profile?.avatarUrl || 
                    appState.users[reply.author]?.profile?.avatar || ''}" 
               class="avatar avatar-small" alt="${reply.author}">
          <div>
            <div style="font-weight: 500;">${reply.author}</div>
            <div style="font-size: 12px; color: var(--text-soft);">
              #${index + 1} • ${new Date(reply.timestamp).toLocaleString()}
            </div>
          </div>
        </div>
        ${(appState.isNucleo || reply.author === appState.currentUser) ? `
          <div style="display: flex; gap: 8px;">
            <button class="message-action" onclick="editReply('${reply.id}', '${reply.content.replace(/'/g, "\\'")}')">
              <i class="fas fa-edit"></i>
            </button>
            <button class="message-action" onclick="deleteReply('${reply.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        ` : ''}
      </div>
      <div style="line-height: 1.6; color: var(--text-main); padding-left: 50px;" id="reply-content-${reply.id}">
        ${reply.content}
      </div>
    </div>
  `).join('');
}

function addReply(topicId) {
  const topic = appState.forumTopics.find(t => t.id === topicId);
  if (!topic || topic.locked) return;
  
  const replyInput = document.getElementById('newReply');
  const content = replyInput.value.trim();
  
  if (!content) {
    showToast('Digite uma resposta!', 'error');
    return;
  }
  
  const reply = {
    id: 'reply_' + Date.now(),
    author: appState.currentUser,
    content: content,
    timestamp: new Date().toISOString()
  };
  
  if (!topic.replies) topic.replies = [];
  topic.replies.push(reply);
  topic.updatedAt = new Date().toISOString();
  
  // Notificar o autor do tópico
  if (topic.author !== appState.currentUser) {
    addNotification(
      'Nova Resposta no Seu Tópico',
      `${appState.currentUser} respondeu em "${topic.title}"`,
      'info',
      `viewForumTopic('${topic.id}')`
    );
  }
  
  saveState();
  
  replyInput.value = '';
  document.getElementById('topicReplies').innerHTML = renderTopicReplies(topic.replies);
  showToast('Resposta publicada!', 'success');
}

function editReply(replyId, oldContent) {
  const newContent = prompt('Editar resposta:', oldContent);
  if (!newContent || newContent.trim() === oldContent) return;
  
  // Encontrar o tópico que contém a resposta
  for (const topic of appState.forumTopics) {
    const reply = topic.replies?.find(r => r.id === replyId);
    if (reply && (reply.author === appState.currentUser || appState.isNucleo)) {
      reply.content = newContent.trim();
      reply.edited = true;
      reply.editedAt = new Date().toISOString();
      topic.updatedAt = new Date().toISOString();
      saveState();
      
      // Atualizar exibição
      const replyElement = document.getElementById(`reply-content-${replyId}`);
      if (replyElement) {
        replyElement.innerHTML = newContent.trim();
      }
      
      showToast('Resposta atualizada!', 'success');
      return;
    }
  }
}

function deleteReply(replyId) {
  if (!confirm('Excluir esta resposta?')) return;
  
  // Encontrar o tópico que contém a resposta
  for (const topic of appState.forumTopics) {
    const replyIndex = topic.replies?.findIndex(r => r.id === replyId);
    if (replyIndex !== -1 && replyIndex !== undefined) {
      // Verificar permissão
      const reply = topic.replies[replyIndex];
      if (reply.author === appState.currentUser || appState.isNucleo) {
        topic.replies.splice(replyIndex, 1);
        topic.updatedAt = new Date().toISOString();
        saveState();
        
        // Recarregar o tópico
        viewForumTopic(topic.id);
        showToast('Resposta excluída!', 'success');
        return;
      }
    }
  }
}

function editTopic(topicId) {
  const topic = appState.forumTopics.find(t => t.id === topicId);
  if (!topic || (topic.author !== appState.currentUser && !appState.isNucleo) || topic.locked) {
    showToast('Não é possível editar este tópico!', 'error');
    return;
  }
  
  showNewTopicForm();
  
  // Preencher os campos
  setTimeout(() => {
    document.getElementById('topicTitle').value = topic.title;
    document.getElementById('topicCategory').value = topic.category;
    document.getElementById('topicContent').value = topic.content;
    document.getElementById('topicTags').value = topic.tags?.join(', ') || '';
    if (appState.isNucleo && document.getElementById('topicPinned')) {
      document.getElementById('topicPinned').checked = topic.pinned;
    }
    
    // Atualizar o formulário para edição
    const form = document.getElementById('topicForm');
    form.onsubmit = function(event) {
      event.preventDefault();
      updateTopic(topicId);
    };
    
    const submitBtn = form.querySelector('.module-button.primary');
    submitBtn.innerHTML = '<i class="fas fa-save"></i> Atualizar Tópico';
    submitBtn.type = 'button';
    submitBtn.onclick = () => updateTopic(topicId);
    
    // Atualizar título
    document.querySelector('.content-header h1').textContent = 'Editar Tópico';
  }, 100);
}

function updateTopic(topicId) {
  const topic = appState.forumTopics.find(t => t.id === topicId);
  if (!topic) return;
  
  topic.title = document.getElementById('topicTitle').value.trim();
  topic.category = document.getElementById('topicCategory').value;
  topic.content = document.getElementById('topicContent').value.trim();
  topic.tags = document.getElementById('topicTags').value.split(',').map(t => t.trim()).filter(t => t);
  topic.updatedAt = new Date().toISOString();
  
  if (appState.isNucleo && document.getElementById('topicPinned')) {
    topic.pinned = document.getElementById('topicPinned').checked;
  }
  
  saveState();
  showToast('Tópico atualizado com sucesso!', 'success');
  viewForumTopic(topicId);
}

function togglePinTopic(topicId) {
  if (!appState.isNucleo) return;
  
  const topic = appState.forumTopics.find(t => t.id === topicId);
  if (!topic) return;
  
  topic.pinned = !topic.pinned;
  saveState();
  showToast(`Tópico ${topic.pinned ? 'fixado' : 'desfixado'}!`, 'success');
  viewForumTopic(topicId);
}

function toggleLockTopic(topicId) {
  if (!appState.isNucleo) return;
  
  const topic = appState.forumTopics.find(t => t.id === topicId);
  if (!topic) return;
  
  topic.locked = !topic.locked;
  saveState();
  showToast(`Tópico ${topic.locked ? 'trancado' : 'destrancado'}!`, 'success');
  viewForumTopic(topicId);
}

function searchForumTopics(query) {
  const topics = appState.forumTopics;
  
  if (!query.trim()) {
    const pinnedTopics = topics.filter(t => t.pinned);
    const regularTopics = topics.filter(t => !t.pinned);
    document.getElementById('forumTopicsList').innerHTML = renderForumTopics(pinnedTopics.concat(regularTopics));
    return;
  }
  
  const filtered = topics.filter(topic => 
    topic.title.toLowerCase().includes(query.toLowerCase()) ||
    topic.content.toLowerCase().includes(query.toLowerCase()) ||
    topic.author.toLowerCase().includes(query.toLowerCase()) ||
    topic.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
  );
  
  document.getElementById('forumTopicsList').innerHTML = renderForumTopics(filtered);
}

function filterForumByCategory(category) {
  let topics = appState.forumTopics;
  
  if (category) {
    topics = topics.filter(t => t.category === category);
  }
  
  const pinnedTopics = topics.filter(t => t.pinned);
  const regularTopics = topics.filter(t => !t.pinned);
  document.getElementById('forumTopicsList').innerHTML = renderForumTopics(pinnedTopics.concat(regularTopics));
}

// ============================================
// 16.3 SISTEMA DE GRUPOS
// ============================================

function renderGroups() {
  const userGroups = appState.groups.filter(g => g.members.includes(appState.currentUser));
  const publicGroups = appState.groups.filter(g => g.privacy === 'public' && !userGroups.includes(g));
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Grupos de Estudo</h1>
      <p>Participe de grupos de estudo e pesquisa</p>
    </div>
    
    <div class="module-container">
      <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Meus Grupos (${userGroups.length})</h2>
        <button class="module-button primary" onclick="showNewGroupForm()">
          <i class="fas fa-plus"></i> Criar Grupo
        </button>
      </div>
      
      <div class="theories-grid" id="myGroupsList">
        ${renderGroupCards(userGroups)}
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Grupos Públicos (${publicGroups.length})</h2>
      </div>
      
      <div class="module-actions">
        <input type="text" id="groupSearch" class="form-control" style="max-width: 300px;"
               placeholder="Buscar grupos..." onkeyup="searchGroups(this.value)">
        <select id="groupCategoryFilter" class="form-control" style="max-width: 200px;"
                onchange="filterGroupsByCategory(this.value)">
          <option value="">Todas as Categorias</option>
          <option value="fisica">Física</option>
          <option value="matematica">Matemática</option>
          <option value="quimica">Química</option>
          <option value="biologia">Biologia</option>
          <option value="programacao">Programação</option>
          <option value="pesquisa">Pesquisa</option>
          <option value="estudo">Estudo</option>
        </select>
      </div>
      
      <div class="theories-grid" id="publicGroupsList">
        ${renderGroupCards(publicGroups)}
      </div>
    </div>
  `;
}

function renderGroupCards(groups) {
  if (groups.length === 0) {
    return `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-soft);">
        <i class="fas fa-users" style="font-size: 48px; margin-bottom: 15px;"></i>
        <p>Nenhum grupo encontrado.</p>
      </div>
    `;
  }
  
  return groups.map(group => {
    const isMember = group.members.includes(appState.currentUser);
    const isOwner = group.owner === appState.currentUser;
    const memberCount = group.members.length;
    const postCount = group.posts?.length || 0;
    
    return `
      <div class="theory-card">
        <h4>${group.name}</h4>
        
        <div class="theory-meta">
          <span><i class="fas fa-user"></i> ${group.owner}</span>
          <span><i class="fas fa-users"></i> ${memberCount} membros</span>
          <span><i class="fas fa-comment"></i> ${postCount} posts</span>
        </div>
        
        <div class="theory-preview">
          ${group.description.substring(0, 100)}...
        </div>
        
        <div class="theory-actions">
          <button class="module-button" onclick="viewGroup('${group.id}')">
            <i class="fas fa-eye"></i> Ver
          </button>
          ${!isMember ? `
            <button class="module-button success" onclick="joinGroup('${group.id}')">
              <i class="fas fa-sign-in-alt"></i> Entrar
            </button>
          ` : ''}
          ${isOwner ? `
            <button class="module-button warning" onclick="editGroup('${group.id}')">
              <i class="fas fa-cog"></i> Gerenciar
            </button>
          ` : ''}
        </div>
      </div>
    `;
  }).join('');
}

function showNewGroupForm() {
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Criar Novo Grupo</h1>
      <p>Crie um grupo de estudo ou pesquisa</p>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Formulário do Grupo</h2>
      </div>
      
      <form id="groupForm" onsubmit="createGroup(event)">
        <div class="form-group">
          <label class="form-label">Nome do Grupo *</label>
          <input type="text" id="groupName" class="form-control" required 
                 placeholder="Ex: Grupo de Estudo de Física Quântica">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Categoria *</label>
            <select id="groupCategory" class="form-control" required>
              <option value="">Selecione uma categoria</option>
              <option value="fisica">Física</option>
              <option value="matematica">Matemática</option>
              <option value="quimica">Química</option>
              <option value="biologia">Biologia</option>
              <option value="astronomia">Astronomia</option>
              <option value="programacao">Programação</option>
              <option value="pesquisa">Pesquisa</option>
              <option value="estudo">Estudo</option>
              <option value="outro">Outro</option>
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Privacidade *</label>
            <select id="groupPrivacy" class="form-control" required>
              <option value="public">Público (qualquer um pode entrar)</option>
              <option value="private">Privado (apenas com convite)</option>
              <option value="hidden">Oculto (apenas membros podem ver)</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Descrição *</label>
          <textarea id="groupDescription" class="form-control" rows="6" required
                    placeholder="Descreva o propósito do grupo, áreas de estudo, regras, etc."></textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tags (separadas por vírgula)</label>
          <input type="text" id="groupTags" class="form-control" 
                 placeholder="ex: quantica, fisica, mecanica">
        </div>
        
        <div class="module-actions">
          <button type="button" class="module-button" onclick="loadSection('groups')">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="module-button primary">
            <i class="fas fa-plus"></i> Criar Grupo
          </button>
        </div>
      </form>
    </div>
  `;
}

function createGroup(event) {
  event.preventDefault();
  
  const name = document.getElementById('groupName').value.trim();
  const category = document.getElementById('groupCategory').value;
  const privacy = document.getElementById('groupPrivacy').value;
  const description = document.getElementById('groupDescription').value.trim();
  const tags = document.getElementById('groupTags').value.split(',').map(t => t.trim()).filter(t => t);
  
  if (!name || !category || !description) {
    showToast('Preencha todos os campos obrigatórios!', 'error');
    return;
  }
  
  const group = {
    id: 'group_' + Date.now(),
    name: name,
    owner: appState.currentUser,
    category: category,
    privacy: privacy,
    description: description,
    tags: tags,
    members: [appState.currentUser],
    createdAt: new Date().toISOString(),
    posts: [],
    events: [],
    files: []
  };
  
  appState.groups.push(group);
  
  // Atualizar estatísticas do usuário
  if (appState.users[appState.currentUser]) {
    appState.users[appState.currentUser].stats.groups++;
  }
  
  saveState();
  showToast('Grupo criado com sucesso!', 'success');
  viewGroup(group.id);
}

function viewGroup(groupId) {
  const group = appState.groups.find(g => g.id === groupId);
  if (!group) {
    showToast('Grupo não encontrado!', 'error');
    loadSection('groups');
    return;
  }
  
  // Verificar permissão de visualização
  const canView = (
    group.privacy === 'public' ||
    group.members.includes(appState.currentUser) ||
    group.owner === appState.currentUser ||
    appState.isNucleo
  );
  
  if (!canView) {
    showToast('Você não tem permissão para ver este grupo!', 'error');
    loadSection('groups');
    return;
  }
  
  const isMember = group.members.includes(appState.currentUser);
  const isOwner = group.owner === appState.currentUser;
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <div style="display: flex; justify-content: space-between; align-items: flex-start;">
        <div>
          <h1>${group.name}</h1>
          <p>
            Criado por ${group.owner} • ${new Date(group.createdAt).toLocaleDateString()} • 
            <span style="color: var(--accent); background: rgba(74, 111, 165, 0.1); padding: 2px 8px; border-radius: 10px;">
              ${group.category}
            </span>
            <span style="margin-left: 10px; color: var(--text-soft);">
              <i class="fas fa-users"></i> ${group.members.length} membros
            </span>
          </p>
        </div>
        <div class="module-actions" style="margin: 0;">
          ${isOwner ? `
            <button class="module-button warning" onclick="manageGroup('${groupId}')">
              <i class="fas fa-cog"></i> Gerenciar
            </button>
          ` : ''}
          ${isMember ? `
            <button class="module-button danger" onclick="leaveGroup('${groupId}')">
              <i class="fas fa-sign-out-alt"></i> Sair
            </button>
          ` : group.privacy === 'public' ? `
            <button class="module-button success" onclick="joinGroup('${groupId}')">
              <i class="fas fa-sign-in-alt"></i> Entrar no Grupo
            </button>
          ` : `
            <button class="module-button" onclick="requestGroupInvite('${groupId}')">
              <i class="fas fa-envelope"></i> Solicitar Convite
            </button>
          `}
          <button class="module-button" onclick="loadSection('groups')">
            <i class="fas fa-arrow-left"></i> Voltar
          </button>
        </div>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Sobre o Grupo</h2>
      </div>
      
      <div style="line-height: 1.7; color: var(--text-main); margin-bottom: 20px;">
        ${group.description}
      </div>
      
      ${group.tags && group.tags.length > 0 ? `
        <div style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 15px;">
          ${group.tags.map(tag => `
            <span style="background: var(--bg-input); padding: 5px 12px; border-radius: 15px; font-size: 13px; color: var(--text-soft);">
              ${tag}
            </span>
          `).join('')}
        </div>
      ` : ''}
    </div>
    
    <div class="module-container">
      <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Posts do Grupo (${group.posts?.length || 0})</h2>
        ${isMember ? `
          <button class="module-button primary" onclick="createGroupPost('${groupId}')">
            <i class="fas fa-plus"></i> Novo Post
          </button>
        ` : ''}
      </div>
      
      <div id="groupPosts">
        ${renderGroupPosts(group.posts || [])}
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Membros (${group.members.length})</h2>
      </div>
      
      <div class="friends-list-grid">
        ${renderGroupMembers(group.members)}
      </div>
    </div>
  `;
}

function renderGroupPosts(posts) {
  if (posts.length === 0) {
    return `
      <div style="text-align: center; padding: 30px; color: var(--text-soft);">
        <i class="fas fa-comments" style="font-size: 32px; margin-bottom: 10px;"></i>
        <p>Nenhum post ainda. Seja o primeiro a postar!</p>
      </div>
    `;
  }
  
  return posts.slice().reverse().map(post => `
    <div style="padding: 20px; border-bottom: 1px solid var(--border);">
      <div style="display: flex; justify-content: space-between; margin-bottom: 15px;">
        <div style="display: flex; align-items: center; gap: 10px;">
          <img src="${appState.users[post.author]?.profile?.avatarUrl || 
                    appState.users[post.author]?.profile?.avatar || ''}" 
               class="avatar avatar-small" alt="${post.author}">
          <div>
            <div style="font-weight: 500;">${post.author}</div>
            <div style="font-size: 12px; color: var(--text-soft);">
              ${new Date(post.timestamp).toLocaleString()}
            </div>
          </div>
        </div>
        ${(post.author === appState.currentUser || appState.isNucleo) ? `
          <button class="message-action" onclick="deleteGroupPost('${post.id}')">
            <i class="fas fa-trash"></i>
          </button>
        ` : ''}
      </div>
      <div style="line-height: 1.6; color: var(--text-main); padding-left: 50px;">
        ${post.content}
      </div>
    </div>
  `).join('');
}

function renderGroupMembers(members) {
  return members.map(member => {
    const user = appState.users[member];
    const isOnline = appState.onlineUsers[member]?.status === 'online';
    
    return `
      <div class="friend-card">
        <img src="${user?.profile?.avatarUrl || user?.profile?.avatar || ''}" 
             class="friend-avatar" alt="${member}">
        <div class="friend-name">${member}</div>
        <div class="friend-status">
          <div class="status-indicator ${isOnline ? 'status-online-ind' : 'status-offline-ind'}"></div>
          <span>${isOnline ? 'Online' : 'Offline'}</span>
        </div>
        <div class="friend-actions">
          <button class="module-button" onclick="viewProfile('${member}')">
            <i class="fas fa-user"></i> Perfil
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function createGroupPost(groupId) {
  const content = prompt('Escreva seu post para o grupo:');
  if (!content || !content.trim()) return;
  
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || !group.members.includes(appState.currentUser)) return;
  
  const post = {
    id: 'gpost_' + Date.now(),
    author: appState.currentUser,
    content: content.trim(),
    timestamp: new Date().toISOString(),
    groupId: groupId
  };
  
  if (!group.posts) group.posts = [];
  group.posts.push(post);
  saveState();
  
  // Atualizar visualização
  viewGroup(groupId);
  showToast('Post publicado no grupo!', 'success');
}

function deleteGroupPost(postId) {
  if (!confirm('Excluir este post do grupo?')) return;
  
  for (const group of appState.groups) {
    const postIndex = group.posts?.findIndex(p => p.id === postId);
    if (postIndex !== -1 && postIndex !== undefined) {
      const post = group.posts[postIndex];
      if (post.author === appState.currentUser || appState.isNucleo) {
        group.posts.splice(postIndex, 1);
        saveState();
        viewGroup(group.id);
        showToast('Post excluído!', 'success');
        return;
      }
    }
  }
}

function joinGroup(groupId) {
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || group.members.includes(appState.currentUser)) return;
  
  if (group.privacy === 'private') {
    showToast('Este grupo é privado. Solicite um convite ao dono.', 'info');
    return;
  }
  
  group.members.push(appState.currentUser);
  
  // Atualizar estatísticas
  if (appState.users[appState.currentUser]) {
    appState.users[appState.currentUser].stats.groups++;
  }
  
  saveState();
  showToast(`Você entrou no grupo ${group.name}!`, 'success');
  viewGroup(groupId);
}

function leaveGroup(groupId) {
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || !group.members.includes(appState.currentUser)) return;
  
  if (group.owner === appState.currentUser) {
    showToast('Você é o dono do grupo. Transfira a propriedade antes de sair.', 'error');
    return;
  }
  
  group.members = group.members.filter(m => m !== appState.currentUser);
  
  // Atualizar estatísticas
  if (appState.users[appState.currentUser]) {
    appState.users[appState.currentUser].stats.groups--;
  }
  
  saveState();
  showToast(`Você saiu do grupo ${group.name}.`, 'info');
  loadSection('groups');
}

function requestGroupInvite(groupId) {
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || group.privacy !== 'private') return;
  
  // Notificar o dono do grupo
  addNotification(
    'Solicitação de Convite para Grupo',
    `${appState.currentUser} quer entrar no grupo "${group.name}"`,
    'info',
    `viewGroup('${groupId}')`
  );
  
  showToast('Solicitação de convite enviada ao dono do grupo!', 'success');
}

function manageGroup(groupId) {
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || group.owner !== appState.currentUser) return;
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Gerenciar Grupo: ${group.name}</h1>
      <p>Configurações e administração do grupo</p>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Configurações do Grupo</h2>
      </div>
      
      <form onsubmit="updateGroupSettings('${groupId}', event)">
        <div class="form-group">
          <label class="form-label">Nome do Grupo</label>
          <input type="text" id="manageGroupName" class="form-control" value="${group.name}">
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Categoria</label>
            <select id="manageGroupCategory" class="form-control">
              ${['fisica', 'matematica', 'quimica', 'biologia', 'astronomia', 'programacao', 'pesquisa', 'estudo', 'outro']
                .map(cat => `<option value="${cat}" ${cat === group.category ? 'selected' : ''}>${cat}</option>`)
                .join('')}
            </select>
          </div>
          
          <div class="form-group">
            <label class="form-label">Privacidade</label>
            <select id="manageGroupPrivacy" class="form-control">
              <option value="public" ${group.privacy === 'public' ? 'selected' : ''}>Público</option>
              <option value="private" ${group.privacy === 'private' ? 'selected' : ''}>Privado</option>
              <option value="hidden" ${group.privacy === 'hidden' ? 'selected' : ''}>Oculto</option>
            </select>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Descrição</label>
          <textarea id="manageGroupDescription" class="form-control" rows="6">${group.description}</textarea>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tags (separadas por vírgula)</label>
          <input type="text" id="manageGroupTags" class="form-control" 
                 value="${group.tags?.join(', ') || ''}">
        </div>
        
        <div class="module-actions">
          <button type="button" class="module-button" onclick="viewGroup('${groupId}')">
            <i class="fas fa-times"></i> Cancelar
          </button>
          <button type="submit" class="module-button primary">
            <i class="fas fa-save"></i> Salvar Alterações
          </button>
        </div>
      </form>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Gerenciar Membros (${group.members.length})</h2>
      </div>
      
      <div class="forum-table-container">
        <table class="forum-table">
          <thead>
            <tr>
              <th>Membro</th>
              <th>Status</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody>
            ${group.members.map(member => {
              const isOwner = member === group.owner;
              const user = appState.users[member];
              const isOnline = appState.onlineUsers[member]?.status === 'online';
              
              return `
                <tr>
                  <td>
                    <div style="display: flex; align-items: center; gap: 10px;">
                      <img src="${user?.profile?.avatarUrl || user?.profile?.avatar || ''}" 
                           class="avatar avatar-small" alt="${member}">
                      <span>${member} ${isOwner ? '<span style="color: var(--accent-secondary);">(Dono)</span>' : ''}</span>
                    </div>
                  </td>
                  <td>
                    <div style="display: flex; align-items: center; gap: 5px;">
                      <div class="status-indicator ${isOnline ? 'status-online-ind' : 'status-offline-ind'}"></div>
                      <span>${isOnline ? 'Online' : 'Offline'}</span>
                    </div>
                  </td>
                  <td>
                    ${!isOwner ? `
                      <div style="display: flex; gap: 8px;">
                        <button class="module-button danger" style="padding: 6px 12px; font-size: 12px;" 
                                onclick="removeMemberFromGroup('${groupId}', '${member}')">
                          <i class="fas fa-user-times"></i> Remover
                        </button>
                        ${group.owner === appState.currentUser ? `
                          <button class="module-button success" style="padding: 6px 12px; font-size: 12px;"
                                  onclick="transferOwnership('${groupId}', '${member}')">
                            <i class="fas fa-crown"></i> Tornar Dono
                          </button>
                        ` : ''}
                      </div>
                    ` : '<span style="color: var(--text-soft); font-size: 13px;">Proprietário</span>'}
                  </td>
                </tr>
              `;
            }).join('')}
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Ações Perigosas</h2>
      </div>
      
      <div class="module-actions">
        <button class="module-button danger" onclick="deleteGroup('${groupId}')">
          <i class="fas fa-trash"></i> Excluir Grupo Permanentemente
        </button>
      </div>
    </div>
  `;
}

function updateGroupSettings(groupId, event) {
  event.preventDefault();
  
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || group.owner !== appState.currentUser) return;
  
  group.name = document.getElementById('manageGroupName').value.trim();
  group.category = document.getElementById('manageGroupCategory').value;
  group.privacy = document.getElementById('manageGroupPrivacy').value;
  group.description = document.getElementById('manageGroupDescription').value.trim();
  group.tags = document.getElementById('manageGroupTags').value.split(',').map(t => t.trim()).filter(t => t);
  
  saveState();
  showToast('Configurações do grupo atualizadas!', 'success');
  viewGroup(groupId);
}

function removeMemberFromGroup(groupId, member) {
  if (!confirm(`Remover ${member} do grupo?`)) return;
  
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || group.owner !== appState.currentUser || member === group.owner) return;
  
  group.members = group.members.filter(m => m !== member);
  
  // Atualizar estatísticas do membro removido
  if (appState.users[member]) {
    appState.users[member].stats.groups--;
  }
  
  saveState();
  
  // Notificar o membro removido
  addNotification(
    'Removido do Grupo',
    `Você foi removido do grupo "${group.name}"`,
    'error',
    ''
  );
  
  showToast(`${member} removido do grupo.`, 'success');
  manageGroup(groupId);
}

function transferOwnership(groupId, newOwner) {
  if (!confirm(`Transferir propriedade do grupo para ${newOwner}?`)) return;
  
  const group = appState.groups.find(g => g.id === groupId);
  if (!group || group.owner !== appState.currentUser) return;
  
  const oldOwner = group.owner;
  group.owner = newOwner;
  
  // Notificar o novo dono
  addNotification(
    'Você é o Novo Dono do Grupo',
    `${oldOwner} transferiu a propriedade do grupo "${group.name}" para você`,
    'success',
    `viewGroup('${groupId}')`
  );
  
  saveState();
  showToast(`Propriedade transferida para ${newOwner}!`, 'success');
  manageGroup(groupId);
}

function deleteGroup(groupId) {
  if (!confirm('EXCLUIR GRUPO PERMANENTEMENTE? Esta ação não pode ser desfeita!')) return;
  
  const groupIndex = appState.groups.findIndex(g => g.id === groupId);
  if (groupIndex === -1 || appState.groups[groupIndex].owner !== appState.currentUser) return;
  
  // Atualizar estatísticas dos membros
  appState.groups[groupIndex].members.forEach(member => {
    if (appState.users[member] && member !== appState.currentUser) {
      appState.users[member].stats.groups--;
    }
  });
  
  // Remover grupo
  appState.groups.splice(groupIndex, 1);
  
  // Atualizar estatísticas do dono
  if (appState.users[appState.currentUser]) {
    appState.users[appState.currentUser].stats.groups--;
  }
  
  saveState();
  showToast('Grupo excluído permanentemente!', 'success');
  loadSection('groups');
}

function searchGroups(query) {
  const publicGroups = appState.groups.filter(g => g.privacy === 'public');
  
  if (!query.trim()) {
    document.getElementById('publicGroupsList').innerHTML = renderGroupCards(publicGroups);
    return;
  }
  
  const filtered = publicGroups.filter(group => 
    group.name.toLowerCase().includes(query.toLowerCase()) ||
    group.description.toLowerCase().includes(query.toLowerCase()) ||
    group.tags?.some(tag => tag.toLowerCase().includes(query.toLowerCase()))
  );
  
  document.getElementById('publicGroupsList').innerHTML = renderGroupCards(filtered);
}

function filterGroupsByCategory(category) {
  let groups = appState.groups.filter(g => g.privacy === 'public');
  
  if (category) {
    groups = groups.filter(g => g.category === category);
  }
  
  document.getElementById('publicGroupsList').innerHTML = renderGroupCards(groups);
}

// ============================================
// 16.4 SISTEMA DE ARQUIVOS
// ============================================

function renderFiles() {
  const userFiles = appState.files.filter(f => f.owner === appState.currentUser);
  const sharedFiles = appState.files.filter(f => 
    f.sharedWith?.includes(appState.currentUser) || f.privacy === 'public'
  );
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Arquivos e Documentos</h1>
      <p>Armazene e compartilhe arquivos científicos</p>
    </div>
    
    <div class="module-container">
      <div class="module-header" style="display: flex; justify-content: space-between; align-items: center;">
        <h2>Meus Arquivos (${userFiles.length})</h2>
        <button class="module-button primary" onclick="uploadFile()">
          <i class="fas fa-upload"></i> Upload de Arquivo
        </button>
      </div>
      
      <div class="forum-table-container">
        <table class="forum-table">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Tipo</th>
              <th>Tamanho</th>
              <th>Data</th>
              <th>Privacidade</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="myFilesList">
            ${renderFileTable(userFiles)}
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Arquivos Compartilhados (${sharedFiles.length})</h2>
      </div>
      
      <div class="module-actions">
        <input type="text" id="fileSearch" class="form-control" style="max-width: 300px;"
               placeholder="Buscar arquivos..." onkeyup="searchFiles(this.value)">
      </div>
      
      <div class="theories-grid" id="sharedFilesList">
        ${renderFileCards(sharedFiles)}
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Estatísticas de Armazenamento</h2>
      </div>
      <div class="stats-grid">
        <div class="stat-card">
          <h3>Total de Arquivos</h3>
          <div class="stat-value">${appState.files.length}</div>
        </div>
        <div class="stat-card">
          <h3>Meu Espaço Usado</h3>
          <div class="stat-value">${formatFileSize(userFiles.reduce((sum, f) => sum + (f.size || 0), 0))}</div>
        </div>
        <div class="stat-card">
          <h3>Arquivos Públicos</h3>
          <div class="stat-value">${appState.files.filter(f => f.privacy === 'public').length}</div>
        </div>
        <div class="stat-card">
          <h3>Arquivos Hoje</h3>
          <div class="stat-value">${appState.files.filter(f => isToday(new Date(f.uploadedAt))).length}</div>
        </div>
      </div>
    </div>
  `;
}

function renderFileTable(files) {
  if (files.length === 0) {
    return `
      <tr>
        <td colspan="6" style="text-align: center; padding: 40px; color: var(--text-soft);">
          <i class="fas fa-folder-open" style="font-size: 32px; margin-bottom: 10px;"></i>
          <p>Nenhum arquivo ainda. Faça upload do seu primeiro arquivo!</p>
        </td>
      </tr>
    `;
  }
  
  return files.slice().reverse().map(file => {
    const icon = getFileIcon(file.type);
    const privacyText = {
      'private': 'Privado',
      'friends': 'Amigos',
      'public': 'Público'
    }[file.privacy] || file.privacy;
    
    return `
      <tr>
        <td>
          <div style="display: flex; align-items: center; gap: 10px;">
            <i class="${icon}" style="font-size: 20px; color: var(--accent);"></i>
            <span>${file.name}</span>
          </div>
        </td>
        <td>
          <span style="font-size: 13px; color: var(--text-soft);">${file.type}</span>
        </td>
        <td>${formatFileSize(file.size)}</td>
        <td>${new Date(file.uploadedAt).toLocaleDateString()}</td>
        <td>
          <span style="background: ${file.privacy === 'public' ? 'rgba(39, 174, 96, 0.1)' : 
                                    file.privacy === 'friends' ? 'rgba(74, 111, 165, 0.1)' : 
                                    'rgba(231, 76, 60, 0.1)'}; 
                color: ${file.privacy === 'public' ? 'var(--success)' : 
                         file.privacy === 'friends' ? 'var(--accent)' : 'var(--danger)'}; 
                padding: 4px 10px; border-radius: 10px; font-size: 12px;">
            ${privacyText}
          </span>
        </td>
        <td>
          <div style="display: flex; gap: 8px;">
            <button class="module-button" style="padding: 6px 12px; font-size: 12px;" 
                    onclick="downloadFile('${file.id}')">
              <i class="fas fa-download"></i>
            </button>
            <button class="module-button" style="padding: 6px 12px; font-size: 12px;" 
                    onclick="shareFile('${file.id}')">
              <i class="fas fa-share"></i>
            </button>
            <button class="module-button danger" style="padding: 6px 12px; font-size: 12px;" 
                    onclick="deleteFile('${file.id}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function renderFileCards(files) {
  if (files.length === 0) {
    return `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-soft);">
        <i class="fas fa-folder" style="font-size: 48px; margin-bottom: 15px;"></i>
        <p>Nenhum arquivo compartilhado disponível.</p>
      </div>
    `;
  }
  
  return files.slice(0, 8).map(file => {
    const icon = getFileIcon(file.type);
    
    return `
      <div class="theory-card">
        <div style="text-align: center; margin-bottom: 15px;">
          <i class="${icon}" style="font-size: 48px; color: var(--accent);"></i>
        </div>
        
        <h4 style="text-align: center; margin-bottom: 10px;">${file.name}</h4>
        
        <div class="theory-meta" style="justify-content: center;">
          <span><i class="fas fa-user"></i> ${file.owner}</span>
          <span><i class="fas fa-weight-hanging"></i> ${formatFileSize(file.size)}</span>
        </div>
        
        <div class="theory-actions" style="justify-content: center;">
          <button class="module-button" onclick="downloadFile('${file.id}')">
            <i class="fas fa-download"></i> Baixar
          </button>
          <button class="module-button success" onclick="viewFileInfo('${file.id}')">
            <i class="fas fa-info"></i> Info
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function getFileIcon(fileType) {
  if (fileType.includes('image')) return 'fas fa-file-image';
  if (fileType.includes('pdf')) return 'fas fa-file-pdf';
  if (fileType.includes('word') || fileType.includes('document')) return 'fas fa-file-word';
  if (fileType.includes('excel') || fileType.includes('spreadsheet')) return 'fas fa-file-excel';
  if (fileType.includes('zip') || fileType.includes('compressed')) return 'fas fa-file-archive';
  if (fileType.includes('text') || fileType.includes('plain')) return 'fas fa-file-alt';
  return 'fas fa-file';
}

function uploadFile() {
  const input = document.createElement('input');
  input.type = 'file';
  input.multiple = true;
  
  input.onchange = function(event) {
    const files = Array.from(event.target.files);
    
    files.forEach(file => {
      // Validar tamanho (max 10MB)
      if (file.size > 10 * 1024 * 1024) {
        showToast(`Arquivo ${file.name} muito grande! Máximo 10MB.`, 'error');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const fileData = {
          id: 'file_' + Date.now() + Math.random(),
          name: file.name,
          type: file.type,
          size: file.size,
          data: e.target.result,
          owner: appState.currentUser,
          privacy: 'private',
          uploadedAt: new Date().toISOString(),
          downloads: 0,
          sharedWith: []
        };
        
        appState.files.push(fileData);
        
        // Atualizar estatísticas
        if (appState.users[appState.currentUser]) {
          appState.users[appState.currentUser].stats.files++;
        }
        
        saveState();
        showToast(`Arquivo ${file.name} enviado com sucesso!`, 'success');
        
        // Recarregar seção
        if (document.getElementById('mainContent').innerHTML.includes('Arquivos e Documentos')) {
          loadSection('files');
        }
      };
      
      reader.readAsDataURL(file);
    });
  };
  
  input.click();
}

function downloadFile(fileId) {
  const file = appState.files.find(f => f.id === fileId);
  if (!file) {
    showToast('Arquivo não encontrado!', 'error');
    return;
  }
  
  // Verificar permissões
  const canDownload = (
    file.owner === appState.currentUser ||
    file.privacy === 'public' ||
    (file.privacy === 'friends' && appState.friends[appState.currentUser]?.includes(file.owner)) ||
    file.sharedWith?.includes(appState.currentUser)
  );
  
  if (!canDownload) {
    showToast('Você não tem permissão para baixar este arquivo!', 'error');
    return;
  }
  
  // Incrementar contador de downloads
  file.downloads = (file.downloads || 0) + 1;
  saveState();
  
  // Criar link de download
  const a = document.createElement('a');
  a.href = file.data;
  a.download = file.name;
  document.body.appendChild(a);
  a.click();
  document.body.removeChild(a);
  
  showToast(`Baixando ${file.name}...`, 'success');
}

function shareFile(fileId) {
  const file = appState.files.find(f => f.id === fileId);
  if (!file || file.owner !== appState.currentUser) return;
  
  const privacy = prompt(
    'Configurar privacidade do arquivo:\n' +
    '1. private (somente você)\n' +
    '2. friends (seus amigos)\n' +
    '3. public (todos os usuários)\n\n' +
    'Digite o número ou o nome:',
    file.privacy
  );
  
  if (!privacy) return;
  
  let newPrivacy;
  if (privacy === '1' || privacy === 'private') newPrivacy = 'private';
  else if (privacy === '2' || privacy === 'friends') newPrivacy = 'friends';
  else if (privacy === '3' || privacy === 'public') newPrivacy = 'public';
  else return;
  
  file.privacy = newPrivacy;
  saveState();
  
  // Perguntar sobre compartilhamento específico se for privado
  if (newPrivacy === 'private') {
    const users = prompt('Compartilhar com usuários específicos (separados por vírgula):');
    if (users) {
      const userList = users.split(',').map(u => u.trim()).filter(u => u && u !== appState.currentUser);
      file.sharedWith = userList;
      
      // Notificar usuários
      userList.forEach(username => {
        if (appState.users[username]) {
          addNotification(
            'Arquivo Compartilhado',
            `${appState.currentUser} compartilhou "${file.name}" com você`,
            'info',
            `downloadFile('${file.id}')`
          );
        }
      });
    }
  }
  
  showToast(`Privacidade do arquivo alterada para ${newPrivacy}!`, 'success');
  
  // Recarregar seção
  if (document.getElementById('mainContent').innerHTML.includes('Arquivos e Documentos')) {
    loadSection('files');
  }
}

function deleteFile(fileId) {
  const file = appState.files.find(f => f.id === fileId);
  if (!file || file.owner !== appState.currentUser) {
    showToast('Você não tem permissão para excluir este arquivo!', 'error');
    return;
  }
  
  if (!confirm(`Excluir permanentemente "${file.name}"?`)) return;
  
  const fileIndex = appState.files.findIndex(f => f.id === fileId);
  if (fileIndex !== -1) {
    appState.files.splice(fileIndex, 1);
    
    // Atualizar estatísticas
    if (appState.users[appState.currentUser]) {
      appState.users[appState.currentUser].stats.files--;
    }
    
    saveState();
    showToast('Arquivo excluído!', 'success');
    
    // Recarregar seção
    if (document.getElementById('mainContent').innerHTML.includes('Arquivos e Documentos')) {
      loadSection('files');
    }
  }
}

function viewFileInfo(fileId) {
  const file = appState.files.find(f => f.id === fileId);
  if (!file) return;
  
  const modalContent = `
    <div class="content-header">
      <h1>Informações do Arquivo</h1>
    </div>
    
    <div class="module-container">
      <div style="text-align: center; margin-bottom: 20px;">
        <i class="${getFileIcon(file.type)}" style="font-size: 64px; color: var(--accent);"></i>
      </div>
      
      <div class="form-group">
        <label class="form-label">Nome</label>
        <div class="form-control" style="background: var(--bg-card);">${file.name}</div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Tipo</label>
          <div class="form-control" style="background: var(--bg-card);">${file.type}</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Tamanho</label>
          <div class="form-control" style="background: var(--bg-card);">${formatFileSize(file.size)}</div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">Proprietário</label>
          <div class="form-control" style="background: var(--bg-card);">${file.owner}</div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Downloads</label>
          <div class="form-control" style="background: var(--bg-card);">${file.downloads || 0}</div>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Data de Upload</label>
        <div class="form-control" style="background: var(--bg-card);">
          ${new Date(file.uploadedAt).toLocaleString()}
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Privacidade</label>
        <div class="form-control" style="background: var(--bg-card);">
          ${file.privacy === 'private' ? 'Privado' : 
            file.privacy === 'friends' ? 'Compartilhado com amigos' : 'Público'}
        </div>
      </div>
      
      ${file.sharedWith && file.sharedWith.length > 0 ? `
        <div class="form-group">
          <label class="form-label">Compartilhado com</label>
          <div class="form-control" style="background: var(--bg-card); height: auto; min-height: 60px;">
            ${file.sharedWith.join(', ')}
          </div>
        </div>
      ` : ''}
      
      <div class="module-actions">
        <button class="module-button primary" onclick="downloadFile('${fileId}')">
          <i class="fas fa-download"></i> Baixar Arquivo
        </button>
        <button class="module-button" onclick="loadSection('files')">
          <i class="fas fa-arrow-left"></i> Voltar
        </button>
      </div>
    </div>
  `;
  
  document.getElementById('mainContent').innerHTML = modalContent;
}

function searchFiles(query) {
  const sharedFiles = appState.files.filter(f => 
    f.sharedWith?.includes(appState.currentUser) || f.privacy === 'public'
  );
  
  if (!query.trim()) {
    document.getElementById('sharedFilesList').innerHTML = renderFileCards(sharedFiles);
    return;
  }
  
  const filtered = sharedFiles.filter(file => 
    file.name.toLowerCase().includes(query.toLowerCase()) ||
    file.owner.toLowerCase().includes(query.toLowerCase())
  );
  
  document.getElementById('sharedFilesList').innerHTML = renderFileCards(filtered);
}

// ============================================
// 16.5 SISTEMA DE PERFIL
// ============================================

function renderProfile() {
  const user = appState.users[appState.currentUser];
  if (!user) return;
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Meu Perfil</h1>
      <p>Gerencie suas informações e configurações</p>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Informações Pessoais</h2>
      </div>
      
      <form id="profileForm" onsubmit="updateProfile(event)">
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Nome de Usuário</label>
            <div class="form-control" style="background: var(--bg-card);">
              ${appState.currentUser}
            </div>
            <small style="color: var(--text-soft);">Nome de usuário não pode ser alterado</small>
          </div>
          
          <div class="form-group">
            <label class="form-label">Membro desde</label>
            <div class="form-control" style="background: var(--bg-card);">
              ${new Date(user.createdAt).toLocaleDateString()}
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Avatar</label>
          <div style="display: flex; align-items: center; gap: 20px;">
            <div class="avatar-upload" onclick="document.getElementById('avatarUpload').click()">
              <img id="currentAvatar" src="${user.profile.avatarUrl || user.profile.avatar}" 
                   class="avatar avatar-large" alt="Avatar">
              <div class="avatar-upload-overlay">
                <i class="fas fa-camera"></i>
              </div>
            </div>
            <div>
              <button type="button" class="module-button" onclick="document.getElementById('avatarUpload').click()">
                <i class="fas fa-upload"></i> Alterar Avatar
              </button>
              <input type="file" id="avatarUpload" accept="image/*" style="display: none;" 
                     onchange="uploadAvatar(event)">
              <p style="color: var(--text-soft); font-size: 13px; margin-top: 5px;">
                Clique no avatar para alterar (max 2MB)
              </p>
            </div>
          </div>
        </div>
        
        <div class="form-group">
          <label class="form-label">Biografia</label>
          <textarea id="profileBio" class="form-control" rows="4"
                    placeholder="Conte um pouco sobre você, suas áreas de interesse, formação...">${user.profile?.bio || ''}</textarea>
        </div>
        
        <div class="form-row">
          <div class="form-group">
            <label class="form-label">Área de Atuação/Interesse</label>
            <input type="text" id="profileArea" class="form-control" 
                   placeholder="Ex: Física Quântica, Matemática, Biologia..."
                   value="${user.profile?.area || ''}">
          </div>
          
          <div class="form-group">
            <label class="form-label">Links (site, GitHub, LinkedIn)</label>
            <input type="text" id="profileLinks" class="form-control" 
                   placeholder="https://..."
                   value="${user.profile?.links || ''}">
          </div>
        </div>
        
        <div class="module-actions">
          <button type="submit" class="module-button primary">
            <i class="fas fa-save"></i> Salvar Alterações
          </button>
        </div>
      </form>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Configurações de Conta</h2>
      </div>
      
      <div class="form-group">
        <label class="form-label">Tema da Interface</label>
        <div class="theme-selector">
          <div class="theme-option theme-dark ${user.settings?.theme === 'dark' ? 'active' : ''}" 
               onclick="setTheme('dark'); updateUserTheme('dark')"></div>
          <div class="theme-option theme-blue ${user.settings?.theme === 'blue' ? 'active' : ''}" 
               onclick="setTheme('blue'); updateUserTheme('blue')"></div>
          <div class="theme-option theme-green ${user.settings?.theme === 'green' ? 'active' : ''}" 
               onclick="setTheme('green'); updateUserTheme('green')"></div>
          <div class="theme-option theme-purple ${user.settings?.theme === 'purple' ? 'active' : ''}" 
               onclick="setTheme('purple'); updateUserTheme('purple')"></div>
        </div>
      </div>
      
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="notificationsEnabled" ${user.settings?.notifications !== false ? 'checked' : ''}>
            Receber notificações
          </label>
        </div>
        
        <div class="form-group">
          <label class="form-label">
            <input type="checkbox" id="showOnlineStatus" ${user.settings?.showOnlineStatus !== false ? 'checked' : ''}>
            Mostrar status online
          </label>
        </div>
      </div>
      
      <div class="form-group">
        <label class="form-label">Privacidade do Perfil</label>
        <select id="profilePrivacy" class="form-control">
          <option value="public" ${user.settings?.privacy === 'public' ? 'selected' : ''}>Público (todos podem ver)</option>
          <option value="friends" ${user.settings?.privacy === 'friends' || !user.settings?.privacy ? 'selected' : ''}>Apenas Amigos</option>
          <option value="private" ${user.settings?.privacy === 'private' ? 'selected' : ''}>Privado (somente eu)</option>
        </select>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Segurança</h2>
      </div>
      
      <div class="form-group">
        <label class="form-label">Alterar Senha</label>
        <div class="form-row">
          <div class="form-group">
            <input type="password" id="currentPassword" class="form-control" 
                   placeholder="Senha atual">
          </div>
          <div class="form-group">
            <input type="password" id="newPassword" class="form-control" 
                   placeholder="Nova senha">
          </div>
          <div class="form-group">
            <input type="password" id="confirmPassword" class="form-control" 
                   placeholder="Confirmar nova senha">
          </div>
        </div>
        <button class="module-button warning" onclick="changePassword()">
          <i class="fas fa-key"></i> Alterar Senha
        </button>
      </div>
      
      <div class="form-group">
        <label class="form-label">Exportar Dados</label>
        <p style="color: var(--text-soft); margin-bottom: 10px;">
          Exporte todos os seus dados em formato JSON
        </p>
        <button class="module-button" onclick="exportUserData()">
          <i class="fas fa-download"></i> Exportar Meus Dados
        </button>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Ações Perigosas</h2>
      </div>
      
      <div class="module-actions">
        <button class="module-button danger" onclick="deleteAccount()">
          <i class="fas fa-trash"></i> Excluir Minha Conta Permanentemente
        </button>
      </div>
      <p style="color: var(--text-soft); font-size: 13px; margin-top: 10px;">
        Atenção: Esta ação não pode ser desfeita! Todos os seus dados serão perdidos.
      </p>
    </div>
  `;
}

function uploadAvatar(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  // Validar se é imagem
  if (!file.type.startsWith('image/')) {
    showToast('Por favor, selecione uma imagem!', 'error');
    return;
  }
  
  // Validar tamanho (max 2MB)
  if (file.size > 2 * 1024 * 1024) {
    showToast('Imagem muito grande! Máximo 2MB.', 'error');
    return;
  }
  
  const reader = new FileReader();
  reader.onload = function(e) {
    // Atualizar avatar
    const user = appState.users[appState.currentUser];
    if (!user) return;
    
    user.profile.avatarUrl = e.target.result;
    
    // Atualizar visualização
    const avatarImg = document.getElementById('currentAvatar');
    if (avatarImg) {
      avatarImg.src = e.target.result;
    }
    
    // Atualizar outros avatares na interface
    updateUserUI();
    
    saveState();
    showToast('Avatar atualizado com sucesso!', 'success');
  };
  
  reader.readAsDataURL(file);
}

function updateProfile(event) {
  event.preventDefault();
  
  const user = appState.users[appState.currentUser];
  if (!user) return;
  
  user.profile.bio = document.getElementById('profileBio').value.trim();
  user.profile.area = document.getElementById('profileArea').value.trim();
  user.profile.links = document.getElementById('profileLinks').value.trim();
  
  // Atualizar configurações
  user.settings = user.settings || {};
  user.settings.notifications = document.getElementById('notificationsEnabled').checked;
  user.settings.showOnlineStatus = document.getElementById('showOnlineStatus').checked;
  user.settings.privacy = document.getElementById('profilePrivacy').value;
  
  saveState();
  showToast('Perfil atualizado com sucesso!', 'success');
}

function updateUserTheme(theme) {
  const user = appState.users[appState.currentUser];
  if (!user) return;
  
  user.settings = user.settings || {};
  user.settings.theme = theme;
  saveState();
}

function changePassword() {
  const currentPassword = document.getElementById('currentPassword').value;
  const newPassword = document.getElementById('newPassword').value;
  const confirmPassword = document.getElementById('confirmPassword').value;
  
  const user = appState.users[appState.currentUser];
  if (!user) return;
  
  if (!currentPassword || !newPassword || !confirmPassword) {
    showToast('Preencha todos os campos!', 'error');
    return;
  }
  
  if (user.password !== currentPassword) {
    showToast('Senha atual incorreta!', 'error');
    return;
  }
  
  if (newPassword !== confirmPassword) {
    showToast('As novas senhas não coincidem!', 'error');
    return;
  }
  
  if (newPassword.length < 6) {
    showToast('A nova senha deve ter pelo menos 6 caracteres!', 'error');
    return;
  }
  
  user.password = newPassword;
  saveState();
  
  // Limpar campos
  document.getElementById('currentPassword').value = '';
  document.getElementById('newPassword').value = '';
  document.getElementById('confirmPassword').value = '';
  
  showToast('Senha alterada com sucesso!', 'success');
}

function exportUserData() {
  const user = appState.users[appState.currentUser];
  if (!user) return;
  
  // Coletar dados do usuário
  const userData = {
    profile: user.profile,
    stats: user.stats,
    settings: user.settings,
    createdAt: user.createdAt,
    theories: appState.theories.filter(t => t.author === appState.currentUser),
    forumTopics: appState.forumTopics.filter(t => t.author === appState.currentUser),
    files: appState.files.filter(f => f.owner === appState.currentUser),
    friends: appState.friends[appState.currentUser] || []
  };
  
  // Criar e baixar arquivo JSON
  const dataStr = JSON.stringify(userData, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `renova_dados_${appState.currentUser}_${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showToast('Dados exportados com sucesso!', 'success');
}

function deleteAccount() {
  if (!confirm('EXCLUIR CONTA PERMANENTEMENTE?\n\nEsta ação removerá:\n• Seu perfil\n• Todas suas teorias\n• Seus posts no fórum\n• Seus arquivos\n• Seus grupos\n\nEsta ação NÃO PODE ser desfeita!')) {
    return;
  }
  
  const password = prompt('Digite sua senha para confirmar a exclusão:');
  if (!password) return;
  
  const user = appState.users[appState.currentUser];
  if (!user || user.password !== password) {
    showToast('Senha incorreta!', 'error');
    return;
  }
  
  const username = appState.currentUser;
  
  // Remover do sistema de amigos
  Object.keys(appState.friends).forEach(friend => {
    appState.friends[friend] = appState.friends[friend].filter(f => f !== username);
  });
  
  // Remover solicitações de amizade
  Object.keys(appState.friendRequests).forEach(user => {
    appState.friendRequests[user] = appState.friendRequests[user].filter(req => 
      req.from !== username && req.to !== username
    );
  });
  
  // Remover mensagens privadas
  Object.keys(appState.privateMessages).forEach(user => {
    delete appState.privateMessages[user][username];
    // Remover conversas do usuário deletado
    if (user === username) {
      delete appState.privateMessages[username];
    }
  });
  
  // Remover mensagens do chat
  Object.keys(appState.chatMessages).forEach(channel => {
    appState.chatMessages[channel] = appState.chatMessages[channel].filter(msg => 
      msg.author !== username
    );
  });
  
  // Remover teorias
  appState.theories = appState.theories.filter(t => t.author !== username);
  
  // Remover tópicos do fórum
  appState.forumTopics = appState.forumTopics.filter(t => t.author !== username);
  
  // Remover arquivos
  appState.files = appState.files.filter(f => f.owner !== username);
  
  // Remover grupos (se dono, remover grupo completamente)
  appState.groups = appState.groups.filter(group => {
    if (group.owner === username) {
      // Remover do contador de grupos dos membros
      group.members.forEach(member => {
        if (appState.users[member] && member !== username) {
          appState.users[member].stats.groups--;
        }
      });
      return false; // Remover grupo
    }
    // Remover usuário da lista de membros
    group.members = group.members.filter(m => m !== username);
    return true; // Manter grupo
  });
  
  // Remover usuário
  delete appState.users[username];
  delete appState.friends[username];
  delete appState.friendRequests[username];
  
  saveState();
  
  // Fazer logout
  logout();
  
  showToast(`Conta ${username} excluída permanentemente.`, 'info');
}

// ============================================
// 16.6 SISTEMA ADMINISTRATIVO
// ============================================

function renderAdmin() {
  if (!appState.isNucleo) {
    showToast('Acesso negado! Apenas membros do núcleo.', 'error');
    loadSection('dashboard');
    return;
  }
  
  const totalUsers = Object.keys(appState.users).length;
  const totalTheories = appState.theories.length;
  const totalForumTopics = appState.forumTopics.length;
  const totalFiles = appState.files.length;
  const totalGroups = appState.groups.length;
  
  const pendingTheories = appState.theories.filter(t => t.status === 'pending');
  const activeUsers = Object.keys(appState.onlineUsers).filter(u => 
    appState.onlineUsers[u].status === 'online'
  ).length;
  
  const content = document.getElementById('mainContent');
  content.innerHTML = `
    <div class="content-header">
      <h1>Painel Administrativo</h1>
      <p>Área restrita do núcleo científico</p>
    </div>
    
    <div class="stats-grid">
      <div class="stat-card">
        <h3>Usuários Totais</h3>
        <div class="stat-value">${totalUsers}</div>
        <div class="stat-trend">
          <i class="fas fa-user"></i>
          <span>${activeUsers} online</span>
        </div>
      </div>
      
      <div class="stat-card">
        <h3>Teorias</h3>
        <div class="stat-value">${totalTheories}</div>
        <div class="stat-trend">
          <i class="fas fa-clock"></i>
          <span>${pendingTheories.length} pendentes</span>
        </div>
      </div>
      
      <div class="stat-card">
        <h3>Fórum</h3>
        <div class="stat-value">${totalForumTopics}</div>
        <div class="stat-trend">
          <i class="fas fa-comment"></i>
          <span>tópicos</span>
        </div>
      </div>
      
      <div class="stat-card">
        <h3>Arquivos</h3>
        <div class="stat-value">${totalFiles}</div>
        <div class="stat-trend">
          <i class="fas fa-hdd"></i>
          <span>armazenados</span>
        </div>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Teorias Pendentes (${pendingTheories.length})</h2>
      </div>
      
      <div class="theories-grid">
        ${renderPendingTheories(pendingTheories)}
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Gerenciamento de Usuários</h2>
      </div>
      
      <div class="module-actions">
        <input type="text" id="adminUserSearch" class="form-control" style="max-width: 300px;"
               placeholder="Buscar usuários..." onkeyup="searchAdminUsers(this.value)">
      </div>
      
      <div class="forum-table-container">
        <table class="forum-table">
          <thead>
            <tr>
              <th>Usuário</th>
              <th>Status</th>
              <th>Membro desde</th>
              <th>Núcleo</th>
              <th>Estatísticas</th>
              <th>Ações</th>
            </tr>
          </thead>
          <tbody id="adminUsersList">
            ${renderAdminUsers()}
          </tbody>
        </table>
      </div>
    </div>
    
    <div class="module-container">
      <div class="module-header">
        <h2>Ferramentas do Sistema</h2>
      </div>
      
      <div class="module-actions">
        <button class="module-button warning" onclick="exportAllData()">
          <i class="fas fa-database"></i> Exportar Todos os Dados
        </button>
        <button class="module-button" onclick="clearNotifications()">
          <i class="fas fa-bell-slash"></i> Limpar Notificações
        </button>
        <button class="module-button danger" onclick="resetSystem()">
          <i class="fas fa-trash"></i> Resetar Sistema
        </button>
      </div>
    </div>
  `;
}

function renderPendingTheories(theories) {
  if (theories.length === 0) {
    return `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--text-soft);">
        <i class="fas fa-check-circle" style="font-size: 48px; margin-bottom: 15px;"></i>
        <p>Nenhuma teoria pendente para revisão.</p>
      </div>
    `;
  }
  
  return theories.slice(0, 6).map(theory => {
    return `
      <div class="theory-card">
        <h4>${theory.title}</h4>
        
        <div class="theory-meta">
          <span><i class="fas fa-user"></i> ${theory.author}</span>
          <span><i class="fas fa-calendar"></i> ${new Date(theory.createdAt).toLocaleDateString()}</span>
          <span><i class="fas fa-tag"></i> ${theory.category}</span>
        </div>
        
        <div class="theory-preview">
          ${theory.content.substring(0, 120)}...
        </div>
        
        <div class="theory-actions">
          <button class="module-button" onclick="viewTheory('${theory.id}')">
            <i class="fas fa-eye"></i> Revisar
          </button>
          <button class="module-button success" onclick="approveTheory('${theory.id}')">
            <i class="fas fa-check"></i> Aprovar
          </button>
          <button class="module-button danger" onclick="rejectTheory('${theory.id}')">
            <i class="fas fa-times"></i> Rejeitar
          </button>
        </div>
      </div>
    `;
  }).join('');
}

function renderAdminUsers() {
  const users = Object.entries(appState.users);
  
  return users.map(([username, user]) => {
    const isOnline = appState.onlineUsers[username]?.status === 'online';
    const theoriesCount = appState.theories.filter(t => t.author === username).length;
    const forumCount = appState.forumTopics.filter(t => t.author === username).length;
    
    return `
      <tr>
        <td>
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${user.profile.avatarUrl || user.profile.avatar}" 
                 class="avatar avatar-small" alt="${username}">
            <div>
              <div style="font-weight: 500;">${username}</div>
              <div style="font-size: 12px; color: var(--text-soft);">
                ${user.profile?.area || 'Sem área definida'}
              </div>
            </div>
          </div>
        </td>
        <td>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div class="status-indicator ${isOnline ? 'status-online-ind' : 'status-offline-ind'}"></div>
            <span>${isOnline ? 'Online' : 'Offline'}</span>
          </div>
        </td>
        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
        <td>
          <span style="background: ${user.nucleo ? 'rgba(155, 89, 182, 0.1)' : 'rgba(149, 165, 166, 0.1)'}; 
                color: ${user.nucleo ? 'var(--accent-secondary)' : 'var(--text-soft)'}; 
                padding: 4px 10px; border-radius: 10px; font-size: 12px;">
            ${user.nucleo ? 'Sim' : 'Não'}
          </span>
        </td>
        <td>
          <div style="font-size: 12px; color: var(--text-soft);">
            <div>T: ${theoriesCount} • F: ${forumCount} • A: ${user.stats?.friends || 0}</div>
          </div>
        </td>
        <td>
          <div style="display: flex; gap: 8px;">
            <button class="module-button" style="padding: 6px 12px; font-size: 12px;" 
                    onclick="adminViewUser('${username}')">
              <i class="fas fa-eye"></i>
            </button>
            <button class="module-button ${user.nucleo ? 'danger' : 'success'}" 
                    style="padding: 6px 12px; font-size: 12px;" 
                    onclick="toggleNucleoStatus('${username}', ${!user.nucleo})">
              <i class="fas ${user.nucleo ? 'fa-user' : 'fa-user-shield'}"></i>
            </button>
            <button class="module-button danger" style="padding: 6px 12px; font-size: 12px;" 
                    onclick="adminDeleteUser('${username}')">
              <i class="fas fa-trash"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
}

function searchAdminUsers(query) {
  const users = Object.entries(appState.users);
  
  if (!query.trim()) {
    document.getElementById('adminUsersList').innerHTML = renderAdminUsers();
    return;
  }
  
  const filtered = users.filter(([username, user]) => 
    username.toLowerCase().includes(query.toLowerCase()) ||
    (user.profile?.area || '').toLowerCase().includes(query.toLowerCase())
  );
  
  const html = filtered.map(([username, user]) => {
    const isOnline = appState.onlineUsers[username]?.status === 'online';
    const theoriesCount = appState.theories.filter(t => t.author === username).length;
    
    return `
      <tr>
        <td>
          <div style="display: flex; align-items: center; gap: 10px;">
            <img src="${user.profile.avatarUrl || user.profile.avatar}" 
                 class="avatar avatar-small" alt="${username}">
            <span>${username}</span>
          </div>
        </td>
        <td>
          <div style="display: flex; align-items: center; gap: 5px;">
            <div class="status-indicator ${isOnline ? 'status-online-ind' : 'status-offline-ind'}"></div>
            <span>${isOnline ? 'Online' : 'Offline'}</span>
          </div>
        </td>
        <td>${new Date(user.createdAt).toLocaleDateString()}</td>
        <td>
          <span style="background: ${user.nucleo ? 'rgba(155, 89, 182, 0.1)' : 'rgba(149, 165, 166, 0.1)'}; 
                color: ${user.nucleo ? 'var(--accent-secondary)' : 'var(--text-soft)'}; 
                padding: 4px 10px; border-radius: 10px; font-size: 12px;">
            ${user.nucleo ? 'Sim' : 'Não'}
          </span>
        </td>
        <td>T: ${theoriesCount}</td>
        <td>
          <div style="display: flex; gap: 8px;">
            <button class="module-button" style="padding: 6px 12px; font-size: 12px;" 
                    onclick="adminViewUser('${username}')">
              <i class="fas fa-eye"></i>
            </button>
            <button class="module-button ${user.nucleo ? 'danger' : 'success'}" 
                    style="padding: 6px 12px; font-size: 12px;" 
                    onclick="toggleNucleoStatus('${username}', ${!user.nucleo})">
              <i class="fas ${user.nucleo ? 'fa-user' : 'fa-user-shield'}"></i>
            </button>
          </div>
        </td>
      </tr>
    `;
  }).join('');
  
  document.getElementById('adminUsersList').innerHTML = html || `
    <tr>
      <td colspan="6" style="text-align: center; padding: 20px; color: var(--text-soft);">
        Nenhum usuário encontrado.
      </td>
    </tr>
  `;
}

function adminViewUser(username) {
  viewProfile(username);
}

function toggleNucleoStatus(username, makeNucleo) {
  const user = appState.users[username];
  if (!user) return;
  
  if (makeNucleo) {
    if (!confirm(`Tornar ${username} membro do núcleo científico?\n\nIsso dará acesso total ao painel administrativo.`)) {
      return;
    }
    user.nucleo = true;
    showToast(`${username} agora é membro do núcleo!`, 'success');
    
    // Notificar o usuário
    addNotification(
      'Promovido ao Núcleo Científico',
      'Você foi promovido a membro do núcleo científico! Agora tem acesso ao painel administrativo.',
      'success',
      'loadSection(\'admin\')'
    );
  } else {
    if (!confirm(`Remover ${username} do núcleo científico?\n\nIsso revogará o acesso ao painel administrativo.`)) {
      return;
    }
    user.nucleo = false;
    showToast(`${username} removido do núcleo.`, 'info');
    
    // Notificar o usuário
    addNotification(
      'Removido do Núcleo Científico',
      'Você foi removido do núcleo científico. Acesso administrativo revogado.',
      'warning',
      ''
    );
  }
  
  saveState();
  renderAdmin();
}

function adminDeleteUser(username) {
  if (username === appState.currentUser) {
    showToast('Você não pode excluir sua própria conta pelo painel admin!', 'error');
    return;
  }
  
  if (!confirm(`EXCLUIR PERMANENTEMENTE a conta de ${username}?\n\nTodos os dados deste usuário serão perdidos!`)) {
    return;
  }
  
  // Simular a exclusão chamando a função de exclusão
  const originalCurrentUser = appState.currentUser;
  appState.currentUser = username;
  deleteAccount();
  appState.currentUser = originalCurrentUser;
  
  showToast(`Conta de ${username} excluída!`, 'success');
  renderAdmin();
}

function exportAllData() {
  if (!confirm('Exportar TODOS os dados do sistema?\n\nIsso inclui todos os usuários, teorias, fórum, etc.')) {
    return;
  }
  
  const allData = {
    appState: appState,
    exportedAt: new Date().toISOString(),
    exportedBy: appState.currentUser,
    version: APP_VERSION
  };
  
  const dataStr = JSON.stringify(allData, null, 2);
  const dataUri = 'data:application/json;charset=utf-8,' + encodeURIComponent(dataStr);
  
  const exportFileDefaultName = `renova_system_backup_${new Date().toISOString().split('T')[0]}.json`;
  
  const linkElement = document.createElement('a');
  linkElement.setAttribute('href', dataUri);
  linkElement.setAttribute('download', exportFileDefaultName);
  linkElement.click();
  
  showToast('Backup do sistema exportado!', 'success');
}

function clearNotifications() {
  appState.notifications = [];
  saveState();
  showToast('Todas as notificações foram limpas!', 'success');
}

function resetSystem() {
  if (!confirm('RESETAR COMPLETAMENTE O SISTEMA?\n\nIsso apagará TODOS os dados:\n• Todos os usuários\n• Todas as teorias\n• Todo o fórum\n• Todos os arquivos\n• Todos os grupos\n\nAPENAS para desenvolvimento!')) {
    return;
  }
  
  const confirmation = prompt('Digite "RESETAR TUDO" para confirmar:');
  if (confirmation !== 'RESETAR TUDO') return;
  
  // Limpar todos os dados
  localStorage.clear();
  
  // Recarregar a página
  location.reload();
}

// ============================================
// 16.7 FUNÇÕES AUXILIARES FINAIS
// ============================================

function isToday(date) {
  const today = new Date();
  return date.getDate() === today.getDate() &&
         date.getMonth() === today.getMonth() &&
         date.getFullYear() === today.getFullYear();
}

// ============================================
// 17. INICIALIZAÇÃO COMPLETA
// ============================================

// Esta é a parte final do código - todas as funções estão implementadas!
console.log('Sistema Renova v' + APP_VERSION + ' carregado com sucesso!');
