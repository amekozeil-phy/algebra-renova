<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Algebra Renova - Revolu√ß√£o Matem√°tica</title>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- Fontes -->
    <link href="https://fonts.googleapis.com/css2?family=Source+Code+Pro:wght@300;400;600;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Toastr -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/toastr.js/latest/toastr.min.js"></script>
    
    <style>
        /* ===== VARI√ÅVEIS DE CORES ===== */
        :root {
            /* Cores base por n√≠vel */
            --nucleo-primary: #8B4513;
            --nucleo-secondary: #DAA520;
            --nucleo-accent: #FFD700;
            
            --iniciado-primary: #1E3A8A;
            --iniciado-secondary: #3B82F6;
            --iniciado-accent: #60A5FA;
            
            --observador-primary: #374151;
            --observador-secondary: #6B7280;
            --observador-accent: #9CA3AF;
            
            /* Cores gerais */
            --bg-dark: #0A0A0F;
            --bg-card: #121218;
            --bg-input: #1A1A24;
            --border-color: #2D2D3A;
            --text-primary: #F8F9FA;
            --text-secondary: #ADB5BD;
            --shadow: rgba(0, 0, 0, 0.3);
        }
        
        /* ===== RESET E ESTILOS GERAIS ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Source Code Pro', monospace;
            background-color: var(--bg-dark);
            color: var(--text-primary);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        /* ===== UTILIT√ÅRIOS ===== */
        .hidden {
            display: none !important;
        }
        
        .visible {
            display: block !important;
        }
        
        /* ===== LAYOUT PRINCIPAL ===== */
        .app-container {
            display: flex;
            min-height: 100vh;
        }
        
        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background-color: var(--bg-card);
            border-right: 1px solid var(--border-color);
            padding: 20px 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }
        
        .logo {
            text-align: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--nucleo-accent);
            margin-bottom: 5px;
        }
        
        .logo .subtitle {
            font-size: 0.8rem;
            color: var(--text-secondary);
        }
        
        /* Informa√ß√µes do usu√°rio */
        .user-info {
            padding: 15px;
            text-align: center;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 20px;
        }
        
        .user-avatar {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            margin: 0 auto 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            font-weight: bold;
            cursor: pointer;
            border: 2px solid;
        }
        
        .user-name {
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 5px;
        }
        
        .user-level {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        /* Navega√ß√£o */
        .nav-section {
            padding: 15px 20px 5px;
            color: var(--text-secondary);
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .nav-item {
            list-style: none;
        }
        
        .nav-link {
            display: flex;
            align-items: center;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s;
            cursor: pointer;
        }
        
        .nav-link:hover {
            background-color: var(--bg-input);
            color: var(--text-primary);
        }
        
        .nav-link.active {
            background-color: var(--bg-input);
            color: var(--text-primary);
            border-left: 3px solid;
        }
        
        .nav-link i {
            margin-right: 10px;
            width: 20px;
            text-align: center;
        }
        
        /* ===== CONTE√öDO PRINCIPAL ===== */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 20px;
            min-height: 100vh;
        }
        
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .page-title {
            font-family: 'Cinzel', serif;
            font-size: 2rem;
            color: var(--text-primary);
        }
        
        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }
        
        /* ===== FORMUL√ÅRIOS ===== */
        .form-container {
            max-width: 600px;
            margin: 0 auto;
            background-color: var(--bg-card);
            border-radius: 10px;
            padding: 30px;
            border: 1px solid var(--border-color);
        }
        
        .form-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            margin-bottom: 25px;
            text-align: center;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        .form-control {
            width: 100%;
            padding: 12px 15px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            color: var(--text-primary);
            font-family: 'Source Code Pro', monospace;
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: var(--nucleo-accent);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border-radius: 6px;
            font-family: 'Source Code Pro', monospace;
            font-weight: 600;
            font-size: 1rem;
            cursor: pointer;
            border: none;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-primary {
            background-color: var(--nucleo-accent);
            color: #000;
        }
        
        .btn-primary:hover {
            background-color: var(--nucleo-secondary);
            transform: translateY(-2px);
        }
        
        .btn-secondary {
            background-color: var(--bg-input);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }
        
        .btn-secondary:hover {
            background-color: var(--border-color);
        }
        
        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }
        
        /* ===== LOGIN PAGE ===== */
        .login-page {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            background: linear-gradient(135deg, var(--bg-dark) 0%, #1a1a2e 100%);
        }
        
        .login-box {
            width: 100%;
            max-width: 500px;
            background-color: var(--bg-card);
            border-radius: 15px;
            padding: 40px;
            border: 1px solid var(--border-color);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
        }
        
        .login-logo {
            text-align: center;
            margin-bottom: 30px;
        }
        
        .login-logo h1 {
            font-family: 'Cinzel', serif;
            font-size: 2.5rem;
            color: var(--nucleo-accent);
            margin-bottom: 10px;
        }
        
        .login-footer {
            text-align: center;
            margin-top: 30px;
            color: var(--text-secondary);
            font-size: 0.9rem;
        }
        
        /* ===== CART√ïES ===== */
        .card {
            background-color: var(--bg-card);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid var(--border-color);
            margin-bottom: 20px;
            transition: transform 0.3s, box-shadow 0.3s;
        }
        
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 10px 20px var(--shadow);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--border-color);
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }
        
        /* ===== MODAIS ===== */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }
        
        .modal-content {
            background-color: var(--bg-card);
            border-radius: 15px;
            width: 90%;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            border: 1px solid var(--border-color);
            position: relative;
        }
        
        .modal-header {
            padding: 25px 30px 15px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-title {
            font-family: 'Cinzel', serif;
            font-size: 1.8rem;
            color: var(--text-primary);
        }
        
        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            transition: color 0.3s;
        }
        
        .modal-close:hover {
            color: var(--text-primary);
        }
        
        .modal-body {
            padding: 25px 30px;
        }
        
        /* ===== CHAT ===== */
        .chat-container {
            display: flex;
            height: 70vh;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
        }
        
        .chat-sidebar {
            width: 250px;
            background-color: var(--bg-input);
            border-right: 1px solid var(--border-color);
            padding: 20px;
            overflow-y: auto;
        }
        
        .chat-main {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .chat-header {
            padding: 15px 20px;
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chat-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            padding: 12px 15px;
            border-radius: 10px;
            max-width: 70%;
        }
        
        .message-sent {
            background-color: rgba(139, 69, 19, 0.3);
            margin-left: auto;
            border: 1px solid rgba(139, 69, 19, 0.5);
        }
        
        .message-received {
            background-color: var(--bg-input);
            margin-right: auto;
            border: 1px solid var(--border-color);
        }
        
        .message-sender {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 0.9rem;
        }
        
        .message-content {
            line-height: 1.5;
        }
        
        .message-time {
            font-size: 0.75rem;
            color: var(--text-secondary);
            text-align: right;
            margin-top: 5px;
        }
        
        .chat-input-area {
            padding: 15px;
            background-color: var(--bg-card);
            border-top: 1px solid var(--border-color);
        }
        
        .chat-input {
            width: 100%;
            min-height: 60px;
            padding: 12px 15px;
            background-color: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-family: 'Source Code Pro', monospace;
            resize: none;
        }
        
        /* ===== LISTAS ===== */
        .list {
            display: grid;
            gap: 20px;
        }
        
        .list-item {
            background-color: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .list-item:hover {
            border-color: var(--nucleo-accent);
            transform: translateY(-2px);
        }
        
        .list-title {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text-primary);
        }
        
        .list-description {
            color: var(--text-secondary);
            margin-bottom: 15px;
            line-height: 1.5;
        }
        
        .list-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-secondary);
        }
        
        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        
        .badge-nucleo {
            background-color: rgba(139, 69, 19, 0.2);
            color: var(--nucleo-accent);
            border: 1px solid var(--nucleo-accent);
        }
        
        .badge-iniciado {
            background-color: rgba(30, 58, 138, 0.2);
            color: var(--iniciado-accent);
            border: 1px solid var(--iniciado-accent);
        }
        
        .badge-observador {
            background-color: rgba(55, 65, 81, 0.2);
            color: var(--observador-accent);
            border: 1px solid var(--observador-accent);
        }
        
        /* ===== P√ÅGINAS ===== */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        /* ===== GRID DE ESTAT√çSTICAS ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background-color: var(--bg-card);
            border-radius: 10px;
            padding: 25px;
            border: 1px solid var(--border-color);
            text-align: center;
        }
        
        .stat-value {
            font-size: 3rem;
            font-weight: bold;
            margin-bottom: 10px;
        }
        
        .stat-label {
            color: var(--text-secondary);
            font-size: 1rem;
        }
        
        /* ===== RESPONSIVIDADE ===== */
        @media (max-width: 1024px) {
            .sidebar {
                width: 80px;
            }
            
            .logo h1, .user-name, .nav-text, .nav-section {
                display: none;
            }
            
            .main-content {
                margin-left: 80px;
            }
            
            .nav-link {
                justify-content: center;
                padding: 15px;
            }
            
            .nav-link i {
                margin-right: 0;
                font-size: 1.2rem;
            }
        }
        
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .main-content {
                margin-left: 0;
            }
            
            .chat-container {
                flex-direction: column;
                height: 80vh;
            }
            
            .chat-sidebar {
                width: 100%;
                height: 200px;
                border-right: none;
                border-bottom: 1px solid var(--border-color);
            }
        }
    </style>
</head>
<body>
    <!-- P√ÅGINA DE LOGIN -->
    <div id="login-page" class="login-page">
        <div class="login-box">
            <div class="login-logo">
                <h1>ALGEBRA RENOVA</h1>
                <p class="subtitle">Revolution. Algebra et Perseverantia.</p>
            </div>
            
            <form id="login-form">
                <div class="form-group">
                    <label class="form-label" for="login-name">Nome Simb√≥lico *</label>
                    <input type="text" class="form-control" id="login-name" placeholder="Seu nome dentro da organiza√ß√£o" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-specialty">Especialidade Matem√°tica *</label>
                    <input type="text" class="form-control" id="login-specialty" placeholder="Ex: √Ålgebra Abstrata, Teoria das Categorias..." required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-bio">Biografia (opcional)</label>
                    <textarea class="form-control" id="login-bio" placeholder="Conte sobre sua jornada matem√°tica..."></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-password">Senha de Inicia√ß√£o *</label>
                    <input type="password" class="form-control" id="login-password" placeholder="Escolha uma senha segura" required>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="login-level">N√≠vel de Acesso *</label>
                    <select class="form-control" id="login-level" required>
                        <option value="">Selecione seu n√≠vel</option>
                        <option value="observador">Observador</option>
                        <option value="iniciado">Iniciado</option>
                    </select>
                </div>
                
                <div class="form-group" id="nucleo-key-group">
                    <label class="form-label" for="nucleo-key">Chave Secreta do N√∫cleo (opcional)</label>
                    <input type="password" class="form-control" id="nucleo-key" placeholder="Digite a chave secreta...">
                    <small style="color: var(--text-secondary); font-size: 0.8rem; display: block; margin-top: 5px;">
                        O n√≠vel N√∫cleo n√£o aparece na lista. Apenas membros com a chave correta podem acessar.
                    </small>
                </div>
                
                <button type="submit" class="btn btn-primary" style="width: 100%;">
                    <i class="fas fa-door-open"></i> Acessar o Portal
                </button>
            </form>
            
            <div class="login-footer">
                <p>"A matem√°tica √© a linguagem com a qual Deus escreveu o universo." - Galileo Galilei</p>
            </div>
        </div>
    </div>

    <!-- APLICA√á√ÉO PRINCIPAL -->
    <div id="app" class="app-container hidden">
        <!-- SIDEBAR -->
        <aside class="sidebar">
            <div class="logo">
                <h1>AR</h1>
                <p class="subtitle">Algebra Renova</p>
            </div>
            
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">
                    <!-- Avatar ser√° gerado dinamicamente -->
                </div>
                <div class="user-name" id="user-display-name">Carregando...</div>
                <div class="user-level" id="user-level-badge">N√≠vel</div>
            </div>
            
            <div class="nav-section">Navega√ß√£o</div>
            <ul>
                <li class="nav-item">
                    <a class="nav-link active" data-page="dashboard">
                        <i class="fas fa-chart-bar"></i>
                        <span class="nav-text">Dashboard</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="theories">
                        <i class="fas fa-atom"></i>
                        <span class="nav-text">Teorias</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="research-groups">
                        <i class="fas fa-users"></i>
                        <span class="nav-text">Grupos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="forum">
                        <i class="fas fa-comments"></i>
                        <span class="nav-text">F√≥rum</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="chat">
                        <i class="fas fa-comment-dots"></i>
                        <span class="nav-text">Chat Geral</span>
                    </a>
                </li>
            </ul>
            
            <div class="nav-section">Rede Social</div>
            <ul>
                <li class="nav-item">
                    <a class="nav-link" data-page="contacts">
                        <i class="fas fa-address-book"></i>
                        <span class="nav-text">Contatos</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="private-chat">
                        <i class="fas fa-user-friends"></i>
                        <span class="nav-text">Chat Privado</span>
                        <span class="badge" id="unread-dm-count">0</span>
                    </a>
                </li>
            </ul>
            
            <div class="nav-section">Administra√ß√£o</div>
            <ul>
                <li class="nav-item">
                    <a class="nav-link" data-page="profile">
                        <i class="fas fa-user-cog"></i>
                        <span class="nav-text">Perfil</span>
                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" data-page="members">
                        <i class="fas fa-users-cog"></i>
                        <span class="nav-text">Membros</span>
                    </a>
                </li>
                <li class="nav-item" id="nucleo-admin-item" style="display: none;">
                    <a class="nav-link" data-page="nucleo-admin">
                        <i class="fas fa-crown"></i>
                        <span class="nav-text">N√∫cleo</span>
                    </a>
                </li>
            </ul>
            
            <div style="padding: 20px; margin-top: 20px; border-top: 1px solid var(--border-color);">
                <button id="logout-btn" class="btn btn-secondary" style="width: 100%;">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <!-- CONTE√öDO PRINCIPAL -->
        <main class="main-content">
            <header class="header">
                <h1 class="page-title" id="page-title">Dashboard</h1>
                <div class="header-actions">
                    <div class="search-box">
                        <input type="text" id="global-search" placeholder="Buscar teorias, membros..." 
                               style="padding: 8px 15px; background: var(--bg-input); border: 1px solid var(--border-color); 
                                      border-radius: 20px; color: var(--text-primary); width: 200px;">
                    </div>
                    <button id="notifications-btn" class="btn btn-secondary btn-small">
                        <i class="fas fa-bell"></i>
                        <span id="notification-count">0</span>
                    </button>
                </div>
            </header>

            <!-- P√ÅGINAS DIN√ÇMICAS -->
            <div id="pages-container">
                <!-- Dashboard -->
                <div id="dashboard-page" class="page active">
                    <div class="stats-grid" id="stats-grid">
                        <!-- As estat√≠sticas ser√£o geradas dinamicamente -->
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Atividade Recente</h3>
                        </div>
                        <div id="recent-activity">
                            <!-- Atividades ser√£o carregadas aqui -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Meus Contatos Online</h3>
                        </div>
                        <div id="online-contacts">
                            <!-- Contatos online ser√£o carregados aqui -->
                        </div>
                    </div>
                </div>

                <!-- Teorias -->
                <div id="theories-page" class="page">
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="font-family: 'Cinzel', serif; font-size: 1.8rem;">Teorias Matem√°ticas</h2>
                        <button id="new-theory-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Nova Teoria
                        </button>
                    </div>
                    <div id="theories-list" class="list">
                        <!-- Teorias ser√£o carregadas aqui -->
                    </div>
                </div>

                <!-- Grupos de Pesquisa -->
                <div id="research-groups-page" class="page">
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="font-family: 'Cinzel', serif; font-size: 1.8rem;">Grupos de Pesquisa</h2>
                        <button id="new-group-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Criar Grupo
                        </button>
                    </div>
                    <div id="research-groups-list" class="list">
                        <!-- Grupos ser√£o carregados aqui -->
                    </div>
                </div>

                <!-- F√≥rum -->
                <div id="forum-page" class="page">
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="font-family: 'Cinzel', serif; font-size: 1.8rem;">F√≥rum de Desafios</h2>
                        <button id="new-forum-topic-btn" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Novo T√≥pico
                        </button>
                    </div>
                    <div id="forum-topics-list" class="list">
                        <!-- T√≥picos do f√≥rum ser√£o carregados aqui -->
                    </div>
                </div>

                <!-- Chat Geral -->
                <div id="chat-page" class="page">
                    <div class="chat-container">
                        <div class="chat-sidebar" id="chat-channels">
                            <!-- Canais ser√£o carregados aqui -->
                        </div>
                        <div class="chat-main">
                            <div class="chat-header">
                                <span id="current-channel">Geral</span>
                                <span id="online-count" style="font-size: 0.9rem; color: var(--text-secondary);">Online: 0</span>
                            </div>
                            <div class="chat-messages" id="chat-messages">
                                <!-- Mensagens ser√£o carregadas aqui -->
                            </div>
                            <div class="chat-input-area">
                                <textarea id="chat-input" class="chat-input" placeholder="Digite sua mensagem... Use LaTeX: $E = mc^2$"></textarea>
                                <button id="send-chat-btn" class="btn btn-primary" style="margin-top: 10px; float: right;">
                                    <i class="fas fa-paper-plane"></i> Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Contatos -->
                <div id="contacts-page" class="page">
                    <div class="page-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
                        <h2 style="font-family: 'Cinzel', serif; font-size: 1.8rem;">Meus Contatos</h2>
                        <button id="add-contact-btn" class="btn btn-primary">
                            <i class="fas fa-user-plus"></i> Adicionar Contato
                        </button>
                    </div>
                    <div id="contacts-list" class="list">
                        <!-- Contatos ser√£o carregados aqui -->
                    </div>
                </div>

                <!-- Chat Privado -->
                <div id="private-chat-page" class="page">
                    <div class="chat-container">
                        <div class="chat-sidebar" id="private-chat-contacts">
                            <!-- Contatos para chat privado ser√£o carregados aqui -->
                        </div>
                        <div class="chat-main">
                            <div class="chat-header">
                                <span id="private-chat-with">Selecione um contato</span>
                            </div>
                            <div class="chat-messages" id="private-chat-messages">
                                <!-- Mensagens privadas ser√£o carregadas aqui -->
                            </div>
                            <div class="chat-input-area" id="private-chat-input-area" style="display: none;">
                                <textarea id="private-chat-input" class="chat-input" placeholder="Digite sua mensagem privada..."></textarea>
                                <button id="send-private-chat-btn" class="btn btn-primary" style="margin-top: 10px; float: right;">
                                    <i class="fas fa-paper-plane"></i> Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Perfil -->
                <div id="profile-page" class="page">
                    <div class="form-container">
                        <h2 class="form-title">Meu Perfil</h2>
                        <form id="profile-form">
                            <div class="form-group">
                                <label class="form-label" for="profile-name">Nome Simb√≥lico</label>
                                <input type="text" class="form-control" id="profile-name" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="profile-specialty">Especialidade</label>
                                <input type="text" class="form-control" id="profile-specialty" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="profile-bio">Biografia</label>
                                <textarea class="form-control" id="profile-bio" rows="4"></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label" for="profile-level">N√≠vel de Acesso</label>
                                <input type="text" class="form-control" id="profile-level" readonly>
                            </div>
                            
                            <div style="display: flex; gap: 15px; margin-top: 30px;">
                                <button type="submit" class="btn btn-primary">Salvar Altera√ß√µes</button>
                                <button type="button" id="change-password-btn" class="btn btn-secondary">Alterar Senha</button>
                            </div>
                        </form>
                        
                        <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid var(--border-color);">
                            <h3 style="margin-bottom: 20px;">Minhas Estat√≠sticas</h3>
                            <div class="stats-grid" style="grid-template-columns: repeat(2, 1fr);">
                                <div class="stat-card">
                                    <div class="stat-value" id="profile-theories-count">0</div>
                                    <div class="stat-label">Teorias Criadas</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="profile-posts-count">0</div>
                                    <div class="stat-label">Posts no F√≥rum</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="profile-groups-count">0</div>
                                    <div class="stat-label">Grupos</div>
                                </div>
                                <div class="stat-card">
                                    <div class="stat-value" id="profile-contacts-count">0</div>
                                    <div class="stat-label">Contatos</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Membros -->
                <div id="members-page" class="page">
                    <div class="page-header" style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Cinzel', serif; font-size: 1.8rem;">Todos os Membros</h2>
                    </div>
                    
                    <div style="display: flex; gap: 20px; margin-bottom: 30px;">
                        <input type="text" id="search-members" class="form-control" placeholder="Buscar membros...">
                        <select id="filter-level" class="form-control" style="width: 200px;">
                            <option value="">Todos os n√≠veis</option>
                            <option value="nucleo">N√∫cleo</option>
                            <option value="iniciado">Iniciado</option>
                            <option value="observador">Observador</option>
                        </select>
                    </div>
                    
                    <div id="members-list" class="list">
                        <!-- Membros ser√£o carregados aqui -->
                    </div>
                </div>

                <!-- Administra√ß√£o do N√∫cleo -->
                <div id="nucleo-admin-page" class="page">
                    <div class="page-header" style="margin-bottom: 30px;">
                        <h2 style="font-family: 'Cinzel', serif; font-size: 1.8rem;">Administra√ß√£o do N√∫cleo</h2>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Promover Membros</h3>
                        </div>
                        <div id="promote-members-list">
                            <!-- Membros para promover ser√£o carregados aqui -->
                        </div>
                    </div>
                    
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Teorias para Aprova√ß√£o</h3>
                        </div>
                        <div id="pending-theories">
                            <!-- Teorias pendentes ser√£o carregadas aqui -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- MODAL CONTAINER -->
    <div id="modal-container"></div>

    <script>
        // =============================================
        // CONSTANTES E CONFIGURA√á√ïES
        // =============================================
        const NUCLEO_SECRET = "Renova, O Non Trad";
        const STORAGE_KEYS = {
            CURRENT_USER: 'algebra_renova_current_user',
            USERS: 'algebra_renova_users',
            THEORIES: 'algebra_renova_theories',
            FORUM_POSTS: 'algebra_renova_forum_posts',
            RESEARCH_GROUPS: 'algebra_renova_research_groups',
            CHAT_MESSAGES: 'algebra_renova_chat_messages',
            PRIVATE_MESSAGES: 'algebra_renova_private_messages',
            CONTACTS: 'algebra_renova_contacts',
            NOTIFICATIONS: 'algebra_renova_notifications'
        };

        // =============================================
        // ESTADO GLOBAL DA APLICA√á√ÉO
        // =============================================
        let currentUser = null;
        let appState = {
            users: [],
            theories: [],
            forumPosts: [],
            researchGroups: [],
            chatMessages: {},
            privateMessages: {},
            contacts: [],
            notifications: [],
            currentPage: 'dashboard',
            currentPrivateChat: null
        };

        // =============================================
        // FUN√á√ïES DE UTILIDADE
        // =============================================
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function formatDate(dateString) {
            try {
                const date = new Date(dateString);
                const now = new Date();
                const diffMs = now - date;
                const diffMins = Math.floor(diffMs / 60000);
                
                if (diffMins < 1) return "Agora mesmo";
                if (diffMins < 60) return `${diffMins} min atr√°s`;
                if (diffMins < 1440) return `${Math.floor(diffMins/60)} h atr√°s`;
                
                return date.toLocaleDateString('pt-BR', { 
                    day: '2-digit', 
                    month: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
            } catch {
                return "Data desconhecida";
            }
        }

        function showToast(message, type = 'success') {
            toastr.options = {
                positionClass: "toast-top-right",
                progressBar: true,
                closeButton: true,
                timeOut: 3000,
                closeDuration: 300
            };
            
            switch(type) {
                case 'success': toastr.success(message); break;
                case 'error': toastr.error(message); break;
                case 'warning': toastr.warning(message); break;
                case 'info': toastr.info(message); break;
            }
        }

        function saveToStorage(key, data) {
            try {
                localStorage.setItem(key, JSON.stringify(data));
                return true;
            } catch (error) {
                console.error(`Erro ao salvar em ${key}:`, error);
                showToast('Erro ao salvar dados', 'error');
                return false;
            }
        }

        function loadFromStorage(key) {
            try {
                const data = localStorage.getItem(key);
                return data ? JSON.parse(data) : null;
            } catch (error) {
                console.error(`Erro ao carregar de ${key}:`, error);
                return null;
            }
        }

        function getLevelColor(level) {
            switch(level) {
                case 'nucleo': return { bg: 'var(--nucleo-primary)', color: 'var(--nucleo-accent)', badge: 'badge-nucleo' };
                case 'iniciado': return { bg: 'var(--iniciado-primary)', color: 'var(--iniciado-accent)', badge: 'badge-iniciado' };
                default: return { bg: 'var(--observador-primary)', color: 'var(--observador-accent)', badge: 'badge-observador' };
            }
        }

        function getAvatarInitials(name) {
            return name.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
        }

        // =============================================
        // INICIALIZA√á√ÉO DO STORAGE
        // =============================================
        function initializeStorage() {
            // Inicializar dados se n√£o existirem
            Object.values(STORAGE_KEYS).forEach(key => {
                if (!localStorage.getItem(key)) {
                    let defaultValue = [];
                    
                    if (key === STORAGE_KEYS.USERS) {
                        // Criar usu√°rio fundador
                        defaultValue = [{
                            id: 'founder',
                            name: 'Lohan Cunha',
                            specialty: '√Ålgebra Abstrata, Teoria das Categorias',
                            bio: 'Fundador do Algebra Renova. Acredito na matem√°tica como revolu√ß√£o intelectual.',
                            level: 'nucleo',
                            password: 'admin123',
                            joinDate: new Date().toISOString(),
                            lastSeen: new Date().toISOString(),
                            status: 'online'
                        }];
                    } else if (key === STORAGE_KEYS.CHAT_MESSAGES) {
                        defaultValue = {
                            general: [{
                                id: generateId(),
                                sender: 'Sistema',
                                senderId: 'system',
                                message: 'üåü Bem-vindo ao chat geral do Algebra Renova! üåü\n\nDiscuta ideias, teorias e conjecturas com outros membros.\nUse LaTeX para f√≥rmulas: $E = mc^2$ ou $$\\int_a^b f(x)dx$$',
                                timestamp: new Date().toISOString(),
                                type: 'system'
                            }]
                        };
                    } else if (key === STORAGE_KEYS.PRIVATE_MESSAGES) {
                        defaultValue = {};
                    } else if (key === STORAGE_KEYS.THEORIES) {
                        defaultValue = [{
                            id: generateId(),
                            title: '√Ålgebra das Anti-identidades',
                            description: 'Uma abordagem revolucion√°ria onde as identidades alg√©bricas tradicionais s√£o questionadas e reinventadas.',
                            content: 'Na √°lgebra tradicional, temos identidades fundamentais como:\n\n$$a + 0 = a$$\n$$a \\cdot 1 = a$$\n\nNesta teoria, propomos sistemas onde estas identidades **n√£o se mant√™m**. Isso nos leva a estruturas como:\n\n$$a + 0 \\neq a$$\n$$a \\cdot 1 \\neq a$$\n\nEssa abordagem permite a cria√ß√£o de estruturas alg√©bricas totalmente novas, com propriedades contra-intuitivas.',
                            visibility: 'public',
                            tags: ['√°lgebra', 'anti-identidades', 'revolu√ß√£o'],
                            authorId: 'founder',
                            author: 'Lohan Cunha',
                            createdAt: new Date(Date.now() - 86400000).toISOString(), // 1 dia atr√°s
                            updatedAt: new Date(Date.now() - 86400000).toISOString(),
                            status: 'published'
                        }];
                    } else if (key === STORAGE_KEYS.FORUM_POSTS) {
                        defaultValue = [{
                            id: generateId(),
                            title: 'Desafio: Provar que 1+1=2 usando apenas axiomas b√°sicos',
                            content: 'Este √© um desafio cl√°ssico: prove que 1+1=2 usando apenas os axiomas de Peano ou ZFC.\n\nDica: Comece definindo o que √© "1", "2" e a opera√ß√£o "+".\n\n$$1 := S(0)$$\n$$2 := S(S(0))$$\n$$a + 0 = a$$\n$$a + S(b) = S(a + b)$$',
                            authorId: 'founder',
                            author: 'Lohan Cunha',
                            createdAt: new Date(Date.now() - 43200000).toISOString(), // 12 horas atr√°s
                            category: 'desafio',
                            tags: ['aritm√©tica', 'l√≥gica', 'desafio'],
                            replies: []
                        }];
                    } else if (key === STORAGE_KEYS.RESEARCH_GROUPS) {
                        defaultValue = [{
                            id: generateId(),
                            name: 'Transfunctora√ß√£o Qu√¢ntica',
                            description: 'Estudo das transforma√ß√µes radicais entre estruturas matem√°ticas de diferentes dimens√µes.',
                            creatorId: 'founder',
                            visibility: 'public',
                            members: ['founder'],
                            createdAt: new Date().toISOString()
                        }];
                    }
                    
                    saveToStorage(key, defaultValue);
                }
            });
        }

        // =============================================
        // FUN√á√ïES DE AUTENTICA√á√ÉO
        // =============================================
        function handleLogin(event) {
            event.preventDefault();
            
            const name = document.getElementById('login-name').value.trim();
            const specialty = document.getElementById('login-specialty').value.trim();
            const bio = document.getElementById('login-bio').value.trim();
            const password = document.getElementById('login-password').value;
            const levelSelect = document.getElementById('login-level').value;
            const nucleoKey = document.getElementById('nucleo-key').value;
            
            // Valida√ß√µes b√°sicas
            if (!name || !specialty || !password || !levelSelect) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            if (password.length < 4) {
                showToast('A senha deve ter pelo menos 4 caracteres', 'error');
                return;
            }
            
            let level = levelSelect;
            
            // Verificar se est√° tentando acessar como N√∫cleo
            if (nucleoKey) {
                if (nucleoKey === NUCLEO_SECRET) {
                    level = 'nucleo';
                    showToast('Chave do N√∫cleo aceita! Acesso concedido.', 'success');
                } else {
                    showToast('Chave do N√∫cleo incorreta', 'error');
                    return;
                }
            }
            
            // Carregar usu√°rios existentes
            const existingUsers = loadFromStorage(STORAGE_KEYS.USERS) || [];
            
            // Verificar se usu√°rio j√° existe
            const existingUserIndex = existingUsers.findIndex(u => u.name.toLowerCase() === name.toLowerCase());
            
            if (existingUserIndex !== -1) {
                // Verificar senha
                if (existingUsers[existingUserIndex].password !== password) {
                    showToast('Senha incorreta', 'error');
                    return;
                }
                
                // Atualizar informa√ß√µes
                existingUsers[existingUserIndex].specialty = specialty;
                existingUsers[existingUserIndex].bio = bio;
                existingUsers[existingUserIndex].level = level; // Atualizar n√≠vel se mudou
                existingUsers[existingUserIndex].lastSeen = new Date().toISOString();
                existingUsers[existingUserIndex].status = 'online';
                
                currentUser = existingUsers[existingUserIndex];
            } else {
                // Criar novo usu√°rio
                const newUser = {
                    id: generateId(),
                    name,
                    specialty,
                    bio,
                    level,
                    password,
                    joinDate: new Date().toISOString(),
                    lastSeen: new Date().toISOString(),
                    status: 'online'
                };
                
                existingUsers.push(newUser);
                currentUser = newUser;
                
                // Adicionar ao grupo de pesquisa padr√£o
                const researchGroups = loadFromStorage(STORAGE_KEYS.RESEARCH_GROUPS) || [];
                if (researchGroups.length > 0) {
                    researchGroups[0].members.push(newUser.id);
                    saveToStorage(STORAGE_KEYS.RESEARCH_GROUPS, researchGroups);
                }
            }
            
            // Salvar usu√°rios atualizados
            saveToStorage(STORAGE_KEYS.USERS, existingUsers);
            saveToStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
            
            // Inicializar dados da aplica√ß√£o
            loadAppData();
            
            // Adicionar contato autom√°tico com o fundador para novos usu√°rios
            if (existingUserIndex === -1) {
                const founder = existingUsers.find(u => u.id === 'founder');
                if (founder) {
                    const contacts = loadFromStorage(STORAGE_KEYS.CONTACTS) || [];
                    const existingContact = contacts.find(c => 
                        (c.userId1 === currentUser.id && c.userId2 === 'founder') ||
                        (c.userId2 === currentUser.id && c.userId1 === 'founder')
                    );
                    
                    if (!existingContact) {
                        contacts.push({
                            id: generateId(),
                            userId1: currentUser.id,
                            userId2: 'founder',
                            createdAt: new Date().toISOString()
                        });
                        saveToStorage(STORAGE_KEYS.CONTACTS, contacts);
                    }
                    
                    // Enviar mensagem de boas-vindas
                    setTimeout(() => {
                        const conversationId = getConversationId(currentUser.id, 'founder');
                        const privateMessages = loadFromStorage(STORAGE_KEYS.PRIVATE_MESSAGES) || {};
                        
                        if (!privateMessages[conversationId]) {
                            privateMessages[conversationId] = [];
                        }
                        
                        privateMessages[conversationId].push({
                            id: generateId(),
                            sender: 'Lohan Cunha',
                            senderId: 'founder',
                            message: `Bem-vindo ao Algebra Renova, ${currentUser.name}! üåü\n\nEu sou Lohan Cunha, fundador da organiza√ß√£o. Fique √† vontade para explorar as teorias, participar dos grupos de pesquisa e discutir no f√≥rum.\n\n"Matem√°tica √© opcional ‚Äì assim como a sanidade."`,
                            timestamp: new Date().toISOString(),
                            type: 'user',
                            read: false
                        });
                        
                        saveToStorage(STORAGE_KEYS.PRIVATE_MESSAGES, privateMessages);
                        loadAppData(); // Recarregar dados
                        
                        if (appState.currentPage === 'private-chat') {
                            renderPrivateChat();
                        }
                    }, 1000);
                }
            }
            
            showToast(`Bem-vindo, ${name}! N√≠vel: ${level.toUpperCase()}`, 'success');
            renderApp();
        }

        function handleLogout() {
            if (currentUser) {
                // Atualizar status
                const users = loadFromStorage(STORAGE_KEYS.USERS) || [];
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                if (userIndex !== -1) {
                    users[userIndex].status = 'offline';
                    users[userIndex].lastSeen = new Date().toISOString();
                    saveToStorage(STORAGE_KEYS.USERS, users);
                }
            }
            
            // Limpar usu√°rio atual
            currentUser = null;
            localStorage.removeItem(STORAGE_KEYS.CURRENT_USER);
            
            // Mostrar p√°gina de login
            document.getElementById('login-page').classList.remove('hidden');
            document.getElementById('app').classList.add('hidden');
            
            // Limpar formul√°rio
            document.getElementById('login-form').reset();
            
            showToast('At√© logo!', 'info');
        }

        // =============================================
        // CARREGAMENTO DE DADOS
        // =============================================
        function loadAppData() {
            appState.users = loadFromStorage(STORAGE_KEYS.USERS) || [];
            appState.theories = loadFromStorage(STORAGE_KEYS.THEORIES) || [];
            appState.forumPosts = loadFromStorage(STORAGE_KEYS.FORUM_POSTS) || [];
            appState.researchGroups = loadFromStorage(STORAGE_KEYS.RESEARCH_GROUPS) || [];
            appState.chatMessages = loadFromStorage(STORAGE_KEYS.CHAT_MESSAGES) || {};
            appState.privateMessages = loadFromStorage(STORAGE_KEYS.PRIVATE_MESSAGES) || {};
            appState.contacts = loadFromStorage(STORAGE_KEYS.CONTACTS) || [];
            appState.notifications = loadFromStorage(STORAGE_KEYS.NOTIFICATIONS) || [];
        }

        // =============================================
        // FUN√á√ïES DE RENDERIZA√á√ÉO PRINCIPAL
        // =============================================
        function renderApp() {
            if (!currentUser) {
                const savedUser = loadFromStorage(STORAGE_KEYS.CURRENT_USER);
                if (savedUser) {
                    currentUser = savedUser;
                    loadAppData();
                } else {
                    document.getElementById('login-page').classList.remove('hidden');
                    document.getElementById('app').classList.add('hidden');
                    return;
                }
            }
            
            // Esconder p√°gina de login, mostrar app
            document.getElementById('login-page').classList.add('hidden');
            document.getElementById('app').classList.remove('hidden');
            
            // Atualizar informa√ß√µes do usu√°rio
            updateUserInfo();
            
            // Renderizar p√°gina atual
            renderCurrentPage();
            
            // Configurar MathJax
            if (window.MathJax) {
                setTimeout(() => MathJax.typesetPromise(), 100);
            }
        }

        function updateUserInfo() {
            if (!currentUser) return;
            
            // Nome
            document.getElementById('user-display-name').textContent = currentUser.name;
            
            // Avatar
            const avatar = document.getElementById('user-avatar');
            const initials = getAvatarInitials(currentUser.name);
            const colors = getLevelColor(currentUser.level);
            
            avatar.textContent = initials;
            avatar.style.backgroundColor = colors.bg;
            avatar.style.color = colors.color;
            avatar.style.borderColor = colors.color;
            
            // Badge de n√≠vel
            const badge = document.getElementById('user-level-badge');
            badge.textContent = currentUser.level.toUpperCase();
            badge.className = `user-level ${colors.badge}`;
            
            // Mostrar/ocultar item do N√∫cleo na sidebar
            const nucleoItem = document.getElementById('nucleo-admin-item');
            nucleoItem.style.display = currentUser.level === 'nucleo' ? 'block' : 'none';
            
            // Atualizar contagem de mensagens n√£o lidas
            updateUnreadMessageCount();
        }

        function updateUnreadMessageCount() {
            if (!currentUser) return;
            
            let unreadCount = 0;
            Object.keys(appState.privateMessages).forEach(conversationId => {
                if (conversationId.includes(currentUser.id)) {
                    const messages = appState.privateMessages[conversationId] || [];
                    unreadCount += messages.filter(m => 
                        m.senderId !== currentUser.id && !m.read
                    ).length;
                }
            });
            
            const unreadBadge = document.getElementById('unread-dm-count');
            if (unreadCount > 0) {
                unreadBadge.textContent = unreadCount;
                unreadBadge.style.display = 'inline-block';
            } else {
                unreadBadge.style.display = 'none';
            }
        }

        function renderCurrentPage() {
            // Esconder todas as p√°ginas
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Mostrar p√°gina atual
            const currentPageElement = document.getElementById(`${appState.currentPage}-page`);
            if (currentPageElement) {
                currentPageElement.classList.add('active');
            }
            
            // Atualizar t√≠tulo da p√°gina
            const pageTitle = document.getElementById('page-title');
            const pageTitles = {
                'dashboard': 'Dashboard',
                'theories': 'Teorias',
                'research-groups': 'Grupos de Pesquisa',
                'forum': 'F√≥rum de Desafios',
                'chat': 'Chat Geral',
                'contacts': 'Contatos',
                'private-chat': 'Chat Privado',
                'profile': 'Meu Perfil',
                'members': 'Membros',
                'nucleo-admin': 'Administra√ß√£o do N√∫cleo'
            };
            
            pageTitle.textContent = pageTitles[appState.currentPage] || appState.currentPage;
            
            // Atualizar navega√ß√£o ativa
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
                if (link.dataset.page === appState.currentPage) {
                    link.classList.add('active');
                }
            });
            
            // Renderizar conte√∫do espec√≠fico da p√°gina
            switch(appState.currentPage) {
                case 'dashboard':
                    renderDashboard();
                    break;
                case 'theories':
                    renderTheories();
                    break;
                case 'research-groups':
                    renderResearchGroups();
                    break;
                case 'forum':
                    renderForum();
                    break;
                case 'chat':
                    renderChat();
                    break;
                case 'contacts':
                    renderContacts();
                    break;
                case 'private-chat':
                    renderPrivateChat();
                    break;
                case 'profile':
                    renderProfile();
                    break;
                case 'members':
                    renderMembers();
                    break;
                case 'nucleo-admin':
                    renderNucleoAdmin();
                    break;
            }
        }

        // =============================================
        // RENDERIZA√á√ÉO DE P√ÅGINAS ESPEC√çFICAS
        // =============================================
        function renderDashboard() {
            // Estat√≠sticas REAIS
            const totalMembers = appState.users.length;
            const totalTheories = appState.theories.length;
            const totalForumPosts = appState.forumPosts.length;
            const totalGroups = appState.researchGroups.length;
            const onlineUsers = appState.users.filter(u => u.status === 'online').length;
            const userTheories = appState.theories.filter(t => t.authorId === currentUser.id).length;
            const userForumPosts = appState.forumPosts.filter(p => p.authorId === currentUser.id).length;
            
            document.getElementById('stats-grid').innerHTML = `
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--nucleo-accent);">${totalMembers}</div>
                    <div class="stat-label">Membros Totais</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                        ${onlineUsers} online agora
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--iniciado-accent);">${totalTheories}</div>
                    <div class="stat-label">Teorias Publicadas</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                        ${userTheories} suas teorias
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--observador-accent);">${totalForumPosts}</div>
                    <div class="stat-label">Discuss√µes no F√≥rum</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                        ${userForumPosts} suas contribui√ß√µes
                    </div>
                </div>
                
                <div class="stat-card">
                    <div class="stat-value" style="color: var(--nucleo-secondary);">${totalGroups}</div>
                    <div class="stat-label">Grupos de Pesquisa</div>
                    <div style="font-size: 0.9rem; color: var(--text-secondary); margin-top: 5px;">
                        ${appState.researchGroups.filter(g => g.members.includes(currentUser.id)).length} que voc√™ participa
                    </div>
                </div>
            `;
            
            // Atividade recente
            const recentActivity = document.getElementById('recent-activity');
            const activities = [];
            
            // Adicionar teorias recentes
            appState.theories.slice(-3).forEach(theory => {
                const author = appState.users.find(u => u.id === theory.authorId);
                activities.push({
                    type: 'theory',
                    icon: 'atom',
                    title: `Nova teoria: ${theory.title}`,
                    author: author?.name || 'Autor desconhecido',
                    time: theory.createdAt,
                    level: author?.level || 'observador'
                });
            });
            
            // Adicionar posts recentes do f√≥rum
            appState.forumPosts.slice(-3).forEach(post => {
                const author = appState.users.find(u => u.id === post.authorId);
                activities.push({
                    type: 'forum',
                    icon: 'comments',
                    title: `Novo t√≥pico: ${post.title}`,
                    author: author?.name || 'Autor desconhecido',
                    time: post.createdAt,
                    level: author?.level || 'observador'
                });
            });
            
            // Ordenar por data
            activities.sort((a, b) => new Date(b.time) - new Date(a.time));
            
            if (activities.length === 0) {
                recentActivity.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-history" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p style="margin-top: 15px;">Nenhuma atividade recente</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Seja o primeiro a criar uma teoria ou iniciar uma discuss√£o!</p>
                    </div>
                `;
            } else {
                recentActivity.innerHTML = activities.slice(0, 5).map(activity => {
                    const colors = getLevelColor(activity.level);
                    return `
                        <div style="display: flex; align-items: flex-start; padding: 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${colors.bg}; 
                                      display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">
                                <i class="fas fa-${activity.icon}" style="color: ${colors.color};"></i>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; margin-bottom: 5px;">${activity.title}</div>
                                <div style="display: flex; align-items: center; gap: 10px;">
                                    <span style="color: ${colors.color}; font-size: 0.85rem;">
                                        <i class="fas fa-user"></i> ${activity.author}
                                    </span>
                                    <span style="color: var(--text-secondary); font-size: 0.85rem;">
                                        <i class="fas fa-clock"></i> ${formatDate(activity.time)}
                                    </span>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Contatos online
            const onlineContactsDiv = document.getElementById('online-contacts');
            const userContacts = appState.contacts.filter(c => 
                c.userId1 === currentUser.id || c.userId2 === currentUser.id
            );
            
            const contactIds = userContacts.map(c => 
                c.userId1 === currentUser.id ? c.userId2 : c.userId1
            );
            
            const onlineContacts = appState.users.filter(u => 
                contactIds.includes(u.id) && u.status === 'online' && u.id !== currentUser.id
            );
            
            if (onlineContacts.length === 0) {
                onlineContactsDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 2rem; opacity: 0.5;"></i>
                        <p style="margin-top: 15px;">Nenhum contato online</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Adicione contatos para conversar!</p>
                    </div>
                `;
            } else {
                onlineContactsDiv.innerHTML = onlineContacts.map(contact => {
                    const colors = getLevelColor(contact.level);
                    const initials = getAvatarInitials(contact.name);
                    return `
                        <div style="display: flex; align-items: center; padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer;" 
                             onclick="startPrivateChat('${contact.id}')">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${colors.bg}; 
                                      display: flex; align-items: center; justify-content: center; margin-right: 15px; flex-shrink: 0;">
                                <span style="color: ${colors.color}; font-weight: bold;">${initials}</span>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600;">${contact.name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.85rem;">${contact.specialty}</div>
                            </div>
                            <div style="width: 10px; height: 10px; border-radius: 50%; background-color: var(--nucleo-accent);"></div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderTheories() {
            const theoriesList = document.getElementById('theories-list');
            
            // Filtrar teorias baseado no n√≠vel do usu√°rio
            let filteredTheories = appState.theories;
            if (currentUser.level !== 'nucleo') {
                filteredTheories = appState.theories.filter(t => 
                    t.visibility !== 'nucleo' && (t.visibility !== 'private' || t.authorId === currentUser.id)
                );
            }
            
            if (filteredTheories.length === 0) {
                theoriesList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-atom" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhuma Teoria</h3>
                        <p>Seja o primeiro a propor uma teoria revolucion√°ria!</p>
                        <button id="create-first-theory" class="btn btn-primary" style="margin-top: 20px;">
                            <i class="fas fa-plus"></i> Criar Primeira Teoria
                        </button>
                    </div>
                `;
            } else {
                theoriesList.innerHTML = filteredTheories.map(theory => {
                    const author = appState.users.find(u => u.id === theory.authorId);
                    const isOwner = theory.authorId === currentUser.id;
                    const canEdit = isOwner || currentUser.level === 'nucleo';
                    const colors = getLevelColor(author?.level || 'observador');
                    
                    return `
                        <div class="list-item" onclick="viewTheory('${theory.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <h3 class="list-title">${theory.title}</h3>
                                <div class="badge ${theory.visibility === 'public' ? 'badge-iniciado' : 
                                                    theory.visibility === 'private' ? 'badge-observador' : 'badge-nucleo'}">
                                    ${theory.visibility === 'public' ? 'P√∫blica' : 
                                     theory.visibility === 'private' ? 'Privada' : 'N√∫cleo'}
                                </div>
                            </div>
                            <div class="list-description">${theory.description}</div>
                            <div class="list-meta">
                                <span style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${colors.color};"></div>
                                    ${author?.name || 'Autor desconhecido'}
                                    ${author?.level === 'nucleo' ? ' üëë' : ''}
                                </span>
                                <span><i class="fas fa-calendar"></i> ${formatDate(theory.createdAt)}</span>
                                ${canEdit ? '<span><i class="fas fa-edit"></i> Editar</span>' : ''}
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderResearchGroups() {
            const groupsList = document.getElementById('research-groups-list');
            
            // Filtrar grupos baseado no n√≠vel do usu√°rio
            let filteredGroups = appState.researchGroups;
            if (currentUser.level !== 'nucleo') {
                filteredGroups = appState.researchGroups.filter(g => 
                    g.visibility !== 'nucleo'
                );
            }
            
            if (filteredGroups.length === 0) {
                groupsList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhum Grupo</h3>
                        <p>Crie o primeiro grupo de pesquisa!</p>
                    </div>
                `;
            } else {
                groupsList.innerHTML = filteredGroups.map(group => {
                    const creator = appState.users.find(u => u.id === group.creatorId);
                    const isMember = group.members.includes(currentUser.id);
                    const memberCount = group.members.length;
                    const colors = getLevelColor(creator?.level || 'observador');
                    
                    return `
                        <div class="list-item">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <h3 class="list-title">${group.name}</h3>
                                <div class="badge ${isMember ? 'badge-iniciado' : 'badge-observador'}">
                                    ${isMember ? 'Membro' : 'N√£o membro'}
                                </div>
                            </div>
                            <div class="list-description">${group.description}</div>
                            <div class="list-meta">
                                <span style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${colors.color};"></div>
                                    Criado por: ${creator?.name || 'Desconhecido'}
                                </span>
                                <span><i class="fas fa-users"></i> ${memberCount} membros</span>
                            </div>
                            <div style="margin-top: 15px; display: flex; gap: 10px;">
                                ${!isMember ? `
                                    <button class="btn btn-primary btn-small" onclick="joinGroup('${group.id}', event)">
                                        <i class="fas fa-sign-in-alt"></i> Entrar no Grupo
                                    </button>
                                ` : `
                                    <button class="btn btn-secondary btn-small" onclick="leaveGroup('${group.id}', event)">
                                        <i class="fas fa-sign-out-alt"></i> Sair do Grupo
                                    </button>
                                `}
                                <button class="btn btn-secondary btn-small" onclick="viewGroup('${group.id}', event)">
                                    <i class="fas fa-eye"></i> Ver Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderForum() {
            const forumList = document.getElementById('forum-topics-list');
            
            if (appState.forumPosts.length === 0) {
                forumList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhum T√≥pico</h3>
                        <p>Inicie a primeira discuss√£o no f√≥rum!</p>
                    </div>
                `;
            } else {
                forumList.innerHTML = appState.forumPosts.map(post => {
                    const author = appState.users.find(u => u.id === post.authorId);
                    const replyCount = post.replies ? post.replies.length : 0;
                    const colors = getLevelColor(author?.level || 'observador');
                    
                    return `
                        <div class="list-item" onclick="viewForumTopic('${post.id}')">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <h3 class="list-title">${post.title}</h3>
                                <div class="badge ${post.category === 'desafio' ? 'badge-nucleo' : 
                                                    post.category === 'discussao' ? 'badge-iniciado' : 'badge-observador'}">
                                    ${post.category === 'desafio' ? 'Desafio' : 
                                     post.category === 'discussao' ? 'Discuss√£o' : 'Pergunta'}
                                </div>
                            </div>
                            <div class="list-description">${post.content.substring(0, 150)}${post.content.length > 150 ? '...' : ''}</div>
                            <div class="list-meta">
                                <span style="display: flex; align-items: center; gap: 5px;">
                                    <div style="width: 8px; height: 8px; border-radius: 50%; background-color: ${colors.color};"></div>
                                    ${author?.name || 'Autor desconhecido'}
                                </span>
                                <span><i class="fas fa-comments"></i> ${replyCount} respostas</span>
                                <span><i class="fas fa-calendar"></i> ${formatDate(post.createdAt)}</span>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderChat() {
            // Renderizar canais
            const chatChannels = document.getElementById('chat-channels');
            const channels = [
                { id: 'general', name: 'Geral', icon: 'globe', description: 'Discuss√µes gerais' },
                { id: 'theories', name: 'Teorias', icon: 'atom', description: 'Debates sobre teorias' },
                { id: 'challenges', name: 'Desafios', icon: 'puzzle-piece', description: 'Problemas matem√°ticos' }
            ];
            
            // Adicionar canais de grupos de pesquisa
            appState.researchGroups.forEach(group => {
                if (group.members.includes(currentUser.id) || currentUser.level === 'nucleo') {
                    channels.push({
                        id: `group-${group.id}`,
                        name: group.name,
                        icon: 'users',
                        description: group.description.substring(0, 30) + '...'
                    });
                }
            });
            
            chatChannels.innerHTML = channels.map(channel => `
                <div class="channel-item" data-channel="${channel.id}" 
                     style="padding: 10px; margin-bottom: 10px; border-radius: 8px; cursor: pointer;
                            display: flex; align-items: center; gap: 10px; transition: background-color 0.3s;"
                     onmouseover="this.style.backgroundColor='var(--bg-card)'"
                     onmouseout="this.style.backgroundColor='transparent'"
                     onclick="switchChatChannel('${channel.id}')">
                    <i class="fas fa-${channel.icon}" style="color: var(--text-secondary);"></i>
                    <div style="flex: 1;">
                        <div style="font-weight: 600;">${channel.name}</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary);">${channel.description}</div>
                    </div>
                </div>
            `).join('');
            
            // Renderizar mensagens do canal atual
            renderChatMessages('general');
            
            // Atualizar contagem online
            const onlineCount = appState.users.filter(u => u.status === 'online').length;
            document.getElementById('online-count').textContent = `Online: ${onlineCount}`;
        }

        function renderChatMessages(channelId = 'general') {
            const chatMessagesDiv = document.getElementById('chat-messages');
            const currentChannel = document.getElementById('current-channel');
            
            // Definir nome do canal
            const channelNames = {
                'general': 'Geral',
                'theories': 'Teorias',
                'challenges': 'Desafios'
            };
            
            let channelName = channelNames[channelId];
            if (channelId.startsWith('group-')) {
                const groupId = channelId.replace('group-', '');
                const group = appState.researchGroups.find(g => g.id === groupId);
                channelName = group ? group.name : 'Grupo';
            }
            
            currentChannel.textContent = channelName;
            
            const messages = appState.chatMessages[channelId] || [];
            
            if (messages.length === 0) {
                chatMessagesDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-comments" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhuma Mensagem</h3>
                        <p>Seja o primeiro a enviar uma mensagem neste canal!</p>
                    </div>
                `;
            } else {
                chatMessagesDiv.innerHTML = messages.map(msg => {
                    const isOwn = msg.senderId === currentUser.id;
                    const sender = appState.users.find(u => u.id === msg.senderId);
                    const colors = getLevelColor(sender?.level || 'observador');
                    
                    return `
                        <div class="message ${isOwn ? 'message-sent' : 'message-received'}">
                            <div class="message-sender">
                                ${sender?.name || 'Sistema'}
                                ${sender?.level === 'nucleo' ? ' üëë' : ''}
                            </div>
                            <div class="message-content">${msg.message}</div>
                            <div class="message-time">${formatDate(msg.timestamp)}</div>
                        </div>
                    `;
                }).join('');
                
                // Scroll para o final
                setTimeout(() => {
                    chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
                }, 100);
            }
            
            // Re-processar MathJax
            if (window.MathJax) {
                setTimeout(() => MathJax.typesetPromise([chatMessagesDiv]), 200);
            }
        }

        function renderContacts() {
            const contactsList = document.getElementById('contacts-list');
            const userContacts = appState.contacts.filter(c => 
                c.userId1 === currentUser.id || c.userId2 === currentUser.id
            );
            
            const contactUsers = userContacts.map(c => {
                const contactId = c.userId1 === currentUser.id ? c.userId2 : c.userId1;
                const user = appState.users.find(u => u.id === contactId);
                return { ...user, contactId: c.id };
            }).filter(user => user);
            
            if (contactUsers.length === 0) {
                contactsList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhum Contato</h3>
                        <p>Adicione outros membros como contatos para conversar!</p>
                    </div>
                `;
            } else {
                contactsList.innerHTML = contactUsers.map(user => {
                    const colors = getLevelColor(user.level);
                    const initials = getAvatarInitials(user.name);
                    const isOnline = user.status === 'online';
                    
                    return `
                        <div class="list-item">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="position: relative;">
                                    <div style="width: 60px; height: 60px; border-radius: 50%; background-color: ${colors.bg}; 
                                              display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: ${colors.color};">
                                        ${initials}
                                    </div>
                                    <div style="position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; border-radius: 50%; 
                                              background-color: ${isOnline ? 'var(--nucleo-accent)' : 'var(--text-secondary)'}; 
                                              border: 2px solid var(--bg-card);"></div>
                                </div>
                                <div style="flex: 1;">
                                    <h3 class="list-title">${user.name}</h3>
                                    <div class="list-description">${user.specialty}</div>
                                    <div class="list-meta">
                                        <span class="badge ${colors.badge}">${user.level.toUpperCase()}</span>
                                        <span><i class="fas fa-clock"></i> ${isOnline ? 'Online agora' : `Visto: ${formatDate(user.lastSeen)}`}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    <button class="btn btn-primary btn-small" onclick="startPrivateChat('${user.id}')">
                                        <i class="fas fa-comment"></i> Conversar
                                    </button>
                                    <button class="btn btn-secondary btn-small" onclick="removeContact('${user.id}', event)">
                                        <i class="fas fa-user-minus"></i> Remover
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderPrivateChat() {
            const contactsSidebar = document.getElementById('private-chat-contacts');
            const userContacts = appState.contacts.filter(c => 
                c.userId1 === currentUser.id || c.userId2 === currentUser.id
            );
            
            const contactUsers = userContacts.map(c => {
                const contactId = c.userId1 === currentUser.id ? c.userId2 : c.userId1;
                const user = appState.users.find(u => u.id === contactId);
                return { ...user, contactId: c.id };
            }).filter(user => user);
            
            if (contactUsers.length === 0) {
                contactsSidebar.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: var(--text-secondary);">
                        <i class="fas fa-user-friends" style="font-size: 2rem; opacity: 0.5; margin-bottom: 15px;"></i>
                        <p>Nenhum contato</p>
                        <p style="font-size: 0.9rem; margin-top: 10px;">Adicione contatos para conversar!</p>
                    </div>
                `;
            } else {
                contactsSidebar.innerHTML = contactUsers.map(user => {
                    const colors = getLevelColor(user.level);
                    const initials = getAvatarInitials(user.name);
                    const isOnline = user.status === 'online';
                    const conversationId = getConversationId(currentUser.id, user.id);
                    const unreadCount = (appState.privateMessages[conversationId] || []).filter(m => 
                        m.senderId !== currentUser.id && !m.read
                    ).length;
                    
                    return `
                        <div style="padding: 12px; margin-bottom: 8px; border-radius: 8px; cursor: pointer; 
                                    display: flex; align-items: center; gap: 10px; transition: background-color 0.3s;
                                    ${appState.currentPrivateChat === conversationId ? 'background-color: var(--bg-card);' : ''}"
                             onmouseover="this.style.backgroundColor='var(--bg-card)'"
                             onmouseout="if('${appState.currentPrivateChat}' !== '${conversationId}') this.style.backgroundColor='transparent'"
                             onclick="loadPrivateChat('${user.id}')">
                            <div style="position: relative;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${colors.bg}; 
                                          display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${colors.color};">
                                    ${initials}
                                </div>
                                <div style="position: absolute; bottom: -2px; right: -2px; width: 12px; height: 12px; border-radius: 50%; 
                                          background-color: ${isOnline ? 'var(--nucleo-accent)' : 'var(--text-secondary)'}; 
                                          border: 2px solid var(--bg-input);"></div>
                            </div>
                            <div style="flex: 1;">
                                <div style="font-weight: 600; font-size: 0.9rem;">${user.name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                    ${user.specialty.substring(0, 20)}${user.specialty.length > 20 ? '...' : ''}
                                </div>
                            </div>
                            ${unreadCount > 0 ? `
                                <div style="background-color: var(--nucleo-accent); color: #000; width: 20px; height: 20px; 
                                          border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 0.7rem; font-weight: bold;">
                                    ${unreadCount}
                                </div>
                            ` : ''}
                        </div>
                    `;
                }).join('');
            }
            
            // Renderizar mensagens se houver conversa ativa
            if (appState.currentPrivateChat) {
                renderPrivateChatMessages(appState.currentPrivateChat);
            } else {
                document.getElementById('private-chat-messages').innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-comment" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Selecione um Contato</h3>
                        <p>Escolha um contato para iniciar uma conversa privada.</p>
                    </div>
                `;
                document.getElementById('private-chat-input-area').style.display = 'none';
            }
        }

        function renderPrivateChatMessages(conversationId) {
            const messagesDiv = document.getElementById('private-chat-messages');
            const inputArea = document.getElementById('private-chat-input-area');
            const messages = appState.privateMessages[conversationId] || [];
            
            // Encontrar o outro usu√°rio na conversa
            const userIds = conversationId.replace('dm_', '').split('_');
            const otherUserId = userIds.find(id => id !== currentUser.id);
            const otherUser = appState.users.find(u => u.id === otherUserId);
            
            if (otherUser) {
                document.getElementById('private-chat-with').textContent = `Conversando com ${otherUser.name}`;
            }
            
            inputArea.style.display = 'block';
            
            if (messages.length === 0) {
                messagesDiv.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-comment" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhuma Mensagem</h3>
                        <p>Inicie a conversa com ${otherUser?.name || 'este contato'}!</p>
                    </div>
                `;
            } else {
                messagesDiv.innerHTML = messages.map(msg => {
                    const isOwn = msg.senderId === currentUser.id;
                    const sender = appState.users.find(u => u.id === msg.senderId);
                    const colors = getLevelColor(sender?.level || 'observador');
                    
                    // Marcar como lida
                    if (!isOwn && !msg.read) {
                        msg.read = true;
                        saveToStorage(STORAGE_KEYS.PRIVATE_MESSAGES, appState.privateMessages);
                    }
                    
                    return `
                        <div class="message ${isOwn ? 'message-sent' : 'message-received'}">
                            <div class="message-sender">
                                ${sender?.name || 'Sistema'}
                                ${sender?.level === 'nucleo' ? ' üëë' : ''}
                            </div>
                            <div class="message-content">${msg.message}</div>
                            <div class="message-time">${formatDate(msg.timestamp)}</div>
                        </div>
                    `;
                }).join('');
                
                // Scroll para o final
                setTimeout(() => {
                    messagesDiv.scrollTop = messagesDiv.scrollHeight;
                }, 100);
            }
            
            // Re-processar MathJax
            if (window.MathJax) {
                setTimeout(() => MathJax.typesetPromise([messagesDiv]), 200);
            }
            
            // Atualizar contagem de mensagens n√£o lidas
            updateUnreadMessageCount();
        }

        function renderProfile() {
            // Preencher formul√°rio
            document.getElementById('profile-name').value = currentUser.name;
            document.getElementById('profile-specialty').value = currentUser.specialty;
            document.getElementById('profile-bio').value = currentUser.bio || '';
            document.getElementById('profile-level').value = currentUser.level.toUpperCase();
            
            // Atualizar estat√≠sticas
            const userTheories = appState.theories.filter(t => t.authorId === currentUser.id).length;
            const userForumPosts = appState.forumPosts.filter(p => p.authorId === currentUser.id).length;
            const userGroups = appState.researchGroups.filter(g => g.members.includes(currentUser.id)).length;
            const userContacts = appState.contacts.filter(c => 
                c.userId1 === currentUser.id || c.userId2 === currentUser.id
            ).length;
            
            document.getElementById('profile-theories-count').textContent = userTheories;
            document.getElementById('profile-posts-count').textContent = userForumPosts;
            document.getElementById('profile-groups-count').textContent = userGroups;
            document.getElementById('profile-contacts-count').textContent = userContacts;
        }

        function renderMembers() {
            const membersList = document.getElementById('members-list');
            const searchInput = document.getElementById('search-members');
            const filterLevel = document.getElementById('filter-level');
            
            let filteredMembers = appState.users.filter(u => u.id !== currentUser.id);
            
            // Aplicar filtro de n√≠vel
            if (filterLevel.value) {
                filteredMembers = filteredMembers.filter(u => u.level === filterLevel.value);
            }
            
            // Aplicar busca
            if (searchInput.value) {
                const searchTerm = searchInput.value.toLowerCase();
                filteredMembers = filteredMembers.filter(u => 
                    u.name.toLowerCase().includes(searchTerm) || 
                    u.specialty.toLowerCase().includes(searchTerm)
                );
            }
            
            if (filteredMembers.length === 0) {
                membersList.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 3rem; opacity: 0.5; margin-bottom: 20px;"></i>
                        <h3 style="color: var(--text-primary); margin-bottom: 10px;">Nenhum Membro Encontrado</h3>
                        <p>Tente alterar os filtros de busca.</p>
                    </div>
                `;
            } else {
                membersList.innerHTML = filteredMembers.map(user => {
                    const colors = getLevelColor(user.level);
                    const initials = getAvatarInitials(user.name);
                    const isOnline = user.status === 'online';
                    const isContact = appState.contacts.some(c => 
                        (c.userId1 === currentUser.id && c.userId2 === user.id) ||
                        (c.userId2 === currentUser.id && c.userId1 === user.id)
                    );
                    
                    return `
                        <div class="list-item">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="position: relative;">
                                    <div style="width: 60px; height: 60px; border-radius: 50%; background-color: ${colors.bg}; 
                                              display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold; color: ${colors.color};">
                                        ${initials}
                                    </div>
                                    <div style="position: absolute; bottom: 0; right: 0; width: 15px; height: 15px; border-radius: 50%; 
                                              background-color: ${isOnline ? 'var(--nucleo-accent)' : 'var(--text-secondary)'}; 
                                              border: 2px solid var(--bg-card);"></div>
                                </div>
                                <div style="flex: 1;">
                                    <h3 class="list-title">${user.name}</h3>
                                    <div class="list-description">${user.specialty}</div>
                                    <div class="list-meta">
                                        <span class="badge ${colors.badge}">${user.level.toUpperCase()}</span>
                                        <span><i class="fas fa-clock"></i> ${isOnline ? 'Online agora' : `Visto: ${formatDate(user.lastSeen)}`}</span>
                                        <span><i class="fas fa-calendar"></i> Desde: ${new Date(user.joinDate).toLocaleDateString('pt-BR')}</span>
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px;">
                                    ${!isContact ? `
                                        <button class="btn btn-primary btn-small" onclick="addContact('${user.id}')">
                                            <i class="fas fa-user-plus"></i> Adicionar
                                        </button>
                                    ` : `
                                        <button class="btn btn-secondary btn-small" onclick="startPrivateChat('${user.id}')">
                                            <i class="fas fa-comment"></i> Conversar
                                        </button>
                                    `}
                                    ${currentUser.level === 'nucleo' && user.level !== 'nucleo' ? `
                                        <button class="btn btn-nucleo btn-small" onclick="promoteMember('${user.id}')" 
                                                style="background-color: var(--nucleo-primary); color: var(--nucleo-accent);">
                                            <i class="fas fa-crown"></i> Promover
                                        </button>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        function renderNucleoAdmin() {
            if (currentUser.level !== 'nucleo') {
                appState.currentPage = 'dashboard';
                renderCurrentPage();
                showToast('Acesso restrito ao N√∫cleo', 'error');
                return;
            }
            
            // Membros para promover
            const promoteList = document.getElementById('promote-members-list');
            const membersToPromote = appState.users.filter(u => u.level !== 'nucleo');
            
            if (membersToPromote.length === 0) {
                promoteList.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-users" style="font-size: 2rem; opacity: 0.5; margin-bottom: 15px;"></i>
                        <p>Nenhum membro para promover</p>
                    </div>
                `;
            } else {
                promoteList.innerHTML = membersToPromote.map(user => {
                    const colors = getLevelColor(user.level);
                    const initials = getAvatarInitials(user.name);
                    
                    return `
                        <div style="display: flex; align-items: center; justify-content: space-between; padding: 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; align-items: center; gap: 15px;">
                                <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${colors.bg}; 
                                          display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${colors.color};">
                                    ${initials}
                                </div>
                                <div>
                                    <div style="font-weight: 600;">${user.name}</div>
                                    <div style="color: var(--text-secondary); font-size: 0.9rem;">${user.specialty}</div>
                                </div>
                            </div>
                            <div>
                                <span class="badge ${colors.badge}" style="margin-right: 15px;">${user.level.toUpperCase()}</span>
                                <button class="btn btn-primary btn-small" onclick="promoteToNucleo('${user.id}')">
                                    <i class="fas fa-crown"></i> Promover a N√∫cleo
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Teorias para aprova√ß√£o
            const pendingTheories = document.getElementById('pending-theories');
            const theoriesToApprove = appState.theories.filter(t => t.status === 'pending');
            
            if (theoriesToApprove.length === 0) {
                pendingTheories.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <i class="fas fa-atom" style="font-size: 2rem; opacity: 0.5; margin-bottom: 15px;"></i>
                        <p>Nenhuma teoria pendente de aprova√ß√£o</p>
                    </div>
                `;
            } else {
                pendingTheories.innerHTML = theoriesToApprove.map(theory => {
                    const author = appState.users.find(u => u.id === theory.authorId);
                    
                    return `
                        <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                            <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 10px;">
                                <h4 style="font-weight: 600;">${theory.title}</h4>
                                <div style="font-size: 0.9rem; color: var(--text-secondary);">
                                    Por: ${author?.name || 'Autor desconhecido'}
                                </div>
                            </div>
                            <div style="color: var(--text-secondary); margin-bottom: 10px;">${theory.description}</div>
                            <div style="display: flex; gap: 10px;">
                                <button class="btn btn-primary btn-small" onclick="approveTheory('${theory.id}')">
                                    <i class="fas fa-check"></i> Aprovar
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="rejectTheory('${theory.id}')">
                                    <i class="fas fa-times"></i> Rejeitar
                                </button>
                                <button class="btn btn-secondary btn-small" onclick="viewTheory('${theory.id}')">
                                    <i class="fas fa-eye"></i> Ver Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // =============================================
        // FUN√á√ïES AUXILIARES
        // =============================================
        function getConversationId(userId1, userId2) {
            const ids = [userId1, userId2].sort();
            return `dm_${ids[0]}_${ids[1]}`;
        }

        function switchChatChannel(channelId) {
            renderChatMessages(channelId);
        }

        function startPrivateChat(userId) {
            appState.currentPrivateChat = getConversationId(currentUser.id, userId);
            appState.currentPage = 'private-chat';
            renderCurrentPage();
        }

        function loadPrivateChat(userId) {
            appState.currentPrivateChat = getConversationId(currentUser.id, userId);
            renderPrivateChat();
        }

        function sendMessage() {
            const chatInput = document.getElementById('chat-input');
            const message = chatInput.value.trim();
            
            if (!message) {
                showToast('Digite uma mensagem', 'warning');
                return;
            }
            
            const newMessage = {
                id: generateId(),
                sender: currentUser.name,
                senderId: currentUser.id,
                message: message,
                timestamp: new Date().toISOString(),
                type: 'user'
            };
            
            if (!appState.chatMessages.general) {
                appState.chatMessages.general = [];
            }
            
            appState.chatMessages.general.push(newMessage);
            saveToStorage(STORAGE_KEYS.CHAT_MESSAGES, appState.chatMessages);
            
            chatInput.value = '';
            renderChatMessages('general');
        }

        function sendPrivateMessage() {
            if (!appState.currentPrivateChat) {
                showToast('Selecione um contato primeiro', 'warning');
                return;
            }
            
            const chatInput = document.getElementById('private-chat-input');
            const message = chatInput.value.trim();
            
            if (!message) {
                showToast('Digite uma mensagem', 'warning');
                return;
            }
            
            const newMessage = {
                id: generateId(),
                sender: currentUser.name,
                senderId: currentUser.id,
                message: message,
                timestamp: new Date().toISOString(),
                type: 'user',
                read: false
            };
            
            if (!appState.privateMessages[appState.currentPrivateChat]) {
                appState.privateMessages[appState.currentPrivateChat] = [];
            }
            
            appState.privateMessages[appState.currentPrivateChat].push(newMessage);
            saveToStorage(STORAGE_KEYS.PRIVATE_MESSAGES, appState.privateMessages);
            
            chatInput.value = '';
            renderPrivateChatMessages(appState.currentPrivateChat);
        }

        function addContact(userId) {
            if (userId === currentUser.id) {
                showToast('N√£o √© poss√≠vel adicionar a si mesmo', 'warning');
                return;
            }
            
            const existingContact = appState.contacts.find(c => 
                (c.userId1 === currentUser.id && c.userId2 === userId) ||
                (c.userId2 === currentUser.id && c.userId1 === userId)
            );
            
            if (existingContact) {
                showToast('Este usu√°rio j√° est√° em seus contatos', 'info');
                return;
            }
            
            const newContact = {
                id: generateId(),
                userId1: currentUser.id,
                userId2: userId,
                createdAt: new Date().toISOString()
            };
            
            appState.contacts.push(newContact);
            saveToStorage(STORAGE_KEYS.CONTACTS, appState.contacts);
            showToast('Contato adicionado com sucesso!', 'success');
            
            // Atualizar a p√°gina se estiver na p√°gina de contatos
            if (appState.currentPage === 'contacts') {
                renderContacts();
            }
            if (appState.currentPage === 'members') {
                renderMembers();
            }
        }

        function removeContact(userId, event) {
            if (event) event.stopPropagation();
            
            const contactIndex = appState.contacts.findIndex(c => 
                (c.userId1 === currentUser.id && c.userId2 === userId) ||
                (c.userId2 === currentUser.id && c.userId1 === userId)
            );
            
            if (contactIndex !== -1) {
                appState.contacts.splice(contactIndex, 1);
                saveToStorage(STORAGE_KEYS.CONTACTS, appState.contacts);
                showToast('Contato removido', 'info');
                
                if (appState.currentPage === 'contacts') {
                    renderContacts();
                }
            }
        }

        function joinGroup(groupId, event) {
            if (event) event.stopPropagation();
            
            const groupIndex = appState.researchGroups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1 && !appState.researchGroups[groupIndex].members.includes(currentUser.id)) {
                appState.researchGroups[groupIndex].members.push(currentUser.id);
                saveToStorage(STORAGE_KEYS.RESEARCH_GROUPS, appState.researchGroups);
                showToast('Voc√™ entrou no grupo!', 'success');
                renderResearchGroups();
            }
        }

        function leaveGroup(groupId, event) {
            if (event) event.stopPropagation();
            
            const groupIndex = appState.researchGroups.findIndex(g => g.id === groupId);
            if (groupIndex !== -1) {
                const memberIndex = appState.researchGroups[groupIndex].members.indexOf(currentUser.id);
                if (memberIndex !== -1) {
                    appState.researchGroups[groupIndex].members.splice(memberIndex, 1);
                    saveToStorage(STORAGE_KEYS.RESEARCH_GROUPS, appState.researchGroups);
                    showToast('Voc√™ saiu do grupo', 'info');
                    renderResearchGroups();
                }
            }
        }

        function promoteMember(userId) {
            showModal('promote-member', { userId });
        }

        // =============================================
        // MODAIS
        // =============================================
        function showModal(modalType, data = {}) {
            let modalHTML = '';
            
            switch(modalType) {
                case 'new-theory':
                    modalHTML = `
                        <div class="modal-overlay">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Nova Teoria</h3>
                                    <button class="modal-close" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="new-theory-form">
                                        <div class="form-group">
                                            <label class="form-label" for="modal-theory-title">T√≠tulo *</label>
                                            <input type="text" class="form-control" id="modal-theory-title" 
                                                   placeholder="Ex: √Ålgebra Transdimensional" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-theory-description">Descri√ß√£o *</label>
                                            <textarea class="form-control" id="modal-theory-description" 
                                                      placeholder="Descreva sua teoria em termos gerais..." 
                                                      rows="4" required></textarea>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-theory-content">Conte√∫do (LaTeX suportado) *</label>
                                            <textarea>
                                                                                                  placeholder="Descreva sua teoria em detalhes. Use LaTeX para f√≥rmulas: $E = mc^2$ ou $$\\int_a^b f(x)dx$$" 
                                                      rows="10" required></textarea>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-theory-tags">Tags</label>
                                            <input type="text" class="form-control" id="modal-theory-tags" 
                                                   placeholder="√°lgebra, geometria, teoria, etc (separadas por v√≠rgula)">
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-theory-visibility">Visibilidade *</label>
                                            <select class="form-control" id="modal-theory-visibility" required>
                                                <option value="public">P√∫blica (todos podem ver)</option>
                                                <option value="private">Privada (somente eu)</option>
                                                ${currentUser.level === 'nucleo' ? 
                                                    '<option value="nucleo">N√∫cleo (somente membros do n√∫cleo)</option>' : ''}
                                            </select>
                                        </div>
                                        
                                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                                            <button type="submit" class="btn btn-primary">Publicar Teoria</button>
                                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'new-forum-topic':
                    modalHTML = `
                        <div class="modal-overlay">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Novo T√≥pico no F√≥rum</h3>
                                    <button class="modal-close" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="new-forum-topic-form">
                                        <div class="form-group">
                                            <label class="form-label" for="modal-forum-title">T√≠tulo *</label>
                                            <input type="text" class="form-control" id="modal-forum-title" 
                                                   placeholder="Ex: Desafio: Provar que ‚àö2 √© irracional" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-forum-category">Categoria *</label>
                                            <select class="form-control" id="modal-forum-category" required>
                                                <option value="discussao">Discuss√£o Geral</option>
                                                <option value="desafio">Desafio Matem√°tico</option>
                                                <option value="pergunta">Pergunta</option>
                                                <option value="projeto">Projeto de Pesquisa</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-forum-content">Conte√∫do *</label>
                                            <textarea class="form-control" id="modal-forum-content" 
                                                      placeholder="Descreva seu t√≥pico em detalhes. Use LaTeX para f√≥rmulas..." 
                                                      rows="8" required></textarea>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-forum-tags">Tags</label>
                                            <input type="text" class="form-control" id="modal-forum-tags" 
                                                   placeholder="√°lgebra, l√≥gica, desafio, etc (separadas por v√≠rgula)">
                                        </div>
                                        
                                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                                            <button type="submit" class="btn btn-primary">Criar T√≥pico</button>
                                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'change-password':
                    modalHTML = `
                        <div class="modal-overlay">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Alterar Senha</h3>
                                    <button class="modal-close" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <form id="change-password-form">
                                        <div class="form-group">
                                            <label class="form-label" for="modal-current-password">Senha Atual *</label>
                                            <input type="password" class="form-control" id="modal-current-password" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-new-password">Nova Senha *</label>
                                            <input type="password" class="form-control" id="modal-new-password" required>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label class="form-label" for="modal-confirm-password">Confirmar Nova Senha *</label>
                                            <input type="password" class="form-control" id="modal-confirm-password" required>
                                        </div>
                                        
                                        <div style="display: flex; gap: 15px; margin-top: 30px;">
                                            <button type="submit" class="btn btn-primary">Alterar Senha</button>
                                            <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                                        </div>
                                    </form>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'add-contact':
                    modalHTML = `
                        <div class="modal-overlay">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Adicionar Contato</h3>
                                    <button class="modal-close" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div class="form-group">
                                        <label class="form-label">Buscar Membro</label>
                                        <input type="text" class="form-control" id="modal-contact-search" 
                                               placeholder="Digite o nome ou especialidade...">
                                    </div>
                                    
                                    <div id="modal-contact-results" style="margin-top: 20px; max-height: 300px; overflow-y: auto;">
                                        <!-- Resultados ser√£o carregados aqui -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'promote-member':
                    modalHTML = `
                        <div class="modal-overlay">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">Promover Membro</h3>
                                    <button class="modal-close" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <p>Tem certeza que deseja promover este membro ao N√∫cleo?</p>
                                    <p style="color: var(--text-secondary); font-size: 0.9rem; margin-top: 10px;">
                                        Membros do N√∫cleo t√™m acesso a todas as funcionalidades e podem moderar conte√∫dos.
                                    </p>
                                    
                                    <div style="display: flex; gap: 15px; margin-top: 30px;">
                                        <button class="btn btn-primary" onclick="promoteToNucleo('${data.userId}'); closeModal();">Promover</button>
                                        <button class="btn btn-secondary" onclick="closeModal()">Cancelar</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
                    
                case 'view-theory':
                    const theory = appState.theories.find(t => t.id === data.theoryId);
                    if (!theory) {
                        showToast('Teoria n√£o encontrada', 'error');
                        return;
                    }
                    
                    const author = appState.users.find(u => u.id === theory.authorId);
                    modalHTML = `
                        <div class="modal-overlay">
                            <div class="modal-content">
                                <div class="modal-header">
                                    <h3 class="modal-title">${theory.title}</h3>
                                    <button class="modal-close" onclick="closeModal()">&times;</button>
                                </div>
                                <div class="modal-body">
                                    <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                                        <div style="display: flex; justify-content: space-between; align-items: center;">
                                            <div>
                                                <span style="color: var(--text-secondary);">Por:</span>
                                                <span style="font-weight: 600; margin-left: 5px;">
                                                    ${author?.name || 'Autor desconhecido'}
                                                    ${author?.level === 'nucleo' ? ' üëë' : ''}
                                                </span>
                                            </div>
                                            <span style="color: var(--text-secondary);">${formatDate(theory.createdAt)}</span>
                                        </div>
                                        <div style="margin-top: 10px; color: var(--text-secondary);">
                                            ${theory.description}
                                        </div>
                                        <div style="margin-top: 10px;">
                                            ${theory.tags?.map(tag => 
                                                `<span class="badge badge-observador" style="margin-right: 5px;">${tag.trim()}</span>`
                                            ).join('')}
                                        </div>
                                    </div>
                                    
                                    <div style="line-height: 1.8;">
                                        ${theory.content.replace(/\n/g, '<br>')}
                                    </div>
                                    
                                    <div style="margin-top: 30px; padding-top: 20px; border-top: 1px solid var(--border-color); display: flex; gap: 10px;">
                                        ${theory.authorId === currentUser.id || currentUser.level === 'nucleo' ? `
                                            <button class="btn btn-primary btn-small" onclick="editTheory('${theory.id}')">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                        ` : ''}
                                        ${currentUser.level === 'nucleo' && theory.status !== 'published' ? `
                                            <button class="btn btn-primary btn-small" onclick="approveTheory('${theory.id}'); closeModal();">
                                                <i class="fas fa-check"></i> Aprovar
                                            </button>
                                        ` : ''}
                                        <button class="btn btn-secondary btn-small" onclick="closeModal()">
                                            <i class="fas fa-times"></i> Fechar
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;
                    break;
            }
            
            const modalContainer = document.getElementById('modal-container');
            modalContainer.innerHTML = modalHTML;
            
            // Adicionar eventos aos formul√°rios
            setTimeout(() => {
                switch(modalType) {
                    case 'new-theory':
                        document.getElementById('new-theory-form')?.addEventListener('submit', handleNewTheory);
                        break;
                    case 'new-forum-topic':
                        document.getElementById('new-forum-topic-form')?.addEventListener('submit', handleNewForumTopic);
                        break;
                    case 'change-password':
                        document.getElementById('change-password-form')?.addEventListener('submit', handleChangePassword);
                        break;
                    case 'add-contact':
                        document.getElementById('modal-contact-search')?.addEventListener('input', handleContactSearch);
                        break;
                }
            }, 100);
        }

        function closeModal() {
            document.getElementById('modal-container').innerHTML = '';
        }

        // =============================================
        // HANDLERS DE FORMUL√ÅRIOS
        // =============================================
        function handleNewTheory(event) {
            event.preventDefault();
            
            const title = document.getElementById('modal-theory-title').value.trim();
            const description = document.getElementById('modal-theory-description').value.trim();
            const content = document.getElementById('modal-theory-content').value.trim();
            const tags = document.getElementById('modal-theory-tags').value.split(',').map(t => t.trim()).filter(t => t);
            const visibility = document.getElementById('modal-theory-visibility').value;
            
            if (!title || !description || !content) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            const newTheory = {
                id: generateId(),
                title,
                description,
                content,
                tags,
                visibility,
                authorId: currentUser.id,
                author: currentUser.name,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString(),
                status: currentUser.level === 'nucleo' ? 'published' : 'pending'
            };
            
            appState.theories.push(newTheory);
            saveToStorage(STORAGE_KEYS.THEORIES, appState.theories);
            
            closeModal();
            showToast('Teoria criada com sucesso!', 'success');
            renderTheories();
            
            // Se for usu√°rio regular, mostrar notifica√ß√£o
            if (currentUser.level !== 'nucleo') {
                showToast('Sua teoria est√° pendente de aprova√ß√£o do N√∫cleo.', 'info');
            }
        }

        function handleNewForumTopic(event) {
            event.preventDefault();
            
            const title = document.getElementById('modal-forum-title').value.trim();
            const category = document.getElementById('modal-forum-category').value;
            const content = document.getElementById('modal-forum-content').value.trim();
            const tags = document.getElementById('modal-forum-tags').value.split(',').map(t => t.trim()).filter(t => t);
            
            if (!title || !content) {
                showToast('Preencha todos os campos obrigat√≥rios', 'error');
                return;
            }
            
            const newPost = {
                id: generateId(),
                title,
                content,
                category,
                tags,
                authorId: currentUser.id,
                author: currentUser.name,
                createdAt: new Date().toISOString(),
                replies: []
            };
            
            appState.forumPosts.push(newPost);
            saveToStorage(STORAGE_KEYS.FORUM_POSTS, appState.forumPosts);
            
            closeModal();
            showToast('T√≥pico criado com sucesso!', 'success');
            renderForum();
        }

        function handleChangePassword(event) {
            event.preventDefault();
            
            const currentPassword = document.getElementById('modal-current-password').value;
            const newPassword = document.getElementById('modal-new-password').value;
            const confirmPassword = document.getElementById('modal-confirm-password').value;
            
            if (currentPassword !== currentUser.password) {
                showToast('Senha atual incorreta', 'error');
                return;
            }
            
            if (newPassword.length < 4) {
                showToast('A nova senha deve ter pelo menos 4 caracteres', 'error');
                return;
            }
            
            if (newPassword !== confirmPassword) {
                showToast('As senhas n√£o coincidem', 'error');
                return;
            }
            
            // Atualizar senha
            const users = loadFromStorage(STORAGE_KEYS.USERS) || [];
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            
            if (userIndex !== -1) {
                users[userIndex].password = newPassword;
                currentUser.password = newPassword;
                
                saveToStorage(STORAGE_KEYS.USERS, users);
                saveToStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
                
                closeModal();
                showToast('Senha alterada com sucesso!', 'success');
            }
        }

        function handleContactSearch(event) {
            const searchTerm = event.target.value.toLowerCase().trim();
            const resultsDiv = document.getElementById('modal-contact-results');
            
            if (!searchTerm) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <p>Digite um nome ou especialidade para buscar</p>
                    </div>
                `;
                return;
            }
            
            const filteredUsers = appState.users.filter(u => 
                u.id !== currentUser.id &&
                !appState.contacts.some(c => 
                    (c.userId1 === currentUser.id && c.userId2 === u.id) ||
                    (c.userId2 === currentUser.id && c.userId1 === u.id)
                ) &&
                (u.name.toLowerCase().includes(searchTerm) || 
                 u.specialty.toLowerCase().includes(searchTerm))
            );
            
            if (filteredUsers.length === 0) {
                resultsDiv.innerHTML = `
                    <div style="text-align: center; padding: 30px; color: var(--text-secondary);">
                        <p>Nenhum membro encontrado</p>
                    </div>
                `;
                return;
            }
            
            resultsDiv.innerHTML = filteredUsers.map(user => {
                const colors = getLevelColor(user.level);
                const initials = getAvatarInitials(user.name);
                const isOnline = user.status === 'online';
                
                return `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; 
                                border-bottom: 1px solid var(--border-color);">
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div style="width: 40px; height: 40px; border-radius: 50%; background-color: ${colors.bg}; 
                                      display: flex; align-items: center; justify-content: center; font-weight: bold; color: ${colors.color};">
                                ${initials}
                            </div>
                            <div>
                                <div style="font-weight: 600;">${user.name}</div>
                                <div style="color: var(--text-secondary); font-size: 0.9rem;">${user.specialty}</div>
                            </div>
                        </div>
                        <div style="display: flex; gap: 5px; align-items: center;">
                            <span style="width: 8px; height: 8px; border-radius: 50%; 
                                      background-color: ${isOnline ? 'var(--nucleo-accent)' : 'var(--text-secondary)'}; 
                                      margin-right: 10px;"></span>
                            <button class="btn btn-primary btn-small" onclick="addContact('${user.id}'); closeModal();">
                                <i class="fas fa-user-plus"></i> Adicionar
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // =============================================
        // FUN√á√ïES DE ADMINISTRA√á√ÉO
        // =============================================
        function promoteToNucleo(userId) {
            const users = loadFromStorage(STORAGE_KEYS.USERS) || [];
            const userIndex = users.findIndex(u => u.id === userId);
            
            if (userIndex !== -1) {
                users[userIndex].level = 'nucleo';
                saveToStorage(STORAGE_KEYS.USERS, users);
                
                // Atualizar appState
                const appUserIndex = appState.users.findIndex(u => u.id === userId);
                if (appUserIndex !== -1) {
                    appState.users[appUserIndex].level = 'nucleo';
                }
                
                showToast('Membro promovido ao N√∫cleo com sucesso!', 'success');
                
                if (appState.currentPage === 'members') {
                    renderMembers();
                }
                if (appState.currentPage === 'nucleo-admin') {
                    renderNucleoAdmin();
                }
            }
        }

        function approveTheory(theoryId) {
            const theoryIndex = appState.theories.findIndex(t => t.id === theoryId);
            
            if (theoryIndex !== -1) {
                appState.theories[theoryIndex].status = 'published';
                saveToStorage(STORAGE_KEYS.THEORIES, appState.theories);
                
                showToast('Teoria aprovada com sucesso!', 'success');
                
                if (appState.currentPage === 'nucleo-admin') {
                    renderNucleoAdmin();
                }
            }
        }

        function rejectTheory(theoryId) {
            const theoryIndex = appState.theories.findIndex(t => t.id === theoryId);
            
            if (theoryIndex !== -1) {
                appState.theories.splice(theoryIndex, 1);
                saveToStorage(STORAGE_KEYS.THEORIES, appState.theories);
                
                showToast('Teoria rejeitada', 'info');
                
                if (appState.currentPage === 'nucleo-admin') {
                    renderNucleoAdmin();
                }
            }
        }

        function editTheory(theoryId) {
            const theory = appState.theories.find(t => t.id === theoryId);
            if (!theory) return;
            
            // Preencher modal de edi√ß√£o
            showModal('new-theory');
            
            setTimeout(() => {
                document.getElementById('modal-theory-title').value = theory.title;
                document.getElementById('modal-theory-description').value = theory.description;
                document.getElementById('modal-theory-content').value = theory.content;
                document.getElementById('modal-theory-tags').value = theory.tags?.join(', ') || '';
                document.getElementById('modal-theory-visibility').value = theory.visibility;
                
                // Substituir handler para edi√ß√£o
                const form = document.getElementById('new-theory-form');
                form.onsubmit = function(event) {
                    event.preventDefault();
                    
                    const updatedTheory = {
                        ...theory,
                        title: document.getElementById('modal-theory-title').value.trim(),
                        description: document.getElementById('modal-theory-description').value.trim(),
                        content: document.getElementById('modal-theory-content').value.trim(),
                        tags: document.getElementById('modal-theory-tags').value.split(',').map(t => t.trim()).filter(t => t),
                        visibility: document.getElementById('modal-theory-visibility').value,
                        updatedAt: new Date().toISOString()
                    };
                    
                    const theoryIndex = appState.theories.findIndex(t => t.id === theoryId);
                    if (theoryIndex !== -1) {
                        appState.theories[theoryIndex] = updatedTheory;
                        saveToStorage(STORAGE_KEYS.THEORIES, appState.theories);
                        
                        closeModal();
                        showToast('Teoria atualizada com sucesso!', 'success');
                        renderTheories();
                    }
                };
            }, 100);
        }

        function viewTheory(theoryId) {
            showModal('view-theory', { theoryId });
        }

        function viewForumTopic(topicId) {
            const topic = appState.forumPosts.find(p => p.id === topicId);
            if (!topic) return;
            
            const modalHTML = `
                <div class="modal-overlay">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">${topic.title}</h3>
                            <button class="modal-close" onclick="closeModal()">&times;</button>
                        </div>
                        <div class="modal-body">
                            <div style="margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--border-color);">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <div>
                                        <span style="color: var(--text-secondary);">Por:</span>
                                        <span style="font-weight: 600; margin-left: 5px;">${topic.author}</span>
                                    </div>
                                    <span style="color: var(--text-secondary);">${formatDate(topic.createdAt)}</span>
                                </div>
                                <div style="margin-top: 10px;">
                                    ${topic.tags?.map(tag => 
                                        `<span class="badge badge-observador" style="margin-right: 5px;">${tag.trim()}</span>`
                                    ).join('')}
                                    <span class="badge ${topic.category === 'desafio' ? 'badge-nucleo' : 
                                                      topic.category === 'discussao' ? 'badge-iniciado' : 'badge-observador'}" 
                                          style="margin-left: 10px;">
                                        ${topic.category === 'desafio' ? 'Desafio' : 
                                         topic.category === 'discussao' ? 'Discuss√£o' : 'Pergunta'}
                                    </span>
                                </div>
                            </div>
                            
                            <div style="line-height: 1.8; margin-bottom: 30px;">
                                ${topic.content.replace(/\n/g, '<br>')}
                            </div>
                            
                            <div style="border-top: 1px solid var(--border-color); padding-top: 20px;">
                                <h4 style="margin-bottom: 15px;">Respostas (${topic.replies?.length || 0})</h4>
                                
                                <div id="topic-replies" style="margin-bottom: 20px;">
                                    ${(topic.replies || []).map(reply => {
                                        const replyAuthor = appState.users.find(u => u.id === reply.authorId);
                                        return `
                                            <div style="padding: 15px; border-bottom: 1px solid var(--border-color);">
                                                <div style="display: flex; justify-content: space-between; margin-bottom: 10px;">
                                                    <span style="font-weight: 600;">${replyAuthor?.name || 'Autor desconhecido'}</span>
                                                    <span style="color: var(--text-secondary); font-size: 0.9rem;">${formatDate(reply.createdAt)}</span>
                                                </div>
                                                <div>${reply.content.replace(/\n/g, '<br>')}</div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                                
                                <form id="reply-form">
                                    <div class="form-group">
                                        <label class="form-label">Sua Resposta</label>
                                        <textarea class="form-control" id="reply-content" rows="4" 
                                                  placeholder="Escreva sua resposta..."></textarea>
                                    </div>
                                    <button type="submit" class="btn btn-primary" style="margin-top: 10px;">
                                        <i class="fas fa-reply"></i> Responder
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.getElementById('modal-container').innerHTML = modalHTML;
            
            // Adicionar handler para respostas
            setTimeout(() => {
                document.getElementById('reply-form')?.addEventListener('submit', function(event) {
                    event.preventDefault();
                    
                    const content = document.getElementById('reply-content').value.trim();
                    if (!content) {
                        showToast('Digite uma resposta', 'warning');
                        return;
                    }
                    
                    const reply = {
                        id: generateId(),
                        content,
                        authorId: currentUser.id,
                        author: currentUser.name,
                        createdAt: new Date().toISOString()
                    };
                    
                    // Adicionar resposta
                    const topicIndex = appState.forumPosts.findIndex(p => p.id === topicId);
                    if (topicIndex !== -1) {
                        if (!appState.forumPosts[topicIndex].replies) {
                            appState.forumPosts[topicIndex].replies = [];
                        }
                        appState.forumPosts[topicIndex].replies.push(reply);
                        saveToStorage(STORAGE_KEYS.FORUM_POSTS, appState.forumPosts);
                        
                        // Atualizar modal
                        document.getElementById('reply-content').value = '';
                        viewForumTopic(topicId); // Recarregar modal
                        showToast('Resposta enviada com sucesso!', 'success');
                    }
                });
                
                // Re-processar MathJax
                if (window.MathJax) {
                    setTimeout(() => MathJax.typesetPromise(), 200);
                }
            }, 100);
        }

        // =============================================
        // EVENT LISTENERS
        // =============================================
        document.addEventListener('DOMContentLoaded', function() {
            // Inicializar storage
            initializeStorage();
            
            // Tentar carregar usu√°rio logado
            const savedUser = loadFromStorage(STORAGE_KEYS.CURRENT_USER);
            if (savedUser) {
                currentUser = savedUser;
                loadAppData();
                renderApp();
            }
            
            // Login form
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            
            // Logout
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
            
            // Navega√ß√£o
            document.querySelectorAll('.nav-link[data-page]').forEach(link => {
                link.addEventListener('click', function() {
                    appState.currentPage = this.dataset.page;
                    renderCurrentPage();
                });
            });
            
            // Bot√µes de a√ß√£o
            document.getElementById('new-theory-btn')?.addEventListener('click', function() {
                showModal('new-theory');
            });
            
            document.getElementById('new-forum-topic-btn')?.addEventListener('click', function() {
                showModal('new-forum-topic');
            });
            
            document.getElementById('add-contact-btn')?.addEventListener('click', function() {
                showModal('add-contact');
            });
            
            document.getElementById('change-password-btn')?.addEventListener('click', function() {
                showModal('change-password');
            });
            
            // Chat
            document.getElementById('send-chat-btn')?.addEventListener('click', sendMessage);
            document.getElementById('chat-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendMessage();
                }
            });
            
            // Chat privado
            document.getElementById('send-private-chat-btn')?.addEventListener('click', sendPrivateMessage);
            document.getElementById('private-chat-input')?.addEventListener('keypress', function(e) {
                if (e.key === 'Enter' && !e.shiftKey) {
                    e.preventDefault();
                    sendPrivateMessage();
                }
            });
            
            // Perfil
            document.getElementById('profile-form')?.addEventListener('submit', function(event) {
                event.preventDefault();
                
                const name = document.getElementById('profile-name').value.trim();
                const specialty = document.getElementById('profile-specialty').value.trim();
                const bio = document.getElementById('profile-bio').value.trim();
                
                if (!name || !specialty) {
                    showToast('Preencha todos os campos obrigat√≥rios', 'error');
                    return;
                }
                
                // Atualizar usu√°rio
                const users = loadFromStorage(STORAGE_KEYS.USERS) || [];
                const userIndex = users.findIndex(u => u.id === currentUser.id);
                
                if (userIndex !== -1) {
                    users[userIndex].name = name;
                    users[userIndex].specialty = specialty;
                    users[userIndex].bio = bio;
                    
                    currentUser.name = name;
                    currentUser.specialty = specialty;
                    currentUser.bio = bio;
                    
                    saveToStorage(STORAGE_KEYS.USERS, users);
                    saveToStorage(STORAGE_KEYS.CURRENT_USER, currentUser);
                    
                    updateUserInfo();
                    showToast('Perfil atualizado com sucesso!', 'success');
                }
            });
            
            // Busca de membros
            document.getElementById('search-members')?.addEventListener('input', renderMembers);
            document.getElementById('filter-level')?.addEventListener('change', renderMembers);
            
            // Configurar MathJax
            if (window.MathJax) {
                MathJax.typesetPromise();
            }
            
            // Simular status online
            if (currentUser) {
                setInterval(() => {
                    // Atualizar status do usu√°rio atual
                    const users = loadFromStorage(STORAGE_KEYS.USERS) || [];
                    const userIndex = users.findIndex(u => u.id === currentUser.id);
                    if (userIndex !== -1 && users[userIndex].status !== 'online') {
                        users[userIndex].status = 'online';
                        users[userIndex].lastSeen = new Date().toISOString();
                        saveToStorage(STORAGE_KEYS.USERS, users);
                        loadAppData();
                    }
                }, 60000); // Atualizar a cada minuto
                
                // Verificar mensagens n√£o lidas periodicamente
                setInterval(updateUnreadMessageCount, 10000);
            }
        });

        // =============================================
        // EXPORT FUNCTIONS TO GLOBAL SCOPE
        // =============================================
        window.switchChatChannel = switchChatChannel;
        window.startPrivateChat = startPrivateChat;
        window.loadPrivateChat = loadPrivateChat;
        window.addContact = addContact;
        window.removeContact = removeContact;
        window.joinGroup = joinGroup;
        window.leaveGroup = leaveGroup;
        window.viewGroup = function(groupId, event) {
            if (event) event.stopPropagation();
            // Implementar visualiza√ß√£o de grupo
            showToast('Funcionalidade em desenvolvimento', 'info');
        };
        window.promoteMember = promoteMember;
        window.promoteToNucleo = promoteToNucleo;
        window.approveTheory = approveTheory;
        window.rejectTheory = rejectTheory;
        window.viewTheory = viewTheory;
        window.viewForumTopic = viewForumTopic;
        window.closeModal = closeModal;
        window.showModal = showModal;

        // =============================================
        // INICIALIZA√á√ÉO FINAL
        // =============================================
        // Se j√° houver um usu√°rio logado, renderizar app
        if (currentUser) {
            renderApp();
        }
    </script>
</body>
</html>
