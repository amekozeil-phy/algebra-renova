<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Algebra Renova - Plataforma Operacional</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script>
MathJax = {
  tex: {
    inlineMath: [['$', '$'], ['\\(', '\\)']],
    displayMath: [['$$', '$$'], ['\\[', '\\]']]
  },
  options: {
    skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
    ignoreHtmlClass: 'tex2jax_ignore',
    processHtmlClass: 'tex2jax_process'
  }
};
</script>
<script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<style>
/* ===============================
   RESET + BASE
================================ */
* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: "Times New Roman", serif;
}

body {
  background: radial-gradient(circle at top, #0b0b0b, #000);
  color: #d6d6d6;
  min-height: 100vh;
  overflow-x: hidden;
}

/* ===============================
   ESTÉTICA GÓTICA / BRUTAL
================================ */
h1, h2, h3, h4 {
  letter-spacing: 1.5px;
  font-weight: normal;
}

h1 {
  font-size: 2.8rem;
  color: #8b0000;
  text-shadow: 0 0 15px #300;
  border-bottom: 2px solid #400;
  padding-bottom: 10px;
  margin-bottom: 20px;
}

h2 {
  color: #8b0000;
  font-size: 1.8rem;
  margin: 25px 0 15px 0;
  border-left: 3px solid #400;
  padding-left: 15px;
}

h3 {
  color: #a52a2a;
  font-size: 1.4rem;
  margin: 20px 0 10px 0;
}

/* ===============================
   HIERARQUIA DE CARGO
================================ */
.rank-badge {
  display: inline-block;
  padding: 3px 12px;
  border-radius: 12px;
  font-size: 0.8rem;
  font-weight: bold;
  letter-spacing: 1px;
  text-transform: uppercase;
  margin-left: 10px;
}

.rank-nucleo {
  background: linear-gradient(135deg, #daa520 0%, #b8860b 100%);
  color: #000;
  border: 1px solid #ffd700;
}

.rank-iniciado {
  background: linear-gradient(135deg, #1e3a8a 0%, #1e40af 100%);
  color: #fff;
  border: 1px solid #3b82f6;
}

.rank-observador {
  background: linear-gradient(135deg, #374151 0%, #4b5563 100%);
  color: #d1d5db;
  border: 1px solid #6b7280;
}

/* ===============================
   LAYOUT PRINCIPAL
================================ */
.container {
  display: grid;
  grid-template-columns: 280px 1fr 320px;
  gap: 0;
  min-height: calc(100vh - 80px);
}

/* ===============================
   SIDEBAR ESQUERDA - PERFIL E NAVEGAÇÃO
================================ */
#sidebar {
  background: rgba(15, 0, 0, 0.7);
  border-right: 2px solid #400;
  padding: 25px 20px;
  overflow-y: auto;
}

.profile-section {
  text-align: center;
  padding: 20px 0;
  border-bottom: 1px solid #300;
  margin-bottom: 25px;
}

.avatar-container {
  width: 100px;
  height: 100px;
  margin: 0 auto 15px;
  border-radius: 50%;
  overflow: hidden;
  border: 2px solid #400;
  background: #111;
  display: flex;
  align-items: center;
  justify-content: center;
}

.avatar-container img {
  width: 100%;
  height: 100%;
  object-fit: cover;
}

.avatar-placeholder {
  width: 100%;
  height: 100%;
  background: #222;
  display: flex;
  align-items: center;
  justify-content: center;
  color: #666;
  font-size: 2rem;
}

.nav-section {
  margin-bottom: 30px;
}

.nav-button {
  display: block;
  width: 100%;
  padding: 12px 15px;
  margin: 8px 0;
  background: transparent;
  color: #b30000;
  border: 1px solid #400;
  text-align: left;
  cursor: pointer;
  transition: all 0.3s;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.nav-button:hover {
  background: rgba(179, 0, 0, 0.1);
  border-color: #b30000;
  transform: translateX(5px);
}

.nav-button.active {
  background: rgba(179, 0, 0, 0.2);
  border-color: #b30000;
  color: #ff3333;
}

/* ===============================
   CONTEÚDO CENTRAL
================================ */
#main-content {
  padding: 30px;
  overflow-y: auto;
  background: rgba(10, 0, 0, 0.4);
}

.content-section {
  display: none;
  animation: fadeIn 0.5s;
}

.content-section.active {
  display: block;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

/* ===============================
   PAINEL DIREITO - ATIVIDADES E CHAT
================================ */
#right-panel {
  background: rgba(20, 0, 0, 0.8);
  border-left: 2px solid #400;
  padding: 25px 20px;
  overflow-y: auto;
}

.activity-log {
  max-height: 300px;
  overflow-y: auto;
  margin-bottom: 30px;
}

.activity-item {
  padding: 12px;
  margin-bottom: 8px;
  background: rgba(30, 0, 0, 0.3);
  border-left: 3px solid #400;
  font-size: 0.85rem;
}

.activity-item.new-member { border-left-color: #daa520; }
.activity-item.new-theory { border-left-color: #1e40af; }
.activity-item.new-connection { border-left-color: #10b981; }

.chat-container {
  border: 1px solid #400;
  background: rgba(0, 0, 0, 0.7);
  padding: 15px;
  margin-top: 20px;
}

#chat-messages {
  height: 200px;
  overflow-y: auto;
  margin-bottom: 15px;
  padding: 10px;
  background: #000;
  border: 1px solid #300;
}

.chat-message {
  margin-bottom: 10px;
  padding: 8px;
  border-bottom: 1px solid #222;
}

.chat-message .sender {
  color: #b30000;
  font-weight: bold;
  margin-right: 8px;
}

.chat-input {
  display: flex;
  gap: 10px;
}

.chat-input input {
  flex: 1;
  background: #111;
  border: 1px solid #400;
  color: #eee;
  padding: 8px 12px;
}

.chat-input button {
  background: #400;
  color: #eee;
  border: 1px solid #600;
  padding: 8px 15px;
  cursor: pointer;
  transition: background 0.3s;
}

.chat-input button:hover {
  background: #600;
}

/* ===============================
   FORMULÁRIOS E INPUTS
================================ */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  color: #b30000;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.form-control {
  width: 100%;
  padding: 12px;
  background: rgba(0, 0, 0, 0.7);
  border: 1px solid #400;
  color: #eee;
  font-size: 0.95rem;
}

.form-control:focus {
  outline: none;
  border-color: #b30000;
  box-shadow: 0 0 10px rgba(179, 0, 0, 0.3);
}

textarea.form-control {
  min-height: 150px;
  resize: vertical;
  font-family: monospace;
}

.btn-primary {
  background: linear-gradient(135deg, #8b0000 0%, #b30000 100%);
  color: white;
  border: none;
  padding: 12px 25px;
  cursor: pointer;
  font-size: 0.9rem;
  text-transform: uppercase;
  letter-spacing: 1.5px;
  transition: all 0.3s;
}

.btn-primary:hover {
  background: linear-gradient(135deg, #b30000 0%, #8b0000 100%);
  box-shadow: 0 0 15px rgba(179, 0, 0, 0.4);
}

.btn-secondary {
  background: transparent;
  color: #b30000;
  border: 1px solid #400;
  padding: 10px 20px;
  cursor: pointer;
  transition: all 0.3s;
}

.btn-secondary:hover {
  background: rgba(179, 0, 0, 0.1);
  border-color: #b30000;
}

/* ===============================
   CARDS E LISTAS
================================ */
.card {
  background: rgba(20, 0, 0, 0.5);
  border: 1px solid #400;
  padding: 20px;
  margin-bottom: 20px;
  transition: all 0.3s;
}

.card:hover {
  border-color: #b30000;
  background: rgba(30, 0, 0, 0.6);
}

.card-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 15px;
  padding-bottom: 10px;
  border-bottom: 1px solid #300;
}

.card-title {
  color: #b30000;
  font-size: 1.2rem;
}

.card-meta {
  color: #666;
  font-size: 0.8rem;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.list-item {
  padding: 15px;
  margin-bottom: 10px;
  background: rgba(10, 0, 0, 0.3);
  border-left: 3px solid #400;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.list-item:hover {
  background: rgba(20, 0, 0, 0.5);
  border-left-color: #b30000;
}

/* ===============================
   BANNER E HEADER
================================ */
#banner {
  background: linear-gradient(135deg, #000 0%, #1a0000 100%);
  border-bottom: 3px solid #400;
  padding: 20px 30px;
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.banner-title {
  font-size: 2.5rem;
  color: #8b0000;
  text-shadow: 0 0 20px #300;
  letter-spacing: 3px;
}

.system-status {
  display: flex;
  gap: 20px;
  font-size: 0.9rem;
  color: #666;
}

.status-item {
  text-align: center;
}

.status-value {
  display: block;
  color: #b30000;
  font-size: 1.2rem;
  font-weight: bold;
}

/* ===============================
   UTILITÁRIOS
================================ */
.hidden {
  display: none !important;
}

.text-center {
  text-align: center;
}

.mt-20 { margin-top: 20px; }
.mb-20 { margin-bottom: 20px; }
.mt-30 { margin-top: 30px; }
.mb-30 { margin-bottom: 30px; }

/* ===============================
   SCROLLBAR
================================ */
::-webkit-scrollbar {
  width: 10px;
}

::-webkit-scrollbar-track {
  background: #111;
}

::-webkit-scrollbar-thumb {
  background: #400;
  border-radius: 5px;
}

::-webkit-scrollbar-thumb:hover {
  background: #600;
}
</style>
</head>
<body>

<div id="banner">
  <div class="banner-title">ALGEBRA RENOVA</div>
  <div class="system-status">
    <div class="status-item">
      <span class="status-value" id="member-count">0</span>
      <span>MEMBROS</span>
    </div>
    <div class="status-item">
      <span class="status-value" id="theory-count">0</span>
      <span>TEORIAS</span>
    </div>
    <div class="status-item">
      <span class="status-value" id="online-count">0</span>
      <span>ONLINE</span>
    </div>
  </div>
</div>

<div class="container">
  
  <!-- SIDEBAR ESQUERDA -->
  <aside id="sidebar">
    <div class="profile-section">
      <div class="avatar-container" id="user-avatar">
        <div class="avatar-placeholder" id="avatar-placeholder">A</div>
      </div>
      <h3 id="username-display">Carregando...</h3>
      <div id="user-rank" class="rank-badge rank-observador">Observador</div>
      <div class="mt-20">
        <button class="btn-secondary" onclick="openProfileEditor()">Editar Perfil</button>
      </div>
    </div>

    <div class="nav-section">
      <button class="nav-button active" onclick="showSection('dashboard')">Dashboard</button>
      <button class="nav-button" onclick="showSection('theories')">Teorias</button>
      <button class="nav-button" onclick="showSection('archive')">Arquivo</button>
      <button class="nav-button" onclick="showSection('bounty')">Desafios</button>
      <button class="nav-button" onclick="showSection('members')">Membros</button>
      <button class="nav-button" onclick="showSection('connections')">Conexões</button>
    </div>

    <div class="nav-section">
      <h4>Ferramentas</h4>
      <button class="nav-button" onclick="showSection('editor')" id="editor-btn">Editor Teórico</button>
      <button class="nav-button" onclick="showSection('upload')">Upload de Referência</button>
      <button class="nav-button" onclick="showSection('reports')">Relatórios</button>
    </div>
  </aside>

  <!-- CONTEÚDO CENTRAL -->
  <main id="main-content">
    
    <!-- DASHBOARD -->
    <section id="dashboard" class="content-section active">
      <h2>Dashboard do Sistema</h2>
      <div class="card">
        <div class="card-header">
          <div class="card-title">Status da Rede</div>
          <div class="card-meta">Última Atualização: <span id="last-update"></span></div>
        </div>
        <p>Plataforma operacional. Sistema de hierarquia rigorosa implementado.</p>
        <div class="mt-20">
          <div class="list-item">
            <span>Teorias Ativas</span>
            <span id="active-theories">0</span>
          </div>
          <div class="list-item">
            <span>Desafios em Aberto</span>
            <span id="open-bounties">0</span>
          </div>
          <div class="list-item">
            <span>Referências Catalogadas</span>
            <span id="archived-refs">0</span>
          </div>
        </div>
      </div>

      <h3>Minhas Conexões</h3>
      <div id="my-connections-list" class="mt-20">
        <!-- Conexões serão carregadas dinamicamente -->
      </div>
    </section>

    <!-- TEORIAS -->
    <section id="theories" class="content-section">
      <div class="card-header">
        <h2>Teorias Publicadas</h2>
        <button class="btn-primary" id="new-theory-btn" onclick="showSection('editor')">Nova Teoria</button>
      </div>
      <div id="theories-list">
        <!-- Teorias serão carregadas dinamicamente -->
      </div>
    </section>

    <!-- EDITOR TEÓRICO -->
    <section id="editor" class="content-section">
      <h2>Editor Teórico</h2>
      <div class="card">
        <div class="form-group">
          <label for="theory-title">Título da Teoria</label>
          <input type="text" id="theory-title" class="form-control" placeholder="Ex: Álgebra Não-Associativa em Espaços de Dimensão Infinita">
        </div>
        <div class="form-group">
          <label for="theory-content">Conteúdo (Suporte LaTeX: use $...$ para inline, $$...$$ para display)</label>
          <textarea id="theory-content" class="form-control" placeholder="Descreva sua teoria matemática aqui..."></textarea>
        </div>
        <div class="form-group">
          <label for="theory-tags">Tags (separadas por vírgula)</label>
          <input type="text" id="theory-tags" class="form-control" placeholder="álgebra, não-associativa, teoria-de-categorias">
        </div>
        <div class="text-center">
          <button class="btn-primary" onclick="publishTheory()">Publicar Teoria</button>
          <button class="btn-secondary" onclick="showSection('theories')">Cancelar</button>
        </div>
      </div>
    </section>

    <!-- ARQUIVO -->
    <section id="archive" class="content-section">
      <h2>Arquivo de Referências</h2>
      <div class="card">
        <div class="form-group">
          <label for="ref-title">Título da Referência</label>
          <input type="text" id="ref-title" class="form-control" placeholder="Ex: Artigo: 'Non-Associative Algebras in Quantum Gravity'">
        </div>
        <div class="form-group">
          <label for="ref-url">URL ou DOI</label>
          <input type="text" id="ref-url" class="form-control" placeholder="https://arxiv.org/abs/... ou DOI: 10.1000/...">
        </div>
        <div class="form-group">
          <label for="ref-description">Descrição/Resumo</label>
          <textarea id="ref-description" class="form-control" placeholder="Resumo ou comentários sobre esta referência..."></textarea>
        </div>
        <button class="btn-primary" onclick="addReference()">Adicionar ao Arquivo</button>
      </div>

      <div id="references-list" class="mt-30">
        <!-- Referências serão carregadas dinamicamente -->
      </div>
    </section>

    <!-- DESAFIOS -->
    <section id="bounty" class="content-section">
      <h2>Quadro de Desafios</h2>
      <div id="bounty-board">
        <!-- Desafios serão carregados dinamicamente -->
      </div>
    </section>

    <!-- MEMBROS -->
    <section id="members" class="content-section">
      <h2>Membros da Rede</h2>
      <div class="form-group">
        <input type="text" id="search-member" class="form-control" placeholder="Buscar membro por nome ou nick..." onkeyup="searchMembers()">
      </div>
      <div id="members-list">
        <!-- Membros serão carregados dinamicamente -->
      </div>
    </section>

    <!-- CONEXÕES -->
    <section id="connections" class="content-section">
      <h2>Minhas Conexões</h2>
      <div id="connections-container">
        <!-- Conexões serão carregadas dinamicamente -->
      </div>
    </section>

    <!-- UPLOAD -->
    <section id="upload" class="content-section">
      <h2>Upload de Documento</h2>
      <div class="card">
        <div class="form-group">
          <label for="doc-title">Título do Documento</label>
          <input type="text" id="doc-title" class="form-control">
        </div>
        <div class="form-group">
          <label for="doc-file">Arquivo (PDF, TEX, MD)</label>
          <input type="file" id="doc-file" class="form-control" accept=".pdf,.tex,.md,.txt">
        </div>
        <div class="form-group">
          <label for="doc-description">Descrição</label>
          <textarea id="doc-description" class="form-control"></textarea>
        </div>
        <button class="btn-primary" onclick="uploadDocument()">Upload</button>
      </div>
    </section>

    <!-- RELATÓRIOS -->
    <section id="reports" class="content-section">
      <h2>Relatórios do Sistema</h2>
      <div class="card">
        <h3>Estatísticas da Rede</h3>
        <div id="system-stats"></div>
      </div>
    </section>

  </main>

  <!-- PAINEL DIREITO -->
  <aside id="right-panel">
    <h3>Log de Atividades</h3>
    <div class="activity-log" id="activity-log">
      <!-- Atividades serão carregadas dinamicamente -->
    </div>

    <h3>Chat de Desafios</h3>
    <div class="chat-container">
      <div id="chat-messages"></div>
      <div class="chat-input">
        <input type="text" id="chat-input" placeholder="Discuta soluções..." onkeypress="if(event.key==='Enter') sendChatMessage()">
        <button onclick="sendChatMessage()">Enviar</button>
      </div>
    </div>

    <div class="mt-30">
      <h4>Status do Usuário</h4>
      <div id="user-status-display"></div>
    </div>
  </aside>

</div>

<!-- MODAL EDITOR DE PERFIL -->
<div id="profile-modal" class="hidden" style="position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; display: flex; align-items: center; justify-content: center;">
  <div style="background: #111; border: 2px solid #400; padding: 30px; width: 90%; max-width: 500px;">
    <h2 style="color: #b30000; margin-bottom: 20px;">Editar Perfil</h2>
    
    <div class="form-group">
      <label>Nome de Exibição</label>
      <input type="text" id="edit-username" class="form-control">
    </div>
    
    <div class="form-group">
      <label>Avatar (URL da imagem)</label>
      <input type="text" id="edit-avatar" class="form-control" placeholder="https://...">
    </div>
    
    <div class="form-group">
      <label>Biografia</label>
      <textarea id="edit-bio" class="form-control" rows="4"></textarea>
    </div>
    
    <div class="form-group">
      <label>Áreas de Interesse (separadas por vírgula)</label>
      <input type="text" id="edit-interests" class="form-control" placeholder="álgebra, topologia, teoria das categorias">
    </div>
    
    <div style="display: flex; gap: 15px; margin-top: 25px;">
      <button class="btn-primary" onclick="saveProfile()">Salvar Alterações</button>
      <button class="btn-secondary" onclick="closeProfileEditor()">Cancelar</button>
    </div>
  </div>
</div>

<script>
// ===============================
// SISTEMA DE ESTADO GLOBAL
// ===============================
class AlgebraRenovaSystem {
  constructor() {
    this.loadState();
    this.initializeSystem();
  }

  loadState() {
    // Estado principal
    this.currentUser = JSON.parse(localStorage.getItem('ar_currentUser')) || this.createDefaultUser();
    this.users = JSON.parse(localStorage.getItem('ar_users')) || [this.currentUser];
    this.theories = JSON.parse(localStorage.getItem('ar_theories')) || [];
    this.references = JSON.parse(localStorage.getItem('ar_references')) || [];
    this.bounties = JSON.parse(localStorage.getItem('ar_bounties')) || [];
    this.documents = JSON.parse(localStorage.getItem('ar_documents')) || [];
    this.activities = JSON.parse(localStorage.getItem('ar_activities')) || [];
    this.chatMessages = JSON.parse(localStorage.getItem('ar_chatMessages')) || [];
    
    // Inicializar contadores reais
    this.updateCounters();
    
    // Log de inicialização
    this.logActivity('Sistema inicializado', 'system');
  }

  createDefaultUser() {
    return {
      id: this.generateId(),
      username: 'Usuario_' + Math.floor(Math.random() * 1000),
      rank: 'observador',
      avatar: '',
      bio: '',
      interests: [],
      connections: [],
      joinDate: new Date().toISOString(),
      lastActive: new Date().toISOString()
    };
  }

  generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
  }

  initializeSystem() {
    // Atualizar interface
    this.updateUserDisplay();
    this.updateCounters();
    this.renderTheories();
    this.renderReferences();
    this.renderBounties();
    this.renderMembers();
    this.renderActivities();
    this.renderChat();
    
    // Configurar intervalos de atualização
    setInterval(() => this.updateUserActivity(), 30000);
    setInterval(() => this.renderActivities(), 60000);
  }

  // ===============================
  // SISTEMA DE HIERARQUIA
  // ===============================
  canPublishTheory() {
    const ranks = ['nucleo', 'iniciado'];
    return ranks.includes(this.currentUser.rank);
  }

  canCreateBounty() {
    return this.currentUser.rank === 'nucleo';
  }

  getRankDisplay(rank) {
    const ranks = {
      'nucleo': { name: 'Núcleo', class: 'rank-nucleo' },
      'iniciado': { name: 'Iniciado', class: 'rank-iniciado' },
      'observador': { name: 'Observador', class: 'rank-observador' }
    };
    return ranks[rank] || ranks.observador;
  }

  // ===============================
  // OPERAÇÕES DO USUÁRIO
  // ===============================
  updateUserDisplay() {
    document.getElementById('username-display').textContent = this.currentUser.username;
    
    const rank = this.getRankDisplay(this.currentUser.rank);
    const rankBadge = document.getElementById('user-rank');
    rankBadge.textContent = rank.name;
    rankBadge.className = `rank-badge ${rank.class}`;
    
    // Atualizar avatar
    if (this.currentUser.avatar) {
      document.getElementById('avatar-placeholder').innerHTML = `<img src="${this.currentUser.avatar}" alt="${this.currentUser.username}">`;
    }
    
    // Botão de nova teoria baseado em permissões
    const newTheoryBtn = document.getElementById('new-theory-btn');
    if (this.canPublishTheory()) {
      newTheoryBtn.classList.remove('hidden');
    } else {
      newTheoryBtn.classList.add('hidden');
    }
  }

  updateUserActivity() {
    this.currentUser.lastActive = new Date().toISOString();
    this.saveUserState();
  }

  saveUserState() {
    // Atualizar usuário na lista
    const userIndex = this.users.findIndex(u => u.id === this.currentUser.id);
    if (userIndex > -1) {
      this.users[userIndex] = this.currentUser;
    } else {
      this.users.push(this.currentUser);
    }
    
    localStorage.setItem('ar_currentUser', JSON.stringify(this.currentUser));
    localStorage.setItem('ar_users', JSON.stringify(this.users));
  }

  // ===============================
  // TEORIAS
  // ===============================
  publishTheory(title, content, tags) {
    if (!this.canPublishTheory()) {
      alert('Apenas membros do Núcleo e Iniciados podem publicar teorias.');
      return;
    }

    const theory = {
      id: this.generateId(),
      title: title,
      content: content,
      tags: tags.split(',').map(tag => tag.trim()),
      author: this.currentUser.username,
      authorId: this.currentUser.id,
      authorRank: this.currentUser.rank,
      createdAt: new Date().toISOString(),
      views: 0,
      comments: []
    };

    this.theories.unshift(theory);
    localStorage.setItem('ar_theories', JSON.stringify(this.theories));
    
    this.logActivity(`${this.currentUser.username} publicou uma nova teoria: "${title}"`, 'new-theory');
    this.renderTheories();
    this.updateCounters();
    
    // Processar MathJax
    setTimeout(() => MathJax.typeset(), 100);
  }

  renderTheories() {
    const container = document.getElementById('theories-list');
    if (!container) return;

    container.innerHTML = '';
    
    this.theories.forEach(theory => {
      const theoryCard = document.createElement('div');
      theoryCard.className = 'card';
      theoryCard.innerHTML = `
        <div class="card-header">
          <div class="card-title">${theory.title}</div>
          <div class="card-meta">
            Por: ${theory.author} 
            <span class="rank-badge ${this.getRankDisplay(theory.authorRank).class}">${this.getRankDisplay(theory.authorRank).name}</span>
          </div>
        </div>
        <div class="theory-content">${theory.content}</div>
        <div class="mt-20">
          <span style="color: #666; font-size: 0.8rem;">Tags: ${theory.tags.join(', ')}</span>
          <span style="float: right; color: #666; font-size: 0.8rem;">Visualizações: ${theory.views}</span>
        </div>
      `;
      container.appendChild(theoryCard);
    });
  }

  // ===============================
  // ARQUIVO DE REFERÊNCIAS
  // ===============================
  addReference(title, url, description) {
    const reference = {
      id: this.generateId(),
      title: title,
      url: url,
      description: description,
      addedBy: this.currentUser.username,
      addedById: this.currentUser.id,
      addedAt: new Date().toISOString(),
      verified: this.currentUser.rank === 'nucleo'
    };

    this.references.unshift(reference);
    localStorage.setItem('ar_references', JSON.stringify(this.references));
    
    this.logActivity(`${this.currentUser.username} adicionou uma referência: "${title}"`, 'archive');
    this.renderReferences();
    this.updateCounters();
  }

  renderReferences() {
    const container = document.getElementById('references-list');
    if (!container) return;

    container.innerHTML = '';
    
    this.references.forEach(ref => {
      const refItem = document.createElement('div');
      refItem.className = 'list-item';
      refItem.innerHTML = `
        <div>
          <strong>${ref.title}</strong><br>
          <small style="color: #666;">${ref.url}</small><br>
          <small>${ref.description}</small>
        </div>
        <div style="text-align: right;">
          <small>Adicionado por: ${ref.addedBy}</small><br>
          <small>${new Date(ref.addedAt).toLocaleDateString()}</small>
        </div>
      `;
      container.appendChild(refItem);
    });
  }

  // ===============================
  // QUADRO DE DESAFIOS
  // ===============================
  createBounty(title, description, reward) {
    if (!this.canCreateBounty()) {
      alert('Apenas membros do Núcleo podem criar desafios.');
      return;
    }

    const bounty = {
      id: this.generateId(),
      title: title,
      description: description,
      reward: reward,
      createdBy: this.currentUser.username,
      createdById: this.currentUser.id,
      createdAt: new Date().toISOString(),
      status: 'open',
      submissions: []
    };

    this.bounties.unshift(bounty);
    localStorage.setItem('ar_bounties', JSON.stringify(this.bounties));
    
    this.logActivity(`Novo desafio criado por ${this.currentUser.username}: "${title}"`, 'bounty');
    this.renderBounties();
    this.updateCounters();
  }

  renderBounties() {
    const container = document.getElementById('bounty-board');
    if (!container) return;

    container.innerHTML = '';
    
    this.bounties.forEach(bounty => {
      const bountyCard = document.createElement('div');
      bountyCard.className = 'card';
      bountyCard.innerHTML = `
        <div class="card-header">
          <div class="card-title">${bounty.title}</div>
          <div class="card-meta">
            <span class="rank-badge ${bounty.status === 'open' ? 'rank-iniciado' : 'rank-observador'}">
              ${bounty.status === 'open' ? 'ABERTO' : 'RESOLVIDO'}
            </span>
          </div>
        </div>
        <p>${bounty.description}</p>
        <div class="mt-20">
          <span style="color: #daa520;">Recompensa: ${bounty.reward}</span>
          <span style="float: right; color: #666;">Criado por: ${bounty.createdBy}</span>
        </div>
        ${bounty.status === 'open' ? 
          `<button class="btn-secondary mt-20" onclick="submitBountySolution('${bounty.id}')">Submeter Solução</button>` : 
          ''
        }
      `;
      container.appendChild(bountyCard);
    });
  }

  // ===============================
  // SISTEMA DE MEMBROS
  // ===============================
  renderMembers() {
    const container = document.getElementById('members-list');
    if (!container) return;

    container.innerHTML = '';
    
    this.users.forEach(user => {
      const rank = this.getRankDisplay(user.rank);
      const memberCard = document.createElement('div');
      memberCard.className = 'list-item';
      memberCard.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
          <div style="width: 40px; height: 40px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center;">
            ${user.username.charAt(0)}
          </div>
          <div>
            <strong>${user.username}</strong><br>
            <span class="rank-badge ${rank.class}" style="font-size: 0.7rem;">${rank.name}</span>
          </div>
        </div>
        <div>
          ${user.id !== this.currentUser.id && !this.currentUser.connections.includes(user.id) ?
            `<button class="btn-secondary" onclick="system.sendConnectionRequest('${user.id}')">Conectar</button>` :
            '<small style="color: #666;">Conectado</small>'
          }
        </div>
      `;
      container.appendChild(memberCard);
    });
  }

  searchMembers() {
    const searchTerm = document.getElementById('search-member').value.toLowerCase();
    const members = document.querySelectorAll('#members-list .list-item');
    
    members.forEach(member => {
      const text = member.textContent.toLowerCase();
      member.style.display = text.includes(searchTerm) ? 'flex' : 'none';
    });
  }

  // ===============================
  // SISTEMA DE CONEXÕES
  // ===============================
  sendConnectionRequest(targetUserId) {
    const targetUser = this.users.find(u => u.id === targetUserId);
    if (!targetUser) return;

    // Adicionar conexão
    if (!this.currentUser.connections.includes(targetUserId)) {
      this.currentUser.connections.push(targetUserId);
      this.saveUserState();
      
      this.logActivity(`${this.currentUser.username} conectou-se com ${targetUser.username}`, 'new-connection');
      this.renderMembers();
      this.updateUserDisplay();
    }
  }

  renderConnections() {
    const container = document.getElementById('connections-container');
    if (!container) return;

    container.innerHTML = '';
    
    const connectedUsers = this.users.filter(user => 
      this.currentUser.connections.includes(user.id)
    );

    if (connectedUsers.length === 0) {
      container.innerHTML = '<p style="color: #666;">Nenhuma conexão estabelecida.</p>';
      return;
    }

    connectedUsers.forEach(user => {
      const rank = this.getRankDisplay(user.rank);
      const connectionCard = document.createElement('div');
      connectionCard.className = 'list-item';
      connectionCard.innerHTML = `
        <div style="display: flex; align-items: center; gap: 15px;">
          <div style="width: 50px; height: 50px; border-radius: 50%; background: #222; display: flex; align-items: center; justify-content: center; font-size: 1.2rem;">
            ${user.username.charAt(0)}
          </div>
          <div>
            <strong>${user.username}</strong><br>
            <span class="rank-badge ${rank.class}">${rank.name}</span><br>
            <small style="color: #666;">${user.interests?.slice(0, 3).join(', ') || 'Sem interesses definidos'}</small>
          </div>
        </div>
      `;
      container.appendChild(connectionCard);
    });
  }

  // ===============================
  // ATIVIDADES E LOG
  // ===============================
  logActivity(message, type = 'system') {
    const activity = {
      id: this.generateId(),
      message: message,
      type: type,
      timestamp: new Date().toISOString(),
      user: this.currentUser.username
    };

    this.activities.unshift(activity);
    
    // Manter apenas as 50 atividades mais recentes
    if (this.activities.length > 50) {
      this.activities = this.activities.slice(0, 50);
    }

    localStorage.setItem('ar_activities', JSON.stringify(this.activities));
    this.renderActivities();
  }

  renderActivities() {
    const container = document.getElementById('activity-log');
    if (!container) return;

    container.innerHTML = '';
    
    this.activities.slice(0, 10).forEach(activity => {
      const activityItem = document.createElement('div');
      activityItem.className = `activity-item ${activity.type}`;
      activityItem.innerHTML = `
        <div style="color: #999; font-size: 0.75rem;">
          ${new Date(activity.timestamp).toLocaleTimeString()}
        </div>
        <div>${activity.message}</div>
      `;
      container.appendChild(activityItem);
    });
  }

  // ===============================
  // SISTEMA DE CHAT
  // ===============================
  sendChatMessage(message) {
    const input = document.getElementById('chat-input');
    if (!input) return;

    const text = message || input.value.trim();
    if (!text) return;

    const chatMessage = {
      id: this.generateId(),
      user: this.currentUser.username,
      userId: this.currentUser.id,
      userRank: this.currentUser.rank,
      text: text,
      timestamp: new Date().toISOString()
    };

    this.chatMessages.push(chatMessage);
    
    // Manter apenas as 100 mensagens mais recentes
    if (this.chatMessages.length > 100) {
      this.chatMessages = this.chatMessages.slice(-100);
    }

    localStorage.setItem('ar_chatMessages', JSON.stringify(this.chatMessages));
    input.value = '';
    this.renderChat();
  }

  renderChat() {
    const container = document.getElementById('chat-messages');
    if (!container) return;

    container.innerHTML = '';
    
    this.chatMessages.slice(-20).forEach(msg => {
      const rank = this.getRankDisplay(msg.userRank);
      const messageDiv = document.createElement('div');
      messageDiv.className = 'chat-message';
      messageDiv.innerHTML = `
        <div>
          <span class="sender">${msg.user}</span>
          <span class="rank-badge ${rank.class}" style="font-size: 0.6rem; padding: 1px 6px;">${rank.name}</span>
          <span style="color: #666; font-size: 0.7rem;">
            ${new Date(msg.timestamp).toLocaleTimeString()}
          </span>
        </div>
        <div>${msg.text}</div>
      `;
      container.appendChild(messageDiv);
    });

    container.scrollTop = container.scrollHeight;
  }

  // ===============================
  // CONTADORES E ESTATÍSTICAS
  // ===============================
  updateCounters() {
    document.getElementById('member-count').textContent = this.users.length;
    document.getElementById('theory-count').textContent = this.theories.length;
    document.getElementById('online-count').textContent = this.users.filter(u => 
      new Date() - new Date(u.lastActive) < 300000
    ).length;
    
    document.getElementById('active-theories').textContent = this.theories.length;
    document.getElementById('open-bounties').textContent = this.bounties.filter(b => b.status === 'open').length;
    document.getElementById('archived-refs').textContent = this.references.length;
    
    document.getElementById('last-update').textContent = new Date().toLocaleTimeString();
  }

  // ===============================
  // PERFIL DO USUÁRIO
  // ===============================
  saveProfile() {
    const username = document.getElementById('edit-username').value.trim();
    const avatar = document.getElementById('edit-avatar').value.trim();
    const bio = document.getElementById('edit-bio').value.trim();
    const interests = document.getElementById('edit-interests').value.split(',').map(i => i.trim());

    if (username) {
      this.currentUser.username = username;
    }
    
    if (avatar) {
      this.currentUser.avatar = avatar;
    }
    
    this.currentUser.bio = bio;
    this.currentUser.interests = interests;

    this.saveUserState();
    this.updateUserDisplay();
    this.closeProfileEditor();
    
    this.logActivity(`${this.currentUser.username} atualizou seu perfil`, 'system');
  }
}

// ===============================
// INSTANCIAÇÃO DO SISTEMA
// ===============================
let system;

document.addEventListener('DOMContentLoaded', () => {
  system = new AlgebraRenovaSystem();
  
  // Adicionar alguns dados iniciais se o sistema estiver vazio
  if (system.theories.length === 0) {
    system.publishTheory(
      'Fundamentos da Algebra Renova',
      'A Algebra Renova transcende as estruturas convencionais. Consideremos uma álgebra $A$ sobre um corpo $K$ com operação $*$ não necessariamente associativa. Definimos a transformação radical: $$T: A \\to A, \\quad T(x) = \\lim_{n\\to\\infty} \\frac{x^{*n}}{n!}$$ onde $x^{*n}$ denota a $n$-ésima potência não-associativa.',
      'álgebra, fundamentos, não-associativa'
    );
  }

  if (system.bounties.length === 0 && system.currentUser.rank === 'nucleo') {
    system.createBounty(
      'Problema da Auto-Similaridade Algébrica',
      'Encontre uma estrutura algébrica não-associativa que seja isomorfa a um de seus subconjuntos próprios. Considere espaços de dimensão infinita.',
      'Acesso ao Núcleo por 30 dias'
    );
  }
});

// ===============================
// FUNÇÕES DE INTERFACE
// ===============================
function showSection(sectionId) {
  // Esconder todas as seções
  document.querySelectorAll('.content-section').forEach(section => {
    section.classList.remove('active');
  });
  
  // Mostrar seção selecionada
  const section = document.getElementById(sectionId);
  if (section) {
    section.classList.add('active');
  }
  
  // Atualizar botões de navegação
  document.querySelectorAll('.nav-button').forEach(button => {
    button.classList.remove('active');
  });
  
  // Atualizar interface baseado na seção
  if (sectionId === 'theories') {
    system.renderTheories();
  } else if (sectionId === 'members') {
    system.renderMembers();
  } else if (sectionId === 'connections') {
    system.renderConnections();
  } else if (sectionId === 'bounty') {
    system.renderBounties();
  }
  
  // Processar MathJax
  setTimeout(() => MathJax.typeset(), 100);
}

function publishTheory() {
  const title = document.getElementById('theory-title').value.trim();
  const content = document.getElementById('theory-content').value.trim();
  const tags = document.getElementById('theory-tags').value.trim();

  if (!title || !content) {
    alert('Título e conteúdo são obrigatórios.');
    return;
  }

  system.publishTheory(title, content, tags);
  
  // Limpar formulário
  document.getElementById('theory-title').value = '';
  document.getElementById('theory-content').value = '';
  document.getElementById('theory-tags').value = '';
  
  // Voltar para teorias
  showSection('theories');
}

function addReference() {
  const title = document.getElementById('ref-title').value.trim();
  const url = document.getElementById('ref-url').value.trim();
  const description = document.getElementById('ref-description').value.trim();

  if (!title) {
    alert('Título é obrigatório.');
    return;
  }

  system.addReference(title, url, description);
  
  // Limpar formulário
  document.getElementById('ref-title').value = '';
  document.getElementById('ref-url').value = '';
  document.getElementById('ref-description').value = '';
}

function openProfileEditor() {
  const modal = document.getElementById('profile-modal');
  if (!modal) return;

  document.getElementById('edit-username').value = system.currentUser.username;
  document.getElementById('edit-avatar').value = system.currentUser.avatar || '';
  document.getElementById('edit-bio').value = system.currentUser.bio || '';
  document.getElementById('edit-interests').value = system.currentUser.interests?.join(', ') || '';

  modal.classList.remove('hidden');
}

function closeProfileEditor() {
  document.getElementById('profile-modal').classList.add('hidden');
}

function saveProfile() {
  system.saveProfile();
}

function sendChatMessage() {
  system.sendChatMessage();
}

function searchMembers() {
  system.searchMembers();
}

function submitBountySolution(bountyId) {
  const solution = prompt('Descreva sua solução para este desafio:');
  if (solution) {
    alert('Solução submetida para análise do Núcleo.');
    system.logActivity(`${system.currentUser.username} submeteu uma solução para um desafio`, 'bounty');
  }
}

// ===============================
// EVENT LISTENERS
// ===============================
document.addEventListener('keypress', (e) => {
  if (e.key === 'Enter' && e.target.id === 'chat-input') {
    sendChatMessage();
  }
});

// ===============================
// INICIALIZAÇÃO FINAL
// ===============================
window.onload = () => {
  // Garantir que MathJax seja processado em novas renderizações
  const originalTypeset = MathJax.typeset;
  MathJax.typeset = function() {
    if (originalTypeset) originalTypeset.call(MathJax);
  };
};
</script>
</body>
</html>
