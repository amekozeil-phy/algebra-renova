<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Renova</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <style>
    * { box-sizing: border-box; font-family: Arial, sans-serif; }

    body {
      margin: 0;
      background: #0b0b10;
      color: #eaeaea;
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .auth-container {
      width: 100%;
      max-width: 420px;
      padding: 24px;
      background: #111118;
      border: 1px solid #333;
    }

    h1 {
      margin-top: 0;
      text-align: center;
    }

    input {
      width: 100%;
      padding: 10px;
      margin-bottom: 10px;
      background: #0b0b10;
      color: #eaeaea;
      border: 1px solid #333;
    }

    button {
      width: 100%;
      padding: 10px;
      background: #1b1b2e;
      color: #eaeaea;
      border: 1px solid #444;
      cursor: pointer;
      margin-bottom: 6px;
    }

    button:hover {
      background: #26264a;
    }

    .hidden { display: none; }

    .info {
      font-size: 12px;
      opacity: 0.7;
      text-align: center;
      margin-top: 8px;
    }
  </style>
</head>

<body>

<div class="auth-container" id="authBox">
  <h1>Renova</h1>

  <input id="username" placeholder="Usu√°rio">
  <input id="password" type="password" placeholder="Senha local">
  <input id="masterKey" placeholder="MASTER_KEY (opcional)">

  <button onclick="login()">Login</button>
  <button onclick="register()">Criar Conta</button>

  <div class="info">
    Sess√£o local ¬∑ Projeto em desenvolvimento
  </div>
</div>

<div class="auth-container hidden" id="loggedBox">
  <h1 id="welcome"></h1>
  <p id="roleInfo"></p>
  <button onclick="logout()">Logout</button>
</div>

<script>
const MASTER_KEY = "Renova, O Non Trad";

let authState = JSON.parse(localStorage.getItem("renova_auth")) || {
  users: {}
};

function saveAuth() {
  localStorage.setItem("renova_auth", JSON.stringify(authState));
}

function currentUser() {
  return localStorage.getItem("renova_user");
}

function register() {
  const u = username.value.trim();
  const p = password.value;
  const k = masterKey.value;

  if (!u || !p) return;
  if (authState.users[u]) return;

  authState.users[u] = {
    pass: p,
    nuclear: k === MASTER_KEY,
    created: Date.now()
  };

  saveAuth();
  localStorage.setItem("renova_user", u);
  renderAuth();
}

function login() {
  const u = username.value.trim();
  const p = password.value;

  if (!authState.users[u]) return;
  if (authState.users[u].pass !== p) return;

  localStorage.setItem("renova_user", u);
  renderAuth();
}

function logout() {
  localStorage.removeItem("renova_user");
  renderAuth();
}

function renderAuth() {
  const u = currentUser();

  authBox.classList.toggle("hidden", !!u);
  loggedBox.classList.toggle("hidden", !u);

  if (u) {
    welcome.innerText = "Bem-vinda, " + u;
    roleInfo.innerText = authState.users[u].nuclear
      ? "Acesso N√∫cleo"
      : "Usu√°ria padr√£o";
  }
}

renderAuth();

// ===============================
// DASHBOARD
// ===============================

    // ===============================
// DASHBOARD
// ===============================

const dashboard = document.createElement("div");
dashboard.id = "dashboard";
dashboard.className = "hidden";
dashboard.style.width = "100%";
dashboard.style.minHeight = "100vh";
dashboard.style.background = "#0b0b10";
dashboard.style.color = "#eaeaea";
dashboard.style.padding = "20px";

document.body.appendChild(dashboard);

function renderDashboard() {
  const u = currentUser();
  if (!u) return;

  dashboard.innerHTML = "";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";
  header.style.marginBottom = "20px";

  const title = document.createElement("h2");
  title.innerText = "Dashboard";

  const role = document.createElement("span");
  role.style.fontSize = "12px";
  role.style.opacity = "0.7";
  role.innerText = authState.users[u].nuclear
    ? "N√∫cleo"
    : "Usu√°ria";

  header.appendChild(title);
  header.appendChild(role);

  const nav = document.createElement("div");
  nav.style.display = "grid";
  nav.style.gridTemplateColumns = "repeat(auto-fit, minmax(160px, 1fr))";
  nav.style.gap = "12px";
  nav.style.marginBottom = "24px";

  const sections = [
    { id: "theories", label: "Teorias" },
    { id: "groups", label: "Grupos" },
    { id: "forum", label: "F√≥rum" },
    { id: "chat", label: "Chat" },
    { id: "files", label: "Arquivos" },
    { id: "profile", label: "Perfil" }
  ];

  sections.forEach(sec => {
    const btn = document.createElement("button");
    btn.innerText = sec.label;
    btn.style.padding = "14px";
    btn.style.background = "#111118";
    btn.style.border = "1px solid #333";
    btn.style.cursor = "pointer";
    btn.onclick = () => openSection(sec.id);
    nav.appendChild(btn);
  });

  const content = document.createElement("div");
  content.id = "dashboardContent";
  content.style.border = "1px solid #333";
  content.style.padding = "20px";
  content.style.minHeight = "300px";
  content.innerText = "Selecione uma √°rea.";

  dashboard.appendChild(header);
  dashboard.appendChild(nav);
  dashboard.appendChild(content);

  authBox.classList.add("hidden");
  loggedBox.classList.add("hidden");
  dashboard.classList.remove("hidden");
}

function openSection(sectionId) {
  const content = document.getElementById("dashboardContent");
  if (!content) return;

  if (sectionId === "theories") {
    content.innerHTML = "<h3>Teorias</h3>";
    const list = document.createElement("ul");

    Object.keys(authState.users).forEach(user => {
      const li = document.createElement("li");
      li.innerText = "Espa√ßo te√≥rico de " + user;
      list.appendChild(li);
    });

    content.appendChild(list);
  }

  if (sectionId === "groups") {
    content.innerHTML = "<h3>Grupos</h3>";
    const p = document.createElement("p");
    p.innerText = "Cria√ß√£o e participa√ß√£o em grupos fechados.";
    content.appendChild(p);
  }

  if (sectionId === "forum") {
    content.innerHTML = "<h3>F√≥rum</h3>";
    const p = document.createElement("p");
    p.innerText = "Discuss√µes organizadas por t√≥picos.";
    content.appendChild(p);
  }

  if (sectionId === "chat") {
    content.innerHTML = "<h3>Chat</h3>";
    const box = document.createElement("div");
    box.style.border = "1px solid #444";
    box.style.height = "200px";
    box.style.marginBottom = "10px";
    content.appendChild(box);

    const input = document.createElement("input");
    input.placeholder = "Mensagem";
    content.appendChild(input);
  }

  if (sectionId === "files") {
    content.innerHTML = "<h3>Arquivos</h3>";
    const p = document.createElement("p");
    p.innerText = "Upload e organiza√ß√£o de arquivos cient√≠ficos.";
    content.appendChild(p);
  }

  if (sectionId === "profile") {
    const u = currentUser();
    content.innerHTML = "<h3>Perfil</h3>";
    const info = document.createElement("pre");
    info.innerText = JSON.stringify(authState.users[u], null, 2);
    content.appendChild(info);
  }
}

function route() {
  if (currentUser()) {
    renderDashboard();
  } else {
    dashboard.classList.add("hidden");
    authBox.classList.remove("hidden");
  }
}

route();

// ===============================
// √ÅREA DE TEORIAS
// ===============================

    // ===============================
// √ÅREA DE TEORIAS
// ===============================

const theoriesState = {
  theories: JSON.parse(localStorage.getItem("theories") || "[]")
};

function saveTheories() {
  localStorage.setItem("theories", JSON.stringify(theoriesState.theories));
}

function renderTheories() {
  const content = document.getElementById("dashboardContent");
  if (!content) return;

  content.innerHTML = "";

  const title = document.createElement("h3");
  title.innerText = "Teorias";
  content.appendChild(title);

  const desc = document.createElement("p");
  desc.innerText =
    "Espa√ßo para cria√ß√£o, leitura e avalia√ß√£o de teorias matem√°ticas e f√≠sicas.";
  content.appendChild(desc);

  const createBox = document.createElement("div");
  createBox.style.border = "1px solid #333";
  createBox.style.padding = "15px";
  createBox.style.marginBottom = "20px";

  const createTitle = document.createElement("h4");
  createTitle.innerText = "Nova Teoria";
  createBox.appendChild(createTitle);

  const inputTitle = document.createElement("input");
  inputTitle.placeholder = "T√≠tulo da teoria";
  inputTitle.style.width = "100%";
  inputTitle.style.marginBottom = "8px";
  createBox.appendChild(inputTitle);

  const inputArea = document.createElement("textarea");
  inputArea.placeholder =
    "Escreva a teoria aqui (LaTeX suportado via MathJax)";
  inputArea.style.width = "100%";
  inputArea.style.height = "120px";
  createBox.appendChild(inputArea);

  const submit = document.createElement("button");
  submit.innerText = "Criar teoria";
  submit.style.marginTop = "10px";
  submit.onclick = () => {
    if (!inputTitle.value || !inputArea.value) return;

    theoriesState.theories.push({
      id: Date.now(),
      author: currentUser(),
      title: inputTitle.value,
      body: inputArea.value,
      approved: false,
      createdAt: new Date().toISOString()
    });

    saveTheories();
    renderTheories();
  };

  createBox.appendChild(submit);
  content.appendChild(createBox);

  const listTitle = document.createElement("h4");
  listTitle.innerText = "Teorias publicadas";
  content.appendChild(listTitle);

  const list = document.createElement("div");
  list.style.display = "flex";
  list.style.flexDirection = "column";
  list.style.gap = "12px";

  theoriesState.theories.forEach(t => {
    const card = document.createElement("div");
    card.style.border = "1px solid #444";
    card.style.padding = "12px";

    const h = document.createElement("h5");
    h.innerText = t.title;
    card.appendChild(h);

    const meta = document.createElement("div");
    meta.style.fontSize = "12px";
    meta.style.opacity = "0.7";
    meta.innerText =
      "Autor: " +
      t.author +
      " | Status: " +
      (t.approved ? "Aprovada" : "Pendente");
    card.appendChild(meta);

    const body = document.createElement("div");
    body.innerHTML = t.body;
    body.style.marginTop = "8px";
    card.appendChild(body);

    if (authState.users[currentUser()]?.nuclear && !t.approved) {
      const approveBtn = document.createElement("button");
      approveBtn.innerText = "Aprovar (N√∫cleo)";
      approveBtn.style.marginTop = "10px";
      approveBtn.onclick = () => {
        t.approved = true;
        saveTheories();
        renderTheories();
      };
      card.appendChild(approveBtn);
    }

    list.appendChild(card);
  });

  content.appendChild(list);

  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

// ===============================
// INTEGRA√á√ÉO COM DASHBOARD
// ===============================

const originalOpenSection = openSection;
openSection = function (sectionId) {
  if (sectionId === "theories") {
    renderTheories();
    return;
  }
  originalOpenSection(sectionId);
};

// ===============================
// BASE DE GRUPOS (INICIALIZA√á√ÉO)
// ===============================

const groupsState = {
  groups: JSON.parse(localStorage.getItem("groups") || "[]")
};

function saveGroups() {
  localStorage.setItem("groups", JSON.stringify(groupsState.groups));
}

// ===============================
// FUN√á√ïES DE GRUPO (EM CONSTRU√á√ÉO)
// ===============================

function renderGroups() {
  const content = document.getElementById("dashboardContent");
  if (!content) return;

  content.innerHTML = "";

  const title = document.createElement("h3");
  title.innerText = "Grupos";
  content.appendChild(title);

  const info = document.createElement("p");
  info.innerText =
    "Grupos de estudo e pesquisa. Cada usu√°ria pode participar de m√∫ltiplos grupos.";
  content.appendChild(info);

  const create = document.createElement("div");
  create.style.border = "1px solid #333";
  create.style.padding = "12px";
  create.style.marginBottom = "20px";

  const nameInput = document.createElement("input");
  nameInput.placeholder = "Nome do grupo";
  nameInput.style.width = "100%";
  create.appendChild(nameInput);

  const createBtn = document.createElement("button");
  createBtn.innerText = "Criar grupo";
  createBtn.style.marginTop = "8px";
  createBtn.onclick = () => {
    if (!nameInput.value) return;

    groupsState.groups.push({
      id: Date.now(),
      name: nameInput.value,
      owner: currentUser(),
      members: [currentUser()],
      createdAt: new Date().toISOString()
    });

    saveGroups();
    renderGroups();
  };

  create.appendChild(createBtn);
  content.appendChild(create);

  const list = document.createElement("div");
  list.style.display = "flex";
  list.style.flexDirection = "column";
  list.style.gap = "10px";

  groupsState.groups.forEach(g => {
    const box = document.createElement("div");
    box.style.border = "1px solid #444";
    box.style.padding = "10px";

    const h = document.createElement("h4");
    h.innerText = g.name;
    box.appendChild(h);

    const m = document.createElement("div");
    m.style.fontSize = "12px";
    m.style.opacity = "0.7";
    m.innerText = "Membros: " + g.members.length;
    box.appendChild(m);

    if (!g.members.includes(currentUser())) {
      const join = document.createElement("button");
      join.innerText = "Entrar";
      join.onclick = () => {
        g.members.push(currentUser());
        saveGroups();
        renderGroups();
      };
      box.appendChild(join);
    } else {
      const leave = document.createElement("button");
      leave.innerText = "Sair";
      leave.onclick = () => {
        g.members = g.members.filter(u => u !== currentUser());
        saveGroups();
        renderGroups();
      };
      box.appendChild(leave);
    }

    list.appendChild(box);
  });

  content.appendChild(list);
}

// ===============================
// PR√ìXIMA √ÅREA A IMPLEMENTAR
// ===============================
// F√≥rum (t√≥picos, respostas, persist√™ncia, modera√ß√£o N√∫cleo)
// Chat geral com canais
// Chat privado
// Sistema de contatos
// Perfil detalhado
// Administra√ß√£o N√∫cleo

    // ===============================
// F√ìRUM ‚Äî SISTEMA COMPLETO
// ===============================

// Estado global do f√≥rum
const forumState = {
  categories: JSON.parse(localStorage.getItem("forum_categories") || "[]"),
  topics: JSON.parse(localStorage.getItem("forum_topics") || "[]"),
  replies: JSON.parse(localStorage.getItem("forum_replies") || "[]"),
  views: JSON.parse(localStorage.getItem("forum_views") || "{}"),
  pinned: JSON.parse(localStorage.getItem("forum_pinned") || "[]")
};

// Persist√™ncia
function saveForum() {
  localStorage.setItem("forum_categories", JSON.stringify(forumState.categories));
  localStorage.setItem("forum_topics", JSON.stringify(forumState.topics));
  localStorage.setItem("forum_replies", JSON.stringify(forumState.replies));
  localStorage.setItem("forum_views", JSON.stringify(forumState.views));
  localStorage.setItem("forum_pinned", JSON.stringify(forumState.pinned));
}

// Utilidades
function forumNow() {
  return new Date().toISOString();
}
function isNucleo() {
  const u = currentUser();
  return !!(u && authState.users[u]?.nuclear);
}
function incView(topicId) {
  forumState.views[topicId] = (forumState.views[topicId] || 0) + 1;
  saveForum();
}
function getReplies(topicId) {
  return forumState.replies.filter(r => r.topicId === topicId);
}

// Inicializa√ß√£o b√°sica
if (forumState.categories.length === 0) {
  forumState.categories.push(
    { id: "geral", name: "Geral", desc: "Discuss√µes abertas" },
    { id: "teorias", name: "Teorias", desc: "Debates te√≥ricos" },
    { id: "provas", name: "Provas & Contraexemplos", desc: "Rigor matem√°tico" },
    { id: "fisica", name: "F√≠sica Matem√°tica", desc: "Modelos e formalismos" }
  );
  saveForum();
}

// Render principal do f√≥rum
function renderForum() {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";

  const title = document.createElement("h3");
  title.innerText = "F√≥rum";
  header.appendChild(title);

  const newBtn = document.createElement("button");
  newBtn.innerText = "Novo T√≥pico";
  newBtn.onclick = () => renderNewTopic();
  header.appendChild(newBtn);

  content.appendChild(header);

  // Categorias
  forumState.categories.forEach(cat => {
    const box = document.createElement("div");
    box.style.border = "1px solid #333";
    box.style.marginTop = "14px";
    box.style.padding = "10px";

    const h = document.createElement("h4");
    h.innerText = cat.name;
    box.appendChild(h);

    const d = document.createElement("div");
    d.style.opacity = "0.7";
    d.style.fontSize = "12px";
    d.innerText = cat.desc;
    box.appendChild(d);

    // Lista de t√≥picos
    const list = document.createElement("div");
    list.style.marginTop = "8px";
    list.style.display = "flex";
    list.style.flexDirection = "column";
    list.style.gap = "6px";

    const topics = forumState.topics
      .filter(t => t.category === cat.id)
      .sort((a, b) => (forumState.pinned.includes(b.id) ? 1 : -1));

    topics.forEach(t => {
      const row = document.createElement("div");
      row.style.border = "1px solid #444";
      row.style.padding = "8px";
      row.style.cursor = "pointer";
      row.onclick = () => openTopic(t.id);

      const tt = document.createElement("div");
      tt.innerText = t.title + (forumState.pinned.includes(t.id) ? " üìå" : "");
      row.appendChild(tt);

      const meta = document.createElement("div");
      meta.style.fontSize = "11px";
      meta.style.opacity = "0.6";
      meta.innerText =
        "por " +
        t.author +
        " ‚Ä¢ respostas: " +
        getReplies(t.id).length +
        " ‚Ä¢ visualiza√ß√µes: " +
        (forumState.views[t.id] || 0);
      row.appendChild(meta);

      list.appendChild(row);
    });

    box.appendChild(list);
    content.appendChild(box);
  });
}

// Criar novo t√≥pico
function renderNewTopic() {
  const content = document.getElementById("dashboardContent");
  content.innerHTML = "";

  const h = document.createElement("h3");
  h.innerText = "Novo T√≥pico";
  content.appendChild(h);

  const title = document.createElement("input");
  title.placeholder = "T√≠tulo do t√≥pico";
  title.style.width = "100%";
  content.appendChild(title);

  const cat = document.createElement("select");
  forumState.categories.forEach(c => {
    const o = document.createElement("option");
    o.value = c.id;
    o.innerText = c.name;
    cat.appendChild(o);
  });
  content.appendChild(cat);

  const body = document.createElement("textarea");
  body.placeholder = "Conte√∫do (LaTeX via MathJax suportado)";
  body.style.width = "100%";
  body.style.height = "160px";
  content.appendChild(body);

  const post = document.createElement("button");
  post.innerText = "Publicar";
  post.onclick = () => {
    if (!title.value || !body.value) return;
    forumState.topics.push({
      id: Date.now().toString(),
      title: title.value,
      body: body.value,
      category: cat.value,
      author: currentUser(),
      createdAt: forumNow(),
      locked: false
    });
    saveForum();
    renderForum();
  };

  content.appendChild(post);
}

// Abrir t√≥pico
function openTopic(topicId) {
  const topic = forumState.topics.find(t => t.id === topicId);
  if (!topic) return;

  incView(topicId);

  const content = document.getElementById("dashboardContent");
  content.innerHTML = "";

  const h = document.createElement("h3");
  h.innerText = topic.title;
  content.appendChild(h);

  const meta = document.createElement("div");
  meta.style.opacity = "0.6";
  meta.style.fontSize = "12px";
  meta.innerText =
    "por " + topic.author + " ‚Ä¢ " + new Date(topic.createdAt).toLocaleString();
  content.appendChild(meta);

  const body = document.createElement("div");
  body.style.marginTop = "10px";
  body.innerHTML = topic.body;
  content.appendChild(body);

  // A√ß√µes N√∫cleo
  if (isNucleo()) {
    const admin = document.createElement("div");
    admin.style.marginTop = "10px";

    const pin = document.createElement("button");
    pin.innerText = forumState.pinned.includes(topic.id)
      ? "Desafixar"
      : "Fixar";
    pin.onclick = () => {
      if (forumState.pinned.includes(topic.id)) {
        forumState.pinned = forumState.pinned.filter(i => i !== topic.id);
      } else {
        forumState.pinned.push(topic.id);
      }
      saveForum();
      openTopic(topic.id);
    };

    const lock = document.createElement("button");
    lock.innerText = topic.locked ? "Desbloquear" : "Bloquear";
    lock.onclick = () => {
      topic.locked = !topic.locked;
      saveForum();
      openTopic(topic.id);
    };

    admin.appendChild(pin);
    admin.appendChild(lock);
    content.appendChild(admin);
  }

  // Respostas
  const rh = document.createElement("h4");
  rh.innerText = "Respostas";
  rh.style.marginTop = "20px";
  content.appendChild(rh);

  const replies = getReplies(topic.id);
  replies.forEach(r => {
    const box = document.createElement("div");
    box.style.border = "1px solid #444";
    box.style.padding = "8px";
    box.style.marginTop = "6px";

    const rm = document.createElement("div");
    rm.style.fontSize = "11px";
    rm.style.opacity = "0.6";
    rm.innerText =
      r.author + " ‚Ä¢ " + new Date(r.createdAt).toLocaleString();
    box.appendChild(rm);

    const rb = document.createElement("div");
    rb.innerHTML = r.body;
    box.appendChild(rb);

    content.appendChild(box);
  });

  // Nova resposta
  if (!topic.locked) {
    const ta = document.createElement("textarea");
    ta.placeholder = "Responder (LaTeX suportado)";
    ta.style.width = "100%";
    ta.style.height = "120px";
    ta.style.marginTop = "10px";
    content.appendChild(ta);

    const send = document.createElement("button");
    send.innerText = "Responder";
    send.onclick = () => {
      if (!ta.value) return;
      forumState.replies.push({
        id: Date.now().toString(),
        topicId: topic.id,
        author: currentUser(),
        body: ta.value,
        createdAt: forumNow()
      });
      saveForum();
      openTopic(topic.id);
    };

    content.appendChild(send);
  } else {
    const locked = document.createElement("div");
    locked.style.opacity = "0.6";
    locked.style.marginTop = "10px";
    locked.innerText = "T√≥pico bloqueado.";
    content.appendChild(locked);
  }

  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

// Integra√ß√£o com dashboard
const __openSectionForum = openSection;
openSection = function (sectionId) {
  if (sectionId === "forum") {
    renderForum();
    return;
  }
  __openSectionForum(sectionId);
};

// ===============================
// PR√ìXIMA IMPLEMENTA√á√ÉO (N√ÉO INICIADA)
// ===============================
// CHAT GERAL
// - Canais m√∫ltiplos
// - Mensagens persistentes
// - Suporte MathJax inline e display
// - Indicador de usu√°rios online
// - Hist√≥rico por canal
// - Notifica√ß√µes locais

    // ===============================
// CHAT GERAL ‚Äî CANAIS + MATHJAX
// ===============================

// Estado do chat geral
const chatState = {
  channels: JSON.parse(localStorage.getItem("chat_channels") || "[]"),
  messages: JSON.parse(localStorage.getItem("chat_messages") || "{}"),
  online: JSON.parse(localStorage.getItem("chat_online") || "{}"),
  unread: JSON.parse(localStorage.getItem("chat_unread") || "{}")
};

// Persist√™ncia
function saveChat() {
  localStorage.setItem("chat_channels", JSON.stringify(chatState.channels));
  localStorage.setItem("chat_messages", JSON.stringify(chatState.messages));
  localStorage.setItem("chat_online", JSON.stringify(chatState.online));
  localStorage.setItem("chat_unread", JSON.stringify(chatState.unread));
}

// Inicializa√ß√£o padr√£o
if (chatState.channels.length === 0) {
  chatState.channels.push(
    { id: "geral", name: "Geral" },
    { id: "math", name: "Matem√°tica" },
    { id: "physics", name: "F√≠sica" },
    { id: "nucleo", name: "N√∫cleo" }
  );
  saveChat();
}

// Marcar usu√°rio online
function setOnline() {
  const u = currentUser();
  if (!u) return;
  chatState.online[u] = Date.now();
  saveChat();
}
setOnline();
setInterval(setOnline, 15000);

// Render principal do chat
function renderChat(channelId = "geral") {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const wrapper = document.createElement("div");
  wrapper.style.display = "grid";
  wrapper.style.gridTemplateColumns = "200px 1fr";
  wrapper.style.height = "70vh";
  wrapper.style.gap = "10px";

  // Sidebar de canais
  const sidebar = document.createElement("div");
  sidebar.style.border = "1px solid #333";
  sidebar.style.padding = "8px";

  chatState.channels.forEach(ch => {
    if (ch.id === "nucleo" && !isNucleo()) return;

    const btn = document.createElement("div");
    btn.style.padding = "6px";
    btn.style.cursor = "pointer";
    btn.style.borderBottom = "1px solid #222";
    btn.innerText =
      ch.name +
      (chatState.unread[ch.id]?.includes(currentUser()) ? " ‚óè" : "");

    btn.onclick = () => {
      chatState.unread[ch.id] = [];
      saveChat();
      renderChat(ch.id);
    };

    sidebar.appendChild(btn);
  });

  // √Årea principal
  const main = document.createElement("div");
  main.style.display = "flex";
  main.style.flexDirection = "column";
  main.style.border = "1px solid #333";

  const header = document.createElement("div");
  header.style.padding = "6px";
  header.style.borderBottom = "1px solid #222";
  header.innerText =
    "Canal: " +
    chatState.channels.find(c => c.id === channelId)?.name;
  main.appendChild(header);

  const messagesBox = document.createElement("div");
  messagesBox.style.flex = "1";
  messagesBox.style.overflowY = "auto";
  messagesBox.style.padding = "8px";

  const msgs = chatState.messages[channelId] || [];
  msgs.forEach(m => {
    const line = document.createElement("div");
    line.style.marginBottom = "6px";

    const meta = document.createElement("span");
    meta.style.opacity = "0.6";
    meta.style.fontSize = "11px";
    meta.innerText =
      m.author +
      " ‚Ä¢ " +
      new Date(m.createdAt).toLocaleTimeString();

    const body = document.createElement("div");
    body.innerHTML = m.body;

    line.appendChild(meta);
    line.appendChild(body);
    messagesBox.appendChild(line);
  });

  main.appendChild(messagesBox);

  // Input
  const inputBox = document.createElement("div");
  inputBox.style.display = "flex";
  inputBox.style.borderTop = "1px solid #222";

  const input = document.createElement("textarea");
  input.placeholder = "Mensagem (LaTeX com MathJax)";
  input.style.flex = "1";
  input.style.height = "60px";

  const send = document.createElement("button");
  send.innerText = "Enviar";
  send.onclick = () => {
    if (!input.value) return;

    if (!chatState.messages[channelId])
      chatState.messages[channelId] = [];

    chatState.messages[channelId].push({
      id: Date.now().toString(),
      author: currentUser(),
      body: input.value,
      createdAt: new Date().toISOString()
    });

    // Marcar n√£o lidas nos outros usu√°rios
    Object.keys(authState.users).forEach(u => {
      if (u !== currentUser()) {
        chatState.unread[channelId] =
          chatState.unread[channelId] || [];
        if (!chatState.unread[channelId].includes(u))
          chatState.unread[channelId].push(u);
      }
    });

    saveChat();
    input.value = "";
    renderChat(channelId);
  };

  inputBox.appendChild(input);
  inputBox.appendChild(send);
  main.appendChild(inputBox);

  wrapper.appendChild(sidebar);
  wrapper.appendChild(main);
  content.appendChild(wrapper);

  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

// Integra√ß√£o com dashboard
const __openSectionChat = openSection;
openSection = function (sectionId) {
  if (sectionId === "chat") {
    renderChat();
    return;
  }
  __openSectionChat(sectionId);
};

// ===============================
// PR√ìXIMO BLOCO A CONTINUAR
// ===============================
// CHAT PRIVADO
// - Conversas 1-a-1
// - Mensagens n√£o lidas
// - Indicador online/offline
// - Hist√≥rico persistente
// - Integra√ß√£o com contatos

    // ===============================
// CHAT PRIVADO ‚Äî 1‚Üî1, N√ÉO LIDAS, ONLINE/OFFLINE
// ===============================

// Estado do chat privado
const privateChatState = {
  threads: JSON.parse(localStorage.getItem("pm_threads") || "{}"),
  unread: JSON.parse(localStorage.getItem("pm_unread") || "{}"),
  typing: JSON.parse(localStorage.getItem("pm_typing") || "{}")
};

// Persist√™ncia
function savePM() {
  localStorage.setItem("pm_threads", JSON.stringify(privateChatState.threads));
  localStorage.setItem("pm_unread", JSON.stringify(privateChatState.unread));
  localStorage.setItem("pm_typing", JSON.stringify(privateChatState.typing));
}

// Utilidades
function pmKey(a, b) {
  return [a, b].sort().join("::");
}
function ensureThread(a, b) {
  const k = pmKey(a, b);
  if (!privateChatState.threads[k]) {
    privateChatState.threads[k] = [];
  }
  return k;
}
function markUnread(user, key) {
  privateChatState.unread[key] = privateChatState.unread[key] || [];
  if (!privateChatState.unread[key].includes(user)) {
    privateChatState.unread[key].push(user);
  }
}
function clearUnreadForMe(key) {
  const me = currentUser();
  if (!me) return;
  privateChatState.unread[key] = (privateChatState.unread[key] || []).filter(u => u !== me);
}
function isUserOnline(u) {
  const t = chatState.online[u];
  if (!t) return false;
  return (Date.now() - t) < 30000; // 30s
}

// Render lista de conversas
function renderPMList(onSelect) {
  const box = document.createElement("div");
  box.style.border = "1px solid #333";
  box.style.padding = "8px";
  box.style.overflowY = "auto";

  const me = currentUser();
  const keys = Object.keys(privateChatState.threads)
    .filter(k => k.includes(me))
    .sort((a, b) => {
      const la = privateChatState.threads[a].slice(-1)[0]?.createdAt || 0;
      const lb = privateChatState.threads[b].slice(-1)[0]?.createdAt || 0;
      return lb.localeCompare ? lb.localeCompare(la) : (lb > la ? 1 : -1);
    });

  keys.forEach(k => {
    const other = k.split("::").find(u => u !== me);
    const row = document.createElement("div");
    row.style.padding = "6px";
    row.style.cursor = "pointer";
    row.style.borderBottom = "1px solid #222";

    const name = document.createElement("div");
    name.innerText = other + (isUserOnline(other) ? " ‚Ä¢ online" : " ‚Ä¢ offline");
    row.appendChild(name);

    const meta = document.createElement("div");
    meta.style.fontSize = "11px";
    meta.style.opacity = "0.6";
    const unread = (privateChatState.unread[k] || []).includes(me);
    meta.innerText = unread ? "mensagens n√£o lidas" : "";
    row.appendChild(meta);

    row.onclick = () => onSelect(other);
    box.appendChild(row);
  });

  return box;
}

// Render conversa
function renderPMThread(otherUser) {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const me = currentUser();
  const key = ensureThread(me, otherUser);
  clearUnreadForMe(key);
  savePM();

  const wrapper = document.createElement("div");
  wrapper.style.display = "grid";
  wrapper.style.gridTemplateColumns = "240px 1fr";
  wrapper.style.gap = "10px";
  wrapper.style.height = "70vh";

  // Sidebar (conversas)
  const sidebar = renderPMList(renderPMThread);

  // Main
  const main = document.createElement("div");
  main.style.display = "flex";
  main.style.flexDirection = "column";
  main.style.border = "1px solid #333";

  const header = document.createElement("div");
  header.style.padding = "6px";
  header.style.borderBottom = "1px solid #222";
  header.innerText = "Conversa com " + otherUser;
  main.appendChild(header);

  const msgsBox = document.createElement("div");
  msgsBox.style.flex = "1";
  msgsBox.style.overflowY = "auto";
  msgsBox.style.padding = "8px";

  privateChatState.threads[key].forEach(m => {
    const line = document.createElement("div");
    line.style.marginBottom = "8px";

    const meta = document.createElement("div");
    meta.style.fontSize = "11px";
    meta.style.opacity = "0.6";
    meta.innerText =
      (m.author === me ? "Voc√™" : m.author) +
      " ‚Ä¢ " +
      new Date(m.createdAt).toLocaleTimeString();
    line.appendChild(meta);

    const body = document.createElement("div");
    body.innerHTML = m.body;
    line.appendChild(body);

    msgsBox.appendChild(line);
  });

  main.appendChild(msgsBox);

  // Indicador digitando
  const typing = document.createElement("div");
  typing.style.fontSize = "11px";
  typing.style.opacity = "0.6";
  typing.style.padding = "4px 8px";
  const tk = pmKey(me, otherUser);
  typing.innerText = privateChatState.typing[tk] === otherUser ? "digitando..." : "";
  main.appendChild(typing);

  // Input
  const inputBox = document.createElement("div");
  inputBox.style.display = "flex";
  inputBox.style.borderTop = "1px solid #222";

  const input = document.createElement("textarea");
  input.placeholder = "Mensagem privada (LaTeX via MathJax)";
  input.style.flex = "1";
  input.style.height = "60px";

  input.oninput = () => {
    privateChatState.typing[tk] = me;
    savePM();
    setTimeout(() => {
      if (privateChatState.typing[tk] === me) {
        delete privateChatState.typing[tk];
        savePM();
      }
    }, 1200);
  };

  const send = document.createElement("button");
  send.innerText = "Enviar";
  send.onclick = () => {
    if (!input.value) return;

    privateChatState.threads[key].push({
      id: Date.now().toString(),
      author: me,
      body: input.value,
      createdAt: new Date().toISOString()
    });

    markUnread(otherUser, key);
    delete privateChatState.typing[tk];
    savePM();

    input.value = "";
    renderPMThread(otherUser);
  };

  inputBox.appendChild(input);
  inputBox.appendChild(send);
  main.appendChild(inputBox);

  wrapper.appendChild(sidebar);
  wrapper.appendChild(main);
  content.appendChild(wrapper);

  if (window.MathJax) {
    MathJax.typesetPromise();
  }
}

// Entrada do chat privado (lista inicial)
function renderPMHome() {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const h = document.createElement("h3");
  h.innerText = "Chat Privado";
  content.appendChild(h);

  const p = document.createElement("p");
  p.innerText = "Selecione uma conversa ou inicie uma nova.";
  content.appendChild(p);

  // Iniciar nova conversa
  const start = document.createElement("div");
  start.style.border = "1px solid #333";
  start.style.padding = "10px";
  start.style.marginBottom = "10px";

  const sel = document.createElement("select");
  Object.keys(authState.users)
    .filter(u => u !== currentUser())
    .forEach(u => {
      const o = document.createElement("option");
      o.value = u;
      o.innerText = u;
      sel.appendChild(o);
    });

  const go = document.createElement("button");
  go.innerText = "Abrir conversa";
  go.onclick = () => renderPMThread(sel.value);

  start.appendChild(sel);
  start.appendChild(go);
  content.appendChild(start);

  // Lista de conversas
  content.appendChild(renderPMList(renderPMThread));
}

// Integra√ß√£o com dashboard
const __openSectionPM = openSection;
openSection = function (sectionId) {
  if (sectionId === "pm") {
    renderPMHome();
    return;
  }
  __openSectionPM(sectionId);
};

// ===============================
// PR√ìXIMO BLOCO (A CONTINUAR)
// ===============================
// CONTATOS
// - Adicionar / remover
// - Status online/offline
// - Integra√ß√£o com chat privado
// - Busca e filtros

    // ===============================
// CONTATOS ‚Äî SISTEMA COMPLETO
// ===============================

// Estado de contatos
const contactsState = {
  contacts: JSON.parse(localStorage.getItem("contacts") || "{}"), // { user: [contatos] }
  requests: JSON.parse(localStorage.getItem("contact_requests") || "{}") // { user: [pendentes] }
};

// Persist√™ncia
function saveContacts() {
  localStorage.setItem("contacts", JSON.stringify(contactsState.contacts));
  localStorage.setItem("contact_requests", JSON.stringify(contactsState.requests));
}

// Utilidades
function ensureUserContacts(u) {
  if (!contactsState.contacts[u]) contactsState.contacts[u] = [];
  if (!contactsState.requests[u]) contactsState.requests[u] = [];
}
function isContact(me, other) {
  ensureUserContacts(me);
  return contactsState.contacts[me].includes(other);
}
function isPending(me, other) {
  ensureUserContacts(me);
  return contactsState.requests[me].includes(other);
}

// Enviar solicita√ß√£o
function sendContactRequest(to) {
  const me = currentUser();
  if (!me || me === to) return;
  ensureUserContacts(to);
  if (contactsState.contacts[to]?.includes(me)) return;
  if (!contactsState.requests[to].includes(me)) {
    contactsState.requests[to].push(me);
  }
  saveContacts();
}

// Aceitar solicita√ß√£o
function acceptContact(from) {
  const me = currentUser();
  ensureUserContacts(me);
  ensureUserContacts(from);

  contactsState.requests[me] = contactsState.requests[me].filter(u => u !== from);
  if (!contactsState.contacts[me].includes(from)) {
    contactsState.contacts[me].push(from);
  }
  if (!contactsState.contacts[from].includes(me)) {
    contactsState.contacts[from].push(me);
  }
  saveContacts();
}

// Remover contato
function removeContact(other) {
  const me = currentUser();
  ensureUserContacts(me);
  ensureUserContacts(other);

  contactsState.contacts[me] = contactsState.contacts[me].filter(u => u !== other);
  contactsState.contacts[other] = contactsState.contacts[other].filter(u => u !== me);
  saveContacts();
}

// Renderiza√ß√£o principal
function renderContacts() {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const me = currentUser();
  ensureUserContacts(me);

  const h = document.createElement("h3");
  h.innerText = "Contatos";
  content.appendChild(h);

  // Buscar membros
  const searchBox = document.createElement("div");
  searchBox.style.border = "1px solid #333";
  searchBox.style.padding = "10px";
  searchBox.style.marginBottom = "14px";

  const searchInput = document.createElement("input");
  searchInput.placeholder = "Buscar membros";
  searchInput.style.width = "100%";
  searchBox.appendChild(searchInput);

  const results = document.createElement("div");
  results.style.marginTop = "10px";
  results.style.display = "flex";
  results.style.flexDirection = "column";
  results.style.gap = "6px";

  searchInput.oninput = () => {
    results.innerHTML = "";
    const q = searchInput.value.toLowerCase();
    if (!q) return;

    Object.keys(authState.users)
      .filter(u => u !== me && u.toLowerCase().includes(q))
      .forEach(u => {
        const row = document.createElement("div");
        row.style.border = "1px solid #444";
        row.style.padding = "6px";

        const name = document.createElement("span");
        name.innerText = u + (isUserOnline(u) ? " ‚Ä¢ online" : " ‚Ä¢ offline");
        row.appendChild(name);

        if (isContact(me, u)) {
          const btn = document.createElement("button");
          btn.innerText = "Remover";
          btn.onclick = () => {
            removeContact(u);
            renderContacts();
          };
          row.appendChild(btn);
        } else if (isPending(u, me)) {
          const btn = document.createElement("button");
          btn.innerText = "Solicita√ß√£o enviada";
          btn.disabled = true;
          row.appendChild(btn);
        } else {
          const btn = document.createElement("button");
          btn.innerText = "Adicionar";
          btn.onclick = () => {
            sendContactRequest(u);
            renderContacts();
          };
          row.appendChild(btn);
        }

        results.appendChild(row);
      });
  };

  searchBox.appendChild(results);
  content.appendChild(searchBox);

  // Solicita√ß√µes recebidas
  const reqBox = document.createElement("div");
  reqBox.style.border = "1px solid #333";
  reqBox.style.padding = "10px";
  reqBox.style.marginBottom = "14px";

  const rh = document.createElement("h4");
  rh.innerText = "Solicita√ß√µes pendentes";
  reqBox.appendChild(rh);

  if (contactsState.requests[me].length === 0) {
    const empty = document.createElement("div");
    empty.style.opacity = "0.6";
    empty.innerText = "Nenhuma solicita√ß√£o.";
    reqBox.appendChild(empty);
  } else {
    contactsState.requests[me].forEach(u => {
      const row = document.createElement("div");
      row.style.display = "flex";
      row.style.justifyContent = "space-between";
      row.style.border = "1px solid #444";
      row.style.padding = "6px";

      const name = document.createElement("span");
      name.innerText = u;
      row.appendChild(name);

      const accept = document.createElement("button");
      accept.innerText = "Aceitar";
      accept.onclick = () => {
        acceptContact(u);
        renderContacts();
      };

      row.appendChild(accept);
      reqBox.appendChild(row);
    });
  }

  content.appendChild(reqBox);

  // Lista de contatos
  const listBox = document.createElement("div");
  listBox.style.border = "1px solid #333";
  listBox.style.padding = "10px";

  const lh = document.createElement("h4");
  lh.innerText = "Meus contatos";
  listBox.appendChild(lh);

  if (contactsState.contacts[me].length === 0) {
    const empty = document.createElement("div");
    empty.style.opacity = "0.6";
    empty.innerText = "Nenhum contato ainda.";
    listBox.appendChild(empty);
  } else {
    contactsState.contacts[me].forEach(u => {
      const row = document.createElement("div");
      row.style.border = "1px solid #444";
      row.style.padding = "6px";
      row.style.display = "flex";
      row.style.justifyContent = "space-between";

      const name = document.createElement("span");
      name.innerText = u + (isUserOnline(u) ? " ‚Ä¢ online" : " ‚Ä¢ offline");
      row.appendChild(name);

      const actions = document.createElement("div");

      const chatBtn = document.createElement("button");
      chatBtn.innerText = "Mensagem";
      chatBtn.onclick = () => renderPMThread(u);

      const remBtn = document.createElement("button");
      remBtn.innerText = "Remover";
      remBtn.onclick = () => {
        removeContact(u);
        renderContacts();
      };

      actions.appendChild(chatBtn);
      actions.appendChild(remBtn);
      row.appendChild(actions);

      listBox.appendChild(row);
    });
  }

  content.appendChild(listBox);
}

// Integra√ß√£o com dashboard
const __openSectionContacts = openSection;
openSection = function (sectionId) {
  if (sectionId === "contacts") {
    renderContacts();
    return;
  }
  __openSectionContacts(sectionId);
};

// ===============================
// PR√ìXIMO BLOCO (A CONTINUAR)
// ===============================
// PERFIL
// - Editar informa√ß√µes
// - Estat√≠sticas pessoais
// - Atividade recente
// - Integra√ß√£o com teorias, f√≥rum e chats

    // ===============================
// PERFIL ‚Äî SISTEMA COMPLETO E DETALHADO
// ===============================

// Estado do perfil
const profileState = {
  profiles: JSON.parse(localStorage.getItem("profiles") || "{}"), // { user: { bio, area, links, stats } }
  activity: JSON.parse(localStorage.getItem("profile_activity") || "{}") // { user: [logs] }
};

// Persist√™ncia
function saveProfiles() {
  localStorage.setItem("profiles", JSON.stringify(profileState.profiles));
  localStorage.setItem("profile_activity", JSON.stringify(profileState.activity));
}

// Utilidades
function ensureProfile(u) {
  if (!profileState.profiles[u]) {
    profileState.profiles[u] = {
      bio: "",
      area: "",
      links: "",
      createdAt: new Date().toISOString(),
      stats: {
        theories: 0,
        forumTopics: 0,
        forumReplies: 0,
        chatMessages: 0
      }
    };
  }
  if (!profileState.activity[u]) profileState.activity[u] = [];
}

function logActivity(u, text) {
  ensureProfile(u);
  profileState.activity[u].unshift({
    text,
    at: new Date().toISOString()
  });
  profileState.activity[u] = profileState.activity[u].slice(0, 20);
  saveProfiles();
}

// Atualizar estat√≠sticas automaticamente
function recomputeStats(u) {
  ensureProfile(u);
  profileState.profiles[u].stats.theories =
    (theoriesState?.theories || []).filter(t => t.author === u).length;

  profileState.profiles[u].stats.forumTopics =
    forumState.topics.filter(t => t.author === u).length;

  profileState.profiles[u].stats.forumReplies =
    forumState.replies.filter(r => r.author === u).length;

  let chatCount = 0;
  Object.values(chatState.messages).forEach(arr => {
    arr.forEach(m => {
      if (m.author === u) chatCount++;
    });
  });
  profileState.profiles[u].stats.chatMessages = chatCount;

  saveProfiles();
}

// Render perfil
function renderProfile(viewUser = null) {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const me = currentUser();
  const u = viewUser || me;
  ensureProfile(u);
  recomputeStats(u);

  const profile = profileState.profiles[u];

  const header = document.createElement("div");
  header.style.display = "flex";
  header.style.justifyContent = "space-between";
  header.style.alignItems = "center";

  const h = document.createElement("h3");
  h.innerText = "Perfil ‚Äî " + u;
  header.appendChild(h);

  const role = document.createElement("span");
  role.style.opacity = "0.6";
  role.style.fontSize = "12px";
  role.innerText = authState.users[u]?.nuclear ? "N√∫cleo" : "Membro";
  header.appendChild(role);

  content.appendChild(header);

  // Informa√ß√µes b√°sicas
  const info = document.createElement("div");
  info.style.border = "1px solid #333";
  info.style.padding = "12px";
  info.style.marginTop = "12px";

  const bio = document.createElement("textarea");
  bio.placeholder = "Bio";
  bio.value = profile.bio;
  bio.style.width = "100%";
  bio.disabled = u !== me;

  const area = document.createElement("input");
  area.placeholder = "√Årea de pesquisa";
  area.value = profile.area;
  area.style.width = "100%";
  area.disabled = u !== me;

  const links = document.createElement("input");
  links.placeholder = "Links (site, GitHub, arXiv)";
  links.value = profile.links;
  links.style.width = "100%";
  links.disabled = u !== me;

  info.appendChild(bio);
  info.appendChild(area);
  info.appendChild(links);

  if (u === me) {
    const save = document.createElement("button");
    save.innerText = "Salvar perfil";
    save.onclick = () => {
      profile.bio = bio.value;
      profile.area = area.value;
      profile.links = links.value;
      logActivity(me, "Atualizou o perfil");
      saveProfiles();
    };
    info.appendChild(save);
  }

  content.appendChild(info);

  // Estat√≠sticas
  const stats = document.createElement("div");
  stats.style.border = "1px solid #333";
  stats.style.padding = "12px";
  stats.style.marginTop = "12px";

  const sh = document.createElement("h4");
  sh.innerText = "Estat√≠sticas";
  stats.appendChild(sh);

  Object.entries(profile.stats).forEach(([k, v]) => {
    const row = document.createElement("div");
    row.innerText = k + ": " + v;
    stats.appendChild(row);
  });

  content.appendChild(stats);

  // Atividade recente
  const act = document.createElement("div");
  act.style.border = "1px solid #333";
  act.style.padding = "12px";
  act.style.marginTop = "12px";

  const ah = document.createElement("h4");
  ah.innerText = "Atividade recente";
  act.appendChild(ah);

  if (profileState.activity[u].length === 0) {
    const empty = document.createElement("div");
    empty.style.opacity = "0.6";
    empty.innerText = "Nenhuma atividade registrada.";
    act.appendChild(empty);
  } else {
    profileState.activity[u].forEach(a => {
      const row = document.createElement("div");
      row.style.fontSize = "12px";
      row.style.opacity = "0.8";
      row.innerText =
        new Date(a.at).toLocaleString() + " ‚Äî " + a.text;
      act.appendChild(row);
    });
  }

  content.appendChild(act);

  // A√ß√µes
  if (u !== me) {
    const actions = document.createElement("div");
    actions.style.marginTop = "12px";

    const msg = document.createElement("button");
    msg.innerText = "Mensagem privada";
    msg.onclick = () => renderPMThread(u);

    actions.appendChild(msg);
    content.appendChild(actions);
  }
}

// Integra√ß√£o com dashboard
const __openSectionProfile = openSection;
openSection = function (sectionId) {
  if (sectionId === "profile") {
    renderProfile();
    return;
  }
  __openSectionProfile(sectionId);
};

// ===============================
// PR√ìXIMO BLOCO (A CONTINUAR)
// ===============================
// ADMINISTRA√á√ÉO N√öCLEO
// - Promover / rebaixar membros
// - Aprovar teorias
// - Modera√ß√£o de f√≥rum
// - Logs globais

    <!-- ============================================================
     DASHBOARD ‚Äî VIS√ÉO GERAL (BLOCO √öNICO, COMPLETO)
     Rede Social para Pesquisa em Matem√°tica
     N√ÉO FECHAR HTML / BODY / SCRIPT
     ============================================================ -->

<!-- =======================
     DASHBOARD: ESTRUTURA
     ======================= -->
<section id="dashboard" class="view hidden">
  <header class="dashboard-header">
    <h1>Dashboard</h1>
    <p class="subtitle">
      Vis√£o geral da atividade cient√≠fica, grupos, teorias e comunica√ß√µes
    </p>
  </header>

  <!-- =======================
       KPIs / ESTAT√çSTICAS
       ======================= -->
  <div class="kpi-grid">
    <div class="kpi-card" id="kpi-theories">
      <h3>Teorias Criadas</h3>
      <span class="kpi-value" data-kpi="theories">0</span>
      <small>Total submetidas</small>
    </div>

    <div class="kpi-card" id="kpi-approved">
      <h3>Aprovadas (N√∫cleo)</h3>
      <span class="kpi-value" data-kpi="approved">0</span>
      <small>Validadas</small>
    </div>

    <div class="kpi-card" id="kpi-groups">
      <h3>Grupos</h3>
      <span class="kpi-value" data-kpi="groups">0</span>
      <small>Participa√ß√µes</small>
    </div>

    <div class="kpi-card" id="kpi-messages">
      <h3>Mensagens</h3>
      <span class="kpi-value" data-kpi="messages">0</span>
      <small>N√£o lidas</small>
    </div>
  </div>

  <!-- =======================
       ATIVIDADE RECENTE
       ======================= -->
  <div class="dashboard-panels">
    <div class="panel panel-activity">
      <h2>Atividade Recente</h2>
      <ul id="activity-feed" class="activity-feed">
        <!-- preenchido dinamicamente -->
      </ul>
    </div>

    <div class="panel panel-notifications">
      <h2>Notifica√ß√µes</h2>
      <ul id="notification-list" class="notification-list">
        <!-- preenchido dinamicamente -->
      </ul>
    </div>
  </div>

  <!-- =======================
       TEORIAS EM ANDAMENTO
       ======================= -->
  <div class="panel panel-theories">
    <h2>Teorias em Andamento</h2>

    <table class="theory-table">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Autor</th>
          <th>Status</th>
          <th>√öltima Atualiza√ß√£o</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="theory-table-body">
        <!-- linhas din√¢micas -->
      </tbody>
    </table>
  </div>

  <!-- =======================
       GRUPOS ATIVOS
       ======================= -->
  <div class="panel panel-groups">
    <h2>Grupos Ativos</h2>
    <div id="group-cards" class="group-card-grid">
      <!-- cards din√¢micos -->
    </div>
  </div>

  <!-- =======================
       F√ìRUM: T√ìPICOS QUENTES
       ======================= -->
  <div class="panel panel-forum">
    <h2>T√≥picos Recentes do F√≥rum</h2>
    <ul id="forum-topics" class="forum-topic-list">
      <!-- din√¢mico -->
    </ul>
  </div>

  <!-- =======================
       CHAT: STATUS GERAL
       ======================= -->
  <div class="panel panel-chat">
    <h2>Status do Chat</h2>
    <div class="chat-status">
      <span id="online-count">0</span> usu√°rios online
    </div>
    <div class="chat-preview" id="chat-preview">
      <!-- mensagens recentes -->
    </div>
  </div>
</section>

<!-- =======================
     DASHBOARD: ESTILOS
     ======================= -->
<style>
.view.hidden { display: none; }

.dashboard-header {
  margin-bottom: 20px;
}

.subtitle {
  opacity: 0.8;
}

.kpi-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.kpi-card {
  background: #111;
  border: 1px solid #222;
  padding: 16px;
  border-radius: 8px;
}

.kpi-value {
  font-size: 2em;
  font-weight: bold;
}

.dashboard-panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 24px;
  margin-bottom: 32px;
}

.panel {
  background: #0b0b0b;
  border: 1px solid #1e1e1e;
  border-radius: 8px;
  padding: 16px;
}

.activity-feed,
.notification-list,
.forum-topic-list {
  list-style: none;
  padding: 0;
  margin: 0;
}

.activity-feed li,
.notification-list li,
.forum-topic-list li {
  padding: 8px 0;
  border-bottom: 1px solid #1a1a1a;
}

.theory-table {
  width: 100%;
  border-collapse: collapse;
}

.theory-table th,
.theory-table td {
  padding: 8px;
  border-bottom: 1px solid #1a1a1a;
}

.group-card-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
}

.chat-preview {
  max-height: 180px;
  overflow-y: auto;
  font-size: 0.9em;
}
</style>

<!-- =======================
     DASHBOARD: L√ìGICA JS
     ======================= -->
<script>
/* ------------------------------------------------
   ESTADO GLOBAL DO DASHBOARD
------------------------------------------------- */
const DashboardState = {
  user: null,
  theories: [],
  groups: [],
  forumTopics: [],
  activities: [],
  notifications: [],
  chatPreview: [],
  onlineCount: 0
};

/* ------------------------------------------------
   INICIALIZA√á√ÉO
------------------------------------------------- */
function initDashboard() {
  DashboardState.user = getCurrentUser();
  if (!DashboardState.user) return;

  loadDashboardData();
  renderDashboard();
}

/* ------------------------------------------------
   CARREGAMENTO DE DADOS (localStorage)
------------------------------------------------- */
function loadDashboardData() {
  DashboardState.theories =
    JSON.parse(localStorage.getItem("theories")) || [];

  DashboardState.groups =
    JSON.parse(localStorage.getItem("groups")) || [];

  DashboardState.forumTopics =
    JSON.parse(localStorage.getItem("forumTopics")) || [];

  DashboardState.activities =
    JSON.parse(localStorage.getItem("activities")) || [];

  DashboardState.notifications =
    JSON.parse(localStorage.getItem("notifications")) || [];

  DashboardState.chatPreview =
    JSON.parse(localStorage.getItem("chatPreview")) || [];

  DashboardState.onlineCount =
    JSON.parse(localStorage.getItem("onlineCount")) || 0;
}

/* ------------------------------------------------
   RENDERIZA√á√ÉO PRINCIPAL
------------------------------------------------- */
function renderDashboard() {
  renderKPIs();
  renderActivities();
  renderNotifications();
  renderTheories();
  renderGroups();
  renderForumTopics();
  renderChatStatus();
}

/* ------------------------------------------------
   KPIs
------------------------------------------------- */
function renderKPIs() {
  const theories = DashboardState.theories.filter(
    t => t.author === DashboardState.user.username
  );

  const approved = theories.filter(t => t.status === "approved");

  document.querySelector('[data-kpi="theories"]').textContent =
    theories.length;

  document.querySelector('[data-kpi="approved"]').textContent =
    approved.length;

  document.querySelector('[data-kpi="groups"]').textContent =
    DashboardState.groups.length;

  document.querySelector('[data-kpi="messages"]').textContent =
    countUnreadMessages();
}

/* ------------------------------------------------
   ATIVIDADES
------------------------------------------------- */
function renderActivities() {
  const ul = document.getElementById("activity-feed");
  ul.innerHTML = "";

  DashboardState.activities.slice(0, 10).forEach(act => {
    const li = document.createElement("li");
    li.textContent = act;
    ul.appendChild(li);
  });
}

/* ------------------------------------------------
   NOTIFICA√á√ïES
------------------------------------------------- */
function renderNotifications() {
  const ul = document.getElementById("notification-list");
  ul.innerHTML = "";

  DashboardState.notifications.slice(0, 10).forEach(n => {
    const li = document.createElement("li");
    li.textContent = n;
    ul.appendChild(li);
  });
}

/* ------------------------------------------------
   TEORIAS
------------------------------------------------- */
function renderTheories() {
  const tbody = document.getElementById("theory-table-body");
  tbody.innerHTML = "";

  DashboardState.theories.forEach(t => {
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${t.title}</td>
      <td>${t.author}</td>
      <td>${t.status}</td>
      <td>${t.updatedAt}</td>
      <td>
        <button onclick="openTheory('${t.id}')">Abrir</button>
      </td>
    `;

    tbody.appendChild(tr);
  });
}

/* ------------------------------------------------
   GRUPOS
------------------------------------------------- */
function renderGroups() {
  const container = document.getElementById("group-cards");
  container.innerHTML = "";

  DashboardState.groups.forEach(g => {
    const div = document.createElement("div");
    div.className = "group-card";
    div.innerHTML = `
      <h3>${g.name}</h3>
      <p>${g.description}</p>
      <small>Membros: ${g.members.length}</small>
    `;
    container.appendChild(div);
  });
}

/* ------------------------------------------------
   F√ìRUM
------------------------------------------------- */
function renderForumTopics() {
  const ul = document.getElementById("forum-topics");
  ul.innerHTML = "";

  DashboardState.forumTopics.slice(0, 5).forEach(t => {
    const li = document.createElement("li");
    li.innerHTML = `
      <strong>${t.title}</strong> ‚Äî ${t.author}
    `;
    ul.appendChild(li);
  });
}

/* ------------------------------------------------
   CHAT
------------------------------------------------- */
function renderChatStatus() {
  document.getElementById("online-count").textContent =
    DashboardState.onlineCount;

  const preview = document.getElementById("chat-preview");
  preview.innerHTML = "";

  DashboardState.chatPreview.slice(0, 5).forEach(m => {
    const p = document.createElement("p");
    p.textContent = `${m.user}: ${m.text}`;
    preview.appendChild(p);
  });
}

/* ------------------------------------------------
   AUXILIARES
------------------------------------------------- */
function countUnreadMessages() {
  const chats = JSON.parse(localStorage.getItem("privateChats")) || [];
  return chats.reduce((acc, c) => acc + (c.unread || 0), 0);
}

function getCurrentUser() {
  return JSON.parse(localStorage.getItem("currentUser"));
}

function openTheory(id) {
  console.log("Abrir teoria:", id);
  // navega√ß√£o futura
}

/* ------------------------------------------------
   IN√çCIO DO DASHBOARD
------------------------------------------------- */
initDashboard();

/* =================================================
   PR√ìXIMO BLOCO A SER DESENVOLVIDO:
   - DASHBOARD AVAN√áADO (FILTROS, GR√ÅFICOS, PERMISS√ïES)
   - Integra√ß√£o N√∫cleo (aprova√ß√£o inline)
   ================================================= */

    <!-- ============================================================
     DASHBOARD AVAN√áADO ‚Äî FILTROS, GR√ÅFICOS, PERMISS√ïES (N√öCLEO)
     BLOCO CONT√çNUO ‚Äî N√ÉO FECHAR HTML / BODY / SCRIPT
     ============================================================ -->

<!-- =======================
     FILTROS DO DASHBOARD
     ======================= -->
<section id="dashboard-filters" class="panel">
  <h2>Filtros e Visualiza√ß√µes</h2>

  <div class="filter-grid">
    <div class="filter-item">
      <label>Status da Teoria</label>
      <select id="filter-theory-status">
        <option value="all">Todas</option>
        <option value="draft">Rascunho</option>
        <option value="pending">Pendente</option>
        <option value="approved">Aprovada</option>
        <option value="rejected">Rejeitada</option>
      </select>
    </div>

    <div class="filter-item">
      <label>Grupo</label>
      <select id="filter-group">
        <option value="all">Todos</option>
      </select>
    </div>

    <div class="filter-item">
      <label>Per√≠odo</label>
      <select id="filter-period">
        <option value="7">√öltimos 7 dias</option>
        <option value="30">√öltimos 30 dias</option>
        <option value="365">√öltimo ano</option>
        <option value="all">Tudo</option>
      </select>
    </div>

    <div class="filter-item">
      <button id="apply-dashboard-filters">
        Aplicar Filtros
      </button>
    </div>
  </div>
</section>

<!-- =======================
     GR√ÅFICOS ANAL√çTICOS
     ======================= -->
<section id="dashboard-analytics" class="panel">
  <h2>An√°lise de Atividade</h2>

  <div class="analytics-grid">
    <div class="chart-box">
      <h3>Produ√ß√£o de Teorias</h3>
      <canvas id="chart-theories"></canvas>
    </div>

    <div class="chart-box">
      <h3>Atividade por Grupo</h3>
      <canvas id="chart-groups"></canvas>
    </div>

    <div class="chart-box">
      <h3>Intera√ß√µes (Chat/F√≥rum)</h3>
      <canvas id="chart-interactions"></canvas>
    </div>
  </div>
</section>

<!-- =======================
     PAINEL N√öCLEO (ADMIN)
     ======================= -->
<section id="dashboard-nucleo" class="panel hidden">
  <h2>Painel N√∫cleo</h2>
  <p class="subtitle">
    Controle avan√ßado, aprova√ß√£o cient√≠fica e gest√£o de membros
  </p>

  <!-- APROVA√á√ÉO DE TEORIAS -->
  <div class="nucleo-section">
    <h3>Teorias Pendentes</h3>
    <table class="theory-table">
      <thead>
        <tr>
          <th>T√≠tulo</th>
          <th>Autor</th>
          <th>Resumo</th>
          <th>A√ß√µes</th>
        </tr>
      </thead>
      <tbody id="nucleo-theory-queue">
        <!-- preenchido dinamicamente -->
      </tbody>
    </table>
  </div>

  <!-- PROMO√á√ÉO DE MEMBROS -->
  <div class="nucleo-section">
    <h3>Membros</h3>
    <table class="member-table">
      <thead>
        <tr>
          <th>Usu√°rio</th>
          <th>N√≠vel</th>
          <th>Grupos</th>
          <th>A√ß√£o</th>
        </tr>
      </thead>
      <tbody id="nucleo-members">
        <!-- din√¢mico -->
      </tbody>
    </table>
  </div>
</section>

<!-- =======================
     ESTILOS AVAN√áADOS
     ======================= -->
<style>
.filter-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
  gap: 16px;
}

.filter-item label {
  display: block;
  font-size: 0.85em;
  margin-bottom: 4px;
}

.analytics-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(260px, 1fr));
  gap: 24px;
}

.chart-box {
  background: #090909;
  border: 1px solid #1f1f1f;
  border-radius: 8px;
  padding: 16px;
}

.nucleo-section {
  margin-top: 24px;
}

.member-table {
  width: 100%;
  border-collapse: collapse;
}

.member-table th,
.member-table td {
  padding: 8px;
  border-bottom: 1px solid #1a1a1a;
}
</style>

<!-- =======================
     L√ìGICA AVAN√áADA JS
     ======================= -->
<script>
/* ------------------------------------------------
   PERMISS√ïES
------------------------------------------------- */
function isNucleoUser() {
  return (
    DashboardState.user &&
    DashboardState.user.role === "nucleo" &&
    DashboardState.user.masterKey === "Renova, O Non Trad"
  );
}

/* ------------------------------------------------
   FILTROS
------------------------------------------------- */
document
  .getElementById("apply-dashboard-filters")
  .addEventListener("click", applyDashboardFilters);

function applyDashboardFilters() {
  const status =
    document.getElementById("filter-theory-status").value;
  const period =
    document.getElementById("filter-period").value;

  let filtered = [...DashboardState.theories];

  if (status !== "all") {
    filtered = filtered.filter(t => t.status === status);
  }

  if (period !== "all") {
    const days = parseInt(period);
    const limit = Date.now() - days * 86400000;
    filtered = filtered.filter(
      t => new Date(t.updatedAt).getTime() >= limit
    );
  }

  renderFilteredTheories(filtered);
}

function renderFilteredTheories(list) {
  const tbody = document.getElementById("theory-table-body");
  tbody.innerHTML = "";

  list.forEach(t => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.title}</td>
      <td>${t.author}</td>
      <td>${t.status}</td>
      <td>${t.updatedAt}</td>
      <td>
        <button onclick="openTheory('${t.id}')">Abrir</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ------------------------------------------------
   PAINEL N√öCLEO
------------------------------------------------- */
function initNucleoPanel() {
  if (!isNucleoUser()) return;

  document
    .getElementById("dashboard-nucleo")
    .classList.remove("hidden");

  renderNucleoTheories();
  renderNucleoMembers();
}

function renderNucleoTheories() {
  const tbody = document.getElementById("nucleo-theory-queue");
  tbody.innerHTML = "";

  DashboardState.theories
    .filter(t => t.status === "pending")
    .forEach(t => {
      const tr = document.createElement("tr");
      tr.innerHTML = `
        <td>${t.title}</td>
        <td>${t.author}</td>
        <td>${t.summary || ""}</td>
        <td>
          <button onclick="approveTheory('${t.id}')">Aprovar</button>
          <button onclick="rejectTheory('${t.id}')">Rejeitar</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
}

function approveTheory(id) {
  updateTheoryStatus(id, "approved");
}

function rejectTheory(id) {
  updateTheoryStatus(id, "rejected");
}

function updateTheoryStatus(id, status) {
  DashboardState.theories = DashboardState.theories.map(t => {
    if (t.id === id) {
      t.status = status;
      t.updatedAt = new Date().toISOString();
    }
    return t;
  });

  localStorage.setItem(
    "theories",
    JSON.stringify(DashboardState.theories)
  );

  renderDashboard();
  renderNucleoTheories();
}

/* ------------------------------------------------
   MEMBROS
------------------------------------------------- */
function renderNucleoMembers() {
  const tbody = document.getElementById("nucleo-members");
  tbody.innerHTML = "";

  const users =
    JSON.parse(localStorage.getItem("users")) || [];

  users.forEach(u => {
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${u.username}</td>
      <td>${u.role}</td>
      <td>${(u.groups || []).length}</td>
      <td>
        ${
          u.role !== "nucleo"
            ? `<button onclick="promoteToNucleo('${u.username}')">Promover</button>`
            : ""
        }
      </td>
    `;
    tbody.appendChild(tr);
  });
}

function promoteToNucleo(username) {
  const users =
    JSON.parse(localStorage.getItem("users")) || [];

  users.forEach(u => {
    if (u.username === username) {
      u.role = "nucleo";
    }
  });

  localStorage.setItem("users", JSON.stringify(users));
  renderNucleoMembers();
}

/* ------------------------------------------------
   GR√ÅFICOS (ESTRUTURA BASE)
------------------------------------------------- */
function initCharts() {
  // Estrutura pronta para integra√ß√£o com Chart.js
  // Dados j√° preparados, apenas liga√ß√£o futura
}

/* ------------------------------------------------
   INICIALIZA√á√ÉO AVAN√áADA
------------------------------------------------- */
initNucleoPanel();
initCharts();

/* =================================================
   PR√ìXIMO BLOCO A IMPLEMENTAR:
   - SISTEMA DE TEORIAS (CRIAR / EDITAR / VERSIONAR)
   - SUPORTE LaTeX COMPLETO (MathJax inline + display)
   ================================================= */

    /* ============================================================
   SISTEMA DE TEORIAS ‚Äî CRIA√á√ÉO, EDI√á√ÉO, VERSIONAMENTO, APROVA√á√ÉO
   BLOCO CONT√çNUO ‚Äî N√ÉO FECHAR SCRIPT / HTML
   ============================================================ */

/* =======================
   ESTADO GLOBAL ‚Äî TEORIAS
   ======================= */
const theoriesState = {
  theories: JSON.parse(localStorage.getItem("theories") || "[]"),
  versions: JSON.parse(localStorage.getItem("theory_versions") || "{}"),
  drafts: JSON.parse(localStorage.getItem("theory_drafts") || "{}")
};

function saveTheories() {
  localStorage.setItem("theories", JSON.stringify(theoriesState.theories));
  localStorage.setItem("theory_versions", JSON.stringify(theoriesState.versions));
  localStorage.setItem("theory_drafts", JSON.stringify(theoriesState.drafts));
}

/* =======================
   UTILIDADES
   ======================= */
function uid(prefix="t") {
  return prefix + "_" + Math.random().toString(36).slice(2) + Date.now();
}

function nowISO() {
  return new Date().toISOString();
}

function canApprove() {
  return authState?.users?.[currentUser()]?.nuclear === true;
}

/* =======================
   RENDER ‚Äî LISTA DE TEORIAS
   ======================= */
function renderTheoriesList() {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const h = document.createElement("h3");
  h.innerText = "Teorias";
  content.appendChild(h);

  const toolbar = document.createElement("div");
  const btnNew = document.createElement("button");
  btnNew.innerText = "Nova Teoria";
  btnNew.onclick = () => renderTheoryEditor();
  toolbar.appendChild(btnNew);

  const sel = document.createElement("select");
  ["all","draft","pending","approved","rejected"].forEach(s=>{
    const o=document.createElement("option"); o.value=s; o.innerText=s;
    sel.appendChild(o);
  });
  sel.onchange = ()=> renderTheoriesTable(sel.value);
  toolbar.appendChild(sel);
  content.appendChild(toolbar);

  const table = document.createElement("table");
  table.style.width="100%";
  table.innerHTML = `
    <thead>
      <tr>
        <th>T√≠tulo</th>
        <th>Autor</th>
        <th>Status</th>
        <th>Atualiza√ß√£o</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="theories-tbody"></tbody>
  `;
  content.appendChild(table);

  renderTheoriesTable("all");
}

function renderTheoriesTable(filter="all") {
  const tb = document.getElementById("theories-tbody");
  if (!tb) return;
  tb.innerHTML = "";
  theoriesState.theories
    .filter(t => filter==="all" ? true : t.status===filter)
    .forEach(t=>{
      const tr=document.createElement("tr");
      tr.innerHTML=`
        <td>${t.title}</td>
        <td>${t.author}</td>
        <td>${t.status}</td>
        <td>${new Date(t.updatedAt).toLocaleString()}</td>
        <td>
          <button onclick="openTheory('${t.id}')">Abrir</button>
          ${t.author===currentUser() ? `<button onclick="renderTheoryEditor('${t.id}')">Editar</button>`:""}
          ${canApprove() && t.status==="pending" ? `<button onclick="approveTheory('${t.id}')">Aprovar</button>`:""}
        </td>
      `;
      tb.appendChild(tr);
    });
}

/* =======================
   EDITOR DE TEORIAS
   ======================= */
function renderTheoryEditor(id=null) {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const editing = id ? theoriesState.theories.find(t=>t.id===id) : null;
  const draft = theoriesState.drafts[id] || {};

  const h = document.createElement("h3");
  h.innerText = id ? "Editar Teoria" : "Nova Teoria";
  content.appendChild(h);

  const title = document.createElement("input");
  title.placeholder="T√≠tulo";
  title.style.width="100%";
  title.value = draft.title || editing?.title || "";

  const abs = document.createElement("textarea");
  abs.placeholder="Resumo";
  abs.style.width="100%";
  abs.value = draft.abstract || editing?.abstract || "";

  const body = document.createElement("textarea");
  body.placeholder="Conte√∫do (LaTeX suportado)";
  body.style.width="100%";
  body.style.minHeight="240px";
  body.value = draft.body || editing?.body || "";

  content.appendChild(title);
  content.appendChild(abs);
  content.appendChild(body);

  const actions = document.createElement("div");

  const btnSaveDraft = document.createElement("button");
  btnSaveDraft.innerText="Salvar Rascunho";
  btnSaveDraft.onclick=()=>{
    const key = id || uid("draft");
    theoriesState.drafts[key] = {
      title:title.value, abstract:abs.value, body:body.value, at:nowISO()
    };
    saveTheories();
    alert("Rascunho salvo");
  };

  const btnSubmit = document.createElement("button");
  btnSubmit.innerText = editing ? "Enviar Atualiza√ß√£o" : "Submeter";
  btnSubmit.onclick=()=>{
    if (editing) {
      createNewVersion(editing.id, body.value);
      editing.title = title.value;
      editing.abstract = abs.value;
      editing.body = body.value;
      editing.status = "pending";
      editing.updatedAt = nowISO();
    } else {
      const t = {
        id: uid("theory"),
        title: title.value,
        abstract: abs.value,
        body: body.value,
        author: currentUser(),
        status: "pending",
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      theoriesState.theories.push(t);
      theoriesState.versions[t.id] = [{
        body: body.value, at: nowISO(), author: currentUser()
      }];
    }
    saveTheories();
    renderTheoriesList();
  };

  actions.appendChild(btnSaveDraft);
  actions.appendChild(btnSubmit);
  content.appendChild(actions);

  const preview = document.createElement("div");
  preview.id="theory-preview";
  preview.style.border="1px solid #333";
  preview.style.padding="12px";
  preview.style.marginTop="12px";
  preview.innerHTML = body.value;
  content.appendChild(preview);

  body.oninput=()=>{
    preview.innerHTML = body.value;
    if (window.MathJax) MathJax.typesetPromise([preview]);
  };

  if (window.MathJax) MathJax.typesetPromise([preview]);
}

/* =======================
   VERSIONAMENTO
   ======================= */
function createNewVersion(id, body) {
  if (!theoriesState.versions[id]) theoriesState.versions[id]=[];
  theoriesState.versions[id].push({
    body, at: nowISO(), author: currentUser()
  });
}

/* =======================
   VISUALIZA√á√ÉO DE TEORIA
   ======================= */
function openTheory(id) {
  const t = theoriesState.theories.find(x=>x.id===id);
  if (!t) return;
  const content = document.getElementById("dashboardContent");
  content.innerHTML="";

  const h=document.createElement("h3");
  h.innerText=t.title;
  content.appendChild(h);

  const meta=document.createElement("div");
  meta.innerText=`Autor: ${t.author} | Status: ${t.status}`;
  content.appendChild(meta);

  const abs=document.createElement("p");
  abs.innerText=t.abstract;
  content.appendChild(abs);

  const body=document.createElement("div");
  body.innerHTML=t.body;
  content.appendChild(body);

  if (window.MathJax) MathJax.typesetPromise([body]);

  const versions = theoriesState.versions[id] || [];
  if (versions.length>1) {
    const vh=document.createElement("h4");
    vh.innerText="Vers√µes";
    content.appendChild(vh);
    versions.forEach((v,i)=>{
      const row=document.createElement("div");
      row.style.fontSize="12px";
      row.innerText=`v${i+1} ‚Äî ${new Date(v.at).toLocaleString()} ‚Äî ${v.author}`;
      content.appendChild(row);
    });
  }
}

/* =======================
   APROVA√á√ÉO (N√öCLEO)
   ======================= */
function approveTheory(id) {
  if (!canApprove()) return;
  theoriesState.theories.forEach(t=>{
    if (t.id===id) {
      t.status="approved";
      t.updatedAt=nowISO();
    }
  });
  saveTheories();
  renderTheoriesList();
}

/* =======================
   INTEGRA√á√ÉO COM DASHBOARD
   ======================= */
const __openSectionTheories = openSection;
openSection = function(sectionId) {
  if (sectionId==="theories") {
    renderTheoriesList();
    return;
  }
  __openSectionTheories(sectionId);
};

/* ============================================================
   PR√ìXIMO BLOCO A CONTINUAR:
   - F√ìRUM (T√ìPICOS, RESPOSTAS, MODERA√á√ÉO)
   - CHAT GERAL (CANAIS, LaTeX, N√ÉO LIDAS)
   - CONTATOS / CHAT PRIVADO
   ============================================================ */

    /* ============================================================
   F√ìRUM ‚Äî T√ìPICOS, RESPOSTAS, MODERA√á√ÉO, LaTeX
   BLOCO CONT√çNUO ‚Äî N√ÉO FECHAR SCRIPT / HTML
   ============================================================ */

/* =======================
   ESTADO GLOBAL ‚Äî F√ìRUM
   ======================= */
const forumState = {
  topics: JSON.parse(localStorage.getItem("forum_topics") || "[]"),
  replies: JSON.parse(localStorage.getItem("forum_replies") || "[]")
};

function saveForum() {
  localStorage.setItem("forum_topics", JSON.stringify(forumState.topics));
  localStorage.setItem("forum_replies", JSON.stringify(forumState.replies));
}

/* =======================
   RENDER ‚Äî LISTA DE T√ìPICOS
   ======================= */
function renderForum() {
  const content = document.getElementById("dashboardContent");
  if (!content) return;
  content.innerHTML = "";

  const h = document.createElement("h3");
  h.innerText = "F√≥rum";
  content.appendChild(h);

  const btnNew = document.createElement("button");
  btnNew.innerText = "Novo T√≥pico";
  btnNew.onclick = () => renderNewTopic();
  content.appendChild(btnNew);

  const table = document.createElement("table");
  table.style.width = "100%";
  table.innerHTML = `
    <thead>
      <tr>
        <th>T√≠tulo</th>
        <th>Autor</th>
        <th>Respostas</th>
        <th>√öltima atividade</th>
        <th>A√ß√µes</th>
      </tr>
    </thead>
    <tbody id="forum-tbody"></tbody>
  `;
  content.appendChild(table);

  renderForumTable();
}

function renderForumTable() {
  const tb = document.getElementById("forum-tbody");
  if (!tb) return;
  tb.innerHTML = "";

  forumState.topics.forEach(t => {
    const repliesCount =
      forumState.replies.filter(r => r.topicId === t.id).length;

    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${t.title}</td>
      <td>${t.author}</td>
      <td>${repliesCount}</td>
      <td>${new Date(t.updatedAt).toLocaleString()}</td>
      <td>
        <button onclick="openTopic('${t.id}')">Abrir</button>
        ${
          canApprove()
            ? `<button onclick="deleteTopic('${t.id}')">Excluir</button>`
            : ""
        }
      </td>
    `;
    tb.appendChild(tr);
  });
}

/* =======================
   NOVO T√ìPICO
   ======================= */
function renderNewTopic() {
  const content = document.getElementById("dashboardContent");
  content.innerHTML = "";

  const h = document.createElement("h3");
  h.innerText = "Criar T√≥pico";
  content.appendChild(h);

  const title = document.createElement("input");
  title.placeholder = "T√≠tulo";
  title.style.width = "100%";

  const body = document.createElement("textarea");
  body.placeholder = "Mensagem (LaTeX suportado)";
  body.style.width = "100%";
  body.style.minHeight = "200px";

  content.appendChild(title);
  content.appendChild(body);

  const btn = document.createElement("button");
  btn.innerText = "Publicar";
  btn.onclick = () => {
    const t = {
      id: uid("topic"),
      title: title.value,
      body: body.value,
      author: currentUser(),
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    forumState.topics.push(t);
    saveForum();
    renderForum();
  };

  content.appendChild(btn);
}

/* =======================
   VISUALIZA√á√ÉO DE T√ìPICO
   ======================= */
function openTopic(id) {
  const topic = forumState.topics.find(t => t.id === id);
  if (!topic) return;

  const content = document.getElementById("dashboardContent");
  content.innerHTML = "";

  const h = document.createElement("h3");
  h.innerText = topic.title;
  content.appendChild(h);

  const meta = document.createElement("div");
  meta.innerText =
    "Autor: " +
    topic.author +
    " | " +
    new Date(topic.createdAt).toLocaleString();
  content.appendChild(meta);

  const body = document.createElement("div");
  body.innerHTML = topic.body;
  content.appendChild(body);

  if (window.MathJax) MathJax.typesetPromise([body]);

  const replies = forumState.replies.filter(r => r.topicId === id);

  const rh = document.createElement("h4");
  rh.innerText = "Respostas";
  content.appendChild(rh);

  replies.forEach(r => {
    const box = document.createElement("div");
    box.style.border = "1px solid #333";
    box.style.padding = "8px";
    box.style.marginTop = "6px";

    const meta = document.createElement("div");
    meta.style.fontSize = "12px";
    meta.innerText =
      r.author + " ‚Äî " + new Date(r.createdAt).toLocaleString();
    box.appendChild(meta);

    const msg = document.createElement("div");
    msg.innerHTML = r.body;
    box.appendChild(msg);

    if (window.MathJax) MathJax.typesetPromise([msg]);
    content.appendChild(box);
  });

  renderReplyBox(id);
}

/* =======================
   RESPOSTA
   ======================= */
function renderReplyBox(topicId) {
  const content = document.getElementById("dashboardContent");

  const box = document.createElement("div");
  box.style.marginTop = "12px";

  const ta = document.createElement("textarea");
  ta.placeholder = "Responder (LaTeX suportado)";
  ta.style.width = "100%";

  const btn = document.createElement("button");
  btn.innerText = "Responder";
  btn.onclick = () => {
    forumState.replies.push({
      id: uid("reply"),
      topicId,
      body: ta.value,
      author: currentUser(),
      createdAt: nowISO()
    });

    forumState.topics.forEach(t => {
      if (t.id === topicId) t.updatedAt = nowISO();
    });

    saveForum();
    openTopic(topicId);
  };

  box.appendChild(ta);
  box.appendChild(btn);
  content.appendChild(box);
}

/* =======================
   MODERA√á√ÉO
   ======================= */
function deleteTopic(id) {
  if (!canApprove()) return;
  forumState.topics = forumState.topics.filter(t => t.id !== id);
  forumState.replies = forumState.replies.filter(r => r.topicId !== id);
  saveForum();
  renderForum();
}

/* =======================
   INTEGRA√á√ÉO DASHBOARD
   ======================= */
const __openSectionForum = openSection;
openSection = function (sectionId) {
  if (sectionId === "forum") {
    renderForum();
    return;
  }
  __openSectionForum(sectionId);
};

/* ============================================================
   PR√ìXIMO BLOCO A CONTINUAR:
   - CHAT GERAL (CANAIS, MENSAGENS N√ÉO LIDAS, LaTeX)
   - CONTATOS / CHAT PRIVADO
   - PRESEN√áA ONLINE / OFFLINE
   ============================================================ */

    
