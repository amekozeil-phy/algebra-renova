<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Renova - Plataforma Científica Radical</title>
    
    <!-- MathJax -->
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <!-- KaTeX (alternativo rápido) -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.css">
    <script defer src="https://cdn.jsdelivr.net/npm/katex@0.16.8/dist/katex.min.js"></script>
    
    <style>
        /* ===== RESET & VARIÁVEIS GLOBAIS ===== */
        :root {
            /* Cores principais - Tema Dark Científico */
            --bg-primary: #0a0a0f;
            --bg-secondary: #121220;
            --bg-tertiary: #1a1a2e;
            --bg-quaternary: #222236;
            --accent-primary: #00d4ff;
            --accent-secondary: #9d4edd;
            --accent-danger: #ff2e63;
            --accent-success: #06d6a0;
            --accent-warning: #ffd166;
            --text-primary: #f8f9fa;
            --text-secondary: #adb5bd;
            --text-muted: #6c757d;
            --border-color: #2d3047;
            --border-light: #3a3d5c;
            
            /* Cores de status */
            --online: #06d6a0;
            --away: #ffd166;
            --offline: #6c757d;
            --dnd: #ff2e63;
            
            /* Shadows */
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.3);
            --shadow-md: 0 4px 8px rgba(0,0,0,0.4);
            --shadow-lg: 0 8px 16px rgba(0,0,0,0.5);
            --shadow-xl: 0 12px 24px rgba(0,0,0,0.6);
            
            /* Gradientes */
            --gradient-primary: linear-gradient(135deg, #00d4ff, #9d4edd);
            --gradient-secondary: linear-gradient(135deg, #ff2e63, #ff9a00);
            --gradient-success: linear-gradient(135deg, #06d6a0, #118ab2);
            
            /* Espaçamento */
            --spacing-xs: 4px;
            --spacing-sm: 8px;
            --spacing-md: 16px;
            --spacing-lg: 24px;
            --spacing-xl: 32px;
            --spacing-xxl: 48px;
            
            /* Bordas */
            --border-radius-sm: 4px;
            --border-radius-md: 8px;
            --border-radius-lg: 12px;
            --border-radius-xl: 16px;
            --border-radius-full: 9999px;
            
            /* Transições */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Roboto', 'Inter', system-ui, sans-serif;
        }

        body {
            background-color: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            overflow-x: hidden;
            font-size: 16px;
            line-height: 1.6;
        }

        .hidden {
            display: none !important;
        }

        .loading {
            opacity: 0.6;
            pointer-events: none;
        }

        /* ===== TYPOGRAPHY ===== */
        h1, h2, h3, h4, h5, h6 {
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: var(--spacing-md);
        }

        h1 {
            font-size: 2.5rem;
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        h2 {
            font-size: 2rem;
            color: var(--accent-primary);
        }

        h3 {
            font-size: 1.5rem;
            color: var(--text-primary);
        }

        p {
            margin-bottom: var(--spacing-md);
        }

        a {
            color: var(--accent-primary);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--accent-secondary);
        }

        code {
            background: var(--bg-tertiary);
            padding: 2px 6px;
            border-radius: var(--border-radius-sm);
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.9em;
            color: var(--accent-primary);
        }

        pre {
            background: var(--bg-tertiary);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            overflow-x: auto;
            margin-bottom: var(--spacing-md);
        }

        /* ===== LAYOUT CONTAINERS ===== */
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 var(--spacing-lg);
        }

        .container-fluid {
            width: 100%;
            padding: 0 var(--spacing-lg);
        }

        .row {
            display: flex;
            flex-wrap: wrap;
            margin: 0 calc(var(--spacing-md) * -1);
        }

        .col {
            flex: 1;
            padding: 0 var(--spacing-md);
        }

        /* ===== TOAST NOTIFICATIONS ===== */
        #toastContainer {
            position: fixed;
            top: var(--spacing-lg);
            right: var(--spacing-lg);
            z-index: 9999;
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
            max-width: 400px;
        }

        .toast {
            background: var(--bg-secondary);
            border-left: 4px solid var(--accent-primary);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md) var(--spacing-lg);
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            animation: slideInRight 0.3s ease;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
        }

        .toast:hover {
            transform: translateX(-4px);
        }

        .toast.success {
            border-left-color: var(--accent-success);
        }

        .toast.error {
            border-left-color: var(--accent-danger);
        }

        .toast.warning {
            border-left-color: var(--accent-warning);
        }

        .toast.info {
            border-left-color: var(--accent-primary);
        }

        .toast-icon {
            font-size: 1.25rem;
        }

        .toast-content {
            flex: 1;
        }

        .toast-title {
            font-weight: 600;
            margin-bottom: 2px;
        }

        .toast-message {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .toast-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
        }

        .toast-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        /* ===== LOADING SPINNER ===== */
        .spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 212, 255, 0.1);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        .spinner-sm {
            width: 20px;
            height: 20px;
            border-width: 2px;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ===== AUTH SCREEN ===== */
        #authScreen {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            background: linear-gradient(135deg, var(--bg-primary) 0%, var(--bg-secondary) 100%);
            position: relative;
            overflow: hidden;
        }

        .auth-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 50%, rgba(0, 212, 255, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(157, 78, 221, 0.1) 0%, transparent 50%);
            z-index: 0;
        }

        .auth-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-xl);
            padding: var(--spacing-xxl);
            width: 100%;
            max-width: 480px;
            position: relative;
            z-index: 1;
            box-shadow: var(--shadow-xl);
            backdrop-filter: blur(10px);
        }

        .auth-header {
            text-align: center;
            margin-bottom: var(--spacing-xl);
        }

        .auth-logo {
            font-size: 3.5rem;
            margin-bottom: var(--spacing-md);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .auth-subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        .auth-tabs {
            display: flex;
            margin-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .auth-tab {
            flex: 1;
            padding: var(--spacing-md);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
        }

        .auth-tab:hover {
            color: var(--text-primary);
        }

        .auth-tab.active {
            color: var(--accent-primary);
        }

        .auth-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gradient-primary);
            border-radius: var(--border-radius-full);
        }

        .auth-form {
            display: none;
        }

        .auth-form.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        .form-group {
            margin-bottom: var(--spacing-lg);
        }

        .form-label {
            display: block;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            transition: all var(--transition-fast);
        }

        .form-control:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .form-control.error {
            border-color: var(--accent-danger);
        }

        .form-error {
            color: var(--accent-danger);
            font-size: 0.85rem;
            margin-top: var(--spacing-xs);
            display: none;
        }

        .form-error.show {
            display: block;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .checkbox-group input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }

        .auth-button {
            width: 100%;
            padding: var(--spacing-md);
            background: var(--gradient-primary);
            color: white;
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-top: var(--spacing-md);
        }

        .auth-button:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .auth-button:active {
            transform: translateY(0);
        }

        .auth-button.loading {
            position: relative;
            color: transparent;
        }

        .auth-button.loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .auth-footer {
            text-align: center;
            margin-top: var(--spacing-xl);
            padding-top: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .auth-theme-selector {
            display: flex;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-md);
        }

        .theme-option {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all var(--transition-fast);
        }

        .theme-option:hover {
            transform: scale(1.1);
        }

        .theme-option.active {
            border-color: var(--text-primary);
            transform: scale(1.1);
        }

        .theme-dark { background: linear-gradient(135deg, #0a0a0f, #121220); }
        .theme-blue { background: linear-gradient(135deg, #0f172a, #1e40af); }
        .theme-green { background: linear-gradient(135deg, #064e3b, #065f46); }
        .theme-purple { background: linear-gradient(135deg, #4c1d95, #7c3aed); }
        .theme-matrix { background: linear-gradient(135deg, #003B00, #00FF41); }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== DASHBOARD LAYOUT ===== */
        #dashboard {
            display: grid;
            grid-template-columns: 280px 1fr;
            min-height: 100vh;
            position: relative;
        }

        /* Mobile Menu Toggle */
        .mobile-menu-toggle {
            display: none;
            position: fixed;
            top: var(--spacing-md);
            left: var(--spacing-md);
            z-index: 100;
            background: var(--gradient-primary);
            color: white;
            width: 48px;
            height: 48px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            box-shadow: var(--shadow-lg);
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
            transition: all var(--transition-fast);
        }

        .mobile-menu-toggle:hover {
            transform: scale(1.05);
        }

        /* Sidebar */
        #sidebar {
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
            z-index: 50;
            transition: transform var(--transition-normal);
        }

        .sidebar-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .sidebar-logo {
            font-size: 1.75rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .user-profile-mini {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--accent-primary);
            transition: all var(--transition-fast);
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        .user-info-mini {
            flex: 1;
            overflow: hidden;
        }

        .user-name {
            font-weight: 600;
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .user-status {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .status-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        .status-online { background: var(--online); }
        .status-away { background: var(--away); }
        .status-offline { background: var(--offline); }
        .status-dnd { background: var(--dnd); }

        /* Sidebar Navigation */
        .sidebar-nav {
            flex: 1;
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-xs);
        }

        .nav-section {
            margin-bottom: var(--spacing-lg);
        }

        .nav-title {
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            margin-bottom: var(--spacing-sm);
            padding-left: var(--spacing-sm);
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            color: var(--text-secondary);
            text-decoration: none;
            border-radius: var(--border-radius-md);
            transition: all var(--transition-fast);
            cursor: pointer;
            position: relative;
        }

        .nav-item:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            transform: translateX(4px);
        }

        .nav-item.active {
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.1), transparent);
            color: var(--accent-primary);
            border-left: 3px solid var(--accent-primary);
        }

        .nav-icon {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
        }

        .nav-label {
            flex: 1;
            font-weight: 500;
        }

        .nav-badge {
            background: var(--accent-danger);
            color: white;
            font-size: 0.75rem;
            padding: 2px 8px;
            border-radius: var(--border-radius-full);
            min-width: 20px;
            text-align: center;
        }

        /* Online Users */
        .online-users {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
        }

        .online-title {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: var(--spacing-md);
        }

        .online-count {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .online-list {
            display: flex;
            flex-direction: column;
            gap: var(--spacing-sm);
        }

        .online-user {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .online-user:hover {
            background: var(--bg-tertiary);
        }

        .online-user-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
            border: 2px solid var(--online);
        }

        .online-user-name {
            flex: 1;
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Main Content */
        #mainContent {
            background: var(--bg-primary);
            overflow-y: auto;
            max-height: 100vh;
            padding: var(--spacing-lg);
        }

        .content-header {
            margin-bottom: var(--spacing-xl);
            padding-bottom: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .content-header h1 {
            margin-bottom: var(--spacing-sm);
        }

        .content-header .subtitle {
            color: var(--text-secondary);
            font-size: 1.1rem;
        }

        /* ===== DASHBOARD HOME ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: var(--spacing-lg);
            margin-bottom: var(--spacing-xl);
        }

        .stat-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-normal);
            position: relative;
            overflow: hidden;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--gradient-primary);
        }

        .stat-icon {
            font-size: 2rem;
            margin-bottom: var(--spacing-md);
            opacity: 0.8;
        }

        .stat-title {
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-sm);
        }

        .stat-value {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            background: var(--gradient-primary);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-trend {
            display: flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .trend-up {
            color: var(--accent-success);
        }

        .trend-down {
            color: var(--accent-danger);
        }

        /* Activity Feed */
        .activity-feed {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
        }

        .activity-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .activity-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .activity-item {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            transition: all var(--transition-fast);
        }

        .activity-item:hover {
            background: var(--bg-tertiary);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        .activity-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.25rem;
        }

        .activity-icon.theory { background: rgba(0, 212, 255, 0.1); color: var(--accent-primary); }
        .activity-icon.forum { background: rgba(157, 78, 221, 0.1); color: var(--accent-secondary); }
        .activity-icon.chat { background: rgba(6, 214, 160, 0.1); color: var(--accent-success); }
        .activity-icon.friend { background: rgba(255, 214, 102, 0.1); color: var(--accent-warning); }

        .activity-content {
            flex: 1;
        }

        .activity-text {
            margin-bottom: var(--spacing-xs);
        }

        .activity-time {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* ===== BUTTONS ===== */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            padding: var(--spacing-sm) var(--spacing-lg);
            border: none;
            border-radius: var(--border-radius-md);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            text-decoration: none;
            white-space: nowrap;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--gradient-primary);
            color: white;
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .btn-secondary:hover {
            border-color: var(--accent-primary);
        }

        .btn-success {
            background: var(--gradient-success);
            color: white;
        }

        .btn-danger {
            background: var(--accent-danger);
            color: white;
        }

        .btn-warning {
            background: var(--accent-warning);
            color: var(--bg-primary);
        }

        .btn-sm {
            padding: var(--spacing-xs) var(--spacing-md);
            font-size: 0.85rem;
        }

        .btn-lg {
            padding: var(--spacing-md) var(--spacing-xl);
            font-size: 1.1rem;
        }

        .btn-block {
            width: 100%;
        }

        .btn-icon {
            padding: var(--spacing-sm);
            width: 40px;
            height: 40px;
        }

        /* ===== FORMS ===== */
        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-md);
        }

        .form-actions {
            display: flex;
            gap: var(--spacing-md);
            margin-top: var(--spacing-lg);
        }

        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
            line-height: 1.5;
        }

        select.form-control {
            cursor: pointer;
        }

        .form-hint {
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-top: var(--spacing-xs);
        }

        .form-check {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-sm);
        }

        .form-check input {
            width: 18px;
            height: 18px;
            accent-color: var(--accent-primary);
        }

        /* ===== CARDS ===== */
        .card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .card-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .card-body {
            padding: var(--spacing-lg);
        }

        .card-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        /* ===== THEORIES SYSTEM ===== */
        .theories-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: var(--spacing-lg);
        }

        .theory-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
            transition: all var(--transition-normal);
            display: flex;
            flex-direction: column;
            height: 100%;
        }

        .theory-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .theory-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: var(--border-radius-full);
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: var(--spacing-md);
        }

        .status-draft { background: rgba(255, 214, 102, 0.1); color: var(--accent-warning); }
        .status-pending { background: rgba(0, 212, 255, 0.1); color: var(--accent-primary); }
        .status-approved { background: rgba(6, 214, 160, 0.1); color: var(--accent-success); }
        .status-rejected { background: rgba(255, 46, 99, 0.1); color: var(--accent-danger); }

        .theory-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--spacing-sm);
            color: var(--text-primary);
            line-height: 1.3;
        }

        .theory-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.85rem;
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
        }

        .theory-content {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-lg);
            flex: 1;
            overflow: hidden;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
        }

        .theory-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: auto;
        }

        /* Theory Editor */
        .editor-toolbar {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-bottom: none;
            border-radius: var(--border-radius-md) var(--border-radius-md) 0 0;
            padding: var(--spacing-md);
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-sm);
        }

        .editor-btn {
            background: var(--bg-quaternary);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
            padding: var(--spacing-sm) var(--spacing-md);
            border-radius: var(--border-radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: var(--spacing-xs);
            font-size: 0.9rem;
        }

        .editor-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
            border-color: var(--accent-primary);
        }

        .editor-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 0 0 var(--border-radius-md) var(--border-radius-md);
            min-height: 400px;
            padding: var(--spacing-lg);
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-primary);
            outline: none;
            overflow-y: auto;
        }

        .editor-content:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .editor-preview {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-lg);
            min-height: 200px;
            margin-top: var(--spacing-lg);
        }

        /* ===== CHAT SYSTEM ===== */
        .chat-container {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: var(--spacing-lg);
            height: 700px;
        }

        .chat-sidebar {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            display: flex;
            flex-direction: column;
        }

        .chat-search {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
        }

        .chat-channels {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-md);
        }

        .channel-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: var(--spacing-xs);
        }

        .channel-item:hover {
            background: var(--bg-tertiary);
        }

        .channel-item.active {
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.1), transparent);
            border-left: 3px solid var(--accent-primary);
        }

        .channel-icon {
            width: 20px;
            text-align: center;
            font-size: 1.1rem;
            color: var(--text-secondary);
        }

        .channel-item.active .channel-icon {
            color: var(--accent-primary);
        }

        .channel-info {
            flex: 1;
        }

        .channel-name {
            font-weight: 500;
            color: var(--text-primary);
        }

        .channel-topic {
            font-size: 0.85rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .channel-unread {
            background: var(--accent-danger);
            color: white;
            font-size: 0.75rem;
            padding: 2px 6px;
            border-radius: var(--border-radius-full);
            min-width: 20px;
            text-align: center;
        }

        .chat-main {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            display: flex;
            flex-direction: column;
        }

        .chat-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .chat-info {
            flex: 1;
        }

        .chat-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: 2px;
        }

        .chat-subtitle {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: var(--spacing-lg);
            display: flex;
            flex-direction: column;
            gap: var(--spacing-lg);
        }

        .message {
            max-width: 70%;
            animation: fadeIn 0.3s ease;
        }

        .message.own {
            align-self: flex-end;
        }

        .message-header {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-xs);
        }

        .message-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            object-fit: cover;
        }

        .message-author {
            font-weight: 600;
            color: var(--text-primary);
        }

        .message-time {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .message-content {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-md);
            position: relative;
        }

        .message.own .message-content {
            background: linear-gradient(135deg, rgba(0, 212, 255, 0.2), rgba(157, 78, 221, 0.2));
            border-color: var(--accent-primary);
        }

        .message-text {
            line-height: 1.5;
            word-break: break-word;
        }

        .message-actions {
            display: flex;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-sm);
            opacity: 0;
            transition: opacity var(--transition-fast);
        }

        .message:hover .message-actions {
            opacity: 1;
        }

        .chat-input-area {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            background: var(--bg-tertiary);
        }

        .chat-input-toolbar {
            display: flex;
            gap: var(--spacing-sm);
            margin-bottom: var(--spacing-md);
            flex-wrap: wrap;
        }

        .chat-input {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-md);
            color: var(--text-primary);
            font-size: 1rem;
            resize: none;
            min-height: 60px;
            width: 100%;
            outline: none;
            transition: all var(--transition-fast);
        }

        .chat-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .chat-input-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: var(--spacing-md);
        }

        /* ===== FORUM SYSTEM ===== */
        .forum-container {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: var(--spacing-lg);
        }

        .forum-categories {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
        }

        .category-item {
            display: flex;
            align-items: center;
            gap: var(--spacing-md);
            padding: var(--spacing-md);
            border-radius: var(--border-radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
            margin-bottom: var(--spacing-xs);
        }

        .category-item:hover {
            background: var(--bg-tertiary);
        }

        .category-item.active {
            background: linear-gradient(90deg, rgba(0, 212, 255, 0.1), transparent);
            border-left: 3px solid var(--accent-primary);
        }

        .forum-main {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
        }

        .forum-table {
            width: 100%;
            border-collapse: collapse;
        }

        .forum-table th {
            text-align: left;
            padding: var(--spacing-lg);
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
            font-weight: 600;
            font-size: 0.9rem;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .forum-table td {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            transition: all var(--transition-fast);
        }

        .forum-table tr:hover td {
            background: var(--bg-tertiary);
        }

        .forum-table tr:last-child td {
            border-bottom: none;
        }

        .topic-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--spacing-xs);
        }

        .topic-excerpt {
            font-size: 0.9rem;
            color: var(--text-secondary);
            line-height: 1.4;
        }

        .topic-meta {
            display: flex;
            gap: var(--spacing-md);
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* ===== PROFILE SYSTEM ===== */
        .profile-header {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
            position: relative;
            overflow: hidden;
        }

        .profile-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-primary);
        }

        .profile-main {
            display: grid;
            grid-template-columns: 200px 1fr;
            gap: var(--spacing-xl);
            align-items: start;
        }

        .profile-sidebar {
            position: sticky;
            top: var(--spacing-lg);
        }

        .profile-avatar {
            width: 200px;
            height: 200px;
            border-radius: var(--border-radius-lg);
            object-fit: cover;
            border: 4px solid var(--accent-primary);
            margin-bottom: var(--spacing-lg);
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .profile-avatar:hover {
            transform: scale(1.02);
            box-shadow: var(--shadow-lg);
        }

        .profile-stats {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-lg);
        }

        .stat-item {
            display: flex;
            justify-content: space-between;
            padding: var(--spacing-md) 0;
            border-bottom: 1px solid var(--border-color);
        }

        .stat-item:last-child {
            border-bottom: none;
        }

        .profile-content {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
        }

        .profile-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: var(--spacing-xl);
            overflow-x: auto;
        }

        .profile-tab {
            padding: var(--spacing-md) var(--spacing-lg);
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            white-space: nowrap;
            position: relative;
        }

        .profile-tab:hover {
            color: var(--text-primary);
        }

        .profile-tab.active {
            color: var(--accent-primary);
        }

        .profile-tab.active::after {
            content: '';
            position: absolute;
            bottom: -1px;
            left: 0;
            width: 100%;
            height: 2px;
            background: var(--gradient-primary);
            border-radius: var(--border-radius-full);
        }

        .profile-section {
            display: none;
        }

        .profile-section.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        /* ===== GROUPS SYSTEM ===== */
        .groups-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: var(--spacing-lg);
        }

        .group-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            overflow: hidden;
            transition: all var(--transition-normal);
        }

        .group-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: var(--accent-primary);
        }

        .group-banner {
            height: 120px;
            background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
            position: relative;
        }

        .group-avatar {
            width: 80px;
            height: 80px;
            border-radius: var(--border-radius-lg);
            border: 4px solid var(--bg-secondary);
            position: absolute;
            bottom: -40px;
            left: var(--spacing-lg);
            object-fit: cover;
            background: var(--bg-tertiary);
        }

        .group-info {
            padding: var(--spacing-xl) var(--spacing-lg) var(--spacing-lg);
            margin-top: 40px;
        }

        .group-title {
            font-size: 1.25rem;
            font-weight: 700;
            margin-bottom: var(--spacing-xs);
            color: var(--text-primary);
        }

        .group-description {
            color: var(--text-secondary);
            margin-bottom: var(--spacing-md);
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .group-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--text-muted);
            margin-bottom: var(--spacing-lg);
        }

        .group-actions {
            display: flex;
            gap: var(--spacing-sm);
        }

        /* ===== SEARCH SYSTEM ===== */
        .search-container {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            padding: var(--spacing-xl);
            margin-bottom: var(--spacing-xl);
        }

        .search-box {
            display: flex;
            gap: var(--spacing-md);
            margin-bottom: var(--spacing-lg);
        }

        .search-input {
            flex: 1;
            padding: var(--spacing-md) var(--spacing-lg);
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            font-size: 1rem;
            outline: none;
            transition: all var(--transition-fast);
        }

        .search-input:focus {
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 3px rgba(0, 212, 255, 0.1);
        }

        .search-filters {
            display: flex;
            gap: var(--spacing-md);
            flex-wrap: wrap;
        }

        .filter-group {
            display: flex;
            align-items: center;
            gap: var(--spacing-sm);
        }

        .filter-label {
            color: var(--text-secondary);
            font-size: 0.9rem;
        }

        .filter-select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            padding: var(--spacing-sm) var(--spacing-md);
            color: var(--text-primary);
            font-size: 0.9rem;
            cursor: pointer;
            outline: none;
            transition: all var(--transition-fast);
        }

        .filter-select:focus {
            border-color: var(--accent-primary);
        }

        .search-results {
            display: grid;
            gap: var(--spacing-lg);
        }

        /* ===== MODALS ===== */
        .modal-backdrop {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: var(--spacing-lg);
            backdrop-filter: blur(4px);
            animation: fadeIn 0.3s ease;
        }

        .modal {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-lg);
            width: 100%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            animation: modalIn 0.3s ease;
            box-shadow: var(--shadow-xl);
        }

        .modal-lg {
            max-width: 800px;
        }

        .modal-xl {
            max-width: 1000px;
        }

        .modal-header {
            padding: var(--spacing-lg);
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            font-size: 1.5rem;
            cursor: pointer;
            padding: var(--spacing-xs);
            border-radius: var(--border-radius-sm);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-close:hover {
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-primary);
        }

        .modal-body {
            padding: var(--spacing-lg);
        }

        .modal-footer {
            padding: var(--spacing-lg);
            border-top: 1px solid var(--border-color);
            background: var(--bg-tertiary);
            display: flex;
            justify-content: flex-end;
            gap: var(--spacing-md);
        }

        @keyframes modalIn {
            from {
                opacity: 0;
                transform: translateY(-20px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* ===== PAGINATION ===== */
        .pagination {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: var(--spacing-sm);
            margin-top: var(--spacing-xl);
        }

        .page-item {
            min-width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-md);
            color: var(--text-primary);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
        }

        .page-item:hover {
            background: var(--bg-secondary);
            border-color: var(--accent-primary);
        }

        .page-item.active {
            background: var(--gradient-primary);
            border-color: transparent;
            color: white;
        }

        .page-item.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .page-item.disabled:hover {
            background: var(--bg-tertiary);
            border-color: var(--border-color);
        }

        /* ===== BADGES ===== */
        .badge {
            display: inline-block;
            padding: 4px 8px;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: var(--border-radius-full);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-primary {
            background: rgba(0, 212, 255, 0.1);
            color: var(--accent-primary);
        }

        .badge-secondary {
            background: rgba(157, 78, 221, 0.1);
            color: var(--accent-secondary);
        }

        .badge-success {
            background: rgba(6, 214, 160, 0.1);
            color: var(--accent-success);
        }

        .badge-danger {
            background: rgba(255, 46, 99, 0.1);
            color: var(--accent-danger);
        }

        .badge-warning {
            background: rgba(255, 214, 102, 0.1);
            color: var(--accent-warning);
        }

        /* ===== TAGS ===== */
        .tags {
            display: flex;
            flex-wrap: wrap;
            gap: var(--spacing-xs);
            margin: var(--spacing-md) 0;
        }

        .tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius-full);
            font-size: 0.85rem;
            color: var(--text-secondary);
            transition: all var(--transition-fast);
        }

        .tag:hover {
            background: var(--bg-quaternary);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        .tag-remove {
            background: none;
            border: none;
            color: inherit;
            cursor: pointer;
            padding: 0;
            font-size: 0.9rem;
            opacity: 0.7;
            transition: opacity var(--transition-fast);
        }

        .tag-remove:hover {
            opacity: 1;
        }

        /* ===== UTILITY CLASSES ===== */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .text-muted { color: var(--text-muted); }
        .text-primary { color: var(--text-primary); }
        .text-success { color: var(--accent-success); }
        .text-danger { color: var(--accent-danger); }
        .text-warning { color: var(--accent-warning); }

        .mb-0 { margin-bottom: 0; }
        .mb-1 { margin-bottom: var(--spacing-xs); }
        .mb-2 { margin-bottom: var(--spacing-sm); }
        .mb-3 { margin-bottom: var(--spacing-md); }
        .mb-4 { margin-bottom: var(--spacing-lg); }
        .mb-5 { margin-bottom: var(--spacing-xl); }

        .mt-0 { margin-top: 0; }
        .mt-1 { margin-top: var(--spacing-xs); }
        .mt-2 { margin-top: var(--spacing-sm); }
        .mt-3 { margin-top: var(--spacing-md); }
        .mt-4 { margin-top: var(--spacing-lg); }
        .mt-5 { margin-top: var(--spacing-xl); }

        .d-flex { display: flex; }
        .d-inline-flex { display: inline-flex; }
        .flex-column { flex-direction: column; }
        .align-items-center { align-items: center; }
        .justify-content-center { justify-content: center; }
        .justify-content-between { justify-content: space-between; }
        .flex-wrap { flex-wrap: wrap; }

        .w-100 { width: 100%; }
        .h-100 { height: 100%; }

        .position-relative { position: relative; }
        .position-absolute { position: absolute; }
        .position-sticky { position: sticky; }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1200px) {
            .chat-container,
            .forum-container {
                grid-template-columns: 1fr;
                height: auto;
            }
            
            .chat-sidebar {
                height: 300px;
            }
        }

        @media (max-width: 992px) {
            .profile-main {
                grid-template-columns: 1fr;
            }
            
            .profile-sidebar {
                position: static;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            #dashboard {
                grid-template-columns: 1fr;
            }
            
            #sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                width: 280px;
                height: 100vh;
                z-index: 100;
                box-shadow: var(--shadow-xl);
                transition: transform var(--transition-normal);
            }
            
            #sidebar.active {
                transform: translateX(280px);
            }
            
            .mobile-menu-toggle {
                display: flex;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .theories-grid,
            .groups-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .auth-container {
                padding: var(--spacing-lg);
                margin: var(--spacing-lg);
            }
            
            h1 {
                font-size: 2rem;
            }
            
            h2 {
                font-size: 1.5rem;
            }
        }

        @media (max-width: 576px) {
            .container {
                padding: 0 var(--spacing-md);
            }
            
            .message {
                max-width: 90%;
            }
            
            .btn {
                padding: var(--spacing-sm) var(--spacing-md);
            }
            
            .modal {
                margin: var(--spacing-md);
            }
        }

        /* ===== ANIMATIONS ===== */
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }

        .pulse {
            animation: pulse 2s infinite;
        }

        @keyframes float {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }

        .float {
            animation: float 3s ease-in-out infinite;
        }

        /* ===== CUSTOM SCROLLBAR ===== */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-tertiary);
            border-radius: var(--border-radius-full);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--accent-primary);
            border-radius: var(--border-radius-full);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--accent-secondary);
        }

        /* ===== PRINT STYLES ===== */
        @media print {
            #sidebar,
            .mobile-menu-toggle,
            .btn,
            .chat-input-area {
                display: none !important;
            }
            
            #dashboard {
                grid-template-columns: 1fr;
            }
            
            #mainContent {
                padding: 0;
            }
            
            body {
                background: white;
                color: black;
            }
        }

        /* ===== ACCESSIBILITY ===== */
        .sr-only {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border: 0;
        }

        :focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }

        /* ===== DARK/LIGHT MODE SUPPORT ===== */
        @media (prefers-color-scheme: light) {
            :root {
                --bg-primary: #ffffff;
                --bg-secondary: #f8f9fa;
                --bg-tertiary: #e9ecef;
                --bg-quaternary: #dee2e6;
                --text-primary: #212529;
                --text-secondary: #495057;
                --text-muted: #6c757d;
                --border-color: #ced4da;
                --border-light: #dee2e6;
            }
        }
    </style>
</head>
<body>
    <!-- Toast Notifications Container -->
    <div id="toastContainer"></div>

    <!-- Mobile Menu Toggle -->
    <button class="mobile-menu-toggle" id="mobileMenuToggle">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Authentication Screen -->
    <div id="authScreen">
        <div class="auth-background"></div>
        <div class="auth-container">
            <div class="auth-header">
                <div class="auth-logo">
                    <i class="fas fa-atom"></i> RENOVA
                </div>
                <p class="auth-subtitle">Plataforma Científica Radical • Desafiando os Limites da Matemática</p>
            </div>

            <div class="auth-tabs">
                <button class="auth-tab active" onclick="switchAuthTab('login')">Entrar</button>
                <button class="auth-tab" onclick="switchAuthTab('register')">Registrar</button>
                <button class="auth-tab" onclick="switchAuthTab('recovery')">Recuperar</button>
            </div>

            <!-- Login Form -->
            <form id="loginForm" class="auth-form active" onsubmit="event.preventDefault(); login();">
                <div class="form-group">
                    <label class="form-label" for="loginUsername">Usuário ou Email</label>
                    <input type="text" id="loginUsername" class="form-control" required placeholder="einstein@renova.math">
                    <div class="form-error" id="loginUsernameError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="loginPassword">Senha</label>
                    <input type="password" id="loginPassword" class="form-control" required placeholder="••••••••">
                    <div class="form-error" id="loginPasswordError"></div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="loginMasterKey">MASTER_KEY (opcional - para núcleo)</label>
                    <input type="password" id="loginMasterKey" class="form-control" placeholder="Renova, O Non Trad">
                    <div class="form-hint">Acesso ao núcleo científico radical</div>
                </div>

                <div class="form-check">
                    <input type="checkbox" id="rememberMe">
                    <label for="rememberMe">Lembrar-me</label>
                </div>

                <button type="submit" class="auth-button" id="loginButton">
                    <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                </button>
            </form>

            <!-- Register Form -->
            <form id="registerForm" class="auth-form" onsubmit="event.preventDefault(); register();">
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="registerUsername">Nome de Usuário*</label>
                        <input type="text" id="registerUsername" class="form-control" required placeholder="einstein">
                        <div class="form-error" id="registerUsernameError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerEmail">Email*</label>
                        <input type="email" id="registerEmail" class="form-control" required placeholder="einstein@renova.math">
                        <div class="form-error" id="registerEmailError"></div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" for="registerPassword">Senha*</label>
                        <input type="password" id="registerPassword" class="form-control" required placeholder="••••••••">
                        <div class="form-error" id="registerPasswordError"></div>
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="registerConfirmPassword">Confirmar Senha*</label>
                        <input type="password" id="registerConfirmPassword" class="form-control" required placeholder="••••••••">
                        <div class="form-error" id="registerConfirmPasswordError"></div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerMasterKey">MASTER_KEY (opcional)</label>
                    <input type="password" id="registerMasterKey" class="form-control" placeholder="Renova, O Non Trad">
                    <div class="form-hint">Para acesso imediato ao núcleo científico</div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="registerSpecialization">Área de Especialização</label>
                    <select id="registerSpecialization" class="form-control">
                        <option value="">Selecione sua área</option>
                        <option value="mathematics">Matemática Pura</option>
                        <option value="physics">Física Teórica</option>
                        <option value="computer">Ciência da Computação</option>
                        <option value="engineering">Engenharia</option>
                        <option value="biology">Biologia Matemática</option>
                        <option value="other">Outra</option>
                    </select>
                </div>

                <div class="form-check">
                    <input type="checkbox" id="termsAgreement" required>
                    <label for="termsAgreement">Concordo com os Termos de Serviço e Política de Privacidade</label>
                </div>

                <button type="submit" class="auth-button" id="registerButton">
                    <i class="fas fa-user-plus"></i> Criar Conta Científica
                </button>
            </form>

            <!-- Recovery Form -->
            <form id="recoveryForm" class="auth-form" onsubmit="event.preventDefault(); recoverPassword();">
                <div class="form-group">
                    <label class="form-label" for="recoveryEmail">Email da Conta</label>
                    <input type="email" id="recoveryEmail" class="form-control" required placeholder="seu@email.com">
                    <div class="form-error" id="recoveryEmailError"></div>
                </div>

                <div class="form-hint">
                    Enviaremos um link de recuperação para seu email. O link expira em 1 hora.
                </div>

                <button type="submit" class="auth-button" id="recoveryButton">
                    <i class="fas fa-key"></i> Recuperar Senha
                </button>
            </form>

            <div class="auth-footer">
                <div class="auth-theme-selector">
                    <div class="theme-option theme-dark active" onclick="setTheme('dark')" title="Tema Escuro"></div>
                    <div class="theme-option theme-blue" onclick="setTheme('blue')" title="Tema Azul"></div>
                    <div class="theme-option theme-green" onclick="setTheme('green')" title="Tema Verde"></div>
                    <div class="theme-option theme-purple" onclick="setTheme('purple')" title="Tema Roxo"></div>
                    <div class="theme-option theme-matrix" onclick="setTheme('matrix')" title="Tema Matrix"></div>
                </div>
                <p>Sistema Renova v4.0 • Desafiando os 7 Problemas do Milênio</p>
                <p><a href="#" onclick="showAboutModal()">Sobre o Projeto</a> • <a href="#" onclick="showPrivacyModal()">Privacidade</a></p>
            </div>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
        <!-- Sidebar -->
        <aside id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-logo">RENOVA</div>
                <div class="user-profile-mini">
                    <img id="sidebarAvatar" class="user-avatar" src="" alt="Avatar">
                    <div class="user-info-mini">
                        <div class="user-name" id="sidebarUsername"></div>
                        <div class="user-status">
                            <span class="status-dot" id="sidebarStatusDot"></span>
                            <span id="sidebarStatusText">Online</span>
                        </div>
                    </div>
                </div>
            </div>

            <nav class="sidebar-nav">
                <div class="nav-section">
                    <div class="nav-title">Principal</div>
                    <a class="nav-item active" onclick="loadSection('dashboard-home')">
                        <div class="nav-icon"><i class="fas fa-home"></i></div>
                        <div class="nav-label">Dashboard</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('theories')">
                        <div class="nav-icon"><i class="fas fa-book"></i></div>
                        <div class="nav-label">Teorias</div>
                        <div class="nav-badge hidden" id="badgeTheories">0</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('research')">
                        <div class="nav-icon"><i class="fas fa-flask"></i></div>
                        <div class="nav-label">Pesquisa</div>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Colaboração</div>
                    <a class="nav-item" onclick="loadSection('chat')">
                        <div class="nav-icon"><i class="fas fa-comments"></i></div>
                        <div class="nav-label">Chat Global</div>
                        <div class="nav-badge hidden" id="badgeChat">0</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('forum')">
                        <div class="nav-icon"><i class="fas fa-comment-dots"></i></div>
                        <div class="nav-label">Fórum</div>
                        <div class="nav-badge hidden" id="badgeForum">0</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('groups')">
                        <div class="nav-icon"><i class="fas fa-users"></i></div>
                        <div class="nav-label">Grupos</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('collaborations')">
                        <div class="nav-icon"><i class="fas fa-handshake"></i></div>
                        <div class="nav-label">Colaborações</div>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Rede</div>
                    <a class="nav-item" onclick="loadSection('friends')">
                        <div class="nav-icon"><i class="fas fa-user-friends"></i></div>
                        <div class="nav-label">Amigos</div>
                        <div class="nav-badge hidden" id="badgeFriends">0</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('messages')">
                        <div class="nav-icon"><i class="fas fa-envelope"></i></div>
                        <div class="nav-label">Mensagens</div>
                        <div class="nav-badge hidden" id="badgeMessages">0</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('notifications')">
                        <div class="nav-icon"><i class="fas fa-bell"></i></div>
                        <div class="nav-label">Notificações</div>
                        <div class="nav-badge hidden" id="badgeNotifications">0</div>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Sistema</div>
                    <a class="nav-item" onclick="loadSection('profile')">
                        <div class="nav-icon"><i class="fas fa-user"></i></div>
                        <div class="nav-label">Perfil</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('files')">
                        <div class="nav-icon"><i class="fas fa-folder"></i></div>
                        <div class="nav-label">Arquivos</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('settings')">
                        <div class="nav-icon"><i class="fas fa-cog"></i></div>
                        <div class="nav-label">Configurações</div>
                    </a>
                    <a class="nav-item hidden" id="navAdmin" onclick="loadSection('admin')">
                        <div class="nav-icon"><i class="fas fa-shield-alt"></i></div>
                        <div class="nav-label">Administração</div>
                    </a>
                </div>

                <div class="nav-section">
                    <div class="nav-title">Problemas do Milênio</div>
                    <a class="nav-item" onclick="loadSection('millennium-p')">
                        <div class="nav-icon"><i class="fas fa-trophy"></i></div>
                        <div class="nav-label">P vs NP</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('millennium-h')">
                        <div class="nav-icon"><i class="fas fa-trophy"></i></div>
                        <div class="nav-label">Hodge</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('millennium-r')">
                        <div class="nav-icon"><i class="fas fa-trophy"></i></div>
                        <div class="nav-label">Riemann</div>
                    </a>
                    <a class="nav-item" onclick="loadSection('millennium-y')">
                        <div class="nav-icon"><i class="fas fa-trophy"></i></div>
                        <div class="nav-label">Yang-Mills</div>
                    </a>
                </div>
            </nav>

            <div class="online-users">
                <div class="online-title">
                    <span>Online Agora</span>
                    <span class="online-count" id="onlineCount">0</span>
                </div>
                <div class="online-list" id="onlineList">
                    <!-- Online users loaded dynamically -->
                </div>
            </div>

            <div class="sidebar-footer" style="padding: var(--spacing-lg); border-top: 1px solid var(--border-color);">
                <select id="statusSelector" class="form-control" style="margin-bottom: var(--spacing-sm);">
                    <option value="online">🟢 Online</option>
                    <option value="away">🟡 Ausente</option>
                    <option value="dnd">🔴 Não Perturbe</option>
                    <option value="offline">⚫ Offline</option>
                </select>
                <button class="btn btn-danger btn-block" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Sair
                </button>
            </div>
        </aside>

        <!-- Main Content -->
        <main id="mainContent">
            <!-- Content loaded dynamically -->
        </main>
    </div>

    <!-- Modals -->
    <div id="aboutModal" class="modal-backdrop hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Sobre o Renova</div>
                <button class="modal-close" onclick="hideModal('aboutModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <h3>Plataforma Científica Radical</h3>
                <p>O Renova é uma plataforma colaborativa projetada para atacar os problemas mais difíceis da matemática e ciências, incluindo os 7 Problemas do Milênio do Instituto Clay.</p>
                
                <h4>Missão</h4>
                <p>Quebrar paradigmas estabelecidos, desenvolver novas áreas da matemática e criar ferramentas para resolver problemas considerados insolúveis.</p>
                
                <h4>Recursos Principais</h4>
                <ul>
                    <li>Sistema colaborativo de teorias matemáticas</li>
                    <li>Chat com suporte completo a LaTeX</li>
                    <li>Fóruns especializados por área</li>
                    <li>Grupos de pesquisa colaborativa</li>
                    <li>Sistema de versionamento de teorias</li>
                    <li>Integração com repositórios científicos</li>
                </ul>
                
                <h4>Versão 4.0</h4>
                <p>Sistema completamente reconstruído com persistência total, interface moderna e todas as funcionalidades operacionais.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('aboutModal')">Fechar</button>
            </div>
        </div>
    </div>

    <div id="privacyModal" class="modal-backdrop hidden">
        <div class="modal">
            <div class="modal-header">
                <div class="modal-title">Política de Privacidade</div>
                <button class="modal-close" onclick="hideModal('privacyModal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <h3>Compromisso com a Privacidade</h3>
                <p>Todos os dados são armazenados localmente no seu navegador. Nenhuma informação é enviada para servidores externos.</p>
                
                <h4>Armazenamento Local</h4>
                <p>Usamos localStorage do navegador para persistir:
                <ul>
                    <li>Dados de usuário (criptografados)</li>
                    <li>Teorias e pesquisas</li>
                    <li>Mensagens e conversas</li>
                    <li>Preferências de interface</li>
                </ul>
                
                <h4>Exportação de Dados</h4>
                <p>Você pode exportar todos os seus dados a qualquer momento através da seção de Configurações.</p>
                
                <h4>Open Source</h4>
                <p>O código do Renova é aberto e auditável. Qualquer um pode verificar como os dados são tratados.</p>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="hideModal('privacyModal')">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="modal-backdrop hidden">
        <div class="modal" style="max-width: 300px; background: transparent; border: none; box-shadow: none;">
            <div class="modal-body text-center">
                <div class="spinner"></div>
                <div class="mt-3" id="loadingText">Carregando...</div>
            </div>
        </div>
    </div>

// ============================================
// ADICIONE ESTAS FUNÇÕES NO FINAL DO SEU ARQUIVO
// ANTES DA TAG </script>
// ============================================

// 1. PÁGINA DE CONFIGURAÇÕES (COMPLETA)
window.renderSettingsPage = async function() {
    const user = AppState.users[AppState.currentUser];
    
    return `
        <div class="content-header">
            <h1>Configurações</h1>
            <p class="subtitle">Personalize sua experiência no Renova</p>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Preferências</h3>
                    </div>
                    <div class="card-body">
                        <form id="systemSettingsForm">
                            <div class="form-group">
                                <label class="form-label">Tema</label>
                                <div class="d-flex gap-3 flex-wrap">
                                    <div class="theme-option theme-dark ${AppState.theme === 'dark' ? 'active' : ''}" 
                                         onclick="setTheme('dark')" title="Tema Escuro"></div>
                                    <div class="theme-option theme-blue ${AppState.theme === 'blue' ? 'active' : ''}" 
                                         onclick="setTheme('blue')" title="Tema Azul"></div>
                                    <div class="theme-option theme-green ${AppState.theme === 'green' ? 'active' : ''}" 
                                         onclick="setTheme('green')" title="Tema Verde"></div>
                                    <div class="theme-option theme-purple ${AppState.theme === 'purple' ? 'active' : ''}" 
                                         onclick="setTheme('purple')" title="Tema Roxo"></div>
                                    <div class="theme-option theme-matrix ${AppState.theme === 'matrix' ? 'active' : ''}" 
                                         onclick="setTheme('matrix')" title="Tema Matrix"></div>
                                </div>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="systemAutosave" 
                                       ${AppState.settings.autosave !== false ? 'checked' : ''}>
                                <label class="form-check-label" for="systemAutosave">
                                    Auto-salvar dados
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="systemNotifications" 
                                       ${AppState.settings.notifications !== false ? 'checked' : ''}>
                                <label class="form-check-label" for="systemNotifications">
                                    Notificações do sistema
                                </label>
                            </div>
                            
                            <div class="form-check mb-3">
                                <input type="checkbox" class="form-check-input" id="systemLatex" 
                                       ${AppState.settings.latexEnabled !== false ? 'checked' : ''}>
                                <label class="form-check-label" for="systemLatex">
                                    Habilitar LaTeX automático
                                </label>
                            </div>
                            
                            <div class="form-group mb-3">
                                <label class="form-label">Idioma</label>
                                <select class="form-control" id="systemLanguage">
                                    <option value="pt-BR" ${AppState.settings.language === 'pt-BR' ? 'selected' : ''}>Português (Brasil)</option>
                                    <option value="en" ${AppState.settings.language === 'en' ? 'selected' : ''}>English</option>
                                    <option value="es" ${AppState.settings.language === 'es' ? 'selected' : ''}>Español</option>
                                </select>
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="saveSystemSettings()">
                                    <i class="fas fa-save"></i> Salvar Configurações
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="mb-0">Gerenciamento de Dados</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex flex-wrap gap-3">
                            <button class="btn btn-primary" onclick="StorageSystem.exportData()">
                                <i class="fas fa-download"></i> Exportar Dados
                            </button>
                            <button class="btn btn-secondary" onclick="importData()">
                                <i class="fas fa-upload"></i> Importar Dados
                            </button>
                            <button class="btn btn-warning" onclick="StorageSystem.createBackup()">
                                <i class="fas fa-copy"></i> Criar Backup
                            </button>
                            <button class="btn btn-danger" onclick="StorageSystem.clearAllData()">
                                <i class="fas fa-trash"></i> Limpar Todos os Dados
                            </button>
                        </div>
                        
                        <div class="mt-4">
                            <h5>Informações do Sistema</h5>
                            <ul class="list-unstyled">
                                <li><strong>Versão:</strong> ${RENOVA_CONFIG.VERSION}</li>
                                <li><strong>Usuários:</strong> ${Object.keys(AppState.users).length}</li>
                                <li><strong>Teorias:</strong> ${AppState.theories.length}</li>
                                <li><strong>Posts no Fórum:</strong> ${AppState.forumPosts.length}</li>
                                <li><strong>Grupos:</strong> ${Object.keys(AppState.groups).length}</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Ajuda</h3>
                    </div>
                    <div class="card-body">
                        <h5>Atalhos de Teclado</h5>
                        <ul class="list-unstyled small">
                            <li><kbd>Ctrl + Enter</kbd>: Enviar mensagem</li>
                            <li><kbd>Ctrl + S</kbd>: Salvar teoria</li>
                            <li><kbd>Ctrl + F</kbd>: Buscar</li>
                            <li><kbd>Esc</kbd>: Fechar modal</li>
                        </ul>
                        
                        <h5 class="mt-4">Suporte</h5>
                        <p class="small">
                            Sistema Renova v${RENOVA_CONFIG.VERSION}<br>
                            Todos os dados são armazenados localmente no seu navegador.
                        </p>
                        
                        <div class="mt-4">
                            <button class="btn btn-sm btn-info btn-block" onclick="showAboutModal()">
                                <i class="fas fa-info-circle"></i> Sobre o Renova
                            </button>
                            <button class="btn btn-sm btn-info btn-block mt-2" onclick="showPrivacyModal()">
                                <i class="fas fa-shield-alt"></i> Política de Privacidade
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="mb-0">Segurança</h3>
                    </div>
                    <div class="card-body">
                        <div class="form-group">
                            <label class="form-label">Alterar Senha</label>
                            <input type="password" class="form-control mb-2" id="changePasswordCurrent" 
                                   placeholder="Senha atual">
                            <input type="password" class="form-control mb-2" id="changePasswordNew" 
                                   placeholder="Nova senha">
                            <input type="password" class="form-control mb-2" id="changePasswordConfirm" 
                                   placeholder="Confirmar nova senha">
                            <button class="btn btn-warning btn-block" onclick="changePassword()">
                                <i class="fas fa-key"></i> Alterar Senha
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
};

// 2. PÁGINA DE ADMINISTRAÇÃO (COMPLETA)
window.renderAdminPage = async function() {
    if (!AppState.isNucleo) {
        return `
            <div class="content-header">
                <h1>Acesso Negado</h1>
                <p class="subtitle">Área restrita ao Núcleo Científico</p>
            </div>
            
            <div class="card">
                <div class="card-body">
                    <div class="text-center py-5">
                        <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                        <h4 class="text-danger">Acesso Restrito</h4>
                        <p class="text-muted">Esta área é exclusiva para membros do Núcleo Científico.</p>
                        <p class="text-muted">Para acessar, utilize a MASTER_KEY durante o login.</p>
                    </div>
                </div>
            </div>
        `;
    }
    
    const pendingTheories = TheorySystem.getPendingTheories();
    const allUsers = Object.values(AppState.users);
    
    return `
        <div class="content-header">
            <h1>Administração</h1>
            <p class="subtitle">Painel de controle do Núcleo Científico</p>
        </div>
        
        <div class="row">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Teorias Pendentes</h3>
                        <span class="badge badge-warning">${pendingTheories.length}</span>
                    </div>
                    <div class="card-body">
                        ${pendingTheories.length > 0 ? `
                            <div class="table-responsive">
                                <table class="table">
                                    <thead>
                                        <tr>
                                            <th>Título</th>
                                            <th>Autor</th>
                                            <th>Data</th>
                                            <th>Ações</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${pendingTheories.map(theory => {
                                            const author = AppState.users[theory.author];
                                            return `
                                                <tr>
                                                    <td>
                                                        <strong>${theory.title}</strong><br>
                                                        <small class="text-muted">${theory.category}</small>
                                                    </td>
                                                    <td>
                                                        <div class="d-flex align-items-center gap-2">
                                                            <img src="${author?.profile?.avatar || ''}" 
                                                                 style="width: 30px; height: 30px; border-radius: 50%;"
                                                                 alt="${author?.username || 'Desconhecido'}">
                                                            <span>${author?.username || 'Desconhecido'}</span>
                                                        </div>
                                                    </td>
                                                    <td>${UISystem.formatDate(theory.createdAt)}</td>
                                                    <td>
                                                        <div class="btn-group">
                                                            <button class="btn btn-sm btn-primary" onclick="viewTheory('${theory.id}')">
                                                                <i class="fas fa-eye"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-success" onclick="approveTheory('${theory.id}')">
                                                                <i class="fas fa-check"></i>
                                                            </button>
                                                            <button class="btn btn-sm btn-danger" onclick="rejectTheoryPrompt('${theory.id}')">
                                                                <i class="fas fa-times"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        ` : `
                            <div class="text-center py-4">
                                <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                                <h5 class="text-success">Nenhuma teoria pendente</h5>
                                <p class="text-muted">Todas as teorias foram revisadas.</p>
                            </div>
                        `}
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="mb-0">Estatísticas do Sistema</h3>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 class="text-primary">${allUsers.length}</h3>
                                        <p class="text-muted mb-0">Usuários</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 class="text-success">${AppState.theories.length}</h3>
                                        <p class="text-muted mb-0">Teorias</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 class="text-warning">${AppState.forumPosts.length}</h3>
                                        <p class="text-muted mb-0">Posts</p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-3 mb-3">
                                <div class="card">
                                    <div class="card-body">
                                        <h3 class="text-info">${Object.keys(AppState.groups).length}</h3>
                                        <p class="text-muted mb-0">Grupos</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="col-md-4">
                <div class="card">
                    <div class="card-header">
                        <h3 class="mb-0">Ferramentas de Administração</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-primary" onclick="showUserManagement()">
                                <i class="fas fa-users"></i> Gerenciar Usuários
                            </button>
                            <button class="btn btn-secondary" onclick="showSystemLogs()">
                                <i class="fas fa-clipboard-list"></i> Logs do Sistema
                            </button>
                            <button class="btn btn-warning" onclick="showBackupManagement()">
                                <i class="fas fa-database"></i> Gerenciar Backups
                            </button>
                            <button class="btn btn-danger" onclick="clearAllSystemData()">
                                <i class="fas fa-broom"></i> Limpar Sistema
                            </button>
                        </div>
                        
                        <hr class="my-4">
                        
                        <h5>Status do Sistema</h5>
                        <ul class="list-unstyled small">
                            <li><span class="badge badge-success">Online</span> Sistema operacional</li>
                            <li><span class="badge badge-success">${allUsers.filter(u => u.status === 'online').length} online</span> Usuários ativos</li>
                            <li><span class="badge badge-primary">${allUsers.filter(u => u.nucleo).length}</span> Membros do Núcleo</li>
                        </ul>
                    </div>
                </div>
                
                <div class="card mt-4">
                    <div class="card-header">
                        <h3 class="mb-0">Ações Rápidas</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-grid gap-2">
                            <button class="btn btn-sm btn-outline-primary" onclick="promoteUserToNucleo()">
                                <i class="fas fa-star"></i> Promover Usuário
                            </button>
                            <button class="btn btn-sm btn-outline-warning" onclick="sendSystemAnnouncement()">
                                <i class="fas fa-bullhorn"></i> Anúncio do Sistema
                            </button>
                            <button class="btn btn-sm btn-outline-info" onclick="runSystemDiagnostics()">
                                <i class="fas fa-stethoscope"></i> Diagnóstico
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    `;
};

// 3. PÁGINA DE PERFIL (VERSÃO MELHORADA)
window.renderProfilePage = async function() {
    const user = AppState.users[AppState.currentUser];
    const theories = TheorySystem.getUserTheories(AppState.currentUser);
    const friends = FriendSystem.getFriends(AppState.currentUser);
    
    return `
        <div class="content-header">
            <h1>Meu Perfil</h1>
            <p class="subtitle">Gerencie suas informações pessoais</p>
        </div>
        
        <div class="profile-header">
            <div class="profile-main">
                <div class="profile-sidebar">
                    <img src="${user.profile.avatar}" class="profile-avatar" alt="${user.username}"
                         onclick="changeProfileAvatar()" style="cursor: pointer;">
                    
                    <div class="text-center mb-4">
                        <h3>${user.username}</h3>
                        <p class="text-muted">${user.profile.specialization || 'Sem especialização'}</p>
                        <div class="badge ${AppState.isNucleo ? 'badge-primary' : 'badge-secondary'}">
                            ${AppState.isNucleo ? 'Membro do Núcleo' : 'Membro'}
                        </div>
                    </div>
                    
                    <div class="profile-stats">
                        <div class="stat-item">
                            <span>Teorias</span>
                            <span>${theories.length}</span>
                        </div>
                        <div class="stat-item">
                            <span>Posts</span>
                            <span>${user.stats.posts || 0}</span>
                        </div>
                        <div class="stat-item">
                            <span>Amigos</span>
                            <span>${friends.length}</span>
                        </div>
                        <div class="stat-item">
                            <span>Reputação</span>
                            <span>${user.stats.reputation || 0}</span>
                        </div>
                    </div>
                </div>
                
                <div class="profile-content">
                    <div class="profile-tabs">
                        <button class="profile-tab active" onclick="switchProfileTab('info')">Informações</button>
                        <button class="profile-tab" onclick="switchProfileTab('theories')">Minhas Teorias</button>
                        <button class="profile-tab" onclick="switchProfileTab('friends')">Amigos</button>
                        <button class="profile-tab" onclick="switchProfileTab('security')">Segurança</button>
                    </div>
                    
                    <div class="profile-section active" id="profileInfoSection">
                        <form id="profileInfoForm">
                            <div class="form-group">
                                <label class="form-label">Nome de Usuário</label>
                                <input type="text" class="form-control" value="${user.username}" disabled>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Email</label>
                                <input type="email" class="form-control" value="${user.email}" disabled>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Biografia</label>
                                <textarea class="form-control" id="profileBio" rows="3">${user.profile.bio || ''}</textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Especialização</label>
                                    <select class="form-control" id="profileSpecialization">
                                        <option value="">Selecione</option>
                                        <option value="mathematics" ${user.profile.specialization === 'mathematics' ? 'selected' : ''}>Matemática</option>
                                        <option value="physics" ${user.profile.specialization === 'physics' ? 'selected' : ''}>Física</option>
                                        <option value="computer" ${user.profile.specialization === 'computer' ? 'selected' : ''}>Computação</option>
                                        <option value="biology" ${user.profile.specialization === 'biology' ? 'selected' : ''}>Biologia</option>
                                        <option value="engineering" ${user.profile.specialization === 'engineering' ? 'selected' : ''}>Engenharia</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Localização</label>
                                    <input type="text" class="form-control" id="profileLocation" 
                                           value="${user.profile.location || ''}">
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Website</label>
                                <input type="url" class="form-control" id="profileWebsite" 
                                       value="${user.profile.website || ''}">
                            </div>
                            
                            <div class="form-actions">
                                <button type="button" class="btn btn-primary" onclick="saveProfileInfo()">
                                    <i class="fas fa-save"></i> Salvar Alterações
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <div class="profile-section" id="profileTheoriesSection">
                        ${theories.length > 0 ? `
                            <div class="list-group">
                                ${theories.map(theory => `
                                    <div class="list-group-item d-flex justify-content-between align-items-center">
                                        <div>
                                            <div class="font-weight-bold">${theory.title}</div>
                                            <small class="text-muted">
                                                Status: <span class="badge ${theory.status === 'approved' ? 'badge-success' : 
                                                                          theory.status === 'pending' ? 'badge-warning' : 
                                                                          theory.status === 'rejected' ? 'badge-danger' : 'badge-secondary'}">
                                                    ${theory.status === 'approved' ? 'Aprovada' :
                                                      theory.status === 'pending' ? 'Pendente' :
                                                      theory.status === 'rejected' ? 'Rejeitada' : 'Rascunho'}
                                                </span>
                                                • ${UISystem.formatDate(theory.createdAt)}
                                            </small>
                                        </div>
                                        <div class="btn-group">
                                            <button class="btn btn-sm btn-primary" onclick="viewTheory('${theory.id}')">
                                                <i class="fas fa-eye"></i>
                                            </button>
                                            <button class="btn btn-sm btn-secondary" onclick="editTheory('${theory.id}')">
                                                <i class="fas fa-edit"></i>
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-4">
                                <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhuma teoria criada</h5>
                                <p class="text-muted">
                                    <a href="javascript:void(0)" onclick="loadSection('theories')">
                                        Crie sua primeira teoria!
                                    </a>
                                </p>
                            </div>
                        `}
                    </div>
                    
                    <div class="profile-section" id="profileFriendsSection">
                        ${friends.length > 0 ? `
                            <div class="row">
                                ${friends.map(friendId => {
                                    const friend = AppState.users[friendId];
                                    if (!friend) return '';
                                    
                                    return `
                                        <div class="col-md-6 mb-3">
                                            <div class="card">
                                                <div class="card-body">
                                                    <div class="d-flex align-items-center gap-3 mb-3">
                                                        <img src="${friend.profile.avatar}" 
                                                             style="width: 50px; height: 50px; border-radius: 50%;"
                                                             alt="${friend.username}">
                                                        <div>
                                                            <div class="font-weight-bold">${friend.username}</div>
                                                            <div class="d-flex align-items-center gap-1">
                                                                <span class="status-dot status-${friend.status || 'offline'}"></span>
                                                                <small class="text-muted">${friend.status === 'online' ? 'Online' : 'Offline'}</small>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button class="btn btn-sm btn-primary flex-grow-1" onclick="UISystem.startPrivateChat('${friendId}')">
                                                            <i class="fas fa-comment"></i> Mensagem
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="removeFriend('${friendId}')">
                                                            <i class="fas fa-user-times"></i>
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    `;
                                }).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-4">
                                <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                                <h5 class="text-muted">Nenhum amigo adicionado</h5>
                                <p class="text-muted">
                                    <a href="javascript:void(0)" onclick="loadSection('friends')">
                                        Adicione amigos para colaborar!
                                    </a>
                                </p>
                            </div>
                        `}
                    </div>
                    
                    <div class="profile-section" id="profileSecuritySection">
                        <form id="profileSecurityForm">
                            <div class="form-group">
                                <label class="form-label">Alterar Senha</label>
                                <input type="password" class="form-control mb-2" id="currentPassword" 
                                       placeholder="Senha atual">
                                <input type="password" class="form-control mb-2" id="newPassword" 
                                       placeholder="Nova senha">
                                <input type="password" class="form-control mb-2" id="confirmPassword" 
                                       placeholder="Confirmar nova senha">
                                <button type="button" class="btn btn-warning" onclick="changePassword()">
                                    <i class="fas fa-key"></i> Alterar Senha
                                </button>
                            </div>
                            
                            <hr class="my-4">
                            
                            <h5>Sessões Ativas</h5>
                            <div class="list-group">
                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <div class="font-weight-bold">Esta sessão</div>
                                        <small class="text-muted">Iniciada agora</small>
                                    </div>
                                    <span class="badge badge-success">Ativa</span>
                                </div>
                            </div>
                            
                            <div class="mt-4">
                                <button type="button" class="btn btn-danger" onclick="logoutAllSessions()">
                                    <i class="fas fa-sign-out-alt"></i> Sair de Todas as Sessões
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
        
        <style>
            .profile-avatar {
                width: 150px;
                height: 150px;
                border-radius: 50%;
                border: 3px solid var(--accent-primary);
                object-fit: cover;
                margin-bottom: 20px;
            }
            
            .profile-tabs {
                display: flex;
                border-bottom: 2px solid var(--border-color);
                margin-bottom: 20px;
                overflow-x: auto;
            }
            
            .profile-tab {
                padding: 10px 20px;
                background: none;
                border: none;
                border-bottom: 2px solid transparent;
                color: var(--text-secondary);
                cursor: pointer;
                font-weight: 600;
                white-space: nowrap;
            }
            
            .profile-tab:hover {
                color: var(--text-primary);
            }
            
            .profile-tab.active {
                color: var(--accent-primary);
                border-bottom-color: var(--accent-primary);
            }
            
            .profile-section {
                display: none;
            }
            
            .profile-section.active {
                display: block;
                animation: fadeIn 0.3s ease;
            }
            
            .profile-stats {
                background: var(--bg-secondary);
                border: 1px solid var(--border-color);
                border-radius: 8px;
                padding: 15px;
                margin-top: 20px;
            }
            
            .stat-item {
                display: flex;
                justify-content: space-between;
                padding: 10px 0;
                border-bottom: 1px solid var(--border-color);
            }
            
            .stat-item:last-child {
                border-bottom: none;
            }
        </style>
    `;
};

// ============================================
// FUNÇÕES AUXILIARES PARA AS NOVAS PÁGINAS
// ============================================

// Função para alternar abas no perfil
window.switchProfileTab = function(tab) {
    // Esconder todas as seções
    document.querySelectorAll('.profile-section').forEach(section => {
        section.classList.remove('active');
    });
    
    // Remover active de todas as tabs
    document.querySelectorAll('.profile-tab').forEach(tabElement => {
        tabElement.classList.remove('active');
    });
    
    // Ativar tab clicada
    const tabElement = Array.from(document.querySelectorAll('.profile-tab')).find(
        t => t.textContent.toLowerCase().includes(tab)
    );
    if (tabElement) {
        tabElement.classList.add('active');
    }
    
    // Mostrar seção correspondente
    const section = document.getElementById(`profile${tab.charAt(0).toUpperCase() + tab.slice(1)}Section`);
    if (section) {
        section.classList.add('active');
    }
};

// Salvar informações do perfil
window.saveProfileInfo = function() {
    const user = AppState.users[AppState.currentUser];
    if (!user) return;
    
    user.profile.bio = document.getElementById('profileBio')?.value || '';
    user.profile.specialization = document.getElementById('profileSpecialization')?.value || '';
    user.profile.location = document.getElementById('profileLocation')?.value || '';
    user.profile.website = document.getElementById('profileWebsite')?.value || '';
    
    StorageSystem.save();
    ToastSystem.success('Perfil atualizado com sucesso!');
};

// Alterar senha
window.changePassword = function() {
    const currentPassword = document.getElementById('currentPassword')?.value;
    const newPassword = document.getElementById('newPassword')?.value;
    const confirmPassword = document.getElementById('confirmPassword')?.value;
    
    if (!currentPassword || !newPassword || !confirmPassword) {
        ToastSystem.error('Preencha todos os campos');
        return;
    }
    
    if (newPassword !== confirmPassword) {
        ToastSystem.error('As senhas não coincidem');
        return;
    }
    
    if (newPassword.length < 8) {
        ToastSystem.error('A nova senha deve ter pelo menos 8 caracteres');
        return;
    }
    
    const user = AppState.users[AppState.currentUser];
    if (!user) return;
    
    // Verificar senha atual
    if (user.password !== Security.hash(currentPassword)) {
        ToastSystem.error('Senha atual incorreta');
        return;
    }
    
    // Alterar senha
    user.password = Security.hash(newPassword);
    StorageSystem.save();
    
    ToastSystem.success('Senha alterada com sucesso!');
    
    // Limpar campos
    document.getElementById('currentPassword').value = '';
    document.getElementById('newPassword').value = '';
    document.getElementById('confirmPassword').value = '';
};

// Salvar configurações do sistema
window.saveSystemSettings = function() {
    AppState.settings.autosave = document.getElementById('systemAutosave')?.checked || false;
    AppState.settings.notifications = document.getElementById('systemNotifications')?.checked || false;
    AppState.settings.latexEnabled = document.getElementById('systemLatex')?.checked || false;
    AppState.settings.language = document.getElementById('systemLanguage')?.value || 'pt-BR';
    
    // Atualizar configurações do usuário atual
    if (AppState.currentUser && AppState.users[AppState.currentUser]) {
        AppState.users[AppState.currentUser].settings = {
            ...AppState.users[AppState.currentUser].settings,
            ...AppState.settings
        };
    }
    
    StorageSystem.save();
    ToastSystem.success('Configurações salvas com sucesso!');
};

// Importar dados
window.importData = function() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = async (e) => {
        const file = e.target.files[0];
        if (file) {
            try {
                await StorageSystem.importData(file);
                ToastSystem.success('Dados importados com sucesso! Recarregando...');
                setTimeout(() => location.reload(), 1000);
            } catch (error) {
                ToastSystem.error('Erro ao importar dados');
            }
        }
    };
    
    input.click();
};

// Funções de administração
window.rejectTheoryPrompt = function(theoryId) {
    const reason = prompt('Digite o motivo da rejeição:');
    if (reason) {
        try {
            TheorySystem.rejectTheory(theoryId, reason);
            ToastSystem.success('Teoria rejeitada');
            loadSection('admin');
        } catch (error) {
            ToastSystem.error(error.message);
        }
    }
};

window.showUserManagement = function() {
    ToastSystem.info('Gerenciamento de usuários em desenvolvimento');
};

window.showSystemLogs = function() {
    ToastSystem.info('Logs do sistema em desenvolvimento');
};

window.showBackupManagement = function() {
    ToastSystem.info('Gerenciamento de backups em desenvolvimento');
};

window.clearAllSystemData = function() {
    if (confirm('⚠️ ATENÇÃO: Isso apagará TODOS os dados do sistema. Esta ação não pode ser desfeita.\n\nTem certeza?')) {
        if (confirm('Digite "CONFIRMAR" para continuar:')) {
            localStorage.clear();
            location.reload();
        }
    }
};

window.promoteUserToNucleo = function() {
    ToastSystem.info('Promoção de usuário em desenvolvimento');
};

window.sendSystemAnnouncement = function() {
    ToastSystem.info('Anúncios do sistema em desenvolvimento');
};

window.runSystemDiagnostics = function() {
    ToastSystem.info('Diagnóstico do sistema em desenvolvimento');
};

window.changeProfileAvatar = function() {
    ToastSystem.info('Alteração de avatar em desenvolvimento');
};

window.logoutAllSessions = function() {
    if (confirm('Tem certeza que deseja sair de todas as sessões?')) {
        AuthSystem.logout();
    }
};
    
    <script>
        // ============================================
        // SISTEMA RENOVA - CÓDIGO JAVASCRIPT COMPLETO
        // ============================================

        // Configurações globais
        const RENOVA_CONFIG = {
            VERSION: '4.0.0',
            MASTER_KEY: 'Renova, O Non Trad',
            STORAGE_KEY: 'renova_system_v4',
            DEFAULT_THEME: 'dark',
            AUTO_SAVE_INTERVAL: 30000, // 30 segundos
            MAX_FILE_SIZE: 50 * 1024 * 1024, // 50MB
            MAX_MESSAGE_LENGTH: 5000,
            MAX_THEORY_LENGTH: 100000
        };

        // Estado global da aplicação
        let AppState = {
            // Estado atual
            currentUser: null,
            isNucleo: false,
            userStatus: 'online',
            currentSection: 'dashboard-home',
            currentModal: null,
            currentConversation: null, // ← ADICIONADO PARA MENSAGENS
            theme: RENOVA_CONFIG.DEFAULT_THEME,
            
            // Dados persistentes
            users: {},
            theories: [],
            forumPosts: [],
            chatMessages: {},
            privateMessages: {},
            groups: {},
            collaborations: [],
            files: [],
            notifications: [],
            
            // Sistema social
            friends: {},
            friendRequests: {},
            blockedUsers: {},
            
            // Configurações
            settings: {
                notifications: true,
                privacy: 'public',
                theme: 'dark',
                language: 'pt-BR',
                autosave: true,
                latexEnabled: true
            },
            
            // Cache temporário
            onlineUsers: new Set(),
            unreadCounts: {
                messages: 0,
                notifications: 0,
                friendRequests: 0,
                theories: 0
            }
        };

        // Cache de templates
        const Templates = {};

        // ============================================
        // 1. SISTEMA DE UTILIDADES
        // ============================================

        // Logger com níveis
        const Logger = {
            log: (...args) => console.log('[RENOVA]', ...args),
            warn: (...args) => console.warn('[RENOVA]', ...args),
            error: (...args) => console.error('[RENOVA]', ...args),
            info: (...args) => console.info('[RENOVA]', ...args)
        };

        // Sistema de notificações Toast
        class ToastSystem {
            static show(message, type = 'info', duration = 5000) {
                const container = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                
                toast.innerHTML = `
                    <div class="toast-icon">
                        <i class="fas ${icons[type] || icons.info}"></i>
                    </div>
                    <div class="toast-content">
                        <div class="toast-message">${message}</div>
                    </div>
                    <button class="toast-close" onclick="this.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                
                container.appendChild(toast);
                
                // Auto-remove
                if (duration > 0) {
                    setTimeout(() => {
                        if (toast.parentElement) {
                            toast.style.opacity = '0';
                            setTimeout(() => toast.remove(), 300);
                        }
                    }, duration);
                }
                
                return toast;
            }
            
            static success(message) {
                return this.show(message, 'success');
            }
            
            static error(message) {
                return this.show(message, 'error', 8000);
            }
            
            static warning(message) {
                return this.show(message, 'warning');
            }
            
            static info(message) {
                return this.show(message, 'info');
            }
        }

        // Sistema de loading
        class LoadingSystem {
            static show(text = 'Carregando...') {
                const overlay = document.getElementById('loadingOverlay');
                const textEl = document.getElementById('loadingText');
                
                if (textEl) textEl.textContent = text;
                if (overlay) overlay.classList.remove('hidden');
            }
            
            static hide() {
                const overlay = document.getElementById('loadingOverlay');
                if (overlay) overlay.classList.add('hidden');
            }
            
            static async wrap(promise, text = 'Carregando...') {
                this.show(text);
                try {
                    const result = await promise;
                    return result;
                } finally {
                    this.hide();
                }
            }
        }

        // Sistema de modal
        class ModalSystem {
            static show(modalId) {
                const modal = document.getElementById(modalId);
                if (modal) {
                    modal.classList.remove('hidden');
                    AppState.currentModal = modalId;
                    document.body.style.overflow = 'hidden';
                }
            }
            
            static hide(modalId = null) {
                const id = modalId || AppState.currentModal;
                if (id) {
                    const modal = document.getElementById(id);
                    if (modal) {
                        modal.classList.add('hidden');
                        if (id === AppState.currentModal) {
                            AppState.currentModal = null;
                        }
                    }
                }
                document.body.style.overflow = '';
            }
            
            static hideAll() {
                document.querySelectorAll('.modal-backdrop').forEach(modal => {
                    modal.classList.add('hidden');
                });
                AppState.currentModal = null;
                document.body.style.overflow = '';
            }
        }

        // Sistema de validação
        class Validator {
            static email(email) {
                const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                return re.test(email);
            }
            
            static username(username) {
                return /^[a-zA-Z0-9_]{3,20}$/.test(username);
            }
            
            static password(password) {
                return password.length >= 8;
            }
            
            static theoryTitle(title) {
                return title.length >= 5 && title.length <= 200;
            }
            
            static theoryContent(content) {
                return content.length >= 100 && content.length <= RENOVA_CONFIG.MAX_THEORY_LENGTH;
            }
        }

        // Sistema de criptografia básica
        class Security {
            static hash(text) {
                let hash = 0;
                for (let i = 0; i < text.length; i++) {
                    const char = text.charCodeAt(i);
                    hash = ((hash << 5) - hash) + char;
                    hash = hash & hash;
                }
                return hash.toString(36);
            }
            
            static encrypt(text, key = RENOVA_CONFIG.MASTER_KEY) {
                // Criptografia básica para demonstração
                // Em produção, usar Web Crypto API
                let result = '';
                for (let i = 0; i < text.length; i++) {
                    const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                    result += String.fromCharCode(charCode);
                }
                return btoa(result);
            }
            
            static decrypt(encrypted, key = RENOVA_CONFIG.MASTER_KEY) {
                try {
                    const text = atob(encrypted);
                    let result = '';
                    for (let i = 0; i < text.length; i++) {
                        const charCode = text.charCodeAt(i) ^ key.charCodeAt(i % key.length);
                        result += String.fromCharCode(charCode);
                    }
                    return result;
                } catch (e) {
                    return null;
                }
            }
        }

        // ============================================
        // 2. SISTEMA DE PERSISTÊNCIA
        // ============================================

        class StorageSystem {
            static save() {
                try {
                    const data = {
                        users: AppState.users,
                        theories: AppState.theories,
                        forumPosts: AppState.forumPosts,
                        chatMessages: AppState.chatMessages,
                        privateMessages: AppState.privateMessages,
                        groups: AppState.groups,
                        collaborations: AppState.collaborations,
                        files: AppState.files,
                        notifications: AppState.notifications,
                        friends: AppState.friends,
                        friendRequests: AppState.friendRequests,
                        blockedUsers: AppState.blockedUsers,
                        settings: AppState.settings,
                        version: RENOVA_CONFIG.VERSION,
                        timestamp: Date.now()
                    };
                    
                    const encrypted = Security.encrypt(JSON.stringify(data));
                    localStorage.setItem(RENOVA_CONFIG.STORAGE_KEY, encrypted);
                    
                    Logger.log('Estado salvo com sucesso');
                    return true;
                } catch (error) {
                    Logger.error('Erro ao salvar estado:', error);
                    ToastSystem.error('Erro ao salvar dados');
                    return false;
                }
            }
            
            static load() {
                try {
                    const encrypted = localStorage.getItem(RENOVA_CONFIG.STORAGE_KEY);
                    if (!encrypted) {
                        Logger.log('Nenhum dado salvo encontrado, iniciando novo sistema');
                        this.initializeDefaultData();
                        return true;
                    }
                    
                    const decrypted = Security.decrypt(encrypted);
                    if (!decrypted) {
                        throw new Error('Falha na descriptografia');
                    }
                    
                    const data = JSON.parse(decrypted);
                    
                    // Carregar dados
                    AppState.users = data.users || {};
                    AppState.theories = data.theories || [];
                    AppState.forumPosts = data.forumPosts || [];
                    AppState.chatMessages = data.chatMessages || {};
                    AppState.privateMessages = data.privateMessages || {};
                    AppState.groups = data.groups || {};
                    AppState.collaborations = data.collaborations || [];
                    AppState.files = data.files || [];
                    AppState.notifications = data.notifications || [];
                    AppState.friends = data.friends || {};
                    AppState.friendRequests = data.friendRequests || {};
                    AppState.blockedUsers = data.blockedUsers || {};
                    AppState.settings = data.settings || AppState.settings;
                    
                    Logger.log('Estado carregado com sucesso');
                    return true;
                } catch (error) {
                    Logger.error('Erro ao carregar estado:', error);
                    
                    // Tentar backup
                    if (this.loadBackup()) {
                        ToastSystem.warning('Usando backup de dados');
                        return true;
                    }
                    
                    // Inicializar dados padrão
                    this.initializeDefaultData();
                    ToastSystem.info('Sistema inicializado com dados padrão');
                    return false;
                }
            }
            
            static loadBackup() {
                try {
                    // Tentar carregar de chaves de backup
                    for (let i = 1; i <= 5; i++) {
                        const backupKey = `${RENOVA_CONFIG.STORAGE_KEY}_backup_${i}`;
                        const backup = localStorage.getItem(backupKey);
                        
                        if (backup) {
                            const decrypted = Security.decrypt(backup);
                            if (decrypted) {
                                const data = JSON.parse(decrypted);
                                
                                // Restaurar dados importantes
                                AppState.users = data.users || AppState.users;
                                AppState.theories = data.theories || AppState.theories;
                                AppState.friends = data.friends || AppState.friends;
                                
                                Logger.log(`Backup ${i} carregado com sucesso`);
                                return true;
                            }
                        }
                    }
                    return false;
                } catch (error) {
                    Logger.error('Erro ao carregar backup:', error);
                    return false;
                }
            }
            
            static createBackup() {
                try {
                    const data = {
                        users: AppState.users,
                        theories: AppState.theories,
                        friends: AppState.friends,
                        timestamp: Date.now(),
                        version: RENOVA_CONFIG.VERSION
                    };
                    
                    const encrypted = Security.encrypt(JSON.stringify(data));
                    
                    // Rotacionar backups (mantém os 5 mais recentes)
                    for (let i = 5; i > 1; i--) {
                        const oldKey = `${RENOVA_CONFIG.STORAGE_KEY}_backup_${i-1}`;
                        const newKey = `${RENOVA_CONFIG.STORAGE_KEY}_backup_${i}`;
                        const oldData = localStorage.getItem(oldKey);
                        if (oldData) {
                            localStorage.setItem(newKey, oldData);
                        }
                    }
                    
                    // Salvar novo backup
                    localStorage.setItem(`${RENOVA_CONFIG.STORAGE_KEY}_backup_1`, encrypted);
                    Logger.log('Backup criado com sucesso');
                    return true;
                } catch (error) {
                    Logger.error('Erro ao criar backup:', error);
                    return false;
                }
            }
            
            static initializeDefaultData() {
                // Usuário admin padrão
                AppState.users = {
                    'einstein': {
                        id: 'user_1',
                        username: 'einstein',
                        email: 'einstein@renova.math',
                        password: Security.hash('relativity123'),
                        nucleo: true,
                        status: 'online',
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        profile: {
                            avatar: this.generateAvatar('einstein'),
                            bio: 'Físico teórico, pai da relatividade. Buscando unificar as forças fundamentais.',
                            specialization: 'physics',
                            location: 'Princeton, USA',
                            website: 'https://example.com',
                            social: {
                                github: 'einstein',
                                twitter: 'einstein'
                            },
                            badges: ['nucleo', 'pioneer', 'relativity']
                        },
                        stats: {
                            theories: 3,
                            posts: 42,
                            friends: 28,
                            collaborations: 12,
                            reputation: 9850
                        },
                        settings: {
                            theme: 'dark',
                            notifications: true,
                            privacy: 'public'
                        }
                    },
                    'newton': {
                        id: 'user_2',
                        username: 'newton',
                        email: 'newton@renova.math',
                        password: Security.hash('gravity123'),
                        nucleo: false,
                        status: 'online',
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        profile: {
                            avatar: this.generateAvatar('newton'),
                            bio: 'Matemático e físico, leis do movimento e gravitação universal.',
                            specialization: 'mathematics',
                            location: 'Cambridge, UK',
                            website: '',
                            social: {},
                            badges: ['pioneer', 'classical']
                        },
                        stats: {
                            theories: 2,
                            posts: 18,
                            friends: 15,
                            collaborations: 8,
                            reputation: 7200
                        }
                    },
                    'curie': {
                        id: 'user_3',
                        username: 'curie',
                        email: 'curie@renova.math',
                        password: Security.hash('radioactivity123'),
                        nucleo: false,
                        status: 'away',
                        createdAt: new Date().toISOString(),
                        lastSeen: new Date().toISOString(),
                        profile: {
                            avatar: this.generateAvatar('curie'),
                            bio: 'Física e química, pesquisa em radioatividade. Duas vezes Nobel.',
                            specialization: 'physics',
                            location: 'Paris, France',
                            website: '',
                            social: {},
                            badges: ['pioneer', 'radioactivity']
                        },
                        stats: {
                            theories: 1,
                            posts: 24,
                            friends: 22,
                            collaborations: 6,
                            reputation: 8500
                        }
                    }
                };
                
                // Amizades padrão
                AppState.friends = {
                    'einstein': ['newton', 'curie'],
                    'newton': ['einstein'],
                    'curie': ['einstein']
                };
                
                // Teorias padrão
                AppState.theories = [
                    {
                        id: 'theory_1',
                        title: 'Teoria da Relatividade Geral',
                        author: 'einstein',
                        content: 'A gravidade não é uma força, mas uma curvatura do espaço-tempo causada pela massa e energia.\n\nEquação de campo de Einstein:\n\n$$G_{\\mu\\nu} + \\Lambda g_{\\mu\\nu} = \\frac{8\\pi G}{c^4} T_{\\mu\\nu}$$\n\nOnde:\n- $G_{\\mu\\nu}$ é o tensor de Einstein\n- $\\Lambda$ é a constante cosmológica\n- $g_{\\mu\\nu}$ é o tensor métrico\n- $T_{\\mu\\nu}$ é o tensor de energia-momento',
                        category: 'physics',
                        tags: ['relatividade', 'gravitação', 'cosmologia'],
                        status: 'approved',
                        visibility: 'public',
                        createdAt: new Date('1915-11-25').toISOString(),
                        updatedAt: new Date('1915-11-25').toISOString(),
                        views: 1250,
                        upvotes: 89,
                        downvotes: 2,
                        collaborators: [],
                        comments: [
                            {
                                id: 'comment_1',
                                author: 'newton',
                                content: 'Interessante abordagem! Como isso se relaciona com a lei da gravitação universal?',
                                timestamp: new Date('1915-12-01').toISOString(),
                                upvotes: 15
                            }
                        ],
                        attachments: [],
                        version: 1
                    },
                    {
                        id: 'theory_2',
                        title: 'Leis do Movimento de Newton',
                        author: 'newton',
                        content: 'Três leis fundamentais que descrevem a relação entre um corpo e as forças que atuam sobre ele:\n\n1. Lei da Inércia\n2. $F = ma$\n3. Ação e Reação',
                        category: 'physics',
                        tags: ['mecânica', 'clássica', 'movimento'],
                        status: 'approved',
                        visibility: 'public',
                        createdAt: new Date('1687-07-05').toISOString(),
                        updatedAt: new Date('1687-07-05').toISOString(),
                        views: 890,
                        upvotes: 67,
                        downvotes: 0,
                        collaborators: [],
                        comments: [],
                        attachments: [],
                        version: 1
                    }
                ];
                
                // Mensagens de chat
                AppState.chatMessages = {
                    'geral': [
                        {
                            id: 'msg_1',
                            author: 'einstein',
                            content: 'Bem-vindos ao Renova! Aqui vamos desbravar os limites da matemática.',
                            timestamp: new Date(Date.now() - 3600000).toISOString(),
                            type: 'text'
                        },
                        {
                            id: 'msg_2',
                            author: 'newton',
                            content: 'Excelente iniciativa! Estou ansioso para colaborar em problemas desafiadores.',
                            timestamp: new Date(Date.now() - 3500000).toISOString(),
                            type: 'text'
                        }
                    ],
                    'matematica': [],
                    'fisica': [],
                    'computacao': []
                };
                
                // Salvar estado inicial
                this.save();
            }
            
            static generateAvatar(username) {
                const colors = [
                    '#00d4ff', '#9d4edd', '#06d6a0', '#ff2e63', '#ffd166',
                    '#118ab2', '#ef476f', '#ff9a00', '#7209b7', '#3a86ff'
                ];
                const hash = username.split('').reduce((acc, char) => acc + char.charCodeAt(0), 0);
                const color = colors[hash % colors.length];
                const initials = username.substring(0, 2).toUpperCase();
                
                return `data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" width="200" height="200"><rect width="200" height="200" fill="${color}"/><text x="100" y="100" font-family="Arial" font-size="80" fill="white" text-anchor="middle" dy=".3em">${initials}</text></svg>`;
            }
            
            static exportData() {
                try {
                    const data = {
                        users: AppState.users,
                        theories: AppState.theories,
                        forumPosts: AppState.forumPosts,
                        chatMessages: AppState.chatMessages,
                        privateMessages: AppState.privateMessages,
                        groups: AppState.groups,
                        collaborations: AppState.collaborations,
                        files: AppState.files,
                        notifications: AppState.notifications,
                        friends: AppState.friends,
                        friendRequests: AppState.friendRequests,
                        blockedUsers: AppState.blockedUsers,
                        settings: AppState.settings,
                        version: RENOVA_CONFIG.VERSION,
                        exportDate: new Date().toISOString(),
                        exportedBy: AppState.currentUser
                    };
                    
                    const json = JSON.stringify(data, null, 2);
                    const blob = new Blob([json], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `renova_backup_${new Date().toISOString().split('T')[0]}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);
                    
                    ToastSystem.success('Dados exportados com sucesso!');
                    return true;
                } catch (error) {
                    Logger.error('Erro ao exportar dados:', error);
                    ToastSystem.error('Erro ao exportar dados');
                    return false;
                }
            }
            
            static importData(file) {
                return new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        try {
                            const data = JSON.parse(e.target.result);
                            
                            // Validar estrutura básica
                            if (!data.users || !data.version) {
                                throw new Error('Arquivo de dados inválido');
                            }
                            
                            // Criar backup antes da importação
                            this.createBackup();
                            
                            // Importar dados
                            AppState.users = data.users || AppState.users;
                            AppState.theories = data.theories || AppState.theories;
                            AppState.forumPosts = data.forumPosts || AppState.forumPosts;
                            AppState.chatMessages = data.chatMessages || AppState.chatMessages;
                            AppState.privateMessages = data.privateMessages || AppState.privateMessages;
                            AppState.groups = data.groups || AppState.groups;
                            AppState.collaborations = data.collaborations || AppState.collaborations;
                            AppState.files = data.files || AppState.files;
                            AppState.notifications = data.notifications || AppState.notifications;
                            AppState.friends = data.friends || AppState.friends;
                            AppState.friendRequests = data.friendRequests || AppState.friendRequests;
                            AppState.blockedUsers = data.blockedUsers || AppState.blockedUsers;
                            AppState.settings = data.settings || AppState.settings;
                            
                            // Salvar estado
                            this.save();
                            
                            ToastSystem.success('Dados importados com sucesso!');
                            resolve(true);
                        } catch (error) {
                            Logger.error('Erro ao importar dados:', error);
                            ToastSystem.error('Erro ao importar dados: arquivo inválido');
                            reject(error);
                        }
                    }.bind(this);
                    
                    reader.onerror = function() {
                        ToastSystem.error('Erro ao ler arquivo');
                        reject(new Error('Erro ao ler arquivo'));
                    };
                    
                    reader.readAsText(file);
                });
            }
            
            static clearAllData() {
                if (confirm('⚠️ ATENÇÃO: Isso apagará TODOS os dados do sistema. Esta ação não pode ser desfeita.\n\nTem certeza?')) {
                    if (confirm('Digite "APAGAR TUDO" para confirmar:')) {
                        localStorage.clear();
                        location.reload();
                    }
                }
            }
        }

        // Auto-save
        setInterval(() => {
            if (AppState.currentUser && AppState.settings.autosave) {
                StorageSystem.save();
            }
        }, RENOVA_CONFIG.AUTO_SAVE_INTERVAL);

        // ============================================
        // 3. SISTEMA DE AUTENTICAÇÃO
        // ============================================

        class AuthSystem {
            static login(username, password, masterKey = '') {
                return LoadingSystem.wrap(new Promise((resolve, reject) => {
                    try {
                        // Validar entrada
                        if (!username || !password) {
                            throw new Error('Preencha usuário e senha');
                        }
                        
                        // Buscar usuário por username ou email
                        let user = null;
                        let userId = null;
                        
                        for (const [id, u] of Object.entries(AppState.users)) {
                            if (u.username === username || u.email === username) {
                                user = u;
                                userId = id;
                                break;
                            }
                        }
                        
                        if (!user) {
                            throw new Error('Usuário não encontrado');
                        }
                        
                        // Verificar senha
                        const hashedPassword = Security.hash(password);
                        if (user.password !== hashedPassword) {
                            throw new Error('Senha incorreta');
                        }
                        
                        // Verificar MASTER_KEY para núcleo
                        if (masterKey && masterKey === RENOVA_CONFIG.MASTER_KEY) {
                            user.nucleo = true;
                            ToastSystem.success('Acesso Núcleo concedido!');
                        }
                        
                        // Atualizar estado
                        AppState.currentUser = userId;
                        AppState.isNucleo = user.nucleo || false;
                        AppState.userStatus = 'online';
                        
                        // Atualizar lastSeen
                        user.lastSeen = new Date().toISOString();
                        user.status = 'online';
                        
                        // Salvar estado
                        StorageSystem.save();
                        
                        // Atualizar interface
                        this.updateUserUI();
                        
                        // Mostrar dashboard
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        document.getElementById('mobileMenuToggle').classList.remove('hidden');
                        
                        // Carregar dashboard
                        loadSection('dashboard-home');
                        
                        // Notificação de boas-vindas
                        ToastSystem.success(`Bem-vindo de volta, ${user.username}!`);
                        
                        Logger.log(`Usuário ${userId} logado com sucesso`);
                        resolve(true);
                    } catch (error) {
                        ToastSystem.error(error.message);
                        reject(error);
                    }
                }), 'Entrando no sistema...');
            }
            
            static register(username, email, password, masterKey = '', specialization = '') {
                return LoadingSystem.wrap(new Promise((resolve, reject) => {
                    try {
                        // Validações
                        if (!Validator.username(username)) {
                            throw new Error('Nome de usuário deve ter 3-20 caracteres (letras, números, _)');
                        }
                        
                        if (!Validator.email(email)) {
                            throw new Error('Email inválido');
                        }
                        
                        if (!Validator.password(password)) {
                            throw new Error('Senha deve ter no mínimo 8 caracteres');
                        }
                        
                        // Verificar se usuário já existe
                        for (const user of Object.values(AppState.users)) {
                            if (user.username === username) {
                                throw new Error('Nome de usuário já em uso');
                            }
                            if (user.email === email) {
                                throw new Error('Email já cadastrado');
                            }
                        }
                        
                        // Criar ID único
                        const userId = `user_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`;
                        
                        // Criar usuário
                        AppState.users[userId] = {
                            id: userId,
                            username: username,
                            email: email,
                            password: Security.hash(password),
                            nucleo: masterKey === RENOVA_CONFIG.MASTER_KEY,
                            status: 'online',
                            createdAt: new Date().toISOString(),
                            lastSeen: new Date().toISOString(),
                            profile: {
                                avatar: StorageSystem.generateAvatar(username),
                                bio: '',
                                specialization: specialization,
                                location: '',
                                website: '',
                                social: {},
                                badges: []
                            },
                            stats: {
                                theories: 0,
                                posts: 0,
                                friends: 0,
                                collaborations: 0,
                                reputation: 100
                            },
                            settings: {
                                theme: AppState.settings.theme,
                                notifications: true,
                                privacy: 'friends'
                            }
                        };
                        
                        // Inicializar listas vazias
                        AppState.friends[userId] = [];
                        AppState.friendRequests[userId] = [];
                        
                        // Definir como usuário atual
                        AppState.currentUser = userId;
                        AppState.isNucleo = AppState.users[userId].nucleo;
                        AppState.userStatus = 'online';
                        
                        // Salvar estado
                        StorageSystem.save();
                        
                        // Atualizar interface
                        this.updateUserUI();
                        
                        // Mostrar dashboard
                        document.getElementById('authScreen').classList.add('hidden');
                        document.getElementById('dashboard').classList.remove('hidden');
                        document.getElementById('mobileMenuToggle').classList.remove('hidden');
                        
                        // Carregar dashboard
                        loadSection('dashboard-home');
                        
                        // Notificação
                        if (AppState.isNucleo) {
                            ToastSystem.success(`Conta Núcleo criada! Bem-vindo(a) ao sistema radical, ${username}!`);
                        } else {
                            ToastSystem.success(`Conta criada com sucesso! Bem-vindo(a) ao Renova, ${username}!`);
                        }
                        
                        Logger.log(`Novo usuário registrado: ${userId}`);
                        resolve(true);
                    } catch (error) {
                        ToastSystem.error(error.message);
                        reject(error);
                    }
                }), 'Criando conta...');
            }
            
            static logout() {
                if (AppState.currentUser && AppState.users[AppState.currentUser]) {
                    AppState.users[AppState.currentUser].status = 'offline';
                    AppState.users[AppState.currentUser].lastSeen = new Date().toISOString();
                    
                    ToastSystem.info('Até logo!');
                }
                
                AppState.currentUser = null;
                AppState.isNucleo = false;
                
                StorageSystem.save();
                
                // Mostrar auth screen
                document.getElementById('dashboard').classList.add('hidden');
                document.getElementById('mobileMenuToggle').classList.add('hidden');
                document.getElementById('authScreen').classList.remove('hidden');
                
                // Resetar forms
                document.getElementById('loginUsername').value = '';
                document.getElementById('loginPassword').value = '';
                document.getElementById('loginMasterKey').value = '';
                
                Logger.log('Usuário deslogado');
            }
            
            static updateUserStatus(status) {
                if (!AppState.currentUser) return;
                
                AppState.userStatus = status;
                if (AppState.users[AppState.currentUser]) {
                    AppState.users[AppState.currentUser].status = status;
                    AppState.users[AppState.currentUser].lastSeen = new Date().toISOString();
                }
                
                // Atualizar UI
                const statusDot = document.getElementById('sidebarStatusDot');
                const statusText = document.getElementById('sidebarStatusText');
                
                if (statusDot) {
                    statusDot.className = 'status-dot';
                    statusDot.classList.add(`status-${status}`);
                }
                
                if (statusText) {
                    const statusMap = {
                        online: 'Online',
                        away: 'Ausente',
                        dnd: 'Não Perturbe',
                        offline: 'Offline'
                    };
                    statusText.textContent = statusMap[status] || status;
                }
                
                StorageSystem.save();
            }
            
            static updateUserUI() {
                if (!AppState.currentUser || !AppState.users[AppState.currentUser]) return;
                
                const user = AppState.users[AppState.currentUser];
                
                // Avatar na sidebar
                const sidebarAvatar = document.getElementById('sidebarAvatar');
                if (sidebarAvatar) {
                    sidebarAvatar.src = user.profile.avatar;
                    sidebarAvatar.alt = user.username;
                }
                
                // Nome de usuário
                const sidebarUsername = document.getElementById('sidebarUsername');
                if (sidebarUsername) {
                    sidebarUsername.textContent = user.username;
                }
                
                // Status
                this.updateUserStatus(user.status || 'online');
                
                // Seletor de status
                const statusSelector = document.getElementById('statusSelector');
                if (statusSelector) {
                    statusSelector.value = user.status || 'online';
                }
                
                // Menu admin
                const navAdmin = document.getElementById('navAdmin');
                if (navAdmin) {
                    if (AppState.isNucleo) {
                        navAdmin.classList.remove('hidden');
                    } else {
                        navAdmin.classList.add('hidden');
                    }
                }
                
                // Badges de notificação
                this.updateNotificationBadges();
            }
            
            static updateNotificationBadges() {
                if (!AppState.currentUser) return;
                
                // Contar notificações não lidas
                const unreadNotifications = AppState.notifications.filter(n => 
                    n.recipient === AppState.currentUser && !n.read
                ).length;
                
                // Contar solicitações de amizade
                const friendRequests = AppState.friendRequests[AppState.currentUser] || [];
                const pendingRequests = friendRequests.filter(r => r.status === 'pending').length;
                
                // Contar mensagens não lidas
                let unreadMessages = 0;
                if (AppState.privateMessages[AppState.currentUser]) {
                    Object.values(AppState.privateMessages[AppState.currentUser]).forEach(conversation => {
                        unreadMessages += conversation.filter(m => 
                            m.sender !== AppState.currentUser && !m.read
                        ).length;
                    });
                }
                
                // Atualizar badges
                const updateBadge = (id, count) => {
                    const badge = document.getElementById(id);
                    if (badge) {
                        if (count > 0) {
                            badge.textContent = count > 99 ? '99+' : count;
                            badge.classList.remove('hidden');
                        } else {
                            badge.classList.add('hidden');
                        }
                    }
                };
                
                updateBadge('badgeNotifications', unreadNotifications);
                updateBadge('badgeFriends', pendingRequests);
                updateBadge('badgeMessages', unreadMessages);
                
                // Atualizar contagem total
                AppState.unreadCounts = {
                    notifications: unreadNotifications,
                    friendRequests: pendingRequests,
                    messages: unreadMessages
                };
            }
            
            static recoverPassword(email) {
                return LoadingSystem.wrap(new Promise((resolve, reject) => {
                    try {
                        // Verificar se email existe
                        let userFound = null;
                        for (const user of Object.values(AppState.users)) {
                            if (user.email === email) {
                                userFound = user;
                                break;
                            }
                        }
                        
                        if (!userFound) {
                            throw new Error('Email não encontrado');
                        }
                        
                        // Em produção, enviaria email de recuperação
                        // Aqui apenas simulamos
                        ToastSystem.info(`Link de recuperação enviado para ${email}`);
                        
                        resolve(true);
                    } catch (error) {
                        ToastSystem.error(error.message);
                        reject(error);
                    }
                }), 'Processando recuperação...');
            }
        }

        // ============================================
        // 4. SISTEMA DE INTERFACE
        // ============================================

        class UISystem {
            static switchAuthTab(tab) {
                // Atualizar tabs
                document.querySelectorAll('.auth-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('.auth-form').forEach(f => f.classList.remove('active'));
                
                // Ativar tab clicada
                const tabButtons = document.querySelectorAll('.auth-tab');
                const tabIndex = Array.from(tabButtons).findIndex(t => t.textContent.toLowerCase().includes(tab));
                if (tabIndex !== -1) {
                    tabButtons[tabIndex].classList.add('active');
                }
                
                // Mostrar form correspondente
                const form = document.getElementById(`${tab}Form`);
                if (form) {
                    form.classList.add('active');
                }
            }
            
            static setTheme(themeName) {
                AppState.theme = themeName;
                AppState.settings.theme = themeName;
                
                // Atualizar variáveis CSS
                const themes = {
                    dark: {
                        '--bg-primary': '#0a0a0f',
                        '--bg-secondary': '#121220',
                        '--bg-tertiary': '#1a1a2e',
                        '--bg-quaternary': '#222236'
                    },
                    blue: {
                        '--bg-primary': '#0f172a',
                        '--bg-secondary': '#1e293b',
                        '--bg-tertiary': '#334155',
                        '--bg-quaternary': '#475569'
                    },
                    green: {
                        '--bg-primary': '#052e16',
                        '--bg-secondary': '#14532d',
                        '--bg-tertiary': '#166534',
                        '--bg-quaternary': '#15803d'
                    },
                    purple: {
                        '--bg-primary': '#1e1b4b',
                        '--bg-secondary': '#312e81',
                        '--bg-tertiary': '#4338ca',
                        '--bg-quaternary': '#4f46e5'
                    },
                    matrix: {
                        '--bg-primary': '#003B00',
                        '--bg-secondary': '#005200',
                        '--bg-tertiary': '#006900',
                        '--bg-quaternary': '#008000',
                        '--accent-primary': '#00FF41',
                        '--accent-secondary': '#00FF41',
                        '--text-primary': '#00FF41',
                        '--text-secondary': '#00CC33'
                    }
                };
                
                const theme = themes[themeName] || themes.dark;
                Object.entries(theme).forEach(([property, value]) => {
                    document.documentElement.style.setProperty(property, value);
                });
                
                // Atualizar tema ativo
                document.querySelectorAll('.theme-option').forEach(opt => {
                    opt.classList.remove('active');
                });
                document.querySelector(`.theme-${themeName}`)?.classList.add('active');
                
                // Salvar preferência
                if (AppState.currentUser && AppState.users[AppState.currentUser]) {
                    AppState.users[AppState.currentUser].settings.theme = themeName;
                }
                
                StorageSystem.save();
                
                ToastSystem.info(`Tema alterado para ${themeName}`);
            }
            
            static toggleSidebar() {
                const sidebar = document.getElementById('sidebar');
                if (sidebar) {
                    sidebar.classList.toggle('active');
                }
            }
            
            static updateOnlineUsers() {
                const onlineList = document.getElementById('onlineList');
                const onlineCount = document.getElementById('onlineCount');
                
                if (!onlineList || !onlineCount) return;
                
                // Contar usuários online
                const onlineUsers = Object.values(AppState.users).filter(user => 
                    user.status === 'online'
                );
                
                // Atualizar contador
                onlineCount.textContent = onlineUsers.length;
                
                // Atualizar lista
                onlineList.innerHTML = '';
                
                onlineUsers.slice(0, 10).forEach(user => {
                    const onlineUser = document.createElement('div');
                    onlineUser.className = 'online-user';
                    onlineUser.innerHTML = `
                        <img src="${user.profile.avatar}" class="online-user-avatar" alt="${user.username}">
                        <div class="online-user-name">${user.username}</div>
                    `;
                    
                    onlineUser.onclick = () => {
                        UISystem.viewUserProfile(user.id);
                    };
                    
                    onlineList.appendChild(onlineUser);
                });
                
                // Adicionar "e mais X..." se houver mais usuários
                if (onlineUsers.length > 10) {
                    const more = document.createElement('div');
                    more.className = 'online-user text-muted text-center';
                    more.textContent = `e mais ${onlineUsers.length - 10}...`;
                    onlineList.appendChild(more);
                }
            }
            
            static viewUserProfile(userId) {
                if (!userId || !AppState.users[userId]) return;
                
                const user = AppState.users[userId];
                
                // Criar modal de perfil
                const modal = document.createElement('div');
                modal.className = 'modal-backdrop';
                modal.id = 'profileModal';
                modal.innerHTML = `
                    <div class="modal modal-lg">
                        <div class="modal-header">
                            <div class="modal-title">Perfil de ${user.username}</div>
                            <button class="modal-close" onclick="ModalSystem.hide('profileModal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="profile-main">
                                <div class="profile-sidebar">
                                    <img src="${user.profile.avatar}" class="profile-avatar" alt="${user.username}">
                                    
                                    ${user.profile.badges && user.profile.badges.length > 0 ? `
                                        <div class="mb-4">
                                            <h4>Badges</h4>
                                            <div class="tags">
                                                ${user.profile.badges.map(badge => `
                                                    <span class="badge badge-primary">${badge}</span>
                                                `).join('')}
                                            </div>
                                        </div>
                                    ` : ''}
                                    
                                    <div class="profile-stats">
                                        <div class="stat-item">
                                            <span>Teorias</span>
                                            <span>${user.stats.theories || 0}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span>Reputação</span>
                                            <span>${user.stats.reputation || 0}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span>Amigos</span>
                                            <span>${user.stats.friends || 0}</span>
                                        </div>
                                        <div class="stat-item">
                                            <span>Colaborações</span>
                                            <span>${user.stats.collaborations || 0}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="profile-content">
                                    <div class="profile-tabs">
                                        <button class="profile-tab active" onclick="UISystem.switchProfileTab('info', this)">Informações</button>
                                        <button class="profile-tab" onclick="UISystem.switchProfileTab('activity', this)">Atividade</button>
                                        <button class="profile-tab" onclick="UISystem.switchProfileTab('theories', this)">Teorias</button>
                                    </div>
                                    
                                    <div class="profile-section active" id="profileInfo">
                                        <h3>Sobre</h3>
                                        <p>${user.profile.bio || 'Sem biografia disponível.'}</p>
                                        
                                        ${user.profile.specialization ? `
                                            <div class="mb-3">
                                                <strong>Especialização:</strong> ${user.profile.specialization}
                                            </div>
                                        ` : ''}
                                        
                                        ${user.profile.location ? `
                                            <div class="mb-3">
                                                <strong>Localização:</strong> ${user.profile.location}
                                            </div>
                                        ` : ''}
                                        
                                        ${user.profile.website ? `
                                            <div class="mb-3">
                                                <strong>Website:</strong> <a href="${user.profile.website}" target="_blank">${user.profile.website}</a>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <div class="profile-section" id="profileActivity">
                                        <h3>Atividade Recente</h3>
                                        <p class="text-muted">Histórico de atividade em breve...</p>
                                    </div>
                                    
                                    <div class="profile-section" id="profileTheories">
                                        <h3>Teorias Publicadas</h3>
                                        <p class="text-muted">Teorias do usuário em breve...</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            ${AppState.currentUser !== userId ? `
                                ${AppState.friends[AppState.currentUser]?.includes(userId) ? `
                                    <button class="btn btn-danger" onclick="FriendSystem.removeFriend('${userId}')">
                                        <i class="fas fa-user-times"></i> Remover Amigo
                                    </button>
                                ` : `
                                    <button class="btn btn-primary" onclick="FriendSystem.sendRequest('${userId}')">
                                        <i class="fas fa-user-plus"></i> Adicionar Amigo
                                    </button>
                                `}
                                <button class="btn btn-secondary" onclick="UISystem.startPrivateChat('${userId}')">
                                    <i class="fas fa-comment"></i> Mensagem
                                </button>
                            ` : ''}
                            <button class="btn btn-secondary" onclick="ModalSystem.hide('profileModal')">
                                Fechar
                            </button>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modal);
                ModalSystem.show('profileModal');
            }
            
            static switchProfileTab(tab, button) {
                // Atualizar tabs
                document.querySelectorAll('#profileModal .profile-tab').forEach(t => t.classList.remove('active'));
                document.querySelectorAll('#profileModal .profile-section').forEach(s => s.classList.remove('active'));
                
                // Ativar tab clicada
                button.classList.add('active');
                
                // Mostrar seção correspondente
                const section = document.getElementById(`profile${tab.charAt(0).toUpperCase() + tab.slice(1)}`);
                if (section) {
                    section.classList.add('active');
                }
            }
            
            static startPrivateChat(userId) {
                ModalSystem.hide('profileModal');
                loadSection('messages');
                
                // Focar no chat com o usuário
                setTimeout(() => {
                    // Implementar foco no chat privado
                    ToastSystem.info(`Iniciar chat com ${AppState.users[userId]?.username}`);
                }, 100);
            }
            
            static formatDate(dateString) {
                const date = new Date(dateString);
                const now = new Date();
                const diff = now - date;
                
                // Menos de 1 minuto
                if (diff < 60000) {
                    return 'agora mesmo';
                }
                
                // Menos de 1 hora
                if (diff < 3600000) {
                    const minutes = Math.floor(diff / 60000);
                    return `há ${minutes} minuto${minutes !== 1 ? 's' : ''}`;
                }
                
                // Hoje
                if (date.toDateString() === now.toDateString()) {
                    return `hoje às ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                }
                
                // Ontem
                const yesterday = new Date(now);
                yesterday.setDate(yesterday.getDate() - 1);
                if (date.toDateString() === yesterday.toDateString()) {
                    return `ontem às ${date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' })}`;
                }
                
                // Este ano
                if (date.getFullYear() === now.getFullYear()) {
                    return date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short' });
                }
                
                // Outro ano
                return date.toLocaleDateString('pt-BR', { day: 'numeric', month: 'short', year: 'numeric' });
            }
            
            static formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }
        }

        // ============================================
        // 5. SISTEMA DE TEORIAS
        // ============================================

        class TheorySystem {
            static createTheory(data) {
                return LoadingSystem.wrap(new Promise((resolve, reject) => {
                    try {
                        // Validar dados
                        if (!Validator.theoryTitle(data.title)) {
                            throw new Error('Título deve ter entre 5 e 200 caracteres');
                        }
                        
                        if (!Validator.theoryContent(data.content)) {
                            throw new Error('Conteúdo deve ter entre 100 e 100.000 caracteres');
                        }
                        
                        if (!data.category) {
                            throw new Error('Selecione uma categoria');
                        }
                        
                        // Criar teoria
                        const theory = {
                            id: `theory_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            title: data.title,
                            author: AppState.currentUser,
                            content: data.content,
                            category: data.category,
                            tags: data.tags || [],
                            status: AppState.isNucleo ? 'approved' : 'pending',
                            visibility: data.visibility || 'public',
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            views: 0,
                            upvotes: 0,
                            downvotes: 0,
                            collaborators: data.collaborators || [],
                            comments: [],
                            attachments: data.attachments || [],
                            version: 1
                        };
                        
                        // Adicionar ao estado
                        AppState.theories.push(theory);
                        
                        // Atualizar estatísticas do usuário
                        if (AppState.users[AppState.currentUser]) {
                            AppState.users[AppState.currentUser].stats.theories++;
                        }
                        
                        // Salvar estado
                        StorageSystem.save();
                        
                        // Notificar núcleo se necessário
                        if (!AppState.isNucleo) {
                            this.notifyNucleo(theory);
                        }
                        
                        // Retornar teoria criada
                        resolve(theory);
                    } catch (error) {
                        ToastSystem.error(error.message);
                        reject(error);
                    }
                }), 'Criando teoria...');
            }
            
            static updateTheory(theoryId, data) {
                const theory = AppState.theories.find(t => t.id === theoryId);
                if (!theory) {
                    throw new Error('Teoria não encontrada');
                }
                
                // Verificar permissão
                if (theory.author !== AppState.currentUser && !AppState.isNucleo) {
                    throw new Error('Sem permissão para editar esta teoria');
                }
                
                // Atualizar dados
                Object.assign(theory, data);
                theory.updatedAt = new Date().toISOString();
                theory.version++;
                
                // Salvar estado
                StorageSystem.save();
                
                return theory;
            }
            
            static deleteTheory(theoryId) {
                const index = AppState.theories.findIndex(t => t.id === theoryId);
                if (index === -1) {
                    throw new Error('Teoria não encontrada');
                }
                
                const theory = AppState.theories[index];
                
                // Verificar permissão
                if (theory.author !== AppState.currentUser && !AppState.isNucleo) {
                    throw new Error('Sem permissão para excluir esta teoria');
                }
                
                // Remover teoria
                AppState.theories.splice(index, 1);
                
                // Atualizar estatísticas do usuário
                if (AppState.users[theory.author]) {
                    AppState.users[theory.author].stats.theories--;
                }
                
                // Salvar estado
                StorageSystem.save();
                
                return true;
            }
            
            static approveTheory(theoryId) {
                if (!AppState.isNucleo) {
                    throw new Error('Apenas membros do núcleo podem aprovar teorias');
                }
                
                const theory = AppState.theories.find(t => t.id === theoryId);
                if (!theory) {
                    throw new Error('Teoria não encontrada');
                }
                
                theory.status = 'approved';
                theory.updatedAt = new Date().toISOString();
                
                // Notificar autor
                this.notifyAuthor(theory, 'approved');
                
                StorageSystem.save();
                
                return theory;
            }
            
            static rejectTheory(theoryId, reason) {
                if (!AppState.isNucleo) {
                    throw new Error('Apenas membros do núcleo podem rejeitar teorias');
                }
                
                const theory = AppState.theories.find(t => t.id === theoryId);
                if (!theory) {
                    throw new Error('Teoria não encontrada');
                }
                
                theory.status = 'rejected';
                theory.rejectionReason = reason;
                theory.updatedAt = new Date().toISOString();
                
                // Notificar autor
                this.notifyAuthor(theory, 'rejected', reason);
                
                StorageSystem.save();
                
                return theory;
            }
            
            static notifyNucleo(theory) {
                // Encontrar membros do núcleo
                const nucleoMembers = Object.entries(AppState.users)
                    .filter(([_, user]) => user.nucleo)
                    .map(([id, _]) => id);
                
                // Criar notificações
                nucleoMembers.forEach(memberId => {
                    if (memberId !== theory.author) {
                        const notification = {
                            id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            type: 'theory_pending',
                            recipient: memberId,
                            title: 'Nova teoria pendente',
                            message: `${AppState.users[theory.author]?.username} submeteu uma nova teoria: "${theory.title}"`,
                            data: { theoryId: theory.id },
                            read: false,
                            timestamp: new Date().toISOString()
                        };
                        
                        AppState.notifications.push(notification);
                    }
                });
            }
            
            static notifyAuthor(theory, action, reason = '') {
                const notification = {
                    id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: `theory_${action}`,
                    recipient: theory.author,
                    title: action === 'approved' ? 'Teoria aprovada!' : 'Teoria rejeitada',
                    message: action === 'approved' 
                        ? `Sua teoria "${theory.title}" foi aprovada pelo núcleo.`
                        : `Sua teoria "${theory.title}" foi rejeitada.${reason ? ` Motivo: ${reason}` : ''}`,
                    data: { theoryId: theory.id },
                    read: false,
                    timestamp: new Date().toISOString()
                };
                
                AppState.notifications.push(notification);
                AuthSystem.updateNotificationBadges();
            }
            
            static getTheory(theoryId) {
                return AppState.theories.find(t => t.id === theoryId);
            }
            
            static getUserTheories(userId) {
                return AppState.theories.filter(t => t.author === userId);
            }
            
            static getPublicTheories() {
                return AppState.theories.filter(t => 
                    t.status === 'approved' && t.visibility === 'public'
                );
            }
            
            static getPendingTheories() {
                return AppState.theories.filter(t => t.status === 'pending');
            }
            
            static searchTheories(query, filters = {}) {
                let results = AppState.theories.filter(t => 
                    t.status === 'approved' && t.visibility === 'public'
                );
                
                // Aplicar filtros
                if (filters.category) {
                    results = results.filter(t => t.category === filters.category);
                }
                
                if (filters.author) {
                    results = results.filter(t => t.author === filters.author);
                }
                
                if (filters.tags && filters.tags.length > 0) {
                    results = results.filter(t => 
                        t.tags.some(tag => filters.tags.includes(tag))
                    );
                }
                
                // Aplicar busca
                if (query) {
                    const q = query.toLowerCase();
                    results = results.filter(t => 
                        t.title.toLowerCase().includes(q) ||
                        t.content.toLowerCase().includes(q) ||
                        t.tags.some(tag => tag.toLowerCase().includes(q))
                    );
                }
                
                // Ordenar por relevância/atualização
                results.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                
                return results;
            }
            
            static addComment(theoryId, content) {
                const theory = AppState.theories.find(t => t.id === theoryId);
                if (!theory) {
                    throw new Error('Teoria não encontrada');
                }
                
                const comment = {
                    id: `comment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    author: AppState.currentUser,
                    content: content,
                    timestamp: new Date().toISOString(),
                    upvotes: 0,
                    replies: []
                };
                
                theory.comments.push(comment);
                theory.updatedAt = new Date().toISOString();
                
                // Notificar autor (se não for o próprio autor)
                if (theory.author !== AppState.currentUser) {
                    const notification = {
                        id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        type: 'theory_comment',
                        recipient: theory.author,
                        title: 'Novo comentário',
                        message: `${AppState.users[AppState.currentUser]?.username} comentou na sua teoria "${theory.title}"`,
                        data: { theoryId: theory.id, commentId: comment.id },
                        read: false,
                        timestamp: new Date().toISOString()
                    };
                    
                    AppState.notifications.push(notification);
                    AuthSystem.updateNotificationBadges();
                }
                
                StorageSystem.save();
                
                return comment;
            }
            
            static voteTheory(theoryId, vote) {
                const theory = AppState.theories.find(t => t.id === theoryId);
                if (!theory) {
                    throw new Error('Teoria não encontrada');
                }
                
                // Verificar se usuário já votou
                const voteKey = `${AppState.currentUser}_${vote}`;
                
                if (vote === 'up') {
                    theory.upvotes++;
                } else if (vote === 'down') {
                    theory.downvotes++;
                }
                
                StorageSystem.save();
                
                return theory;
            }
        }

        // ============================================
        // 6. SISTEMA DE AMIGOS
        // ============================================

        class FriendSystem {
            static sendRequest(toUserId) {
                if (!toUserId || toUserId === AppState.currentUser) {
                    throw new Error('Não é possível enviar solicitação para si mesmo');
                }
                
                if (AppState.friends[AppState.currentUser]?.includes(toUserId)) {
                    throw new Error('Vocês já são amigos');
                }
                
                // Verificar se já existe solicitação pendente
                const existingRequest = (AppState.friendRequests[toUserId] || []).find(
                    r => r.from === AppState.currentUser && r.status === 'pending'
                );
                
                if (existingRequest) {
                    throw new Error('Solicitação já enviada');
                }
                
                // Criar solicitação
                const request = {
                    id: `fr_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    from: AppState.currentUser,
                    to: toUserId,
                    status: 'pending',
                    sentAt: new Date().toISOString(),
                    message: ''
                };
                
                // Adicionar às solicitações do destinatário
                if (!AppState.friendRequests[toUserId]) {
                    AppState.friendRequests[toUserId] = [];
                }
                AppState.friendRequests[toUserId].push(request);
                
                // Notificar destinatário
                const notification = {
                    id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: 'friend_request',
                    recipient: toUserId,
                    title: 'Solicitação de amizade',
                    message: `${AppState.users[AppState.currentUser]?.username} enviou uma solicitação de amizade`,
                    data: { requestId: request.id },
                    read: false,
                    timestamp: new Date().toISOString()
                };
                
                AppState.notifications.push(notification);
                
                // Salvar estado
                StorageSystem.save();
                
                // Atualizar badges
                AuthSystem.updateNotificationBadges();
                
                return request;
            }
            
            static acceptRequest(requestId) {
                const request = this.findRequest(requestId);
                if (!request) {
                    throw new Error('Solicitação não encontrada');
                }
                
                if (request.to !== AppState.currentUser) {
                    throw new Error('Esta solicitação não é para você');
                }
                
                request.status = 'accepted';
                request.respondedAt = new Date().toISOString();
                
                // Adicionar como amigos
                this.addFriendship(request.from, request.to);
                
                // Notificar remetente
                const notification = {
                    id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: 'friend_accepted',
                    recipient: request.from,
                    title: 'Solicitação aceita',
                    message: `${AppState.users[AppState.currentUser]?.username} aceitou sua solicitação de amizade`,
                    read: false,
                    timestamp: new Date().toISOString()
                };
                
                AppState.notifications.push(notification);
                
                // Salvar estado
                StorageSystem.save();
                
                // Atualizar badges
                AuthSystem.updateNotificationBadges();
                
                return request;
            }
            
            static rejectRequest(requestId) {
                const request = this.findRequest(requestId);
                if (!request) {
                    throw new Error('Solicitação não encontrada');
                }
                
                if (request.to !== AppState.currentUser) {
                    throw new Error('Esta solicitação não é para você');
                }
                
                request.status = 'rejected';
                request.respondedAt = new Date().toISOString();
                
                // Salvar estado
                StorageSystem.save();
                
                // Atualizar badges
                AuthSystem.updateNotificationBadges();
                
                return request;
            }
            
            static removeFriend(friendId) {
                if (!friendId) return;
                
                // Remover de ambas as listas
                if (AppState.friends[AppState.currentUser]) {
                    AppState.friends[AppState.currentUser] = AppState.friends[AppState.currentUser].filter(
                        id => id !== friendId
                    );
                }
                
                if (AppState.friends[friendId]) {
                    AppState.friends[friendId] = AppState.friends[friendId].filter(
                        id => id !== AppState.currentUser
                    );
                }
                
                // Atualizar estatísticas
                if (AppState.users[AppState.currentUser]) {
                    AppState.users[AppState.currentUser].stats.friends--;
                }
                
                if (AppState.users[friendId]) {
                    AppState.users[friendId].stats.friends--;
                }
                
                // Salvar estado
                StorageSystem.save();
                
                return true;
            }
            
            static findRequest(requestId) {
                for (const userId in AppState.friendRequests) {
                    const request = AppState.friendRequests[userId].find(r => r.id === requestId);
                    if (request) return request;
                }
                return null;
            }
            
            static addFriendship(userId1, userId2) {
                // Adicionar à lista do primeiro usuário
                if (!AppState.friends[userId1]) {
                    AppState.friends[userId1] = [];
                }
                if (!AppState.friends[userId1].includes(userId2)) {
                    AppState.friends[userId1].push(userId2);
                }
                
                // Adicionar à lista do segundo usuário
                if (!AppState.friends[userId2]) {
                    AppState.friends[userId2] = [];
                }
                if (!AppState.friends[userId2].includes(userId1)) {
                    AppState.friends[userId2].push(userId1);
                }
                
                // Atualizar estatísticas
                if (AppState.users[userId1]) {
                    AppState.users[userId1].stats.friends++;
                }
                
                if (AppState.users[userId2]) {
                    AppState.users[userId2].stats.friends++;
                }
            }
            
            static getFriends(userId) {
                return AppState.friends[userId] || [];
            }
            
            static getFriendRequests(userId) {
                return AppState.friendRequests[userId] || [];
            }
            
            static searchUsers(query, excludeFriends = true) {
                let results = Object.entries(AppState.users)
                    .filter(([id, user]) => id !== AppState.currentUser);
                
                // Filtrar amigos se necessário
                if (excludeFriends) {
                    const friends = AppState.friends[AppState.currentUser] || [];
                    results = results.filter(([id, _]) => !friends.includes(id));
                }
                
                // Aplicar busca
                if (query) {
                    const q = query.toLowerCase();
                    results = results.filter(([_, user]) => 
                        user.username.toLowerCase().includes(q) ||
                        user.email.toLowerCase().includes(q) ||
                        (user.profile.bio && user.profile.bio.toLowerCase().includes(q))
                    );
                }
                
                return results.map(([id, user]) => ({ id, ...user }));
            }
        }

        // ============================================
        // 7. SISTEMA DE CHAT
        // ============================================

        class ChatSystem {
            static sendMessage(channel, content, type = 'text') {
                if (!channel || !content) {
                    throw new Error('Canal e conteúdo são obrigatórios');
                }
                
                if (content.length > RENOVA_CONFIG.MAX_MESSAGE_LENGTH) {
                    throw new Error(`Mensagem muito longa (máximo ${RENOVA_CONFIG.MAX_MESSAGE_LENGTH} caracteres)`);
                }
                
                // Criar mensagem
                const message = {
                    id: `msg_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    author: AppState.currentUser,
                    content: content,
                    type: type,
                    timestamp: new Date().toISOString(),
                    channel: channel,
                    edited: false,
                    reactions: {}
                };
                
                // Adicionar ao canal
                if (!AppState.chatMessages[channel]) {
                    AppState.chatMessages[channel] = [];
                }
                AppState.chatMessages[channel].push(message);
                
                // Salvar estado
                StorageSystem.save();
                
                return message;
            }
            
            static getChannelMessages(channel, limit = 100) {
                if (!AppState.chatMessages[channel]) {
                    return [];
                }
                
                return AppState.chatMessages[channel]
                    .slice(-limit)
                    .map(msg => ({
                        ...msg,
                        authorName: AppState.users[msg.author]?.username || 'Desconhecido',
                        authorAvatar: AppState.users[msg.author]?.profile?.avatar
                    }));
            }
            
            static getChannels() {
                const channels = [
                    { id: 'geral', name: 'Geral', icon: 'fas fa-hashtag', topic: 'Conversas gerais da comunidade' },
                    { id: 'matematica', name: 'Matemática', icon: 'fas fa-square-root-alt', topic: 'Discussões matemáticas avançadas' },
                    { id: 'fisica', name: 'Física', icon: 'fas fa-atom', topic: 'Física teórica e experimental' },
                    { id: 'computacao', name: 'Computação', icon: 'fas fa-code', topic: 'Algoritmos, IA e teoria da computação' },
                    { id: 'pvsnp', name: 'P vs NP', icon: 'fas fa-trophy', topic: 'Discussões sobre o problema P vs NP' },
                    { id: 'riemann', name: 'Riemann', icon: 'fas fa-trophy', topic: 'Hipótese de Riemann e teoria dos números' }
                ];
                
                return channels;
            }
            
            static createPrivateMessage(toUserId, content) {
                if (!toUserId || !content) {
                    throw new Error('Destinatário e conteúdo são obrigatórios');
                }
                
                if (!AppState.users[toUserId]) {
                    throw new Error('Usuário não encontrado');
                }
                
                // Criar ID de conversa (ordenado para consistência)
                const conversationId = [AppState.currentUser, toUserId].sort().join('_');
                
                // Criar mensagem
                const message = {
                    id: `pm_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    sender: AppState.currentUser,
                    receiver: toUserId,
                    content: content,
                    timestamp: new Date().toISOString(),
                    read: false,
                    type: 'text'
                };
                
                // Adicionar às mensagens do remetente
                if (!AppState.privateMessages[AppState.currentUser]) {
                    AppState.privateMessages[AppState.currentUser] = {};
                }
                if (!AppState.privateMessages[AppState.currentUser][conversationId]) {
                    AppState.privateMessages[AppState.currentUser][conversationId] = [];
                }
                AppState.privateMessages[AppState.currentUser][conversationId].push(message);
                
                // Adicionar às mensagens do destinatário
                if (!AppState.privateMessages[toUserId]) {
                    AppState.privateMessages[toUserId] = {};
                }
                if (!AppState.privateMessages[toUserId][conversationId]) {
                    AppState.privateMessages[toUserId][conversationId] = [];
                }
                AppState.privateMessages[toUserId][conversationId].push(message);
                
                // Notificar destinatário
                const notification = {
                    id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    type: 'private_message',
                    recipient: toUserId,
                    title: 'Nova mensagem privada',
                    message: `${AppState.users[AppState.currentUser]?.username}: ${content.substring(0, 50)}${content.length > 50 ? '...' : ''}`,
                    data: { conversationId, senderId: AppState.currentUser },
                    read: false,
                    timestamp: new Date().toISOString()
                };
                
                AppState.notifications.push(notification);
                
                // Salvar estado
                StorageSystem.save();
                
                // Atualizar badges
                AuthSystem.updateNotificationBadges();
                
                return message;
            }
            
            static getPrivateConversations() {
                if (!AppState.privateMessages[AppState.currentUser]) {
                    return [];
                }
                
                const conversations = [];
                
                for (const [conversationId, messages] of Object.entries(AppState.privateMessages[AppState.currentUser])) {
                    if (messages.length > 0) {
                        // Extrair IDs dos participantes
                        const participantIds = conversationId.split('_');
                        const otherUserId = participantIds.find(id => id !== AppState.currentUser);
                        
                        if (otherUserId && AppState.users[otherUserId]) {
                            const lastMessage = messages[messages.length - 1];
                            const unreadCount = messages.filter(m => 
                                m.sender !== AppState.currentUser && !m.read
                            ).length;
                            
                            conversations.push({
                                id: conversationId,
                                userId: otherUserId,
                                username: AppState.users[otherUserId].username,
                                avatar: AppState.users[otherUserId].profile.avatar,
                                lastMessage: lastMessage.content,
                                lastMessageTime: lastMessage.timestamp,
                                unreadCount: unreadCount
                            });
                        }
                    }
                }
                
                // Ordenar por última mensagem
                conversations.sort((a, b) => 
                    new Date(b.lastMessageTime) - new Date(a.lastMessageTime)
                );
                
                return conversations;
            }
            
            static getPrivateMessages(conversationId) {
                if (!AppState.privateMessages[AppState.currentUser]) {
                    return [];
                }
                
                return AppState.privateMessages[AppState.currentUser][conversationId] || [];
            }
            
            static markAsRead(conversationId) {
                if (!AppState.privateMessages[AppState.currentUser] || 
                    !AppState.privateMessages[AppState.currentUser][conversationId]) {
                    return;
                }
                
                const messages = AppState.privateMessages[AppState.currentUser][conversationId];
                messages.forEach(message => {
                    if (message.sender !== AppState.currentUser) {
                        message.read = true;
                    }
                });
                
                // Atualizar badges
                AuthSystem.updateNotificationBadges();
                
                StorageSystem.save();
            }
        }

        // ============================================
        // 8. SISTEMA DE FÓRUM
        // ============================================

        class ForumSystem {
            static createPost(data) {
                return LoadingSystem.wrap(new Promise((resolve, reject) => {
                    try {
                        // Validar dados
                        if (!data.title || data.title.length < 5) {
                            throw new Error('Título deve ter pelo menos 5 caracteres');
                        }
                        
                        if (!data.content || data.content.length < 20) {
                            throw new Error('Conteúdo deve ter pelo menos 20 caracteres');
                        }
                        
                        if (!data.category) {
                            throw new Error('Selecione uma categoria');
                        }
                        
                        // Criar post
                        const post = {
                            id: `post_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            title: data.title,
                            content: data.content,
                            author: AppState.currentUser,
                            category: data.category,
                            tags: data.tags || [],
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            views: 0,
                            upvotes: 0,
                            downvotes: 0,
                            comments: [],
                            pinned: false,
                            locked: false
                        };
                        
                        // Adicionar ao estado
                        AppState.forumPosts.push(post);
                        
                        // Atualizar estatísticas do usuário
                        if (AppState.users[AppState.currentUser]) {
                            AppState.users[AppState.currentUser].stats.posts++;
                        }
                        
                        // Salvar estado
                        StorageSystem.save();
                        
                        resolve(post);
                    } catch (error) {
                        ToastSystem.error(error.message);
                        reject(error);
                    }
                }), 'Criando post...');
            }
            
            static getPosts(category = null, limit = 50) {
                let posts = AppState.forumPosts;
                
                // Filtrar por categoria
                if (category) {
                    posts = posts.filter(p => p.category === category);
                }
                
                // Ordenar (pinned primeiro, depois por data)
                posts.sort((a, b) => {
                    if (a.pinned && !b.pinned) return -1;
                    if (!a.pinned && b.pinned) return 1;
                    return new Date(b.updatedAt) - new Date(a.updatedAt);
                });
                
                // Limitar
                return posts.slice(0, limit);
            }
            
            static getCategories() {
                return [
                    { id: 'matematica', name: 'Matemática', icon: 'fas fa-square-root-alt', description: 'Discussões matemáticas' },
                    { id: 'fisica', name: 'Física', icon: 'fas fa-atom', description: 'Física teórica e experimental' },
                    { id: 'computacao', name: 'Computação', icon: 'fas fa-code', description: 'Algoritmos e teoria' },
                    { id: 'biologia', name: 'Biologia', icon: 'fas fa-dna', description: 'Biologia matemática' },
                    { id: 'filosofia', name: 'Filosofia', icon: 'fas fa-brain', description: 'Filosofia da ciência' },
                    { id: 'geral', name: 'Geral', icon: 'fas fa-comments', description: 'Discussões gerais' }
                ];
            }
            
            static addComment(postId, content) {
                const post = AppState.forumPosts.find(p => p.id === postId);
                if (!post) {
                    throw new Error('Post não encontrado');
                }
                
                if (post.locked) {
                    throw new Error('Este post está trancado');
                }
                
                const comment = {
                    id: `comment_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                    author: AppState.currentUser,
                    content: content,
                    timestamp: new Date().toISOString(),
                    upvotes: 0
                };
                
                post.comments.push(comment);
                post.updatedAt = new Date().toISOString();
                
                // Notificar autor (se não for o próprio autor)
                if (post.author !== AppState.currentUser) {
                    const notification = {
                        id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        type: 'forum_comment',
                        recipient: post.author,
                        title: 'Novo comentário no fórum',
                        message: `${AppState.users[AppState.currentUser]?.username} comentou no seu post "${post.title}"`,
                        data: { postId: post.id, commentId: comment.id },
                        read: false,
                        timestamp: new Date().toISOString()
                    };
                    
                    AppState.notifications.push(notification);
                    AuthSystem.updateNotificationBadges();
                }
                
                StorageSystem.save();
                
                return comment;
            }
        }

        // ============================================
        // 9. SISTEMA DE GRUPOS
        // ============================================

        class GroupSystem {
            static createGroup(data) {
                return LoadingSystem.wrap(new Promise((resolve, reject) => {
                    try {
                        // Validar dados
                        if (!data.name || data.name.length < 3) {
                            throw new Error('Nome do grupo deve ter pelo menos 3 caracteres');
                        }
                        
                        if (!data.description || data.description.length < 10) {
                            throw new Error('Descrição deve ter pelo menos 10 caracteres');
                        }
                        
                        // Criar grupo
                        const group = {
                            id: `group_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                            name: data.name,
                            description: data.description,
                            owner: AppState.currentUser,
                            category: data.category || 'geral',
                            tags: data.tags || [],
                            privacy: data.privacy || 'public', // public, private, hidden
                            createdAt: new Date().toISOString(),
                            updatedAt: new Date().toISOString(),
                            members: [AppState.currentUser],
                            posts: [],
                            files: [],
                            events: [],
                            settings: {
                                allowPosts: true,
                                allowFiles: true,
                                requireApproval: false
                            }
                        };
                        
                        // Adicionar ao estado
                        AppState.groups[group.id] = group;
                        
                        // Salvar estado
                        StorageSystem.save();
                        
                        resolve(group);
                    } catch (error) {
                        ToastSystem.error(error.message);
                        reject(error);
                    }
                }), 'Criando grupo...');
            }
            
            static joinGroup(groupId) {
                const group = AppState.groups[groupId];
                if (!group) {
                    throw new Error('Grupo não encontrado');
                }
                
                if (group.members.includes(AppState.currentUser)) {
                    throw new Error('Você já é membro deste grupo');
                }
                
                // Verificar privacidade
                if (group.privacy === 'private') {
                    throw new Error('Este grupo é privado. Solicite um convite.');
                }
                
                // Adicionar membro
                group.members.push(AppState.currentUser);
                group.updatedAt = new Date().toISOString();
                
                // Notificar dono do grupo
                if (group.owner !== AppState.currentUser) {
                    const notification = {
                        id: `notif_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
                        type: 'group_join',
                        recipient: group.owner,
                        title: 'Novo membro no grupo',
                        message: `${AppState.users[AppState.currentUser]?.username} entrou no grupo "${group.name}"`,
                        data: { groupId: group.id },
                        read: false,
                        timestamp: new Date().toISOString()
                    };
                    
                    AppState.notifications.push(notification);
                    AuthSystem.updateNotificationBadges();
                }
                
                StorageSystem.save();
                
                return group;
            }
            
            static leaveGroup(groupId) {
                const group = AppState.groups[groupId];
                if (!group) {
                    throw new Error('Grupo não encontrado');
                }
                
                if (!group.members.includes(AppState.currentUser)) {
                    throw new Error('Você não é membro deste grupo');
                }
                
                // Não permitir que o dono saia (deve transferir ou excluir)
                if (group.owner === AppState.currentUser) {
                    throw new Error('O dono do grupo não pode sair. Transfira a propriedade primeiro.');
                }
                
                // Remover membro
                group.members = group.members.filter(m => m !== AppState.currentUser);
                group.updatedAt = new Date().toISOString();
                
                StorageSystem.save();
                
                return true;
            }
            
            static getGroups(filter = {}) {
                let groups = Object.values(AppState.groups);
                
                // Aplicar filtros
                if (filter.privacy) {
                    groups = groups.filter(g => g.privacy === filter.privacy);
                }
                
                if (filter.category) {
                    groups = groups.filter(g => g.category === filter.category);
                }
                
                if (filter.member) {
                    groups = groups.filter(g => g.members.includes(filter.member));
                }
                
                // Ordenar por atividade
                groups.sort((a, b) => new Date(b.updatedAt) - new Date(a.updatedAt));
                
                return groups;
            }
            
            static getUserGroups(userId) {
                return Object.values(AppState.groups).filter(g => 
                    g.members.includes(userId)
                );
            }
        }

        // ============================================
        // 10. FUNÇÕES GLOBAIS E INICIALIZAÇÃO
        // ============================================

        // Funções globais acessíveis no HTML
        window.switchAuthTab = UISystem.switchAuthTab;
        window.setTheme = UISystem.setTheme;
        window.showAboutModal = () => ModalSystem.show('aboutModal');
        window.showPrivacyModal = () => ModalSystem.show('privacyModal');
        window.hideModal = ModalSystem.hide;
        window.logout = AuthSystem.logout;

        // Login e registro
        window.login = async () => {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const masterKey = document.getElementById('loginMasterKey').value;
            
            try {
                await AuthSystem.login(username, password, masterKey);
            } catch (error) {
                // Erro já tratado pelo sistema
            }
        };

        window.register = async () => {
            const username = document.getElementById('registerUsername').value.trim();
            const email = document.getElementById('registerEmail').value.trim();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('registerConfirmPassword').value;
            const masterKey = document.getElementById('registerMasterKey').value;
            const specialization = document.getElementById('registerSpecialization').value;
            
            // Validação básica
            if (password !== confirmPassword) {
                ToastSystem.error('As senhas não coincidem');
                return;
            }
            
            try {
                await AuthSystem.register(username, email, password, masterKey, specialization);
            } catch (error) {
                // Erro já tratado pelo sistema
            }
        };

        window.recoverPassword = async () => {
            const email = document.getElementById('recoveryEmail').value.trim();
            
            try {
                await AuthSystem.recoverPassword(email);
            } catch (error) {
                // Erro já tratado pelo sistema
            }
        };

        // Sistema de navegação
        window.loadSection = async (section) => {
            AppState.currentSection = section;
            
            // Fechar menu mobile
            UISystem.toggleSidebar();
            
            // Atualizar menu ativo
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Marcar item ativo
            const navItem = document.querySelector(`.nav-item[onclick*="${section}"]`);
            if (navItem) {
                navItem.classList.add('active');
            }
            
            // Carregar conteúdo
            const mainContent = document.getElementById('mainContent');
            if (!mainContent) return;
            
            LoadingSystem.show('Carregando...');
            
            try {
                let content = '';
                
                switch (section) {
                    case 'dashboard-home':
                        content = await renderDashboardHome();
                        break;
                    case 'theories':
                        content = await renderTheoriesPage();
                        break;
                    case 'chat':
                        content = await renderChatPage();
                        break;
                    case 'forum':
                        content = await renderForumPage();
                        break;
                    case 'groups':
                        content = await renderGroupsPage();
                        break;
                    case 'friends':
                        content = await renderFriendsPage();
                        break;
                    case 'messages':
                        content = await renderMessagesPage();
                        break;
                    case 'profile':
                        content = await renderProfilePage();
                        break;
                    case 'settings':
                        content = await renderSettingsPage();
                        break;
                    case 'admin':
                        content = await renderAdminPage();
                        break;
                    default:
                        content = await renderDashboardHome();
                }
                
                mainContent.innerHTML = content;
                
                // Atualizar MathJax
                if (window.MathJax) {
                    MathJax.typesetPromise();
                }
                
                // Atualizar KaTeX
                if (window.katex) {
                    document.querySelectorAll('.katex').forEach(el => {
                        katex.render(el.textContent, el, {
                            throwOnError: false,
                            displayMode: el.classList.contains('display')
                        });
                    });
                }
            } catch (error) {
                Logger.error('Erro ao carregar seção:', error);
                mainContent.innerHTML = `
                    <div class="content-header">
                        <h1>Erro</h1>
                        <p class="subtitle">Não foi possível carregar esta seção</p>
                    </div>
                    <div class="card">
                        <div class="card-body">
                            <p class="text-danger">${error.message}</p>
                            <button class="btn btn-primary" onclick="loadSection('dashboard-home')">
                                Voltar ao Dashboard
                            </button>
                        </div>
                    </div>
                `;
            } finally {
                LoadingSystem.hide();
            }
        };

        // ============================================
        // FUNÇÕES DE RENDERIZAÇÃO DAS PÁGINAS
        // ============================================

        // 1. DASHBOARD HOME (Já existe)
        async function renderDashboardHome() {
            const user = AppState.users[AppState.currentUser];
            const theories = TheorySystem.getUserTheories(AppState.currentUser);
            const pendingTheories = TheorySystem.getPendingTheories();
            const friends = FriendSystem.getFriends(AppState.currentUser);
            const onlineUsers = Object.values(AppState.users).filter(u => u.status === 'online');
            
            return `
                <div class="content-header">
                    <h1>Dashboard</h1>
                    <p class="subtitle">Bem-vindo(a) ao Renova, ${user?.username || 'Cientista'}!</p>
                </div>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-book"></i>
                        </div>
                        <div class="stat-title">Minhas Teorias</div>
                        <div class="stat-value">${theories.length}</div>
                        <div class="stat-trend">
                            <i class="fas fa-chart-line"></i>
                            <span>${theories.filter(t => t.status === 'approved').length} aprovadas</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-user-friends"></i>
                        </div>
                        <div class="stat-title">Amigos</div>
                        <div class="stat-value">${friends.length}</div>
                        <div class="stat-trend">
                            <i class="fas fa-user"></i>
                            <span>${onlineUsers.length} online</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="stat-title">Mensagens</div>
                        <div class="stat-value">${AppState.unreadCounts.messages}</div>
                        <div class="stat-trend">
                            <i class="fas fa-inbox"></i>
                            <span>não lidas</span>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-icon">
                            <i class="fas fa-trophy"></i>
                        </div>
                        <div class="stat-title">Reputação</div>
                        <div class="stat-value">${user?.stats?.reputation || 0}</div>
                        <div class="stat-trend">
                            <i class="fas fa-star"></i>
                            <span>${AppState.isNucleo ? 'Núcleo' : 'Membro'}</span>
                        </div>
                    </div>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="mb-0">Ações Rápidas</h3>
                            </div>
                            <div class="card-body">
                                <div class="d-flex flex-wrap gap-3">
                                    <button class="btn btn-primary" onclick="loadSection('theories')">
                                        <i class="fas fa-plus"></i> Nova Teoria
                                    </button>
                                    <button class="btn btn-secondary" onclick="loadSection('chat')">
                                        <i class="fas fa-comments"></i> Chat Global
                                    </button>
                                    <button class="btn btn-success" onclick="loadSection('friends')">
                                        <i class="fas fa-user-plus"></i> Adicionar Amigo
                                    </button>
                                    <button class="btn btn-warning" onclick="loadSection('forum')">
                                        <i class="fas fa-comment-dots"></i> Novo Post
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h3 class="mb-0">Teorias Pendentes</h3>
                            </div>
                            <div class="card-body">
                                ${pendingTheories.length > 0 ? `
                                    <div class="theories-grid">
                                        ${pendingTheories.slice(0, 3).map(theory => `
                                            <div class="theory-card">
                                                <div class="theory-status status-pending">Pendente</div>
                                                <h4 class="theory-title">${theory.title}</h4>
                                                <div class="theory-meta">
                                                    <span>${AppState.users[theory.author]?.username || 'Desconhecido'}</span>
                                                    <span>${UISystem.formatDate(theory.createdAt)}</span>
                                                </div>
                                                <div class="theory-content">
                                                    ${theory.content.substring(0, 150)}...
                                                </div>
                                                <div class="theory-actions">
                                                    <button class="btn btn-sm btn-primary" onclick="viewTheory('${theory.id}')">
                                                        <i class="fas fa-eye"></i> Ver
                                                    </button>
                                                    ${AppState.isNucleo ? `
                                                        <button class="btn btn-sm btn-success" onclick="approveTheory('${theory.id}')">
                                                            <i class="fas fa-check"></i> Aprovar
                                                        </button>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${pendingTheories.length > 3 ? `
                                        <div class="text-center mt-3">
                                            <button class="btn btn-secondary" onclick="loadSection('theories')">
                                                Ver todas (${pendingTheories.length})
                                            </button>
                                        </div>
                                    ` : ''}
                                ` : `
                                    <p class="text-center text-muted mb-0">
                                        Nenhuma teoria pendente para revisão.
                                    </p>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="mb-0">Atividade Recente</h3>
                            </div>
                            <div class="card-body">
                                <div class="activity-list">
                                    <div class="activity-item">
                                        <div class="activity-icon theory">
                                            <i class="fas fa-book"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-text">
                                                <strong>${user?.username || 'Você'}</strong> criou uma nova teoria
                                            </div>
                                            <div class="activity-time">
                                                ${UISystem.formatDate(new Date().toISOString())}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="activity-item">
                                        <div class="activity-icon forum">
                                            <i class="fas fa-comment-dots"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-text">
                                                <strong>einstein</strong> respondeu no fórum
                                            </div>
                                            <div class="activity-time">
                                                ${UISystem.formatDate(new Date(Date.now() - 3600000).toISOString())}
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <div class="activity-item">
                                        <div class="activity-icon friend">
                                            <i class="fas fa-user-friends"></i>
                                        </div>
                                        <div class="activity-content">
                                            <div class="activity-text">
                                                <strong>newton</strong> aceitou sua solicitação de amizade
                                            </div>
                                            <div class="activity-time">
                                                ${UISystem.formatDate(new Date(Date.now() - 7200000).toISOString())}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h3 class="mb-0">Online Agora</h3>
                            </div>
                            <div class="card-body">
                                ${onlineUsers.length > 0 ? `
                                    <div class="online-list">
                                        ${onlineUsers.slice(0, 5).map(user => `
                                            <div class="online-user">
                                                <img src="${user.profile.avatar}" class="online-user-avatar" alt="${user.username}">
                                                <div class="online-user-name">${user.username}</div>
                                                <span class="status-dot status-online"></span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    ${onlineUsers.length > 5 ? `
                                        <div class="text-center mt-3">
                                            <span class="text-muted">e mais ${onlineUsers.length - 5} online</span>
                                        </div>
                                    ` : ''}
                                ` : `
                                    <p class="text-center text-muted mb-0">
                                        Nenhum usuário online no momento.
                                    </p>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 2. PÁGINA DE TEORIAS (Já existe)
        async function renderTheoriesPage() {
            const theories = TheorySystem.getUserTheories(AppState.currentUser);
            const publicTheories = TheorySystem.getPublicTheories();
            
            return `
                <div class="content-header">
                    <h1>Teorias Científicas</h1>
                    <p class="subtitle">Compartilhe e explore teorias revolucionárias</p>
                </div>
                
                <div class="card mb-4">
                    <div class="card-header">
                        <h3 class="mb-0">Minhas Teorias</h3>
                    </div>
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-4">
                            <div>
                                <span class="text-muted">${theories.length} teoria${theories.length !== 1 ? 's' : ''}</span>
                            </div>
                            <button class="btn btn-primary" onclick="showNewTheoryModal()">
                                <i class="fas fa-plus"></i> Nova Teoria
                            </button>
                        </div>
                        
                        ${theories.length > 0 ? `
                            <div class="theories-grid">
                                ${theories.slice().reverse().map(theory => `
                                    <div class="theory-card">
                                        <div class="theory-status status-${theory.status}">
                                            ${theory.status === 'draft' ? 'Rascunho' :
                                              theory.status === 'pending' ? 'Pendente' :
                                              theory.status === 'approved' ? 'Aprovada' : 'Rejeitada'}
                                        </div>
                                        <h4 class="theory-title">${theory.title}</h4>
                                        <div class="theory-meta">
                                            <span>${theory.category}</span>
                                            <span>${UISystem.formatDate(theory.createdAt)}</span>
                                            <span>${theory.views} visualizações</span>
                                        </div>
                                        <div class="theory-content">
                                            ${theory.content.substring(0, 150)}...
                                        </div>
                                        <div class="theory-actions">
                                            <button class="btn btn-sm btn-primary" onclick="viewTheory('${theory.id}')">
                                                <i class="fas fa-eye"></i> Ver
                                            </button>
                                            <button class="btn btn-sm btn-success" onclick="voteTheory('${theory.id}', 'up')">
                                                <i class="fas fa-thumbs-up"></i> ${theory.upvotes}
                                            </button>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        ` : `
                            <div class="text-center py-5">
                                <i class="fas fa-book-open fa-3x text-muted mb-3"></i>
                                <h4 class="text-muted">Nenhuma teoria pública</h4>
                                <p class="text-muted">Aguarde novas teorias sendo publicadas pela comunidade.</p>
                            </div>
                        `}
                    </div>
                </div>
            `;
        }

        // 3. PÁGINA DE CHAT (Já existe)
        async function renderChatPage() {
            const channels = ChatSystem.getChannels();
            
            return `
                <div class="content-header">
                    <h1>Chat Global</h1>
                    <p class="subtitle">Comunicação em tempo real para colaboração científica</p>
                </div>
                
                <div class="chat-container" id="chatContainer">
                    <div class="chat-sidebar">
                        <div class="chat-search">
                            <input type="text" class="form-control" placeholder="Buscar canais..." id="chatSearch">
                        </div>
                        <div class="chat-channels">
                            <div class="nav-title">Canais</div>
                            ${channels.map(channel => `
                                <div class="channel-item" onclick="selectChannel('${channel.id}')">
                                    <div class="channel-icon">
                                        <i class="${channel.icon}"></i>
                                    </div>
                                    <div class="channel-info">
                                        <div class="channel-name">${channel.name}</div>
                                        <div class="channel-topic">${channel.topic}</div>
                                    </div>
                                    <div class="channel-unread hidden" id="unread-${channel.id}">0</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                    
                    <div class="chat-main">
                        <div class="chat-header">
                            <div class="chat-info">
                                <div class="chat-title" id="currentChannelName">Geral</div>
                                <div class="chat-subtitle" id="currentChannelTopic">Conversas gerais da comunidade</div>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-icon btn-secondary" title="Membros">
                                    <i class="fas fa-users"></i>
                                </button>
                                <button class="btn btn-icon btn-secondary" title="Configurações">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="chat-messages" id="chatMessages">
                            <!-- Mensagens carregadas dinamicamente -->
                            <div class="text-center text-muted py-5">
                                <i class="fas fa-comments fa-3x mb-3"></i>
                                <p>Selecione um canal para começar a conversar</p>
                            </div>
                        </div>
                        
                        <div class="chat-input-area">
                            <div class="chat-input-toolbar">
                                <button class="editor-btn" onclick="insertLatex()">
                                    <i class="fas fa-square-root-alt"></i> LaTeX
                                </button>
                                <button class="editor-btn" onclick="insertCode()">
                                    <i class="fas fa-code"></i> Código
                                </button>
                                <button class="editor-btn" onclick="insertEquation()">
                                    <i class="fas fa-equals"></i> Equação
                                </button>
                                <button class="editor-btn" onclick="insertLink()">
                                    <i class="fas fa-link"></i> Link
                                </button>
                            </div>
                            <textarea 
                                class="chat-input" 
                                id="chatInput" 
                                placeholder="Digite sua mensagem... (Ctrl+Enter para enviar)"
                                rows="3"
                            ></textarea>
                            <div class="chat-input-actions">
                                <div class="d-flex gap-2">
                                    <button class="btn btn-icon btn-secondary">
                                        <i class="fas fa-smile"></i>
                                    </button>
                                    <button class="btn btn-icon btn-secondary">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                </div>
                                <button class="btn btn-primary" onclick="sendChatMessage()">
                                    <i class="fas fa-paper-plane"></i> Enviar
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 4. PÁGINA DE FÓRUM (Já existe)
        async function renderForumPage() {
            const categories = ForumSystem.getCategories();
            const posts = ForumSystem.getPosts();
            
            return `
                <div class="content-header">
                    <h1>Fórum Científico</h1>
                    <p class="subtitle">Discussões aprofundadas sobre ciência e matemática</p>
                </div>
                
                <div class="forum-container">
                    <div class="forum-categories">
                        <div class="nav-title">Categorias</div>
                        ${categories.map(cat => `
                            <div class="category-item" onclick="selectForumCategory('${cat.id}')">
                                <div class="channel-icon">
                                    <i class="${cat.icon}"></i>
                                </div>
                                <div class="channel-info">
                                    <div class="channel-name">${cat.name}</div>
                                    <div class="channel-topic">${cat.description}</div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                    
                    <div class="forum-main">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="mb-0">Todas as Discussões</h3>
                                <button class="btn btn-primary" onclick="showNewPostModal()">
                                    <i class="fas fa-plus"></i> Nova Discussão
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <table class="forum-table">
                                    <thead>
                                        <tr>
                                            <th style="width: 50%;">Tópico</th>
                                            <th>Autor</th>
                                            <th>Respostas</th>
                                            <th>Última Atividade</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${posts.length > 0 ? posts.slice(0, 20).map(post => `
                                            <tr onclick="viewForumPost('${post.id}')" style="cursor: pointer;">
                                                <td>
                                                    ${post.pinned ? '<i class="fas fa-thumbtack text-warning mr-2"></i>' : ''}
                                                    <div class="topic-title">${post.title}</div>
                                                    <div class="topic-excerpt">
                                                        ${post.content.substring(0, 100)}...
                                                    </div>
                                                    <div class="tags mt-2">
                                                        ${post.tags.map(tag => `
                                                            <span class="tag">${tag}</span>
                                                        `).join('')}
                                                    </div>
                                                </td>
                                                <td>
                                                    <div class="d-flex align-items-center gap-2">
                                                        <img src="${AppState.users[post.author]?.profile?.avatar || ''}" 
                                                             class="online-user-avatar" 
                                                             alt="${AppState.users[post.author]?.username || 'Desconhecido'}">
                                                        <div>${AppState.users[post.author]?.username || 'Desconhecido'}</div>
                                                    </div>
                                                </td>
                                                <td>${post.comments.length}</td>
                                                <td>${UISystem.formatDate(post.updatedAt)}</td>
                                            </tr>
                                        `).join('') : `
                                            <tr>
                                                <td colspan="4" class="text-center py-5">
                                                    <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                                    <h4 class="text-muted">Nenhuma discussão encontrada</h4>
                                                    <p class="text-muted">Seja o primeiro a iniciar uma discussão!</p>
                                                </td>
                                            </tr>
                                        `}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 5. PÁGINA DE AMIGOS (Já existe)
        async function renderFriendsPage() {
            const friends = FriendSystem.getFriends(AppState.currentUser);
            const requests = FriendSystem.getFriendRequests(AppState.currentUser);
            
            return `
                <div class="content-header">
                    <h1>Rede de Amigos</h1>
                    <p class="subtitle">Conecte-se com outros cientistas e colaboradores</p>
                </div>
                
                <div class="row">
                    <div class="col">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="mb-0">Buscar Cientistas</h3>
                            </div>
                            <div class="card-body">
                                <div class="search-box">
                                    <input type="text" 
                                           class="search-input" 
                                           id="friendSearch" 
                                           placeholder="Buscar por nome, email ou especialização...">
                                    <button class="btn btn-primary" onclick="searchFriends()">
                                        <i class="fas fa-search"></i>
                                    </button>
                                </div>
                                <div class="search-results" id="friendResults">
                                    <!-- Resultados da busca aparecerão aqui -->
                                </div>
                            </div>
                        </div>
                        
                        <div class="card mt-4">
                            <div class="card-header">
                                <h3 class="mb-0">Solicitações de Amizade</h3>
                                ${requests.length > 0 ? `
                                    <span class="badge badge-danger">${requests.filter(r => r.status === 'pending').length}</span>
                                ` : ''}
                            </div>
                            <div class="card-body">
                                ${requests.filter(r => r.status === 'pending').length > 0 ? `
                                    <div class="list-group">
                                        ${requests.filter(r => r.status === 'pending').map(request => {
                                            const user = AppState.users[request.from];
                                            return `
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div class="d-flex align-items-center gap-3">
                                                        <img src="${user?.profile?.avatar || ''}" 
                                                             class="online-user-avatar" 
                                                             alt="${user?.username || 'Desconhecido'}">
                                                        <div>
                                                            <div class="font-weight-bold">${user?.username || 'Desconhecido'}</div>
                                                            <small class="text-muted">${user?.profile?.specialization || 'Sem especialização'}</small>
                                                        </div>
                                                    </div>
                                                    <div class="d-flex gap-2">
                                                        <button class="btn btn-sm btn-success" onclick="acceptFriendRequest('${request.id}')">
                                                            <i class="fas fa-check"></i> Aceitar
                                                        </button>
                                                        <button class="btn btn-sm btn-danger" onclick="rejectFriendRequest('${request.id}')">
                                                            <i class="fas fa-times"></i> Recusar
                                                        </button>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <p class="text-center text-muted mb-0">
                                        Nenhuma solicitação de amizade pendente.
                                    </p>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="mb-0">Meus Amigos</h3>
                                <span class="text-muted">${friends.length} amigos</span>
                            </div>
                            <div class="card-body">
                                ${friends.length > 0 ? `
                                    <div class="row">
                                        ${friends.map(friendId => {
                                            const user = AppState.users[friendId];
                                            if (!user) return '';
                                            
                                            return `
                                                <div class="col-md-6 mb-3">
                                                    <div class="card">
                                                        <div class="card-body">
                                                            <div class="d-flex align-items-center gap-3 mb-3">
                                                                <img src="${user.profile.avatar}" 
                                                                     class="online-user-avatar" 
                                                                     alt="${user.username}">
                                                                <div>
                                                                    <div class="font-weight-bold">${user.username}</div>
                                                                    <div class="d-flex align-items-center gap-1">
                                                                        <span class="status-dot status-${user.status || 'offline'}"></span>
                                                                        <small class="text-muted">${user.status === 'online' ? 'Online' : 'Offline'}</small>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                            <p class="small text-muted mb-3">
                                                                ${user.profile.bio ? user.profile.bio.substring(0, 80) + '...' : 'Sem biografia disponível.'}
                                                            </p>
                                                            <div class="d-flex gap-2">
                                                                <button class="btn btn-sm btn-primary flex-grow-1" onclick="UISystem.startPrivateChat('${friendId}')">
                                                                    <i class="fas fa-comment"></i> Mensagem
                                                                </button>
                                                                <button class="btn btn-sm btn-danger" onclick="removeFriend('${friendId}')">
                                                                    <i class="fas fa-user-times"></i>
                                                                </button>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-5">
                                        <i class="fas fa-user-friends fa-3x text-muted mb-3"></i>
                                        <h4 class="text-muted">Nenhum amigo adicionado</h4>
                                        <p class="text-muted">Adicione outros cientistas para colaborar!</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // 6. PÁGINA DE MENSAGENS PRIVADAS (NOVA)
        window.renderMessagesPage = async function() {
            const conversations = ChatSystem.getPrivateConversations();
            
            return `
                <div class="content-header">
                    <h1>Mensagens Privadas</h1>
                    <p class="subtitle">Conversas diretas com outros cientistas</p>
                </div>
                
                <div class="row">
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="mb-0">Conversas</h3>
                                <button class="btn btn-primary btn-sm" onclick="startNewConversation()">
                                    <i class="fas fa-plus"></i> Nova
                                </button>
                            </div>
                            <div class="card-body p-0">
                                <div id="conversationsList" style="max-height: 500px; overflow-y: auto;">
                                    ${conversations.length > 0 ? conversations.map(conv => {
                                        const user = AppState.users[conv.userId];
                                        if (!user) return '';
                                        
                                        return `
                                            <div class="conversation-item ${conv.id === AppState.currentConversation ? 'active' : ''}" 
                                                 onclick="loadConversation('${conv.id}')"
                                                 style="padding: 12px; border-bottom: 1px solid var(--border-color); cursor: pointer; display: flex; align-items: center; gap: 12px;">
                                                <img src="${user.profile.avatar}" 
                                                     style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid var(--accent-primary);"
                                                     alt="${user.username}">
                                                <div style="flex: 1; overflow: hidden;">
                                                    <div style="font-weight: 600; margin-bottom: 2px;">${user.username}</div>
                                                    <div style="font-size: 0.85rem; color: var(--text-secondary); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;">
                                                        ${conv.lastMessage.substring(0, 50)}${conv.lastMessage.length > 50 ? '...' : ''}
                                                    </div>
                                                </div>
                                                <div style="text-align: right;">
                                                    <div style="font-size: 0.75rem; color: var(--text-muted); margin-bottom: 4px;">
                                                        ${UISystem.formatDate(conv.lastMessageTime)}
                                                    </div>
                                                    ${conv.unreadCount > 0 ? `
                                                        <div style="background: var(--accent-danger); color: white; font-size: 0.7rem; 
                                                             padding: 2px 6px; border-radius: 10px; text-align: center;">
                                                            ${conv.unreadCount}
                                                        </div>
                                                    ` : ''}
                                                </div>
                                            </div>
                                        `;
                                    }).join('') : `
                                        <div class="text-center py-5">
                                            <i class="fas fa-comments fa-3x text-muted mb-3"></i>
                                            <p class="text-muted">Nenhuma conversa</p>
                                        </div>
                                    `}
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-8">
                        <div class="card h-100">
                            <div class="card-header">
                                <h3 class="mb-0" id="currentConversationName">
                                    ${conversations.length > 0 ? 'Selecione uma conversa' : 'Nenhuma conversa'}
                                </h3>
                            </div>
                            <div class="card-body" style="height: 500px; overflow-y: auto; padding: 20px;" id="messagesContainer">
                                ${conversations.length > 0 ? '' : `
                                    <div class="text-center py-5">
                                        <i class="fas fa-comment-dots fa-3x text-muted mb-3"></i>
                                        <h4 class="text-muted">Nenhuma conversa selecionada</h4>
                                        <p class="text-muted">Selecione uma conversa ou inicie uma nova</p>
                                    </div>
                                `}
                            </div>
                            <div class="card-footer ${conversations.length > 0 ? '' : 'hidden'}" id="messageInputContainer">
                                <div class="input-group">
                                    <textarea class="form-control" id="privateMessageInput" 
                                              placeholder="Digite sua mensagem..." rows="2"></textarea>
                                    <button class="btn btn-primary" onclick="sendPrivateMessage()" style="border-radius: 0 8px 8px 0;">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // 7. PÁGINA DE PERFIL (NOVA)
        window.renderProfilePage = async function() {
            const user = AppState.users[AppState.currentUser];
            const theories = TheorySystem.getUserTheories(AppState.currentUser);
            
            return `
                <div class="content-header">
                    <h1>Meu Perfil</h1>
                    <p class="subtitle">Gerencie suas informações pessoais</p>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-4 text-center">
                                <img src="${user.profile.avatar}" 
                                     style="width: 150px; height: 150px; border-radius: 50%; border: 3px solid var(--accent-primary); object-fit: cover; margin-bottom: 20px;"
                                     alt="${user.username}">
                                <h3>${user.username}</h3>
                                <p class="text-muted">${user.profile.specialization || 'Sem especialização'}</p>
                                <div class="badge ${AppState.isNucleo ? 'badge-primary' : 'badge-secondary'} mb-2">
                                    ${AppState.isNucleo ? 'Núcleo' : 'Membro'}
                                </div>
                                <p class="small">Reputação: ${user.stats.reputation || 0}</p>
                            </div>
                            
                            <div class="col-md-8">
                                <div class="profile-tabs mb-4" style="display: flex; border-bottom: 2px solid var(--border-color);">
                                    <button class="profile-tab active" onclick="switchProfileTab('info')" 
                                            style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; 
                                                   color: var(--text-secondary); cursor: pointer; font-weight: 600;">
                                        Informações
                                    </button>
                                    <button class="profile-tab" onclick="switchProfileTab('stats')"
                                            style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; 
                                                   color: var(--text-secondary); cursor: pointer; font-weight: 600;">
                                        Estatísticas
                                    </button>
                                    <button class="profile-tab" onclick="switchProfileTab('preferences')"
                                            style="padding: 10px 20px; background: none; border: none; border-bottom: 2px solid transparent; 
                                                   color: var(--text-secondary); cursor: pointer; font-weight: 600;">
                                        Preferências
                                    </button>
                                </div>
                                
                                <div id="profileInfoContent">
                                    <h4>Informações Básicas</h4>
                                    <div class="mb-3">
                                        <strong>Email:</strong> ${user.email}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Biografia:</strong><br>
                                        ${user.profile.bio || 'Nenhuma biografia adicionada.'}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Localização:</strong> ${user.profile.location || 'Não informada'}
                                    </div>
                                    <div class="mb-3">
                                        <strong>Website:</strong> ${user.profile.website ? `<a href="${user.profile.website}" target="_blank">${user.profile.website}</a>` : 'Não informado'}
                                    </div>
                                    
                                    <button class="btn btn-primary" onclick="editProfile()">
                                        <i class="fas fa-edit"></i> Editar Perfil
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // 8. PÁGINA DE GRUPOS (NOVA)
        window.renderGroupsPage = async function() {
            const userGroups = GroupSystem.getUserGroups(AppState.currentUser);
            const publicGroups = GroupSystem.getGroups({ privacy: 'public' });
            
            return `
                <div class="content-header">
                    <h1>Grupos de Pesquisa</h1>
                    <p class="subtitle">Colabore em grupos especializados</p>
                </div>
                
                <div class="row">
                    <div class="col-md-8">
                        <div class="card mb-4">
                            <div class="card-header d-flex justify-content-between align-items-center">
                                <h3 class="mb-0">Meus Grupos</h3>
                                <button class="btn btn-primary" onclick="showNewGroupModal()">
                                    <i class="fas fa-plus"></i> Criar Grupo
                                </button>
                            </div>
                            <div class="card-body">
                                ${userGroups.length > 0 ? `
                                    <div class="groups-grid">
                                        ${userGroups.map(group => `
                                            <div class="group-card">
                                                <div class="group-banner"></div>
                                                <div class="group-info">
                                                    <h4 class="group-title">${group.name}</h4>
                                                    <p class="group-description">${group.description}</p>
                                                    <div class="group-meta">
                                                        <span>
                                                            <i class="fas fa-users"></i> 
                                                            ${group.members.length} membros
                                                        </span>
                                                        <span class="badge ${group.privacy === 'public' ? 'badge-success' : group.privacy === 'private' ? 'badge-warning' : 'badge-secondary'}">
                                                            ${group.privacy === 'public' ? 'Público' : group.privacy === 'private' ? 'Privado' : 'Oculto'}
                                                        </span>
                                                    </div>
                                                    <div class="group-actions">
                                                        <button class="btn btn-sm btn-primary" onclick="viewGroup('${group.id}')">
                                                            <i class="fas fa-eye"></i> Ver
                                                        </button>
                                                        ${group.owner === AppState.currentUser ? `
                                                            <button class="btn btn-sm btn-secondary" onclick="editGroup('${group.id}')">
                                                                <i class="fas fa-edit"></i>
                                                            </button>
                                                        ` : `
                                                            <button class="btn btn-sm btn-danger" onclick="leaveGroup('${group.id}')">
                                                                <i class="fas fa-sign-out-alt"></i> Sair
                                                            </button>
                                                        `}
                                                    </div>
                                                </div>
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : `
                                    <div class="text-center py-5">
                                        <i class="fas fa-users fa-3x text-muted mb-3"></i>
                                        <h4 class="text-muted">Você não está em nenhum grupo</h4>
                                        <p class="text-muted">Junte-se a um grupo público ou crie o seu próprio</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                    
                    <div class="col-md-4">
                        <div class="card">
                            <div class="card-header">
                                <h3 class="mb-0">Grupos Públicos</h3>
                            </div>
                            <div class="card-body">
                                ${publicGroups.length > 0 ? `
                                    <div class="list-group">
                                        ${publicGroups.slice(0, 5).map(group => {
                                            const isMember = group.members.includes(AppState.currentUser);
                                            return `
                                                <div class="list-group-item d-flex justify-content-between align-items-center">
                                                    <div>
                                                        <div class="font-weight-bold">${group.name}</div>
                                                        <small class="text-muted">${group.members.length} membros</small>
                                                    </div>
                                                    ${!isMember ? `
                                                        <button class="btn btn-sm btn-primary" onclick="joinGroup('${group.id}')">
                                                            <i class="fas fa-user-plus"></i> Entrar
                                                        </button>
                                                    ` : `
                                                        <span class="badge badge-success">Membro</span>
                                                    `}
                                                </div>
                                            `;
                                        }).join('')}
                                    </div>
                                    ${publicGroups.length > 5 ? `
                                        <div class="text-center mt-3">
                                            <button class="btn btn-sm btn-secondary" onclick="viewAllPublicGroups()">
                                                Ver todos (${publicGroups.length})
                                            </button>
                                        </div>
                                    ` : ''}
                                ` : `
                                    <div class="text-center py-4">
                                        <p class="text-muted">Nenhum grupo público disponível</p>
                                    </div>
                                `}
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // 9. PÁGINA DE CONFIGURAÇÕES (BASIC)
        window.renderSettingsPage = async function() {
            return `
                <div class="content-header">
                    <h1>Configurações</h1>
                    <p class="subtitle">Personalize sua experiência no Renova</p>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="fas fa-cogs fa-3x text-muted mb-3"></i>
                            <h4 class="text-muted">Configurações do Sistema</h4>
                            <p class="text-muted">Em desenvolvimento</p>
                            
                            <div class="alert alert-info mt-4">
                                <i class="fas fa-info-circle"></i>
                                <strong>Configurações disponíveis:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Tema (já disponível no menu de login)</li>
                                    <li>Notificações</li>
                                    <li>Privacidade</li>
                                    <li>Exportar/Importar dados</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // 10. PÁGINA DE ADMINISTRAÇÃO (BASIC)
        window.renderAdminPage = async function() {
            if (!AppState.isNucleo) {
                return `
                    <div class="content-header">
                        <h1>Acesso Negado</h1>
                        <p class="subtitle">Área restrita ao Núcleo Científico</p>
                    </div>
                    
                    <div class="card">
                        <div class="card-body">
                            <div class="text-center py-5">
                                <i class="fas fa-shield-alt fa-3x text-danger mb-3"></i>
                                <h4 class="text-danger">Acesso Restrito</h4>
                                <p class="text-muted">Esta área é exclusiva para membros do Núcleo Científico.</p>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            return `
                <div class="content-header">
                    <h1>Administração</h1>
                    <p class="subtitle">Painel de controle do Núcleo Científico</p>
                </div>
                
                <div class="card">
                    <div class="card-body">
                        <div class="text-center py-5">
                            <i class="fas fa-user-shield fa-3x text-primary mb-3"></i>
                            <h4 class="text-primary">Painel de Administração</h4>
                            <p class="text-muted">Em desenvolvimento</p>
                            
                            <div class="alert alert-warning mt-4">
                                <i class="fas fa-tools"></i>
                                <strong>Funcionalidades em desenvolvimento:</strong>
                                <ul class="mb-0 mt-2">
                                    <li>Moderação de teorias</li>
                                    <li>Gerenciamento de usuários</li>
                                    <li>Relatórios do sistema</li>
                                    <li>Configurações avançadas</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        };

        // ============================================
        // FUNÇÕES AUXILIARES PARA AS PÁGINAS
        // ============================================

        // Funções para o chat
        window.selectChannel = function(channelId) {
            const channels = ChatSystem.getChannels();
            const channel = channels.find(c => c.id === channelId);
            if (!channel) return;
            
            // Atualizar UI do canal
            document.getElementById('currentChannelName').textContent = channel.name;
            document.getElementById('currentChannelTopic').textContent = channel.topic;
            
            // Atualizar canais ativos
            document.querySelectorAll('.channel-item').forEach(item => {
                item.classList.remove('active');
            });
            document.querySelector(`.channel-item[onclick*="${channelId}"]`)?.classList.add('active');
            
            // Carregar mensagens
            loadChannelMessages(channelId);
        };

        function loadChannelMessages(channelId) {
            const messages = ChatSystem.getChannelMessages(channelId, 50);
            const messagesContainer = document.getElementById('chatMessages');
            
            if (!messagesContainer) return;
            
            messagesContainer.innerHTML = messages.length > 0 ? messages.map(msg => `
                <div class="message ${msg.author === AppState.currentUser ? 'own' : ''}">
                    <div class="message-header">
                        <img src="${msg.authorAvatar}" class="message-avatar" alt="${msg.authorName}">
                        <div class="message-author">${msg.authorName}</div>
                        <div class="message-time">${UISystem.formatDate(msg.timestamp)}</div>
                    </div>
                    <div class="message-content">
                        <div class="message-text">${msg.content}</div>
                        <div class="message-actions">
                            <button class="btn btn-sm btn-secondary">
                                <i class="fas fa-reply"></i>
                            </button>
                            <button class="btn btn-sm btn-secondary">
                                <i class="fas fa-thumbs-up"></i>
                            </button>
                        </div>
                    </div>
                </div>
            `).join('') : `
                <div class="text-center text-muted py-5">
                    <i class="fas fa-comment-slash fa-3x mb-3"></i>
                    <h4>Nenhuma mensagem neste canal</h4>
                    <p>Seja o primeiro a enviar uma mensagem!</p>
                </div>
            `;
            
            // Rolar para o final
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
            
            // Configurar entrada de chat
            const chatInput = document.getElementById('chatInput');
            if (chatInput) {
                chatInput.onkeydown = function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        sendChatMessage();
                    }
                };
                
                // Focar no input
                chatInput.focus();
            }
        };

        window.sendChatMessage = function() {
            const input = document.getElementById('chatInput');
            if (!input || !input.value.trim()) return;
            
            const channels = ChatSystem.getChannels();
            const activeChannel = document.querySelector('.channel-item.active');
            const channelId = activeChannel ? 
                activeChannel.onclick.toString().match(/'([^']+)'/)[1] : 'geral';
            
            try {
                ChatSystem.sendMessage(channelId, input.value.trim());
                input.value = '';
                
                // Recarregar mensagens
                loadChannelMessages(channelId);
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        // Funções para mensagens privadas
        window.loadConversation = function(conversationId) {
            AppState.currentConversation = conversationId;
            
            // Extrair o ID do outro usuário
            const participantIds = conversationId.split('_');
            const otherUserId = participantIds.find(id => id !== AppState.currentUser);
            const otherUser = AppState.users[otherUserId];
            
            // Atualizar nome da conversa
            document.getElementById('currentConversationName').textContent = otherUser?.username || 'Conversa';
            
            // Mostrar input
            document.getElementById('messageInputContainer').classList.remove('hidden');
            
            // Carregar mensagens
            const messages = ChatSystem.getPrivateMessages(conversationId);
            const container = document.getElementById('messagesContainer');
            
            if (!container) return;
            
            container.innerHTML = messages.length > 0 ? messages.map(msg => `
                <div class="message ${msg.sender === AppState.currentUser ? 'own' : ''}" style="margin-bottom: 15px;">
                    <div class="message-header" style="margin-bottom: 5px;">
                        <span class="message-author" style="font-weight: 600;">
                            ${AppState.users[msg.sender]?.username || 'Desconhecido'}
                        </span>
                        <span class="message-time" style="font-size: 0.8rem; color: #666;">
                            ${UISystem.formatDate(msg.timestamp)}
                        </span>
                    </div>
                    <div class="message-content" style="background: ${msg.sender === AppState.currentUser ? 'rgba(0, 212, 255, 0.1)' : 'var(--bg-tertiary)'}; 
                                                        border: 1px solid ${msg.sender === AppState.currentUser ? 'var(--accent-primary)' : 'var(--border-color)'}; 
                                                        border-radius: 8px; padding: 10px 15px;">
                        <div class="message-text">${msg.content}</div>
                    </div>
                </div>
            `).join('') : `
                <div class="text-center py-5">
                    <p class="text-muted">Nenhuma mensagem nesta conversa</p>
                </div>
            `;
            
            // Marcar como lida
            ChatSystem.markAsRead(conversationId);
            
            // Rolar para baixo
            container.scrollTop = container.scrollHeight;
            
            // Configurar input
            const input = document.getElementById('privateMessageInput');
            if (input) {
                input.focus();
                input.onkeydown = function(e) {
                    if (e.ctrlKey && e.key === 'Enter') {
                        sendPrivateMessage();
                    }
                };
            }
        };

        window.sendPrivateMessage = function() {
            const input = document.getElementById('privateMessageInput');
            if (!input || !input.value.trim()) return;
            
            if (!AppState.currentConversation) {
                ToastSystem.error('Selecione uma conversa primeiro');
                return;
            }
            
            // Extrair o ID do outro usuário
            const participantIds = AppState.currentConversation.split('_');
            const otherUserId = participantIds.find(id => id !== AppState.currentUser);
            
            try {
                ChatSystem.createPrivateMessage(otherUserId, input.value.trim());
                input.value = '';
                
                // Recarregar conversa
                loadConversation(AppState.currentConversation);
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        window.startNewConversation = function() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'newConversationModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">Nova Conversa</div>
                        <button class="modal-close" onclick="ModalSystem.hide('newConversationModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label class="form-label">Buscar Usuário</label>
                            <input type="text" class="form-control" id="userSearchInput" 
                                   placeholder="Digite nome de usuário ou email" 
                                   onkeyup="searchUsersForChat(this.value)">
                        </div>
                        <div id="userSearchResults" style="max-height: 300px; overflow-y: auto; margin-top: 15px;">
                            <div class="text-center text-muted py-3">
                                Digite para buscar usuários
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            ModalSystem.show('newConversationModal');
            
            // Focar no input
            setTimeout(() => {
                document.getElementById('userSearchInput')?.focus();
            }, 100);
        };

        window.searchUsersForChat = function(query) {
            if (!query || query.length < 2) {
                document.getElementById('userSearchResults').innerHTML = `
                    <div class="text-center text-muted py-3">
                        Digite pelo menos 2 caracteres
                    </div>
                `;
                return;
            }
            
            const results = FriendSystem.searchUsers(query, false);
            const container = document.getElementById('userSearchResults');
            
            if (!container) return;
            
            container.innerHTML = results.length > 0 ? `
                <div class="list-group">
                    ${results.slice(0, 10).map(user => `
                        <div class="list-group-item d-flex justify-content-between align-items-center" 
                             style="cursor: pointer;"
                             onclick="startChatWithUser('${user.id}')">
                            <div class="d-flex align-items-center gap-3">
                                <img src="${user.profile.avatar}" 
                                     style="width: 40px; height: 40px; border-radius: 50%;" 
                                     alt="${user.username}">
                                <div>
                                    <div class="font-weight-bold">${user.username}</div>
                                    <small class="text-muted">${user.profile.specialization || 'Sem especialização'}</small>
                                </div>
                            </div>
                            <i class="fas fa-chevron-right text-muted"></i>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="text-center py-4">
                    <p class="text-muted">Nenhum usuário encontrado</p>
                </div>
            `;
        };

        window.startChatWithUser = function(userId) {
            // Criar ID de conversa
            const conversationId = [AppState.currentUser, userId].sort().join('_');
            
            // Fechar modal
            ModalSystem.hide('newConversationModal');
            
            // Carregar a página de mensagens
            loadSection('messages');
            
            // Aguardar um momento e carregar a conversa
            setTimeout(() => {
                if (typeof loadConversation === 'function') {
                    loadConversation(conversationId);
                }
            }, 300);
        };

        // Funções para o fórum
        window.selectForumCategory = function(categoryId) {
            ToastSystem.info(`Filtrando por categoria: ${categoryId}`);
        };

        window.viewForumPost = function(postId) {
            const post = AppState.forumPosts.find(p => p.id === postId);
            if (!post) {
                ToastSystem.error('Post não encontrado');
                return;
            }
            
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'forumPostModal';
            modal.innerHTML = `
                <div class="modal modal-lg">
                    <div class="modal-header">
                        <div class="modal-title">
                            ${post.pinned ? '<i class="fas fa-thumbtack text-warning mr-2"></i>' : ''}
                            ${post.title}
                        </div>
                        <button class="modal-close" onclick="ModalSystem.hide('forumPostModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div class="d-flex align-items-center gap-3 mb-4">
                            <img src="${AppState.users[post.author]?.profile?.avatar || ''}" 
                                 class="online-user-avatar" 
                                 alt="${AppState.users[post.author]?.username || 'Desconhecido'}">
                            <div>
                                <div class="font-weight-bold">${AppState.users[post.author]?.username || 'Desconhecido'}</div>
                                <div class="text-muted small">
                                    Postado ${UISystem.formatDate(post.createdAt)}
                                    ${post.updatedAt !== post.createdAt ? 
                                        `• Editado ${UISystem.formatDate(post.updatedAt)}` : ''}
                                </div>
                            </div>
                        </div>
                        
                        <div class="mb-4">
                            ${post.content}
                        </div>
                        
                        <div class="mb-4">
                            <div class="tags">
                                ${post.tags.map(tag => `
                                    <span class="tag">${tag}</span>
                                `).join('')}
                            </div>
                        </div>
                        
                        <hr>
                        
                        <div class="mb-3">
                            <h5>Comentários (${post.comments.length})</h5>
                        </div>
                        
                        <div class="mb-4">
                            <textarea class="form-control mb-2" id="postComment" 
                                      placeholder="Adicione um comentário..." rows="3"></textarea>
                            <button class="btn btn-primary" onclick="addPostComment('${post.id}')">
                                <i class="fas fa-comment"></i> Comentar
                            </button>
                        </div>
                        
                        <div id="postComments">
                            ${post.comments.map(comment => `
                                <div class="card mb-3">
                                    <div class="card-body">
                                        <div class="d-flex align-items-center gap-2 mb-2">
                                            <img src="${AppState.users[comment.author]?.profile?.avatar || ''}" 
                                                 class="online-user-avatar" 
                                                 alt="${AppState.users[comment.author]?.username || 'Desconhecido'}">
                                            <div>
                                                <div class="font-weight-bold">${AppState.users[comment.author]?.username || 'Desconhecido'}</div>
                                                <div class="text-muted small">${UISystem.formatDate(comment.timestamp)}</div>
                                            </div>
                                        </div>
                                        <div>${comment.content}</div>
                                    </div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            ModalSystem.show('forumPostModal');
        };

        window.addPostComment = function(postId) {
            const commentInput = document.getElementById('postComment');
            if (!commentInput || !commentInput.value.trim()) {
                ToastSystem.error('Digite um comentário');
                return;
            }
            
            try {
                ForumSystem.addComment(postId, commentInput.value.trim());
                commentInput.value = '';
                
                // Atualizar comentários
                const post = AppState.forumPosts.find(p => p.id === postId);
                if (post) {
                    const commentsContainer = document.getElementById('postComments');
                    if (commentsContainer) {
                        const lastComment = post.comments[post.comments.length - 1];
                        commentsContainer.innerHTML += `
                            <div class="card mb-3">
                                <div class="card-body">
                                    <div class="d-flex align-items-center gap-2 mb-2">
                                        <img src="${AppState.users[lastComment.author]?.profile?.avatar || ''}" 
                                             class="online-user-avatar" 
                                             alt="${AppState.users[lastComment.author]?.username || 'Desconhecido'}">
                                        <div>
                                            <div class="font-weight-bold">${AppState.users[lastComment.author]?.username || 'Desconhecido'}</div>
                                            <div class="text-muted small">${UISystem.formatDate(lastComment.timestamp)}</div>
                                        </div>
                                    </div>
                                    <div>${lastComment.content}</div>
                                </div>
                            </div>
                        `;
                        
                        // Rolar para o novo comentário
                        commentsContainer.scrollTop = commentsContainer.scrollHeight;
                    }
                }
                
                ToastSystem.success('Comentário adicionado!');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        // Funções para os grupos
        window.showNewGroupModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'newGroupModal';
            modal.innerHTML = `
                <div class="modal">
                    <div class="modal-header">
                        <div class="modal-title">Criar Novo Grupo</div>
                        <button class="modal-close" onclick="ModalSystem.hide('newGroupModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="groupForm">
                            <div class="form-group">
                                <label class="form-label">Nome do Grupo*</label>
                                <input type="text" class="form-control" id="groupName" 
                                       placeholder="Ex: Grupo de Pesquisa em Topologia" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Descrição*</label>
                                <textarea class="form-control" id="groupDescription" 
                                          rows="3" 
                                          placeholder="Descreva os objetivos e temas do grupo..." 
                                          required></textarea>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Categoria</label>
                                    <select class="form-control" id="groupCategory">
                                        <option value="geral">Geral</option>
                                        <option value="mathematics">Matemática</option>
                                        <option value="physics">Física</option>
                                        <option value="computer">Computação</option>
                                        <option value="biology">Biologia</option>
                                        <option value="engineering">Engenharia</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Privacidade</label>
                                    <select class="form-control" id="groupPrivacy">
                                        <option value="public">Público</option>
                                        <option value="private">Privado</option>
                                        <option value="hidden">Oculto</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tags</label>
                                <input type="text" class="form-control" id="groupTags" 
                                       placeholder="Separe tags por vírgula">
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="ModalSystem.hide('newGroupModal')">
                            Cancelar
                        </button>
                        <button class="btn btn-primary" onclick="createNewGroup()">
                            <i class="fas fa-users"></i> Criar Grupo
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            ModalSystem.show('newGroupModal');
        };

        window.createNewGroup = async function() {
            const name = document.getElementById('groupName')?.value;
            const description = document.getElementById('groupDescription')?.value;
            const category = document.getElementById('groupCategory')?.value;
            const privacy = document.getElementById('groupPrivacy')?.value;
            const tags = document.getElementById('groupTags')?.value;
            
            try {
                const groupData = {
                    name: name,
                    description: description,
                    category: category,
                    privacy: privacy,
                    tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag)
                };
                
                const group = await GroupSystem.createGroup(groupData);
                
                ModalSystem.hide('newGroupModal');
                ToastSystem.success(`Grupo "${group.name}" criado com sucesso!`);
                
                loadSection('groups');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        window.joinGroup = async function(groupId) {
            try {
                await GroupSystem.joinGroup(groupId);
                ToastSystem.success('Você entrou no grupo!');
                loadSection('groups');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        window.viewGroup = function(groupId) {
            const group = AppState.groups[groupId];
            if (!group) {
                ToastSystem.error('Grupo não encontrado');
                return;
            }
            
            ToastSystem.info(`Visualizando grupo: ${group.name}`);
        };

        // Funções para o perfil
        window.switchProfileTab = function(tab) {
            ToastSystem.info(`Mudando para aba: ${tab}`);
        };

        window.editProfile = function() {
            ToastSystem.info('Editor de perfil em desenvolvimento');
        };

        // Funções para novas teorias
        window.showNewTheoryModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'newTheoryModal';
            modal.innerHTML = `
                <div class="modal modal-xl">
                    <div class="modal-header">
                        <div class="modal-title">Nova Teoria Científica</div>
                        <button class="modal-close" onclick="ModalSystem.hide('newTheoryModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="theoryForm" onsubmit="event.preventDefault(); createNewTheory();">
                            <div class="form-group">
                                <label class="form-label">Título*</label>
                                <input type="text" class="form-control" id="theoryTitle" 
                                       placeholder="Ex: Nova abordagem para a Hipótese de Riemann" required>
                            </div>
                            
                            <div class="form-row">
                                <div class="form-group">
                                    <label class="form-label">Categoria*</label>
                                    <select class="form-control" id="theoryCategory" required>
                                        <option value="">Selecione uma categoria</option>
                                        <option value="mathematics">Matemática</option>
                                        <option value="physics">Física</option>
                                        <option value="computer">Ciência da Computação</option>
                                        <option value="biology">Biologia Matemática</option>
                                        <option value="engineering">Engenharia</option>
                                        <option value="other">Outra</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Visibilidade</label>
                                    <select class="form-control" id="theoryVisibility">
                                        <option value="public">Pública</option>
                                        <option value="private">Privada</option>
                                        <option value="draft">Rascunho</option>
                                    </select>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tags</label>
                                <input type="text" class="form-control" id="theoryTags" 
                                       placeholder="Separe tags por vírgula (ex: riemann, números-primos, hipótese)">
                                <div class="form-hint">Máximo 5 tags, separadas por vírgula</div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Conteúdo*</label>
                                <div class="editor-toolbar">
                                    <button type="button" class="editor-btn" onclick="formatTheoryText('bold')">
                                        <i class="fas fa-bold"></i>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="formatTheoryText('italic')">
                                        <i class="fas fa-italic"></i>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="formatTheoryText('latex')">
                                        <i class="fas fa-square-root-alt"></i> LaTeX
                                    </button>
                                    <button type="button" class="editor-btn" onclick="formatTheoryText('code')">
                                        <i class="fas fa-code"></i>
                                    </button>
                                    <button type="button" class="editor-btn" onclick="formatTheoryText('heading')">
                                        <i class="fas fa-heading"></i>
                                    </button>
                                </div>
                                <textarea class="form-control" id="theoryContent" 
                                          rows="15" 
                                          placeholder="Descreva sua teoria em detalhes. Use LaTeX para equações matemáticas: $E = mc^2$" 
                                          required></textarea>
                                <div class="form-hint">
                                    Suporte completo a LaTeX. Use $$ para equações em bloco e $ para inline.
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Resumo</label>
                                <textarea class="form-control" id="theoryAbstract" 
                                          rows="3" 
                                          placeholder="Breve resumo da sua teoria (máximo 300 caracteres)"></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="ModalSystem.hide('newTheoryModal')">
                            Cancelar
                        </button>
                        <button class="btn btn-success" onclick="saveTheoryDraft()">
                            <i class="fas fa-save"></i> Salvar Rascunho
                        </button>
                        <button class="btn btn-primary" onclick="createNewTheory()">
                            <i class="fas fa-paper-plane"></i> Submeter Teoria
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            ModalSystem.show('newTheoryModal');
        };

        window.createNewTheory = async function() {
            const title = document.getElementById('theoryTitle')?.value;
            const category = document.getElementById('theoryCategory')?.value;
            const visibility = document.getElementById('theoryVisibility')?.value;
            const tags = document.getElementById('theoryTags')?.value;
            const content = document.getElementById('theoryContent')?.value;
            
            try {
                const theoryData = {
                    title: title,
                    category: category,
                    visibility: visibility,
                    tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag),
                    content: content
                };
                
                const theory = await TheorySystem.createTheory(theoryData);
                
                ModalSystem.hide('newTheoryModal');
                ToastSystem.success(
                    theory.status === 'approved' 
                        ? 'Teoria publicada com sucesso!' 
                        : 'Teoria submetida para revisão!'
                );
                
                loadSection('theories');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        window.saveTheoryDraft = function() {
            ToastSystem.info('Rascunho salvo automaticamente');
        };

        window.formatTheoryText = function(format) {
            const textarea = document.getElementById('theoryContent');
            if (!textarea) return;
            
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const selectedText = textarea.value.substring(start, end);
            
            let formattedText = '';
            
            switch(format) {
                case 'bold':
                    formattedText = `**${selectedText}**`;
                    break;
                case 'italic':
                    formattedText = `*${selectedText}*`;
                    break;
                case 'latex':
                    formattedText = `$${selectedText}$`;
                    break;
                case 'code':
                    formattedText = "```\n" + selectedText + "\n```";
                    break;
                case 'heading':
                    formattedText = `# ${selectedText}`;
                    break;
            }
            
            textarea.value = textarea.value.substring(0, start) + 
                             formattedText + 
                             textarea.value.substring(end);
            
            textarea.focus();
            textarea.setSelectionRange(start, start + formattedText.length);
        };

        // Funções para novas discussões no fórum
        window.showNewPostModal = function() {
            const modal = document.createElement('div');
            modal.className = 'modal-backdrop';
            modal.id = 'newPostModal';
            modal.innerHTML = `
                <div class="modal modal-lg">
                    <div class="modal-header">
                        <div class="modal-title">Nova Discussão no Fórum</div>
                        <button class="modal-close" onclick="ModalSystem.hide('newPostModal')">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body">
                        <form id="postForm">
                            <div class="form-group">
                                <label class="form-label">Título*</label>
                                <input type="text" class="form-control" id="postTitle" 
                                       placeholder="Qual é o tópico da sua discussão?" required>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Categoria*</label>
                                <select class="form-control" id="postCategory" required>
                                    <option value="">Selecione uma categoria</option>
                                    <option value="matematica">Matemática</option>
                                    <option value="fisica">Física</option>
                                    <option value="computacao">Computação</option>
                                    <option value="geral">Geral</option>
                                </select>
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Tags</label>
                                <input type="text" class="form-control" id="postTags" 
                                       placeholder="Separe tags por vírgula">
                            </div>
                            
                            <div class="form-group">
                                <label class="form-label">Conteúdo*</label>
                                <textarea class="form-control" id="postContent" 
                                          rows="10" 
                                          placeholder="Descreva sua discussão em detalhes..." 
                                          required></textarea>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button class="btn btn-secondary" onclick="ModalSystem.hide('newPostModal')">
                            Cancelar
                        </button>
                        <button class="btn btn-primary" onclick="createNewPost()">
                            <i class="fas fa-paper-plane"></i> Publicar Discussão
                        </button>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            ModalSystem.show('newPostModal');
        };

        window.createNewPost = async function() {
            const title = document.getElementById('postTitle')?.value;
            const category = document.getElementById('postCategory')?.value;
            const tags = document.getElementById('postTags')?.value;
            const content = document.getElementById('postContent')?.value;
            
            try {
                const postData = {
                    title: title,
                    category: category,
                    content: content,
                    tags: tags.split(',').map(tag => tag.trim()).filter(tag => tag)
                };
                
                const post = await ForumSystem.createPost(postData);
                
                ModalSystem.hide('newPostModal');
                ToastSystem.success('Discussão publicada com sucesso!');
                
                // Recarregar página do fórum
                loadSection('forum');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        // Funções para amizades
        window.acceptFriendRequest = function(requestId) {
            try {
                FriendSystem.acceptRequest(requestId);
                ToastSystem.success('Solicitação de amizade aceita!');
                loadSection('friends');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        window.rejectFriendRequest = function(requestId) {
            try {
                FriendSystem.rejectRequest(requestId);
                ToastSystem.info('Solicitação de amizade recusada');
                loadSection('friends');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        window.removeFriend = function(friendId) {
            if (confirm(`Tem certeza que deseja remover ${AppState.users[friendId]?.username || 'este amigo'}?`)) {
                try {
                    FriendSystem.removeFriend(friendId);
                    ToastSystem.success('Amigo removido');
                    loadSection('friends');
                } catch (error) {
                    ToastSystem.error(error.message);
                }
            }
        };

        window.searchFriends = function() {
            const query = document.getElementById('friendSearch')?.value;
            if (!query || query.length < 2) {
                ToastSystem.warning('Digite pelo menos 2 caracteres para buscar');
                return;
            }
            
            const results = FriendSystem.searchUsers(query, true);
            const resultsContainer = document.getElementById('friendResults');
            
            if (!resultsContainer) return;
            
            resultsContainer.innerHTML = results.length > 0 ? `
                <div class="list-group">
                    ${results.slice(0, 10).map(user => `
                        <div class="list-group-item d-flex justify-content-between align-items-center">
                            <div class="d-flex align-items-center gap-3">
                                <img src="${user.profile.avatar}" 
                                     class="online-user-avatar" 
                                     alt="${user.username}">
                                <div>
                                    <div class="font-weight-bold">${user.username}</div>
                                    <small class="text-muted">${user.email}</small>
                                    <div class="small text-muted mt-1">
                                        ${user.profile.specialization || 'Sem especialização'}
                                    </div>
                                </div>
                            </div>
                            <button class="btn btn-sm btn-primary" onclick="FriendSystem.sendRequest('${user.id}')">
                                <i class="fas fa-user-plus"></i> Adicionar
                            </button>
                        </div>
                    `).join('')}
                </div>
            ` : `
                <div class="text-center py-4">
                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                    <h5 class="text-muted">Nenhum usuário encontrado</h5>
                    <p class="text-muted">Tente buscar por nome de usuário ou email</p>
                </div>
            `;
        };

        // Funções para teorias
        window.viewTheory = function(theoryId) {
            ToastSystem.info(`Visualizando teoria: ${theoryId}`);
        };

        window.approveTheory = function(theoryId) {
            try {
                TheorySystem.approveTheory(theoryId);
                ToastSystem.success('Teoria aprovada com sucesso');
                loadSection('theories');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        window.voteTheory = function(theoryId, vote) {
            try {
                TheorySystem.voteTheory(theoryId, vote);
                ToastSystem.success(`Voto ${vote === 'up' ? 'positivo' : 'negativo'} registrado`);
                loadSection('theories');
            } catch (error) {
                ToastSystem.error(error.message);
            }
        };

        // Funções para o editor
        window.insertLatex = function() {
            const input = document.getElementById('chatInput');
            if (input) {
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const selectedText = input.value.substring(start, end);
                
                input.value = input.value.substring(0, start) + 
                             `$${selectedText || 'equação'}$` + 
                             input.value.substring(end);
                
                input.focus();
                input.setSelectionRange(start + 1, start + 1 + (selectedText || 'equação').length);
            }
        };

        window.insertCode = function() {
            const input = document.getElementById('chatInput');
            if (input) {
                const start = input.selectionStart;
                const end = input.selectionEnd;
                const selectedText = input.value.substring(start, end);
                
                input.value = input.value.substring(0, start) + 
                             "```\n" + (selectedText || 'código') + "\n```" + 
                             input.value.substring(end);
                
                input.focus();
                input.setSelectionRange(start + 4, start + 4 + (selectedText || 'código').length);
            }
        };

        // ============================================
        // INICIALIZAÇÃO DO SISTEMA
        // ============================================

        document.addEventListener('DOMContentLoaded', async () => {
            Logger.log('Sistema Renova iniciando...');
            
            try {
                // Carregar dados persistentes
                StorageSystem.load();
                
                // Configurar tema salvo
                const savedTheme = AppState.settings.theme || RENOVA_CONFIG.DEFAULT_THEME;
                UISystem.setTheme(savedTheme);
                
                // Configurar menu mobile
                const mobileToggle = document.getElementById('mobileMenuToggle');
                if (mobileToggle) {
                    mobileToggle.onclick = UISystem.toggleSidebar;
                }
                
                // Configurar seletor de status
                const statusSelector = document.getElementById('statusSelector');
                if (statusSelector) {
                    statusSelector.onchange = (e) => {
                        AuthSystem.updateUserStatus(e.target.value);
                    };
                }
                
                // Auto-atualizar usuários online
                setInterval(() => {
                    UISystem.updateOnlineUsers();
                }, 10000);
                
                Logger.log('Sistema Renova pronto!');
                
                // Verificar se há usuário logado
                if (AppState.currentUser && AppState.users[AppState.currentUser]) {
                    // Restaurar sessão
                    document.getElementById('authScreen').classList.add('hidden');
                    document.getElementById('dashboard').classList.remove('hidden');
                    document.getElementById('mobileMenuToggle').classList.remove('hidden');
                    
                    AuthSystem.updateUserUI();
                    loadSection('dashboard-home');
                    UISystem.updateOnlineUsers();
                    
                    ToastSystem.info(`Bem-vindo de volta, ${AppState.users[AppState.currentUser].username}!`);
                }
            } catch (error) {
                Logger.error('Erro na inicialização:', error);
                ToastSystem.error('Erro ao iniciar o sistema');
            }
        });

        // Prevenir fechamento acidental
        window.addEventListener('beforeunload', (e) => {
            if (AppState.currentUser && AppState.settings.autosave) {
                StorageSystem.save();
                
                // Criação de backup
                StorageSystem.createBackup();
            }
        });

    </script>
</body>
</html>
